
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../chain-layer/" rel="prev"/>
<link href="../io-subsystem/" rel="next"/>
<link href="../../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Inode Layer - DragonFly BSD Kernel Documentation</title>
<link href="../../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#hammer2-inode-layer">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Inode Layer
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_4_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_4_2">
<span class="md-nav__icon md-icon"></span>
            
  
    HAMMER2
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../on-disk-format/">
<span class="md-ellipsis">
    
  
    On-Disk Format
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chain-layer/">
<span class="md-ellipsis">
    
  
    Chain Layer
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Inode Layer
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Inode Layer
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-data-structures">
<span class="md-ellipsis">
      
        Core Data Structures
      
    </span>
</a>
<nav aria-label="Core Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_inode_t">
<span class="md-ellipsis">
      
        hammer2_inode_t
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-flags">
<span class="md-ellipsis">
      
        Inode Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_depend_t">
<span class="md-ellipsis">
      
        hammer2_depend_t
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-hash-table">
<span class="md-ellipsis">
      
        Inode Hash Table
      
    </span>
</a>
<nav aria-label="Inode Hash Table" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#initialization">
<span class="md-ellipsis">
      
        Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup">
<span class="md-ellipsis">
      
        Lookup
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reference-counting">
<span class="md-ellipsis">
      
        Reference Counting
      
    </span>
</a>
<nav aria-label="Reference Counting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-references">
<span class="md-ellipsis">
      
        Adding References
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dropping-references">
<span class="md-ellipsis">
      
        Dropping References
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#locking">
<span class="md-ellipsis">
      
        Locking
      
    </span>
</a>
<nav aria-label="Locking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#basic-locking">
<span class="md-ellipsis">
      
        Basic Locking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#multi-inode-locking">
<span class="md-ellipsis">
      
        Multi-Inode Locking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lock-upgradedowngrade">
<span class="md-ellipsis">
      
        Lock Upgrade/Downgrade
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#temporary-releaserestore">
<span class="md-ellipsis">
      
        Temporary Release/Restore
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vnode-association">
<span class="md-ellipsis">
      
        Vnode Association
      
    </span>
</a>
<nav aria-label="Vnode Association" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#getting-a-vnode-for-an-inode">
<span class="md-ellipsis">
      
        Getting a Vnode for an Inode
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-creation">
<span class="md-ellipsis">
      
        Inode Creation
      
    </span>
</a>
<nav aria-label="Inode Creation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-normal-inodes">
<span class="md-ellipsis">
      
        Creating Normal Inodes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-pfs-inodes">
<span class="md-ellipsis">
      
        Creating PFS Inodes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-directory-entries">
<span class="md-ellipsis">
      
        Creating Directory Entries
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-lookup-and-caching">
<span class="md-ellipsis">
      
        Inode Lookup and Caching
      
    </span>
</a>
<nav aria-label="Inode Lookup and Caching" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_inode_get">
<span class="md-ellipsis">
      
        hammer2_inode_get
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cluster-repointing">
<span class="md-ellipsis">
      
        Cluster Repointing
      
    </span>
</a>
<nav aria-label="Cluster Repointing" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#full-cluster-repoint">
<span class="md-ellipsis">
      
        Full Cluster Repoint
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#single-chain-repoint">
<span class="md-ellipsis">
      
        Single Chain Repoint
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#modification-and-synchronization">
<span class="md-ellipsis">
      
        Modification and Synchronization
      
    </span>
</a>
<nav aria-label="Modification and Synchronization" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#marking-inodes-modified">
<span class="md-ellipsis">
      
        Marking Inodes Modified
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#syncing-to-chains">
<span class="md-ellipsis">
      
        Syncing to Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inserting-chains">
<span class="md-ellipsis">
      
        Inserting Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deleting-chains">
<span class="md-ellipsis">
      
        Deleting Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flushing-to-media">
<span class="md-ellipsis">
      
        Flushing to Media
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#unlink-handling">
<span class="md-ellipsis">
      
        Unlink Handling
      
    </span>
</a>
<nav aria-label="Unlink Handling" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#finishing-unlink">
<span class="md-ellipsis">
      
        Finishing Unlink
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vnode-recycling">
<span class="md-ellipsis">
      
        Vnode Recycling
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-dependency-management">
<span class="md-ellipsis">
      
        Flush Dependency Management
      
    </span>
</a>
<nav aria-label="Flush Dependency Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sideq-and-syncq">
<span class="md-ellipsis">
      
        SIDEQ and SYNCQ
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dependency-groups">
<span class="md-ellipsis">
      
        Dependency Groups
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-to-sideq">
<span class="md-ellipsis">
      
        Adding to SIDEQ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#statistics">
<span class="md-ellipsis">
      
        Statistics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-access">
<span class="md-ellipsis">
      
        Chain Access
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lifecycle-summary">
<span class="md-ellipsis">
      
        Lifecycle Summary
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../io-subsystem/">
<span class="md-ellipsis">
    
  
    I/O Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../flush-sync/">
<span class="md-ellipsis">
    
  
    Flush &amp; Sync
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../freemap/">
<span class="md-ellipsis">
    
  
    Freemap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../xop-system/">
<span class="md-ellipsis">
    
  
    XOP System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs-integration/">
<span class="md-ellipsis">
    
  
    VFS Integration
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../compression/">
<span class="md-ellipsis">
    
  
    Compression
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../snapshots/">
<span class="md-ellipsis">
    
  
    Snapshots
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clustering/">
<span class="md-ellipsis">
    
  
    Clustering
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    net/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    net/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/interfaces/">
<span class="md-ellipsis">
    
  
    Network Interfaces
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/netisr/">
<span class="md-ellipsis">
    
  
    Network ISR
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-data-structures">
<span class="md-ellipsis">
      
        Core Data Structures
      
    </span>
</a>
<nav aria-label="Core Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_inode_t">
<span class="md-ellipsis">
      
        hammer2_inode_t
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-flags">
<span class="md-ellipsis">
      
        Inode Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_depend_t">
<span class="md-ellipsis">
      
        hammer2_depend_t
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-hash-table">
<span class="md-ellipsis">
      
        Inode Hash Table
      
    </span>
</a>
<nav aria-label="Inode Hash Table" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#initialization">
<span class="md-ellipsis">
      
        Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup">
<span class="md-ellipsis">
      
        Lookup
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reference-counting">
<span class="md-ellipsis">
      
        Reference Counting
      
    </span>
</a>
<nav aria-label="Reference Counting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-references">
<span class="md-ellipsis">
      
        Adding References
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dropping-references">
<span class="md-ellipsis">
      
        Dropping References
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#locking">
<span class="md-ellipsis">
      
        Locking
      
    </span>
</a>
<nav aria-label="Locking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#basic-locking">
<span class="md-ellipsis">
      
        Basic Locking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#multi-inode-locking">
<span class="md-ellipsis">
      
        Multi-Inode Locking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lock-upgradedowngrade">
<span class="md-ellipsis">
      
        Lock Upgrade/Downgrade
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#temporary-releaserestore">
<span class="md-ellipsis">
      
        Temporary Release/Restore
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vnode-association">
<span class="md-ellipsis">
      
        Vnode Association
      
    </span>
</a>
<nav aria-label="Vnode Association" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#getting-a-vnode-for-an-inode">
<span class="md-ellipsis">
      
        Getting a Vnode for an Inode
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-creation">
<span class="md-ellipsis">
      
        Inode Creation
      
    </span>
</a>
<nav aria-label="Inode Creation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-normal-inodes">
<span class="md-ellipsis">
      
        Creating Normal Inodes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-pfs-inodes">
<span class="md-ellipsis">
      
        Creating PFS Inodes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-directory-entries">
<span class="md-ellipsis">
      
        Creating Directory Entries
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-lookup-and-caching">
<span class="md-ellipsis">
      
        Inode Lookup and Caching
      
    </span>
</a>
<nav aria-label="Inode Lookup and Caching" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_inode_get">
<span class="md-ellipsis">
      
        hammer2_inode_get
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cluster-repointing">
<span class="md-ellipsis">
      
        Cluster Repointing
      
    </span>
</a>
<nav aria-label="Cluster Repointing" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#full-cluster-repoint">
<span class="md-ellipsis">
      
        Full Cluster Repoint
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#single-chain-repoint">
<span class="md-ellipsis">
      
        Single Chain Repoint
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#modification-and-synchronization">
<span class="md-ellipsis">
      
        Modification and Synchronization
      
    </span>
</a>
<nav aria-label="Modification and Synchronization" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#marking-inodes-modified">
<span class="md-ellipsis">
      
        Marking Inodes Modified
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#syncing-to-chains">
<span class="md-ellipsis">
      
        Syncing to Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inserting-chains">
<span class="md-ellipsis">
      
        Inserting Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deleting-chains">
<span class="md-ellipsis">
      
        Deleting Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flushing-to-media">
<span class="md-ellipsis">
      
        Flushing to Media
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#unlink-handling">
<span class="md-ellipsis">
      
        Unlink Handling
      
    </span>
</a>
<nav aria-label="Unlink Handling" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#finishing-unlink">
<span class="md-ellipsis">
      
        Finishing Unlink
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vnode-recycling">
<span class="md-ellipsis">
      
        Vnode Recycling
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-dependency-management">
<span class="md-ellipsis">
      
        Flush Dependency Management
      
    </span>
</a>
<nav aria-label="Flush Dependency Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sideq-and-syncq">
<span class="md-ellipsis">
      
        SIDEQ and SYNCQ
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dependency-groups">
<span class="md-ellipsis">
      
        Dependency Groups
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-to-sideq">
<span class="md-ellipsis">
      
        Adding to SIDEQ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#statistics">
<span class="md-ellipsis">
      
        Statistics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-access">
<span class="md-ellipsis">
      
        Chain Access
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lifecycle-summary">
<span class="md-ellipsis">
      
        Lifecycle Summary
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="hammer2-inode-layer">HAMMER2 Inode Layer<a class="headerlink" href="#hammer2-inode-layer" title="Permanent link"></a></h1>
<div class="admonition abstract">
<p class="admonition-title">Source Reference</p>
<p>Primary source: <code>sys/vfs/hammer2/hammer2_inode.c</code><br/>
Header definitions: <code>sys/vfs/hammer2/hammer2.h</code> (lines 673-767)</p>
</div>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link"></a></h2>
<p>The inode layer provides the high-level file and directory abstraction built on top of the <a href="../chain-layer/">chain layer</a>. It manages in-memory inode structures (<code>hammer2_inode_t</code>), their association with vnodes, reference counting, locking semantics, and synchronization with the underlying chain topology.</p>
<p>Key responsibilities:</p>
<ul>
<li><strong>Inode lifecycle management</strong>  creation, lookup, reference counting, and destruction</li>
<li><strong>Vnode association</strong>  bridging between VFS vnodes and HAMMER2 inodes</li>
<li><strong>Locking with SYNCQ semantics</strong>  coordinating with the filesystem syncer</li>
<li><strong>Flush dependency tracking</strong>  ensuring related inodes are flushed together</li>
<li><strong>Metadata synchronization</strong>  propagating in-memory changes to on-disk chains</li>
</ul>
<h2 id="core-data-structures">Core Data Structures<a class="headerlink" href="#core-data-structures" title="Permanent link"></a></h2>
<h3 id="hammer2_inode_t">hammer2_inode_t<a class="headerlink" href="#hammer2_inode_t" title="Permanent link"></a></h3>
<p>The main in-memory inode structure (<code>hammer2.h:690-710</code>):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_inode</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_inode</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w">         </span><span class="cm">/* hash chain linkage */</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="n">TAILQ_ENTRY</span><span class="p">(</span><span class="n">hammer2_inode</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w">   </span><span class="cm">/* SYNCQ/SIDEQ queue entry */</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">hammer2_depend_t</span><span class="w">    </span><span class="o">*</span><span class="n">depend</span><span class="p">;</span><span class="w">        </span><span class="cm">/* flush dependency (non-NULL if SIDEQ) */</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">hammer2_depend_t</span><span class="w">    </span><span class="n">depend_static</span><span class="p">;</span><span class="w">  </span><span class="cm">/* in-place allocation for depend */</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">hammer2_mtx_t</span><span class="w">       </span><span class="n">lock</span><span class="p">;</span><span class="w">           </span><span class="cm">/* inode lock */</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">hammer2_mtx_t</span><span class="w">       </span><span class="n">truncate_lock</span><span class="p">;</span><span class="w">  </span><span class="cm">/* prevent truncates during I/O */</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_pfs</span><span class="w">  </span><span class="o">*</span><span class="n">pmp</span><span class="p">;</span><span class="w">           </span><span class="cm">/* PFS mount point */</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w">        </span><span class="o">*</span><span class="n">vp</span><span class="p">;</span><span class="w">            </span><span class="cm">/* associated vnode (may be NULL) */</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="n">hammer2_spin_t</span><span class="w">      </span><span class="n">cluster_spin</span><span class="p">;</span><span class="w">   </span><span class="cm">/* protects cluster updates */</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">hammer2_cluster_t</span><span class="w">   </span><span class="n">cluster</span><span class="p">;</span><span class="w">        </span><span class="cm">/* embedded cluster of chains */</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="n">hammer2_cluster_item_t</span><span class="w"> </span><span class="n">ccache</span><span class="p">[</span><span class="n">HAMMER2_MAXCLUSTER</span><span class="p">];</span><span class="w"> </span><span class="cm">/* cached data chains */</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">ccache_nchains</span><span class="p">;</span><span class="w"> </span><span class="cm">/* number of cached chains */</span>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lockf</span><span class="w">        </span><span class="n">advlock</span><span class="p">;</span><span class="w">        </span><span class="cm">/* advisory lock state */</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="n">u_int</span><span class="w">               </span><span class="n">flags</span><span class="p">;</span><span class="w">          </span><span class="cm">/* state flags */</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="n">u_int</span><span class="w">               </span><span class="n">refs</span><span class="p">;</span><span class="w">           </span><span class="cm">/* reference count */</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">ihash</span><span class="p">;</span><span class="w">          </span><span class="cm">/* XOP worker distribution hash */</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">             </span><span class="n">comp_heuristic</span><span class="p">;</span><span class="w"> </span><span class="cm">/* compression heuristic */</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="n">hammer2_inode_meta_t</span><span class="w"> </span><span class="n">meta</span><span class="p">;</span><span class="w">          </span><span class="cm">/* copy of on-disk metadata */</span>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="n">hammer2_off_t</span><span class="w">       </span><span class="n">osize</span><span class="p">;</span><span class="w">          </span><span class="cm">/* original size (for RESIZED) */</span>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="p">};</span>
</code></pre></div>
<p>Key fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>next</code></td>
<td>Hash chain linkage for inode number lookup</td>
</tr>
<tr>
<td><code>entry</code></td>
<td>Queue entry for SYNCQ (sync in progress) or SIDEQ (dirty, needs sync)</td>
</tr>
<tr>
<td><code>depend</code></td>
<td>Flush dependency group pointer</td>
</tr>
<tr>
<td><code>lock</code></td>
<td>Primary inode lock (shared/exclusive)</td>
</tr>
<tr>
<td><code>truncate_lock</code></td>
<td>Prevents truncates during read/write operations</td>
</tr>
<tr>
<td><code>pmp</code></td>
<td>Back-pointer to the PFS mount structure</td>
</tr>
<tr>
<td><code>vp</code></td>
<td>Associated vnode (NULL if no vnode attached)</td>
</tr>
<tr>
<td><code>cluster</code></td>
<td>Embedded cluster linking to underlying chains</td>
</tr>
<tr>
<td><code>flags</code></td>
<td>State flags (see below)</td>
</tr>
<tr>
<td><code>refs</code></td>
<td>Reference count (includes vnode ref, flush refs)</td>
</tr>
<tr>
<td><code>meta</code></td>
<td>In-memory copy of on-disk inode metadata</td>
</tr>
</tbody>
</table>
<h3 id="inode-flags">Inode Flags<a class="headerlink" href="#inode-flags" title="Permanent link"></a></h3>
<p>Defined in <code>hammer2.h:747-767</code>:</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_INODE_MODIFIED</code></td>
<td>0x0001</td>
<td>Inode metadata has been modified</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_ONHASH</code></td>
<td>0x0008</td>
<td>Inode is in the inum hash table</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_RESIZED</code></td>
<td>0x0010</td>
<td>File size changed, requires chain sync</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_ISUNLINKED</code></td>
<td>0x0040</td>
<td>Inode has been unlinked (nlinks  0)</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_SIDEQ</code></td>
<td>0x0100</td>
<td>On side processing queue (dirty, awaiting sync)</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_NOSIDEQ</code></td>
<td>0x0200</td>
<td>Disable SIDEQ operations</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_DIRTYDATA</code></td>
<td>0x0400</td>
<td>Has dirty data, interlocks flush</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_SYNCQ</code></td>
<td>0x0800</td>
<td>Currently being synced (on sync queue)</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_DELETING</code></td>
<td>0x1000</td>
<td>Marked for deletion during sync</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_CREATING</code></td>
<td>0x2000</td>
<td>Chains not yet inserted into media topology</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_SYNCQ_WAKEUP</code></td>
<td>0x4000</td>
<td>Wakeup requested when SYNCQ clears</td>
</tr>
<tr>
<td><code>HAMMER2_INODE_SYNCQ_PASS2</code></td>
<td>0x8000</td>
<td>Force retry delay during sync</td>
</tr>
</tbody>
</table>
<p>The <code>HAMMER2_INODE_DIRTY</code> macro combines flags indicating the inode needs flushing:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cp">#define HAMMER2_INODE_DIRTY  (HAMMER2_INODE_MODIFIED | \</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="cp">                              HAMMER2_INODE_DIRTYDATA | \</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="cp">                              HAMMER2_INODE_DELETING | \</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="cp">                              HAMMER2_INODE_CREATING)</span>
</code></pre></div></p>
<h3 id="hammer2_depend_t">hammer2_depend_t<a class="headerlink" href="#hammer2_depend_t" title="Permanent link"></a></h3>
<p>Flush dependency structure (<code>hammer2.h:673-679</code>):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_depend</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="n">TAILQ_ENTRY</span><span class="p">(</span><span class="n">hammer2_depend</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w">  </span><span class="cm">/* pmp-&gt;depq linkage */</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inoq_head</span><span class="w">    </span><span class="n">sideq</span><span class="p">;</span><span class="w">          </span><span class="cm">/* list of dependent inodes */</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="kt">long</span><span class="w">                </span><span class="n">count</span><span class="p">;</span><span class="w">          </span><span class="cm">/* number of inodes in group */</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">pass2</span><span class="p">;</span><span class="w">          </span><span class="cm">/* requires second pass */</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">unused01</span><span class="p">;</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="p">};</span>
</code></pre></div>
<p>Dependencies group related inodes (e.g., directory and its entries) to ensure they are flushed together, maintaining filesystem consistency.</p>
<h2 id="inode-hash-table">Inode Hash Table<a class="headerlink" href="#inode-hash-table" title="Permanent link"></a></h2>
<p>Inodes are indexed by inode number in a per-PFS hash table for fast lookup.</p>
<h3 id="initialization">Initialization<a class="headerlink" href="#initialization" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inum_hash_init</span><span class="p">(</span><span class="n">hammer2_pfs_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmp</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:50-60</code></p>
<p>Initializes the inode hash table spinlocks for a PFS. Called during PFS mount.</p>
<h3 id="lookup">Lookup<a class="headerlink" href="#lookup" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_inode_lookup</span><span class="p">(</span><span class="n">hammer2_pfs_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">inum</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:548-569</code></p>
<p>Looks up an inode by inode number. Returns a referenced inode or NULL if not found in memory. The hash function uses the low bits of the inode number:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">__inline</span><span class="w"> </span><span class="n">hammer2_inum_hash_t</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nf">inumhash</span><span class="p">(</span><span class="n">hammer2_pfs_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">inum</span><span class="p">)</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="p">{</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">hv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">inum</span><span class="p">;</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">inumhash</span><span class="p">[</span><span class="n">hv</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HAMMER2_INUMHASH_MASK</span><span class="p">]);</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="p">}</span>
</code></pre></div>
<h2 id="reference-counting">Reference Counting<a class="headerlink" href="#reference-counting" title="Permanent link"></a></h2>
<h3 id="adding-references">Adding References<a class="headerlink" href="#adding-references" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_ref</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:577-585</code></p>
<p>Atomically increments the reference count. The inode must already have at least one reference. Can be called with spinlocks held.</p>
<h3 id="dropping-references">Dropping References<a class="headerlink" href="#dropping-references" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_drop</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:591-656</code></p>
<p>Decrements the reference count. When the count reaches zero:</p>
<ol>
<li>Acquires the hash bucket spinlock</li>
<li>Removes the inode from the hash table (if <code>ONHASH</code> flag set)</li>
<li>Cleans out the embedded cluster via <code>hammer2_inode_repoint(ip, NULL)</code></li>
<li>Frees the inode structure</li>
</ol>
<p>The transition to zero is protected by <code>atomic_cmpset_int()</code> to handle races.</p>
<h2 id="locking">Locking<a class="headerlink" href="#locking" title="Permanent link"></a></h2>
<p>HAMMER2 provides shared and exclusive locks on inodes with special SYNCQ semantics.</p>
<h3 id="basic-locking">Basic Locking<a class="headerlink" href="#basic-locking" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_lock</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">how</span><span class="p">);</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_unlock</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:226-375</code></p>
<p>The <code>how</code> parameter accepts flags:</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_RESOLVE_SHARED</code></td>
<td>Acquire shared lock (no SYNCQ wait)</td>
</tr>
<tr>
<td><code>HAMMER2_RESOLVE_ALWAYS</code></td>
<td>Ensure inode metadata is resolved</td>
</tr>
<tr>
<td><code>HAMMER2_RESOLVE_NEVER</code></td>
<td>Don't require metadata resolution</td>
</tr>
</tbody>
</table>
<p><strong>SYNCQ Semantics</strong>: When acquiring an exclusive lock, if the inode is on the SYNCQ (being synced), the caller must wait for the sync to complete. This prevents metadata dependencies from being split across flushes. To reduce stall time, the inode is moved to the head of the syncq before blocking:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HAMMER2_INODE_SYNCQ</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pmp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="cm">/* Move to head of syncq and sleep */</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="n">TAILQ_REMOVE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">syncq</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="n">TAILQ_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">syncq</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="n">hammer2_mtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">PINTERLOCKED</span><span class="p">,</span><span class="w"> </span><span class="s">"h2sync"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="n">hammer2_mtx_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="p">}</span>
</code></pre></div>
<h3 id="multi-inode-locking">Multi-Inode Locking<a class="headerlink" href="#multi-inode-locking" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_lock4</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip2</span><span class="p">,</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">                         </span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip4</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:281-358</code></p>
<p>Exclusively locks up to four inodes simultaneously, establishing a flush dependency between them. Used for operations like rename that span multiple inodes. The function:</p>
<ol>
<li>References and locks all inodes in order</li>
<li>Establishes flush dependencies via <code>hammer2_inode_setdepend_locked()</code></li>
<li>If any inode is on SYNCQ, unlocks all and retries after sleeping</li>
</ol>
<h3 id="lock-upgradedowngrade">Lock Upgrade/Downgrade<a class="headerlink" href="#lock-upgradedowngrade" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_inode_lock_upgrade</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_lock_downgrade</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">wasexclusive</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:508-533</code></p>
<p>Upgrades a shared lock to exclusive, or downgrades back. The <code>wasexclusive</code> return value tracks whether the lock was already exclusive.</p>
<h3 id="temporary-releaserestore">Temporary Release/Restore<a class="headerlink" href="#temporary-releaserestore" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">hammer2_mtx_state_t</span><span class="w"> </span><span class="nf">hammer2_inode_lock_temp_release</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_lock_temp_restore</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_mtx_state_t</span><span class="w"> </span><span class="n">ostate</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:487-497</code></p>
<p>Temporarily releases a lock (to avoid deadlocks) and restores it later. Used by <code>hammer2_igetv()</code> when calling into the vnode layer.</p>
<h2 id="vnode-association">Vnode Association<a class="headerlink" href="#vnode-association" title="Permanent link"></a></h2>
<h3 id="getting-a-vnode-for-an-inode">Getting a Vnode for an Inode<a class="headerlink" href="#getting-a-vnode-for-an-inode" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">hammer2_igetv</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:669-816</code></p>
<p>Returns an exclusively locked vnode for the given inode, allocating one if necessary. The caller must hold the inode locked.</p>
<p><strong>Algorithm</strong>:</p>
<ol>
<li>If <code>ip-&gt;vp</code> is non-NULL, attempt to reuse the existing vnode via <code>vget()</code></li>
<li>If vget fails (lost reclaim race), retry</li>
<li>If no vnode exists, allocate via <code>getnewvnode()</code></li>
<li>Set vnode type based on <code>ip-&gt;meta.type</code>:</li>
<li><code>HAMMER2_OBJTYPE_DIRECTORY</code>  <code>VDIR</code></li>
<li><code>HAMMER2_OBJTYPE_REGFILE</code>  <code>VREG</code> (with buffer cache)</li>
<li><code>HAMMER2_OBJTYPE_SOFTLINK</code>  <code>VLNK</code></li>
<li><code>HAMMER2_OBJTYPE_CDEV/BDEV</code>  <code>VCHR/VBLK</code></li>
<li><code>HAMMER2_OBJTYPE_FIFO</code>  <code>VFIFO</code></li>
<li><code>HAMMER2_OBJTYPE_SOCKET</code>  <code>VSOCK</code></li>
<li>Link vnode and inode: <code>vp-&gt;v_data = ip; ip-&gt;vp = vp;</code></li>
<li>Add reference for vnode association</li>
</ol>
<p><strong>Deadlock Avoidance</strong>: The inode lock must be temporarily released during <code>vget()</code> to avoid deadlocking against vnode reclaim:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">vhold</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="n">ostate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hammer2_inode_lock_temp_release</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vget</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">LK_EXCLUSIVE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* retry */</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="n">hammer2_inode_lock_temp_restore</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">ostate</span><span class="p">);</span>
<a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="n">vdrop</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>
</code></pre></div>
<h2 id="inode-creation">Inode Creation<a class="headerlink" href="#inode-creation" title="Permanent link"></a></h2>
<h3 id="creating-normal-inodes">Creating Normal Inodes<a class="headerlink" href="#creating-normal-inodes" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nf">hammer2_inode_create_normal</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">pip</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vattr</span><span class="w"> </span><span class="o">*</span><span class="n">vap</span><span class="p">,</span>
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">                            </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="o">*</span><span class="n">cred</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="n">inum</span><span class="p">,</span>
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">                            </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1121-1263</code></p>
<p>Creates a new inode (file, directory, symlink, device, etc.) as a child of the parent inode <code>pip</code>. The function:</p>
<ol>
<li>Allocates an in-memory inode via <code>hammer2_inode_get()</code></li>
<li>Sets <code>HAMMER2_INODE_CREATING</code> flag (chains not yet in media topology)</li>
<li>Initializes metadata from <code>vattr</code> and parent attributes</li>
<li>Inherits compression/checksum algorithms from parent</li>
<li>Creates detached media chains via <code>hammer2_inode_create_det_desc</code> XOP</li>
<li>Associates chains with inode via <code>hammer2_inode_repoint()</code></li>
</ol>
<p><strong>Note</strong>: The chains are created detached (not inserted into the on-disk tree). They will be inserted during the next filesystem sync when <code>hammer2_inode_chain_ins()</code> is called.</p>
<h3 id="creating-pfs-inodes">Creating PFS Inodes<a class="headerlink" href="#creating-pfs-inodes" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="nf">hammer2_inode_create_pfs</span><span class="p">(</span><span class="n">hammer2_pfs_t</span><span class="w"> </span><span class="o">*</span><span class="n">spmp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">                         </span><span class="kt">size_t</span><span class="w"> </span><span class="n">name_len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:988-1112</code></p>
<p>Creates a PFS (Pseudo File System) root inode under the superroot. Unlike normal inodes, PFS inodes are inserted immediately (requires flush transaction).</p>
<h3 id="creating-directory-entries">Creating Directory Entries<a class="headerlink" href="#creating-directory-entries" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_dirent_create</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">dip</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">                          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">name_len</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="n">inum</span><span class="p">,</span>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">                          </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1273-1352</code></p>
<p>Creates a directory entry linking a name to an inode number. Handles hash collisions by scanning for an unused key in the collision space:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">lhc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hammer2_dirhash</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name_len</span><span class="p">);</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="cm">/* Scan for unused key if collision */</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">hammer2_xop_collect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sxop</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lhc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">sxop</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">focus</span><span class="o">-&gt;</span><span class="n">bref</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="o">++</span><span class="n">lhc</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Try next slot */</span>
<a href="#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="p">}</span>
</code></pre></div>
<h2 id="inode-lookup-and-caching">Inode Lookup and Caching<a class="headerlink" href="#inode-lookup-and-caching" title="Permanent link"></a></h2>
<h3 id="hammer2_inode_get">hammer2_inode_get<a class="headerlink" href="#hammer2_inode_get" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="nf">hammer2_inode_get</span><span class="p">(</span><span class="n">hammer2_pfs_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_xop_head_t</span><span class="w"> </span><span class="o">*</span><span class="n">xop</span><span class="p">,</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">                  </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">inum</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:845-979</code></p>
<p>Gets or creates an inode structure. If <code>xop</code> is provided, synchronizes the inode's cluster with the XOP's cluster. The function:</p>
<ol>
<li>Looks up existing inode via <code>hammer2_inode_lookup()</code></li>
<li>If found, repoints cluster chains and returns</li>
<li>If not found, allocates new <code>hammer2_inode_t</code></li>
<li>Initializes cluster, metadata, locks</li>
<li>Attempts to insert into hash table (handles races)</li>
</ol>
<h2 id="cluster-repointing">Cluster Repointing<a class="headerlink" href="#cluster-repointing" title="Permanent link"></a></h2>
<h3 id="full-cluster-repoint">Full Cluster Repoint<a class="headerlink" href="#full-cluster-repoint" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_repoint</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_cluster_t</span><span class="w"> </span><span class="o">*</span><span class="n">cluster</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1364-1463</code></p>
<p>Replaces all chains in the inode's embedded cluster with chains from the provided cluster. Also clears any cached data chains. Pass <code>NULL</code> to clean out all chains.</p>
<h3 id="single-chain-repoint">Single Chain Repoint<a class="headerlink" href="#single-chain-repoint" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_repoint_one</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_cluster_t</span><span class="w"> </span><span class="o">*</span><span class="n">cluster</span><span class="p">,</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1470-1529</code></p>
<p>Repoints a single chain element. Used by synchronization threads for piecemeal updates.</p>
<h2 id="modification-and-synchronization">Modification and Synchronization<a class="headerlink" href="#modification-and-synchronization" title="Permanent link"></a></h2>
<h3 id="marking-inodes-modified">Marking Inodes Modified<a class="headerlink" href="#marking-inodes-modified" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_modify</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1674-1682</code></p>
<p>Marks an inode as modified:</p>
<ol>
<li>Sets <code>HAMMER2_INODE_MODIFIED</code> flag</li>
<li>Marks associated vnode dirty via <code>vsetisdirty()</code></li>
<li>Adds inode to SIDEQ via <code>hammer2_inode_delayed_sideq()</code> (unless NOSIDEQ)</li>
</ol>
<p>Can be called with shared or exclusive lock.</p>
<h3 id="syncing-to-chains">Syncing to Chains<a class="headerlink" href="#syncing-to-chains" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_inode_chain_sync</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1694-1736</code></p>
<p>Synchronizes the inode's frontend state with the chain state. Called before explicit flush or strategy write. Uses the <code>hammer2_inode_chain_sync_desc</code> XOP to propagate metadata changes.</p>
<p>Handles <code>RESIZED</code> flag specially  if file grew past embedded bytes, clears <code>DIRECTDATA</code> flag.</p>
<h3 id="inserting-chains">Inserting Chains<a class="headerlink" href="#inserting-chains" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_inode_chain_ins</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1742-1767</code></p>
<p>Inserts the inode's chains into the on-media tree. Called during sync for inodes with <code>INODE_CREATING</code> flag. Clears the flag upon success.</p>
<h3 id="deleting-chains">Deleting Chains<a class="headerlink" href="#deleting-chains" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_inode_chain_des</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1781-1806</code></p>
<p>Removes the inode's chains from the media topology. Called during sync for inodes with <code>INODE_DELETING</code> flag. Clears both <code>DELETING</code> and <code>ISUNLINKED</code> flags.</p>
<h3 id="flushing-to-media">Flushing to Media<a class="headerlink" href="#flushing-to-media" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_inode_chain_flush</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1816-1831</code></p>
<p>Flushes the inode's chain and sub-topology to media. Clears <code>DIRTYDATA</code> flag before flush. Uses <code>hammer2_inode_flush_desc</code> XOP.</p>
<h2 id="unlink-handling">Unlink Handling<a class="headerlink" href="#unlink-handling" title="Permanent link"></a></h2>
<h3 id="finishing-unlink">Finishing Unlink<a class="headerlink" href="#finishing-unlink" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_inode_unlink_finisher</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">**</span><span class="n">vprecyclep</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1567-1631</code></p>
<p>Called after <code>xop_unlink</code> to decrement nlinks and handle final deletion:</p>
<ol>
<li>If <code>nlinks &gt; 1</code>, just decrement and update ctime</li>
<li>If <code>nlinks &lt;= 1</code>:</li>
<li>Sets <code>ISUNLINKED</code> flag</li>
<li>If no vnode, sets <code>DELETING</code> and adds to SIDEQ</li>
<li>If vnode exists, defers vnode recycling to VOP completion</li>
<li>Updates metadata via <code>hammer2_inode_modify()</code></li>
</ol>
<h3 id="vnode-recycling">Vnode Recycling<a class="headerlink" href="#vnode-recycling" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_vprecycle</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1641-1652</code></p>
<p>Aggressively recycles a vnode after file deletion. Called at the end of VOPs that remove files. Without this, deleted files can linger with nlinks==0 until random system activity reclaims the vnode.</p>
<h2 id="flush-dependency-management">Flush Dependency Management<a class="headerlink" href="#flush-dependency-management" title="Permanent link"></a></h2>
<h3 id="sideq-and-syncq">SIDEQ and SYNCQ<a class="headerlink" href="#sideq-and-syncq" title="Permanent link"></a></h3>
<p>Inodes that need flushing are managed through two queues:</p>
<ul>
<li><strong>SIDEQ</strong> (Side Queue): Dirty inodes awaiting the next sync. Inodes without an attached vnode go here to ensure they're not missed by the vnode-based syncer.</li>
<li><strong>SYNCQ</strong> (Sync Queue): Inodes currently being synced. During sync, inodes are moved from SIDEQ to SYNCQ.</li>
</ul>
<h3 id="dependency-groups">Dependency Groups<a class="headerlink" href="#dependency-groups" title="Permanent link"></a></h3>
<p>Related inodes are grouped via <code>hammer2_depend_t</code> structures to ensure atomic flushing:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_depend</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip2</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:389-400</code></p>
<p>Merges two inodes into a single dependency group. Used to ensure directory entries and their target inodes are flushed together.</p>
<h3 id="adding-to-sideq">Adding to SIDEQ<a class="headerlink" href="#adding-to-sideq" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_inode_delayed_sideq</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:176-189</code></p>
<p>Adds a dirty inode to the SIDEQ. Called from <code>hammer2_inode_modify()</code> and other places that dirty an inode.</p>
<h2 id="statistics">Statistics<a class="headerlink" href="#statistics" title="Permanent link"></a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="n">hammer2_key_t</span><span class="w"> </span><span class="nf">hammer2_inode_data_count</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
<a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="n">hammer2_key_t</span><span class="w"> </span><span class="nf">hammer2_inode_inode_count</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:1531-1561</code></p>
<p>Returns the maximum data/inode count across all chains in the inode's cluster. Used for filesystem statistics.</p>
<h2 id="chain-access">Chain Access<a class="headerlink" href="#chain-access" title="Permanent link"></a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_inode_chain</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">clindex</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">how</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:407-427</code></p>
<p>Selects and locks a chain from the inode's cluster. The inode doesn't need to be locked. Returns a referenced and locked chain.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-33-2" id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="nf">hammer2_inode_chain_and_parent</span><span class="p">(</span><span class="n">hammer2_inode_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">clindex</span><span class="p">,</span>
<a href="#__codelineno-33-3" id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">                               </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">parentp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">how</span><span class="p">);</span>
</code></pre></div>
<p>Source: <code>hammer2_inode.c:429-478</code></p>
<p>Returns both a chain and its parent, properly locked. Handles lock ordering (parent before chain) and retries if the topology changes during locking.</p>
<h2 id="lifecycle-summary">Lifecycle Summary<a class="headerlink" href="#lifecycle-summary" title="Permanent link"></a></h2>
<pre class="mermaid"><code>flowchart TB
    subgraph creation["Creation"]
        CREATE["hammer2_inode_create_normal()"] --&gt; |"allocate + CREATING flag"| INMEM["In-Memory Inode"]
        GET["hammer2_inode_get()<br/>(lookup/create)"] --&gt; INMEM
    end

    subgraph operations["Operations"]
        INMEM --&gt; IGETV["hammer2_igetv()<br/>(get vnode)"]
        INMEM --&gt; MODIFY["modify()<br/>(SIDEQ)"]
        INMEM --&gt; UNLINK["unlink_finisher()"]
    end

    subgraph sync["Filesystem Sync"]
        MODIFY --&gt; FSSYNC["Filesystem Sync"]
        UNLINK --&gt; |"ISUNLINKED<br/>DELETING"| FSSYNC
    end

    subgraph chainops["Chain Operations"]
        FSSYNC --&gt; INS["chain_ins()<br/>(insert chains)"]
        FSSYNC --&gt; CSYNC["chain_sync()<br/>(sync metadata)"]
        FSSYNC --&gt; DES["chain_des()<br/>(delete chains)"]
    end

    subgraph flush["Flush"]
        INS --&gt; CFLUSH["chain_flush()<br/>(write to disk)"]
        CSYNC --&gt; CFLUSH
        DES --&gt; CFLUSH
    end
</code></pre>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link"></a></h2>
<ul>
<li><a href="../">HAMMER2 Overview</a>  Filesystem architecture</li>
<li><a href="../chain-layer/">Chain Layer</a>  Underlying block management</li>
<li><a href="../vfs-integration/">VFS Integration</a>  VFS operations implementation</li>
<li><a href="../xop-system/">XOP System</a>  Cross-cluster operations</li>
<li><a href="../flush-sync/">Flush and Sync</a>  Synchronization mechanisms</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>