
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../compression/" rel="prev"/>
<link href="../clustering/" rel="next"/>
<link href="../../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Snapshots - DragonFly BSD Kernel Documentation</title>
<link href="../../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#hammer2-snapshots">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Snapshots
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_4_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_4_2">
<span class="md-nav__icon md-icon"></span>
            
  
    HAMMER2
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../on-disk-format/">
<span class="md-ellipsis">
    
  
    On-Disk Format
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chain-layer/">
<span class="md-ellipsis">
    
  
    Chain Layer
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../inode-layer/">
<span class="md-ellipsis">
    
  
    Inode Layer
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../io-subsystem/">
<span class="md-ellipsis">
    
  
    I/O Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../flush-sync/">
<span class="md-ellipsis">
    
  
    Flush &amp; Sync
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../freemap/">
<span class="md-ellipsis">
    
  
    Freemap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../xop-system/">
<span class="md-ellipsis">
    
  
    XOP System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs-integration/">
<span class="md-ellipsis">
    
  
    VFS Integration
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../compression/">
<span class="md-ellipsis">
    
  
    Compression
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Snapshots
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Snapshots
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-architecture">
<span class="md-ellipsis">
      
        Snapshot Architecture
      
    </span>
</a>
<nav aria-label="Snapshot Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#pfs-based-design">
<span class="md-ellipsis">
      
        PFS-Based Design
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#transaction-id-tracking">
<span class="md-ellipsis">
      
        Transaction ID Tracking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-sharing-model">
<span class="md-ellipsis">
      
        Block Sharing Model
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-creation">
<span class="md-ellipsis">
      
        Snapshot Creation
      
    </span>
</a>
<nav aria-label="Snapshot Creation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#userland-interface">
<span class="md-ellipsis">
      
        Userland Interface
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creation-flow">
<span class="md-ellipsis">
      
        Creation Flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-implementation-details">
<span class="md-ellipsis">
      
        Key Implementation Details
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write-preservation">
<span class="md-ellipsis">
      
        Copy-on-Write Preservation
      
    </span>
</a>
<nav aria-label="Copy-on-Write Preservation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-cow-decision">
<span class="md-ellipsis">
      
        The COW Decision
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decision-logic">
<span class="md-ellipsis">
      
        Decision Logic
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-preservation-rules">
<span class="md-ellipsis">
      
        Snapshot Preservation Rules
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example-scenario">
<span class="md-ellipsis">
      
        Example Scenario
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#emergency-mode">
<span class="md-ellipsis">
      
        Emergency Mode
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#accessing-snapshots">
<span class="md-ellipsis">
      
        Accessing Snapshots
      
    </span>
</a>
<nav aria-label="Accessing Snapshots" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#listing-snapshots">
<span class="md-ellipsis">
      
        Listing Snapshots
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mounting-snapshots">
<span class="md-ellipsis">
      
        Mounting Snapshots
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-deletion">
<span class="md-ellipsis">
      
        Snapshot Deletion
      
    </span>
</a>
<nav aria-label="Snapshot Deletion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#deleting-a-snapshot">
<span class="md-ellipsis">
      
        Deleting a Snapshot
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#space-reclamation">
<span class="md-ellipsis">
      
        Space Reclamation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pfs-subtypes">
<span class="md-ellipsis">
      
        PFS Subtypes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#synchronization-considerations">
<span class="md-ellipsis">
      
        Synchronization Considerations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-related-fields-in-hammer2_inode_meta">
<span class="md-ellipsis">
      
        Snapshot-Related Fields in hammer2_inode_meta
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ioctl-structure">
<span class="md-ellipsis">
      
        Ioctl Structure
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-notes">
<span class="md-ellipsis">
      
        Implementation Notes
      
    </span>
</a>
<nav aria-label="Implementation Notes" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bulkfree-lock">
<span class="md-ellipsis">
      
        Bulkfree Lock
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-number-space">
<span class="md-ellipsis">
      
        Inode Number Space
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clustering/">
<span class="md-ellipsis">
    
  
    Clustering
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    net/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    net/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/interfaces/">
<span class="md-ellipsis">
    
  
    Network Interfaces
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/netisr/">
<span class="md-ellipsis">
    
  
    Network ISR
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-architecture">
<span class="md-ellipsis">
      
        Snapshot Architecture
      
    </span>
</a>
<nav aria-label="Snapshot Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#pfs-based-design">
<span class="md-ellipsis">
      
        PFS-Based Design
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#transaction-id-tracking">
<span class="md-ellipsis">
      
        Transaction ID Tracking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-sharing-model">
<span class="md-ellipsis">
      
        Block Sharing Model
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-creation">
<span class="md-ellipsis">
      
        Snapshot Creation
      
    </span>
</a>
<nav aria-label="Snapshot Creation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#userland-interface">
<span class="md-ellipsis">
      
        Userland Interface
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creation-flow">
<span class="md-ellipsis">
      
        Creation Flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-implementation-details">
<span class="md-ellipsis">
      
        Key Implementation Details
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write-preservation">
<span class="md-ellipsis">
      
        Copy-on-Write Preservation
      
    </span>
</a>
<nav aria-label="Copy-on-Write Preservation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-cow-decision">
<span class="md-ellipsis">
      
        The COW Decision
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decision-logic">
<span class="md-ellipsis">
      
        Decision Logic
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-preservation-rules">
<span class="md-ellipsis">
      
        Snapshot Preservation Rules
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example-scenario">
<span class="md-ellipsis">
      
        Example Scenario
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#emergency-mode">
<span class="md-ellipsis">
      
        Emergency Mode
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#accessing-snapshots">
<span class="md-ellipsis">
      
        Accessing Snapshots
      
    </span>
</a>
<nav aria-label="Accessing Snapshots" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#listing-snapshots">
<span class="md-ellipsis">
      
        Listing Snapshots
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mounting-snapshots">
<span class="md-ellipsis">
      
        Mounting Snapshots
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-deletion">
<span class="md-ellipsis">
      
        Snapshot Deletion
      
    </span>
</a>
<nav aria-label="Snapshot Deletion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#deleting-a-snapshot">
<span class="md-ellipsis">
      
        Deleting a Snapshot
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#space-reclamation">
<span class="md-ellipsis">
      
        Space Reclamation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pfs-subtypes">
<span class="md-ellipsis">
      
        PFS Subtypes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#synchronization-considerations">
<span class="md-ellipsis">
      
        Synchronization Considerations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshot-related-fields-in-hammer2_inode_meta">
<span class="md-ellipsis">
      
        Snapshot-Related Fields in hammer2_inode_meta
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ioctl-structure">
<span class="md-ellipsis">
      
        Ioctl Structure
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-notes">
<span class="md-ellipsis">
      
        Implementation Notes
      
    </span>
</a>
<nav aria-label="Implementation Notes" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bulkfree-lock">
<span class="md-ellipsis">
      
        Bulkfree Lock
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inode-number-space">
<span class="md-ellipsis">
      
        Inode Number Space
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="hammer2-snapshots">HAMMER2 Snapshots<a class="headerlink" href="#hammer2-snapshots" title="Permanent link">¶</a></h1>
<p>This document describes HAMMER2's snapshot implementation, which provides instant,
space-efficient point-in-time copies of filesystem state using copy-on-write semantics.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h2>
<p>HAMMER2 snapshots leverage the copy-on-write (COW) architecture to create instant
point-in-time copies of a PFS (pseudo-filesystem). Unlike traditional backup methods,
snapshots:</p>
<ul>
<li>Are created <strong>instantaneously</strong> regardless of filesystem size</li>
<li>Share unchanged data blocks with the source PFS (space-efficient)</li>
<li>Are <strong>read-write</strong> and can be mounted independently</li>
<li>Are preserved through the COW mechanism until explicitly deleted</li>
</ul>
<p>Each snapshot is a complete, self-contained PFS that appears in the super-root
alongside regular PFSes. The snapshot shares its entire block tree with the
source at creation time; subsequent modifications to either the source or
snapshot cause blocks to diverge through copy-on-write.</p>
<p><strong>Source files:</strong></p>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hammer2_ioctl.c</code></td>
<td>Snapshot ioctl implementation</td>
</tr>
<tr>
<td><code>hammer2_chain.c</code></td>
<td>COW logic with snapshot preservation</td>
</tr>
<tr>
<td><code>hammer2_disk.h</code></td>
<td>On-disk structures (<code>pfs_lsnap_tid</code>)</td>
</tr>
<tr>
<td><code>sbin/hammer2/cmd_snapshot.c</code></td>
<td>Userland snapshot command</td>
</tr>
</tbody>
</table>
<h2 id="snapshot-architecture">Snapshot Architecture<a class="headerlink" href="#snapshot-architecture" title="Permanent link">¶</a></h2>
<h3 id="pfs-based-design">PFS-Based Design<a class="headerlink" href="#pfs-based-design" title="Permanent link">¶</a></h3>
<p>Snapshots are implemented as PFS inodes stored in the super-root:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Super-Root (SUPROOT)
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>├── ROOT                    (MASTER, pfs_subtype=NONE)
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>├── ROOT.20231215.143022    (MASTER, pfs_subtype=SNAPSHOT)
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>├── ROOT.20231220.091500    (MASTER, pfs_subtype=SNAPSHOT)
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>└── DATA                    (MASTER, pfs_subtype=NONE)
</code></pre></div>
<p>Each snapshot has:</p>
<ul>
<li><strong>Unique <code>pfs_fsid</code></strong> — Private filesystem identifier (generated at creation)</li>
<li><strong>Unique <code>pfs_clid</code></strong> — Private cluster identifier (generated at creation)</li>
<li><strong><code>pfs_type = MASTER</code></strong> — Full read-write capability</li>
<li><strong><code>pfs_subtype = SNAPSHOT</code></strong> — Identifies it as a snapshot</li>
</ul>
<h3 id="transaction-id-tracking">Transaction ID Tracking<a class="headerlink" href="#transaction-id-tracking" title="Permanent link">¶</a></h3>
<p>The key field enabling snapshot preservation is <code>pfs_lsnap_tid</code> (last snapshot
transaction ID), stored in the PFS inode metadata:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cm">/* hammer2_disk.h:994 */</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">hammer2_tid_t</span><span class="w">   </span><span class="n">pfs_lsnap_tid</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 00D0 last snapshot tid */</span>
</code></pre></div>
<p>This field records the transaction ID at which the most recent snapshot was taken.
It serves as a boundary marker for the copy-on-write decision logic.</p>
<h3 id="block-sharing-model">Block Sharing Model<a class="headerlink" href="#block-sharing-model" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>graph TB
    subgraph "After Snapshot Creation"
        SR[Super-Root]
        SRC[Source PFS<br/>pfs_lsnap_tid = T100]
        SNAP[Snapshot PFS<br/>pfs_lsnap_tid = T100]

        BS[Shared Blockset<br/>modify_tid ≤ T100]

        SR --&gt; SRC
        SR --&gt; SNAP
        SRC -.-&gt;|"references"| BS
        SNAP -.-&gt;|"references"| BS
    end

    subgraph "After Source Modification"
        SR2[Super-Root]
        SRC2[Source PFS]
        SNAP2[Snapshot PFS]

        BS2[Original Blocks<br/>modify_tid ≤ T100]
        NB[New Block<br/>modify_tid = T150]

        SR2 --&gt; SRC2
        SR2 --&gt; SNAP2
        SRC2 -.-&gt;|"new data"| NB
        SRC2 -.-&gt;|"unchanged"| BS2
        SNAP2 -.-&gt;|"preserved"| BS2
    end
</code></pre>
<h2 id="snapshot-creation">Snapshot Creation<a class="headerlink" href="#snapshot-creation" title="Permanent link">¶</a></h2>
<h3 id="userland-interface">Userland Interface<a class="headerlink" href="#userland-interface" title="Permanent link">¶</a></h3>
<p>Snapshots are created using the <code>hammer2</code> utility:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># Create snapshot with auto-generated name (PFS.YYYYMMDD.HHMMSS)</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>hammer2<span class="w"> </span>pfs-snapshot<span class="w"> </span>/mountpoint
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="c1"># Create snapshot with custom label</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>hammer2<span class="w"> </span>pfs-snapshot<span class="w"> </span>/mountpoint<span class="w"> </span>mylabel
</code></pre></div>
<p>The naming convention for auto-generated snapshots is:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>&lt;pfs_name&gt;.&lt;YYYYMMDD&gt;.&lt;HHMMSS&gt;
</code></pre></div></p>
<h3 id="creation-flow">Creation Flow<a class="headerlink" href="#creation-flow" title="Permanent link">¶</a></h3>
<p>The snapshot creation process is handled by <code>hammer2_ioctl_pfs_snapshot()</code>:</p>
<pre class="mermaid"><code>graph TB
    A[hammer2 pfs-snapshot] --&gt;|HAMMER2IOC_PFS_SNAPSHOT| B[hammer2_ioctl_pfs_snapshot]
    B --&gt; C[Acquire bulklk exclusive]
    C --&gt; D{NOSYNC flag?}
    D --&gt;|No| E[hammer2_vfs_sync<br/>Flush filesystem]
    D --&gt;|Yes| F[Skip sync<br/>Debug mode only]
    E --&gt; G[hammer2_trans_init<br/>ISFLUSH transaction]
    F --&gt; H[hammer2_trans_init<br/>Normal transaction]
    G --&gt; I[Set source pfs_lsnap_tid = mtid]
    H --&gt; I
    I --&gt; J[hammer2_inode_create_pfs<br/>Create snapshot PFS in super-root]
    J --&gt; K[Configure snapshot metadata]
    K --&gt; L[Copy blockset from source]
    L --&gt; M[hammer2_inode_chain_flush<br/>Flush snapshot PFS]
    M --&gt; N[hammer2_pfsalloc<br/>Allocate PFS structures]
    N --&gt; O[Release bulklk]
</code></pre>
<h3 id="key-implementation-details">Key Implementation Details<a class="headerlink" href="#key-implementation-details" title="Permanent link">¶</a></h3>
<p><strong>Step 1: Filesystem Synchronization</strong> (<code>hammer2_ioctl.c:842-845</code>)</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pfs</span><span class="o">-&gt;</span><span class="n">pfs_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HAMMER2_PFSFLAGS_NOSYNC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="n">hammer2_trans_init</span><span class="p">(</span><span class="n">pmp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">hammer2_vfs_sync</span><span class="p">(</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="n">MNT_WAIT</span><span class="p">);</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">hammer2_trans_init</span><span class="p">(</span><span class="n">pmp</span><span class="p">,</span><span class="w"> </span><span class="n">HAMMER2_TRANS_ISFLUSH</span><span class="p">);</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="p">}</span>
</code></pre></div>
<p>The filesystem is fully synchronized before snapshot creation to ensure
a consistent point-in-time image. The <code>NOSYNC</code> flag exists only for
debugging/testing purposes.</p>
<p><strong>Step 2: Record Snapshot Transaction ID</strong> (<code>hammer2_ioctl.c:846-849</code>)</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">mtid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hammer2_trans_sub</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">hammer2_inode_lock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">hammer2_inode_modify</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="n">ip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtid</span><span class="p">;</span>
</code></pre></div>
<p>The current transaction ID is recorded as <code>pfs_lsnap_tid</code> on the <strong>source</strong> PFS.
This marks the boundary for future COW decisions.</p>
<p><strong>Step 3: Create Snapshot PFS</strong> (<code>hammer2_ioctl.c:874</code>)</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">nip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hammer2_inode_create_pfs</span><span class="p">(</span><span class="n">hmp</span><span class="o">-&gt;</span><span class="n">spmp</span><span class="p">,</span><span class="w"> </span><span class="n">pfs</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name_len</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</code></pre></div>
<p>A new PFS inode is created in the super-root with the specified name.</p>
<p><strong>Step 4: Configure Snapshot Metadata</strong> (<code>hammer2_ioctl.c:890-911</code>)</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_inum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">starting_inum</span><span class="p">;</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAMMER2_PFSTYPE_MASTER</span><span class="p">;</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_subtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAMMER2_PFSSUBTYPE_SNAPSHOT</span><span class="p">;</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">op_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">HAMMER2_OPFLAG_PFSROOT</span><span class="p">;</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtid</span><span class="p">;</span>
<a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="n">kern_uuidgen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_fsid</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="n">kern_uuidgen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_clid</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<p>The snapshot receives:</p>
<ul>
<li>Its own starting inode number range</li>
<li>Type <code>MASTER</code> with subtype <code>SNAPSHOT</code></li>
<li>The same <code>pfs_lsnap_tid</code> as the source</li>
<li>New unique UUIDs for <code>pfs_fsid</code> and <code>pfs_clid</code></li>
</ul>
<p><strong>Step 5: Copy Blockset</strong> (<code>hammer2_ioctl.c:917-919</code>)</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">wipdata</span><span class="o">-&gt;</span><span class="n">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">;</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">hammer2_spin_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">blockset_spin</span><span class="p">);</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="n">wipdata</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">blockset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">pfs_iroot_blocksets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="n">hammer2_spin_unex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">blockset_spin</span><span class="p">);</span>
</code></pre></div>
<p>The blockset (array of block references to the PFS root's children) is copied
from the source to the snapshot. This is the key operation that makes the
snapshot share all blocks with the source.</p>
<h2 id="copy-on-write-preservation">Copy-on-Write Preservation<a class="headerlink" href="#copy-on-write-preservation" title="Permanent link">¶</a></h2>
<h3 id="the-cow-decision">The COW Decision<a class="headerlink" href="#the-cow-decision" title="Permanent link">¶</a></h3>
<p>When modifying a block, HAMMER2 must decide whether to:</p>
<ol>
<li><strong>Overwrite in place</strong> — Reuse the existing block location</li>
<li><strong>Copy-on-write</strong> — Allocate a new block, leaving the original intact</li>
</ol>
<p>The decision is made in <code>hammer2_chain_modify()</code> based on <code>pfs_lsnap_tid</code>:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="cm">/* hammer2_chain.c:1504-1538 */</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">bref</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HAMMER2_BREF_TYPE_DATA</span><span class="w"> </span><span class="o">||</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">     </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">bref</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HAMMER2_BREF_TYPE_DIRENT</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HAMMER2_CHAIN_INITIAL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HAMMER2_CHAIN_DEDUPABLE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="n">HAMMER2_DEC_CHECK</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">bref</span><span class="p">.</span><span class="n">methods</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HAMMER2_CHECK_NONE</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">bref</span><span class="p">.</span><span class="n">modify_tid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">iroot</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">        </span><span class="cm">/* Overwrite in place allowed */</span>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">        </span><span class="n">newmod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">        </span><span class="cm">/* Must copy-on-write */</span>
<a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">        </span><span class="n">newmod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="p">}</span>
</code></pre></div>
<h3 id="decision-logic">Decision Logic<a class="headerlink" href="#decision-logic" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>graph TB
    A[Block Modification Request] --&gt; B{Block type is<br/>DATA or DIRENT?}
    B --&gt;|No| COW[Copy-on-Write Required]
    B --&gt;|Yes| C{CHAIN_INITIAL<br/>flag set?}
    C --&gt;|Yes| COW
    C --&gt;|No| D{CHAIN_DEDUPABLE<br/>flag set?}
    D --&gt;|Yes| COW
    D --&gt;|No| E{Check mode<br/>is NONE?}
    E --&gt;|No| COW
    E --&gt;|Yes| F{modify_tid &gt;<br/>pfs_lsnap_tid?}
    F --&gt;|No| COW
    F --&gt;|Yes| OIP[Overwrite In Place<br/>Allowed]

    style COW fill:#f96
    style OIP fill:#9f6
</code></pre>
<h3 id="snapshot-preservation-rules">Snapshot Preservation Rules<a class="headerlink" href="#snapshot-preservation-rules" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Condition</th>
<th>Result</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>modify_tid &gt; pfs_lsnap_tid</code></td>
<td>May overwrite</td>
<td>Block created after last snapshot</td>
</tr>
<tr>
<td><code>modify_tid &lt;= pfs_lsnap_tid</code></td>
<td>Must COW</td>
<td>Block may be referenced by snapshot</td>
</tr>
<tr>
<td>Check mode != NONE</td>
<td>Must COW</td>
<td>Data integrity verification required</td>
</tr>
<tr>
<td>DEDUPABLE flag set</td>
<td>Must COW</td>
<td>Block may be dedup source</td>
</tr>
</tbody>
</table>
<h3 id="example-scenario">Example Scenario<a class="headerlink" href="#example-scenario" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>Timeline:
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>  T=100: Snapshot created, pfs_lsnap_tid = 100
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>  T=150: File modified
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>Block states:
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>  Block A: modify_tid = 80  → COW required (80 ≤ 100)
<a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>  Block B: modify_tid = 120 → May overwrite if CHECK_NONE (120 &gt; 100)
</code></pre></div>
<p>When Block A is modified at T=150:</p>
<ol>
<li>New block allocated at different location</li>
<li>New block gets <code>modify_tid = 150</code></li>
<li>Original Block A preserved (snapshot still references it)</li>
<li>Parent chain updated to point to new block</li>
</ol>
<h2 id="emergency-mode">Emergency Mode<a class="headerlink" href="#emergency-mode" title="Permanent link">¶</a></h2>
<p>In emergency situations (e.g., filesystem nearly full), HAMMER2 can relax the
COW requirement using the <code>HMNT2_EMERG</code> flag:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="cm">/* hammer2_chain.c:1517-1532 */</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">hmp</span><span class="o">-&gt;</span><span class="n">hflags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HMNT2_EMERG</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">           </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">           </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">bref</span><span class="p">.</span><span class="n">modify_tid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">iroot</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">        </span><span class="cm">/* Emergency: modify-in-place on any chain type */</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">        </span><span class="n">newmod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Emergency Mode Risks</p>
<p>Emergency mode modifications are <strong>NOT SAFE</strong>. A power failure, storage
failure, or panic during emergency mode can corrupt the filesystem.
This mode should only be used as a last resort when space is critically low.</p>
</div>
<h2 id="accessing-snapshots">Accessing Snapshots<a class="headerlink" href="#accessing-snapshots" title="Permanent link">¶</a></h2>
<h3 id="listing-snapshots">Listing Snapshots<a class="headerlink" href="#listing-snapshots" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1"># List all PFSes including snapshots</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>hammer2<span class="w"> </span>pfs-list<span class="w"> </span>/mountpoint
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="c1"># Example output:</span>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a>Type<span class="w">        </span>ClusterId<span class="w"> </span><span class="o">(</span>pfs_clid<span class="o">)</span><span class="w">                 </span>Label
<a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>MASTER<span class="w">      </span><span class="m">12345678</span>-1234-1234-1234-123456789abc<span class="w"> </span>ROOT
<a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>SNAPSHOT<span class="w">    </span>abcdef01-2345-6789-abcd-ef0123456789<span class="w"> </span>ROOT.20231215.143022
<a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>SNAPSHOT<span class="w">    </span>fedcba98-7654-3210-fedc-ba9876543210<span class="w"> </span>ROOT.20231220.091500
</code></pre></div>
<h3 id="mounting-snapshots">Mounting Snapshots<a class="headerlink" href="#mounting-snapshots" title="Permanent link">¶</a></h3>
<p>Snapshots can be mounted read-write as independent filesystems:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># Mount a specific snapshot</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>mount<span class="w"> </span>-t<span class="w"> </span>hammer2<span class="w"> </span>/dev/serno/XXXX@ROOT.20231215.143022<span class="w"> </span>/mnt/snapshot
</code></pre></div>
<p>Once mounted, the snapshot behaves like a normal filesystem. Any modifications
to the mounted snapshot trigger COW independently of the original PFS.</p>
<h2 id="snapshot-deletion">Snapshot Deletion<a class="headerlink" href="#snapshot-deletion" title="Permanent link">¶</a></h2>
<h3 id="deleting-a-snapshot">Deleting a Snapshot<a class="headerlink" href="#deleting-a-snapshot" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># Delete a snapshot PFS</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>hammer2<span class="w"> </span>pfs-delete<span class="w"> </span>ROOT.20231215.143022
</code></pre></div>
<p>Deleting a snapshot removes the PFS inode from the super-root. However, the
actual space is not immediately reclaimed.</p>
<h3 id="space-reclamation">Space Reclamation<a class="headerlink" href="#space-reclamation" title="Permanent link">¶</a></h3>
<p>Space occupied by deleted snapshots is reclaimed through the <strong>bulkfree</strong> process:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># Run bulkfree to reclaim space</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>hammer2<span class="w"> </span>bulkfree<span class="w"> </span>/mountpoint
</code></pre></div>
<p>The bulkfree pass:</p>
<ol>
<li>Scans all PFS block trees to identify referenced blocks</li>
<li>Compares against the freemap to find unreferenced blocks</li>
<li>Marks unreferenced blocks as free</li>
</ol>
<p>Blocks shared between snapshots are only freed when <strong>no</strong> PFS references them.</p>
<pre class="mermaid"><code>graph TB
    subgraph "Before Deletion"
        S1[Source PFS] -.-&gt; BA[Block A]
        S1 -.-&gt; BB[Block B]
        SNAP1[Snapshot] -.-&gt; BA
        SNAP1 -.-&gt; BB
    end

    subgraph "After Snapshot Deletion"
        S2[Source PFS] -.-&gt; BA2[Block A]
        S2 -.-&gt; BB2[Block B]
        DEL[Snapshot Deleted]
    end

    subgraph "After Bulkfree"
        S3[Source PFS] -.-&gt; BA3[Block A]
        S3 -.-&gt; BB3[Block B]
        NOTE[Blocks retained<br/>still referenced by source]
    end
</code></pre>
<h2 id="pfs-subtypes">PFS Subtypes<a class="headerlink" href="#pfs-subtypes" title="Permanent link">¶</a></h2>
<p>HAMMER2 defines snapshot-related PFS subtypes:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="cm">/* hammer2_disk.h:1090-1092 */</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="cp">#define HAMMER2_PFSSUBTYPE_NONE      0</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="cp">#define HAMMER2_PFSSUBTYPE_SNAPSHOT  1  </span><span class="cm">/* manual/managed snapshot */</span>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="cp">#define HAMMER2_PFSSUBTYPE_AUTOSNAP  2  </span><span class="cm">/* automatic snapshot */</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Subtype</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NONE</code></td>
<td>0</td>
<td>Regular PFS (not a snapshot)</td>
</tr>
<tr>
<td><code>SNAPSHOT</code></td>
<td>1</td>
<td>Manually created snapshot</td>
</tr>
<tr>
<td><code>AUTOSNAP</code></td>
<td>2</td>
<td>Automatically created snapshot (reserved)</td>
</tr>
</tbody>
</table>
<p>The <code>AUTOSNAP</code> subtype is reserved for potential future automatic snapshot
functionality.</p>
<h2 id="synchronization-considerations">Synchronization Considerations<a class="headerlink" href="#synchronization-considerations" title="Permanent link">¶</a></h2>
<p>During cluster synchronization, the <code>pfs_lsnap_tid</code> field is propagated to
ensure snapshot consistency across cluster members:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="cm">/* hammer2_synchro.c:1005-1008 */</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ipdata</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="w"> </span><span class="o">&lt;</span>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ipdata</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">        </span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ipdata</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="w"> </span><span class="o">=</span>
<a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">            </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ipdata</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_lsnap_tid</span><span class="p">;</span>
<a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="p">}</span>
</code></pre></div>
<p>This ensures that all cluster members have consistent snapshot boundaries
for proper COW behavior.</p>
<h2 id="data-structures">Data Structures<a class="headerlink" href="#data-structures" title="Permanent link">¶</a></h2>
<h3 id="snapshot-related-fields-in-hammer2_inode_meta">Snapshot-Related Fields in <code>hammer2_inode_meta</code><a class="headerlink" href="#snapshot-related-fields-in-hammer2_inode_meta" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Offset</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pfs_type</code></td>
<td>0x80</td>
<td>PFS type (<code>HAMMER2_PFSTYPE_MASTER</code>)</td>
</tr>
<tr>
<td><code>pfs_subtype</code></td>
<td>0x81</td>
<td>PFS subtype (<code>HAMMER2_PFSSUBTYPE_SNAPSHOT</code>)</td>
</tr>
<tr>
<td><code>pfs_clid</code></td>
<td>0x88</td>
<td>Cluster ID (unique per snapshot)</td>
</tr>
<tr>
<td><code>pfs_fsid</code></td>
<td>0x98</td>
<td>Filesystem ID (unique per snapshot)</td>
</tr>
<tr>
<td><code>pfs_lsnap_tid</code></td>
<td>0xD0</td>
<td>Last snapshot transaction ID</td>
</tr>
</tbody>
</table>
<h3 id="ioctl-structure">Ioctl Structure<a class="headerlink" href="#ioctl-structure" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_ioc_pfs</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="n">hammer2_key_t</span><span class="w">   </span><span class="n">name_key</span><span class="p">;</span><span class="w">       </span><span class="cm">/* super-root scan key */</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="n">hammer2_key_t</span><span class="w">   </span><span class="n">name_next</span><span class="p">;</span><span class="w">      </span><span class="cm">/* next key for iteration */</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">pfs_type</span><span class="p">;</span><span class="w">       </span><span class="cm">/* PFS type */</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">pfs_subtype</span><span class="p">;</span><span class="w">    </span><span class="cm">/* PFS subtype */</span>
<a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">reserved</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<a href="#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="n">uuid_t</span><span class="w">          </span><span class="n">pfs_fsid</span><span class="p">;</span><span class="w">       </span><span class="cm">/* unique filesystem ID */</span>
<a href="#__codelineno-18-8" id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="n">uuid_t</span><span class="w">          </span><span class="n">pfs_clid</span><span class="p">;</span><span class="w">       </span><span class="cm">/* cluster ID */</span>
<a href="#__codelineno-18-9" id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="kt">char</span><span class="w">            </span><span class="n">name</span><span class="p">[</span><span class="n">NAME_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<a href="#__codelineno-18-10" id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">        </span><span class="n">pfs_flags</span><span class="p">;</span><span class="w">      </span><span class="cm">/* HAMMER2_PFSFLAGS_* */</span>
<a href="#__codelineno-18-11" id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="p">}</span><span class="w"> </span><span class="n">hammer2_ioc_pfs_t</span><span class="p">;</span>
</code></pre></div>
<h2 id="implementation-notes">Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permanent link">¶</a></h2>
<h3 id="bulkfree-lock">Bulkfree Lock<a class="headerlink" href="#bulkfree-lock" title="Permanent link">¶</a></h3>
<p>Snapshot creation acquires the <code>bulklk</code> exclusively to prevent conflicts
with concurrent bulkfree operations:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="cm">/* hammer2_ioctl.c:831 */</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="n">lockmgr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmp</span><span class="o">-&gt;</span><span class="n">bulklk</span><span class="p">,</span><span class="w"> </span><span class="n">LK_EXCLUSIVE</span><span class="p">);</span>
</code></pre></div>
<p>This serialization ensures that:</p>
<ol>
<li>Bulkfree doesn't free blocks being snapshotted</li>
<li>Snapshot creation sees a consistent freemap state</li>
</ol>
<h3 id="inode-number-space">Inode Number Space<a class="headerlink" href="#inode-number-space" title="Permanent link">¶</a></h3>
<p>Each snapshot receives its own inode number starting point to avoid
collisions:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="cm">/* hammer2_ioctl.c:890-891 */</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="n">starting_inum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="o">-&gt;</span><span class="n">inode_tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="n">nip</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">pfs_inum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">starting_inum</span><span class="p">;</span>
</code></pre></div>
<p>This allows snapshots to allocate new inodes independently.</p>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../">HAMMER2 Overview</a> — General HAMMER2 architecture</li>
<li><a href="../chain-layer/">Chain Layer</a> — Copy-on-write chain operations</li>
<li><a href="../freemap/">Freemap</a> — Block allocation and bulkfree</li>
<li><a href="../flush-sync/">Flush and Sync</a> — Transaction and flush operations</li>
<li><a href="../on-disk-format/">On-Disk Format</a> — PFS inode structure</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>