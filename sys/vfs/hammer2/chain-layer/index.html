
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../on-disk-format/" rel="prev"/>
<link href="../inode-layer/" rel="next"/>
<link href="../../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Chain Layer - DragonFly BSD Kernel Documentation</title>
<link href="../../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#hammer2-chain-layer">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Chain Layer
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kern/utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_4_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_4_2">
<span class="md-nav__icon md-icon"></span>
            
  
    HAMMER2
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../on-disk-format/">
<span class="md-ellipsis">
    
  
    On-Disk Format
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Chain Layer
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Chain Layer
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-structure">
<span class="md-ellipsis">
      
        Chain Structure
      
    </span>
</a>
<nav aria-label="Chain Structure" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_t">
<span class="md-ellipsis">
      
        hammer2_chain_t
      
    </span>
</a>
<nav aria-label="hammer2_chain_t" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#field-descriptions">
<span class="md-ellipsis">
      
        Field Descriptions
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_core_t">
<span class="md-ellipsis">
      
        hammer2_chain_core_t
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-flags">
<span class="md-ellipsis">
      
        Chain Flags
      
    </span>
</a>
<nav aria-label="Chain Flags" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-state-flags">
<span class="md-ellipsis">
      
        Core State Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-and-topology-flags">
<span class="md-ellipsis">
      
        Flush and Topology Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-mask">
<span class="md-ellipsis">
      
        Flush Mask
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-codes">
<span class="md-ellipsis">
      
        Error Codes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reference-counting">
<span class="md-ellipsis">
      
        Reference Counting
      
    </span>
</a>
<nav aria-label="Reference Counting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_ref">
<span class="md-ellipsis">
      
        hammer2_chain_ref()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_drop">
<span class="md-ellipsis">
      
        hammer2_chain_drop()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#holdunhold-operations">
<span class="md-ellipsis">
      
        Hold/Unhold Operations
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#locking-model">
<span class="md-ellipsis">
      
        Locking Model
      
    </span>
</a>
<nav aria-label="Locking Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-resolution-modes">
<span class="md-ellipsis">
      
        Data Resolution Modes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lock-flags">
<span class="md-ellipsis">
      
        Lock Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_lock">
<span class="md-ellipsis">
      
        hammer2_chain_lock()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_unlock">
<span class="md-ellipsis">
      
        hammer2_chain_unlock()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-lifecycle">
<span class="md-ellipsis">
      
        Chain Lifecycle
      
    </span>
</a>
<nav aria-label="Chain Lifecycle" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#allocation">
<span class="md-ellipsis">
      
        Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initialization">
<span class="md-ellipsis">
      
        Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#insertion">
<span class="md-ellipsis">
      
        Insertion
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deallocation">
<span class="md-ellipsis">
      
        Deallocation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tree-traversal">
<span class="md-ellipsis">
      
        Tree Traversal
      
    </span>
</a>
<nav aria-label="Tree Traversal" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup-initialization">
<span class="md-ellipsis">
      
        Lookup Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_lookup">
<span class="md-ellipsis">
      
        hammer2_chain_lookup()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup-flags">
<span class="md-ellipsis">
      
        Lookup Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_next">
<span class="md-ellipsis">
      
        hammer2_chain_next()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_scan">
<span class="md-ellipsis">
      
        hammer2_chain_scan()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#modification-operations">
<span class="md-ellipsis">
      
        Modification Operations
      
    </span>
</a>
<nav aria-label="Modification Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_modify">
<span class="md-ellipsis">
      
        hammer2_chain_modify()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_resize">
<span class="md-ellipsis">
      
        hammer2_chain_resize()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-creation-and-deletion">
<span class="md-ellipsis">
      
        Chain Creation and Deletion
      
    </span>
</a>
<nav aria-label="Chain Creation and Deletion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_create">
<span class="md-ellipsis">
      
        hammer2_chain_create()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_delete">
<span class="md-ellipsis">
      
        hammer2_chain_delete()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_rename">
<span class="md-ellipsis">
      
        hammer2_chain_rename()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-integration">
<span class="md-ellipsis">
      
        Flush Integration
      
    </span>
</a>
<nav aria-label="Flush Integration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_setflush">
<span class="md-ellipsis">
      
        hammer2_chain_setflush()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-related-flags">
<span class="md-ellipsis">
      
        Flush-Related Flags
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#parent-access">
<span class="md-ellipsis">
      
        Parent Access
      
    </span>
</a>
<nav aria-label="Parent Access" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_getparent">
<span class="md-ellipsis">
      
        hammer2_chain_getparent()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_repparent">
<span class="md-ellipsis">
      
        hammer2_chain_repparent()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rb-tree-organization">
<span class="md-ellipsis">
      
        RB-Tree Organization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#combined-find">
<span class="md-ellipsis">
      
        Combined Find
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../inode-layer/">
<span class="md-ellipsis">
    
  
    Inode Layer
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../io-subsystem/">
<span class="md-ellipsis">
    
  
    I/O Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../flush-sync/">
<span class="md-ellipsis">
    
  
    Flush &amp; Sync
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../freemap/">
<span class="md-ellipsis">
    
  
    Freemap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../xop-system/">
<span class="md-ellipsis">
    
  
    XOP System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs-integration/">
<span class="md-ellipsis">
    
  
    VFS Integration
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../compression/">
<span class="md-ellipsis">
    
  
    Compression
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../snapshots/">
<span class="md-ellipsis">
    
  
    Snapshots
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clustering/">
<span class="md-ellipsis">
    
  
    Clustering
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    net/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    net/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/interfaces/">
<span class="md-ellipsis">
    
  
    Network Interfaces
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../net/netisr/">
<span class="md-ellipsis">
    
  
    Network ISR
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-structure">
<span class="md-ellipsis">
      
        Chain Structure
      
    </span>
</a>
<nav aria-label="Chain Structure" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_t">
<span class="md-ellipsis">
      
        hammer2_chain_t
      
    </span>
</a>
<nav aria-label="hammer2_chain_t" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#field-descriptions">
<span class="md-ellipsis">
      
        Field Descriptions
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_core_t">
<span class="md-ellipsis">
      
        hammer2_chain_core_t
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-flags">
<span class="md-ellipsis">
      
        Chain Flags
      
    </span>
</a>
<nav aria-label="Chain Flags" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-state-flags">
<span class="md-ellipsis">
      
        Core State Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-and-topology-flags">
<span class="md-ellipsis">
      
        Flush and Topology Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-mask">
<span class="md-ellipsis">
      
        Flush Mask
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-codes">
<span class="md-ellipsis">
      
        Error Codes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reference-counting">
<span class="md-ellipsis">
      
        Reference Counting
      
    </span>
</a>
<nav aria-label="Reference Counting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_ref">
<span class="md-ellipsis">
      
        hammer2_chain_ref()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_drop">
<span class="md-ellipsis">
      
        hammer2_chain_drop()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#holdunhold-operations">
<span class="md-ellipsis">
      
        Hold/Unhold Operations
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#locking-model">
<span class="md-ellipsis">
      
        Locking Model
      
    </span>
</a>
<nav aria-label="Locking Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-resolution-modes">
<span class="md-ellipsis">
      
        Data Resolution Modes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lock-flags">
<span class="md-ellipsis">
      
        Lock Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_lock">
<span class="md-ellipsis">
      
        hammer2_chain_lock()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_unlock">
<span class="md-ellipsis">
      
        hammer2_chain_unlock()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-lifecycle">
<span class="md-ellipsis">
      
        Chain Lifecycle
      
    </span>
</a>
<nav aria-label="Chain Lifecycle" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#allocation">
<span class="md-ellipsis">
      
        Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initialization">
<span class="md-ellipsis">
      
        Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#insertion">
<span class="md-ellipsis">
      
        Insertion
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deallocation">
<span class="md-ellipsis">
      
        Deallocation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tree-traversal">
<span class="md-ellipsis">
      
        Tree Traversal
      
    </span>
</a>
<nav aria-label="Tree Traversal" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup-initialization">
<span class="md-ellipsis">
      
        Lookup Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_lookup">
<span class="md-ellipsis">
      
        hammer2_chain_lookup()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup-flags">
<span class="md-ellipsis">
      
        Lookup Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_next">
<span class="md-ellipsis">
      
        hammer2_chain_next()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_scan">
<span class="md-ellipsis">
      
        hammer2_chain_scan()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#modification-operations">
<span class="md-ellipsis">
      
        Modification Operations
      
    </span>
</a>
<nav aria-label="Modification Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_modify">
<span class="md-ellipsis">
      
        hammer2_chain_modify()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_resize">
<span class="md-ellipsis">
      
        hammer2_chain_resize()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chain-creation-and-deletion">
<span class="md-ellipsis">
      
        Chain Creation and Deletion
      
    </span>
</a>
<nav aria-label="Chain Creation and Deletion" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_create">
<span class="md-ellipsis">
      
        hammer2_chain_create()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_delete">
<span class="md-ellipsis">
      
        hammer2_chain_delete()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_rename">
<span class="md-ellipsis">
      
        hammer2_chain_rename()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-integration">
<span class="md-ellipsis">
      
        Flush Integration
      
    </span>
</a>
<nav aria-label="Flush Integration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_setflush">
<span class="md-ellipsis">
      
        hammer2_chain_setflush()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#flush-related-flags">
<span class="md-ellipsis">
      
        Flush-Related Flags
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#parent-access">
<span class="md-ellipsis">
      
        Parent Access
      
    </span>
</a>
<nav aria-label="Parent Access" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_getparent">
<span class="md-ellipsis">
      
        hammer2_chain_getparent()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hammer2_chain_repparent">
<span class="md-ellipsis">
      
        hammer2_chain_repparent()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rb-tree-organization">
<span class="md-ellipsis">
      
        RB-Tree Organization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#combined-find">
<span class="md-ellipsis">
      
        Combined Find
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="hammer2-chain-layer">HAMMER2 Chain Layer<a class="headerlink" href="#hammer2-chain-layer" title="Permanent link"></a></h1>
<div class="admonition note">
<p class="admonition-title">Documentation Status</p>
<p>This page documents the chain layer based on <code>hammer2_chain.c</code> and <code>hammer2.h</code>.</p>
</div>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link"></a></h2>
<p>The chain layer is HAMMER2's central abstraction for managing block references in memory. Every on-disk blockref is represented in memory as a <strong>chain structure</strong> (<code>hammer2_chain_t</code>). Chains form a cached, in-memory representation of the filesystem's block topology and serve as the primary interface between the VFS layer and the underlying storage.</p>
<p>Key responsibilities of the chain layer:</p>
<ul>
<li><strong>Topology management</strong>: Chains organize blockrefs into a tree structure using red-black trees</li>
<li><strong>Reference counting</strong>: Chains track references to prevent premature deallocation</li>
<li><strong>Locking</strong>: Chains provide mutex-based locking for concurrent access control</li>
<li><strong>Data resolution</strong>: Chains manage loading and caching of block data from disk</li>
<li><strong>Copy-on-write</strong>: Chains implement COW semantics for modifications</li>
<li><strong>Flush integration</strong>: Chains track modification state for the flush subsystem</li>
</ul>
<p>Source files:</p>
<ul>
<li><code>sys/vfs/hammer2/hammer2.h</code>  Structure definitions and constants</li>
<li><code>sys/vfs/hammer2/hammer2_chain.c</code>  Chain operations implementation</li>
</ul>
<h2 id="chain-structure">Chain Structure<a class="headerlink" href="#chain-structure" title="Permanent link"></a></h2>
<h3 id="hammer2_chain_t">hammer2_chain_t<a class="headerlink" href="#hammer2_chain_t" title="Permanent link"></a></h3>
<p>The <code>hammer2_chain_t</code> structure is the primary in-memory representation of any media object (volume header, inode, indirect block, data block, freemap node, etc.).</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_chain</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="n">hammer2_mtx_t</span><span class="w">           </span><span class="n">lock</span><span class="p">;</span><span class="w">           </span><span class="cm">/* exclusive/shared mutex */</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="n">hammer2_chain_core_t</span><span class="w">    </span><span class="n">core</span><span class="p">;</span><span class="w">           </span><span class="cm">/* embedded core (rbtree, etc.) */</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">RB_ENTRY</span><span class="p">(</span><span class="n">hammer2_chain</span><span class="p">)</span><span class="w"> </span><span class="n">rbnode</span><span class="p">;</span><span class="w">         </span><span class="cm">/* linkage in parent's rbtree */</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">hammer2_blockref_t</span><span class="w">      </span><span class="n">bref</span><span class="p">;</span><span class="w">           </span><span class="cm">/* block reference (128 bytes) */</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_chain</span><span class="w">    </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">        </span><span class="cm">/* parent chain */</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_dev</span><span class="w">      </span><span class="o">*</span><span class="n">hmp</span><span class="p">;</span><span class="w">           </span><span class="cm">/* device mount point */</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_pfs</span><span class="w">      </span><span class="o">*</span><span class="n">pmp</span><span class="p">;</span><span class="w">           </span><span class="cm">/* PFS mount or super-root */</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock</span><span class="w">             </span><span class="n">diolk</span><span class="p">;</span><span class="w">          </span><span class="cm">/* xop focus interlock */</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">hammer2_io_t</span><span class="w">            </span><span class="o">*</span><span class="n">dio</span><span class="p">;</span><span class="w">           </span><span class="cm">/* physical data buffer */</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="n">hammer2_media_data_t</span><span class="w">    </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w">          </span><span class="cm">/* data pointer shortcut */</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="n">u_int</span><span class="w">                   </span><span class="n">bytes</span><span class="p">;</span><span class="w">          </span><span class="cm">/* physical data size */</span>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="n">u_int</span><span class="w">                   </span><span class="n">flags</span><span class="p">;</span><span class="w">          </span><span class="cm">/* chain state flags */</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="n">u_int</span><span class="w">                   </span><span class="n">refs</span><span class="p">;</span><span class="w">           </span><span class="cm">/* reference count */</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="n">u_int</span><span class="w">                   </span><span class="n">lockcnt</span><span class="p">;</span><span class="w">        </span><span class="cm">/* lock nesting count */</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="kt">int</span><span class="w">                     </span><span class="n">error</span><span class="p">;</span><span class="w">          </span><span class="cm">/* on-lock data error state */</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="kt">int</span><span class="w">                     </span><span class="n">cache_index</span><span class="p">;</span><span class="w">    </span><span class="cm">/* heuristic for faster lookup */</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">};</span>
</code></pre></div>
<p><em>Source: <code>hammer2.h:324-342</code></em></p>
<h4 id="field-descriptions">Field Descriptions<a class="headerlink" href="#field-descriptions" title="Permanent link"></a></h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lock</code></td>
<td>Mutex for exclusive or shared locking of the chain</td>
</tr>
<tr>
<td><code>core</code></td>
<td>Embedded structure containing the RB-tree of child chains</td>
</tr>
<tr>
<td><code>rbnode</code></td>
<td>Red-black tree linkage for insertion into parent's child tree</td>
</tr>
<tr>
<td><code>bref</code></td>
<td>The 128-byte block reference copied from or destined for media</td>
</tr>
<tr>
<td><code>parent</code></td>
<td>Pointer to the parent chain (NULL for root chains)</td>
</tr>
<tr>
<td><code>hmp</code></td>
<td>Pointer to the device mount structure</td>
</tr>
<tr>
<td><code>pmp</code></td>
<td>Pointer to the PFS mount (NULL for super-root chains)</td>
</tr>
<tr>
<td><code>diolk</code></td>
<td>Lock for XOP (cross-cluster operation) focus interlock</td>
</tr>
<tr>
<td><code>dio</code></td>
<td>Device I/O structure wrapping the buffer cache</td>
</tr>
<tr>
<td><code>data</code></td>
<td>Direct pointer to the chain's data (shortcut through dio)</td>
</tr>
<tr>
<td><code>bytes</code></td>
<td>Size of the data in bytes (derived from bref radix)</td>
</tr>
<tr>
<td><code>flags</code></td>
<td>State flags (MODIFIED, DELETED, ONFLUSH, etc.)</td>
</tr>
<tr>
<td><code>refs</code></td>
<td>Reference count preventing deallocation</td>
</tr>
<tr>
<td><code>lockcnt</code></td>
<td>Count of active locks (supports lock nesting)</td>
</tr>
<tr>
<td><code>error</code></td>
<td>Error code set during lock/data resolution</td>
</tr>
<tr>
<td><code>cache_index</code></td>
<td>Heuristic index to speed up repeated lookups</td>
</tr>
</tbody>
</table>
<p>The following diagram illustrates the key relationships within a chain structure:</p>
<pre class="mermaid"><code>flowchart TB
    subgraph chain["hammer2_chain_t"]
        lock["lock (mutex)"]
        core["core (chain_core_t)"]
        rbnode["rbnode (RB linkage)"]
        bref["bref (128-byte blockref)"]
        parent_ptr["parent pointer"]
        hmp["hmp (device mount)"]
        pmp["pmp (PFS mount)"]
        dio["dio (I/O buffer)"]
        data["data pointer"]
        flags["flags, refs, lockcnt"]
    end

    parent_chain["Parent Chain"]
    parent_rbtree["Parent's RB-Tree"]
    disk_block["Disk Block"]
    buffer_cache["Buffer Cache"]

    parent_ptr --&gt; parent_chain
    rbnode --&gt; parent_rbtree
    parent_rbtree -.-&gt;|"contained in"| parent_chain
    dio --&gt; buffer_cache
    buffer_cache --&gt; disk_block
    data -.-&gt;|"points into"| dio
    bref -.-&gt;|"describes"| disk_block
</code></pre>
<h3 id="hammer2_chain_core_t">hammer2_chain_core_t<a class="headerlink" href="#hammer2_chain_core_t" title="Permanent link"></a></h3>
<p>The <code>hammer2_chain_core_t</code> structure is embedded within each chain and manages the chain's children:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_chain_core</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="n">hammer2_spin_t</span><span class="w">          </span><span class="n">spin</span><span class="p">;</span><span class="w">           </span><span class="cm">/* spinlock for rbtree access */</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_reptrack</span><span class="w"> </span><span class="o">*</span><span class="n">reptrack</span><span class="p">;</span><span class="w">      </span><span class="cm">/* parent replacement tracking */</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hammer2_chain_tree</span><span class="w"> </span><span class="n">rbtree</span><span class="p">;</span><span class="w">       </span><span class="cm">/* RB-tree of child chains */</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">                     </span><span class="n">live_zero</span><span class="p">;</span><span class="w">      </span><span class="cm">/* blockref array optimization */</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">u_int</span><span class="w">                   </span><span class="n">live_count</span><span class="p">;</span><span class="w">     </span><span class="cm">/* count of live (non-deleted) children */</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">u_int</span><span class="w">                   </span><span class="n">chain_count</span><span class="p">;</span><span class="w">    </span><span class="cm">/* total children (live + deleted) */</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="kt">int</span><span class="w">                     </span><span class="n">generation</span><span class="p">;</span><span class="w">     </span><span class="cm">/* generation number for iteration */</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="p">};</span>
</code></pre></div>
<p><em>Source: <code>hammer2.h:238-246</code></em></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>spin</code></td>
<td>Spinlock protecting access to the RB-tree</td>
</tr>
<tr>
<td><code>reptrack</code></td>
<td>Linked list for tracking parent replacement during deletion</td>
</tr>
<tr>
<td><code>rbtree</code></td>
<td>Red-black tree containing all in-memory child chains</td>
</tr>
<tr>
<td><code>live_zero</code></td>
<td>Optimization: index beyond which all blockrefs are empty</td>
</tr>
<tr>
<td><code>live_count</code></td>
<td>Number of non-deleted chains in the tree</td>
</tr>
<tr>
<td><code>chain_count</code></td>
<td>Total number of chains (including deleted) in the tree</td>
</tr>
<tr>
<td><code>generation</code></td>
<td>Incremented on insertions; used to detect iteration races</td>
</tr>
</tbody>
</table>
<p>The chain tree mirrors the on-disk blockref topology. Each chain's embedded <code>core</code> contains an RB-tree of its children:</p>
<pre class="mermaid"><code>flowchart TB
    subgraph root["Root Chain (Inode)"]
        root_core["core.rbtree"]
    end

    subgraph children["Child Chains in RB-Tree"]
        indirect["Indirect Chain<br/>key=0x0000"]
        data1["Data Chain<br/>key=0x1000"]
        data2["Data Chain<br/>key=0x2000"]
    end

    subgraph indirect_children["Indirect's Children"]
        sub1["Data Chain<br/>key=0x0000"]
        sub2["Data Chain<br/>key=0x0400"]
        sub3["Data Chain<br/>key=0x0800"]
    end

    root_core --&gt; indirect
    root_core --&gt; data1
    root_core --&gt; data2
    indirect --&gt; sub1
    indirect --&gt; sub2
    indirect --&gt; sub3

    note["Each chain's rbnode links<br/>it into parent's rbtree.<br/>Keys determine tree ordering."]
</code></pre>
<p><strong>Key properties:</strong></p>
<ul>
<li>Chains are keyed by <code>bref.key</code> and <code>bref.keybits</code> (key range)</li>
<li>Non-overlapping key ranges ensure unique RB-tree positions  </li>
<li><code>live_count</code> tracks non-deleted children; <code>chain_count</code> includes deleted</li>
<li><code>generation</code> changes on insertion, allowing iteration race detection</li>
</ul>
<h2 id="chain-flags">Chain Flags<a class="headerlink" href="#chain-flags" title="Permanent link"></a></h2>
<p>Chain flags indicate the current state of a chain. Multiple flags can be set simultaneously.</p>
<h3 id="core-state-flags">Core State Flags<a class="headerlink" href="#core-state-flags" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_CHAIN_MODIFIED</code></td>
<td>0x00000001</td>
<td>Chain data has been modified; requires flush</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_ALLOCATED</code></td>
<td>0x00000002</td>
<td>Chain was kmalloc'd (vs. static)</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_DESTROY</code></td>
<td>0x00000004</td>
<td>Chain should be destroyed when possible</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_DEDUPABLE</code></td>
<td>0x00000008</td>
<td>Chain is registered for deduplication</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_DELETED</code></td>
<td>0x00000010</td>
<td>Chain has been deleted</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_INITIAL</code></td>
<td>0x00000020</td>
<td>Chain is newly created, data is all-zeros</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_UPDATE</code></td>
<td>0x00000040</td>
<td>Parent's blockref needs update</td>
</tr>
</tbody>
</table>
<p><em>Source: <code>hammer2.h:375-381</code></em></p>
<h3 id="flush-and-topology-flags">Flush and Topology Flags<a class="headerlink" href="#flush-and-topology-flags" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_CHAIN_NOTTESTED</code></td>
<td>0x00000080</td>
<td>CRC has not been generated yet</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_TESTEDGOOD</code></td>
<td>0x00000100</td>
<td>CRC has been tested and is good</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_ONFLUSH</code></td>
<td>0x00000200</td>
<td>Chain is on the flush list</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_VOLUMESYNC</code></td>
<td>0x00000800</td>
<td>Needs volume header sync</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_COUNTEDBREFS</code></td>
<td>0x00002000</td>
<td>Block table stats have been counted</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_ONRBTREE</code></td>
<td>0x00004000</td>
<td>Chain is in parent's RB-tree</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_RELEASE</code></td>
<td>0x00020000</td>
<td>Don't keep chain cached after unlock</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_BLKMAPPED</code></td>
<td>0x00040000</td>
<td>Chain is present in parent's blockmap</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_BLKMAPUPD</code></td>
<td>0x00080000</td>
<td>Blockmap entry needs updating</td>
</tr>
<tr>
<td><code>HAMMER2_CHAIN_PFSBOUNDARY</code></td>
<td>0x00400000</td>
<td>Chain is a PFS root boundary</td>
</tr>
</tbody>
</table>
<p><em>Source: <code>hammer2.h:382-399</code></em></p>
<h3 id="flush-mask">Flush Mask<a class="headerlink" href="#flush-mask" title="Permanent link"></a></h3>
<p>The flush mask combines flags that indicate a chain needs attention from the flush subsystem:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cp">#define HAMMER2_CHAIN_FLUSH_MASK    (HAMMER2_CHAIN_MODIFIED |</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">                                     </span><span class="n">HAMMER2_CHAIN_UPDATE</span><span class="w"> </span><span class="o">|</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">                                     </span><span class="n">HAMMER2_CHAIN_ONFLUSH</span><span class="w"> </span><span class="o">|</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">                                     </span><span class="n">HAMMER2_CHAIN_DESTROY</span><span class="p">)</span>
</code></pre></div>
<p><em>Source: <code>hammer2.h:401-404</code></em></p>
<h2 id="error-codes">Error Codes<a class="headerlink" href="#error-codes" title="Permanent link"></a></h2>
<p>HAMMER2 uses its own error code system that can be ORed together:</p>
<table>
<thead>
<tr>
<th>Error Code</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_ERROR_NONE</code></td>
<td>0x00000000</td>
<td>No error</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_EIO</code></td>
<td>0x00000001</td>
<td>Device I/O error</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_CHECK</code></td>
<td>0x00000002</td>
<td>Checksum verification failed</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_INCOMPLETE</code></td>
<td>0x00000004</td>
<td>Cluster incomplete or parent error</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_DEPTH</code></td>
<td>0x00000008</td>
<td>Temporary recursion depth limit</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_BADBREF</code></td>
<td>0x00000010</td>
<td>Illegal block reference</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_ENOSPC</code></td>
<td>0x00000020</td>
<td>No space for allocation</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_ENOENT</code></td>
<td>0x00000040</td>
<td>Entry not found</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_ENOTEMPTY</code></td>
<td>0x00000080</td>
<td>Directory not empty</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_EAGAIN</code></td>
<td>0x00000100</td>
<td>Retry operation</td>
</tr>
<tr>
<td><code>HAMMER2_ERROR_EOF</code></td>
<td>0x00002000</td>
<td>End of scan</td>
</tr>
</tbody>
</table>
<p><em>Source: <code>hammer2.h:426-445</code></em></p>
<h2 id="reference-counting">Reference Counting<a class="headerlink" href="#reference-counting" title="Permanent link"></a></h2>
<p>Chains use reference counting to manage their lifetime. A chain cannot be freed while it has outstanding references.</p>
<h3 id="hammer2_chain_ref">hammer2_chain_ref()<a class="headerlink" href="#hammer2_chain_ref" title="Permanent link"></a></h3>
<p>Adds a reference to a chain:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_ref</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>Atomically increments <code>chain-&gt;refs</code></li>
<li>Can be called with spinlocks held</li>
<li>Chain must already have at least one reference</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:257-263</code></em></p>
<h3 id="hammer2_chain_drop">hammer2_chain_drop()<a class="headerlink" href="#hammer2_chain_drop" title="Permanent link"></a></h3>
<p>Releases a reference:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_drop</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>Atomically decrements <code>chain-&gt;refs</code></li>
<li>On 10 transition, attempts to disassociate and free the chain</li>
<li>Recursively drops the parent if the chain was the last child</li>
<li>The chain cannot be freed if:<ul>
<li>It has children in its RB-tree</li>
<li>It is flagged MODIFIED or UPDATE</li>
<li>It is still connected to a parent</li>
</ul>
</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:345-368</code></em></p>
<h3 id="holdunhold-operations">Hold/Unhold Operations<a class="headerlink" href="#holdunhold-operations" title="Permanent link"></a></h3>
<p>For holding chain data across unlock operations:</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hammer2_chain_ref_hold()</code></td>
<td>Ref and increment lockcnt to hold data</td>
</tr>
<tr>
<td><code>hammer2_chain_unhold()</code></td>
<td>Decrement lockcnt, may need to reacquire lock</td>
</tr>
<tr>
<td><code>hammer2_chain_drop_unhold()</code></td>
<td>Combined unhold and drop</td>
</tr>
<tr>
<td><code>hammer2_chain_rehold()</code></td>
<td>Lock shared, increment lockcnt, unlock</td>
</tr>
</tbody>
</table>
<p><em>Source: <code>hammer2_chain.c:272-426</code></em></p>
<h2 id="locking-model">Locking Model<a class="headerlink" href="#locking-model" title="Permanent link"></a></h2>
<p>Chains support both exclusive and shared locking through the <code>hammer2_chain_lock()</code> and <code>hammer2_chain_unlock()</code> functions.</p>
<h3 id="data-resolution-modes">Data Resolution Modes<a class="headerlink" href="#data-resolution-modes" title="Permanent link"></a></h3>
<p>When locking a chain, you specify how data should be resolved:</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_RESOLVE_NEVER</code></td>
<td>1</td>
<td>Do not resolve data (avoid buffer aliasing)</td>
</tr>
<tr>
<td><code>HAMMER2_RESOLVE_MAYBE</code></td>
<td>2</td>
<td>Resolve metadata but not bulk data</td>
</tr>
<tr>
<td><code>HAMMER2_RESOLVE_ALWAYS</code></td>
<td>3</td>
<td>Always resolve and load data</td>
</tr>
</tbody>
</table>
<p><em>Source: <code>hammer2.h:497-500</code></em></p>
<h3 id="lock-flags">Lock Flags<a class="headerlink" href="#lock-flags" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_RESOLVE_SHARED</code></td>
<td>0x10</td>
<td>Request shared (read) lock</td>
</tr>
<tr>
<td><code>HAMMER2_RESOLVE_LOCKAGAIN</code></td>
<td>0x20</td>
<td>Another shared lock (nesting)</td>
</tr>
<tr>
<td><code>HAMMER2_RESOLVE_NONBLOCK</code></td>
<td>0x80</td>
<td>Non-blocking lock attempt</td>
</tr>
</tbody>
</table>
<p><em>Source: <code>hammer2.h:502-505</code></em></p>
<h3 id="hammer2_chain_lock">hammer2_chain_lock()<a class="headerlink" href="#hammer2_chain_lock" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_chain_lock</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">how</span><span class="p">);</span>
</code></pre></div>
<p>Locks a referenced chain and optionally resolves its data:</p>
<ul>
<li><strong>RESOLVE_NEVER</strong>: Does not load data; <code>chain-&gt;data</code> remains NULL</li>
<li><strong>RESOLVE_MAYBE</strong>: Loads metadata (inodes, indirect blocks) but not DATA blocks</li>
<li><strong>RESOLVE_ALWAYS</strong>: Always loads data from disk if not already present</li>
<li>Sets <code>chain-&gt;error</code> on I/O or checksum failure</li>
<li>Returns 0 on success, EAGAIN if NONBLOCK specified and lock unavailable</li>
<li>Lock can recurse; <code>lockcnt</code> tracks nesting depth</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:787-859</code></em></p>
<h3 id="hammer2_chain_unlock">hammer2_chain_unlock()<a class="headerlink" href="#hammer2_chain_unlock" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_unlock</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">);</span>
</code></pre></div>
<p>Unlocks a chain:</p>
<ul>
<li>Decrements <code>lockcnt</code></li>
<li>On last unlock (lockcnt 10), may drop data reference</li>
<li>Data is dropped unless chain has MODIFIED flag set</li>
<li>Releases the underlying mutex</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:860-920</code></em></p>
<h2 id="chain-lifecycle">Chain Lifecycle<a class="headerlink" href="#chain-lifecycle" title="Permanent link"></a></h2>
<p>A chain progresses through several states during its lifetime:</p>
<pre class="mermaid"><code>flowchart TB
    subgraph alloc["Allocation Phase"]
        A[hammer2_chain_alloc] --&gt; B["Disconnected Chain<br/>refs=1, ALLOCATED"]
    end

    subgraph attach["Attachment Phase"]
        B --&gt; C[hammer2_chain_insert]
        C --&gt; D["In Parent's RB-Tree<br/>ONRBTREE set"]
    end

    subgraph use["Active Use"]
        D --&gt; E[hammer2_chain_lock]
        E --&gt; F["Locked Chain<br/>data resolved"]
        F --&gt; G{Modification?}
        G --&gt;|Yes| H[hammer2_chain_modify]
        H --&gt; I["MODIFIED set<br/>COW if needed"]
        I --&gt; J[hammer2_chain_unlock]
        G --&gt;|No| J
        J --&gt; K["Unlocked<br/>refs maintained"]
    end

    subgraph flush["Flush Phase"]
        K --&gt; L{Flush triggered?}
        L --&gt;|Yes| M[hammer2_chain_flush]
        M --&gt; N["Written to disk<br/>MODIFIED cleared"]
        N --&gt; O["Parent blockref updated"]
    end

    subgraph delete["Deletion Phase"]
        K --&gt; P[hammer2_chain_delete]
        P --&gt; Q["DELETED set<br/>Removed from RB-tree"]
    end

    subgraph free["Deallocation"]
        Q --&gt; R[hammer2_chain_drop]
        O --&gt; R
        R --&gt; S{refs == 0?}
        S --&gt;|Yes| T["Chain freed"]
        S --&gt;|No| K
    end
</code></pre>
<h3 id="allocation">Allocation<a class="headerlink" href="#allocation" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_chain_alloc</span><span class="p">(</span><span class="n">hammer2_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">hmp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_pfs_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmp</span><span class="p">,</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">                                      </span><span class="n">hammer2_blockref_t</span><span class="w"> </span><span class="o">*</span><span class="n">bref</span><span class="p">);</span>
</code></pre></div>
<p>Allocates a new disconnected chain:</p>
<ol>
<li>Calculates <code>bytes</code> from the blockref's radix field</li>
<li>Allocates memory with <code>kmalloc_obj()</code></li>
<li>Initializes the chain structure:<ul>
<li>Copies the blockref to <code>chain-&gt;bref</code></li>
<li>Sets <code>refs = 1</code></li>
<li>Sets <code>flags = HAMMER2_CHAIN_ALLOCATED</code></li>
<li>Initializes mutex, spinlock, and RB-tree</li>
</ul>
</li>
<li>Returns a referenced but <strong>unlocked</strong> chain</li>
</ol>
<p><em>Source: <code>hammer2_chain.c:177-237</code></em></p>
<h3 id="initialization">Initialization<a class="headerlink" href="#initialization" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_init</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">);</span>
</code></pre></div>
<p>Initializes chain synchronization primitives:</p>
<ul>
<li>Initializes the RB-tree (<code>RB_INIT</code>)</li>
<li>Initializes the chain mutex</li>
<li>Initializes the core spinlock</li>
<li>Initializes the DIO interlock</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:242-249</code></em></p>
<h3 id="insertion">Insertion<a class="headerlink" href="#insertion" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_chain_insert</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">                                 </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">generation</span><span class="p">);</span>
</code></pre></div>
<p>Inserts a chain into a parent's RB-tree:</p>
<ul>
<li>Acquires parent's spinlock if <code>HAMMER2_CHAIN_INSERT_SPIN</code> is set</li>
<li>Checks for race conditions if <code>HAMMER2_CHAIN_INSERT_RACE</code> is set</li>
<li>Inserts into parent's <code>core.rbtree</code></li>
<li>Sets <code>HAMMER2_CHAIN_ONRBTREE</code> flag</li>
<li>Updates <code>chain_count</code> and <code>generation</code></li>
<li>Increments <code>live_count</code> if <code>HAMMER2_CHAIN_INSERT_LIVE</code> is set</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:290-332</code></em></p>
<h3 id="deallocation">Deallocation<a class="headerlink" href="#deallocation" title="Permanent link"></a></h3>
<p>When <code>refs</code> drops to 0, <code>hammer2_chain_lastdrop()</code> handles cleanup:</p>
<ol>
<li>Acquires chain's spinlock</li>
<li>Checks if chain can be freed:<ul>
<li>Must not have MODIFIED or UPDATE flags (if parent exists)</li>
<li>Must not have children in RB-tree</li>
</ul>
</li>
<li>Removes chain from parent's RB-tree if present</li>
<li>Frees the chain memory</li>
<li>May recursively drop parent</li>
</ol>
<p><em>Source: <code>hammer2_chain.c:450-699</code></em></p>
<h2 id="tree-traversal">Tree Traversal<a class="headerlink" href="#tree-traversal" title="Permanent link"></a></h2>
<h3 id="lookup-initialization">Lookup Initialization<a class="headerlink" href="#lookup-initialization" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_chain_lookup_init</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_lookup_done</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">);</span>
</code></pre></div>
<p>Bracket a series of lookups:</p>
<ul>
<li><code>lookup_init</code>: Refs and locks the parent</li>
<li><code>lookup_done</code>: Unlocks and drops the parent</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:2113-2133</code></em></p>
<h3 id="hammer2_chain_lookup">hammer2_chain_lookup()<a class="headerlink" href="#hammer2_chain_lookup" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_chain_lookup</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">parentp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="o">*</span><span class="n">key_nextp</span><span class="p">,</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">                                       </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="n">key_beg</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="n">key_end</span><span class="p">,</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">                                       </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Looks up the first chain whose key range overlaps <code>[key_beg, key_end]</code>:</p>
<ol>
<li>Counts blockrefs if not already counted (<code>COUNTEDBREFS</code>)</li>
<li>Acquires parent's spinlock</li>
<li>Calls <code>hammer2_combined_find()</code> to search both:<ul>
<li>The in-memory RB-tree of child chains</li>
<li>The on-disk blockref array</li>
</ul>
</li>
<li>If found in blockref but not in memory, creates chain with <code>hammer2_chain_get()</code></li>
<li>Handles MATCHIND flag to return indirect blocks</li>
<li>Returns locked chain, sets <code>*key_nextp</code> for iteration</li>
</ol>
<p><em>Source: <code>hammer2_chain.c:2339-2600</code></em></p>
<h3 id="lookup-flags">Lookup Flags<a class="headerlink" href="#lookup-flags" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HAMMER2_LOOKUP_NODATA</code></td>
<td>Don't resolve data (leave NULL)</td>
</tr>
<tr>
<td><code>HAMMER2_LOOKUP_NODIRECT</code></td>
<td>Don't return inode for offset 0 in DIRECTDATA mode</td>
</tr>
<tr>
<td><code>HAMMER2_LOOKUP_SHARED</code></td>
<td>Use shared lock</td>
</tr>
<tr>
<td><code>HAMMER2_LOOKUP_MATCHIND</code></td>
<td>Allow returning indirect blocks</td>
</tr>
<tr>
<td><code>HAMMER2_LOOKUP_ALWAYS</code></td>
<td>Always resolve data</td>
</tr>
</tbody>
</table>
<p><em>Source: <code>hammer2.h:473-480</code></em></p>
<h3 id="hammer2_chain_next">hammer2_chain_next()<a class="headerlink" href="#hammer2_chain_next" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_chain_next</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">parentp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">                                     </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="o">*</span><span class="n">key_nextp</span><span class="p">,</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">                                     </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="n">key_beg</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="n">key_end</span><span class="p">,</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">                                     </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Continues iteration after <code>hammer2_chain_lookup()</code>:</p>
<ul>
<li>Unlocks and drops the previous chain</li>
<li>Uses <code>*key_nextp</code> to find the next element</li>
<li>Returns NULL with <code>HAMMER2_ERROR_EOF</code> when done</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:2690-2780</code></em></p>
<h3 id="hammer2_chain_scan">hammer2_chain_scan()<a class="headerlink" href="#hammer2_chain_scan" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_chain_scan</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">chainp</span><span class="p">,</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">                        </span><span class="n">hammer2_blockref_t</span><span class="w"> </span><span class="o">*</span><span class="n">bref</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">firstp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Raw scan for iterating all children:</p>
<ul>
<li>Does not seek to a specific key</li>
<li>Fills in <code>bref</code> with the current blockref</li>
<li>Only instantiates chains for recursive types (INDIRECT, INODE, etc.)</li>
<li>Returns <code>HAMMER2_ERROR_EOF</code> when exhausted</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:2820-3020</code></em></p>
<h2 id="modification-operations">Modification Operations<a class="headerlink" href="#modification-operations" title="Permanent link"></a></h2>
<h3 id="hammer2_chain_modify">hammer2_chain_modify()<a class="headerlink" href="#hammer2_chain_modify" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_chain_modify</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">mtid</span><span class="p">,</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">                          </span><span class="n">hammer2_off_t</span><span class="w"> </span><span class="n">dedup_off</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Marks a chain as modified, implementing copy-on-write:</p>
<ol>
<li>Loads existing data if needed (unless OPTDATA flag)</li>
<li>If not already MODIFIED:<ul>
<li>Sets MODIFIED flag</li>
<li>Determines if COW is required (checks overwrite-in-place eligibility)</li>
</ul>
</li>
<li>Sets UPDATE flag for parent blockref update</li>
<li>Acquires <code>diolk</code> for XOP interlock</li>
<li>If new allocation needed:<ul>
<li>Calls <code>hammer2_freemap_alloc()</code> for new block</li>
<li>Copies old data to new block</li>
<li>Clears DEDUPABLE flag</li>
</ul>
</li>
<li>If <code>dedup_off</code> specified:<ul>
<li>Uses dedup block instead of new allocation</li>
<li>Clears MODIFIED, sets DEDUPABLE</li>
</ul>
</li>
</ol>
<p><strong>Overwrite-in-place</strong>: Allowed when:</p>
<ul>
<li>Chain is DATA or DIRENT type</li>
<li>Check mode is NONE</li>
<li><code>modify_tid</code> is beyond the last snapshot</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:1436-1750</code></em></p>
<p>The following diagram illustrates the copy-on-write modification flow:</p>
<pre class="mermaid"><code>flowchart TB
    subgraph entry["hammer2_chain_modify Entry"]
        A[Start] --&gt; B{Already MODIFIED?}
    end

    subgraph check["COW Decision"]
        B --&gt;|No| C{Can overwrite<br/>in place?}
        B --&gt;|Yes| D[Skip allocation]
        C --&gt;|Yes| E["Set MODIFIED<br/>Keep same block"]
        C --&gt;|No| F["Set MODIFIED<br/>Need new block"]
    end

    subgraph cow["COW Allocation"]
        F --&gt; G[hammer2_freemap_alloc]
        G --&gt; H["Allocate new block"]
        H --&gt; I["Copy old data  new block"]
        I --&gt; J["Update bref.data_off"]
    end

    subgraph parent_update["Parent Update Chain"]
        E --&gt; K["Set UPDATE flag"]
        D --&gt; K
        J --&gt; K
        K --&gt; L["Parent's blockref<br/>must be updated"]
        L --&gt; M["Parent also needs<br/>hammer2_chain_modify"]
        M --&gt; N["...propagates to root"]
    end

    subgraph complete["Completion"]
        N --&gt; O[setflush on ancestors]
        O --&gt; P[Return]
    end
</code></pre>
<p><strong>Why COW propagates upward</strong>: When a chain's block location changes, its parent's blockref entry must be updated to point to the new location. This update modifies the parent, requiring the parent to also undergo COW. This propagation continues until reaching the volume header, which is updated atomically during flush.</p>
<h3 id="hammer2_chain_resize">hammer2_chain_resize()<a class="headerlink" href="#hammer2_chain_resize" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_chain_resize</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">mtid</span><span class="p">,</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">                          </span><span class="n">hammer2_off_t</span><span class="w"> </span><span class="n">dedup_off</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nradix</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Resizes a chain's physical storage:</p>
<ul>
<li>Only DATA, INDIRECT, and DIRENT blocks can be resized</li>
<li>Calls <code>hammer2_chain_modify()</code> first</li>
<li>Allocates new storage with <code>hammer2_freemap_alloc()</code></li>
<li>Updates <code>chain-&gt;bytes</code></li>
<li>Caller must copy data if needed</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:1339-1407</code></em></p>
<h2 id="chain-creation-and-deletion">Chain Creation and Deletion<a class="headerlink" href="#chain-creation-and-deletion" title="Permanent link"></a></h2>
<h3 id="hammer2_chain_create">hammer2_chain_create()<a class="headerlink" href="#hammer2_chain_create" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_chain_create</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">parentp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">chainp</span><span class="p">,</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">                          </span><span class="n">hammer2_pfs_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">methods</span><span class="p">,</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">                          </span><span class="n">hammer2_key_t</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">keybits</span><span class="p">,</span>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">                          </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span>
<a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">                          </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">mtid</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_off_t</span><span class="w"> </span><span class="n">dedup_off</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Creates a new chain or reattaches an existing one:</p>
<ol>
<li>If <code>*chainp</code> is NULL, allocates a new chain with INITIAL flag</li>
<li>Ensures parent has room for new child:<ul>
<li>If <code>live_count == count</code>, creates indirect block</li>
</ul>
</li>
<li>Inserts chain into parent's RB-tree</li>
<li>Calls <code>hammer2_chain_modify()</code> for newly allocated chains</li>
<li>Sets UPDATE flag for reconnected chains</li>
<li>Calls <code>hammer2_chain_setflush()</code> on parent</li>
</ol>
<p><strong>Indirect block creation</strong>: When a parent's blockref array is full, <code>hammer2_chain_create_indirect()</code> is called to:</p>
<ol>
<li>Allocate an indirect block</li>
<li>Move some children to the indirect block</li>
<li>Return the appropriate parent for the new chain</li>
</ol>
<p><em>Source: <code>hammer2_chain.c:3070-3388</code></em></p>
<h3 id="hammer2_chain_delete">hammer2_chain_delete()<a class="headerlink" href="#hammer2_chain_delete" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_delete</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">                           </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">mtid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Deletes a chain from the topology:</p>
<ol>
<li>Sets DELETED flag</li>
<li>Removes chain from parent's RB-tree</li>
<li>Removes blockmap entry from parent (if BLKMAPPED)</li>
<li>Decrements parent's <code>live_count</code></li>
<li>If <code>HAMMER2_DELETE_PERMANENT</code>:<ul>
<li>Marks storage for deallocation via freemap</li>
</ul>
</li>
</ol>
<p><em>Source: <code>hammer2_chain.c:3640-3680</code></em></p>
<h3 id="hammer2_chain_rename">hammer2_chain_rename()<a class="headerlink" href="#hammer2_chain_rename" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_rename</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">parentp</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">                           </span><span class="n">hammer2_tid_t</span><span class="w"> </span><span class="n">mtid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Moves a chain to a new parent:</p>
<ul>
<li>Chain must already be disconnected (deleted or never attached)</li>
<li>Calls <code>hammer2_chain_create()</code> to insert under new parent</li>
<li>Sets UPDATE and ONFLUSH flags</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:3415-3461</code></em></p>
<h2 id="flush-integration">Flush Integration<a class="headerlink" href="#flush-integration" title="Permanent link"></a></h2>
<h3 id="hammer2_chain_setflush">hammer2_chain_setflush()<a class="headerlink" href="#hammer2_chain_setflush" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">hammer2_chain_setflush</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">);</span>
</code></pre></div>
<p>Marks a chain and its ancestors for flushing:</p>
<ol>
<li>Sets ONFLUSH flag on chain</li>
<li>Walks up to parent, setting ONFLUSH on each</li>
<li>Stops at inode boundaries (flush inflection points)</li>
<li>Inode chains connect different flush domains</li>
</ol>
<p>The flusher uses ONFLUSH to efficiently locate modified chains via top-down recursion.</p>
<p><em>Source: <code>hammer2_chain.c:146-165</code></em></p>
<p>The following diagram shows how ONFLUSH propagates up the chain tree:</p>
<pre class="mermaid"><code>flowchart TB
    subgraph tree["Chain Tree"]
        root["Volume Root"]
        pfs["PFS Inode<br/>(flush boundary)"]
        dir["Directory Inode<br/>(flush boundary)"]
        indirect["Indirect Block"]
        data["Data Block<br/>(MODIFIED)"]
    end

    root --&gt; pfs
    pfs --&gt; dir
    dir --&gt; indirect
    indirect --&gt; data

    subgraph propagation["setflush Propagation"]
        data --&gt;|"1. Set ONFLUSH"| step1["data: ONFLUSH "]
        step1 --&gt;|"2. Walk to parent"| step2["indirect: ONFLUSH "]
        step2 --&gt;|"3. Walk to parent"| step3["dir (inode): ONFLUSH "]
        step3 --&gt;|"4. STOP at inode"| stop["Inode is flush<br/>inflection point"]
    end
</code></pre>
<p><strong>Why inodes are boundaries</strong>: Inodes serve as natural flush boundaries because they represent coherent filesystem objects. The flusher processes inodes via the <code>sideq</code> (side-queue) and recursively flushes their children. This allows incremental flushing without traversing the entire tree.</p>
<h3 id="flush-related-flags">Flush-Related Flags<a class="headerlink" href="#flush-related-flags" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MODIFIED</code></td>
<td>Chain data was modified, needs writing</td>
</tr>
<tr>
<td><code>UPDATE</code></td>
<td>Parent blockref needs updating</td>
</tr>
<tr>
<td><code>ONFLUSH</code></td>
<td>Chain is on the flush recursion path</td>
</tr>
<tr>
<td><code>BLKMAPPED</code></td>
<td>Chain exists in parent's on-disk blockmap</td>
</tr>
<tr>
<td><code>BLKMAPUPD</code></td>
<td>Blockmap entry needs update (bref changed)</td>
</tr>
</tbody>
</table>
<h2 id="parent-access">Parent Access<a class="headerlink" href="#parent-access" title="Permanent link"></a></h2>
<h3 id="hammer2_chain_getparent">hammer2_chain_getparent()<a class="headerlink" href="#hammer2_chain_getparent" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_chain_getparent</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Returns a locked parent while keeping chain locked:</p>
<ul>
<li>Handles lock order reversal (must unlock child before locking parent)</li>
<li>Re-locks child after acquiring parent</li>
<li>Handles races where parent changes during unlock window</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:2149-2185</code></em></p>
<h3 id="hammer2_chain_repparent">hammer2_chain_repparent()<a class="headerlink" href="#hammer2_chain_repparent" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="nf">hammer2_chain_repparent</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">**</span><span class="n">chainp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p>Returns parent while dropping the chain:</p>
<ul>
<li>Uses <code>reptrack</code> mechanism to follow parent if it changes</li>
<li>Handles complex deletion scenarios during indirect block cleanup</li>
<li>More complex than <code>getparent()</code> but handles unstable chains</li>
</ul>
<p><em>Source: <code>hammer2_chain.c:2200-2293</code></em></p>
<h2 id="rb-tree-organization">RB-Tree Organization<a class="headerlink" href="#rb-tree-organization" title="Permanent link"></a></h2>
<p>Chains are organized in a red-black tree within their parent, keyed by their blockref's key and keybits:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">hammer2_chain_cmp</span><span class="p">(</span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain1</span><span class="p">,</span><span class="w"> </span><span class="n">hammer2_chain_t</span><span class="w"> </span><span class="o">*</span><span class="n">chain2</span><span class="p">);</span>
</code></pre></div>
<p>The comparison function:</p>
<ol>
<li>Calculates key range for each chain: <code>[key, key + (1 &lt;&lt; keybits) - 1]</code></li>
<li>Returns -1 if chain1 is fully left of chain2</li>
<li>Returns +1 if chain1 is fully right of chain2</li>
<li>Returns 0 for overlap (should not happen in normal operation)</li>
</ol>
<p>This allows efficient range-based lookups and ensures children don't overlap.</p>
<p><em>Source: <code>hammer2_chain.c:96-118</code></em></p>
<h2 id="combined-find">Combined Find<a class="headerlink" href="#combined-find" title="Permanent link"></a></h2>
<p>The lookup system must merge two data sources to find the correct chain for a given key:</p>
<pre class="mermaid"><code>flowchart TB
    subgraph search["hammer2_combined_find"]
        A["Input: key range<br/>[key_beg, key_end]"]
        A --&gt; B["Search RB-Tree<br/>(in-memory chains)"]
        A --&gt; C["Search blockref array<br/>(on-disk references)"]
    end

    subgraph rbtree["RB-Tree Results"]
        B --&gt; D{Found chain?}
        D --&gt;|Yes| E["chain (may be<br/>MODIFIED or DELETED)"]
        D --&gt;|No| F["No in-memory<br/>representation"]
    end

    subgraph blockref["Blockref Results"]
        C --&gt; G{Found bref?}
        G --&gt;|Yes| H["bref from parent's<br/>block table"]
        G --&gt;|No| I["Not on disk"]
    end

    subgraph merge["Merge Logic"]
        E --&gt; J{Compare results}
        F --&gt; J
        H --&gt; J
        I --&gt; J
        J --&gt; K["Return best match:<br/>- Prefer in-memory if exists<br/>- Create chain from bref if needed<br/>- Handle DELETED chains specially"]
    end
</code></pre>
<p><strong>Scenarios handled by combined find:</strong></p>
<table>
<thead>
<tr>
<th>RB-Tree</th>
<th>Blockref</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>Found (live)</td>
<td>Found</td>
<td>Return in-memory chain</td>
</tr>
<tr>
<td>Found (DELETED)</td>
<td>Found</td>
<td>Return bref, skip deleted chain</td>
</tr>
<tr>
<td>Not found</td>
<td>Found</td>
<td>Create chain from bref via <code>hammer2_chain_get()</code></td>
</tr>
<tr>
<td>Found (new)</td>
<td>Not found</td>
<td>Return in-memory chain (not yet flushed)</td>
</tr>
<tr>
<td>Not found</td>
<td>Not found</td>
<td>Key does not exist</td>
</tr>
</tbody>
</table>
<p>The <code>hammer2_combined_find()</code> function merges results from:</p>
<ol>
<li><strong>In-memory chains</strong>: Searched via RB-tree scan</li>
<li><strong>On-disk blockrefs</strong>: Searched via linear scan of blockref array</li>
</ol>
<p>This is necessary because:</p>
<ul>
<li>Not all on-disk blockrefs have in-memory chains</li>
<li>In-memory chains may be newly created (not yet on disk)</li>
<li>In-memory chains may be deleted (still on disk until flushed)</li>
</ul>
<p>The combined find returns the best match considering both sources.</p>
<p><em>Source: <code>hammer2_chain.c:1900-2030</code></em></p>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link"></a></h2>
<ul>
<li><a href="../">HAMMER2 Overview</a></li>
<li><a href="../on-disk-format/">On-Disk Format</a>  Underlying block references</li>
<li><a href="../inode-layer/">Inode Layer</a>  Higher-level inode abstraction</li>
<li><a href="../flush-sync/">Flush and Sync</a>  How chains are flushed to disk</li>
<li><a href="../xop-system/">XOP System</a>  Cross-cluster operations using chains</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>