
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../vfs-operations/" rel="prev"/>
<link href="../vfs-locking/" rel="next"/>
<link href="../../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Journaling System - DragonFly BSD Kernel Documentation</title>
<link href="../../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#vfs-journaling-system">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Journaling System
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#architecture">
<span class="md-ellipsis">
      
        Architecture
      
    </span>
</a>
<nav aria-label="Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#layered-design">
<span class="md-ellipsis">
      
        Layered Design
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#memory-fifo-structure">
<span class="md-ellipsis">
      
        Memory FIFO Structure
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-records">
<span class="md-ellipsis">
      
        Journal Records
      
    </span>
</a>
<nav aria-label="Journal Records" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#stream-record-structure">
<span class="md-ellipsis">
      
        Stream Record Structure
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stream-control-bits">
<span class="md-ellipsis">
      
        Stream Control Bits
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#special-stream-ids">
<span class="md-ellipsis">
      
        Special Stream IDs
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#subrecords">
<span class="md-ellipsis">
      
        Subrecords
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-management">
<span class="md-ellipsis">
      
        FIFO Management
      
    </span>
</a>
<nav aria-label="FIFO Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#reservation-process">
<span class="md-ellipsis">
      
        Reservation Process
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#extension-and-truncation">
<span class="md-ellipsis">
      
        Extension and Truncation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#commit-process">
<span class="md-ellipsis">
      
        Commit Process
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#abort-process">
<span class="md-ellipsis">
      
        Abort Process
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#worker-threads">
<span class="md-ellipsis">
      
        Worker Threads
      
    </span>
</a>
<nav aria-label="Worker Threads" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#write-worker-thread">
<span class="md-ellipsis">
      
        Write Worker Thread
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#read-worker-thread-full-duplex">
<span class="md-ellipsis">
      
        Read Worker Thread (Full-Duplex)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-vop-operations">
<span class="md-ellipsis">
      
        Journal VOP Operations
      
    </span>
</a>
<nav aria-label="Journal VOP Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#operation-interception">
<span class="md-ellipsis">
      
        Operation Interception
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example-journal_write">
<span class="md-ellipsis">
      
        Example: journal_write()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#undo-recording">
<span class="md-ellipsis">
      
        UNDO Recording
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#redo-recording">
<span class="md-ellipsis">
      
        REDO Recording
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-management">
<span class="md-ellipsis">
      
        Journal Management
      
    </span>
</a>
<nav aria-label="Journal Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#installing-a-journal">
<span class="md-ellipsis">
      
        Installing a Journal
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-lifecycle">
<span class="md-ellipsis">
      
        Journal Lifecycle
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#transaction-structure">
<span class="md-ellipsis">
      
        Transaction Structure
      
    </span>
</a>
<nav aria-label="Transaction Structure" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#nested-subrecords">
<span class="md-ellipsis">
      
        Nested Subrecords
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#jrecord-api">
<span class="md-ellipsis">
      
        jrecord API
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#synchronization-and-locking">
<span class="md-ellipsis">
      
        Synchronization and Locking
      
    </span>
</a>
<nav aria-label="Synchronization and Locking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-concurrency">
<span class="md-ellipsis">
      
        FIFO Concurrency
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#memory-barriers">
<span class="md-ellipsis">
      
        Memory Barriers
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-targets">
<span class="md-ellipsis">
      
        Journal Targets
      
    </span>
</a>
<nav aria-label="Journal Targets" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#filesocket-support">
<span class="md-ellipsis">
      
        File/Socket Support
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#full-duplex-journaling">
<span class="md-ellipsis">
      
        Full-Duplex Journaling
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restart-and-resync">
<span class="md-ellipsis">
      
        Restart and Resync
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#performance-considerations">
<span class="md-ellipsis">
      
        Performance Considerations
      
    </span>
</a>
<nav aria-label="Performance Considerations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-sizing">
<span class="md-ellipsis">
      
        FIFO Sizing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#batching-efficiency">
<span class="md-ellipsis">
      
        Batching Efficiency
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#zero-copy-optimization">
<span class="md-ellipsis">
      
        Zero-Copy Optimization
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-handling">
<span class="md-ellipsis">
      
        Error Handling
      
    </span>
</a>
<nav aria-label="Error Handling" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#filesystem-operation-errors">
<span class="md-ellipsis">
      
        Filesystem Operation Errors
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-write-errors">
<span class="md-ellipsis">
      
        Journal Write Errors
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-overflow">
<span class="md-ellipsis">
      
        FIFO Overflow
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#use-cases">
<span class="md-ellipsis">
      
        Use Cases
      
    </span>
</a>
<nav aria-label="Use Cases" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#replication">
<span class="md-ellipsis">
      
        Replication
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#auditing">
<span class="md-ellipsis">
      
        Auditing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reversible-journaling">
<span class="md-ellipsis">
      
        Reversible Journaling
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#local-fast-journal">
<span class="md-ellipsis">
      
        Local Fast Journal
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debugging">
<span class="md-ellipsis">
      
        Debugging
      
    </span>
</a>
<nav aria-label="Debugging" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#statistics">
<span class="md-ellipsis">
      
        Statistics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tracing">
<span class="md-ellipsis">
      
        Tracing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-issues">
<span class="md-ellipsis">
      
        Common Issues
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#limitations-and-future-work">
<span class="md-ellipsis">
      
        Limitations and Future Work
      
    </span>
</a>
<nav aria-label="Limitations and Future Work" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#current-limitations">
<span class="md-ellipsis">
      
        Current Limitations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#planned-enhancements">
<span class="md-ellipsis">
      
        Planned Enhancements
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
<span class="md-ellipsis">
      
        Summary
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vm/vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/hammer2/">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../vfs/dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#architecture">
<span class="md-ellipsis">
      
        Architecture
      
    </span>
</a>
<nav aria-label="Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#layered-design">
<span class="md-ellipsis">
      
        Layered Design
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#memory-fifo-structure">
<span class="md-ellipsis">
      
        Memory FIFO Structure
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-records">
<span class="md-ellipsis">
      
        Journal Records
      
    </span>
</a>
<nav aria-label="Journal Records" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#stream-record-structure">
<span class="md-ellipsis">
      
        Stream Record Structure
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stream-control-bits">
<span class="md-ellipsis">
      
        Stream Control Bits
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#special-stream-ids">
<span class="md-ellipsis">
      
        Special Stream IDs
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#subrecords">
<span class="md-ellipsis">
      
        Subrecords
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-management">
<span class="md-ellipsis">
      
        FIFO Management
      
    </span>
</a>
<nav aria-label="FIFO Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#reservation-process">
<span class="md-ellipsis">
      
        Reservation Process
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#extension-and-truncation">
<span class="md-ellipsis">
      
        Extension and Truncation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#commit-process">
<span class="md-ellipsis">
      
        Commit Process
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#abort-process">
<span class="md-ellipsis">
      
        Abort Process
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#worker-threads">
<span class="md-ellipsis">
      
        Worker Threads
      
    </span>
</a>
<nav aria-label="Worker Threads" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#write-worker-thread">
<span class="md-ellipsis">
      
        Write Worker Thread
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#read-worker-thread-full-duplex">
<span class="md-ellipsis">
      
        Read Worker Thread (Full-Duplex)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-vop-operations">
<span class="md-ellipsis">
      
        Journal VOP Operations
      
    </span>
</a>
<nav aria-label="Journal VOP Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#operation-interception">
<span class="md-ellipsis">
      
        Operation Interception
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example-journal_write">
<span class="md-ellipsis">
      
        Example: journal_write()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#undo-recording">
<span class="md-ellipsis">
      
        UNDO Recording
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#redo-recording">
<span class="md-ellipsis">
      
        REDO Recording
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-management">
<span class="md-ellipsis">
      
        Journal Management
      
    </span>
</a>
<nav aria-label="Journal Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#installing-a-journal">
<span class="md-ellipsis">
      
        Installing a Journal
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-lifecycle">
<span class="md-ellipsis">
      
        Journal Lifecycle
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#transaction-structure">
<span class="md-ellipsis">
      
        Transaction Structure
      
    </span>
</a>
<nav aria-label="Transaction Structure" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#nested-subrecords">
<span class="md-ellipsis">
      
        Nested Subrecords
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#jrecord-api">
<span class="md-ellipsis">
      
        jrecord API
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#synchronization-and-locking">
<span class="md-ellipsis">
      
        Synchronization and Locking
      
    </span>
</a>
<nav aria-label="Synchronization and Locking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-concurrency">
<span class="md-ellipsis">
      
        FIFO Concurrency
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#memory-barriers">
<span class="md-ellipsis">
      
        Memory Barriers
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-targets">
<span class="md-ellipsis">
      
        Journal Targets
      
    </span>
</a>
<nav aria-label="Journal Targets" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#filesocket-support">
<span class="md-ellipsis">
      
        File/Socket Support
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#full-duplex-journaling">
<span class="md-ellipsis">
      
        Full-Duplex Journaling
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restart-and-resync">
<span class="md-ellipsis">
      
        Restart and Resync
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#performance-considerations">
<span class="md-ellipsis">
      
        Performance Considerations
      
    </span>
</a>
<nav aria-label="Performance Considerations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-sizing">
<span class="md-ellipsis">
      
        FIFO Sizing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#batching-efficiency">
<span class="md-ellipsis">
      
        Batching Efficiency
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#zero-copy-optimization">
<span class="md-ellipsis">
      
        Zero-Copy Optimization
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-handling">
<span class="md-ellipsis">
      
        Error Handling
      
    </span>
</a>
<nav aria-label="Error Handling" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#filesystem-operation-errors">
<span class="md-ellipsis">
      
        Filesystem Operation Errors
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#journal-write-errors">
<span class="md-ellipsis">
      
        Journal Write Errors
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fifo-overflow">
<span class="md-ellipsis">
      
        FIFO Overflow
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#use-cases">
<span class="md-ellipsis">
      
        Use Cases
      
    </span>
</a>
<nav aria-label="Use Cases" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#replication">
<span class="md-ellipsis">
      
        Replication
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#auditing">
<span class="md-ellipsis">
      
        Auditing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reversible-journaling">
<span class="md-ellipsis">
      
        Reversible Journaling
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#local-fast-journal">
<span class="md-ellipsis">
      
        Local Fast Journal
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debugging">
<span class="md-ellipsis">
      
        Debugging
      
    </span>
</a>
<nav aria-label="Debugging" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#statistics">
<span class="md-ellipsis">
      
        Statistics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tracing">
<span class="md-ellipsis">
      
        Tracing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-issues">
<span class="md-ellipsis">
      
        Common Issues
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#limitations-and-future-work">
<span class="md-ellipsis">
      
        Limitations and Future Work
      
    </span>
</a>
<nav aria-label="Limitations and Future Work" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#current-limitations">
<span class="md-ellipsis">
      
        Current Limitations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#planned-enhancements">
<span class="md-ellipsis">
      
        Planned Enhancements
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
<span class="md-ellipsis">
      
        Summary
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="vfs-journaling-system">VFS Journaling System<a class="headerlink" href="#vfs-journaling-system" title="Permanent link"></a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link"></a></h2>
<p>The DragonFly BSD VFS journaling system provides a flexible infrastructure for recording filesystem operations to a journal stream. This enables features like:</p>
<ul>
<li><strong>Transaction logging</strong> - Record all filesystem changes</li>
<li><strong>Replication</strong> - Stream changes to remote systems</li>
<li><strong>Crash recovery</strong> - Replay operations after system failures</li>
<li><strong>Auditing</strong> - Track all filesystem modifications</li>
<li><strong>Two-way acknowledgement</strong> - Full-duplex journaling with commit confirmation</li>
</ul>
<p>The journaling layer sits between VOP wrappers and the underlying filesystem, transparently intercepting and recording operations before passing them through to the actual filesystem implementation.</p>
<p><strong>Key components:</strong>
- <strong>Memory FIFO</strong> - Circular buffer for batching journal records
- <strong>Worker threads</strong> - Asynchronous write-out to journal targets
- <strong>Stream records</strong> - Structured format for journal data
- <strong>Transaction IDs</strong> - Sequencing and acknowledgement
- <strong>Subrecords</strong> - Nested transaction structure</p>
<p><strong>Key files:</strong>
- <code>sys/kern/vfs_journal.c</code> - Core journaling infrastructure and FIFO management
- <code>sys/kern/vfs_jops.c</code> - Journal VOP implementations
- <code>sys/sys/journal.h</code> - Journaling data structures and protocol definitions</p>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link"></a></h2>
<h3 id="layered-design">Layered Design<a class="headerlink" href="#layered-design" title="Permanent link"></a></h3>
<pre class="mermaid"><code>flowchart TD
    USER["User/Kernel VFS calls"] --&gt; VOP["VOP Wrappers<br/>(vfs_vopops.c)"]
    VOP --&gt; JOURNAL{"Journaling<br/>enabled?"}
    JOURNAL --&gt;|Yes| JLAYER["Journal Layer<br/>(vfs_jops.c)"]
    JOURNAL --&gt;|No| FS
    JLAYER --&gt; FS["Underlying Filesystem"]
    FS --&gt; DISK["Disk/Storage"]
</code></pre>
<p>When journaling is enabled for a mount point:
1. Mount point's <code>mnt_vn_journal_ops</code> is set to <code>journal_vnode_vops</code>
2. VOP operations are intercepted by journal functions
3. Journal records operation details to memory FIFO
4. Worker thread writes FIFO contents to journal target
5. Operation is passed to underlying filesystem</p>
<h3 id="memory-fifo-structure">Memory FIFO Structure<a class="headerlink" href="#memory-fifo-structure" title="Permanent link"></a></h3>
<p>The memory FIFO is a circular buffer that batches journal records before writing to the target:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">journal_fifo</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">membase</span><span class="p">;</span><span class="w">      </span><span class="c1">// Base of circular buffer</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">        </span><span class="c1">// Total buffer size (power of 2)</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span><span class="w">        </span><span class="c1">// Size - 1 (for wrapping)</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">windex</span><span class="p">;</span><span class="w">     </span><span class="c1">// Write index (monotonically increasing)</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">rindex</span><span class="p">;</span><span class="w">     </span><span class="c1">// Read index (what's been written out)</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">xindex</span><span class="p">;</span><span class="w">     </span><span class="c1">// Acknowledgement index (what's been committed)</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Index relationships:</strong>
- <code>windex &gt;= rindex &gt;= xindex</code> (always)
- Available write space: <code>size - (windex - xindex)</code>
- Unwritten data: <code>windex - rindex</code>
- Unacknowledged data: <code>rindex - xindex</code></p>
<p><strong>Key properties:</strong>
- Indices never decrease (monotonically increasing)
- Wrapping uses mask: <code>physicaloffset = index &amp; mask</code>
- 16-byte alignment for all records
- Incomplete records block worker thread progress</p>
<h2 id="journal-records">Journal Records<a class="headerlink" href="#journal-records" title="Permanent link"></a></h2>
<h3 id="stream-record-structure">Stream Record Structure<a class="headerlink" href="#stream-record-structure" title="Permanent link"></a></h3>
<p>Stream records are the fundamental unit of journaling:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">journal_rawrecbeg</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="n">u_int16_t</span><span class="w"> </span><span class="n">begmagic</span><span class="p">;</span><span class="w">     </span><span class="c1">// JREC_BEGMAGIC (0x1234) or INCOMPLETE</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="n">u_int16_t</span><span class="w"> </span><span class="n">streamid</span><span class="p">;</span><span class="w">     </span><span class="c1">// Stream ID + control bits</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">recsize</span><span class="p">;</span><span class="w">        </span><span class="c1">// Total record size (includes header/trailer)</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">transid</span><span class="p">;</span><span class="w">        </span><span class="c1">// Sequence/transaction ID</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="c1">// ... payload data ...</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="p">};</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="k">struct</span><span class="w"> </span><span class="nc">journal_rawrecend</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="n">u_int16_t</span><span class="w"> </span><span class="n">endmagic</span><span class="p">;</span><span class="w">     </span><span class="c1">// JREC_ENDMAGIC (0xCDEF)</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="n">u_int16_t</span><span class="w"> </span><span class="n">check</span><span class="p">;</span><span class="w">        </span><span class="c1">// Checksum (0 = disabled)</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">recsize</span><span class="p">;</span><span class="w">        </span><span class="c1">// Same as rawrecbeg-&gt;recsize</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Record layout:</strong></p>
<pre class="mermaid"><code>block-beta
    columns 1
    block:header["rawrecbeg (16B) - Header"]
    end
    block:payload["Payload data (Variable size)<br/>(subrecords)"]
    end
    block:trailer["rawrecend (8B) - Trailer"]
    end
</code></pre>
<p>Total: 16-byte aligned</p>
<p><strong>Magic numbers:</strong>
- <code>JREC_BEGMAGIC (0x1234)</code> - Valid record ready to write
- <code>JREC_INCOMPLETEMAGIC (0xFFFF)</code> - Reserved but not yet committed
- <code>JREC_ENDMAGIC (0xCDEF)</code> - End marker for reverse scanning</p>
<h3 id="stream-control-bits">Stream Control Bits<a class="headerlink" href="#stream-control-bits" title="Permanent link"></a></h3>
<p>The <code>streamid</code> field combines control bits and stream identifier:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cp">#define JREC_STREAMCTL_BEGIN    0x8000  </span><span class="c1">// Start of logical stream</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="cp">#define JREC_STREAMCTL_END      0x4000  </span><span class="c1">// End of logical stream</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="cp">#define JREC_STREAMCTL_ABORTED  0x2000  </span><span class="c1">// Stream was aborted</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="cp">#define JREC_STREAMID_MASK      0x1FFF  </span><span class="c1">// Actual stream ID (bits 0-12)</span>
</code></pre></div>
<p><strong>Stream lifecycle:</strong>
- <strong>Single record:</strong> <code>BEGIN | END</code> set (complete transaction in one record)
- <strong>Multi-record:</strong> First has <code>BEGIN</code>, intermediate have neither, last has <code>END</code>
- <strong>Aborted:</strong> Last record has <code>ABORTED | END</code></p>
<h3 id="special-stream-ids">Special Stream IDs<a class="headerlink" href="#special-stream-ids" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="cp">#define JREC_STREAMID_PAD       0x0001  </span><span class="c1">// Padding (FIFO wrap-around)</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="cp">#define JREC_STREAMID_SYNCPT    0x0000  </span><span class="c1">// Synchronization point</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="cp">#define JREC_STREAMID_DISCONT   0x0002  </span><span class="c1">// Discontinuity marker</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="cp">#define JREC_STREAMID_ACK       0x0004  </span><span class="c1">// Acknowledgement record</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="cp">#define JREC_STREAMID_RESTART   0x0005  </span><span class="c1">// Journal restart marker</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// Filesystem operation streams: 0x0100 - 0x1FFF</span>
</code></pre></div>
<h3 id="subrecords">Subrecords<a class="headerlink" href="#subrecords" title="Permanent link"></a></h3>
<p>Within a stream record, operations are broken down into subrecords:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">journal_subrecord</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="n">u_int16_t</span><span class="w"> </span><span class="n">rectype</span><span class="p">;</span><span class="w">      </span><span class="c1">// Control bits + type</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">reserved</span><span class="p">;</span><span class="w">       </span><span class="c1">// Future use</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">recsize</span><span class="p">;</span><span class="w">        </span><span class="c1">// Subrecord size</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="c1">// ... type-specific data ...</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Subrecord control bits:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="cp">#define JMASK_NESTED    0x8000  </span><span class="c1">// Contains nested subrecords</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="cp">#define JMASK_LAST      0x4000  </span><span class="c1">// Last subrecord in group</span>
</code></pre></div></p>
<p><strong>Common subrecord types:</strong>
- <code>JTYPE_SETATTR</code> - Attribute changes (nested)
- <code>JTYPE_WRITE</code> - File write operation (nested)
- <code>JTYPE_CREATE</code> - File creation (nested)
- <code>JTYPE_REMOVE</code> - File removal (nested)
- <code>JTYPE_RENAME</code> - File rename (nested)
- <code>JTYPE_UNDO</code> - Undo information (nested)
- <code>JLEAF_FILEDATA</code> - File content data (leaf)
- <code>JLEAF_PATH1/2/3/4</code> - Pathname components (leaf)
- <code>JLEAF_UID/GID</code> - User/group IDs (leaf)</p>
<h2 id="fifo-management">FIFO Management<a class="headerlink" href="#fifo-management" title="Permanent link"></a></h2>
<h3 id="reservation-process">Reservation Process<a class="headerlink" href="#reservation-process" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_journal.c:496</code>.</p>
<p><strong>Function:</strong> <code>journal_reserve()</code></p>
<p>The reservation process ensures thread-safe allocation of FIFO space:</p>
<ol>
<li>
<p><strong>Calculate required space:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">total_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">payload_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trailer_size</span><span class="p">;</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">aligned_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">total_bytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mi">15</span><span class="p">;</span><span class="w">  </span><span class="c1">// 16-byte align</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Check for wrap-around:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">availtoend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fifo_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">windex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">fifo_mask</span><span class="p">);</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">availtoend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">availtoend</span><span class="p">;</span><span class="w">  </span><span class="c1">// Need pad record at end</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Wait for space if needed:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fifo_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">windex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xindex</span><span class="p">);</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avail</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">MC_JOURNAL_WWAIT</span><span class="p">;</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">windex</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"jwrite"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Create pad record if wrapping:</strong></p>
</li>
<li>Pad record fills dead space at end of FIFO</li>
<li>Has valid transaction ID for sequencing</li>
<li>
<p>Worker thread skips pad records</p>
</li>
<li>
<p><strong>Reserve space:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">begmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_INCOMPLETEMAGIC</span><span class="p">;</span><span class="w">  </span><span class="c1">// Blocks worker thread</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">streamid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">streamid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">JREC_STREAMCTL_BEGIN</span><span class="p">;</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">transid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">transid</span><span class="p">;</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="n">windex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_bytes</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Return pointer to payload area:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">rawp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// Skip header</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Key insight:</strong> The incomplete magic prevents the worker thread from writing past this record until it's committed, allowing the caller to populate the record at leisure.</p>
<h3 id="extension-and-truncation">Extension and Truncation<a class="headerlink" href="#extension-and-truncation" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_journal.c:610</code>.</p>
<p><strong>Function:</strong> <code>journal_extend()</code></p>
<p>Streams can be extended after initial reservation:</p>
<p><strong>Case 1: Simple extension</strong> (no size class change)
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_aligned_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">old_aligned_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span><span class="w">  </span><span class="c1">// Just update size</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">payload</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">truncbytes</span><span class="p">);</span>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Case 2: FIFO still at our record</strong> (can adjust windex)
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">windex</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="n">windex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">new_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_size</span><span class="p">);</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">payload</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">truncbytes</span><span class="p">);</span>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Case 3: Must create new stream record</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">// Commit current record (marked END)</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="n">journal_commit</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="n">rawpp</span><span class="p">,</span><span class="w"> </span><span class="n">truncbytes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c1">// Create new continuing record (no BEGIN mark)</span>
<a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="n">rptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journal_reserve</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="n">rawpp</span><span class="p">,</span><span class="w"> </span><span class="n">streamid</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">streamid</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">JREC_STREAMCTL_BEGIN</span><span class="p">;</span>
</code></pre></div></p>
<p>This creates a <strong>multi-record stream</strong> where records share the same stream ID but only the first has <code>BEGIN</code> and only the last has <code>END</code>.</p>
<h3 id="commit-process">Commit Process<a class="headerlink" href="#commit-process" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_journal.c:712</code>.</p>
<p><strong>Function:</strong> <code>journal_commit()</code></p>
<p>Committing a record makes it visible to the worker thread:</p>
<ol>
<li>
<p><strong>Truncate if requested:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="n">new_recsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">header_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trailer_size</span><span class="p">;</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="n">new_aligned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">new_recsize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mi">15</span><span class="p">;</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Handle freed space:</strong></p>
</li>
<li><strong>If windex still at our record:</strong> Back-index windex</li>
<li>
<p><strong>Otherwise:</strong> Create pad record in dead space</p>
</li>
<li>
<p><strong>Fill in trailer:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">rendp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">rawp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aligned_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rendp</span><span class="p">);</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="n">rendp</span><span class="o">-&gt;</span><span class="n">endmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_ENDMAGIC</span><span class="p">;</span>
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="n">rendp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="p">;</span>
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="n">rendp</span><span class="o">-&gt;</span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// Checksum (currently disabled)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Mark stream end if closeout:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">closeout</span><span class="p">)</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">    </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">streamid</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">JREC_STREAMCTL_END</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Commit with memory barrier:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">cpu_sfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// Ensure trailer written before magic</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">begmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_BEGMAGIC</span><span class="p">;</span><span class="w">  </span><span class="c1">// Makes record visible</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Wake worker if needed:</strong></p>
</li>
<li>If FIFO more than half full</li>
<li>If threads waiting for space (<code>MC_JOURNAL_WWAIT</code>)</li>
</ol>
<h3 id="abort-process">Abort Process<a class="headerlink" href="#abort-process" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_journal.c:678</code>.</p>
<p><strong>Function:</strong> <code>journal_abort()</code></p>
<p>Aborts can optimize away uncommitted records:</p>
<p><strong>Case 1: Can reverse windex</strong> (record at end of FIFO)
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_begin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">windex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">end_of_our_record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="n">windex</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">aligned_size</span><span class="p">;</span><span class="w">  </span><span class="c1">// Completely remove record</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="o">*</span><span class="n">rawpp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Case 2: Must mark as aborted</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">streamid</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">JREC_STREAMCTL_ABORTED</span><span class="p">;</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="n">journal_commit</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="n">rawpp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// Commit with 0 payload</span>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="p">}</span>
</code></pre></div></p>
<h2 id="worker-threads">Worker Threads<a class="headerlink" href="#worker-threads" title="Permanent link"></a></h2>
<h3 id="write-worker-thread">Write Worker Thread<a class="headerlink" href="#write-worker-thread" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_journal.c:165</code>.</p>
<p><strong>Function:</strong> <code>journal_wthread()</code></p>
<p>The write worker drains the FIFO to the journal target:</p>
<p><strong>Main loop:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">    </span><span class="c1">// Calculate writable bytes</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">windex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rindex</span><span class="p">;</span>
<a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>
<a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">    </span><span class="c1">// Sleep if nothing to write</span>
<a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stop_requested</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">        </span><span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"jfifo"</span><span class="p">,</span><span class="w"> </span><span class="n">hz</span><span class="p">);</span>
<a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a>
<a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">    </span><span class="c1">// Block on incomplete records</span>
<a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">    </span><span class="n">rawp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">membase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rindex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span>
<a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">begmagic</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JREC_INCOMPLETEMAGIC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-15" id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">        </span><span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"jpad"</span><span class="p">,</span><span class="w"> </span><span class="n">hz</span><span class="p">);</span>
<a href="#__codelineno-20-16" id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-20-17" id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-18" id="__codelineno-20-18" name="__codelineno-20-18"></a>
<a href="#__codelineno-20-19" id="__codelineno-20-19" name="__codelineno-20-19"></a><span class="w">    </span><span class="c1">// Skip pad records</span>
<a href="#__codelineno-20-20" id="__codelineno-20-20" name="__codelineno-20-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">streamid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JREC_STREAMID_PAD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-21" id="__codelineno-20-21" name="__codelineno-20-21"></a><span class="w">        </span><span class="n">rindex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_recsize</span><span class="p">;</span>
<a href="#__codelineno-20-22" id="__codelineno-20-22" name="__codelineno-20-22"></a><span class="w">        </span><span class="n">xindex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_recsize</span><span class="p">;</span><span class="w">  </span><span class="c1">// (if not full-duplex)</span>
<a href="#__codelineno-20-23" id="__codelineno-20-23" name="__codelineno-20-23"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-20-24" id="__codelineno-20-24" name="__codelineno-20-24"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-25" id="__codelineno-20-25" name="__codelineno-20-25"></a>
<a href="#__codelineno-20-26" id="__codelineno-20-26" name="__codelineno-20-26"></a><span class="w">    </span><span class="c1">// Calculate contiguous writable region</span>
<a href="#__codelineno-20-27" id="__codelineno-20-27" name="__codelineno-20-27"></a><span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-20-28" id="__codelineno-20-28" name="__codelineno-20-28"></a><span class="w">    </span><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fifo_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">rindex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span><span class="w">  </span><span class="c1">// To end of buffer</span>
<a href="#__codelineno-20-29" id="__codelineno-20-29" name="__codelineno-20-29"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">begmagic</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JREC_BEGMAGIC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-30" id="__codelineno-20-30" name="__codelineno-20-30"></a><span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_recsize</span><span class="p">;</span>
<a href="#__codelineno-20-31" id="__codelineno-20-31" name="__codelineno-20-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">avail</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w">  </span><span class="c1">// Hit end of buffer</span>
<a href="#__codelineno-20-32" id="__codelineno-20-32" name="__codelineno-20-32"></a><span class="w">        </span><span class="n">rawp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_record</span><span class="p">(</span><span class="n">rawp</span><span class="p">);</span>
<a href="#__codelineno-20-33" id="__codelineno-20-33" name="__codelineno-20-33"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-34" id="__codelineno-20-34" name="__codelineno-20-34"></a>
<a href="#__codelineno-20-35" id="__codelineno-20-35" name="__codelineno-20-35"></a><span class="w">    </span><span class="c1">// Write to target</span>
<a href="#__codelineno-20-36" id="__codelineno-20-36" name="__codelineno-20-36"></a><span class="w">    </span><span class="n">rindex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span><span class="w">  </span><span class="c1">// Advance BEFORE write (for ack racing)</span>
<a href="#__codelineno-20-37" id="__codelineno-20-37" name="__codelineno-20-37"></a><span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fp_write</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="n">membase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">old_rindex</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">written</span><span class="p">);</span>
<a href="#__codelineno-20-38" id="__codelineno-20-38" name="__codelineno-20-38"></a>
<a href="#__codelineno-20-39" id="__codelineno-20-39" name="__codelineno-20-39"></a><span class="w">    </span><span class="c1">// Advance acknowledgement index (if not full-duplex)</span>
<a href="#__codelineno-20-40" id="__codelineno-20-40" name="__codelineno-20-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">full_duplex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-41" id="__codelineno-20-41" name="__codelineno-20-41"></a><span class="w">        </span><span class="n">xindex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span>
<a href="#__codelineno-20-42" id="__codelineno-20-42" name="__codelineno-20-42"></a><span class="w">        </span><span class="n">wakeup_waiters</span><span class="p">();</span>
<a href="#__codelineno-20-43" id="__codelineno-20-43" name="__codelineno-20-43"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-44" id="__codelineno-20-44" name="__codelineno-20-44"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Key aspects:</strong>
- Never writes incomplete records (blocks until committed)
- Writes contiguous regions up to buffer wrap
- Advances rindex before writing (allows acks to race)
- Handles full-duplex vs simplex differently</p>
<h3 id="read-worker-thread-full-duplex">Read Worker Thread (Full-Duplex)<a class="headerlink" href="#read-worker-thread-full-duplex" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_journal.c:301</code>.</p>
<p><strong>Function:</strong> <code>journal_rthread()</code></p>
<p>For two-way journaling streams, reads acknowledgements from target:</p>
<p><strong>Main loop:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stop_requested</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a>
<a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="c1">// Read acknowledgement record</span>
<a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">transid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fp_read</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ack</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">UIO_SYSSPACE</span><span class="p">);</span>
<a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ack</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a>
<a href="#__codelineno-21-9" id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">        </span><span class="c1">// Validate magic numbers</span>
<a href="#__codelineno-21-10" id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">rbeg</span><span class="p">.</span><span class="n">begmagic</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">JREC_BEGMAGIC</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-21-11" id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ack</span><span class="p">.</span><span class="n">rend</span><span class="p">.</span><span class="n">endmagic</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">JREC_ENDMAGIC</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-21-12" id="__codelineno-21-12" name="__codelineno-21-12"></a>
<a href="#__codelineno-21-13" id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="w">        </span><span class="n">transid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ack</span><span class="p">.</span><span class="n">rbeg</span><span class="p">.</span><span class="n">transid</span><span class="p">;</span>
<a href="#__codelineno-21-14" id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-21-15" id="__codelineno-21-15" name="__codelineno-21-15"></a>
<a href="#__codelineno-21-16" id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="w">    </span><span class="c1">// Check for unacknowledged data</span>
<a href="#__codelineno-21-17" id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="w">    </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rindex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xindex</span><span class="p">;</span>
<a href="#__codelineno-21-18" id="__codelineno-21-18" name="__codelineno-21-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-19" id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="w">        </span><span class="c1">// Unsent data acknowledged - protocol error</span>
<a href="#__codelineno-21-20" id="__codelineno-21-20" name="__codelineno-21-20"></a><span class="w">        </span><span class="n">kprintf</span><span class="p">(</span><span class="s">"warning: unsent data acknowledged</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a href="#__codelineno-21-21" id="__codelineno-21-21" name="__codelineno-21-21"></a><span class="w">        </span><span class="n">transid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-21-22" id="__codelineno-21-22" name="__codelineno-21-22"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-21-23" id="__codelineno-21-23" name="__codelineno-21-23"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-21-24" id="__codelineno-21-24" name="__codelineno-21-24"></a>
<a href="#__codelineno-21-25" id="__codelineno-21-25" name="__codelineno-21-25"></a><span class="w">    </span><span class="c1">// Get record at xindex</span>
<a href="#__codelineno-21-26" id="__codelineno-21-26" name="__codelineno-21-26"></a><span class="w">    </span><span class="n">rawp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">membase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">xindex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span>
<a href="#__codelineno-21-27" id="__codelineno-21-27" name="__codelineno-21-27"></a>
<a href="#__codelineno-21-28" id="__codelineno-21-28" name="__codelineno-21-28"></a><span class="w">    </span><span class="c1">// Advance xindex for all records up to transid</span>
<a href="#__codelineno-21-29" id="__codelineno-21-29" name="__codelineno-21-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">transid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">transid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-30" id="__codelineno-21-30" name="__codelineno-21-30"></a><span class="w">        </span><span class="n">xindex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_recsize</span><span class="p">;</span>
<a href="#__codelineno-21-31" id="__codelineno-21-31" name="__codelineno-21-31"></a><span class="w">        </span><span class="n">total_acked</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_recsize</span><span class="p">;</span>
<a href="#__codelineno-21-32" id="__codelineno-21-32" name="__codelineno-21-32"></a><span class="w">        </span><span class="n">wakeup_waiters</span><span class="p">();</span>
<a href="#__codelineno-21-33" id="__codelineno-21-33" name="__codelineno-21-33"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-21-34" id="__codelineno-21-34" name="__codelineno-21-34"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-21-35" id="__codelineno-21-35" name="__codelineno-21-35"></a>
<a href="#__codelineno-21-36" id="__codelineno-21-36" name="__codelineno-21-36"></a><span class="w">    </span><span class="c1">// Found matching transid</span>
<a href="#__codelineno-21-37" id="__codelineno-21-37" name="__codelineno-21-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">transid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">transid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-38" id="__codelineno-21-38" name="__codelineno-21-38"></a><span class="w">        </span><span class="n">xindex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_recsize</span><span class="p">;</span>
<a href="#__codelineno-21-39" id="__codelineno-21-39" name="__codelineno-21-39"></a><span class="w">        </span><span class="n">total_acked</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_recsize</span><span class="p">;</span>
<a href="#__codelineno-21-40" id="__codelineno-21-40" name="__codelineno-21-40"></a><span class="w">        </span><span class="n">wakeup_waiters</span><span class="p">();</span>
<a href="#__codelineno-21-41" id="__codelineno-21-41" name="__codelineno-21-41"></a><span class="w">        </span><span class="n">transid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-21-42" id="__codelineno-21-42" name="__codelineno-21-42"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-21-43" id="__codelineno-21-43" name="__codelineno-21-43"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-21-44" id="__codelineno-21-44" name="__codelineno-21-44"></a>
<a href="#__codelineno-21-45" id="__codelineno-21-45" name="__codelineno-21-45"></a><span class="w">    </span><span class="c1">// Unsent data acknowledged - protocol error</span>
<a href="#__codelineno-21-46" id="__codelineno-21-46" name="__codelineno-21-46"></a><span class="w">    </span><span class="n">transid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-21-47" id="__codelineno-21-47" name="__codelineno-21-47"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Key aspects:</strong>
- Target can acknowledge multiple records at once
- Target sends back transaction IDs that are committed
- Advances xindex to free up FIFO space
- Wakes up threads waiting for space</p>
<h2 id="journal-vop-operations">Journal VOP Operations<a class="headerlink" href="#journal-vop-operations" title="Permanent link"></a></h2>
<p>The file <code>sys/kern/vfs_jops.c</code> implements journal-aware VOP operations that intercept filesystem operations to record them before passing through to the underlying filesystem.</p>
<h3 id="operation-interception">Operation Interception<a class="headerlink" href="#operation-interception" title="Permanent link"></a></h3>
<p>When journaling is enabled:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vop_ops</span><span class="w"> </span><span class="n">journal_vnode_vops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="p">.</span><span class="n">vop_default</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">vop_journal_operate_ap</span><span class="p">,</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">    </span><span class="p">.</span><span class="n">vop_setattr</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">journal_setattr</span><span class="p">,</span>
<a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">    </span><span class="p">.</span><span class="n">vop_write</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="n">journal_write</span><span class="p">,</span>
<a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">    </span><span class="p">.</span><span class="n">vop_fsync</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="n">journal_fsync</span><span class="p">,</span>
<a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="p">.</span><span class="n">vop_ncreate</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">journal_ncreate</span><span class="p">,</span>
<a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="p">.</span><span class="n">vop_nremove</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">journal_nremove</span><span class="p">,</span>
<a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="p">.</span><span class="n">vop_nrename</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">journal_nrename</span><span class="p">,</span>
<a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">    </span><span class="c1">// ... etc</span>
<a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="p">};</span>
</code></pre></div>
<p>Each intercepted operation follows this pattern:</p>
<ol>
<li><strong>Start journal record</strong></li>
<li><strong>Record UNDO information</strong> (if journaling is reversible)</li>
<li><strong>Call underlying VOP</strong></li>
<li><strong>Record REDO information</strong> (operation details)</li>
<li><strong>Commit journal record</strong></li>
<li><strong>Return result</strong></li>
</ol>
<h3 id="example-journal_write">Example: journal_write()<a class="headerlink" href="#example-journal_write" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_jops.c:400</code> (approximate).</p>
<p><strong>Simplified flow:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="nf">journal_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vop_write_args</span><span class="w"> </span><span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="p">{</span>
<a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_vp</span><span class="o">-&gt;</span><span class="n">v_mount</span><span class="p">;</span>
<a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">journal</span><span class="w"> </span><span class="o">*</span><span class="n">jo</span><span class="p">;</span>
<a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="n">jrec</span><span class="p">;</span>
<a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a>
<a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="c1">// For each journal on this mount</span>
<a href="#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">    </span><span class="n">TAILQ_FOREACH</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mnt_jlist</span><span class="p">,</span><span class="w"> </span><span class="n">jentry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">        </span><span class="c1">// Initialize journal record</span>
<a href="#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">        </span><span class="n">jrecord_init</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JTYPE_WRITE</span><span class="p">);</span>
<a href="#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a>
<a href="#__codelineno-23-14" id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">        </span><span class="c1">// Record UNDO data (old file contents) if reversible</span>
<a href="#__codelineno-23-15" id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MC_JOURNAL_WANT_REVERSIBLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-23-16" id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">            </span><span class="n">jrecord_undo_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_vp</span><span class="p">,</span><span class="w"> </span><span class="n">JRUNDO_FILEDATA</span><span class="p">,</span>
<a href="#__codelineno-23-17" id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="w">                            </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_uio</span><span class="o">-&gt;</span><span class="n">uio_offset</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-23-18" id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="w">                            </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_uio</span><span class="o">-&gt;</span><span class="n">uio_resid</span><span class="p">);</span>
<a href="#__codelineno-23-19" id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-23-20" id="__codelineno-23-20" name="__codelineno-23-20"></a>
<a href="#__codelineno-23-21" id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="w">        </span><span class="c1">// Record write operation details</span>
<a href="#__codelineno-23-22" id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">        </span><span class="n">jrecord_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_vp</span><span class="p">,</span><span class="w"> </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_uio</span><span class="p">,</span><span class="w"> </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_ioflag</span><span class="p">);</span>
<a href="#__codelineno-23-23" id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-23-24" id="__codelineno-23-24" name="__codelineno-23-24"></a>
<a href="#__codelineno-23-25" id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="w">    </span><span class="c1">// Call underlying filesystem VOP</span>
<a href="#__codelineno-23-26" id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vop_write_ap</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<a href="#__codelineno-23-27" id="__codelineno-23-27" name="__codelineno-23-27"></a>
<a href="#__codelineno-23-28" id="__codelineno-23-28" name="__codelineno-23-28"></a><span class="w">    </span><span class="c1">// Commit all journal records</span>
<a href="#__codelineno-23-29" id="__codelineno-23-29" name="__codelineno-23-29"></a><span class="w">    </span><span class="n">TAILQ_FOREACH</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mnt_jlist</span><span class="p">,</span><span class="w"> </span><span class="n">jentry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-23-30" id="__codelineno-23-30" name="__codelineno-23-30"></a><span class="w">        </span><span class="n">jrecord_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<a href="#__codelineno-23-31" id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-23-32" id="__codelineno-23-32" name="__codelineno-23-32"></a>
<a href="#__codelineno-23-33" id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-23-34" id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Key steps:</strong>
1. Loop through all journals on mount point (can have multiple)
2. Create <code>JTYPE_WRITE</code> stream record
3. Record UNDO if reversible (old file data)
4. Record REDO (write parameters + new data)
5. Perform actual write via underlying VOP
6. Commit journal records with result</p>
<h3 id="undo-recording">UNDO Recording<a class="headerlink" href="#undo-recording" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_jops.c:600</code> (approximate).</p>
<p><strong>Function:</strong> <code>jrecord_undo_file()</code></p>
<p>For reversible journals, UNDO information allows replaying backwards:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="nf">jrecord_undo_file</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="o">*</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">,</span>
<a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">                  </span><span class="kt">int</span><span class="w"> </span><span class="n">jrflags</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span>
<a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="p">{</span>
<a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vattr</span><span class="w"> </span><span class="n">vat</span><span class="p">;</span>
<a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uio</span><span class="w"> </span><span class="n">uio</span><span class="p">;</span>
<a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">    </span><span class="c1">// Start UNDO subrecord</span>
<a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">    </span><span class="n">jrecord_push</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JTYPE_UNDO</span><span class="p">);</span>
<a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a>
<a href="#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">    </span><span class="c1">// Record file attributes</span>
<a href="#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jrflags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">JRUNDO_VATTR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">        </span><span class="n">VOP_GETATTR</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vat</span><span class="p">);</span>
<a href="#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">        </span><span class="n">jrecord_write_vattr</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vat</span><span class="p">);</span>
<a href="#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a>
<a href="#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="w">    </span><span class="c1">// Record file data</span>
<a href="#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jrflags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">JRUNDO_FILEDATA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-24-19" id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="w">        </span><span class="c1">// Read old file contents</span>
<a href="#__codelineno-24-20" id="__codelineno-24-20" name="__codelineno-24-20"></a><span class="w">        </span><span class="n">uio</span><span class="p">.</span><span class="n">uio_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<a href="#__codelineno-24-21" id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="w">        </span><span class="n">uio</span><span class="p">.</span><span class="n">uio_resid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span>
<a href="#__codelineno-24-22" id="__codelineno-24-22" name="__codelineno-24-22"></a><span class="w">        </span><span class="n">VOP_READ</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uio</span><span class="p">,</span><span class="w"> </span><span class="n">IO_NODELOCKED</span><span class="p">,</span><span class="w"> </span><span class="n">cred</span><span class="p">);</span>
<a href="#__codelineno-24-23" id="__codelineno-24-23" name="__codelineno-24-23"></a>
<a href="#__codelineno-24-24" id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="w">        </span><span class="c1">// Write to journal</span>
<a href="#__codelineno-24-25" id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="w">        </span><span class="n">jrecord_write_uio</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uio</span><span class="p">);</span>
<a href="#__codelineno-24-26" id="__codelineno-24-26" name="__codelineno-24-26"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-24-27" id="__codelineno-24-27" name="__codelineno-24-27"></a>
<a href="#__codelineno-24-28" id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="w">    </span><span class="c1">// End UNDO subrecord</span>
<a href="#__codelineno-24-29" id="__codelineno-24-29" name="__codelineno-24-29"></a><span class="w">    </span><span class="n">jrecord_pop</span><span class="p">(</span><span class="n">jrec</span><span class="p">);</span>
<a href="#__codelineno-24-30" id="__codelineno-24-30" name="__codelineno-24-30"></a><span class="p">}</span>
</code></pre></div>
<p><strong>UNDO flags:</strong>
- <code>JRUNDO_SIZE</code> - File size
- <code>JRUNDO_UID/GID</code> - Ownership
- <code>JRUNDO_MODES</code> - Permissions
- <code>JRUNDO_MTIME/ATIME/CTIME</code> - Timestamps
- <code>JRUNDO_FILEDATA</code> - File contents
- <code>JRUNDO_NLINK</code> - Link count
- <code>JRUNDO_VATTR</code> - All vattr fields</p>
<h3 id="redo-recording">REDO Recording<a class="headerlink" href="#redo-recording" title="Permanent link"></a></h3>
<p>REDO information describes the operation being performed:</p>
<p><strong>For JTYPE_WRITE:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="n">jrecord_push</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JTYPE_WRITE</span><span class="p">);</span>
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="n">jrecord_leaf</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_PATH1</span><span class="p">,</span><span class="w"> </span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="n">pathlen</span><span class="p">);</span>
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="n">jrecord_leaf</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_FILEDATA</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">datalen</span><span class="p">);</span>
<a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="n">jrecord_leaf</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="n">jrecord_pop</span><span class="p">(</span><span class="n">jrec</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>For JTYPE_RENAME:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="n">jrecord_push</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JTYPE_RENAME</span><span class="p">);</span>
<a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="n">jrecord_push</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JTYPE_UNDO</span><span class="p">);</span>
<a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="n">jrecord_leaf</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_PATH1</span><span class="p">,</span><span class="w"> </span><span class="n">oldpath</span><span class="p">,</span><span class="w"> </span><span class="n">oldlen</span><span class="p">);</span>
<a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="n">jrecord_pop</span><span class="p">(</span><span class="n">jrec</span><span class="p">);</span>
<a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="n">jrecord_leaf</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_PATH1</span><span class="p">,</span><span class="w"> </span><span class="n">oldpath</span><span class="p">,</span><span class="w"> </span><span class="n">oldlen</span><span class="p">);</span>
<a href="#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="n">jrecord_leaf</span><span class="p">(</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_PATH2</span><span class="p">,</span><span class="w"> </span><span class="n">newpath</span><span class="p">,</span><span class="w"> </span><span class="n">newlen</span><span class="p">);</span>
<a href="#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="n">jrecord_pop</span><span class="p">(</span><span class="n">jrec</span><span class="p">);</span>
</code></pre></div></p>
<h2 id="journal-management">Journal Management<a class="headerlink" href="#journal-management" title="Permanent link"></a></h2>
<h3 id="installing-a-journal">Installing a Journal<a class="headerlink" href="#installing-a-journal" title="Permanent link"></a></h3>
<p>Located at <code>sys/kern/vfs_jops.c:250</code> (approximate).</p>
<p><strong>Function:</strong> <code>journal_install_vfs_journal()</code></p>
<p>Journals are installed via <code>mountctl()</code> system call:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nf">journal_install_vfs_journal</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">fp</span><span class="p">,</span>
<a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mountctl_install_journal</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span>
<a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="p">{</span>
<a href="#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">journal</span><span class="w"> </span><span class="o">*</span><span class="n">jo</span><span class="p">;</span>
<a href="#__codelineno-27-6" id="__codelineno-27-6" name="__codelineno-27-6"></a>
<a href="#__codelineno-27-7" id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">    </span><span class="c1">// Check for duplicate journal ID</span>
<a href="#__codelineno-27-8" id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">    </span><span class="n">TAILQ_FOREACH</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mnt_jlist</span><span class="p">,</span><span class="w"> </span><span class="n">jentry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-27-9" id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-27-10" id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">EALREADY</span><span class="p">;</span>
<a href="#__codelineno-27-11" id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-27-12" id="__codelineno-27-12" name="__codelineno-27-12"></a>
<a href="#__codelineno-27-13" id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">    </span><span class="c1">// Allocate journal structure</span>
<a href="#__codelineno-27-14" id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">    </span><span class="n">jo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">jo</span><span class="p">),</span><span class="w"> </span><span class="n">M_JOURNAL</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">M_ZERO</span><span class="p">);</span>
<a href="#__codelineno-27-15" id="__codelineno-27-15" name="__codelineno-27-15"></a>
<a href="#__codelineno-27-16" id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">    </span><span class="c1">// Initialize fields</span>
<a href="#__codelineno-27-17" id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">    </span><span class="n">strlcpy</span><span class="p">(</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
<a href="#__codelineno-27-18" id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fp</span><span class="p">;</span><span class="w">  </span><span class="c1">// File/socket to write journal to</span>
<a href="#__codelineno-27-19" id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
<a href="#__codelineno-27-20" id="__codelineno-27-20" name="__codelineno-27-20"></a>
<a href="#__codelineno-27-21" id="__codelineno-27-21" name="__codelineno-27-21"></a><span class="w">    </span><span class="c1">// Allocate memory FIFO</span>
<a href="#__codelineno-27-22" id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">;</span>
<a href="#__codelineno-27-23" id="__codelineno-27-23" name="__codelineno-27-23"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a href="#__codelineno-27-24" id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">membase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_JFIFO</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a href="#__codelineno-27-25" id="__codelineno-27-25" name="__codelineno-27-25"></a>
<a href="#__codelineno-27-26" id="__codelineno-27-26" name="__codelineno-27-26"></a><span class="w">    </span><span class="c1">// Initialize indices</span>
<a href="#__codelineno-27-27" id="__codelineno-27-27" name="__codelineno-27-27"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">windex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-27-28" id="__codelineno-27-28" name="__codelineno-27-28"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">rindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-27-29" id="__codelineno-27-29" name="__codelineno-27-29"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">xindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-27-30" id="__codelineno-27-30" name="__codelineno-27-30"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">transid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a href="#__codelineno-27-31" id="__codelineno-27-31" name="__codelineno-27-31"></a>
<a href="#__codelineno-27-32" id="__codelineno-27-32" name="__codelineno-27-32"></a><span class="w">    </span><span class="c1">// Create worker threads</span>
<a href="#__codelineno-27-33" id="__codelineno-27-33" name="__codelineno-27-33"></a><span class="w">    </span><span class="n">journal_create_threads</span><span class="p">(</span><span class="n">jo</span><span class="p">);</span>
<a href="#__codelineno-27-34" id="__codelineno-27-34" name="__codelineno-27-34"></a>
<a href="#__codelineno-27-35" id="__codelineno-27-35" name="__codelineno-27-35"></a><span class="w">    </span><span class="c1">// Add to mount point's journal list</span>
<a href="#__codelineno-27-36" id="__codelineno-27-36" name="__codelineno-27-36"></a><span class="w">    </span><span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mnt_jlist</span><span class="p">,</span><span class="w"> </span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="n">jentry</span><span class="p">);</span>
<a href="#__codelineno-27-37" id="__codelineno-27-37" name="__codelineno-27-37"></a>
<a href="#__codelineno-27-38" id="__codelineno-27-38" name="__codelineno-27-38"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-27-39" id="__codelineno-27-39" name="__codelineno-27-39"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Installation flags:</strong>
- <code>MC_JOURNAL_WANT_AUDIT</code> - Audit trail mode
- <code>MC_JOURNAL_WANT_REVERSIBLE</code> - Record UNDO information
- <code>MC_JOURNAL_WANT_FULLDUPLEX</code> - Two-way acknowledgement</p>
<h3 id="journal-lifecycle">Journal Lifecycle<a class="headerlink" href="#journal-lifecycle" title="Permanent link"></a></h3>
<p><strong>Attach:</strong> <code>journal_attach(mp)</code>
- Switches mount point's vnops to <code>journal_vnode_vops</code>
- Sets <code>mp-&gt;mnt_vn_journal_ops</code></p>
<p><strong>Install:</strong> <code>journal_install_vfs_journal()</code>
- Creates journal structure
- Allocates FIFO
- Starts worker threads
- Adds to <code>mp-&gt;mnt_jlist</code></p>
<p><strong>Operate:</strong> Normal VFS operations are intercepted and journaled</p>
<p><strong>Detach:</strong> <code>journal_detach(mp)</code>
- Stops worker threads
- Flushes FIFO
- Frees resources
- Restores normal vnops</p>
<h2 id="transaction-structure">Transaction Structure<a class="headerlink" href="#transaction-structure" title="Permanent link"></a></h2>
<h3 id="nested-subrecords">Nested Subrecords<a class="headerlink" href="#nested-subrecords" title="Permanent link"></a></h3>
<p>Journal records use nested subrecord structure:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a>Stream Record (JTYPE_RENAME)
<a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a> JTYPE_UNDO (nested)
<a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a>   JLEAF_PATH1 (old source path) [leaf]
<a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a>   JLEAF_PATH2 (old dest path if exists) [leaf, LAST]
<a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a> JLEAF_PATH1 (source path) [leaf]
<a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a> JLEAF_PATH2 (destination path) [leaf, LAST]
</code></pre></div>
<p><strong>Subrecord traversal:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">traverse_subrecords</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">journal_subrecord</span><span class="w"> </span><span class="o">*</span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a>
<a href="#__codelineno-29-4" id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">sub</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-5" id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">rectype</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">JMASK_NESTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-6" id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">            </span><span class="c1">// Recurse into nested subrecord</span>
<a href="#__codelineno-29-7" id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">            </span><span class="n">traverse_subrecords</span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a href="#__codelineno-29-8" id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-9" id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">            </span><span class="c1">// Process leaf subrecord</span>
<a href="#__codelineno-29-10" id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="w">            </span><span class="n">process_leaf</span><span class="p">(</span><span class="n">sub</span><span class="p">);</span>
<a href="#__codelineno-29-11" id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-29-12" id="__codelineno-29-12" name="__codelineno-29-12"></a>
<a href="#__codelineno-29-13" id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="w">        </span><span class="c1">// Check for last subrecord</span>
<a href="#__codelineno-29-14" id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">rectype</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">JMASK_LAST</span><span class="p">)</span>
<a href="#__codelineno-29-15" id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-29-16" id="__codelineno-29-16" name="__codelineno-29-16"></a>
<a href="#__codelineno-29-17" id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="w">        </span><span class="c1">// Advance to next subrecord</span>
<a href="#__codelineno-29-18" id="__codelineno-29-18" name="__codelineno-29-18"></a><span class="w">        </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">sub</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="p">;</span>
<a href="#__codelineno-29-19" id="__codelineno-29-19" name="__codelineno-29-19"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-29-20" id="__codelineno-29-20" name="__codelineno-29-20"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="jrecord-api">jrecord API<a class="headerlink" href="#jrecord-api" title="Permanent link"></a></h3>
<p>High-level API for building journal records:</p>
<p><strong>Initialize:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">jrecord_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">journal</span><span class="w"> </span><span class="o">*</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="o">*</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">                  </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">streamid</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Push/pop nested subrecords:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">jrecord_push</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="o">*</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">rectype</span><span class="p">);</span>
<a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">jrecord_pop</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="o">*</span><span class="n">jrec</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Write leaf data:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">jrecord_leaf</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="o">*</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">rectype</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">                  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<a href="#__codelineno-32-3" id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">jrecord_data</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="o">*</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dtype</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Commit:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">jrecord_done</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="o">*</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Example usage:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">jrecord</span><span class="w"> </span><span class="n">jrec</span><span class="p">;</span>
<a href="#__codelineno-34-2" id="__codelineno-34-2" name="__codelineno-34-2"></a>
<a href="#__codelineno-34-3" id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="n">jrecord_init</span><span class="p">(</span><span class="n">jo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JTYPE_WRITE</span><span class="p">);</span>
<a href="#__codelineno-34-4" id="__codelineno-34-4" name="__codelineno-34-4"></a>
<a href="#__codelineno-34-5" id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="n">jrecord_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JTYPE_UNDO</span><span class="p">);</span>
<a href="#__codelineno-34-6" id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w">    </span><span class="n">jrecord_leaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_FILEDATA</span><span class="p">,</span><span class="w"> </span><span class="n">oldbuf</span><span class="p">,</span><span class="w"> </span><span class="n">oldsize</span><span class="p">);</span>
<a href="#__codelineno-34-7" id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="n">jrecord_pop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">);</span>
<a href="#__codelineno-34-8" id="__codelineno-34-8" name="__codelineno-34-8"></a>
<a href="#__codelineno-34-9" id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="n">jrecord_leaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_PATH1</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">pathlen</span><span class="p">);</span>
<a href="#__codelineno-34-10" id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="n">jrecord_leaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">JLEAF_FILEDATA</span><span class="p">,</span><span class="w"> </span><span class="n">newbuf</span><span class="p">,</span><span class="w"> </span><span class="n">newsize</span><span class="p">);</span>
<a href="#__codelineno-34-11" id="__codelineno-34-11" name="__codelineno-34-11"></a>
<a href="#__codelineno-34-12" id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="n">jrecord_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
</code></pre></div></p>
<h2 id="synchronization-and-locking">Synchronization and Locking<a class="headerlink" href="#synchronization-and-locking" title="Permanent link"></a></h2>
<h3 id="fifo-concurrency">FIFO Concurrency<a class="headerlink" href="#fifo-concurrency" title="Permanent link"></a></h3>
<p>The memory FIFO supports concurrent operations:</p>
<p><strong>Multiple writers:</strong> 
- Each thread reserves its own space via <code>journal_reserve()</code>
- Incomplete magic blocks worker thread from writing past incomplete records
- Records can be completed out-of-order
- Worker thread writes in reservation order</p>
<p><strong>Single writer thread:</strong>
- One worker thread per journal
- Reads from FIFO via rindex
- Blocks on incomplete records</p>
<p><strong>Acknowledgement:</strong>
- Single reader thread (full-duplex only)
- Advances xindex based on acknowledgements
- Frees up FIFO space</p>
<p><strong>Wait conditions:</strong>
- Writers wait on <code>&amp;jo-&gt;fifo.windex</code> when FIFO full (<code>MC_JOURNAL_WWAIT</code>)
- Worker wakes writers when space available
- Worker waits on <code>&amp;jo-&gt;fifo</code> when nothing to write</p>
<h3 id="memory-barriers">Memory Barriers<a class="headerlink" href="#memory-barriers" title="Permanent link"></a></h3>
<p>Critical use of memory barriers for correctness:</p>
<p><strong>Reserve:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="c1">// Initialize record header and trailer</span>
<a href="#__codelineno-35-2" id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">begmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_INCOMPLETEMAGIC</span><span class="p">;</span>
<a href="#__codelineno-35-3" id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span>
<a href="#__codelineno-35-4" id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="c1">// ... fill in fields ...</span>
<a href="#__codelineno-35-5" id="__codelineno-35-5" name="__codelineno-35-5"></a>
<a href="#__codelineno-35-6" id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="n">cpu_sfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// Ensure writes complete before advancing windex</span>
<a href="#__codelineno-35-7" id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">windex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aligned_bytes</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>Commit:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="c1">// Fill in trailer</span>
<a href="#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="n">rendp</span><span class="o">-&gt;</span><span class="n">endmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_ENDMAGIC</span><span class="p">;</span>
<a href="#__codelineno-36-3" id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="n">rendp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="p">;</span>
<a href="#__codelineno-36-4" id="__codelineno-36-4" name="__codelineno-36-4"></a>
<a href="#__codelineno-36-5" id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="n">cpu_sfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// Ensure trailer written before magic</span>
<a href="#__codelineno-36-6" id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">begmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_BEGMAGIC</span><span class="p">;</span><span class="w">  </span><span class="c1">// Make visible to worker</span>
</code></pre></div></p>
<p><strong>Pad record:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">streamid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_STREAMID_PAD</span><span class="p">;</span>
<a href="#__codelineno-37-2" id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">recsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recsize</span><span class="p">;</span>
<a href="#__codelineno-37-3" id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="n">rendp</span><span class="o">-&gt;</span><span class="n">endmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_ENDMAGIC</span><span class="p">;</span>
<a href="#__codelineno-37-4" id="__codelineno-37-4" name="__codelineno-37-4"></a>
<a href="#__codelineno-37-5" id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="n">cpu_sfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// Ensure complete before making visible</span>
<a href="#__codelineno-37-6" id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">begmagic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JREC_BEGMAGIC</span><span class="p">;</span>
</code></pre></div></p>
<p>These barriers prevent:
- Worker thread seeing incomplete records
- Reordered writes corrupting record structure
- CPU/compiler optimization breaking protocol</p>
<h2 id="journal-targets">Journal Targets<a class="headerlink" href="#journal-targets" title="Permanent link"></a></h2>
<h3 id="filesocket-support">File/Socket Support<a class="headerlink" href="#filesocket-support" title="Permanent link"></a></h3>
<p>Journals can write to:</p>
<p><strong>Regular files:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-38-1" id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="n">fp_write</span><span class="p">(</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">written</span><span class="p">,</span><span class="w"> </span><span class="n">UIO_SYSSPACE</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Sockets (network journaling):</strong>
- TCP sockets for remote replication
- Can span network boundaries
- Two-way acknowledgement over socket</p>
<p><strong>Special devices:</strong>
- Raw disk partitions for fast local journaling
- Block devices</p>
<h3 id="full-duplex-journaling">Full-Duplex Journaling<a class="headerlink" href="#full-duplex-journaling" title="Permanent link"></a></h3>
<p>For two-way acknowledgement:</p>
<p><strong>Setup:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-39-1" id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">MC_JOURNAL_WANT_FULLDUPLEX</span><span class="p">;</span>
<a href="#__codelineno-39-2" id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="n">journal_install_vfs_journal</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Operation:</strong>
- Write worker sends journal records
- Read worker receives acknowledgements
- Target must implement ack protocol
- xindex only advances on ack receipt</p>
<p><strong>Acknowledgement record format:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-40-1" id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">journal_ackrecord</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-40-2" id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">journal_rawrecbeg</span><span class="w"> </span><span class="n">rbeg</span><span class="p">;</span>
<a href="#__codelineno-40-3" id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">filler0</span><span class="p">;</span>
<a href="#__codelineno-40-4" id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">filler1</span><span class="p">;</span>
<a href="#__codelineno-40-5" id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">journal_rawrecend</span><span class="w"> </span><span class="n">rend</span><span class="p">;</span>
<a href="#__codelineno-40-6" id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="p">};</span>
</code></pre></div></p>
<p>Target sends back transaction ID when committed to stable storage.</p>
<h3 id="restart-and-resync">Restart and Resync<a class="headerlink" href="#restart-and-resync" title="Permanent link"></a></h3>
<p>Journals support interruption and restart:</p>
<p><strong>Restart marker:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-41-1" id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="n">JREC_STREAMID_RESTART</span><span class="w">  </span><span class="c1">// Marks journal restart after interruption</span>
</code></pre></div></p>
<p><strong>Resync operation:</strong>
- Target can request resync to transaction ID
- Journal fast-forwards xindex
- Allows recovery after link interruption</p>
<p><strong>Use cases:</strong>
- Network failure recovery
- Target system restart
- Catching up after outage</p>
<h2 id="performance-considerations">Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permanent link"></a></h2>
<h3 id="fifo-sizing">FIFO Sizing<a class="headerlink" href="#fifo-sizing" title="Permanent link"></a></h3>
<p>FIFO size affects performance and stall behavior:</p>
<p><strong>Too small:</strong>
- Frequent stalls waiting for space
- <code>fifostalls</code> counter increments
- Threads block in <code>journal_reserve()</code></p>
<p><strong>Too large:</strong>
- Memory overhead
- Longer recovery window on restart
- Delayed error detection</p>
<p><strong>Recommended:</strong>
- 1-4 MB for local journaling
- 8-32 MB for network journaling
- Power of 2 for efficient masking</p>
<h3 id="batching-efficiency">Batching Efficiency<a class="headerlink" href="#batching-efficiency" title="Permanent link"></a></h3>
<p>Worker thread batching reduces overhead:</p>
<p><strong>Wakeup policy:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-42-1" id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fifo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">50</span><span class="o">%</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">waiters_present</span><span class="p">)</span>
<a href="#__codelineno-42-2" id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="w">    </span><span class="n">wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Benefits:</strong>
- Amortizes thread switch overhead
- Better CPU cache utilization
- Reduces syscall/write overhead
- Batches related operations</p>
<p><strong>Heartbeat:</strong>
- Worker wakes periodically (HZ)
- Flushes small amounts of data
- Prevents indefinite delay</p>
<h3 id="zero-copy-optimization">Zero-Copy Optimization<a class="headerlink" href="#zero-copy-optimization" title="Permanent link"></a></h3>
<p>Journal records are built directly in FIFO:</p>
<ol>
<li>Reserve space in FIFO</li>
<li>Write data directly to reserved space</li>
<li>Commit when complete</li>
<li>Worker writes directly from FIFO to target</li>
</ol>
<p>No intermediate buffering or copying required.</p>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link"></a></h2>
<h3 id="filesystem-operation-errors">Filesystem Operation Errors<a class="headerlink" href="#filesystem-operation-errors" title="Permanent link"></a></h3>
<p>If underlying VOP fails:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-43-1" id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vop_write_ap</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<a href="#__codelineno-43-2" id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="n">jrecord_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jrec</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span><span class="w">  </span><span class="c1">// Records error in journal</span>
</code></pre></div>
<p>Journal records operation and result, even on failure.</p>
<h3 id="journal-write-errors">Journal Write Errors<a class="headerlink" href="#journal-write-errors" title="Permanent link"></a></h3>
<p>If worker thread encounters write error:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-44-1" id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fp_write</span><span class="p">(</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
<a href="#__codelineno-44-2" id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-44-3" id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">"journal_thread(%s) write, error %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<a href="#__codelineno-44-4" id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w">    </span><span class="c1">// XXX: Error policy TBD</span>
<a href="#__codelineno-44-5" id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="w">    </span><span class="c1">// Options: pause, abort, mark journal failed</span>
<a href="#__codelineno-44-6" id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Current behavior:</strong> Log error and continue
<strong>Future:</strong> Configurable error policies</p>
<h3 id="fifo-overflow">FIFO Overflow<a class="headerlink" href="#fifo-overflow" title="Permanent link"></a></h3>
<p>When FIFO fills up:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-45-1" id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fifo_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">windex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xindex</span><span class="p">);</span>
<a href="#__codelineno-45-2" id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avail</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">required</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-45-3" id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">    </span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">MC_JOURNAL_WWAIT</span><span class="p">;</span>
<a href="#__codelineno-45-4" id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="o">++</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifostalls</span><span class="p">;</span>
<a href="#__codelineno-45-5" id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="w">    </span><span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">windex</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"jwrite"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-45-6" id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Blocking behavior:</strong>
- Thread sleeps until space available
- Worker thread wakes waiters
- <code>fifostalls</code> tracks frequency</p>
<p><strong>Implications:</strong>
- Filesystem operations block
- System slows to journal speed
- Prevents memory exhaustion</p>
<h2 id="use-cases">Use Cases<a class="headerlink" href="#use-cases" title="Permanent link"></a></h2>
<h3 id="replication">Replication<a class="headerlink" href="#replication" title="Permanent link"></a></h3>
<p>Stream filesystem changes to remote system:</p>
<ol>
<li>Install journal with socket to remote host</li>
<li>All filesystem operations recorded</li>
<li>Remote system applies changes</li>
<li>Full-duplex acks ensure durability</li>
</ol>
<p><strong>Benefits:</strong>
- Near real-time replication
- Crash recovery via replay
- Bandwidth efficient (operation-level)</p>
<h3 id="auditing">Auditing<a class="headerlink" href="#auditing" title="Permanent link"></a></h3>
<p>Record all filesystem access:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-46-1" id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MC_JOURNAL_WANT_AUDIT</span><span class="p">;</span>
</code></pre></div>
<p><strong>Captures:</strong>
- All file creates/deletes
- All writes and modifications
- User credentials
- Timestamps
- Process information</p>
<p><strong>Use:</strong> Security auditing, compliance</p>
<h3 id="reversible-journaling">Reversible Journaling<a class="headerlink" href="#reversible-journaling" title="Permanent link"></a></h3>
<p>Enable undo capability:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-47-1" id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MC_JOURNAL_WANT_REVERSIBLE</span><span class="p">;</span>
</code></pre></div>
<p><strong>Records:</strong>
- UNDO information (old data)
- REDO information (new data)
- Complete state for rollback</p>
<p><strong>Use:</strong> Snapshot-like functionality, experimental</p>
<h3 id="local-fast-journal">Local Fast Journal<a class="headerlink" href="#local-fast-journal" title="Permanent link"></a></h3>
<p>For crash recovery:</p>
<ol>
<li>Journal to fast SSD/NVMe</li>
<li>Async write to slower main storage</li>
<li>Replay journal on crash</li>
<li>Discard journal when committed</li>
</ol>
<p><strong>Benefits:</strong>
- Fast write acknowledgement
- Large write coalescing
- Crash consistency</p>
<h2 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link"></a></h2>
<h3 id="statistics">Statistics<a class="headerlink" href="#statistics" title="Permanent link"></a></h3>
<p>Each journal maintains statistics:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-48-1" id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">journal</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-48-2" id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">total_acked</span><span class="p">;</span><span class="w">    </span><span class="c1">// Total bytes acknowledged</span>
<a href="#__codelineno-48-3" id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fifostalls</span><span class="p">;</span><span class="w">         </span><span class="c1">// FIFO full stall count</span>
<a href="#__codelineno-48-4" id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w">    </span><span class="c1">// ...</span>
<a href="#__codelineno-48-5" id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Access via mountctl:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-49-1" id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="n">MOUNTCTL_STATUS_VFS_JOURNAL</span>
</code></pre></div></p>
<h3 id="tracing">Tracing<a class="headerlink" href="#tracing" title="Permanent link"></a></h3>
<p>Enable debugging output:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-50-1" id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="cp">#if 1</span>
<a href="#__codelineno-50-2" id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">"ackskip %08llx/%08llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">rawp</span><span class="o">-&gt;</span><span class="n">transid</span><span class="p">,</span><span class="w"> </span><span class="n">transid</span><span class="p">);</span>
<a href="#__codelineno-50-3" id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="cp">#endif</span>
</code></pre></div>
<p><strong>Traces:</strong>
- Acknowledgement processing
- Record sequencing
- Error conditions</p>
<h3 id="common-issues">Common Issues<a class="headerlink" href="#common-issues" title="Permanent link"></a></h3>
<p><strong>FIFO stalls:</strong>
- <code>fifostalls</code> counter high
- Increase FIFO size
- Check target write performance</p>
<p><strong>Incomplete record hangs:</strong>
- Thread crashed while populating record
- Incomplete magic left in FIFO
- Worker thread blocked forever
- Solution: Timeout + recovery logic (TBD)</p>
<p><strong>Acknowledgement protocol errors:</strong>
- "warning: unsent data acknowledged"
- Target acknowledging wrong transid
- Check target implementation</p>
<h2 id="limitations-and-future-work">Limitations and Future Work<a class="headerlink" href="#limitations-and-future-work" title="Permanent link"></a></h2>
<h3 id="current-limitations">Current Limitations<a class="headerlink" href="#current-limitations" title="Permanent link"></a></h3>
<ol>
<li><strong>MPLOCK dependency:</strong></li>
<li>Worker threads still use MPLOCK</li>
<li>
<p>Not fully SMP-optimized</p>
</li>
<li>
<p><strong>Error handling:</strong></p>
</li>
<li>Limited error policies</li>
<li>
<p>No automatic journal failure handling</p>
</li>
<li>
<p><strong>Checksum disabled:</strong></p>
</li>
<li><code>check</code> field in records unused</li>
<li>
<p>No data integrity verification</p>
</li>
<li>
<p><strong>No encryption:</strong></p>
</li>
<li>All data in clear text</li>
<li>Security via transport layer only</li>
</ol>
<h3 id="planned-enhancements">Planned Enhancements<a class="headerlink" href="#planned-enhancements" title="Permanent link"></a></h3>
<p>From <code>vfs_journal.c:35-60</code> comments:</p>
<ol>
<li><strong>Two-way acknowledgement:</strong></li>
<li>Transaction ID acknowledgement (partially implemented)</li>
<li>Explicit and implicit ack schemes</li>
<li>Resynchronization support</li>
<li>
<p>Restart after interruption</p>
</li>
<li>
<p><strong>Swap space spooling:</strong></p>
</li>
<li>Use swap to absorb long interruptions</li>
<li>Prevent slow links from blocking local ops</li>
<li>
<p>Larger buffer capacity</p>
</li>
<li>
<p><strong>Per-CPU FIFOs:</strong></p>
</li>
<li>Remove locking requirements</li>
<li>Better SMP scalability</li>
<li>
<p>Reduce contention</p>
</li>
<li>
<p><strong>Filesystem integration:</strong></p>
</li>
<li>Allow filesystems to use journal layer directly</li>
<li>Avoid rolling their own journaling</li>
<li>Leverage kernel infrastructure</li>
</ol>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link"></a></h2>
<p>The VFS journaling system provides a sophisticated infrastructure for recording filesystem operations. Key aspects:</p>
<p><strong>Architecture:</strong>
- Interception layer between VOP wrappers and filesystem
- Memory FIFO batches records before writing
- Asynchronous worker threads for write-out
- Optional two-way acknowledgement</p>
<p><strong>Record structure:</strong>
- Stream records with headers/trailers
- Nested subrecord hierarchy
- Transaction IDs for sequencing
- Extensible operation types</p>
<p><strong>Concurrency:</strong>
- Lock-free reservation with incomplete magic
- Multiple writers, single worker thread
- Memory barriers for correctness
- Wait/wakeup for flow control</p>
<p><strong>Features:</strong>
- Multiple journals per mount point
- Full-duplex acknowledgement
- Reversible journals (UNDO)
- Network and local targets</p>
<p><strong>Use cases:</strong>
- Replication to remote systems
- Security auditing trails
- Crash recovery journals
- Experimental undo functionality</p>
<p>The journaling system is mature but retains areas for optimization, particularly in SMP scalability and error handling sophistication.</p>
<p><strong>Related documentation:</strong>
- <a href="../vfs-operations/">VFS Operations</a> - VOP dispatch mechanism
- <a href="../buffer-cache/">Buffer Cache</a> - Block I/O infrastructure
- <a href="../mounting/">Mounting</a> - Mount point management</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>