
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive documentation for the DragonFly BSD kernel source code">
      
      
        <meta name="author" content="DragonFly BSD Community">
      
      
      
        <link rel="prev" href="../mounting/">
      
      
        <link rel="next" href="../vfs-operations/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Buffer Cache & I/O - DragonFly BSD Kernel Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vfs-buffer-cache-and-io" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Buffer Cache & I/O
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../" class="md-tabs__link">
          
  
  
  Kernel Subsystems

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DragonFly BSD Kernel Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lwkt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../synchronization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../time/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Time & Timers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Initialization & Bootstrap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processes & Threads
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Resources & Credentials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../signals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_11" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../namecache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Name Lookup & Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mounting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mounting & Unmounting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Buffer Cache & I/O
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Buffer Cache & I/O
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Structure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-buf" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct buf
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bio-layer-fields" class="md-nav__link">
    <span class="md-ellipsis">
      
        BIO Layer Fields
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-flags-b_flags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Flags (b_flags)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-commands-buf_cmd_t" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Commands (buf_cmd_t)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-queues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Queues
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Queues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#per-cpu-queue-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Queue Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-lifecycle-through-queues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Lifecycle Through Queues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-cache-tuning-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Cache Tuning Parameters
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Cache Tuning Parameters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sysctl-tunables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysctl Tunables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-daemon-threads" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Daemon Threads
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Allocation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getnewbuf-core-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        getnewbuf() - Core Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getblk-cached-block-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        getblk() - Cached Block Access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-io-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer I/O Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer I/O Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bread-synchronous-read" class="md-nav__link">
    <span class="md-ellipsis">
      
        bread() - Synchronous Read
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breadn-read-with-read-ahead" class="md-nav__link">
    <span class="md-ellipsis">
      
        breadn() - Read with Read-ahead
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bwrite-synchronous-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        bwrite() - Synchronous Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bawrite-asynchronous-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        bawrite() - Asynchronous Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bdwrite-delayed-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        bdwrite() - Delayed Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bdirty-mark-buffer-dirty" class="md-nav__link">
    <span class="md-ellipsis">
      
        bdirty() - Mark Buffer Dirty
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buwrite-fake-write-tmpfs" class="md-nav__link">
    <span class="md-ellipsis">
      
        buwrite() - Fake Write (tmpfs)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Release
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Release">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#brelse-standard-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        brelse() - Standard Release
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bqrelse-quick-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        bqrelse() - Quick Release
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vm-integration-vmio" class="md-nav__link">
    <span class="md-ellipsis">
      
        VM Integration (VMIO)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VM Integration (VMIO)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vmio-buffers" class="md-nav__link">
    <span class="md-ellipsis">
      
        VMIO Buffers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_vmio_alloc-allocate-vm-pages" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_vmio_alloc() - Allocate VM Pages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_bio_clrbuf-clear-buffer" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_bio_clrbuf() - Clear Buffer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_busy_pages-vfs_unbusy_pages" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_busy_pages() / vfs_unbusy_pages()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_vmio_release-release-vm-pages" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_vmio_release() - Release VM Pages
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster I/O
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cluster I/O">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster Cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_read-clustered-read" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_read() - Clustered Read
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_rbuild-build-read-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_rbuild() - Build Read Cluster
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_write-clustered-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_write() - Clustered Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_awrite-asynchronous-cluster-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_awrite() - Asynchronous Cluster Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sequential-access-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sequential Access Detection
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bio-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        BIO Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BIO Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bio-layer-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        BIO Layer Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bio-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bio Callbacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bio-stacking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bio Stacking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-flushing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Flushing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Flushing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buf_daemon-main-flush-thread" class="md-nav__link">
    <span class="md-ellipsis">
      
        buf_daemon() - Main Flush Thread
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flushbufqueues-queue-flusher" class="md-nav__link">
    <span class="md-ellipsis">
      
        flushbufqueues() - Queue Flusher
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_sync-filesystem-sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        VFS_SYNC - Filesystem Sync
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#page-cleaning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Cleaning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page Cleaning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vfs_clean_pages-mark-pages-clean" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_clean_pages() - Mark Pages Clean
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#page-validity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Validity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kvabio-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        KVABIO API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="KVABIO API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvabio-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        KVABIO Functions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buffer-cache-sizing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Cache Sizing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-buffer-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dirty Buffer Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-ahead-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Read-ahead Tuning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-clustering" class="md-nav__link">
    <span class="md-ellipsis">
      
        Write Clustering
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        I/O Errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retry Strategies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buffer-state-inspection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer State Inspection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Issues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs-operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../journaling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs-locking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vnode Locking & Lifecycle
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs-extensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VFS Extensions & Helpers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2_12" >
        
          
          <label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    IPC & Sockets
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    IPC & Sockets
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ipc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ipc/mbufs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Devices & Drivers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../syscalls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cpu/x86_64/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Structure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-buf" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct buf
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bio-layer-fields" class="md-nav__link">
    <span class="md-ellipsis">
      
        BIO Layer Fields
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-flags-b_flags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Flags (b_flags)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-commands-buf_cmd_t" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Commands (buf_cmd_t)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-queues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Queues
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Queues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#per-cpu-queue-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Queue Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-lifecycle-through-queues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Lifecycle Through Queues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-cache-tuning-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Cache Tuning Parameters
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Cache Tuning Parameters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sysctl-tunables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sysctl Tunables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-daemon-threads" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Daemon Threads
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Allocation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getnewbuf-core-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        getnewbuf() - Core Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getblk-cached-block-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        getblk() - Cached Block Access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-io-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer I/O Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer I/O Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bread-synchronous-read" class="md-nav__link">
    <span class="md-ellipsis">
      
        bread() - Synchronous Read
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breadn-read-with-read-ahead" class="md-nav__link">
    <span class="md-ellipsis">
      
        breadn() - Read with Read-ahead
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bwrite-synchronous-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        bwrite() - Synchronous Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bawrite-asynchronous-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        bawrite() - Asynchronous Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bdwrite-delayed-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        bdwrite() - Delayed Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bdirty-mark-buffer-dirty" class="md-nav__link">
    <span class="md-ellipsis">
      
        bdirty() - Mark Buffer Dirty
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buwrite-fake-write-tmpfs" class="md-nav__link">
    <span class="md-ellipsis">
      
        buwrite() - Fake Write (tmpfs)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Release
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Release">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#brelse-standard-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        brelse() - Standard Release
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bqrelse-quick-release" class="md-nav__link">
    <span class="md-ellipsis">
      
        bqrelse() - Quick Release
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vm-integration-vmio" class="md-nav__link">
    <span class="md-ellipsis">
      
        VM Integration (VMIO)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VM Integration (VMIO)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vmio-buffers" class="md-nav__link">
    <span class="md-ellipsis">
      
        VMIO Buffers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_vmio_alloc-allocate-vm-pages" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_vmio_alloc() - Allocate VM Pages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_bio_clrbuf-clear-buffer" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_bio_clrbuf() - Clear Buffer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_busy_pages-vfs_unbusy_pages" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_busy_pages() / vfs_unbusy_pages()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_vmio_release-release-vm-pages" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_vmio_release() - Release VM Pages
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster I/O
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cluster I/O">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster Cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_read-clustered-read" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_read() - Clustered Read
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_rbuild-build-read-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_rbuild() - Build Read Cluster
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_write-clustered-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_write() - Clustered Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_awrite-asynchronous-cluster-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        cluster_awrite() - Asynchronous Cluster Write
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sequential-access-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sequential Access Detection
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bio-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        BIO Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BIO Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bio-layer-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        BIO Layer Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bio-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bio Callbacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bio-stacking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bio Stacking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer-flushing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Flushing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Flushing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buf_daemon-main-flush-thread" class="md-nav__link">
    <span class="md-ellipsis">
      
        buf_daemon() - Main Flush Thread
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flushbufqueues-queue-flusher" class="md-nav__link">
    <span class="md-ellipsis">
      
        flushbufqueues() - Queue Flusher
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vfs_sync-filesystem-sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        VFS_SYNC - Filesystem Sync
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#page-cleaning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Cleaning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page Cleaning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vfs_clean_pages-mark-pages-clean" class="md-nav__link">
    <span class="md-ellipsis">
      
        vfs_clean_pages() - Mark Pages Clean
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#page-validity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Validity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kvabio-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        KVABIO API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="KVABIO API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvabio-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        KVABIO Functions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buffer-cache-sizing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Cache Sizing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-buffer-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dirty Buffer Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-ahead-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Read-ahead Tuning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-clustering" class="md-nav__link">
    <span class="md-ellipsis">
      
        Write Clustering
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        I/O Errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retry Strategies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buffer-state-inspection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer State Inspection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Issues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="vfs-buffer-cache-and-io">VFS Buffer Cache and I/O<a class="headerlink" href="#vfs-buffer-cache-and-io" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The VFS buffer cache is a critical subsystem that mediates between the filesystem layer and the underlying storage devices while integrating tightly with the VM system. It provides caching for filesystem metadata and file data, manages asynchronous and synchronous I/O, implements read-ahead and write-behind optimizations, and coordinates between buffer-based and VM-page-based I/O.</p>
<p><strong>Key source files:</strong>
- <code>sys/kern/vfs_bio.c</code> (4,659 lines) - Buffer cache management
- <code>sys/kern/vfs_cluster.c</code> (1,814 lines) - Cluster I/O optimization
- <code>sys/kern/vfs_vm.c</code> (503 lines) - VM integration
- <code>sys/sys/buf.h</code> - Buffer structure definitions
- <code>sys/sys/bio.h</code> - BIO layer structures</p>
<p><strong>Core responsibilities:</strong>
- Cache filesystem blocks in memory
- Manage dirty data and write-behind
- Implement read-ahead for sequential access
- Cluster I/O operations for performance
- Integrate with VM system for unified caching
- Provide async/sync I/O primitives</p>
<h2 id="buffer-structure">Buffer Structure<a class="headerlink" href="#buffer-structure" title="Permanent link">&para;</a></h2>
<h3 id="struct-buf">struct buf<a class="headerlink" href="#struct-buf" title="Permanent link">&para;</a></h3>
<p>The <code>struct buf</code> (sys/sys/buf.h:153) is the central data structure representing a cached filesystem block:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="cm">/* Tree linkages */</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">RB_ENTRY</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="n">b_rbnode</span><span class="p">;</span><span class="w">         </span><span class="cm">/* RB node in vnode clean/dirty tree */</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="n">RB_ENTRY</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="n">b_rbhash</span><span class="p">;</span><span class="w">         </span><span class="cm">/* RB node in vnode hash tree */</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="n">TAILQ_ENTRY</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="n">b_freelist</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Free list position if not active */</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">b_cluster_next</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Next buffer (cluster code) */</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="cm">/* Vnode association */</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">b_vp</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Vnode for this buffer */</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="cm">/* BIO translation layers */</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="n">b_bio_array</span><span class="p">[</span><span class="n">NBUF_BIO</span><span class="p">];</span><span class="w"> </span><span class="cm">/* Typically 6 layers */</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="cm">/* State and control */</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">b_flags</span><span class="p">;</span><span class="w">              </span><span class="cm">/* B_* flags */</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b_qindex</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Buffer queue index */</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b_qcpu</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Buffer queue CPU */</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">b_act_count</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Activity count (like vm_page) */</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">b_swindex</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Swap index */</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">    </span><span class="kt">cpumask_t</span><span class="w"> </span><span class="n">b_cpumask</span><span class="p">;</span><span class="w">            </span><span class="cm">/* KVABIO API CPU mask */</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock</span><span class="w"> </span><span class="n">b_lock</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Buffer lock */</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">    </span><span class="n">buf_cmd_t</span><span class="w"> </span><span class="n">b_cmd</span><span class="p">;</span><span class="w">                </span><span class="cm">/* I/O command */</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">    </span><span class="cm">/* Size fields */</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_bufsize</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* Allocated buffer size (filesystem block) */</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_runningbufspace</span><span class="p">;</span><span class="w">          </span><span class="cm">/* When I/O is running, pipelining */</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_bcount</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Valid bytes in buffer */</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_resid</span><span class="p">;</span><span class="w">                    </span><span class="cm">/* Remaining I/O */</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_error</span><span class="p">;</span><span class="w">                    </span><span class="cm">/* Error return */</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">    </span><span class="cm">/* Data pointers */</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">b_data</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Data pointer (KVA) */</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">b_kvabase</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Base KVA for buffer */</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_kvasize</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* Size of KVA for buffer */</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">    </span><span class="cm">/* Dirty tracking */</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_dirtyoff</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Offset in buffer of dirty region */</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_dirtyend</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Offset of end of dirty region */</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">    </span><span class="cm">/* Reference counting */</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_refs</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* FINDBLK_REF/bqhold()/bqdrop() */</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="w">    </span><span class="cm">/* Page list management */</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">xio</span><span class="w"> </span><span class="n">b_xio</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Data buffer page list management */</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="w">    </span><span class="cm">/* Filesystem dependencies */</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_ops</span><span class="w"> </span><span class="o">*</span><span class="n">b_ops</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Bio_ops used w/ b_dep */</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">workhead</span><span class="w"> </span><span class="n">b_dep</span><span class="p">;</span><span class="w">      </span><span class="cm">/* List of filesystem dependencies */</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">b_priv</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Filesystem private data */</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Key field groups:</strong></p>
<ol>
<li><strong>Indexing</strong>: b_rbnode, b_rbhash organize buffers by (vnode, offset)</li>
<li><strong>Bio layers</strong>: b_bio_array[] provides I/O address translation</li>
<li><strong>State</strong>: b_flags, b_cmd, b_error track buffer state</li>
<li><strong>Sizing</strong>: b_bufsize (allocation), b_bcount (valid data), b_resid (remaining)</li>
<li><strong>Data</strong>: b_data points to KVA, b_xio manages VM pages</li>
<li><strong>Dirty</strong>: b_dirtyoff/b_dirtyend track partial dirty ranges</li>
</ol>
<h3 id="bio-layer-fields">BIO Layer Fields<a class="headerlink" href="#bio-layer-fields" title="Permanent link">&para;</a></h3>
<p><strong>b_bio1</strong> (b_bio_array[0]) - Logical layer:
- Contains logical offset (b_loffset = b_bio1.bio_offset)
- Used with primary vnode (bp-&gt;b_vp)
- Operations: <code>vn_strategy(bp-&gt;b_vp, &amp;bp-&gt;b_bio1)</code></p>
<p><strong>b_bio2</strong> (b_bio_array[1]) - Physical layer:
- Contains device-relative offset (translated from logical)
- Used with device vnode in filesystems
- Set by VOP_BMAP() call</p>
<p><strong>Additional layers</strong>: Allocated from object cache for device stacking (RAID, encryption, etc.)</p>
<h3 id="buffer-flags-b_flags">Buffer Flags (b_flags)<a class="headerlink" href="#buffer-flags-b_flags" title="Permanent link">&para;</a></h3>
<p>Buffer state flags (sys/sys/buf.h:304):</p>
<p><strong>Cache state:</strong>
- <code>B_CACHE</code> (0x00000020) - Buffer found in cache, data valid
- <code>B_INVAL</code> (0x00002000) - Buffer does not contain valid info
- <code>B_DELWRI</code> (0x00000080) - Delayed write (dirty, needs flush)
- <code>B_DIRTY</code> (0x00200000) - Needs writing later</p>
<p><strong>I/O state:</strong>
- <code>B_ERROR</code> (0x00000800) - I/O error occurred
- <code>B_EINTR</code> (0x00000400) - I/O was interrupted
- <code>B_IOISSUED</code> (0x00001000) - I/O has been issued (vfs can clear)</p>
<p><strong>VM integration:</strong>
- <code>B_VMIO</code> (0x20000000) - Buffer tied to VM object
- <code>B_PAGING</code> (0x04000000) - Volatile paging I/O, bypass VMIO
- <code>B_RAM</code> (0x10000000) - Read-ahead mark</p>
<p><strong>Clustering:</strong>
- <code>B_CLUSTER</code> (0x40000000) - Part of a cluster operation
- <code>B_CLUSTEROK</code> (0x00020000) - May be clustered with adjacent buffers</p>
<p><strong>Locking:</strong>
- <code>B_LOCKED</code> (0x00004000) - Locked in core (not reusable)
- <code>B_KVABIO</code> (0x00010000) - Lockholder uses KVABIO API</p>
<p><strong>Lifecycle:</strong>
- <code>B_AGE</code> (0x00000001) - Reuse more quickly
- <code>B_RELBUF</code> (0x00400000) - Release VMIO buffer
- <code>B_NOCACHE</code> (0x00008000) - Destroy buffer AND backing store</p>
<p><strong>Special:</strong>
- <code>B_HEAVY</code> (0x00100000) - Heavy-weight buffer (needs special handling)
- <code>B_BNOCLIP</code> (0x00000100) - EOF clipping not allowed
- <code>B_NOTMETA</code> (0x00000004) - Not metadata (affects VM page handling)
- <code>B_MARKER</code> (0x00040000) - Special marker buffer in queue
- <code>B_HASHED</code> (0x00000040) - Indexed via v_rbhash_tree</p>
<p><strong>Tree linkage:</strong>
- <code>B_VNCLEAN</code> (0x01000000) - On vnode clean list
- <code>B_VNDIRTY</code> (0x02000000) - On vnode dirty list</p>
<h3 id="buffer-commands-buf_cmd_t">Buffer Commands (buf_cmd_t)<a class="headerlink" href="#buffer-commands-buf_cmd_t" title="Permanent link">&para;</a></h3>
<p>I/O operation types (sys/sys/buf.h:87):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">buf_cmd</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="n">BUF_CMD_DONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">      </span><span class="cm">/* I/O completed */</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="n">BUF_CMD_READ</span><span class="p">,</span><span class="w">          </span><span class="cm">/* Read operation */</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="n">BUF_CMD_WRITE</span><span class="p">,</span><span class="w">         </span><span class="cm">/* Write operation */</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="n">BUF_CMD_FREEBLKS</span><span class="p">,</span><span class="w">      </span><span class="cm">/* Free blocks */</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="n">BUF_CMD_FORMAT</span><span class="p">,</span><span class="w">        </span><span class="cm">/* Format operation */</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="n">BUF_CMD_FLUSH</span><span class="p">,</span><span class="w">         </span><span class="cm">/* Cache flush */</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="n">BUF_CMD_SEEK</span><span class="p">,</span><span class="w">          </span><span class="cm">/* Seek operation */</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="p">}</span><span class="w"> </span><span class="n">buf_cmd_t</span><span class="p">;</span>
</code></pre></div>
<h2 id="buffer-queues">Buffer Queues<a class="headerlink" href="#buffer-queues" title="Permanent link">&para;</a></h2>
<h3 id="per-cpu-queue-structure">Per-CPU Queue Structure<a class="headerlink" href="#per-cpu-queue-structure" title="Permanent link">&para;</a></h3>
<p>Buffers are organized into per-CPU queues to reduce lock contention (vfs_bio.c:72):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">enum</span><span class="w"> </span><span class="n">bufq_type</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="n">BQUEUE_NONE</span><span class="p">,</span><span class="w">        </span><span class="cm">/* not on any queue */</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="n">BQUEUE_LOCKED</span><span class="p">,</span><span class="w">      </span><span class="cm">/* locked buffers */</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">BQUEUE_CLEAN</span><span class="p">,</span><span class="w">       </span><span class="cm">/* non-B_DELWRI buffers */</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">BQUEUE_DIRTY</span><span class="p">,</span><span class="w">       </span><span class="cm">/* B_DELWRI buffers */</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="n">BQUEUE_DIRTY_HW</span><span class="p">,</span><span class="w">    </span><span class="cm">/* B_DELWRI buffers - heavy weight */</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="n">BQUEUE_EMPTY</span><span class="p">,</span><span class="w">       </span><span class="cm">/* empty buffer headers */</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="n">BUFFER_QUEUES</span><span class="w">       </span><span class="cm">/* number of buffer queues */</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="p">};</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bufpcpu</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="n">spin</span><span class="p">;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bqueues</span><span class="w"> </span><span class="n">bufqueues</span><span class="p">[</span><span class="n">BUFFER_QUEUES</span><span class="p">];</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="p">}</span><span class="w"> </span><span class="n">__cachealign</span><span class="p">;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bufpcpu</span><span class="w"> </span><span class="n">bufpcpu</span><span class="p">[</span><span class="n">MAXCPU</span><span class="p">];</span>
</code></pre></div>
<p><strong>Queue semantics:</strong></p>
<ul>
<li><strong>BQUEUE_NONE</strong>: Buffer is actively in use (locked, doing I/O)</li>
<li><strong>BQUEUE_LOCKED</strong>: Buffer explicitly locked with B_LOCKED flag</li>
<li><strong>BQUEUE_CLEAN</strong>: Clean cached buffers eligible for reuse</li>
<li><strong>BQUEUE_DIRTY</strong>: Dirty buffers awaiting flush</li>
<li><strong>BQUEUE_DIRTY_HW</strong>: Heavy-weight dirty buffers (special flushing)</li>
<li><strong>BQUEUE_EMPTY</strong>: Empty buffer headers (no data allocated)</li>
</ul>
<h3 id="buffer-lifecycle-through-queues">Buffer Lifecycle Through Queues<a class="headerlink" href="#buffer-lifecycle-through-queues" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Allocation</strong> (getnewbuf):</li>
<li>Pull from BQUEUE_EMPTY or BQUEUE_CLEAN</li>
<li>
<p>State: BQUEUE_NONE (in use)</p>
</li>
<li>
<p><strong>Active use</strong>:</p>
</li>
<li>Buffer locked via BUF_LOCK()</li>
<li>State: BQUEUE_NONE</li>
<li>
<p>I/O operations performed</p>
</li>
<li>
<p><strong>Release</strong> (brelse/bqrelse):</p>
</li>
<li>Unlock buffer</li>
<li>
<p>Move to appropriate queue:</p>
<ul>
<li>B_DELWRI  BQUEUE_DIRTY or BQUEUE_DIRTY_HW</li>
<li>B_LOCKED  BQUEUE_LOCKED</li>
<li>Clean  BQUEUE_CLEAN</li>
</ul>
</li>
<li>
<p><strong>Reuse</strong> (getnewbuf):</p>
</li>
<li>Scan BQUEUE_CLEAN for victims</li>
<li>
<p>Invalidate and reallocate</p>
</li>
<li>
<p><strong>Flush</strong> (buf_daemon):</p>
</li>
<li>Scan BQUEUE_DIRTY/BQUEUE_DIRTY_HW</li>
<li>Write dirty buffers asynchronously</li>
<li>Move to BQUEUE_CLEAN after write completes</li>
</ol>
<h2 id="buffer-cache-tuning-parameters">Buffer Cache Tuning Parameters<a class="headerlink" href="#buffer-cache-tuning-parameters" title="Permanent link">&para;</a></h2>
<h3 id="sysctl-tunables">Sysctl Tunables<a class="headerlink" href="#sysctl-tunables" title="Permanent link">&para;</a></h3>
<p>Space management (vfs_bio.c:162-210):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="cm">/* Operational control */</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kt">long</span><span class="w"> </span><span class="n">maxbufspace</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Hard limit on buffer space */</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kt">long</span><span class="w"> </span><span class="n">hibufspace</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Soft limit (high watermark) */</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kt">long</span><span class="w"> </span><span class="n">lobufspace</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Low watermark */</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kt">long</span><span class="w"> </span><span class="n">bufspace</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Current buffer space used */</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kt">long</span><span class="w"> </span><span class="n">lodirtybufspace</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Trigger buf_daemon activation */</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kt">long</span><span class="w"> </span><span class="n">hidirtybufspace</span><span class="p">;</span><span class="w">      </span><span class="cm">/* High watermark for dirty buffers */</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="kt">long</span><span class="w"> </span><span class="n">dirtybufspace</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Current dirty buffer space */</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="kt">long</span><span class="w"> </span><span class="n">dirtybufcount</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Number of dirty buffers */</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="kt">long</span><span class="w"> </span><span class="n">dirtybufspacehw</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Dirty space (heavy-weight) */</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="kt">long</span><span class="w"> </span><span class="n">dirtybufcounthw</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Dirty count (heavy-weight) */</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="kt">long</span><span class="w"> </span><span class="n">lorunningspace</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Minimum space for active I/O */</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="kt">long</span><span class="w"> </span><span class="n">hirunningspace</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Maximum space for active I/O */</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="kt">long</span><span class="w"> </span><span class="n">runningbufspace</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Currently running I/O space */</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="kt">long</span><span class="w"> </span><span class="n">runningbufcount</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Currently running I/O count */</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="n">u_int</span><span class="w"> </span><span class="n">flushperqueue</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Buffers to flush per queue (default: 1024) */</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="kt">long</span><span class="w"> </span><span class="n">bufcache_bw</span><span class="p">;</span><span class="w">          </span><span class="cm">/* BufferVM transfer bandwidth (200 MB/s) */</span>
</code></pre></div>
<p><strong>Watermark behavior:</strong></p>
<ul>
<li><strong>lobufspace  hibufspace</strong>: Normal operation, allocate freely</li>
<li><strong>&gt; hibufspace</strong>: Trigger aggressive buffer reclamation</li>
<li><strong>lodirtybufspace  hidirtybufspace</strong>: Normal dirty buffer accumulation</li>
<li><strong>&gt; hidirtybufspace</strong>: Wake buf_daemon to flush aggressively</li>
<li><strong>lorunningspace  hirunningspace</strong>: Control I/O pipeline depth</li>
</ul>
<h3 id="buffer-daemon-threads">Buffer Daemon Threads<a class="headerlink" href="#buffer-daemon-threads" title="Permanent link">&para;</a></h3>
<p>Two kernel threads manage buffer flushing (vfs_bio.c:155-156):</p>
<p><strong>bufdaemon_td</strong> - Standard buffer daemon:
- Flushes BQUEUE_DIRTY when dirtybufspace &gt; lodirtybufspace
- Triggered via bd_request atomic flag
- Writes dirty buffers asynchronously
- Moves flushed buffers to BQUEUE_CLEAN</p>
<p><strong>bufdaemonhw_td</strong> - Heavy-weight buffer daemon:
- Flushes BQUEUE_DIRTY_HW
- Separate thread prevents deadlock (heavy buffers may need more buffers to flush)
- Triggered via bd_request_hw atomic flag</p>
<p><strong>bd_signal()</strong> (vfs_bio.c:4522):
Wakes buffer daemons based on dirty space:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bd_signal</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">totalspace</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalspace</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">        </span><span class="n">runningbufspace</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dirtykvaspace</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lodirtybufspace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">        </span><span class="n">atomic_set_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd_request</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">        </span><span class="n">wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd_request</span><span class="p">);</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dirtybufspacehw</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">lodirtybufspace</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">            </span><span class="n">atomic_set_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd_request_hw</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">            </span><span class="n">wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd_request_hw</span><span class="p">);</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="p">}</span>
</code></pre></div>
<h2 id="buffer-allocation">Buffer Allocation<a class="headerlink" href="#buffer-allocation" title="Permanent link">&para;</a></h2>
<h3 id="getnewbuf-core-allocation">getnewbuf() - Core Allocation<a class="headerlink" href="#getnewbuf-core-allocation" title="Permanent link">&para;</a></h3>
<p><strong>getnewbuf()</strong> (vfs_bio.c:1885)</p>
<p>Allocates a buffer for use, reusing existing buffers when necessary:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">getnewbuf</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">blkflags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">slptimeo</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxsize</span><span class="p">)</span>
</code></pre></div>
<p><strong>Allocation strategy:</strong></p>
<ol>
<li>
<p><strong>Check space limits</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">bufspace</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">maxsize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">hibufspace</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="n">bufspacewakeup</span><span class="p">();</span><span class="w">  </span><span class="cm">/* wait for space */</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Try BQUEUE_EMPTY</strong> (fast path):</p>
</li>
<li>Pull empty buffer header</li>
<li>
<p>No data backing store yet</p>
</li>
<li>
<p><strong>Scan BQUEUE_CLEAN</strong> (reuse path):</p>
</li>
<li>Look for buffers with B_AGE (prefer aged buffers)</li>
<li>Check lock availability (LK_NOWAIT)</li>
<li>
<p>Validate buffer can be reused:</p>
<ul>
<li>Not locked (B_LOCKED clear)</li>
<li>Not in I/O (B_IOISSUED clear)</li>
<li>Not referenced (b_refs == 0)</li>
</ul>
</li>
<li>
<p><strong>Flush and wait</strong> (pressure path):</p>
</li>
<li>If no buffers available, flush BQUEUE_DIRTY</li>
<li>Wait for buffers to become available</li>
<li>
<p>Retry allocation</p>
</li>
<li>
<p><strong>Initialize buffer</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Start cached */</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_DONE</span><span class="p">;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_qindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BQUEUE_NONE</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Heavy-weight handling:</strong></p>
<p>Heavy-weight buffers (B_HEAVY) have restrictions:
- May need additional buffers to complete write
- Prevented from being allocated when dirty space is high
- Separate daemon thread (bufdaemonhw_td) for flushing</p>
<h3 id="getblk-cached-block-access">getblk() - Cached Block Access<a class="headerlink" href="#getblk-cached-block-access" title="Permanent link">&para;</a></h3>
<p><strong>getblk()</strong> (vfs_bio.c:2729)</p>
<p>Main entry point for accessing cached filesystem blocks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">getblk</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">                   </span><span class="kt">int</span><span class="w"> </span><span class="n">blkflags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">slptimeo</span><span class="p">)</span>
</code></pre></div>
<p><strong>Lookup and allocation workflow:</strong></p>
<ol>
<li>
<p><strong>Search vnode's buffer tree</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="n">FINDBLK_NBLOCK</span><span class="p">);</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="cm">/* Found in cache */</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BUF_LOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">LK_EXCLUSIVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LK_NOWAIT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="cm">/* Lock contention, retry or wait */</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bp</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Cache hit */</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Allocate new buffer</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getnewbuf</span><span class="p">(</span><span class="n">blkflags</span><span class="p">,</span><span class="w"> </span><span class="n">slptimeo</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">maxsize</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Insert into vnode's tree</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">lwkt_gettoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_token</span><span class="p">);</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="cm">/* Re-check for race (someone else inserted) */</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">bp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="cm">/* Lost race, use bp2 */</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="n">brelse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp2</span><span class="p">;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="cm">/* Won race, insert bp */</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vp</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_loffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loffset</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="n">buf_rb_tree_RB_INSERT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_rbclean_tree</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="n">buf_rb_hash_RB_INSERT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_rbhash_tree</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_HASHED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_VNCLEAN</span><span class="p">;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="p">}</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="n">lwkt_reltoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_token</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Handle size changes</strong>:</p>
</li>
<li>
<p>If buffer exists but size doesn't match:</p>
<ul>
<li>GETBLK_SZMATCH: Return NULL</li>
<li>Otherwise: Reallocate buffer with new size</li>
</ul>
</li>
<li>
<p><strong>Initialize for use</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="cm">/* Not valid, caller must issue I/O */</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">B_ERROR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_INVAL</span><span class="p">);</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="cm">/* Don&#39;t set BUF_CMD_READ here, caller does it */</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Flags:</strong>
- <code>GETBLK_PCATCH</code>: Allow signals (can return NULL)
- <code>GETBLK_BHEAVY</code>: Mark as heavy-weight buffer
- <code>GETBLK_SZMATCH</code>: Fail if size doesn't match
- <code>GETBLK_NOWAIT</code>: Non-blocking lock
- <code>GETBLK_KVABIO</code>: Request KVABIO buffer</p>
<p><strong>Return states:</strong>
- Buffer locked and ready for use
- B_CACHE set if data valid
- B_CACHE clear if I/O needed</p>
<h2 id="buffer-io-operations">Buffer I/O Operations<a class="headerlink" href="#buffer-io-operations" title="Permanent link">&para;</a></h2>
<h3 id="bread-synchronous-read">bread() - Synchronous Read<a class="headerlink" href="#bread-synchronous-read" title="Permanent link">&para;</a></h3>
<p><strong>bread()</strong> (vfs_bio.c:857)</p>
<p>Reads a single block synchronously:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">bread</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">**</span><span class="n">bpp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Workflow:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cm">/* Get buffer (from cache or allocate) */</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="cm">/* If not in cache, issue I/O */</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">B_ERROR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_EINTR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_INVAL</span><span class="p">);</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="p">;</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biodone_sync</span><span class="p">;</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">BIO_SYNC</span><span class="p">;</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="n">vfs_busy_pages</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="n">vn_strategy</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;biord&quot;</span><span class="p">);</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="p">}</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="o">*</span><span class="n">bpp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Return locked buffer */</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
</code></pre></div>
<h3 id="breadn-read-with-read-ahead">breadn() - Read with Read-ahead<a class="headerlink" href="#breadn-read-with-read-ahead" title="Permanent link">&para;</a></h3>
<p><strong>breadn()</strong> (vfs_bio.c:892)</p>
<p>Reads a block with optional read-ahead:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">breadn</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bflags</span><span class="p">,</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">           </span><span class="kt">off_t</span><span class="w"> </span><span class="o">*</span><span class="n">raoffset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">rabsize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cnt</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">**</span><span class="n">bpp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Read-ahead strategy:</strong></p>
<ol>
<li>
<p><strong>Issue primary read</strong> (synchronous):
   <div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="cm">/* Issue sync I/O */</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">vn_strategy</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="n">readwait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Issue read-ahead requests</strong> (asynchronous):
   <div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inmem</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">raoffset</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Already cached */</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="n">rabp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">raoffset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">rabsize</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">rabp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">        </span><span class="n">rabp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="p">;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">        </span><span class="n">BUF_KERNPROC</span><span class="p">(</span><span class="n">rabp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Async, owned by kernel */</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">        </span><span class="n">vn_strategy</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rabp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">        </span><span class="n">brelse</span><span class="p">(</span><span class="n">rabp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Already cached */</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Wait for primary read</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readwait</span><span class="p">)</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;biord&quot;</span><span class="p">);</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Read-ahead benefits:</strong>
- Overlap disk I/O with CPU processing
- Exploit sequential access patterns
- Improve throughput for streaming reads</p>
<h3 id="bwrite-synchronous-write">bwrite() - Synchronous Write<a class="headerlink" href="#bwrite-synchronous-write" title="Permanent link">&para;</a></h3>
<p><strong>bwrite()</strong> (vfs_bio.c:963)</p>
<p>Writes a buffer synchronously:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">bwrite</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Workflow:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_INVAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="n">brelse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="p">}</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="cm">/* Clear errors, mark cached */</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">B_ERROR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_EINTR</span><span class="p">);</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">;</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_WRITE</span><span class="p">;</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biodone_sync</span><span class="p">;</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">BIO_SYNC</span><span class="p">;</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="n">vfs_busy_pages</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="n">bsetrunningbufspace</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bufsize</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Account running space */</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="n">vn_strategy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;biows&quot;</span><span class="p">);</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="n">brelse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
</code></pre></div>
<p><strong>Key points:</strong>
- Waits for I/O completion
- Sets B_CACHE (data valid after write)
- Tracks running I/O space
- Always releases buffer after completion</p>
<h3 id="bawrite-asynchronous-write">bawrite() - Asynchronous Write<a class="headerlink" href="#bawrite-asynchronous-write" title="Permanent link">&para;</a></h3>
<p><strong>bawrite()</strong> (vfs_bio.c:1014)</p>
<p>Writes a buffer asynchronously:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kt">void</span><span class="w"> </span><span class="n">bawrite</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Differences from bwrite():</strong>
- Does NOT wait for completion (no biowait)
- Uses default biodone (not biodone_sync)
- Marks buffer as kernel-owned (BUF_KERNPROC)
- Returns immediately</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">B_ERROR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_EINTR</span><span class="p">);</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_WRITE</span><span class="p">;</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Use default */</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="n">vfs_busy_pages</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="n">bsetrunningbufspace</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bufsize</span><span class="p">);</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="n">BUF_KERNPROC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Transfer to kernel */</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="n">vn_strategy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="cm">/* Returns immediately, I/O in progress */</span>
</code></pre></div>
<h3 id="bdwrite-delayed-write">bdwrite() - Delayed Write<a class="headerlink" href="#bdwrite-delayed-write" title="Permanent link">&para;</a></h3>
<p><strong>bdwrite()</strong> (vfs_bio.c:1060)</p>
<p>Marks a buffer dirty for later writing:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kt">void</span><span class="w"> </span><span class="n">bdwrite</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Delayed write behavior:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">bdirty</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Mark B_DELWRI, move to dirty tree */</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">;</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="cm">/* Pre-map physical block to avoid deadlock during sync */</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio2</span><span class="p">.</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NOOFFSET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="n">VOP_BMAP</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_loffset</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">             </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio2</span><span class="p">.</span><span class="n">bio_offset</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">             </span><span class="n">BUF_CMD_WRITE</span><span class="p">);</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="p">}</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="cm">/* Mark pages clean (earmarked for buffer flush) */</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="n">vfs_clean_pages</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="n">bqrelse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Release to dirty queue */</span>
</code></pre></div>
<p><strong>Why delay writes?</strong>
- Batch multiple writes together
- Allow cancellation (if file deleted)
- Enable write clustering
- Avoid synchronous delays</p>
<p><strong>VOP_BMAP call importance:</strong>
- Pre-translates logicalphysical block mapping
- Avoids needing buffers during sync (prevents deadlock)
- Memory for indirect blocks may not be available during sync</p>
<h3 id="bdirty-mark-buffer-dirty">bdirty() - Mark Buffer Dirty<a class="headerlink" href="#bdirty-mark-buffer-dirty" title="Permanent link">&para;</a></h3>
<p><strong>bdirty()</strong> (vfs_bio.c:1163)</p>
<p>Core function to mark a buffer dirty:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">bdirty</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="p">{</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="n">KASSERT</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_qindex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BQUEUE_NONE</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">B_RELBUF</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_NOCACHE</span><span class="p">);</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_DELWRI</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">        </span><span class="n">lwkt_gettoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="o">-&gt;</span><span class="n">v_token</span><span class="p">);</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">        </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_DELWRI</span><span class="p">;</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">        </span><span class="n">reassignbuf</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Move from cleandirty tree */</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">        </span><span class="n">lwkt_reltoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="o">-&gt;</span><span class="n">v_token</span><span class="p">);</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">        </span><span class="cm">/* Update global counters */</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">        </span><span class="n">atomic_add_long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirtybufcount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">        </span><span class="n">atomic_add_long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirtykvaspace</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_kvasize</span><span class="p">);</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">        </span><span class="n">atomic_add_long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirtybufspace</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bufsize</span><span class="p">);</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_HEAVY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">            </span><span class="n">atomic_add_long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirtybufcounthw</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">            </span><span class="n">atomic_add_long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirtybufspacehw</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bufsize</span><span class="p">);</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">        </span><span class="n">bd_heatup</span><span class="p">();</span><span class="w">  </span><span class="cm">/* Signal buffer daemon */</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="p">}</span>
</code></pre></div>
<p><strong>reassignbuf()</strong>: Moves buffer between vnode trees:
- From: <code>vp-&gt;v_rbclean_tree</code>, <code>B_VNCLEAN</code>
- To: <code>vp-&gt;v_rbdirty_tree</code>, <code>B_VNDIRTY</code></p>
<h3 id="buwrite-fake-write-tmpfs">buwrite() - Fake Write (tmpfs)<a class="headerlink" href="#buwrite-fake-write-tmpfs" title="Permanent link">&para;</a></h3>
<p><strong>buwrite()</strong> (vfs_bio.c:1127)</p>
<p>Used by tmpfs to mark pages dirty without writing to disk:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">buwrite</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="p">{</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="cm">/* Only for VMIO buffers */</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_VMIO</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_DELWRI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">        </span><span class="n">bdwrite</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">    </span><span class="cm">/* Mark VM pages as needing commit */</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">        </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">        </span><span class="n">vm_page_need_commit</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">    </span><span class="n">bqrelse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Release without marking buffer dirty */</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Use case:</strong>
- tmpfs stores data in VM pages, not disk
- Pages need marking dirty for VM system
- Buffer itself doesn't need writing</p>
<h2 id="buffer-release">Buffer Release<a class="headerlink" href="#buffer-release" title="Permanent link">&para;</a></h2>
<h3 id="brelse-standard-release">brelse() - Standard Release<a class="headerlink" href="#brelse-standard-release" title="Permanent link">&para;</a></h3>
<p><strong>brelse()</strong> (vfs_bio.c:1268)</p>
<p>Releases a buffer back to the cache:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kt">void</span><span class="w"> </span><span class="n">brelse</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Release workflow:</strong></p>
<ol>
<li>
<p><strong>Clear transient flags</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">B_IOISSUED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_EINTR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_NOTMETA</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_KVABIO</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Handle B_NOCACHE</strong> (destroy request):
   <div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_NOCACHE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_INVAL</span><span class="p">;</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Handle B_INVAL</strong> (invalidate):
   <div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_INVAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">B_DELWRI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_VNDIRTY</span><span class="p">))</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">        </span><span class="n">bundirty</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Remove from dirty tree */</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_HASHED</span><span class="p">)</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">        </span><span class="n">buf_rb_hash_RB_REMOVE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_rbhash_tree</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">B_VNCLEAN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_VNDIRTY</span><span class="p">))</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">        </span><span class="n">buf_rb_tree_RB_REMOVE</span><span class="p">(...,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">B_HASHED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_VNCLEAN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_VNDIRTY</span><span class="p">);</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Determine destination queue</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_LOCKED</span><span class="p">)</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="n">qindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BQUEUE_LOCKED</span><span class="p">;</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_DELWRI</span><span class="p">)</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="n">qindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_HEAVY</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">             </span><span class="nl">BQUEUE_DIRTY_HW</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">BQUEUE_DIRTY</span><span class="p">;</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_vp</span><span class="p">)</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="n">qindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BQUEUE_CLEAN</span><span class="p">;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="k">else</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="n">qindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BQUEUE_EMPTY</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Insert into queue</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bufqspin</span><span class="p">);</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bufqueues</span><span class="p">[</span><span class="n">qindex</span><span class="p">],</span><span class="w"> </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">b_freelist</span><span class="p">);</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bufqspin</span><span class="p">);</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_qindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qindex</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Unlock buffer</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">BUF_UNLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Wake waiters</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">bufcountwakeup</span><span class="p">();</span><span class="w">  </span><span class="cm">/* Wake anyone waiting for buffers */</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">bufspacewakeup</span><span class="p">();</span><span class="w">  </span><span class="cm">/* Wake anyone waiting for space */</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="bqrelse-quick-release">bqrelse() - Quick Release<a class="headerlink" href="#bqrelse-quick-release" title="Permanent link">&para;</a></h3>
<p><strong>bqrelse()</strong> (vfs_bio.c:1564)</p>
<p>Optimized release for buffers expected to be reused:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kt">void</span><span class="w"> </span><span class="n">bqrelse</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Difference from brelse():</strong>
- Doesn't set B_AGE flag
- Leaves buffer in favorable position for reuse
- Used for metadata that's likely to be accessed again soon</p>
<h2 id="vm-integration-vmio">VM Integration (VMIO)<a class="headerlink" href="#vm-integration-vmio" title="Permanent link">&para;</a></h2>
<h3 id="vmio-buffers">VMIO Buffers<a class="headerlink" href="#vmio-buffers" title="Permanent link">&para;</a></h3>
<p>Buffers can be backed by VM pages instead of pure KVA (B_VMIO flag):</p>
<p><strong>Benefits:</strong>
- Unified buffer cache and page cache
- Pages shared between mmap() and read()/write()
- Better memory utilization
- Supports direct I/O to user pages</p>
<p><strong>b_xio structure</strong> (sys/sys/xio.h):
Manages the list of VM pages backing the buffer:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">xio</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">xio_npages</span><span class="p">;</span><span class="w">                    </span><span class="cm">/* Number of pages */</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">xio_flags</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* Flags */</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">xio_pages</span><span class="p">[</span><span class="n">XIO_INTERNAL_PAGES</span><span class="p">];</span><span class="w">  </span><span class="cm">/* Page array */</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_page</span><span class="w"> </span><span class="o">*</span><span class="n">xio_internal_pages</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Internal storage */</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="p">};</span>
</code></pre></div>
<h3 id="vfs_vmio_alloc-allocate-vm-pages">vfs_vmio_alloc() - Allocate VM Pages<a class="headerlink" href="#vfs_vmio_alloc-allocate-vm-pages" title="Permanent link">&para;</a></h3>
<p><strong>vfs_vmio_alloc()</strong> (vfs_bio.c:2247)</p>
<p>Allocates VM pages to back a buffer:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">vfs_vmio_alloc</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">                          </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bsize</span><span class="p">)</span>
</code></pre></div>
<p><strong>Allocation workflow:</strong></p>
<ol>
<li>
<p><strong>Calculate page range</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">vm_object_t</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_object</span><span class="p">;</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kt">off_t</span><span class="w"> </span><span class="n">pgoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loffset</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PAGE_MASK</span><span class="p">;</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btoc</span><span class="p">(</span><span class="n">round_page</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pgoff</span><span class="p">));</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Allocate/lookup pages</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">npages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">    </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btop</span><span class="p">(</span><span class="n">loffset</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio_page_alloc</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">pg</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Set buffer properties</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_VMIO</span><span class="p">;</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">caddr_t</span><span class="p">)(</span><span class="n">pgoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">vm_offset_t</span><span class="p">)</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">npages</span><span class="p">;</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="vfs_bio_clrbuf-clear-buffer">vfs_bio_clrbuf() - Clear Buffer<a class="headerlink" href="#vfs_bio_clrbuf-clear-buffer" title="Permanent link">&para;</a></h3>
<p><strong>vfs_bio_clrbuf()</strong> (vfs_bio.c:729)</p>
<p>Zeros a buffer and validates all pages:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vfs_bio_clrbuf</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="p">{</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_VMIO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">        </span><span class="cm">/* Zero VM pages */</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">            </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">VM_PAGE_BITS_ALL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">                </span><span class="n">pmap_zero_page</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">                </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_PAGE_BITS_ALL</span><span class="p">;</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">                </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">        </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_resid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">        </span><span class="cm">/* Zero KVA */</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="w">        </span><span class="n">clrbuf</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">;</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="p">}</span>
</code></pre></div>
<h3 id="vfs_busy_pages-vfs_unbusy_pages">vfs_busy_pages() / vfs_unbusy_pages()<a class="headerlink" href="#vfs_busy_pages-vfs_unbusy_pages" title="Permanent link">&para;</a></h3>
<p><strong>vfs_busy_pages()</strong> (vfs_bio.c:4051)</p>
<p>Prepares VM pages for I/O:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vfs_busy_pages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="p">{</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_VMIO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">            </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">                </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PG_ZERO</span><span class="p">;</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">                </span><span class="n">vm_page_io_start</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">                </span><span class="n">vm_page_protect</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">VM_PROT_READ</span><span class="p">);</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">                </span><span class="n">vm_page_io_start</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="p">}</span>
</code></pre></div>
<p><strong>vfs_unbusy_pages()</strong> (vfs_bio.c:4096)</p>
<p>Completes I/O on VM pages:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vfs_unbusy_pages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="p">{</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_VMIO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">            </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">            </span><span class="n">vm_page_io_finish</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">                </span><span class="cm">/* Mark page valid after successful read */</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">                </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_PAGE_BITS_ALL</span><span class="p">;</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="p">}</span>
</code></pre></div>
<h3 id="vfs_vmio_release-release-vm-pages">vfs_vmio_release() - Release VM Pages<a class="headerlink" href="#vfs_vmio_release-release-vm-pages" title="Permanent link">&para;</a></h3>
<p><strong>vfs_vmio_release()</strong> (vfs_bio.c:1233)</p>
<p>Releases VM pages when buffer destroyed:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">vfs_vmio_release</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="p">{</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">        </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">        </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">        </span><span class="n">vm_page_busy_wait</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vmiorl&quot;</span><span class="p">);</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">        </span><span class="cm">/* Free page if appropriate */</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">B_NOCACHE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">B_DIRECT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">            </span><span class="n">vm_page_try_to_free</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">            </span><span class="n">vm_page_try_to_cache</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">        </span><span class="n">vm_page_wakeup</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">B_VMIO</span><span class="p">;</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="p">}</span>
</code></pre></div>
<h2 id="cluster-io">Cluster I/O<a class="headerlink" href="#cluster-io" title="Permanent link">&para;</a></h2>
<h3 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h3>
<p>Cluster I/O optimization groups contiguous filesystem blocks into single I/O operations for improved throughput. Implemented in <code>sys/kern/vfs_cluster.c</code>.</p>
<p><strong>Benefits:</strong>
- Reduces per-I/O overhead
- Better utilizes disk bandwidth
- Exploits spatial locality
- Amortizes seek time over multiple blocks</p>
<h3 id="cluster-cache">Cluster Cache<a class="headerlink" href="#cluster-cache" title="Permanent link">&para;</a></h3>
<p><strong>cluster_cache_t</strong> structure (vfs_cluster.c:70):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cluster_cache</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">cc_loffset</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Logical offset (cluster start) */</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">cc_lastloffset</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Last offset in cluster */</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cc_flags</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Flags */</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">cc_vp</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Vnode */</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cc_refs</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Reference count */</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="p">}</span><span class="w"> </span><span class="n">cluster_cache_t</span><span class="p">;</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="cp">#define CLUSTER_CACHE_SIZE 16</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="n">cluster_cache_t</span><span class="w"> </span><span class="n">cluster_array</span><span class="p">[</span><span class="n">CLUSTER_CACHE_SIZE</span><span class="p">];</span>
</code></pre></div>
<p><strong>Per-vnode cluster state:</strong>
- Tracks sequential access patterns
- Maintains read-ahead context
- Cached in global array indexed by vnode</p>
<p><strong>cluster_getcache() / cluster_putcache()</strong>: Manage cluster cache entries</p>
<h3 id="cluster_read-clustered-read">cluster_read() - Clustered Read<a class="headerlink" href="#cluster_read-clustered-read" title="Permanent link">&para;</a></h3>
<p><strong>cluster_read()</strong> (vfs_cluster.c:224)</p>
<p>Main entry point for clustered read operations:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">cluster_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">filesize</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">                 </span><span class="kt">int</span><span class="w"> </span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalbytes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seqcount</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">                 </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">**</span><span class="n">bpp</span><span class="p">)</span>
</code></pre></div>
<p><strong>Parameters:</strong>
- <code>filesize</code>: Total file size
- <code>loffset</code>: Logical offset to read
- <code>blksize</code>: Filesystem block size
- <code>totalbytes</code>: Total read size
- <code>seqcount</code>: Sequential access count (for read-ahead)
- <code>bpp</code>: Returns buffer pointer</p>
<p><strong>Read clustering workflow:</strong></p>
<ol>
<li>
<p><strong>Check for existing buffer</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">    </span><span class="o">*</span><span class="n">bpp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="p">;</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Cache hit */</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Determine cluster size</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="cm">/* Use seqcount to scale read-ahead */</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="n">maxra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seqcount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="n">maxra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">maxra</span><span class="p">,</span><span class="w"> </span><span class="n">MAXPHYS</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Cap at MAXPHYS (128KB) */</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Build read-ahead list</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxblocks</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inmem</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blksize</span><span class="p">))</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Stop at cached block */</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="n">raoffset</span><span class="p">[</span><span class="n">rablks</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="n">rabsize</span><span class="p">[</span><span class="n">rablks</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="n">rablks</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Issue clustered I/O</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster_rbuild</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">filesize</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">                       </span><span class="n">loffset</span><span class="p">,</span><span class="w"> </span><span class="n">raoffset</span><span class="p">,</span><span class="w"> </span><span class="n">rabsize</span><span class="p">,</span><span class="w"> </span><span class="n">rablks</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Update cluster cache</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster_getcache</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="p">);</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cc_lastloffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rablks</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="n">cluster_putcache</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="cluster_rbuild-build-read-cluster">cluster_rbuild() - Build Read Cluster<a class="headerlink" href="#cluster_rbuild-build-read-cluster" title="Permanent link">&para;</a></h3>
<p><strong>cluster_rbuild()</strong> (vfs_cluster.c:893)</p>
<p>Constructs a clustered read I/O operation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cluster_rbuild</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">filesize</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">                          </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">loffset</span><span class="p">,</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">                          </span><span class="kt">off_t</span><span class="w"> </span><span class="o">*</span><span class="n">raoffset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">rabsize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rablks</span><span class="p">)</span>
</code></pre></div>
<p><strong>Clustering strategy:</strong></p>
<ol>
<li>
<p><strong>Allocate read-ahead buffers</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rablks</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">    </span><span class="n">rabp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">raoffset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">rabsize</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rabp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_CACHE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">        </span><span class="n">brelse</span><span class="p">(</span><span class="n">rabp</span><span class="p">);</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Skip cached */</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">    </span><span class="n">rabp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_RAM</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Mark read-ahead */</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">    </span><span class="n">rabp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="p">;</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">    </span><span class="cm">/* Link into cluster chain */</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">    </span><span class="n">cluster_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">,</span><span class="w"> </span><span class="n">rabp</span><span class="p">);</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Issue parent I/O</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="p">;</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster_callback</span><span class="p">;</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_CLUSTER</span><span class="p">;</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="n">vfs_busy_pages</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="n">vn_strategy</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Cluster callback</strong> (cluster_callback):</p>
</li>
<li>Completes parent bio</li>
<li>Iterates child bios (read-ahead buffers)</li>
<li>Calls biodone() on each child</li>
<li>Releases buffers</li>
</ol>
<p><strong>Chain structure:</strong>
- Parent buffer has bio chain (bio-&gt;bio_caller_info.cluster_head)
- Child buffers linked via cluster_next
- All complete when parent I/O finishes</p>
<h3 id="cluster_write-clustered-write">cluster_write() - Clustered Write<a class="headerlink" href="#cluster_write-clustered-write" title="Permanent link">&para;</a></h3>
<p><strong>cluster_write()</strong> (vfs_cluster.c:1244)</p>
<p>Attempts to cluster a write operation with adjacent dirty buffers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="kt">void</span><span class="w"> </span><span class="n">cluster_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">filesize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seqcount</span><span class="p">)</span>
</code></pre></div>
<p><strong>Write clustering workflow:</strong></p>
<ol>
<li>
<p><strong>Check if clustering allowed</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_CLUSTEROK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Filesystem doesn&#39;t allow clustering */</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_LOCKED</span><span class="p">)</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Locked buffer */</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Scan for adjacent dirty buffers</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="cm">/* Scan backwards */</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxback</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="w">    </span><span class="n">tbp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">FINDBLK_TEST</span><span class="p">);</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tbp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">tbp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_DELWRI</span><span class="p">))</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">    </span><span class="cm">/* Collect buffer */</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="p">}</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="cm">/* Scan forwards */</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxahead</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">    </span><span class="n">tbp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findblk</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">loffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">FINDBLK_TEST</span><span class="p">);</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tbp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">tbp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_DELWRI</span><span class="p">))</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="w">    </span><span class="cm">/* Collect buffer */</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Build cluster</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">cluster_wbuild</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">bpp</span><span class="p">,</span><span class="w"> </span><span class="n">numblks</span><span class="p">,</span><span class="w"> </span><span class="n">start_loffset</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Issue clustered write</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nblocks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="w">    </span><span class="cm">/* Single block, issue normally */</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">    </span><span class="n">bawrite</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">    </span><span class="cm">/* Multi-block cluster */</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">cluster</span><span class="o">:</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">        </span><span class="n">cluster_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">    </span><span class="n">vn_strategy</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Write clustering benefits:</strong>
- Reduces write overhead
- Better disk utilization
- Elevator seeking optimization
- Improved metadata write performance</p>
<h3 id="cluster_awrite-asynchronous-cluster-write">cluster_awrite() - Asynchronous Cluster Write<a class="headerlink" href="#cluster_awrite-asynchronous-cluster-write" title="Permanent link">&para;</a></h3>
<p><strong>cluster_awrite()</strong> (vfs_cluster.c:1418)</p>
<p>Called during buffer flushing to attempt clustering:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">cluster_awrite</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="p">{</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="w">    </span><span class="cm">/* If already doing I/O, skip */</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_IOISSUED</span><span class="p">)</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="w">    </span><span class="cm">/* Try to build cluster */</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="w">    </span><span class="n">cluster_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">filesize</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">seqcount</span><span class="p">);</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="p">}</span>
</code></pre></div>
<p>Called by buf_daemon when flushing BQUEUE_DIRTY.</p>
<h3 id="sequential-access-detection">Sequential Access Detection<a class="headerlink" href="#sequential-access-detection" title="Permanent link">&para;</a></h3>
<p><strong>sequential_heuristic()</strong> (vfs_vnops.c):</p>
<p>Filesystem code tracks sequential access via VOP_READ/VOP_WRITE:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">seqcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_SEQMASK</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">B_SEQSHIFT</span><span class="p">;</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loffset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">last_loffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blksize</span><span class="p">)</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w">    </span><span class="n">seqcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">seqcount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">B_SEQMAX</span><span class="p">);</span><span class="w">  </span><span class="cm">/* 127 max */</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="k">else</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">    </span><span class="n">seqcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Reset on non-sequential */</span>
</code></pre></div>
<p><strong>seqcount usage:</strong>
- 0: Random access, minimal read-ahead
- &gt;0: Sequential, scale read-ahead proportionally
- Max (127): Aggressive read-ahead (127 * blksize)</p>
<h2 id="bio-operations">BIO Operations<a class="headerlink" href="#bio-operations" title="Permanent link">&para;</a></h2>
<h3 id="bio-layer-overview">BIO Layer Overview<a class="headerlink" href="#bio-layer-overview" title="Permanent link">&para;</a></h3>
<p>The BIO (Block I/O) layer provides a flexible mechanism for I/O request transformation and stacking.</p>
<p><strong>struct bio</strong> (sys/sys/bio.h):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio_next</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Next bio in chain */</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio_prev</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Previous bio */</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">bio_offset</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Logical offset (or block number) */</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bio_buf</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Associated buffer */</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">    </span><span class="n">bio_track_t</span><span class="w"> </span><span class="o">*</span><span class="n">bio_track</span><span class="p">;</span><span class="w">        </span><span class="cm">/* I/O tracking */</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">bio_done</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Completion callback */</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">bio_caller_info1</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Caller private data */</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cluster_head</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Cluster I/O head */</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cluster_parent</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Cluster parent */</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">bio_caller_info</span><span class="p">;</span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">    </span><span class="n">u_int</span><span class="w"> </span><span class="n">bio_flags</span><span class="p">;</span><span class="w">               </span><span class="cm">/* BIO flags */</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="p">};</span>
</code></pre></div>
<p><strong>BIO flags:</strong>
- <code>BIO_SYNC</code> - Synchronous I/O
- <code>BIO_WANT</code> - Want notification on completion
- <code>BIO_DONE</code> - I/O completed</p>
<h3 id="bio-callbacks">Bio Callbacks<a class="headerlink" href="#bio-callbacks" title="Permanent link">&para;</a></h3>
<p><strong>biodone()</strong> (vfs_bio.c:4201)</p>
<p>Default I/O completion handler:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">biodone</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="p">{</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_buf</span><span class="p">;</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w">    </span><span class="cm">/* Call bio-specific done function if present */</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">        </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_done</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">    </span><span class="cm">/* Default completion */</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="w">    </span><span class="n">bufdone</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Complete buffer I/O */</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="p">}</span>
</code></pre></div>
<p><strong>biodone_sync()</strong> (vfs_bio.c:4226)</p>
<p>Synchronous I/O completion:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">biodone_sync</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="p">{</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">BIO_DONE</span><span class="p">;</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="n">wakeup</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Wake biowait() */</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="p">}</span>
</code></pre></div>
<p><strong>biowait()</strong> (vfs_bio.c:4243)</p>
<p>Wait for synchronous I/O completion:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">biowait</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">wmesg</span><span class="p">)</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="p">{</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIO_DONE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">        </span><span class="n">tsleep</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">wmesg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIO_ERROR</span><span class="p">)</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_buf</span><span class="o">-&gt;</span><span class="n">b_error</span><span class="p">;</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="p">}</span>
</code></pre></div>
<h3 id="bio-stacking">Bio Stacking<a class="headerlink" href="#bio-stacking" title="Permanent link">&para;</a></h3>
<p>Device drivers and filesystems can push additional BIO layers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="cm">/* Filesystem layer (logical offset) */</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="n">vn_strategy</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="w">    </span><span class="err"></span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="cm">/* Filesystem translates bio1  bio2 */</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="n">VOP_STRATEGY</span><span class="p">(</span><span class="n">devvp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio2</span><span class="p">);</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w">    </span><span class="err"></span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="cm">/* Device driver handles bio2 (physical offset) */</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="n">dev_dstrategy</span><span class="p">(...);</span>
</code></pre></div>
<p><strong>Example: HAMMER filesystem</strong>
1. bio1: File logical offset
2. bio2: HAMMER volume offset
3. bio3: Device physical offset</p>
<h2 id="buffer-flushing">Buffer Flushing<a class="headerlink" href="#buffer-flushing" title="Permanent link">&para;</a></h2>
<h3 id="buf_daemon-main-flush-thread">buf_daemon() - Main Flush Thread<a class="headerlink" href="#buf_daemon-main-flush-thread" title="Permanent link">&para;</a></h3>
<p><strong>buf_daemon()</strong> (vfs_bio.c:4566)</p>
<p>Kernel thread that flushes dirty buffers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buf_daemon</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="p">{</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">        </span><span class="cm">/* Sleep until work needed */</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">        </span><span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd_request</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;psleep&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hz</span><span class="p">);</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="w">        </span><span class="cm">/* Check if flushing needed */</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runningbufspace</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dirtykvaspace</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lodirtybufspace</span><span class="p">)</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="w">        </span><span class="cm">/* Flush dirty buffers */</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="w">        </span><span class="n">flushbufqueues</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">BQUEUE_DIRTY</span><span class="p">);</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="p">}</span>
</code></pre></div>
<h3 id="flushbufqueues-queue-flusher">flushbufqueues() - Queue Flusher<a class="headerlink" href="#flushbufqueues-queue-flusher" title="Permanent link">&para;</a></h3>
<p><strong>flushbufqueues()</strong> (vfs_bio.c:4330)</p>
<p>Scans a buffer queue and flushes dirty buffers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">flushbufqueues</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="n">bufq_type_t</span><span class="w"> </span><span class="n">q</span><span class="p">)</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="p">{</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flushed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">    </span><span class="cm">/* Scan per-CPU queues */</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncpus</span><span class="p">;</span><span class="w"> </span><span class="n">cpu</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">        </span><span class="n">TAILQ_FOREACH</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bufpcpu</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">bufqueues</span><span class="p">[</span><span class="n">q</span><span class="p">],</span><span class="w"> </span><span class="n">b_freelist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_MARKER</span><span class="p">)</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_DELWRI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w">                </span><span class="cm">/* Remove from queue */</span>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="w">                </span><span class="n">bremfree</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="w">                </span><span class="cm">/* Try to lock */</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BUF_LOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">LK_EXCLUSIVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LK_NOWAIT</span><span class="p">))</span>
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Skip if locked */</span>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="w">                </span><span class="cm">/* Cluster and write */</span>
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="w">                </span><span class="n">cluster_awrite</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="w">                </span><span class="n">flushed</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flushed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">flushperqueue</span><span class="p">)</span>
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Flushed enough */</span>
<a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>
<a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">flushed</span><span class="p">;</span>
<a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Flush triggers:</strong>
- <code>dirtybufspace &gt; hidirtybufspace</code> - High watermark exceeded
- System sync operation (sync(2) system call)
- Vnode reclamation (vnode has dirty buffers)
- Filesystem-specific sync (VFS_SYNC)</p>
<h3 id="vfs_sync-filesystem-sync">VFS_SYNC - Filesystem Sync<a class="headerlink" href="#vfs_sync-filesystem-sync" title="Permanent link">&para;</a></h3>
<p><strong>VFS_SYNC()</strong> vnode operation:</p>
<p>Called to sync a filesystem:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">VFS_SYNC</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">waitfor</span><span class="p">)</span>
</code></pre></div>
<p><strong>Typical implementation:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">myfs_sync</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">waitfor</span><span class="p">)</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="p">{</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="w">    </span><span class="cm">/* Sync inodes */</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="w">    </span><span class="n">myfs_sync_inodes</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="n">waitfor</span><span class="p">);</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">    </span><span class="cm">/* Scan dirty vnodes */</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="w">    </span><span class="n">sync_info</span><span class="p">.</span><span class="n">waitfor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitfor</span><span class="p">;</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="w">    </span><span class="n">vmntvnodescan</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="n">VMSC_GETVP</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">myfs_sync_callback</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sync_info</span><span class="p">);</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="w">    </span><span class="cm">/* Write superblock */</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="w">    </span><span class="n">myfs_write_superblock</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="p">}</span>
</code></pre></div>
<p><strong>waitfor values:</strong>
- <code>MNT_WAIT</code>: Wait for all I/O to complete
- <code>MNT_NOWAIT</code>: Initiate I/O but don't wait
- <code>MNT_LAZY</code>: Lazy sync (metadata only)</p>
<h2 id="page-cleaning">Page Cleaning<a class="headerlink" href="#page-cleaning" title="Permanent link">&para;</a></h2>
<h3 id="vfs_clean_pages-mark-pages-clean">vfs_clean_pages() - Mark Pages Clean<a class="headerlink" href="#vfs_clean_pages-mark-pages-clean" title="Permanent link">&para;</a></h3>
<p><strong>vfs_clean_pages()</strong> (vfs_bio.c:3980)</p>
<p>Marks VM pages clean after buffer written:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">vfs_clean_pages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="p">{</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_VMIO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_npages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">            </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_xio</span><span class="p">.</span><span class="n">xio_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">            </span><span class="n">vfs_clean_one_page</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="p">}</span>
</code></pre></div>
<p><strong>vfs_clean_one_page()</strong> (vfs_bio.c:4002):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">vfs_clean_one_page</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pageno</span><span class="p">,</span><span class="w"> </span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="p">{</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">soff</span><span class="p">,</span><span class="w"> </span><span class="n">eoff</span><span class="p">;</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">    </span><span class="cm">/* Calculate page-relative dirty range */</span>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="w">    </span><span class="n">soff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_dirtyoff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pageno</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="w">    </span><span class="n">eoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_dirtyend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pageno</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eoff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">soff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="w">        </span><span class="cm">/* Mark page range clean */</span>
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="w">        </span><span class="n">vm_page_set_valid</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">soff</span><span class="p">,</span><span class="w"> </span><span class="n">eoff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">soff</span><span class="p">);</span>
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="w">        </span><span class="n">vm_page_clear_dirty</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">soff</span><span class="p">,</span><span class="w"> </span><span class="n">eoff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">soff</span><span class="p">);</span>
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="p">}</span>
</code></pre></div>
<h3 id="page-validity">Page Validity<a class="headerlink" href="#page-validity" title="Permanent link">&para;</a></h3>
<p>VM pages have validity bits tracking which parts contain valid data:</p>
<p><strong>vm_page-&gt;valid</strong> bitmask:
- One bit per 512-byte sector (DEV_BSIZE)
- <code>VM_PAGE_BITS_ALL</code> (0xFF): Entire page valid
- Partial validity supported</p>
<p><strong>vm_page_set_valid()</strong>: Sets validity bits for byte range</p>
<p><strong>vm_page_clear_dirty()</strong>: Clears dirty bits for byte range</p>
<h2 id="kvabio-api">KVABIO API<a class="headerlink" href="#kvabio-api" title="Permanent link">&para;</a></h2>
<h3 id="overview_2">Overview<a class="headerlink" href="#overview_2" title="Permanent link">&para;</a></h3>
<p>KVABIO (Kernel Virtual Address BIO) allows efficient buffer access across CPUs without explicit synchronization.</p>
<p><strong>Problem</strong>: Regular buffers (b_data) may be accessed via different CPUs:
- Data written on CPU0
- Buffer passed to CPU1
- CPU1 reads stale data from cache</p>
<p><strong>Solution</strong>: KVABIO API provides:
- Explicit synchronization primitives
- Per-CPU data mapping tracking
- Automatic cache coherency</p>
<h3 id="kvabio-functions">KVABIO Functions<a class="headerlink" href="#kvabio-functions" title="Permanent link">&para;</a></h3>
<p><strong>bkvasync()</strong> (vfs_bio.c):</p>
<p>Synchronizes buffer data for current CPU:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">bkvasync</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="p">{</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_KVABIO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="w">        </span><span class="cm">/* Ensure data visible to current CPU */</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="w">        </span><span class="n">cpu_lfence</span><span class="p">();</span><span class="w">  </span><span class="cm">/* Load fence */</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="p">}</span>
</code></pre></div>
<p><strong>bkvasync_all()</strong> (vfs_bio.c):</p>
<p>Synchronizes buffer data for all CPUs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">bkvasync_all</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="p">{</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_KVABIO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="w">        </span><span class="cm">/* Flush to all CPUs */</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="w">        </span><span class="n">cpu_sfence</span><span class="p">();</span><span class="w">  </span><span class="cm">/* Store fence */</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">        </span><span class="cm">/* IPI to other CPUs if needed */</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Usage:</strong>
- Call bkvasync() before reading bp-&gt;b_data
- Call bkvasync_all() after writing bp-&gt;b_data
- Only needed for B_KVABIO buffers</p>
<h2 id="performance-considerations">Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permanent link">&para;</a></h2>
<h3 id="buffer-cache-sizing">Buffer Cache Sizing<a class="headerlink" href="#buffer-cache-sizing" title="Permanent link">&para;</a></h3>
<p><strong>Optimal buffer cache size:</strong>
- Default: ~10% of physical RAM
- Minimum (lobufspace): 4 MB
- Maximum (maxbufspace): Computed from available RAM
- Adjust via sysctl: <code>vfs.maxbufspace</code>, <code>vfs.hibufspace</code></p>
<p><strong>Trade-offs:</strong>
- Larger cache: Better hit rate, less I/O
- Smaller cache: More RAM for VM page cache
- Balance based on workload</p>
<h3 id="dirty-buffer-limits">Dirty Buffer Limits<a class="headerlink" href="#dirty-buffer-limits" title="Permanent link">&para;</a></h3>
<p><strong>Configure dirty limits:</strong>
- <code>vfs.lodirtybufspace</code>: When to start flushing (default: ~5% RAM)
- <code>vfs.hidirtybufspace</code>: Aggressive flushing (default: ~10% RAM)
- <code>vfs.dirtybufspace</code>: Current dirty space (read-only)</p>
<p><strong>Why limit dirty buffers?</strong>
- Prevent memory exhaustion
- Bound data loss on crash
- Ensure write progress
- Avoid sync stalls</p>
<h3 id="read-ahead-tuning">Read-ahead Tuning<a class="headerlink" href="#read-ahead-tuning" title="Permanent link">&para;</a></h3>
<p><strong>Sequential detection:</strong>
- Tracked via seqcount (0-127)
- Scales read-ahead: seqcount * blksize
- Maximum read-ahead: MAXPHYS (128KB typically)</p>
<p><strong>Read-ahead benefits:</strong>
- Hides disk latency
- Improves streaming performance
- Minimal overhead for random access</p>
<p><strong>Disable read-ahead:</strong>
- For random workloads
- Flash storage with fast random access
- Set <code>vfs.read_max</code> lower</p>
<h3 id="write-clustering">Write Clustering<a class="headerlink" href="#write-clustering" title="Permanent link">&para;</a></h3>
<p><strong>Enable clustering:</strong>
- Filesystem sets B_CLUSTEROK on buffers
- bdwrite() for delayed writes
- buf_daemon clusters during flush</p>
<p><strong>Benefits:</strong>
- Reduces write overhead
- Larger I/O sizes
- Better disk scheduling</p>
<p><strong>When not to cluster:</strong>
- Synchronous writes (bwrite)
- Small files (&lt;128KB)
- Random write patterns</p>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<h3 id="io-errors">I/O Errors<a class="headerlink" href="#io-errors" title="Permanent link">&para;</a></h3>
<p><strong>Error propagation:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="cm">/* I/O completes with error */</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="n">biodone</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">BIO_ERROR</span><span class="p">;</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EIO</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Or specific error */</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_ERROR</span><span class="p">;</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="w">    </span><span class="n">bufdone</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="p">}</span>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="cm">/* Sync I/O: Error returned */</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biowait</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;biord&quot;</span><span class="p">);</span>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>
<a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a><span class="cm">/* Async I/O: Error logged, buffer marked invalid */</span>
<a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a><span class="n">biodone</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">B_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a><span class="w">        </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_INVAL</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Invalidate */</span>
<a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a><span class="w">        </span><span class="cm">/* Error may be logged by filesystem */</span>
<a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a><span class="p">}</span>
</code></pre></div>
<h3 id="retry-strategies">Retry Strategies<a class="headerlink" href="#retry-strategies" title="Permanent link">&para;</a></h3>
<p><strong>Filesystem-level retry:</strong>
- VFS layers don't retry automatically
- Filesystem must detect error and retry
- Example: NFS retries on EIO</p>
<p><strong>User-level retry:</strong>
- read(2)/write(2) return -1 with errno
- Application decides retry policy</p>
<h2 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">&para;</a></h2>
<h3 id="buffer-state-inspection">Buffer State Inspection<a class="headerlink" href="#buffer-state-inspection" title="Permanent link">&para;</a></h3>
<p><strong>DDB commands</strong> (when kernel debugger active):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>db&gt; show buffer &lt;addr&gt;       # Display buffer state
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>db&gt; show allbufs             # List all buffers
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>db&gt; show lockedbufs          # List locked buffers
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>db&gt; show dirtybufs           # List dirty buffers
</code></pre></div>
<p><strong>Sysctl inspection:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1"># Buffer cache statistics</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>sysctl<span class="w"> </span>vfs.nbuf<span class="w">              </span><span class="c1"># Total buffers</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>sysctl<span class="w"> </span>vfs.bufspace<span class="w">          </span><span class="c1"># Current space used</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>sysctl<span class="w"> </span>vfs.dirtybufspace<span class="w">     </span><span class="c1"># Dirty buffer space</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>sysctl<span class="w"> </span>vfs.dirtybufcount<span class="w">     </span><span class="c1"># Dirty buffer count</span>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>sysctl<span class="w"> </span>vfs.runningbufspace<span class="w">   </span><span class="c1"># Running I/O space</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>sysctl<span class="w"> </span>vfs.runningbufcount<span class="w">   </span><span class="c1"># Running I/O count</span>
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="c1"># Tuning parameters</span>
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>sysctl<span class="w"> </span>vfs.maxbufspace<span class="w">       </span><span class="c1"># Max buffer space</span>
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>sysctl<span class="w"> </span>vfs.hibufspace<span class="w">        </span><span class="c1"># High watermark</span>
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>sysctl<span class="w"> </span>vfs.lodirtybufspace<span class="w">   </span><span class="c1"># Dirty low watermark</span>
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>sysctl<span class="w"> </span>vfs.hidirtybufspace<span class="w">   </span><span class="c1"># Dirty high watermark</span>
</code></pre></div>
<h3 id="common-issues">Common Issues<a class="headerlink" href="#common-issues" title="Permanent link">&para;</a></h3>
<p><strong>Issue: System hangs during sync</strong>
- Cause: Deadlock in buffer allocation
- Debug: Check runningbufspace vs hirunningspace
- Solution: Increase vfs.hirunningspace</p>
<p><strong>Issue: Poor write performance</strong>
- Cause: Not clustering writes
- Debug: Check if B_CLUSTEROK set on buffers
- Solution: Enable write clustering in filesystem</p>
<p><strong>Issue: Excessive read-ahead</strong>
- Cause: High seqcount on random workload
- Debug: Monitor vfs.lowmempgallocs
- Solution: Reduce MAXPHYS or tune read-ahead</p>
<p><strong>Issue: Buffer cache thrashing</strong>
- Cause: Working set larger than cache
- Debug: Monitor vfs.getnewbufcalls
- Solution: Increase vfs.maxbufspace</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>The VFS buffer cache is a sophisticated subsystem providing:</p>
<ol>
<li><strong>Caching</strong>: Filesystem block caching with LRU eviction</li>
<li><strong>I/O Management</strong>: Sync/async I/O primitives (bread, bwrite, bdwrite)</li>
<li><strong>VM Integration</strong>: Unified buffer/page cache via VMIO</li>
<li><strong>Clustering</strong>: Read-ahead and write clustering for performance</li>
<li><strong>Dirty Tracking</strong>: Write-behind with configurable watermarks</li>
<li><strong>Multi-threading</strong>: Per-CPU queues and dedicated flush threads</li>
<li><strong>Flexibility</strong>: BIO layer enables device stacking and transformation</li>
</ol>
<p>The buffer cache sits at a critical junction between filesystems, the VM system, and device drivers, providing high-performance cached I/O while maintaining data consistency and integrity.</p>
<p>Key design principles:
- <strong>Lock-free fast paths</strong>: Atomic operations and per-CPU structures
- <strong>Unified caching</strong>: VMIO integrates buffer and page caches
- <strong>Asynchronous I/O</strong>: Pipeline writes, overlap operations
- <strong>Adaptive behavior</strong>: Sequential detection, watermark-based flushing
- <strong>Layered I/O</strong>: BIO translation enables complex storage stacks</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>