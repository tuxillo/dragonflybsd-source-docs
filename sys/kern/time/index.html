
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive documentation for the DragonFly BSD kernel source code">
      
      
        <meta name="author" content="DragonFly BSD Community">
      
      
      
        <link rel="prev" href="../synchronization/">
      
      
        <link rel="next" href="../memory/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Time & Timers - DragonFly BSD Kernel Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#time-and-timer-subsystems" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Time & Timers
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  Kernel Subsystems

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DragonFly BSD Kernel Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lwkt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../synchronization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Time & Timers
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Time & Timers
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-source-files" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Source Files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design Principles
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Concepts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-types-and-frequencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clock Types and Frequencies
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Clock Types and Frequencies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardclock-main-system-clock" class="md-nav__link">
    <span class="md-ellipsis">
      
        hardclock (Main System Clock)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statclock-statistics-clock" class="md-nav__link">
    <span class="md-ellipsis">
      
        statclock (Statistics Clock)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schedclock-scheduler-clock" class="md-nav__link">
    <span class="md-ellipsis">
      
        schedclock (Scheduler Clock)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Timer Types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Timer Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cputimer-hardware-timer-abstraction" class="md-nav__link">
    <span class="md-ellipsis">
      
        cputimer (Hardware Timer Abstraction)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer-software-timer" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer (Software Timer)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-timeout-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout (Timeout Mechanism)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-bases-and-representation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Bases and Representation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Time Bases and Representation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#realtime-wall-clock-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        Realtime (Wall Clock Time)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monotonic-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monotonic Time
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uptime" class="md-nav__link">
    <span class="md-ellipsis">
      
        Uptime
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-time-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Time State
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntp-time-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        NTP Time Adjustment
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Structures
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-cputimer" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct cputimer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-systimer" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct systimer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-callout-and-struct-_callout" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct callout and struct _callout
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="struct callout and struct _callout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#frontend-struct-callout" class="md-nav__link">
    <span class="md-ellipsis">
      
        Frontend: struct callout
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend-struct-_callout" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend: struct _callout
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-wheel-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callout Wheel Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-representation-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Representation Types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Time Representation Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-timeval-traditional-bsd" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct timeval (Traditional BSD)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-timespec-posix" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct timespec (POSIX)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysclock_t-internal-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      
        sysclock_t (Internal Kernel)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sbintime_t-signed-binary-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        sbintime_t (Signed Binary Time)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#global-time-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Time Variables
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardware-timer-registration-and-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hardware Timer Registration and Selection
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hardware Timer Registration and Selection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cputimer_register" class="md-nav__link">
    <span class="md-ellipsis">
      
        cputimer_register()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cputimer_select" class="md-nav__link">
    <span class="md-ellipsis">
      
        cputimer_select()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-timer-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Timer Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Timer Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#systimer_init_periodic" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_init_periodic()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer_init_periodic_nq" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_init_periodic_nq()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer_add" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_add()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer_del" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_del()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callout Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Callout Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#callout_init" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_init()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout_reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_reset()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout_stop" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_stop()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout_terminate" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_terminate()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-retrieval-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Retrieval Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Time Retrieval Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getmicrotime-getnanotime" class="md-nav__link">
    <span class="md-ellipsis">
      
        getmicrotime() / getnanotime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microtime-nanotime" class="md-nav__link">
    <span class="md-ellipsis">
      
        microtime() / nanotime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getmicrouptime-getnanouptime" class="md-nav__link">
    <span class="md-ellipsis">
      
        getmicrouptime() / getnanouptime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microuptime-nanouptime" class="md-nav__link">
    <span class="md-ellipsis">
      
        microuptime() / nanouptime()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Calls
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sys_clock_gettime" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_clock_gettime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sys_nanosleep" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_nanosleep()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sys_gettimeofday" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_gettimeofday()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sys_adjtime-sys_ntp_adjtime" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_adjtime() / sys_ntp_adjtime()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-flow-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Flow Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Flow Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-callout-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 1: Callout Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-hardclock-processing-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 2: Hardclock Processing Flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-callout-wheel-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 3: Callout Wheel Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-4-ntp-time-adjustment-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 4: NTP Time Adjustment Flow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-timer-facilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choosing Timer Facilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-usage-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callout Usage Guidelines
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-retrieval-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Retrieval Guidelines
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntp-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        NTP Considerations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      
        See Also
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../initialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Initialization & Bootstrap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processes & Threads
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Resources & Credentials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../signals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2_11" >
        
          
          <label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/namecache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Name Lookup & Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/mounting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mounting & Unmounting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/buffer-cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Buffer Cache & I/O
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/vfs-operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/journaling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ipc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IPC & Sockets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Devices & Drivers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../syscalls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cpu/x86_64/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-source-files" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Source Files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design Principles
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Concepts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-types-and-frequencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clock Types and Frequencies
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Clock Types and Frequencies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardclock-main-system-clock" class="md-nav__link">
    <span class="md-ellipsis">
      
        hardclock (Main System Clock)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statclock-statistics-clock" class="md-nav__link">
    <span class="md-ellipsis">
      
        statclock (Statistics Clock)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schedclock-scheduler-clock" class="md-nav__link">
    <span class="md-ellipsis">
      
        schedclock (Scheduler Clock)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Timer Types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Timer Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cputimer-hardware-timer-abstraction" class="md-nav__link">
    <span class="md-ellipsis">
      
        cputimer (Hardware Timer Abstraction)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer-software-timer" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer (Software Timer)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-timeout-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout (Timeout Mechanism)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-bases-and-representation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Bases and Representation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Time Bases and Representation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#realtime-wall-clock-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        Realtime (Wall Clock Time)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monotonic-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monotonic Time
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uptime" class="md-nav__link">
    <span class="md-ellipsis">
      
        Uptime
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-time-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Time State
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntp-time-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        NTP Time Adjustment
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Structures
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-cputimer" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct cputimer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-systimer" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct systimer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-callout-and-struct-_callout" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct callout and struct _callout
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="struct callout and struct _callout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#frontend-struct-callout" class="md-nav__link">
    <span class="md-ellipsis">
      
        Frontend: struct callout
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend-struct-_callout" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend: struct _callout
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-wheel-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callout Wheel Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-representation-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Representation Types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Time Representation Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-timeval-traditional-bsd" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct timeval (Traditional BSD)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct-timespec-posix" class="md-nav__link">
    <span class="md-ellipsis">
      
        struct timespec (POSIX)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sysclock_t-internal-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      
        sysclock_t (Internal Kernel)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sbintime_t-signed-binary-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        sbintime_t (Signed Binary Time)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#global-time-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Time Variables
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardware-timer-registration-and-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hardware Timer Registration and Selection
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hardware Timer Registration and Selection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cputimer_register" class="md-nav__link">
    <span class="md-ellipsis">
      
        cputimer_register()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cputimer_select" class="md-nav__link">
    <span class="md-ellipsis">
      
        cputimer_select()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-timer-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Timer Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Timer Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#systimer_init_periodic" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_init_periodic()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer_init_periodic_nq" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_init_periodic_nq()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer_add" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_add()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systimer_del" class="md-nav__link">
    <span class="md-ellipsis">
      
        systimer_del()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callout Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Callout Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#callout_init" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_init()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout_reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_reset()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout_stop" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_stop()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout_terminate" class="md-nav__link">
    <span class="md-ellipsis">
      
        callout_terminate()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-retrieval-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Retrieval Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Time Retrieval Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getmicrotime-getnanotime" class="md-nav__link">
    <span class="md-ellipsis">
      
        getmicrotime() / getnanotime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microtime-nanotime" class="md-nav__link">
    <span class="md-ellipsis">
      
        microtime() / nanotime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getmicrouptime-getnanouptime" class="md-nav__link">
    <span class="md-ellipsis">
      
        getmicrouptime() / getnanouptime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microuptime-nanouptime" class="md-nav__link">
    <span class="md-ellipsis">
      
        microuptime() / nanouptime()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Calls
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sys_clock_gettime" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_clock_gettime()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sys_nanosleep" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_nanosleep()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sys_gettimeofday" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_gettimeofday()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sys_adjtime-sys_ntp_adjtime" class="md-nav__link">
    <span class="md-ellipsis">
      
        sys_adjtime() / sys_ntp_adjtime()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-flow-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Flow Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Flow Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-callout-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 1: Callout Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-hardclock-processing-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 2: Hardclock Processing Flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-callout-wheel-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 3: Callout Wheel Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-4-ntp-time-adjustment-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 4: NTP Time Adjustment Flow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-timer-facilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choosing Timer Facilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callout-usage-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callout Usage Guidelines
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-retrieval-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time Retrieval Guidelines
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntp-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        NTP Considerations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      
        See Also
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="time-and-timer-subsystems">Time and Timer Subsystems<a class="headerlink" href="#time-and-timer-subsystems" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The DragonFly BSD kernel implements a sophisticated multi-layered timekeeping architecture that provides both system-wide and per-CPU timing facilities. The design separates hardware timer abstraction from software timer services, enabling flexible and efficient time management across different hardware platforms.</p>
<h3 id="architecture-layers">Architecture Layers<a class="headerlink" href="#architecture-layers" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  User Applications (syscalls: gettimeofday, nanosleep, etc) 
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                            
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>  Time Representation (timeval, timespec, sbintime_t)        
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                            
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  Callout/Timeout Mechanism (kern_timeout.c)                 
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>  - Wheel-based per-CPU callout queues                       
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>  - Frontend (struct callout) / Backend (struct _callout)    
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                            
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>  System Timer Infrastructure (kern_systimer.c)              
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>  - Software timers built on hardware abstraction            
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>  - Periodic and one-shot timer support                      
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                            
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>  Clock Interrupts (kern_clock.c)                            
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>  - hardclock() - Main system clock at hz (100Hz)            
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>  - statclock() - Statistics clock at stathz (128Hz)         
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>  - schedclock() - Scheduler clock at 50Hz                   
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                            
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>  Hardware Timer Abstraction (kern_cputimer.c)               
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>  - struct cputimer with count() method                      
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>  - Registration and selection of hardware timers            
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>  - Examples: TSC, i8254, ACPI-fast, HPET                    
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                            
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>  Hardware Timers (TSC, HPET, i8254, ACPI-fast, etc)        
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
</code></pre></div>
<h3 id="key-source-files">Key Source Files<a class="headerlink" href="#key-source-files" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kern_clock.c</code></td>
<td>1866</td>
<td>System clock interrupts, hardclock, statclock, schedclock, NTP adjustment</td>
</tr>
<tr>
<td><code>kern_cputimer.c</code></td>
<td>673</td>
<td>Hardware timer abstraction layer (cputimer)</td>
</tr>
<tr>
<td><code>kern_systimer.c</code></td>
<td>418</td>
<td>Software timer infrastructure built on cputimer</td>
</tr>
<tr>
<td><code>kern_timeout.c</code></td>
<td>1153</td>
<td>Callout/timeout mechanism with wheel-based implementation</td>
</tr>
<tr>
<td><code>kern_time.c</code></td>
<td>1247</td>
<td>Time-related system calls (gettimeofday, nanosleep, etc.)</td>
</tr>
<tr>
<td><code>kern_ntptime.c</code></td>
<td>872</td>
<td>NTP time adjustment with PLL/FLL</td>
</tr>
</tbody>
</table>
<h3 id="design-principles">Design Principles<a class="headerlink" href="#design-principles" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Hardware Independence</strong>: The cputimer abstraction allows the kernel to work with different hardware timer sources without modifying upper layers.</p>
</li>
<li>
<p><strong>Per-CPU Scalability</strong>: Most timing facilities are per-CPU to minimize lock contention and cache line bouncing.</p>
</li>
<li>
<p><strong>Multiple Time Bases</strong>: The kernel maintains several time representations:</p>
</li>
<li><strong>Realtime</strong> (<code>gettimeofday</code>): Wall clock time, affected by NTP adjustments</li>
<li><strong>Monotonic</strong> (<code>clock_gettime(CLOCK_MONOTONIC)</code>): Always increasing, not affected by time adjustments</li>
<li>
<p><strong>Uptime</strong>: Time since boot, not affected by suspend/resume</p>
</li>
<li>
<p><strong>Lazy Updates</strong>: Many time globals are updated passively to minimize overhead (e.g., <code>time_second</code>, <code>time_uptime</code>).</p>
</li>
<li>
<p><strong>NTP Integration</strong>: Built-in support for Network Time Protocol adjustments using phase-locked loop (PLL) and frequency-locked loop (FLL) algorithms.</p>
</li>
</ol>
<h2 id="key-concepts">Key Concepts<a class="headerlink" href="#key-concepts" title="Permanent link">&para;</a></h2>
<h3 id="clock-types-and-frequencies">Clock Types and Frequencies<a class="headerlink" href="#clock-types-and-frequencies" title="Permanent link">&para;</a></h3>
<p>DragonFly BSD uses three main periodic clock interrupts, each with a different frequency and purpose:</p>
<h4 id="hardclock-main-system-clock">hardclock (Main System Clock)<a class="headerlink" href="#hardclock-main-system-clock" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Frequency</strong>: <code>hz</code> (typically 100 Hz, configurable)</li>
<li><strong>Function</strong>: <code>hardclock()</code> in kern_clock.c:552</li>
<li><strong>Purpose</strong>: </li>
<li>Updates master tick counter (<code>ticks</code>, <code>sbticks</code>)</li>
<li>Advances global time values (<code>time_second</code>, <code>time_uptime</code>)</li>
<li>Processes callouts (timeouts)</li>
<li>Handles NTP time adjustments</li>
<li>Per-CPU scheduling accounting</li>
<li><strong>Per-CPU State</strong>: <code>gd-&gt;gd_hardclock</code> (struct systimer)</li>
</ul>
<p>The hardclock is the primary system heartbeat. It runs on each CPU and coordinates time advancement across the system.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="cm">/*</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="cm"> * Hardclock runs on each CPU at hz frequency (typically 100Hz).</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="cm"> * Updates time, processes timeouts, and performs per-CPU bookkeeping.</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="cm"> */</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="nf">hardclock</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">in_ipi</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">intrframe</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="p">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="cm">/* Update tick counters */</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="n">ticks</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="n">sbticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mftb</span><span class="p">();</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="cm">/* Update passive time globals */</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_time_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">basetime</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tv_sec</span><span class="p">;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="cm">/* Process callouts for this CPU */</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="n">softclock</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">in_ipi</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="cm">/* Scheduling and accounting */</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="p">}</span>
</code></pre></div>
<h4 id="statclock-statistics-clock">statclock (Statistics Clock)<a class="headerlink" href="#statclock-statistics-clock" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Frequency</strong>: <code>stathz</code> (typically 128 Hz, default; or profhz for profiling)</li>
<li><strong>Function</strong>: <code>statclock()</code> in kern_clock.c:892</li>
<li><strong>Purpose</strong>:</li>
<li>CPU usage statistics (user/system time)</li>
<li>Profiling support</li>
<li>Randomized to prevent synchronization with hardclock</li>
<li>Per-process and per-thread accounting</li>
<li><strong>Per-CPU State</strong>: <code>gd-&gt;gd_statclock</code> (struct systimer)</li>
</ul>
<p>The statclock runs at a slightly different frequency than hardclock to provide statistical sampling that doesn't synchronize with the main clock. This prevents phase-locking artifacts in profiling data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="cm">/*</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="cm"> * Statclock collects CPU usage statistics.</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="cm"> * Frequency is randomized to prevent phase locking with hardclock.</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="cm"> */</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="nf">statclock</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">in_ipi</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">intrframe</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="p">{</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread</span><span class="w"> </span><span class="o">*</span><span class="n">td</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curthread</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_proc</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="cm">/* Account CPU time to current thread/process */</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CLKF_USERMODE</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_uticks</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_nice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">NZERO</span><span class="p">)</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">            </span><span class="n">cp_time</span><span class="p">[</span><span class="n">CP_NICE</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">            </span><span class="n">cp_time</span><span class="p">[</span><span class="n">CP_USER</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_sticks</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">        </span><span class="n">cp_time</span><span class="p">[</span><span class="n">CP_SYS</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">    </span><span class="cm">/* Profiling support */</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_profthreads</span><span class="p">)</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">        </span><span class="n">addupc_intr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">CLKF_PC</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="p">}</span>
</code></pre></div>
<h4 id="schedclock-scheduler-clock">schedclock (Scheduler Clock)<a class="headerlink" href="#schedclock-scheduler-clock" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Frequency</strong>: 50 Hz (fixed)</li>
<li><strong>Function</strong>: <code>schedclock()</code> in kern_clock.c:1028</li>
<li><strong>Purpose</strong>:</li>
<li>Scheduler hint processing</li>
<li>Thread priority recalculation</li>
<li>Load balancing decisions</li>
<li><strong>Per-CPU State</strong>: <code>gd-&gt;gd_schedclock</code> (struct systimer)</li>
</ul>
<p>The schedclock runs at a lower frequency than the other clocks, handling less time-critical scheduler operations.</p>
<h3 id="timer-types">Timer Types<a class="headerlink" href="#timer-types" title="Permanent link">&para;</a></h3>
<h4 id="cputimer-hardware-timer-abstraction">cputimer (Hardware Timer Abstraction)<a class="headerlink" href="#cputimer-hardware-timer-abstraction" title="Permanent link">&para;</a></h4>
<p>The <code>cputimer</code> is a hardware abstraction that provides a consistent interface to various hardware timer sources.</p>
<p><strong>Key Operations</strong>:
- <code>count()</code>: Read current timer value (monotonically increasing)
- <code>fromhz(hz)</code>: Convert frequency to timer units
- <code>fromus(us)</code>: Convert microseconds to timer units
- <code>fromnano(ns)</code>: Convert nanoseconds to timer units</p>
<p><strong>Common Hardware Timers</strong>:
- <strong>TSC</strong> (Time Stamp Counter): Per-CPU cycle counter on x86
- <strong>HPET</strong> (High Precision Event Timer): Modern high-resolution timer
- <strong>i8254</strong>: Legacy PC timer (8254 PIT)
- <strong>ACPI-fast</strong>: ACPI power management timer</p>
<p><strong>Selection</strong>: The kernel selects the best available cputimer based on quality rating (see <code>cputimer_register()</code> in kern_cputimer.c:291).</p>
<h4 id="systimer-software-timer">systimer (Software Timer)<a class="headerlink" href="#systimer-software-timer" title="Permanent link">&para;</a></h4>
<p>The <code>systimer</code> builds software timer facilities on top of the hardware cputimer abstraction.</p>
<p><strong>Types</strong>:
- <strong>Periodic</strong>: Fires at regular intervals (used by hardclock, statclock, schedclock)
- <strong>One-shot</strong>: Fires once at a specified time (used internally)</p>
<p><strong>Key Functions</strong>:
- <code>systimer_init_periodic()</code> (kern_systimer.c:292): Create periodic timer
- <code>systimer_init_periodic_nq()</code> (kern_systimer.c:317): Create periodic timer without initial queue
- <code>systimer_add()</code>: Add timer to active queue
- <code>systimer_del()</code>: Remove timer from queue</p>
<p>Each CPU maintains its own systimer queue to avoid lock contention.</p>
<h4 id="callout-timeout-mechanism">callout (Timeout Mechanism)<a class="headerlink" href="#callout-timeout-mechanism" title="Permanent link">&para;</a></h4>
<p>Callouts provide a high-level timeout mechanism for scheduling function calls in the future.</p>
<p><strong>Key Features</strong>:
- <strong>Wheel-based algorithm</strong>: O(1) insertion and deletion using a timing wheel
- <strong>Per-CPU wheels</strong>: Separate callout wheels per CPU for scalability
- <strong>Two-tier structure</strong>:
  - <strong>Frontend</strong>: <code>struct callout</code> - Embedded in client structures
  - <strong>Backend</strong>: <code>struct _callout</code> - Actual queued element with wheel linkage
- <strong>Flags support</strong>: <code>CALLOUT_MPSAFE</code>, <code>CALLOUT_ACTIVE</code>, etc.</p>
<p><strong>Common Use Cases</strong>:
- Network packet timeouts
- Device driver timeouts
- Timed events in kernel subsystems</p>
<h3 id="time-bases-and-representation">Time Bases and Representation<a class="headerlink" href="#time-bases-and-representation" title="Permanent link">&para;</a></h3>
<p>DragonFly maintains several time bases for different purposes:</p>
<h4 id="realtime-wall-clock-time">Realtime (Wall Clock Time)<a class="headerlink" href="#realtime-wall-clock-time" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Source</strong>: <code>basetime[]</code> FIFO in kern_clock.c</li>
<li><strong>Representation</strong>: <code>struct timespec</code> (seconds + nanoseconds)</li>
<li><strong>Access</strong>: <code>gettimeofday()</code>, <code>clock_gettime(CLOCK_REALTIME)</code></li>
<li><strong>Characteristics</strong>: Can jump forward/backward with NTP adjustments</li>
</ul>
<p>The <code>basetime</code> array is a FIFO that allows the NTP code to adjust time without holding locks during the entire hardclock interrupt.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="cm">/*</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="cm"> * basetime[] is a FIFO of 16 entries that stores real time.</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="cm"> * NTP adjustments update the write pointer, hardclock reads</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="cm"> * from the read pointer.</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="cm"> */</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">basetime</span><span class="p">[</span><span class="n">BASETIME_ARYSIZE</span><span class="p">];</span><span class="w">  </span><span class="cm">/* FIFO */</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">basetime_index</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Read pointer */</span>
</code></pre></div>
<h4 id="monotonic-time">Monotonic Time<a class="headerlink" href="#monotonic-time" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Source</strong>: <code>gd-&gt;gd_cpuclock_base</code> + cputimer count</li>
<li><strong>Access</strong>: <code>clock_gettime(CLOCK_MONOTONIC)</code>, <code>nanouptime()</code></li>
<li><strong>Characteristics</strong>: Always increases, never affected by time adjustments</li>
</ul>
<p>Monotonic time is ideal for measuring intervals because it's immune to clock adjustments.</p>
<h4 id="uptime">Uptime<a class="headerlink" href="#uptime" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Source</strong>: <code>time_uptime</code> global, updated in hardclock</li>
<li><strong>Access</strong>: Direct global variable access (for kernel code)</li>
<li><strong>Characteristics</strong>: Seconds since boot, low-resolution</li>
</ul>
<h3 id="per-cpu-time-state">Per-CPU Time State<a class="headerlink" href="#per-cpu-time-state" title="Permanent link">&para;</a></h3>
<p>Each CPU maintains timing state in its <code>globaldata</code> structure (see <code>sys/sys/globaldata.h</code>):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">globaldata</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="cm">/* Passive time values (updated in hardclock) */</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="kt">time_t</span><span class="w">          </span><span class="n">gd_time_seconds</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Cached time_second */</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="kt">time_t</span><span class="w">          </span><span class="n">gd_time_uptime</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Cached time_uptime */</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="cm">/* High-precision time base */</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w">      </span><span class="n">gd_cpuclock_base</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Monotonic base for this CPU */</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="cm">/* System clocks (periodic systimers) */</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">systimer</span><span class="w"> </span><span class="n">gd_hardclock</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Main clock at hz */</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">systimer</span><span class="w"> </span><span class="n">gd_statclock</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Stats clock at stathz */</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">systimer</span><span class="w"> </span><span class="n">gd_schedclock</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Scheduler clock at 50Hz */</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">    </span><span class="cm">/* Callout wheel for this CPU */</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">    </span><span class="cm">/* (see struct _callout_tailq in kern_timeout.c) */</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="p">};</span>
</code></pre></div>
<h3 id="ntp-time-adjustment">NTP Time Adjustment<a class="headerlink" href="#ntp-time-adjustment" title="Permanent link">&para;</a></h3>
<p>The kernel includes a sophisticated NTP implementation (<code>kern_ntptime.c</code>) that adjusts system time gradually to synchronize with network time sources.</p>
<p><strong>Key Components</strong>:
- <strong>PLL</strong> (Phase-Locked Loop): Adjusts time based on phase error
- <strong>FLL</strong> (Frequency-Locked Loop): Adjusts frequency based on long-term drift
- <strong>Adaptive switching</strong>: Automatically switches between PLL and FLL based on conditions</p>
<p><strong>System Calls</strong>:
- <code>ntp_adjtime()</code>: User-space interface to NTP adjustment (sys/timex.h)
- <code>adjtime()</code>: Legacy BSD interface for time adjustment</p>
<p><strong>Time Adjustment Variables</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">long</span><span class="w"> </span><span class="n">time_tick</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Nominal tick in us */</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kt">long</span><span class="w"> </span><span class="n">time_adjtime</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Adjustment remaining (us) */</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kt">int64_t</span><span class="w"> </span><span class="n">time_offset</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Current offset for NTP (ns scaled) */</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kt">long</span><span class="w"> </span><span class="n">time_freq</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Frequency adjustment (scaled ppm) */</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="kt">long</span><span class="w"> </span><span class="n">time_maxerror</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Maximum error (us) */</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="kt">long</span><span class="w"> </span><span class="n">time_esterror</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Estimated error (us) */</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="kt">int</span><span class="w"> </span><span class="n">time_status</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Clock status flags */</span>
</code></pre></div></p>
<p>The NTP code runs as part of hardclock and makes small adjustments to <code>basetime[]</code> to gradually bring the system clock in sync with the reference time source.</p>
<h2 id="data-structures">Data Structures<a class="headerlink" href="#data-structures" title="Permanent link">&para;</a></h2>
<h3 id="struct-cputimer">struct cputimer<a class="headerlink" href="#struct-cputimer" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/sys/systimer.h</code></p>
<p>The <code>cputimer</code> structure provides a hardware-independent interface to various timer sources.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">cputimer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="n">SLIST_ENTRY</span><span class="p">(</span><span class="n">cputimer</span><span class="p">)</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Timer name (e.g., &quot;TSC&quot;, &quot;HPET&quot;) */</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pri</span><span class="p">;</span><span class="w">                    </span><span class="cm">/* Priority for selection */</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Timer type flags */</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">freq</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Timer frequency in Hz */</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Read current count */</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fromhz</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Convert hz to timer units */</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fromus</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Convert microseconds to timer units */</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fromnano</span><span class="p">)(</span><span class="kt">int64_t</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Convert nanoseconds to timer units */</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">construct</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cputimer</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sysclock_t</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Constructor */</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">destruct</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cputimer</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w">              </span><span class="cm">/* Destructor */</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="n">freq64_count</span><span class="p">;</span><span class="w">    </span><span class="cm">/* For high-precision scaling */</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">freq64_nsec</span><span class="p">;</span><span class="w">        </span><span class="cm">/* For nanosecond conversion */</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Key Fields</strong>:</p>
<ul>
<li><strong><code>name</code></strong>: Human-readable timer name (e.g., "TSC", "HPET", "i8254", "ACPI-fast")</li>
<li><strong><code>pri</code></strong>: Priority for automatic selection (higher = preferred)</li>
<li><code>CPUTIMER_PRI_TSC</code> (1000) - TSC when synchronized</li>
<li><code>CPUTIMER_PRI_HPET</code> (900) - HPET</li>
<li><code>CPUTIMER_PRI_ACPI</code> (800) - ACPI PM timer</li>
<li><code>CPUTIMER_PRI_8254</code> (100) - Legacy 8254 PIT</li>
<li><code>CPUTIMER_PRI_DUMMY</code> (-1) - Placeholder</li>
<li><strong><code>freq</code></strong>: Timer frequency in Hz (used for time conversions)</li>
<li><strong><code>count()</code></strong>: Returns current monotonically-increasing timer count</li>
<li><strong><code>fromhz()</code>, <code>fromus()</code>, <code>fromnano()</code></strong>: Convert time units to timer ticks</li>
</ul>
<p><strong>Global Variables</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">cputimer</span><span class="w"> </span><span class="o">*</span><span class="n">sys_cputimer</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Currently selected timer */</span>
</code></pre></div></p>
<p><strong>Referenced in</strong>: kern_cputimer.c:54</p>
<h3 id="struct-systimer">struct systimer<a class="headerlink" href="#struct-systimer" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/sys/systimer.h</code></p>
<p>The <code>systimer</code> structure represents a software timer built on top of the cputimer hardware abstraction.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">systimer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="n">TAILQ_ENTRY</span><span class="p">(</span><span class="n">systimer</span><span class="p">)</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Queue linkage */</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="n">time</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Next fire time (absolute) */</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="n">periodic</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Period (0 = one-shot) */</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="n">sysclock_t</span><span class="w"> </span><span class="n">which</span><span class="p">;</span><span class="w">               </span><span class="cm">/* For load distribution */</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="n">systimer_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Callback function */</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* Callback argument */</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                      </span><span class="cm">/* Flags (periodic, etc.) */</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">globaldata</span><span class="w"> </span><span class="o">*</span><span class="n">gd</span><span class="p">;</span><span class="w">          </span><span class="cm">/* CPU this timer runs on */</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">freq</span><span class="p">;</span><span class="w">                       </span><span class="cm">/* For periodic timers */</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="p">};</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">systimer_func_t</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">systimer</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">intrframe</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
</code></pre></div>
<p><strong>Key Fields</strong>:</p>
<ul>
<li><strong><code>time</code></strong>: Absolute time when timer should fire (in sysclock_t units)</li>
<li><strong><code>periodic</code></strong>: If non-zero, timer fires repeatedly at this interval</li>
<li><strong><code>func</code></strong>: Callback function invoked when timer fires</li>
<li><strong><code>data</code></strong>: Opaque data passed to callback</li>
<li><strong><code>gd</code></strong>: Pointer to globaldata - specifies which CPU owns this timer</li>
<li><strong><code>freq</code></strong>: For periodic timers, the desired frequency</li>
</ul>
<p><strong>Timer Types</strong>:
- <strong>Periodic</strong>: Used for hardclock, statclock, schedclock
- <strong>One-shot</strong>: Used internally for callout wheel advancement</p>
<p><strong>Per-CPU Queue</strong>: Each CPU's <code>globaldata</code> contains a queue of active systimers.</p>
<p><strong>Referenced in</strong>: kern_systimer.c:292, kern_clock.c:552</p>
<h3 id="struct-callout-and-struct-_callout">struct callout and struct _callout<a class="headerlink" href="#struct-callout-and-struct-_callout" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/sys/callout.h</code></p>
<p>DragonFly uses a two-tier callout structure:</p>
<h4 id="frontend-struct-callout">Frontend: struct callout<a class="headerlink" href="#frontend-struct-callout" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">_callout</span><span class="w"> </span><span class="o">*</span><span class="n">lh</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Link head (backend pointer) */</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="p">};</span>
</code></pre></div>
<p>The frontend structure is embedded in client data structures (e.g., network mbuf, driver state). It's lightweight and only contains a pointer to the backend.</p>
<h4 id="backend-struct-_callout">Backend: struct _callout<a class="headerlink" href="#backend-struct-_callout" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_timeout.c:138 (internal structure)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">_callout</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">        </span><span class="n">TAILQ_ENTRY</span><span class="p">(</span><span class="n">_callout</span><span class="p">)</span><span class="w"> </span><span class="n">tq</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Wheel queue linkage */</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">_callout</span><span class="w"> </span><span class="o">*</span><span class="n">rq_next</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Free list linkage */</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">c_links</span><span class="p">;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c_lh</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Back-pointer to frontend */</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">softclock_pcpu</span><span class="w"> </span><span class="o">*</span><span class="n">c_base</span><span class="p">;</span><span class="w">      </span><span class="cm">/* CPU this callout runs on */</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">c_func</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w">             </span><span class="cm">/* Callback function */</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">c_arg</span><span class="p">;</span><span class="w">                        </span><span class="cm">/* Callback argument */</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c_time</span><span class="p">;</span><span class="w">                         </span><span class="cm">/* Wheel position (ticks) */</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c_flags</span><span class="p">;</span><span class="w">                        </span><span class="cm">/* Flags (see below) */</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Key Fields</strong>:</p>
<ul>
<li><strong><code>c_links.tq</code></strong>: Queue linkage for timing wheel</li>
<li><strong><code>c_lh</code></strong>: Back-pointer to the frontend callout structure</li>
<li><strong><code>c_base</code></strong>: Per-CPU softclock structure (identifies which CPU)</li>
<li><strong><code>c_func</code></strong>: Function to call when timer expires</li>
<li><strong><code>c_arg</code></strong>: Argument passed to callback function</li>
<li><strong><code>c_time</code></strong>: Absolute tick count when callout should fire</li>
<li><strong><code>c_flags</code></strong>: Status and control flags</li>
</ul>
<p><strong>Callout Flags</strong> (defined in sys/sys/callout.h):
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="cp">#define CALLOUT_PENDING         0x0001  </span><span class="cm">/* Callout is on wheel */</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="cp">#define CALLOUT_ACTIVE          0x0002  </span><span class="cm">/* Callout is active */</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="cp">#define CALLOUT_MPSAFE          0x0008  </span><span class="cm">/* Can run without Giant */</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="cp">#define CALLOUT_DID_INIT        0x0010  </span><span class="cm">/* callout_init() called */</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="cp">#define CALLOUT_AUTOLOCK        0x0020  </span><span class="cm">/* Automatic locking */</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="cp">#define CALLOUT_WAITING         0x0040  </span><span class="cm">/* Thread waiting for callout */</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="cp">#define CALLOUT_EXECUTED        0x0080  </span><span class="cm">/* Callout executed */</span>
</code></pre></div></p>
<p><strong>Design Rationale</strong>: The two-tier design allows:
1. <strong>Lightweight embedding</strong>: Client structures only need one pointer
2. <strong>O(1) operations</strong>: Checking if callout is pending is just a NULL check
3. <strong>Efficient migration</strong>: Backend can be moved between CPUs without updating client</p>
<p><strong>Referenced in</strong>: kern_timeout.c:788 (callout_reset), kern_timeout.c:865 (callout_stop)</p>
<h3 id="callout-wheel-structure">Callout Wheel Structure<a class="headerlink" href="#callout-wheel-structure" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: kern_timeout.c:132</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">softclock_pcpu</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="n">spin</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Protects callout wheel */</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">colist</span><span class="w"> </span><span class="n">callwheel</span><span class="p">[</span><span class="n">BUCKETS</span><span class="p">];</span><span class="w">   </span><span class="cm">/* Timing wheel */</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">colist</span><span class="w"> </span><span class="n">calltodo</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Overflow list */</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">colist</span><span class="w"> </span><span class="o">*</span><span class="n">callcursor</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Current wheel position */</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">_callout</span><span class="w"> </span><span class="o">*</span><span class="n">running</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Currently executing callout */</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">softticks</span><span class="p">;</span><span class="w">                      </span><span class="cm">/* Local tick counter */</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">curticks</span><span class="p">;</span><span class="w">                       </span><span class="cm">/* Current tick being processed */</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">isrunning</span><span class="p">;</span><span class="w">                      </span><span class="cm">/* Processing in progress */</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread</span><span class="w"> </span><span class="o">*</span><span class="kr">thread</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Softclock thread */</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Key Fields</strong>:</p>
<ul>
<li><strong><code>callwheel[BUCKETS]</code></strong>: Circular array of callout queues (timing wheel)</li>
<li>Default <code>BUCKETS = 512</code> (can be tuned)</li>
<li>Each bucket represents one tick</li>
<li>Wheel covers 512 ticks (5.12 seconds at 100 Hz)</li>
<li><strong><code>calltodo</code></strong>: Overflow list for callouts beyond the wheel range</li>
<li><strong><code>callcursor</code></strong>: Points to current wheel bucket being processed</li>
<li><strong><code>running</code></strong>: Currently executing callout (for detecting recursion)</li>
<li><strong><code>softticks</code></strong>: Local tick counter for this CPU</li>
<li><strong><code>thread</code></strong>: Dedicated kernel thread for running callouts</li>
</ul>
<p><strong>Wheel Algorithm</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>Bucket index = (current_tick + delta_ticks) % BUCKETS
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>Example at hz=100 (10ms per tick):
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>- Bucket 0: Callouts firing at tick 0, 512, 1024, ...
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>- Bucket 1: Callouts firing at tick 1, 513, 1025, ...
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>- Bucket N: Callouts firing at tick N, N+512, N+1024, ...
</code></pre></div></p>
<p>For callouts beyond 512 ticks, they're placed on the overflow list and moved to the wheel as time advances.</p>
<p><strong>Per-CPU Design</strong>: Each CPU has its own <code>softclock_pcpu</code> structure to avoid lock contention.</p>
<p><strong>Referenced in</strong>: kern_timeout.c:788, kern_clock.c:712 (softclock processing)</p>
<h3 id="time-representation-types">Time Representation Types<a class="headerlink" href="#time-representation-types" title="Permanent link">&para;</a></h3>
<p>DragonFly uses several time representation types:</p>
<h4 id="struct-timeval-traditional-bsd">struct timeval (Traditional BSD)<a class="headerlink" href="#struct-timeval-traditional-bsd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="kt">time_t</span><span class="w">      </span><span class="n">tv_sec</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Seconds since epoch */</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="n">suseconds_t</span><span class="w"> </span><span class="n">tv_usec</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Microseconds [0, 999999] */</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Usage</strong>: <code>gettimeofday()</code>, legacy interfaces
<strong>Resolution</strong>: Microsecond (1e-6 seconds)
<strong>Range</strong>: ~68 years (32-bit time_t) or ~292 billion years (64-bit time_t)</p>
<h4 id="struct-timespec-posix">struct timespec (POSIX)<a class="headerlink" href="#struct-timespec-posix" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="kt">time_t</span><span class="w">  </span><span class="n">tv_sec</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Seconds since epoch */</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="kt">long</span><span class="w">    </span><span class="n">tv_nsec</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Nanoseconds [0, 999999999] */</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Usage</strong>: <code>clock_gettime()</code>, <code>nanosleep()</code>, modern interfaces
<strong>Resolution</strong>: Nanosecond (1e-9 seconds)
<strong>Range</strong>: Same as timeval but with nanosecond precision</p>
<h4 id="sysclock_t-internal-kernel">sysclock_t (Internal Kernel)<a class="headerlink" href="#sysclock_t-internal-kernel" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">sysclock_t</span><span class="p">;</span><span class="w">    </span><span class="cm">/* System clock counter */</span>
</code></pre></div>
<p><strong>Usage</strong>: Internal timing, cputimer counts
<strong>Resolution</strong>: Depends on hardware timer frequency
<strong>Range</strong>: 2^63 ticks (effectively unlimited for reasonable frequencies)
<strong>Characteristics</strong>: Monotonic, never wraps in practice</p>
<h4 id="sbintime_t-signed-binary-time">sbintime_t (Signed Binary Time)<a class="headerlink" href="#sbintime_t-signed-binary-time" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">sbintime_t</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 2^-32 second units */</span>
</code></pre></div>
<p><strong>Usage</strong>: High-precision internal timing
<strong>Resolution</strong>: 2^-32 seconds (~233 picoseconds)
<strong>Range</strong>: ~68 years with picosecond precision
<strong>Characteristics</strong>: Fast binary arithmetic, no division needed</p>
<p><strong>Conversion</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="cp">#define SBT_1S  ((sbintime_t)1 &lt;&lt; 32)  </span><span class="cm">/* One second */</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="cp">#define SBT_1MS (SBT_1S / 1000)         </span><span class="cm">/* One millisecond */</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="cp">#define SBT_1US (SBT_1S / 1000000)      </span><span class="cm">/* One microsecond */</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="cp">#define SBT_1NS (SBT_1S / 1000000000)   </span><span class="cm">/* One nanosecond */</span>
</code></pre></div></p>
<h3 id="global-time-variables">Global Time Variables<a class="headerlink" href="#global-time-variables" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: kern_clock.c</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="cm">/* Master tick counters */</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ticks</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* Tick counter at hz */</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">sbticks</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Tick counter in sbintime_t */</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="cm">/* Passive time globals (updated in hardclock) */</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="kt">time_t</span><span class="w"> </span><span class="n">time_second</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* Current realtime (seconds) */</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="kt">time_t</span><span class="w"> </span><span class="n">time_uptime</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* Uptime (seconds since boot) */</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="cm">/* Real time FIFO for NTP */</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="cp">#define BASETIME_ARYSIZE 16</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">basetime</span><span class="p">[</span><span class="n">BASETIME_ARYSIZE</span><span class="p">];</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="k">static</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">basetime_index</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Read index (FIFO) */</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="cm">/* Boot time reference */</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">boottime</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Time at boot */</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="cm">/* NTP adjustment state */</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="k">extern</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">time_tick</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* Nominal tick (us) */</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="k">extern</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">time_adjtime</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Adjustment remaining (us) */</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">time_offset</span><span class="p">;</span><span class="w">             </span><span class="cm">/* NTP offset (scaled ns) */</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="k">extern</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">time_freq</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* Frequency adjustment (ppm) */</span>
</code></pre></div>
<p><strong>Key Variables</strong>:</p>
<ul>
<li><strong><code>ticks</code></strong>: Global tick counter, incremented at <code>hz</code> frequency (typically 100 Hz)</li>
<li>Used for timeout calculations</li>
<li>Wraps after ~497 days at hz=100</li>
<li><strong><code>sbticks</code></strong>: High-precision tick counter in sbintime_t format</li>
<li><strong><code>time_second</code></strong>: Cached realtime in seconds (low overhead to read)</li>
<li><strong><code>time_uptime</code></strong>: Seconds since boot (monotonic)</li>
<li><strong><code>basetime[]</code></strong>: FIFO of realtime values (NTP adjusts write end, hardclock reads read end)</li>
<li><strong><code>boottime</code></strong>: Reference time when system booted</li>
</ul>
<p><strong>Thread Safety</strong>: Most time globals are updated atomically or use lock-free FIFO mechanisms (basetime).</p>
<h2 id="key-functions">Key Functions<a class="headerlink" href="#key-functions" title="Permanent link">&para;</a></h2>
<h3 id="hardware-timer-registration-and-selection">Hardware Timer Registration and Selection<a class="headerlink" href="#hardware-timer-registration-and-selection" title="Permanent link">&para;</a></h3>
<h4 id="cputimer_register">cputimer_register()<a class="headerlink" href="#cputimer_register" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_cputimer.c:291</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">cputimer_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cputimer</span><span class="w"> </span><span class="o">*</span><span class="n">timer</span><span class="p">);</span>
</code></pre></div>
<p>Registers a hardware timer with the kernel. If the new timer has higher priority than the current timer, it becomes the active timer.</p>
<p><strong>Parameters</strong>:
- <code>timer</code>: Pointer to initialized cputimer structure</p>
<p><strong>Selection Logic</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">pri</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sys_cputimer</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="n">sys_cputimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Switch to better timer */</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Common Priorities</strong>:
- TSC (synchronized): 1000
- HPET: 900
- ACPI PM Timer: 800
- i8254 PIT: 100</p>
<h4 id="cputimer_select">cputimer_select()<a class="headerlink" href="#cputimer_select" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_cputimer.c:325</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">cputimer_select</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cputimer</span><span class="w"> </span><span class="o">*</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prio</span><span class="p">);</span>
</code></pre></div>
<p>Explicitly selects a timer, optionally changing its priority.</p>
<h3 id="system-timer-operations">System Timer Operations<a class="headerlink" href="#system-timer-operations" title="Permanent link">&para;</a></h3>
<h4 id="systimer_init_periodic">systimer_init_periodic()<a class="headerlink" href="#systimer_init_periodic" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_systimer.c:292</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">systimer_init_periodic</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">systimer_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">,</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">                            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">freq</span><span class="p">);</span>
</code></pre></div>
<p>Initializes a periodic software timer.</p>
<p><strong>Parameters</strong>:
- <code>info</code>: Pointer to systimer structure to initialize
- <code>func</code>: Callback function to invoke on each timer expiration
- <code>data</code>: Opaque pointer passed to callback
- <code>freq</code>: Desired frequency in Hz</p>
<p><strong>Usage Example</strong> (hardclock initialization in kern_clock.c:373):
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">systimer_init_periodic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_hardclock</span><span class="p">,</span><span class="w"> </span><span class="n">hardclock</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">hz</span><span class="p">);</span>
</code></pre></div></p>
<h4 id="systimer_init_periodic_nq">systimer_init_periodic_nq()<a class="headerlink" href="#systimer_init_periodic_nq" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_systimer.c:317</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">systimer_init_periodic_nq</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">systimer_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">,</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">                               </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">freq</span><span class="p">);</span>
</code></pre></div>
<p>Same as <code>systimer_init_periodic()</code> but doesn't initially add the timer to the active queue. Must call <code>systimer_add()</code> to activate.</p>
<h4 id="systimer_add">systimer_add()<a class="headerlink" href="#systimer_add" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_systimer.c:342</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">systimer_add</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
</code></pre></div>
<p>Adds a systimer to the active queue for its CPU.</p>
<h4 id="systimer_del">systimer_del()<a class="headerlink" href="#systimer_del" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_systimer.c:368</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">systimer_del</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
</code></pre></div>
<p>Removes a systimer from the active queue.</p>
<h3 id="callout-operations">Callout Operations<a class="headerlink" href="#callout-operations" title="Permanent link">&para;</a></h3>
<h4 id="callout_init">callout_init()<a class="headerlink" href="#callout_init" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_timeout.c:636</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">callout_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">);</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">callout_init_mp</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">);</span><span class="w">  </span><span class="cm">/* MP-safe variant */</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">callout_init_lk</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">);</span><span class="w">  </span><span class="cm">/* With lock */</span>
</code></pre></div>
<p>Initializes a callout structure. Must be called before using the callout.</p>
<p><strong>Variants</strong>:
- <code>callout_init()</code>: Basic initialization
- <code>callout_init_mp()</code>: Marks callout as MP-safe (no Giant lock needed)
- <code>callout_init_lk()</code>: Associates a lock with the callout (automatic locking)</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="n">my_callout</span><span class="p">;</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">callout_init_mp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_callout</span><span class="p">);</span>
</code></pre></div></p>
<h4 id="callout_reset">callout_reset()<a class="headerlink" href="#callout_reset" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_timeout.c:788</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">callout_reset</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">callout_reset_bycpu</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">                         </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cpuid</span><span class="p">);</span>
</code></pre></div>
<p>Schedules or reschedules a callout to fire after the specified number of ticks.</p>
<p><strong>Parameters</strong>:
- <code>c</code>: Callout structure (must be initialized)
- <code>ticks</code>: Number of ticks until expiration (relative to current time)
- <code>func</code>: Callback function
- <code>arg</code>: Argument passed to callback</p>
<p><strong>Behavior</strong>:
- If callout is already pending, it's cancelled and rescheduled
- Returns immediately; callback executes asynchronously
- Thread-safe; uses per-CPU locks</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="cm">/* Fire callback in 5 seconds (assuming hz=100) */</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="n">callout_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_callout</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hz</span><span class="p">,</span><span class="w"> </span><span class="n">my_timeout_func</span><span class="p">,</span><span class="w"> </span><span class="n">my_data</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>CPU Assignment</strong>:
- <code>callout_reset()</code>: Uses current CPU
- <code>callout_reset_bycpu()</code>: Explicitly specifies CPU</p>
<h4 id="callout_stop">callout_stop()<a class="headerlink" href="#callout_stop" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_timeout.c:865</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">callout_stop</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">);</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="kt">int</span><span class="w"> </span><span class="nf">callout_stop_sync</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">);</span>
</code></pre></div>
<p>Cancels a pending callout.</p>
<p><strong>Returns</strong>:
- Non-zero if callout was pending (successfully cancelled)
- Zero if callout was not pending</p>
<p><strong>Variants</strong>:
- <code>callout_stop()</code>: Basic stop, returns immediately
- <code>callout_stop_sync()</code>: Waits for callback to complete if currently executing</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callout_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_callout</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="cm">/* Callout was pending and has been cancelled */</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="cm">/* Callout wasn&#39;t pending or already fired */</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="callout_terminate">callout_terminate()<a class="headerlink" href="#callout_terminate" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_timeout.c:928</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">callout_terminate</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">);</span>
</code></pre></div>
<p>Terminates a callout, stopping it and waiting for any in-progress execution to complete. Called during cleanup/shutdown.</p>
<h3 id="time-retrieval-functions">Time Retrieval Functions<a class="headerlink" href="#time-retrieval-functions" title="Permanent link">&para;</a></h3>
<h4 id="getmicrotime-getnanotime">getmicrotime() / getnanotime()<a class="headerlink" href="#getmicrotime-getnanotime" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:462, kern_time.c:478</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">getmicrotime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="o">*</span><span class="n">tvp</span><span class="p">);</span><span class="w">   </span><span class="cm">/* Realtime, low precision */</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">getnanotime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">tsp</span><span class="p">);</span><span class="w">   </span><span class="cm">/* Realtime, low precision */</span>
</code></pre></div>
<p>Returns cached realtime with low overhead (no hardware timer read).</p>
<p><strong>Precision</strong>: Updated only at hardclock frequency (typically 100 Hz, 10ms resolution)
<strong>Use Case</strong>: When exact time isn't critical (logging, coarse timestamps)</p>
<h4 id="microtime-nanotime">microtime() / nanotime()<a class="headerlink" href="#microtime-nanotime" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:494, kern_time.c:510</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">microtime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="o">*</span><span class="n">tvp</span><span class="p">);</span><span class="w">      </span><span class="cm">/* Realtime, high precision */</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">nanotime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">tsp</span><span class="p">);</span><span class="w">      </span><span class="cm">/* Realtime, high precision */</span>
</code></pre></div>
<p>Returns precise realtime by reading the hardware timer.</p>
<p><strong>Precision</strong>: Hardware timer resolution (nanosecond range for modern timers)
<strong>Overhead</strong>: Higher than getmicrotime/getnanotime (hardware read required)
<strong>Use Case</strong>: When accurate timestamps are needed</p>
<h4 id="getmicrouptime-getnanouptime">getmicrouptime() / getnanouptime()<a class="headerlink" href="#getmicrouptime-getnanouptime" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:526, kern_time.c:542</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">getmicrouptime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="o">*</span><span class="n">tvp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Monotonic, low precision */</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">getnanouptime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">tsp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Monotonic, low precision */</span>
</code></pre></div>
<p>Returns cached monotonic uptime.</p>
<p><strong>Characteristics</strong>: 
- Monotonically increasing
- Not affected by time adjustments
- Low overhead (no hardware read)</p>
<h4 id="microuptime-nanouptime">microuptime() / nanouptime()<a class="headerlink" href="#microuptime-nanouptime" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:558, kern_time.c:574</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">microuptime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="o">*</span><span class="n">tvp</span><span class="p">);</span><span class="w">     </span><span class="cm">/* Monotonic, high precision */</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">nanouptime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">tsp</span><span class="p">);</span><span class="w">     </span><span class="cm">/* Monotonic, high precision */</span>
</code></pre></div>
<p>Returns precise monotonic uptime by reading hardware timer.</p>
<p><strong>Use Case</strong>: Measuring time intervals accurately</p>
<h3 id="system-calls">System Calls<a class="headerlink" href="#system-calls" title="Permanent link">&para;</a></h3>
<h4 id="sys_clock_gettime">sys_clock_gettime()<a class="headerlink" href="#sys_clock_gettime" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:672</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sys_clock_gettime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sysmsg</span><span class="w"> </span><span class="o">*</span><span class="n">sysmsg</span><span class="p">,</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">                      </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_gettime_args</span><span class="w"> </span><span class="o">*</span><span class="n">uap</span><span class="p">);</span>
</code></pre></div>
<p>POSIX clock_gettime() system call.</p>
<p><strong>Supported Clocks</strong>:
- <code>CLOCK_REALTIME</code>: Realtime (can jump with NTP)
- <code>CLOCK_MONOTONIC</code>: Monotonic time (always increasing)
- <code>CLOCK_UPTIME</code>: Uptime since boot
- <code>CLOCK_VIRTUAL</code>: Per-process virtual time
- <code>CLOCK_PROF</code>: Per-process profiling time
- <code>CLOCK_SECOND</code>: Low-resolution second counter</p>
<h4 id="sys_nanosleep">sys_nanosleep()<a class="headerlink" href="#sys_nanosleep" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:823</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sys_nanosleep</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sysmsg</span><span class="w"> </span><span class="o">*</span><span class="n">sysmsg</span><span class="p">,</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">nanosleep_args</span><span class="w"> </span><span class="o">*</span><span class="n">uap</span><span class="p">);</span>
</code></pre></div>
<p>POSIX nanosleep() - sleep for specified time.</p>
<p><strong>Implementation</strong>:
1. Converts timespec to ticks
2. Calls <code>tsleep()</code> with timeout
3. Handles early wakeup (signals)
4. Returns remaining time if interrupted</p>
<h4 id="sys_gettimeofday">sys_gettimeofday()<a class="headerlink" href="#sys_gettimeofday" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:273</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sys_gettimeofday</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sysmsg</span><span class="w"> </span><span class="o">*</span><span class="n">sysmsg</span><span class="p">,</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gettimeofday_args</span><span class="w"> </span><span class="o">*</span><span class="n">uap</span><span class="p">);</span>
</code></pre></div>
<p>Traditional BSD gettimeofday() system call.</p>
<p><strong>Implementation</strong>: Calls <code>microtime()</code> to get high-precision realtime.</p>
<h4 id="sys_adjtime-sys_ntp_adjtime">sys_adjtime() / sys_ntp_adjtime()<a class="headerlink" href="#sys_adjtime-sys_ntp_adjtime" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: kern_time.c:370, kern_ntptime.c:260</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sys_adjtime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sysmsg</span><span class="w"> </span><span class="o">*</span><span class="n">sysmsg</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">adjtime_args</span><span class="w"> </span><span class="o">*</span><span class="n">uap</span><span class="p">);</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sys_ntp_adjtime</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sysmsg</span><span class="w"> </span><span class="o">*</span><span class="n">sysmsg</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ntp_adjtime_args</span><span class="w"> </span><span class="o">*</span><span class="n">uap</span><span class="p">);</span>
</code></pre></div>
<p>Adjust system time gradually (for time synchronization).</p>
<ul>
<li><code>adjtime()</code>: Simple time adjustment (legacy BSD)</li>
<li><code>ntp_adjtime()</code>: Full NTP adjustment interface</li>
</ul>
<h2 id="code-flow-examples">Code Flow Examples<a class="headerlink" href="#code-flow-examples" title="Permanent link">&para;</a></h2>
<h3 id="example-1-callout-lifecycle">Example 1: Callout Lifecycle<a class="headerlink" href="#example-1-callout-lifecycle" title="Permanent link">&para;</a></h3>
<p>Complete example of using callouts for a timeout:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="cm">/* Device driver timeout example */</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="n">watchdog</span><span class="p">;</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout_pending</span><span class="p">;</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">    </span><span class="cm">/* ... other fields ... */</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="p">};</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="cm">/* Initialize callout (in device attach) */</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="kt">void</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="nf">my_device_attach</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="p">{</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">    </span><span class="n">callout_init_mp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timeout_pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="p">}</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="cm">/* Start operation with timeout */</span>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="kt">void</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a><span class="nf">my_device_start_operation</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a><span class="p">{</span>
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a><span class="w">    </span><span class="cm">/* Start hardware operation */</span>
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a><span class="w">    </span><span class="n">my_device_hw_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a>
<a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="w">    </span><span class="cm">/* Set 5-second watchdog timeout (hz = 100) */</span>
<a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="w">    </span><span class="n">callout_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hz</span><span class="p">,</span><span class="w"> </span><span class="n">my_device_timeout</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>
<a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a><span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timeout_pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a><span class="p">}</span>
<a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a>
<a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a><span class="cm">/* Timeout callback (runs in softclock context) */</span>
<a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a><span class="kt">void</span>
<a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a><span class="nf">my_device_timeout</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a><span class="p">{</span>
<a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span>
<a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a>
<a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;Device operation timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a><span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timeout_pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a>
<a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a><span class="w">    </span><span class="cm">/* Reset hardware */</span>
<a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a><span class="w">    </span><span class="n">my_device_hw_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="p">}</span>
<a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a>
<a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a><span class="cm">/* Operation completed successfully */</span>
<a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a><span class="kt">void</span>
<a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a><span class="nf">my_device_operation_complete</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a><span class="p">{</span>
<a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a><span class="w">    </span><span class="cm">/* Cancel timeout */</span>
<a id="__codelineno-43-47" name="__codelineno-43-47" href="#__codelineno-43-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callout_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-48" name="__codelineno-43-48" href="#__codelineno-43-48"></a><span class="w">        </span><span class="cm">/* Timeout was pending and successfully cancelled */</span>
<a id="__codelineno-43-49" name="__codelineno-43-49" href="#__codelineno-43-49"></a><span class="w">        </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timeout_pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-43-50" name="__codelineno-43-50" href="#__codelineno-43-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-43-51" name="__codelineno-43-51" href="#__codelineno-43-51"></a>
<a id="__codelineno-43-52" name="__codelineno-43-52" href="#__codelineno-43-52"></a><span class="w">    </span><span class="cm">/* Process completion */</span>
<a id="__codelineno-43-53" name="__codelineno-43-53" href="#__codelineno-43-53"></a><span class="w">    </span><span class="n">my_device_handle_completion</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<a id="__codelineno-43-54" name="__codelineno-43-54" href="#__codelineno-43-54"></a><span class="p">}</span>
<a id="__codelineno-43-55" name="__codelineno-43-55" href="#__codelineno-43-55"></a>
<a id="__codelineno-43-56" name="__codelineno-43-56" href="#__codelineno-43-56"></a><span class="cm">/* Cleanup (in device detach) */</span>
<a id="__codelineno-43-57" name="__codelineno-43-57" href="#__codelineno-43-57"></a><span class="kt">void</span>
<a id="__codelineno-43-58" name="__codelineno-43-58" href="#__codelineno-43-58"></a><span class="nf">my_device_detach</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<a id="__codelineno-43-59" name="__codelineno-43-59" href="#__codelineno-43-59"></a><span class="p">{</span>
<a id="__codelineno-43-60" name="__codelineno-43-60" href="#__codelineno-43-60"></a><span class="w">    </span><span class="cm">/* Stop and wait for any in-progress timeout */</span>
<a id="__codelineno-43-61" name="__codelineno-43-61" href="#__codelineno-43-61"></a><span class="w">    </span><span class="n">callout_terminate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
<a id="__codelineno-43-62" name="__codelineno-43-62" href="#__codelineno-43-62"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Call Flow</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>1. Device attach
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>   &gt; callout_init_mp(&amp;dev-&gt;watchdog)
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>   &gt; Callout ready for use
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>2. Start operation
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>   &gt; my_device_hw_start()
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>   &gt; callout_reset(&amp;dev-&gt;watchdog, 5*hz, callback, dev)
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>      &gt; Allocate backend _callout
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>      &gt; Calculate expiration: ticks + 5*hz
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>      &gt; Insert into callout wheel bucket
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>      &gt; Mark as CALLOUT_PENDING
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>   &gt; Return to caller
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>3a. Normal completion path:
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>    &gt; Operation completes
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>    &gt; callout_stop(&amp;dev-&gt;watchdog)
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>       &gt; Remove from wheel
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>       &gt; Clear CALLOUT_PENDING
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>       &gt; Return 1 (was pending)
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>    &gt; Handle completion
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>3b. Timeout path:
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>    &gt; hardclock() runs at hz frequency
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>    &gt; softclock() processes callout wheel
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>    &gt; Finds expired callout
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>    &gt; Calls my_device_timeout(dev)
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>       &gt; Log timeout
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>       &gt; Reset hardware
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>    &gt; Clear CALLOUT_PENDING
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>
<a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>4. Device detach
<a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>   &gt; callout_terminate(&amp;dev-&gt;watchdog)
<a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>   &gt; Stop callout
<a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>   &gt; Wait for completion if running
</code></pre></div></p>
<h3 id="example-2-hardclock-processing-flow">Example 2: Hardclock Processing Flow<a class="headerlink" href="#example-2-hardclock-processing-flow" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: kern_clock.c:552</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="cm">/*</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="cm"> * Hardclock runs on each CPU at hz frequency.</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="cm"> * This is the primary system heartbeat.</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="cm"> */</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="nf">hardclock</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">in_ipi</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">intrframe</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="p">{</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">    </span><span class="n">globaldata_t</span><span class="w"> </span><span class="n">gd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mycpu</span><span class="p">();</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">    </span><span class="n">thread_t</span><span class="w"> </span><span class="n">td</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curthread</span><span class="p">;</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">    </span><span class="cm">/* Step 1: Update global tick counters */</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="w">    </span><span class="o">++</span><span class="n">ticks</span><span class="p">;</span><span class="w">                        </span><span class="cm">/* Increment master tick counter */</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">    </span><span class="n">sbticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mftb</span><span class="p">();</span><span class="w">               </span><span class="cm">/* Read timebase for sbintime */</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="w">    </span><span class="cm">/* Step 2: Update passive time globals from basetime FIFO */</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="w">    </span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_time_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">basetime</span><span class="p">[</span><span class="n">basetime_index</span><span class="p">].</span><span class="n">tv_sec</span><span class="p">;</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="w">    </span><span class="n">time_second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_time_seconds</span><span class="p">;</span>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="w">    </span><span class="n">time_uptime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">systimer_count</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">systimer_offset</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sys_cputimer</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="w">    </span><span class="cm">/* Step 3: Handle NTP adjustments (on CPU 0 only) */</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_cpuid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="w">        </span><span class="n">ntp_update_second</span><span class="p">(</span><span class="o">&amp;</span><span class="n">basetime</span><span class="p">[</span><span class="n">basetime_index</span><span class="p">],</span><span class="w"> </span><span class="n">ticks</span><span class="p">);</span>
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a>
<a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="w">    </span><span class="cm">/* Step 4: Process callouts (timeouts) */</span>
<a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a><span class="w">    </span><span class="n">softclock</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">in_ipi</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span>
<a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a>
<a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="w">    </span><span class="cm">/* Step 5: Per-thread accounting */</span>
<a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">td</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_idlethread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="w">        </span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_wakefromcpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CLKF_USERMODE</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="w">            </span><span class="o">++</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_uticks</span><span class="p">;</span><span class="w">        </span><span class="cm">/* User mode */</span>
<a id="__codelineno-45-33" name="__codelineno-45-33" href="#__codelineno-45-33"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-34" name="__codelineno-45-34" href="#__codelineno-45-34"></a><span class="w">            </span><span class="o">++</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_sticks</span><span class="p">;</span><span class="w">        </span><span class="cm">/* System mode */</span>
<a id="__codelineno-45-35" name="__codelineno-45-35" href="#__codelineno-45-35"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-45-36" name="__codelineno-45-36" href="#__codelineno-45-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-37" name="__codelineno-45-37" href="#__codelineno-45-37"></a>
<a id="__codelineno-45-38" name="__codelineno-45-38" href="#__codelineno-45-38"></a><span class="w">    </span><span class="cm">/* Step 6: Scheduler operations (every 10 ticks on DragonFly) */</span>
<a id="__codelineno-45-39" name="__codelineno-45-39" href="#__codelineno-45-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ticks</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-40" name="__codelineno-45-40" href="#__codelineno-45-40"></a><span class="w">        </span><span class="n">scheduler_tick</span><span class="p">(</span><span class="n">td</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span>
<a id="__codelineno-45-41" name="__codelineno-45-41" href="#__codelineno-45-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-42" name="__codelineno-45-42" href="#__codelineno-45-42"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Flow Diagram</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>Hardware Timer Interrupt
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>        
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>systimer_intr() [kern_systimer.c:69]
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>        
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>hardclock() [kern_clock.c:552]
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>        &gt; Update ticks, sbticks
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>        &gt; Update time_second, time_uptime (from basetime FIFO)
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>        &gt; CPU 0: ntp_update_second()
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>                   &gt; Apply PLL/FLL adjustments
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>                   &gt; Update basetime[] write index
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>        &gt; softclock() [kern_clock.c:712]
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>           &gt; Process callout wheel
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>               &gt; Advance wheel cursor
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>               &gt; For each expired callout:
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>                  &gt; Remove from wheel
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>                  &gt; Mark as executing
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>                  &gt; Call callback function
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>                  &gt; Mark as executed
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a>               &gt; Check overflow list (calltodo)
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a>        &gt; Thread accounting (td_uticks/td_sticks)
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>        &gt; Every 10 ticks: scheduler_tick()
</code></pre></div></p>
<h3 id="example-3-callout-wheel-operation">Example 3: Callout Wheel Operation<a class="headerlink" href="#example-3-callout-wheel-operation" title="Permanent link">&para;</a></h3>
<p><strong>Wheel Structure</strong> (BUCKETS = 512):
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>Current ticks = 1000
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>Wheel bucket index = ticks % BUCKETS = 1000 % 512 = 488
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>Callout wheel layout:
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a> 488  489  490   ...   487           
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>                                        
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>Current cursor                           
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>When callout_reset(&amp;c, 50, func, arg) is called:
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>- Expiration tick = 1000 + 50 = 1050
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>- Bucket = 1050 % 512 = 26
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>- Insert callout into bucket 26
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a>When ticks reaches 1050:
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a>- Cursor advances to bucket 26
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a>- Callout found and executed
</code></pre></div></p>
<p><strong>Insertion Algorithm</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kt">void</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="nf">callout_reset</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">callout</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="p">{</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">softclock_pcpu</span><span class="w"> </span><span class="o">*</span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">softclock_pcpu_ary</span><span class="p">[</span><span class="n">mycpuid</span><span class="p">];</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">_callout</span><span class="w"> </span><span class="o">*</span><span class="n">cc</span><span class="p">;</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">expire_tick</span><span class="p">;</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket</span><span class="p">;</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="w">    </span><span class="cm">/* Calculate absolute expiration */</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="w">    </span><span class="n">expire_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">softticks</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ticks</span><span class="p">;</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="w">    </span><span class="cm">/* Allocate backend if needed */</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lh</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="w">        </span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callout_alloc</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a><span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cc</span><span class="p">;</span>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a><span class="w">        </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_lh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="w">        </span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lh</span><span class="p">;</span>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="w">        </span><span class="cm">/* Remove from current position if pending */</span>
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CALLOUT_PENDING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a><span class="w">            </span><span class="n">TAILQ_REMOVE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">callwheel</span><span class="p">[</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_time</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUCKETS</span><span class="p">],</span><span class="w"> </span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">c_links</span><span class="p">.</span><span class="n">tq</span><span class="p">);</span>
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a><span class="w">    </span><span class="cm">/* Setup callout */</span>
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a><span class="w">    </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a><span class="w">    </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span>
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a><span class="w">    </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expire_tick</span><span class="p">;</span>
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a><span class="w">    </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CALLOUT_PENDING</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CALLOUT_ACTIVE</span><span class="p">;</span>
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a>
<a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a><span class="w">    </span><span class="cm">/* Insert into appropriate bucket */</span>
<a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ticks</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BUCKETS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a><span class="w">        </span><span class="cm">/* Within wheel range */</span>
<a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a><span class="w">        </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expire_tick</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUCKETS</span><span class="p">;</span>
<a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a><span class="w">        </span><span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">callwheel</span><span class="p">[</span><span class="n">bucket</span><span class="p">],</span><span class="w"> </span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">c_links</span><span class="p">.</span><span class="n">tq</span><span class="p">);</span>
<a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a><span class="w">        </span><span class="cm">/* Beyond wheel range - use overflow list */</span>
<a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a><span class="w">        </span><span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">calltodo</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">c_links</span><span class="p">.</span><span class="n">tq</span><span class="p">);</span>
<a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a>
<a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a><span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Processing Algorithm</strong> (in softclock):
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="kt">void</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="nf">softclock</span><span class="p">(</span><span class="n">systimer_t</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">in_ipi</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">intrframe</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="p">{</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">softclock_pcpu</span><span class="w"> </span><span class="o">*</span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">softclock_pcpu_ary</span><span class="p">[</span><span class="n">mycpuid</span><span class="p">];</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">_callout</span><span class="w"> </span><span class="o">*</span><span class="n">cc</span><span class="p">;</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">curticks</span><span class="p">;</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">    </span><span class="cm">/* Process all ticks since last run */</span>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">softticks</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ticks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">        </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">curticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">++</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">softticks</span><span class="p">;</span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">        </span><span class="n">curticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">curticks</span><span class="p">;</span>
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">        </span><span class="cm">/* Advance cursor to current bucket */</span>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="w">        </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">callcursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">callwheel</span><span class="p">[</span><span class="n">curticks</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUCKETS</span><span class="p">];</span>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="w">        </span><span class="cm">/* Process all callouts in current bucket */</span>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAILQ_FIRST</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">callcursor</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_time</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">curticks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="w">                </span><span class="cm">/* Not expired yet (wheel wrapped) */</span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="w">            </span><span class="cm">/* Remove from wheel */</span>
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="w">            </span><span class="n">TAILQ_REMOVE</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">callcursor</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">c_links</span><span class="p">.</span><span class="n">tq</span><span class="p">);</span>
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a><span class="w">            </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">CALLOUT_PENDING</span><span class="p">;</span>
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a><span class="w">            </span><span class="cm">/* Mark as running */</span>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a><span class="w">            </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cc</span><span class="p">;</span>
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a>
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a><span class="w">            </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a>
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a><span class="w">            </span><span class="cm">/* Execute callback */</span>
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a><span class="w">            </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_func</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_arg</span><span class="p">);</span>
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a>
<a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a><span class="w">            </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a>
<a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a><span class="w">            </span><span class="cm">/* Mark completed */</span>
<a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a><span class="w">            </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a><span class="w">            </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">c_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">CALLOUT_EXECUTED</span><span class="p">;</span>
<a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a>
<a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a><span class="w">        </span><span class="cm">/* Move callouts from overflow list to wheel if in range */</span>
<a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a><span class="w">        </span><span class="n">migrate_callouts_from_overflow</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a>
<a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a><span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="example-4-ntp-time-adjustment-flow">Example 4: NTP Time Adjustment Flow<a class="headerlink" href="#example-4-ntp-time-adjustment-flow" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: kern_ntptime.c, kern_clock.c</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="cm">/*</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="cm"> * NTP adjustment happens in hardclock on CPU 0</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="cm"> */</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="kt">void</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="nf">ntp_update_second</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">btp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ticks</span><span class="p">)</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="p">{</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">time_adj</span><span class="p">;</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">    </span><span class="cm">/* Phase-Locked Loop (PLL) adjustment */</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">STA_PLL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">        </span><span class="n">time_adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Scale down */</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">        </span><span class="cm">/* Apply adjustment limit */</span>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_adj</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAXPHASE</span><span class="p">)</span>
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">            </span><span class="n">time_adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAXPHASE</span><span class="p">;</span>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_adj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">MAXPHASE</span><span class="p">)</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="w">            </span><span class="n">time_adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">MAXPHASE</span><span class="p">;</span>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">        </span><span class="cm">/* Apply adjustment to current second */</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="w">        </span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">time_adj</span><span class="p">;</span>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a>
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a><span class="w">        </span><span class="cm">/* Reduce offset */</span>
<a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a><span class="w">        </span><span class="n">time_offset</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">time_adj</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-50-25" name="__codelineno-50-25" href="#__codelineno-50-25"></a>
<a id="__codelineno-50-26" name="__codelineno-50-26" href="#__codelineno-50-26"></a><span class="w">    </span><span class="cm">/* Frequency-Locked Loop (FLL) adjustment */</span>
<a id="__codelineno-50-27" name="__codelineno-50-27" href="#__codelineno-50-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">STA_FLL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-28" name="__codelineno-50-28" href="#__codelineno-50-28"></a><span class="w">        </span><span class="cm">/* Adjust frequency based on long-term drift */</span>
<a id="__codelineno-50-29" name="__codelineno-50-29" href="#__codelineno-50-29"></a><span class="w">        </span><span class="n">time_freq</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">time_offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1L</span><span class="n">L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">));</span>
<a id="__codelineno-50-30" name="__codelineno-50-30" href="#__codelineno-50-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-50-31" name="__codelineno-50-31" href="#__codelineno-50-31"></a>
<a id="__codelineno-50-32" name="__codelineno-50-32" href="#__codelineno-50-32"></a><span class="w">    </span><span class="cm">/* Normalize timespec */</span>
<a id="__codelineno-50-33" name="__codelineno-50-33" href="#__codelineno-50-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-34" name="__codelineno-50-34" href="#__codelineno-50-34"></a><span class="w">        </span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">;</span>
<a id="__codelineno-50-35" name="__codelineno-50-35" href="#__codelineno-50-35"></a><span class="w">        </span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-50-36" name="__codelineno-50-36" href="#__codelineno-50-36"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-37" name="__codelineno-50-37" href="#__codelineno-50-37"></a><span class="w">        </span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">;</span>
<a id="__codelineno-50-38" name="__codelineno-50-38" href="#__codelineno-50-38"></a><span class="w">        </span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-50-39" name="__codelineno-50-39" href="#__codelineno-50-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-50-40" name="__codelineno-50-40" href="#__codelineno-50-40"></a>
<a id="__codelineno-50-41" name="__codelineno-50-41" href="#__codelineno-50-41"></a><span class="w">    </span><span class="cm">/* Update basetime FIFO write pointer */</span>
<a id="__codelineno-50-42" name="__codelineno-50-42" href="#__codelineno-50-42"></a><span class="w">    </span><span class="n">basetime_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">basetime_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BASETIME_ARYSIZE</span><span class="p">;</span>
<a id="__codelineno-50-43" name="__codelineno-50-43" href="#__codelineno-50-43"></a><span class="w">    </span><span class="n">basetime</span><span class="p">[</span><span class="n">basetime_index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">btp</span><span class="p">;</span>
<a id="__codelineno-50-44" name="__codelineno-50-44" href="#__codelineno-50-44"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Flow</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>NTP Daemon (ntpd in userspace)
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>        
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>sys_ntp_adjtime() [kern_ntptime.c:260]
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>        &gt; Lock ntp_lock
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>        &gt; Update time_offset, time_freq
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>        &gt; Set time_status (PLL/FLL mode)
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>        &gt; Unlock ntp_lock
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>Every hardclock on CPU 0:
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>        
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>hardclock() [kern_clock.c:552]
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>        &gt; Read basetime[read_index]
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>        &gt; ntp_update_second(&amp;basetime[write_index])
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>           &gt; Calculate adjustment based on time_offset
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>           &gt; Apply PLL correction (phase)
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>           &gt; Apply FLL correction (frequency)
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>           &gt; Adjust tv_nsec by small amount
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>           &gt; Normalize timespec
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>           &gt; Increment write_index
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>        &gt; Update time_second from basetime[read_index]
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>Result: Time gradually converges to NTP reference
</code></pre></div></p>
<p><strong>Basetime FIFO</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>basetime[16] = FIFO of timespec values
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>Write end (NTP adjusts):     Read end (hardclock uses):
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>                                     
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>[0][1][2][3][4][5][6][7][8][9][10][11][12][13][14][15]
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>- NTP code writes adjusted time to write_index
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>- hardclock reads from read_index
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>- FIFO provides lock-free communication
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>- 16 entries give ~160ms buffer at hz=100
</code></pre></div></p>
<h2 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h2>
<h3 id="choosing-timer-facilities">Choosing Timer Facilities<a class="headerlink" href="#choosing-timer-facilities" title="Permanent link">&para;</a></h3>
<p><strong>Use callouts when</strong>:
- Need to schedule a callback in the future
- Timeout needed for asynchronous operations
- Per-device or per-connection timers</p>
<p><strong>Use systimers when</strong>:
- Need periodic system-wide events
- Implementing new clock types
- Low-level kernel timing infrastructure</p>
<p><strong>Use sleep/tsleep when</strong>:
- Need to block a thread for a duration
- Waiting for an event with timeout
- User-space style blocking</p>
<h3 id="callout-usage-guidelines">Callout Usage Guidelines<a class="headerlink" href="#callout-usage-guidelines" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Always initialize</strong>: Call <code>callout_init()</code> or variant before use</li>
<li><strong>MP-safe by default</strong>: Use <code>callout_init_mp()</code> for new code</li>
<li><strong>Cancel on cleanup</strong>: Use <code>callout_terminate()</code> during shutdown</li>
<li><strong>Check return values</strong>: <code>callout_stop()</code> returns whether callout was pending</li>
<li><strong>Avoid long callbacks</strong>: Callouts run in softclock context; keep them brief</li>
<li><strong>Use appropriate CPU</strong>: Consider <code>callout_reset_bycpu()</code> for load distribution</li>
</ol>
<h3 id="time-retrieval-guidelines">Time Retrieval Guidelines<a class="headerlink" href="#time-retrieval-guidelines" title="Permanent link">&para;</a></h3>
<p><strong>For logging/coarse timestamps</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">getmicrotime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span><span class="w">    </span><span class="cm">/* Low overhead, ~10ms resolution */</span>
</code></pre></div></p>
<p><strong>For accurate timestamps</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">microtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span><span class="w">       </span><span class="cm">/* Higher overhead, hardware precision */</span>
</code></pre></div></p>
<p><strong>For measuring intervals</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">microuptime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv1</span><span class="p">);</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="cm">/* ... operation ... */</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">microuptime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv2</span><span class="p">);</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="n">timevalsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tv1</span><span class="p">);</span><span class="w">  </span><span class="cm">/* tv2 now contains elapsed time */</span>
</code></pre></div></p>
<p><strong>Why use *uptime variants for intervals?</strong>:
- Not affected by NTP adjustments
- Monotonically increasing
- Accurate for performance measurements</p>
<h3 id="ntp-considerations">NTP Considerations<a class="headerlink" href="#ntp-considerations" title="Permanent link">&para;</a></h3>
<ul>
<li>NTP adjustments are gradual (typically &lt;500ppm frequency adjustment)</li>
<li>Realtime can jump backward with <code>settimeofday()</code> but not with NTP</li>
<li>For intervals, always use monotonic time (*uptime functions)</li>
<li>Maximum NTP adjustment: 500ms with PLL, more with FLL</li>
</ul>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../lwkt/">LWKT (Lightweight Kernel Threads)</a> - Thread scheduling and execution</li>
<li><a href="../synchronization/">Synchronization Primitives</a> - Locks and synchronization used by timers</li>
<li><a href="../memory/">Memory Management</a> - Memory allocation for timer structures</li>
</ul>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><code>sys/kern/kern_clock.c</code> - System clock implementation</li>
<li><code>sys/kern/kern_timeout.c</code> - Callout/timeout mechanism</li>
<li><code>sys/kern/kern_systimer.c</code> - Software timer infrastructure</li>
<li><code>sys/kern/kern_cputimer.c</code> - Hardware timer abstraction</li>
<li><code>sys/kern/kern_time.c</code> - Time-related system calls</li>
<li><code>sys/kern/kern_ntptime.c</code> - NTP time adjustment</li>
<li><code>sys/sys/systimer.h</code> - Timer data structure definitions</li>
<li><code>sys/sys/callout.h</code> - Callout API definitions</li>
<li><code>sys/sys/time.h</code> - Time representation types</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>