
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../bus-resources/" rel="prev"/>
<link href="../firmware/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Disk Subsystem - DragonFly BSD Kernel Documentation</title>
<link href="../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#disk-subsystem">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Disk Subsystem
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#architecture-overview">
<span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
</a>
<nav aria-label="Architecture Overview" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#device-naming">
<span class="md-ellipsis">
      
        Device Naming
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#minor-number-encoding">
<span class="md-ellipsis">
      
        Minor Number Encoding
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-data-structures">
<span class="md-ellipsis">
      
        Core Data Structures
      
    </span>
</a>
<nav aria-label="Core Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-disk">
<span class="md-ellipsis">
      
        struct disk
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-disk_info">
<span class="md-ellipsis">
      
        struct disk_info
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-diskslices">
<span class="md-ellipsis">
      
        struct diskslices
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-diskslice">
<span class="md-ellipsis">
      
        struct diskslice
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-registration-and-lifecycle">
<span class="md-ellipsis">
      
        Disk Registration and Lifecycle
      
    </span>
</a>
<nav aria-label="Disk Registration and Lifecycle" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-a-disk">
<span class="md-ellipsis">
      
        Creating a Disk
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-disk-information">
<span class="md-ellipsis">
      
        Setting Disk Information
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-message-thread">
<span class="md-ellipsis">
      
        Disk Message Thread
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#slice-and-partition-probing">
<span class="md-ellipsis">
      
        Slice and Partition Probing
      
    </span>
</a>
<nav aria-label="Slice and Partition Probing" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mbr-parsing">
<span class="md-ellipsis">
      
        MBR Parsing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gpt-parsing">
<span class="md-ellipsis">
      
        GPT Parsing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disklabel-probing">
<span class="md-ellipsis">
      
        Disklabel Probing
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disklabel-operations">
<span class="md-ellipsis">
      
        Disklabel Operations
      
    </span>
</a>
<nav aria-label="Disklabel Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#disklabel-operations-structure">
<span class="md-ellipsis">
      
        Disklabel Operations Structure
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-bit-disklabel">
<span class="md-ellipsis">
      
        32-bit Disklabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-bit-disklabel">
<span class="md-ellipsis">
      
        64-bit Disklabel
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#io-path">
<span class="md-ellipsis">
      
        I/O Path
      
    </span>
</a>
<nav aria-label="I/O Path" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-device-operations">
<span class="md-ellipsis">
      
        Disk Device Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#strategy-routine">
<span class="md-ellipsis">
      
        Strategy Routine
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#slice-checking-and-translation">
<span class="md-ellipsis">
      
        Slice Checking and Translation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#io-ordering">
<span class="md-ellipsis">
      
        I/O Ordering
      
    </span>
</a>
<nav aria-label="I/O Ordering" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bio-queue-management">
<span class="md-ellipsis">
      
        BIO Queue Management
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-enumeration">
<span class="md-ellipsis">
      
        Disk Enumeration
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ioctls">
<span class="md-ellipsis">
      
        Ioctls
      
    </span>
</a>
<nav aria-label="Ioctls" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#diskslice-ioctls">
<span class="md-ellipsis">
      
        Disk/Slice Ioctls
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kernel-dumps">
<span class="md-ellipsis">
      
        Kernel Dumps
      
    </span>
</a>
<nav aria-label="Kernel Dumps" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dump-configuration">
<span class="md-ellipsis">
      
        Dump Configuration
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#device-aliases">
<span class="md-ellipsis">
      
        Device Aliases
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initialization">
<span class="md-ellipsis">
      
        Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#io-scheduling-dsched">
<span class="md-ellipsis">
      
        I/O Scheduling (dsched)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctl-interface">
<span class="md-ellipsis">
      
        Sysctl Interface
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer2/">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#architecture-overview">
<span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
</a>
<nav aria-label="Architecture Overview" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#device-naming">
<span class="md-ellipsis">
      
        Device Naming
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#minor-number-encoding">
<span class="md-ellipsis">
      
        Minor Number Encoding
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-data-structures">
<span class="md-ellipsis">
      
        Core Data Structures
      
    </span>
</a>
<nav aria-label="Core Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-disk">
<span class="md-ellipsis">
      
        struct disk
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-disk_info">
<span class="md-ellipsis">
      
        struct disk_info
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-diskslices">
<span class="md-ellipsis">
      
        struct diskslices
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-diskslice">
<span class="md-ellipsis">
      
        struct diskslice
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-registration-and-lifecycle">
<span class="md-ellipsis">
      
        Disk Registration and Lifecycle
      
    </span>
</a>
<nav aria-label="Disk Registration and Lifecycle" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-a-disk">
<span class="md-ellipsis">
      
        Creating a Disk
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-disk-information">
<span class="md-ellipsis">
      
        Setting Disk Information
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-message-thread">
<span class="md-ellipsis">
      
        Disk Message Thread
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#slice-and-partition-probing">
<span class="md-ellipsis">
      
        Slice and Partition Probing
      
    </span>
</a>
<nav aria-label="Slice and Partition Probing" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mbr-parsing">
<span class="md-ellipsis">
      
        MBR Parsing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gpt-parsing">
<span class="md-ellipsis">
      
        GPT Parsing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disklabel-probing">
<span class="md-ellipsis">
      
        Disklabel Probing
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disklabel-operations">
<span class="md-ellipsis">
      
        Disklabel Operations
      
    </span>
</a>
<nav aria-label="Disklabel Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#disklabel-operations-structure">
<span class="md-ellipsis">
      
        Disklabel Operations Structure
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-bit-disklabel">
<span class="md-ellipsis">
      
        32-bit Disklabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-bit-disklabel">
<span class="md-ellipsis">
      
        64-bit Disklabel
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#io-path">
<span class="md-ellipsis">
      
        I/O Path
      
    </span>
</a>
<nav aria-label="I/O Path" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-device-operations">
<span class="md-ellipsis">
      
        Disk Device Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#strategy-routine">
<span class="md-ellipsis">
      
        Strategy Routine
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#slice-checking-and-translation">
<span class="md-ellipsis">
      
        Slice Checking and Translation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#io-ordering">
<span class="md-ellipsis">
      
        I/O Ordering
      
    </span>
</a>
<nav aria-label="I/O Ordering" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bio-queue-management">
<span class="md-ellipsis">
      
        BIO Queue Management
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#disk-enumeration">
<span class="md-ellipsis">
      
        Disk Enumeration
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ioctls">
<span class="md-ellipsis">
      
        Ioctls
      
    </span>
</a>
<nav aria-label="Ioctls" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#diskslice-ioctls">
<span class="md-ellipsis">
      
        Disk/Slice Ioctls
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kernel-dumps">
<span class="md-ellipsis">
      
        Kernel Dumps
      
    </span>
</a>
<nav aria-label="Kernel Dumps" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dump-configuration">
<span class="md-ellipsis">
      
        Dump Configuration
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#device-aliases">
<span class="md-ellipsis">
      
        Device Aliases
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initialization">
<span class="md-ellipsis">
      
        Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#io-scheduling-dsched">
<span class="md-ellipsis">
      
        I/O Scheduling (dsched)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctl-interface">
<span class="md-ellipsis">
      
        Sysctl Interface
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="disk-subsystem">Disk Subsystem<a class="headerlink" href="#disk-subsystem" title="Permanent link">¶</a></h1>
<p>The disk subsystem provides a unified framework for managing block storage
devices, including disk registration, slice/partition handling, and I/O
routing. It bridges device drivers with the filesystem layer through a
multi-level abstraction: whole disk, slices (MBR/GPT partitions), and
BSD partitions (within slices).</p>
<p><strong>Source files:</strong>
- <code>sys/kern/subr_disk.c</code> - Core disk management (~1,600 lines)
- <code>sys/kern/subr_diskslice.c</code> - Slice management (~900 lines)
- <code>sys/kern/subr_diskmbr.c</code> - MBR parsing (~560 lines)
- <code>sys/kern/subr_diskgpt.c</code> - GPT parsing (~240 lines)
- <code>sys/kern/subr_disklabel32.c</code> - BSD 32-bit disklabel (~660 lines)
- <code>sys/kern/subr_disklabel64.c</code> - BSD 64-bit disklabel (~540 lines)</p>
<p><strong>Header files:</strong>
- <code>sys/sys/disk.h</code> - Disk structures
- <code>sys/sys/diskslice.h</code> - Slice structures and helpers</p>
<hr/>
<h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">¶</a></h2>
<p>The disk subsystem implements a three-level hierarchy:</p>
<pre class="mermaid"><code>flowchart TD
    WD["Whole Disk<br/>WHOLE_DISK_SLICE<br/>(e.g., da0)"]
    WD --&gt; S0["Slice 0<br/>(s0/compat)"]
    WD --&gt; S1["Slice 1<br/>(s1)"]
    WD --&gt; SN["Slice N<br/>(sN)"]
    S0 --&gt; P0["Partitions<br/>(a-p)"]
    S1 --&gt; P1["Partitions<br/>(a-p)"]
</code></pre>
<h3 id="device-naming">Device Naming<a class="headerlink" href="#device-naming" title="Permanent link">¶</a></h3>
<p>Disk devices follow a hierarchical naming scheme:</p>
<table>
<thead>
<tr>
<th>Device</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>da0</code></td>
<td>Whole disk (raw, no interpretation)</td>
</tr>
<tr>
<td><code>da0s0</code></td>
<td>Compatibility slice (MBR) or GPT s0</td>
</tr>
<tr>
<td><code>da0s1</code></td>
<td>First slice (MBR partition 1)</td>
</tr>
<tr>
<td><code>da0s1a</code></td>
<td>Partition 'a' within slice 1</td>
</tr>
<tr>
<td><code>da0s1c</code></td>
<td>Raw slice 1 (whole slice)</td>
</tr>
</tbody>
</table>
<h3 id="minor-number-encoding">Minor Number Encoding<a class="headerlink" href="#minor-number-encoding" title="Permanent link">¶</a></h3>
<p>Minor numbers encode unit, slice, and partition:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cm">/* sys/sys/diskslice.h:240-256 */</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">static</span><span class="w"> </span><span class="kr">__inline</span><span class="w"> </span><span class="n">u_int32_t</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nf">dkmakeminor</span><span class="p">(</span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">slice</span><span class="p">,</span><span class="w"> </span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">part</span><span class="p">)</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="p">{</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">unit</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x001f</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">unit</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01e0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">          </span><span class="p">((</span><span class="n">slice</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000f</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">slice</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0070</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">          </span><span class="p">(</span><span class="n">part</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0007</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">part</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0008</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">          </span><span class="p">((</span><span class="n">part</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00F0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">21</span><span class="p">);</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Bit layout (32 bits):</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>| SL2 | PART3 |UNIT_2 |P| SLICE |  MAJOR?  |  UNIT   |PART |
</code></pre></div></p>
<hr/>
<h2 id="core-data-structures">Core Data Structures<a class="headerlink" href="#core-data-structures" title="Permanent link">¶</a></h2>
<h3 id="struct-disk">struct disk<a class="headerlink" href="#struct-disk" title="Permanent link">¶</a></h3>
<p>The primary structure representing a disk device:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cm">/* sys/sys/disk.h:132-148 */</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_ops</span><span class="w">      </span><span class="o">*</span><span class="n">d_dev_ops</span><span class="p">;</span><span class="w">     </span><span class="cm">/* disk layer dev ops */</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_ops</span><span class="w">      </span><span class="o">*</span><span class="n">d_raw_ops</span><span class="p">;</span><span class="w">     </span><span class="cm">/* raw device driver ops */</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">u_int</span><span class="w">               </span><span class="n">d_flags</span><span class="p">;</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">d_opencount</span><span class="p">;</span><span class="w">    </span><span class="cm">/* current open count */</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="n">cdev_t</span><span class="w">              </span><span class="n">d_rawdev</span><span class="p">;</span><span class="w">       </span><span class="cm">/* backing raw device */</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="n">cdev_t</span><span class="w">              </span><span class="n">d_cdev</span><span class="p">;</span><span class="w">         </span><span class="cm">/* whole-disk device */</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w">   </span><span class="o">*</span><span class="n">d_slice</span><span class="p">;</span><span class="w">       </span><span class="cm">/* slice table */</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w">    </span><span class="n">d_info</span><span class="p">;</span><span class="w">         </span><span class="cm">/* media parameters */</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">          </span><span class="o">*</span><span class="n">d_disktype</span><span class="p">;</span><span class="w">    </span><span class="cm">/* disk type string */</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="n">LIST_ENTRY</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span><span class="w">    </span><span class="n">d_list</span><span class="p">;</span><span class="w">         </span><span class="cm">/* global disk list */</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="n">kdmsg_iocom_t</span><span class="w">       </span><span class="n">d_iocom</span><span class="p">;</span><span class="w">        </span><span class="cm">/* cluster import/export */</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">d_refs</span><span class="p">;</span><span class="w">         </span><span class="cm">/* destruction interlock */</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Flags:</strong>
- <code>DISKFLAG_LOCK</code> - Disk operations locked
- <code>DISKFLAG_WANTED</code> - Someone waiting for lock
- <code>DISKFLAG_MARKER</code> - Enumeration marker (not a real disk)</p>
<h3 id="struct-disk_info">struct disk_info<a class="headerlink" href="#struct-disk_info" title="Permanent link">¶</a></h3>
<p>Media parameters provided by the device driver:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="cm">/* sys/sys/disk.h:70-99 */</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">u_int64_t</span><span class="w">   </span><span class="n">d_media_size</span><span class="p">;</span><span class="w">       </span><span class="cm">/* media size in bytes */</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">u_int64_t</span><span class="w">   </span><span class="n">d_media_blocks</span><span class="p">;</span><span class="w">     </span><span class="cm">/* media size in sectors */</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">d_media_blksize</span><span class="p">;</span><span class="w">    </span><span class="cm">/* sector size (bytes) */</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="n">u_int</span><span class="w">       </span><span class="n">d_dsflags</span><span class="p">;</span><span class="w">          </span><span class="cm">/* management flags */</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="cm">/* Optional geometry (legacy CHS) */</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="n">u_int</span><span class="w">       </span><span class="n">d_type</span><span class="p">;</span><span class="w">             </span><span class="cm">/* DTYPE_xxx */</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="n">u_int</span><span class="w">       </span><span class="n">d_nheads</span><span class="p">;</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="n">u_int</span><span class="w">       </span><span class="n">d_ncylinders</span><span class="p">;</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="n">u_int</span><span class="w">       </span><span class="n">d_secpertrack</span><span class="p">;</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="n">u_int</span><span class="w">       </span><span class="n">d_secpercyl</span><span class="p">;</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="n">u_int</span><span class="w">       </span><span class="n">d_trimflag</span><span class="p">;</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="kt">char</span><span class="w">        </span><span class="o">*</span><span class="n">d_serialno</span><span class="p">;</span><span class="w">        </span><span class="cm">/* serial number string */</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="p">};</span>
</code></pre></div>
<p><strong>DSO flags (<code>d_dsflags</code>):</strong></p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DSO_NOLABELS</code></td>
<td>0x0001</td>
<td>Don't probe for labels</td>
</tr>
<tr>
<td><code>DSO_ONESLICE</code></td>
<td>0x0002</td>
<td>Single slice only</td>
</tr>
<tr>
<td><code>DSO_COMPATLABEL</code></td>
<td>0x0004</td>
<td>Create compatibility label if none</td>
</tr>
<tr>
<td><code>DSO_COMPATPARTA</code></td>
<td>0x0008</td>
<td>Create partition 'a' in compat label</td>
</tr>
<tr>
<td><code>DSO_RAWEXTENSIONS</code></td>
<td>0x0020</td>
<td>Allow raw partition extensions</td>
</tr>
<tr>
<td><code>DSO_MBRQUIET</code></td>
<td>0x0040</td>
<td>Silent MBR probe failures</td>
</tr>
<tr>
<td><code>DSO_DEVICEMAPPER</code></td>
<td>0x0080</td>
<td>Device mapper (use "." separator)</td>
</tr>
<tr>
<td><code>DSO_RAWPSIZE</code></td>
<td>0x0100</td>
<td>Use raw device psize on failure</td>
</tr>
</tbody>
</table>
<h3 id="struct-diskslices">struct diskslices<a class="headerlink" href="#struct-diskslices" title="Permanent link">¶</a></h3>
<p>Container for all slices on a disk:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="cm">/* sys/sys/diskslice.h:167-177 */</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdevsw</span><span class="w">   </span><span class="o">*</span><span class="n">dss_cdevsw</span><span class="p">;</span><span class="w">        </span><span class="cm">/* containing device switch */</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">dss_first_bsd_slice</span><span class="p">;</span><span class="w"> </span><span class="cm">/* COMPATIBILITY_SLICE mapped here */</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">u_int</span><span class="w">           </span><span class="n">dss_nslices</span><span class="p">;</span><span class="w">        </span><span class="cm">/* actual number of slices */</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">u_int</span><span class="w">           </span><span class="n">dss_oflags</span><span class="p">;</span><span class="w">         </span><span class="cm">/* flags for first open */</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">dss_secmult</span><span class="p">;</span><span class="w">        </span><span class="cm">/* block-to-sector multiplier */</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">dss_secshift</span><span class="p">;</span><span class="w">       </span><span class="cm">/* block-to-sector shift (-1 if N/A) */</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">dss_secsize</span><span class="p">;</span><span class="w">        </span><span class="cm">/* sector size */</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="n">dss_slices</span><span class="p">[</span><span class="n">MAX_SLICES</span><span class="p">];</span>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="p">};</span>
</code></pre></div>
<h3 id="struct-diskslice">struct diskslice<a class="headerlink" href="#struct-diskslice" title="Permanent link">¶</a></h3>
<p>Individual slice (MBR partition or GPT entry):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="cm">/* sys/sys/diskslice.h:142-163 */</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="n">cdev_t</span><span class="w">          </span><span class="n">ds_dev</span><span class="p">;</span><span class="w">             </span><span class="cm">/* device for this slice */</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="n">u_int64_t</span><span class="w">       </span><span class="n">ds_offset</span><span class="p">;</span><span class="w">          </span><span class="cm">/* starting sector */</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="n">u_int64_t</span><span class="w">       </span><span class="n">ds_size</span><span class="p">;</span><span class="w">            </span><span class="cm">/* number of sectors */</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="n">u_int32_t</span><span class="w">       </span><span class="n">ds_reserved</span><span class="p">;</span><span class="w">        </span><span class="cm">/* reserved sectors (label area) */</span>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uuid</span><span class="w">     </span><span class="n">ds_type_uuid</span><span class="p">;</span><span class="w">       </span><span class="cm">/* slice type UUID (GPT) */</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uuid</span><span class="w">     </span><span class="n">ds_stor_uuid</span><span class="p">;</span><span class="w">       </span><span class="cm">/* storage UUID (GPT) */</span>
<a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">ds_type</span><span class="p">;</span><span class="w">            </span><span class="cm">/* MBR partition type */</span>
<a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">ds_flags</span><span class="p">;</span><span class="w">           </span><span class="cm">/* DSF_ flags */</span>
<a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="n">disklabel_t</span><span class="w">     </span><span class="n">ds_label</span><span class="p">;</span><span class="w">           </span><span class="cm">/* BSD label (if present) */</span>
<a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ds_ops</span><span class="p">;</span><span class="w">       </span><span class="cm">/* label operations */</span>
<a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="kt">void</span><span class="w">            </span><span class="o">*</span><span class="n">ds_devs</span><span class="p">[</span><span class="n">MAXPARTITIONS</span><span class="p">];</span>
<a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">    </span><span class="n">u_int32_t</span><span class="w">       </span><span class="n">ds_openmask</span><span class="p">[</span><span class="n">DKMAXPARTITIONS</span><span class="o">/</span><span class="mi">32</span><span class="p">];</span>
<a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="n">u_char</span><span class="w">          </span><span class="n">ds_wlabel</span><span class="p">;</span><span class="w">          </span><span class="cm">/* label writable flag */</span>
<a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">ds_ttlopens</span><span class="p">;</span><span class="w">        </span><span class="cm">/* total opens */</span>
<a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Special slices:</strong></p>
<table>
<thead>
<tr>
<th>Constant</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>COMPATIBILITY_SLICE</code></td>
<td>0</td>
<td>Compatibility (s0)</td>
</tr>
<tr>
<td><code>WHOLE_DISK_SLICE</code></td>
<td>1</td>
<td>Entire disk</td>
</tr>
<tr>
<td><code>BASE_SLICE</code></td>
<td>2</td>
<td>First real slice (s1)</td>
</tr>
<tr>
<td><code>WHOLE_SLICE_PART</code></td>
<td>255</td>
<td>Entire slice partition</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="disk-registration-and-lifecycle">Disk Registration and Lifecycle<a class="headerlink" href="#disk-registration-and-lifecycle" title="Permanent link">¶</a></h2>
<h3 id="creating-a-disk">Creating a Disk<a class="headerlink" href="#creating-a-disk" title="Permanent link">¶</a></h3>
<p>Device drivers register disks using <code>disk_create()</code>:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="cm">/* sys/kern/subr_disk.c:664-765 */</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">cdev_t</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nf">disk_create</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_ops</span><span class="w"> </span><span class="o">*</span><span class="n">raw_ops</span><span class="p">)</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="p">{</span>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_disk_create_named</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">raw_ops</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="p">}</span>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="k">static</span><span class="w"> </span><span class="n">cdev_t</span>
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="nf">_disk_create_named</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">,</span>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_ops</span><span class="w"> </span><span class="o">*</span><span class="n">raw_ops</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">clone</span><span class="p">)</span>
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="p">{</span>
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="n">cdev_t</span><span class="w"> </span><span class="n">rawdev</span><span class="p">;</span>
<a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_ops</span><span class="w"> </span><span class="o">*</span><span class="n">dops</span><span class="p">;</span>
<a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>
<a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="cm">/* Create raw device (no slice/partition interpretation) */</span>
<a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">        </span><span class="n">rawdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_only_dev</span><span class="p">(</span><span class="n">raw_ops</span><span class="p">,</span><span class="w"> </span><span class="n">dkmakewholedisk</span><span class="p">(</span><span class="n">unit</span><span class="p">),</span>
<a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">                               </span><span class="n">UID_ROOT</span><span class="p">,</span><span class="w"> </span><span class="n">GID_OPERATOR</span><span class="p">,</span><span class="w"> </span><span class="mo">0640</span><span class="p">,</span><span class="w"> </span><span class="s">"%s"</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">        </span><span class="n">rawdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_only_dev</span><span class="p">(</span><span class="n">raw_ops</span><span class="p">,</span><span class="w"> </span><span class="n">dkmakewholedisk</span><span class="p">(</span><span class="n">unit</span><span class="p">),</span>
<a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">                               </span><span class="n">UID_ROOT</span><span class="p">,</span><span class="w"> </span><span class="n">GID_OPERATOR</span><span class="p">,</span><span class="w"> </span><span class="mo">0640</span><span class="p">,</span>
<a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">                               </span><span class="s">"%s%d"</span><span class="p">,</span><span class="w"> </span><span class="n">raw_ops</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">);</span>
<a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a>
<a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="n">bzero</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dp</span><span class="p">));</span>
<a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a>
<a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="cm">/* Select disk ops based on D_NOEMERGPGR flag */</span>
<a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">    </span><span class="n">dops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">raw_ops</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">D_NOEMERGPGR</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disk2_ops</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disk1_ops</span><span class="p">;</span>
<a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a>
<a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_rawdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawdev</span><span class="p">;</span>
<a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">    </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_raw_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_ops</span><span class="p">;</span>
<a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">    </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_dev_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dops</span><span class="p">;</span>
<a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a>
<a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">    </span><span class="cm">/* Create covering device for slice/partition management */</span>
<a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">        </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_cdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_only_dev_covering</span><span class="p">(...);</span>
<a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">        </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_cdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_dev_covering</span><span class="p">(...);</span>
<a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a>
<a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">    </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_cdev</span><span class="o">-&gt;</span><span class="n">si_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp</span><span class="p">;</span>
<a href="#__codelineno-6-42" id="__codelineno-6-42" name="__codelineno-6-42"></a>
<a href="#__codelineno-6-43" id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">    </span><span class="cm">/* Initialize I/O scheduling */</span>
<a href="#__codelineno-6-44" id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">    </span><span class="n">dsched_disk_create</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">);</span>
<a href="#__codelineno-6-45" id="__codelineno-6-45" name="__codelineno-6-45"></a>
<a href="#__codelineno-6-46" id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">    </span><span class="cm">/* Add to global disk list */</span>
<a href="#__codelineno-6-47" id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="n">lwkt_gettoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-6-48" id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">    </span><span class="n">LIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">d_list</span><span class="p">);</span>
<a href="#__codelineno-6-49" id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">    </span><span class="n">lwkt_reltoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-6-50" id="__codelineno-6-50" name="__codelineno-6-50"></a>
<a href="#__codelineno-6-51" id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">    </span><span class="cm">/* Initialize cluster support */</span>
<a href="#__codelineno-6-52" id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">    </span><span class="n">disk_iocom_init</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<a href="#__codelineno-6-53" id="__codelineno-6-53" name="__codelineno-6-53"></a>
<a href="#__codelineno-6-54" id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_rawdev</span><span class="p">;</span>
<a href="#__codelineno-6-55" id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="p">}</span>
</code></pre></div>
<h3 id="setting-disk-information">Setting Disk Information<a class="headerlink" href="#setting-disk-information" title="Permanent link">¶</a></h3>
<p>After creating the disk, drivers provide media parameters:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="cm">/* sys/kern/subr_disk.c:853-869 */</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kt">void</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nf">disk_setdiskinfo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">{</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="n">_setdiskinfo</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="n">disk_msg_send</span><span class="p">(</span><span class="n">DISK_DISK_PROBE</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="p">}</span>
<a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>
<a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="nf">_setdiskinfo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span>
<a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="p">{</span>
<a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="cm">/* Copy info, duplicate serial number */</span>
<a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="n">bcopy</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">d_info</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">d_info</span><span class="p">));</span>
<a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>
<a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_serialno</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_serialno</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">        </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_serialno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kstrdup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_serialno</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">        </span><span class="n">disk_cleanserial</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_serialno</span><span class="p">);</span>
<a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">        </span><span class="n">make_dev_alias</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">d_cdev</span><span class="p">,</span><span class="w"> </span><span class="s">"serno/%s"</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_serialno</span><span class="p">);</span>
<a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>
<a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">    </span><span class="cm">/* Calculate size from blocks or vice versa */</span>
<a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">        </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_int64_t</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blocks</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">                             </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a>
<a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">    </span><span class="n">dsched_disk_update</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="p">}</span>
</code></pre></div>
<h3 id="disk-message-thread">Disk Message Thread<a class="headerlink" href="#disk-message-thread" title="Permanent link">¶</a></h3>
<p>A dedicated kernel thread processes disk operations asynchronously:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="cm">/* sys/kern/subr_disk.c:500-601 */</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nf">disk_msg_core</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="p">{</span>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">;</span>
<a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">;</span>
<a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="n">disk_msg_t</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="n">lwkt_initport_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_msg_port</span><span class="p">,</span><span class="w"> </span><span class="n">curthread</span><span class="p">);</span>
<a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">run</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">        </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">disk_msg_t</span><span class="p">)</span><span class="n">lwkt_waitport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_msg_port</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a>
<a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ms_result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">DISK_DISK_PROBE</span><span class="p">:</span>
<a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">            </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
<a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">            </span><span class="n">disk_iocom_update</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">            </span><span class="n">disk_probe</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a>
<a href="#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">DISK_DISK_DESTROY</span><span class="p">:</span>
<a href="#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">            </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
<a href="#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">            </span><span class="n">disk_iocom_uninit</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<a href="#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a>
<a href="#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">            </span><span class="cm">/* Wait for references to drain */</span>
<a href="#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_refs</span><span class="p">)</span>
<a href="#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">                </span><span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_refs</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"diskdel"</span><span class="p">,</span><span class="w"> </span><span class="n">hz</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<a href="#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">            </span><span class="n">LIST_REMOVE</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">d_list</span><span class="p">);</span>
<a href="#__codelineno-8-29" id="__codelineno-8-29" name="__codelineno-8-29"></a>
<a href="#__codelineno-8-30" id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">            </span><span class="n">dsched_disk_destroy</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
<a href="#__codelineno-8-31" id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">            </span><span class="n">devfs_destroy_related</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_cdev</span><span class="p">);</span>
<a href="#__codelineno-8-32" id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">            </span><span class="n">destroy_dev</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_cdev</span><span class="p">);</span>
<a href="#__codelineno-8-33" id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">            </span><span class="n">destroy_only_dev</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_rawdev</span><span class="p">);</span>
<a href="#__codelineno-8-34" id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-8-35" id="__codelineno-8-35" name="__codelineno-8-35"></a>
<a href="#__codelineno-8-36" id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">DISK_SLICE_REPROBE</span><span class="p">:</span>
<a href="#__codelineno-8-37" id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="w">            </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
<a href="#__codelineno-8-38" id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="w">            </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">load2</span><span class="p">;</span>
<a href="#__codelineno-8-39" id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="w">            </span><span class="n">disk_probe_slice</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_dev</span><span class="p">,</span><span class="w"> </span><span class="n">dkslice</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_dev</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a href="#__codelineno-8-40" id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-8-41" id="__codelineno-8-41" name="__codelineno-8-41"></a>
<a href="#__codelineno-8-42" id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">DISK_DISK_REPROBE</span><span class="p">:</span>
<a href="#__codelineno-8-43" id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">            </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
<a href="#__codelineno-8-44" id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">            </span><span class="n">disk_probe</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a href="#__codelineno-8-45" id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-8-46" id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-8-47" id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="w">        </span><span class="n">lwkt_replymsg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-8-48" id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-8-49" id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Message types:</strong></p>
<table>
<thead>
<tr>
<th>Message</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DISK_DISK_PROBE</code></td>
<td>Initial disk probe (parse MBR/GPT)</td>
</tr>
<tr>
<td><code>DISK_DISK_DESTROY</code></td>
<td>Disk removal</td>
</tr>
<tr>
<td><code>DISK_SLICE_REPROBE</code></td>
<td>Re-probe single slice</td>
</tr>
<tr>
<td><code>DISK_DISK_REPROBE</code></td>
<td>Re-probe entire disk</td>
</tr>
<tr>
<td><code>DISK_UNPROBE</code></td>
<td>Remove slice devices</td>
</tr>
<tr>
<td><code>DISK_SYNC</code></td>
<td>Synchronization barrier</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="slice-and-partition-probing">Slice and Partition Probing<a class="headerlink" href="#slice-and-partition-probing" title="Permanent link">¶</a></h2>
<h3 id="mbr-parsing">MBR Parsing<a class="headerlink" href="#mbr-parsing" title="Permanent link">¶</a></h3>
<p>MBR (Master Boot Record) parsing handles traditional PC partition tables:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="cm">/* sys/kern/subr_diskmbr.c:89-322 */</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kt">int</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="nf">mbrinit</span><span class="p">(</span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">**</span><span class="n">sspp</span><span class="p">)</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="p">{</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="p">;</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dos_partition</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">;</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dos_partition</span><span class="w"> </span><span class="n">dpcopy</span><span class="p">[</span><span class="n">NDOSPART</span><span class="p">];</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">    </span><span class="cm">/* Read sector 0 */</span>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getpbuf_mem</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="n">mbr_offset</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="p">;</span>
<a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="n">dev_dstrategy</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>
<a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">biowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">,</span><span class="w"> </span><span class="s">"mbrrd"</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EIO</span><span class="p">;</span>
<a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a>
<a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">    </span><span class="cm">/* Verify magic number */</span>
<a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">    </span><span class="n">cp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
<a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mh">0x1FE</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x55</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cp</span><span class="p">[</span><span class="mh">0x1FF</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xAA</span><span class="p">)</span>
<a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a>
<a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">    </span><span class="cm">/* Copy partition table */</span>
<a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpcopy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DOSPARTOFF</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">dpcopy</span><span class="p">));</span>
<a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a>
<a href="#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="cm">/* Check for GPT (PMBR) */</span>
<a href="#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dospart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp0</span><span class="p">;</span><span class="w"> </span><span class="n">dospart</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NDOSPART</span><span class="p">;</span><span class="w"> </span><span class="n">dospart</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dospart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dp_typ</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DOSPTYP_PMBR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">gptinit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">sspp</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Switch to GPT */</span>
<a href="#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dp_typ</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DOSPTYP_ONTRACK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">            </span><span class="cm">/* Ontrack Disk Manager - retry at sector 63 */</span>
<a href="#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">            </span><span class="n">mbr_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">63</span><span class="p">;</span>
<a href="#__codelineno-9-35" id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">reread_mbr</span><span class="p">;</span>
<a href="#__codelineno-9-36" id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-9-37" id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-38" id="__codelineno-9-38" name="__codelineno-9-38"></a>
<a href="#__codelineno-9-39" id="__codelineno-9-39" name="__codelineno-9-39"></a><span class="w">    </span><span class="cm">/* Create slice structures */</span>
<a href="#__codelineno-9-40" id="__codelineno-9-40" name="__codelineno-9-40"></a><span class="w">    </span><span class="n">ssp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsmakeslicestruct</span><span class="p">(</span><span class="n">MAX_SLICES</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-9-41" id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="w">    </span><span class="o">*</span><span class="n">sspp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssp</span><span class="p">;</span>
<a href="#__codelineno-9-42" id="__codelineno-9-42" name="__codelineno-9-42"></a>
<a href="#__codelineno-9-43" id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="w">    </span><span class="cm">/* Initialize slices from MBR entries */</span>
<a href="#__codelineno-9-44" id="__codelineno-9-44" name="__codelineno-9-44"></a><span class="w">    </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_slices</span><span class="p">[</span><span class="n">BASE_SLICE</span><span class="p">];</span>
<a href="#__codelineno-9-45" id="__codelineno-9-45" name="__codelineno-9-45"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dospart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">dospart</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NDOSPART</span><span class="p">;</span><span class="w"> </span><span class="n">dospart</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-46" id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">        </span><span class="n">mbr_setslice</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">mbr_offset</span><span class="p">);</span>
<a href="#__codelineno-9-47" id="__codelineno-9-47" name="__codelineno-9-47"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-48" id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="w">    </span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_nslices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_SLICE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NDOSPART</span><span class="p">;</span>
<a href="#__codelineno-9-49" id="__codelineno-9-49" name="__codelineno-9-49"></a>
<a href="#__codelineno-9-50" id="__codelineno-9-50" name="__codelineno-9-50"></a><span class="w">    </span><span class="cm">/* Handle extended partitions (recursive) */</span>
<a href="#__codelineno-9-51" id="__codelineno-9-51" name="__codelineno-9-51"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dospart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">dospart</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NDOSPART</span><span class="p">;</span><span class="w"> </span><span class="n">dospart</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-52" id="__codelineno-9-52" name="__codelineno-9-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DOSPTYP_EXT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DOSPTYP_EXTLBA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-53" id="__codelineno-9-53" name="__codelineno-9-53"></a><span class="w">            </span><span class="n">mbr_extended</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_offset</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_size</span><span class="p">,</span>
<a href="#__codelineno-9-54" id="__codelineno-9-54" name="__codelineno-9-54"></a><span class="w">                         </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_offset</span><span class="p">,</span><span class="w"> </span><span class="n">max_nsectors</span><span class="p">,</span><span class="w"> </span><span class="n">max_ntracks</span><span class="p">,</span>
<a href="#__codelineno-9-55" id="__codelineno-9-55" name="__codelineno-9-55"></a><span class="w">                         </span><span class="n">mbr_offset</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a href="#__codelineno-9-56" id="__codelineno-9-56" name="__codelineno-9-56"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-9-57" id="__codelineno-9-57" name="__codelineno-9-57"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-58" id="__codelineno-9-58" name="__codelineno-9-58"></a>
<a href="#__codelineno-9-59" id="__codelineno-9-59" name="__codelineno-9-59"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-9-60" id="__codelineno-9-60" name="__codelineno-9-60"></a><span class="p">}</span>
</code></pre></div>
<h3 id="gpt-parsing">GPT Parsing<a class="headerlink" href="#gpt-parsing" title="Permanent link">¶</a></h3>
<p>GPT (GUID Partition Table) provides modern partition support:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="cm">/* sys/kern/subr_diskgpt.c:62-229 */</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kt">int</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="nf">gptinit</span><span class="p">(</span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">**</span><span class="n">sspp</span><span class="p">)</span>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="p">{</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpt_hdr</span><span class="w"> </span><span class="o">*</span><span class="n">gpt</span><span class="p">;</span>
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpt_ent</span><span class="w"> </span><span class="o">*</span><span class="n">ent</span><span class="p">;</span>
<a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>
<a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="cm">/* Read GPT header at LBA 1 */</span>
<a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="n">bp1</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="n">bp1</span><span class="o">-&gt;</span><span class="n">b_bcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="n">bp1</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUF_CMD_READ</span><span class="p">;</span>
<a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="n">dev_dstrategy</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp1</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>
<a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="n">gpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bp1</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
<a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a>
<a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">    </span><span class="cm">/* Validate header */</span>
<a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le32toh</span><span class="p">(</span><span class="n">gpt</span><span class="o">-&gt;</span><span class="n">hdr_size</span><span class="p">);</span>
<a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GPT_MIN_HDR_SIZE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">)</span>
<a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a>
<a href="#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">    </span><span class="cm">/* Verify CRC32 */</span>
<a href="#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">    </span><span class="n">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le32toh</span><span class="p">(</span><span class="n">gpt</span><span class="o">-&gt;</span><span class="n">hdr_crc_self</span><span class="p">);</span>
<a href="#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="n">gpt</span><span class="o">-&gt;</span><span class="n">hdr_crc_self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="n">gpt</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">crc</span><span class="p">)</span>
<a href="#__codelineno-10-25" id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<a href="#__codelineno-10-26" id="__codelineno-10-26" name="__codelineno-10-26"></a>
<a href="#__codelineno-10-27" id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">    </span><span class="cm">/* Read partition entries */</span>
<a href="#__codelineno-10-28" id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="w">    </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le32toh</span><span class="p">(</span><span class="n">gpt</span><span class="o">-&gt;</span><span class="n">hdr_entries</span><span class="p">);</span>
<a href="#__codelineno-10-29" id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">    </span><span class="n">entsz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le32toh</span><span class="p">(</span><span class="n">gpt</span><span class="o">-&gt;</span><span class="n">hdr_entsz</span><span class="p">);</span>
<a href="#__codelineno-10-30" id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">    </span><span class="n">table_lba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le32toh</span><span class="p">(</span><span class="n">gpt</span><span class="o">-&gt;</span><span class="n">hdr_lba_table</span><span class="p">);</span>
<a href="#__codelineno-10-31" id="__codelineno-10-31" name="__codelineno-10-31"></a>
<a href="#__codelineno-10-32" id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">    </span><span class="n">bp2</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">.</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="n">table_lba</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-10-33" id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">    </span><span class="n">bp2</span><span class="o">-&gt;</span><span class="n">b_bcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_blocks</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-10-34" id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">    </span><span class="n">dev_dstrategy</span><span class="p">(</span><span class="n">wdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bp2</span><span class="o">-&gt;</span><span class="n">b_bio1</span><span class="p">);</span>
<a href="#__codelineno-10-35" id="__codelineno-10-35" name="__codelineno-10-35"></a>
<a href="#__codelineno-10-36" id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">    </span><span class="cm">/* Create slice structure for up to 128 partitions */</span>
<a href="#__codelineno-10-37" id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">    </span><span class="n">ssp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsmakeslicestruct</span><span class="p">(</span><span class="n">BASE_SLICE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-10-38" id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">    </span><span class="o">*</span><span class="n">sspp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ssp</span><span class="p">;</span>
<a href="#__codelineno-10-39" id="__codelineno-10-39" name="__codelineno-10-39"></a>
<a href="#__codelineno-10-40" id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">    </span><span class="cm">/* Process each GPT entry */</span>
<a href="#__codelineno-10-41" id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-10-42" id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">        </span><span class="n">ent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bp2</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">entsz</span><span class="p">);</span>
<a href="#__codelineno-10-43" id="__codelineno-10-43" name="__codelineno-10-43"></a>
<a href="#__codelineno-10-44" id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="w">        </span><span class="cm">/* Convert from little-endian */</span>
<a href="#__codelineno-10-45" id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="w">        </span><span class="n">le_uuid_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">ent_type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sent</span><span class="p">.</span><span class="n">ent_type</span><span class="p">);</span>
<a href="#__codelineno-10-46" id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="w">        </span><span class="n">le_uuid_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">ent_uuid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sent</span><span class="p">.</span><span class="n">ent_uuid</span><span class="p">);</span>
<a href="#__codelineno-10-47" id="__codelineno-10-47" name="__codelineno-10-47"></a><span class="w">        </span><span class="n">sent</span><span class="p">.</span><span class="n">ent_lba_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le64toh</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">ent_lba_start</span><span class="p">);</span>
<a href="#__codelineno-10-48" id="__codelineno-10-48" name="__codelineno-10-48"></a><span class="w">        </span><span class="n">sent</span><span class="p">.</span><span class="n">ent_lba_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le64toh</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">ent_lba_end</span><span class="p">);</span>
<a href="#__codelineno-10-49" id="__codelineno-10-49" name="__codelineno-10-49"></a>
<a href="#__codelineno-10-50" id="__codelineno-10-50" name="__codelineno-10-50"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kuuid_is_nil</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sent</span><span class="p">.</span><span class="n">ent_type</span><span class="p">))</span>
<a href="#__codelineno-10-51" id="__codelineno-10-51" name="__codelineno-10-51"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-10-52" id="__codelineno-10-52" name="__codelineno-10-52"></a>
<a href="#__codelineno-10-53" id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="w">        </span><span class="cm">/* GPT entry 0 -&gt; COMPATIBILITY_SLICE, others -&gt; BASE_SLICE+i-1 */</span>
<a href="#__codelineno-10-54" id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-10-55" id="__codelineno-10-55" name="__codelineno-10-55"></a><span class="w">            </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_slices</span><span class="p">[</span><span class="n">COMPATIBILITY_SLICE</span><span class="p">];</span>
<a href="#__codelineno-10-56" id="__codelineno-10-56" name="__codelineno-10-56"></a><span class="w">        </span><span class="k">else</span>
<a href="#__codelineno-10-57" id="__codelineno-10-57" name="__codelineno-10-57"></a><span class="w">            </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_slices</span><span class="p">[</span><span class="n">BASE_SLICE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<a href="#__codelineno-10-58" id="__codelineno-10-58" name="__codelineno-10-58"></a>
<a href="#__codelineno-10-59" id="__codelineno-10-59" name="__codelineno-10-59"></a><span class="w">        </span><span class="n">gpt_setslice</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sent</span><span class="p">);</span>
<a href="#__codelineno-10-60" id="__codelineno-10-60" name="__codelineno-10-60"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-10-61" id="__codelineno-10-61" name="__codelineno-10-61"></a>
<a href="#__codelineno-10-62" id="__codelineno-10-62" name="__codelineno-10-62"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-10-63" id="__codelineno-10-63" name="__codelineno-10-63"></a><span class="p">}</span>
</code></pre></div>
<h3 id="disklabel-probing">Disklabel Probing<a class="headerlink" href="#disklabel-probing" title="Permanent link">¶</a></h3>
<p>BSD disklabels are probed within slices:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="cm">/* sys/kern/subr_disk.c:184-340 */</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nf">disk_probe_slice</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">slice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reprobe</span><span class="p">)</span>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="p">{</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_info</span><span class="p">;</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_slice</span><span class="o">-&gt;</span><span class="n">dss_slices</span><span class="p">[</span><span class="n">slice</span><span class="p">];</span>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="n">disklabel_ops_t</span><span class="w"> </span><span class="n">ops</span><span class="p">;</span>
<a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">;</span>
<a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="cm">/* Try 32-bit disklabel first */</span>
<a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disklabel32_ops</span><span class="p">;</span>
<a href="#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_readdisklabel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a>
<a href="#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span><span class="cm">/* If not found, try 64-bit disklabel */</span>
<a href="#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="s">"no disk label"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">        </span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disklabel64_ops</span><span class="p">;</span>
<a href="#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">        </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_readdisklabel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a>
<a href="#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">        </span><span class="cm">/* Label found - create partition devices */</span>
<a href="#__codelineno-11-22" id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">        </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="p">;</span>
<a href="#__codelineno-11-23" id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_getnumparts</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-24" id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">            </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_loadpartinfo</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">part</span><span class="p">);</span>
<a href="#__codelineno-11-25" id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">part</span><span class="p">.</span><span class="n">fstype</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-26" id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">                </span><span class="n">ndev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_dev_covering</span><span class="p">(</span><span class="n">dops</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_rawdev</span><span class="o">-&gt;</span><span class="n">si_ops</span><span class="p">,</span>
<a href="#__codelineno-11-27" id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">                        </span><span class="n">dkmakeminor</span><span class="p">(</span><span class="n">dkunit</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_cdev</span><span class="p">),</span><span class="w"> </span><span class="n">slice</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span>
<a href="#__codelineno-11-28" id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">                        </span><span class="n">UID_ROOT</span><span class="p">,</span><span class="w"> </span><span class="n">GID_OPERATOR</span><span class="p">,</span><span class="w"> </span><span class="mo">0640</span><span class="p">,</span>
<a href="#__codelineno-11-29" id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">                        </span><span class="s">"%s%c"</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">si_name</span><span class="p">,</span><span class="w"> </span><span class="sc">'a'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a href="#__codelineno-11-30" id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">                </span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">si_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp</span><span class="p">;</span>
<a href="#__codelineno-11-31" id="__codelineno-11-31" name="__codelineno-11-31"></a>
<a href="#__codelineno-11-32" id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="w">                </span><span class="cm">/* Create UUID alias if available */</span>
<a href="#__codelineno-11-33" id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">kuuid_is_nil</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="p">.</span><span class="n">storage_uuid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-34" id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">                    </span><span class="n">snprintf_uuid</span><span class="p">(</span><span class="n">uuid_buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">uuid_buf</span><span class="p">),</span>
<a href="#__codelineno-11-35" id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">                                  </span><span class="o">&amp;</span><span class="n">part</span><span class="p">.</span><span class="n">storage_uuid</span><span class="p">);</span>
<a href="#__codelineno-11-36" id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="w">                    </span><span class="n">make_dev_alias</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span><span class="w"> </span><span class="s">"part-by-uuid/%s"</span><span class="p">,</span><span class="w"> </span><span class="n">uuid_buf</span><span class="p">);</span>
<a href="#__codelineno-11-37" id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="w">                </span><span class="p">}</span>
<a href="#__codelineno-11-38" id="__codelineno-11-38" name="__codelineno-11-38"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-11-39" id="__codelineno-11-39" name="__codelineno-11-39"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-11-40" id="__codelineno-11-40" name="__codelineno-11-40"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_dsflags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DSO_COMPATLABEL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-41" id="__codelineno-11-41" name="__codelineno-11-41"></a><span class="w">        </span><span class="cm">/* Create compatibility label */</span>
<a href="#__codelineno-11-42" id="__codelineno-11-42" name="__codelineno-11-42"></a><span class="w">        </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_clone_label</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">);</span>
<a href="#__codelineno-11-43" id="__codelineno-11-43" name="__codelineno-11-43"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-11-44" id="__codelineno-11-44" name="__codelineno-11-44"></a>
<a href="#__codelineno-11-45" id="__codelineno-11-45" name="__codelineno-11-45"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EINVAL</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-11-46" id="__codelineno-11-46" name="__codelineno-11-46"></a><span class="p">}</span>
</code></pre></div>
<hr/>
<h2 id="disklabel-operations">Disklabel Operations<a class="headerlink" href="#disklabel-operations" title="Permanent link">¶</a></h2>
<h3 id="disklabel-operations-structure">Disklabel Operations Structure<a class="headerlink" href="#disklabel-operations-structure" title="Permanent link">¶</a></h3>
<p>Both 32-bit and 64-bit disklabels use a common operations interface:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="cm">/* sys/sys/disklabel.h (conceptual) */</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel_ops</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">labelsize</span><span class="p">;</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">op_readdisklabel</span><span class="p">)(</span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">,</span>
<a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">                                    </span><span class="n">disklabel_t</span><span class="w"> </span><span class="o">*</span><span class="n">lpp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_setdisklabel</span><span class="p">)(</span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">olp</span><span class="p">,</span><span class="w"> </span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">nlp</span><span class="p">,</span>
<a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">                           </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">*</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">,</span>
<a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">                           </span><span class="n">u_int32_t</span><span class="w"> </span><span class="o">*</span><span class="n">openmask</span><span class="p">);</span>
<a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_writedisklabel</span><span class="p">)(</span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">*</span><span class="n">ssp</span><span class="p">,</span>
<a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">                             </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">lp</span><span class="p">);</span>
<a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="n">disklabel_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_clone_label</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">);</span>
<a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_adjust_label_reserved</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">*</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">slice</span><span class="p">,</span>
<a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">                                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">);</span>
<a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_getpartbounds</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">*</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">lp</span><span class="p">,</span>
<a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">                            </span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="n">u_int64_t</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">u_int64_t</span><span class="w"> </span><span class="o">*</span><span class="n">blocks</span><span class="p">);</span>
<a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_loadpartinfo</span><span class="p">)(</span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">part</span><span class="p">,</span>
<a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">                            </span><span class="k">struct</span><span class="w"> </span><span class="nc">partinfo</span><span class="w"> </span><span class="o">*</span><span class="n">dpart</span><span class="p">);</span>
<a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">    </span><span class="n">u_int32_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_getnumparts</span><span class="p">)(</span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">lp</span><span class="p">);</span>
<a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_makevirginlabel</span><span class="p">)(</span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">*</span><span class="n">ssp</span><span class="p">,</span>
<a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">                               </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_getpackname</span><span class="p">)(</span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<a href="#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">op_freedisklabel</span><span class="p">)(</span><span class="n">disklabel_t</span><span class="w"> </span><span class="o">*</span><span class="n">lpp</span><span class="p">);</span>
<a href="#__codelineno-12-24" id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="p">};</span>
</code></pre></div>
<h3 id="32-bit-disklabel">32-bit Disklabel<a class="headerlink" href="#32-bit-disklabel" title="Permanent link">¶</a></h3>
<p>Traditional BSD disklabel format (up to 2TB):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="cm">/* sys/kern/subr_disklabel32.c:647-660 */</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel_ops</span><span class="w"> </span><span class="n">disklabel32_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="p">.</span><span class="n">labelsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel32</span><span class="p">),</span>
<a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="p">.</span><span class="n">op_readdisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_readdisklabel</span><span class="p">,</span>
<a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="p">.</span><span class="n">op_setdisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_setdisklabel</span><span class="p">,</span>
<a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="p">.</span><span class="n">op_writedisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_writedisklabel</span><span class="p">,</span>
<a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="p">.</span><span class="n">op_clone_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_clone_label</span><span class="p">,</span>
<a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="p">.</span><span class="n">op_adjust_label_reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_adjust_label_reserved</span><span class="p">,</span>
<a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="p">.</span><span class="n">op_getpartbounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_getpartbounds</span><span class="p">,</span>
<a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="p">.</span><span class="n">op_loadpartinfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_loadpartinfo</span><span class="p">,</span>
<a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="p">.</span><span class="n">op_getnumparts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_getnumparts</span><span class="p">,</span>
<a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">    </span><span class="p">.</span><span class="n">op_makevirginlabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_makevirginlabel</span><span class="p">,</span>
<a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">    </span><span class="p">.</span><span class="n">op_getpackname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_getpackname</span><span class="p">,</span>
<a href="#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">    </span><span class="p">.</span><span class="n">op_freedisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l32_freedisklabel</span>
<a href="#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="p">};</span>
</code></pre></div>
<p><strong>32-bit label location:</strong> Sector 1 (<code>LABELSECTOR32</code>)</p>
<p><strong>Key features:</strong>
- Up to 16 partitions (a-p)
- 32-bit sector addresses (2TB limit)
- CHS geometry stored
- Checksum-based integrity</p>
<h3 id="64-bit-disklabel">64-bit Disklabel<a class="headerlink" href="#64-bit-disklabel" title="Permanent link">¶</a></h3>
<p>DragonFly's native 64-bit disklabel format:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="cm">/* sys/kern/subr_disklabel64.c:529-542 */</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel_ops</span><span class="w"> </span><span class="n">disklabel64_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="p">.</span><span class="n">labelsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel64</span><span class="p">),</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="p">.</span><span class="n">op_readdisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_readdisklabel</span><span class="p">,</span>
<a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="p">.</span><span class="n">op_setdisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_setdisklabel</span><span class="p">,</span>
<a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="p">.</span><span class="n">op_writedisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_writedisklabel</span><span class="p">,</span>
<a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="p">.</span><span class="n">op_clone_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_clone_label</span><span class="p">,</span>
<a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="p">.</span><span class="n">op_adjust_label_reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_adjust_label_reserved</span><span class="p">,</span>
<a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="p">.</span><span class="n">op_getpartbounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_getpartbounds</span><span class="p">,</span>
<a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="p">.</span><span class="n">op_loadpartinfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_loadpartinfo</span><span class="p">,</span>
<a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">    </span><span class="p">.</span><span class="n">op_getnumparts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_getnumparts</span><span class="p">,</span>
<a href="#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">    </span><span class="p">.</span><span class="n">op_makevirginlabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_makevirginlabel</span><span class="p">,</span>
<a href="#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">    </span><span class="p">.</span><span class="n">op_getpackname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_getpackname</span><span class="p">,</span>
<a href="#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">    </span><span class="p">.</span><span class="n">op_freedisklabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l64_freedisklabel</span>
<a href="#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="p">};</span>
</code></pre></div>
<p><strong>64-bit label location:</strong> Offset 0 (sector-agnostic)</p>
<p><strong>Key features:</strong>
- Up to 16 partitions
- 64-bit byte offsets (no practical size limit)
- UUID-based partition identification
- CRC32 integrity check
- 1MB-aligned partitions by default
- Reserved boot area (32KB)</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="cm">/* sys/kern/subr_disklabel64.c:437-509 */</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="nf">l64_makevirginlabel</span><span class="p">(</span><span class="n">disklabel_t</span><span class="w"> </span><span class="n">lpx</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">*</span><span class="n">ssp</span><span class="p">,</span>
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">                    </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span>
<a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="p">{</span>
<a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel64</span><span class="w"> </span><span class="o">*</span><span class="n">lp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lpx</span><span class="p">.</span><span class="n">lab64</span><span class="p">;</span>
<a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a>
<a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="cm">/* Use 4KB minimum block size for alignment calculations */</span>
<a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4096</span><span class="p">)</span>
<a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">        </span><span class="n">blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="p">;</span>
<a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a>
<a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_magic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DISKMAGIC64</span><span class="p">;</span>
<a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_npartitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAXPARTITIONS64</span><span class="p">;</span>
<a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">    </span><span class="n">kern_uuidgen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_stor_uuid</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a>
<a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="cm">/* Reserve space for label (rounded to block size) */</span>
<a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">    </span><span class="n">ressize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disklabel64</span><span class="p">,</span><span class="w"> </span><span class="n">d_partitions</span><span class="p">[</span><span class="n">RESPARTITIONS64</span><span class="p">]);</span>
<a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">    </span><span class="n">ressize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ressize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blkmask</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">blkmask</span><span class="p">;</span>
<a href="#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a>
<a href="#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_bbase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ressize</span><span class="p">;</span><span class="w">                          </span><span class="cm">/* boot area start */</span>
<a href="#__codelineno-15-22" id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_pbase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_bbase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BOOT2SIZE64</span><span class="p">;</span><span class="w">        </span><span class="cm">/* partition area start */</span>
<a href="#__codelineno-15-23" id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_abase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_total_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ressize</span><span class="p">;</span><span class="w">       </span><span class="cm">/* backup label */</span>
<a href="#__codelineno-15-24" id="__codelineno-15-24" name="__codelineno-15-24"></a>
<a href="#__codelineno-15-25" id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">    </span><span class="cm">/* Align partition boundaries to 1MB (physical alignment) */</span>
<a href="#__codelineno-15-26" id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_pbase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">doffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_pbase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PALIGN_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span>
<a href="#__codelineno-15-27" id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="w">                   </span><span class="o">~</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">PALIGN_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">doffset</span><span class="p">;</span>
<a href="#__codelineno-15-28" id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_pstop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_abase</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_pbase</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span>
<a href="#__codelineno-15-29" id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">                   </span><span class="o">~</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">PALIGN_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">d_pbase</span><span class="p">;</span>
<a href="#__codelineno-15-30" id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="p">}</span>
</code></pre></div>
<hr/>
<h2 id="io-path">I/O Path<a class="headerlink" href="#io-path" title="Permanent link">¶</a></h2>
<h3 id="disk-device-operations">Disk Device Operations<a class="headerlink" href="#disk-device-operations" title="Permanent link">¶</a></h3>
<p>The disk layer interposes its own device operations:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="cm">/* sys/kern/subr_disk.c:136-159 */</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_ops</span><span class="w"> </span><span class="n">disk1_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">"disk"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">D_DISK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D_MPSAFE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D_TRACKCLOSE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D_KVABIO</span><span class="w"> </span><span class="p">},</span>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="p">.</span><span class="n">d_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diskopen</span><span class="p">,</span>
<a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="p">.</span><span class="n">d_close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diskclose</span><span class="p">,</span>
<a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="p">.</span><span class="n">d_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">physread</span><span class="p">,</span>
<a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="p">.</span><span class="n">d_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">physwrite</span><span class="p">,</span>
<a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="p">.</span><span class="n">d_ioctl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diskioctl</span><span class="p">,</span>
<a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">    </span><span class="p">.</span><span class="n">d_strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diskstrategy</span><span class="p">,</span>
<a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="p">.</span><span class="n">d_dump</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diskdump</span><span class="p">,</span>
<a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="p">.</span><span class="n">d_psize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diskpsize</span><span class="p">,</span>
<a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="p">};</span>
<a href="#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a>
<a href="#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="cm">/* Variant without emergency pager */</span>
<a href="#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_ops</span><span class="w"> </span><span class="n">disk2_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-16-16" id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">"disk"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">D_DISK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D_MPSAFE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D_TRACKCLOSE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D_KVABIO</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D_NOEMERGPGR</span><span class="w"> </span><span class="p">},</span>
<a href="#__codelineno-16-17" id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">    </span><span class="cm">/* ... same operations ... */</span>
<a href="#__codelineno-16-18" id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="p">};</span>
</code></pre></div>
<h3 id="strategy-routine">Strategy Routine<a class="headerlink" href="#strategy-routine" title="Permanent link">¶</a></h3>
<p>The disk strategy routine translates slice-relative offsets:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="cm">/* sys/kern/subr_disk.c:1221-1253 */</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="nf">diskstrategy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_strategy_args</span><span class="w"> </span><span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="p">{</span>
<a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_head</span><span class="p">.</span><span class="n">a_dev</span><span class="p">;</span>
<a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">a_bio</span><span class="p">;</span>
<a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">nbio</span><span class="p">;</span>
<a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">;</span>
<a href="#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a>
<a href="#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">    </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">si_disk</span><span class="p">;</span>
<a href="#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">        </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_buf</span><span class="o">-&gt;</span><span class="n">b_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ENXIO</span><span class="p">;</span>
<a href="#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">        </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_buf</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_ERROR</span><span class="p">;</span>
<a href="#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">        </span><span class="n">biodone</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<a href="#__codelineno-17-15" id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-17-16" id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-17-17" id="__codelineno-17-17" name="__codelineno-17-17"></a>
<a href="#__codelineno-17-18" id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">    </span><span class="cm">/*</span>
<a href="#__codelineno-17-19" id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="cm">     * dscheck() transforms slice-relative offset to absolute offset.</span>
<a href="#__codelineno-17-20" id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="cm">     * Returns NULL if I/O should not proceed (EOF, error, etc.)</span>
<a href="#__codelineno-17-21" id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="cm">     */</span>
<a href="#__codelineno-17-22" id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">nbio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dscheck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_slice</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-17-23" id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">        </span><span class="n">dev_dstrategy</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_rawdev</span><span class="p">,</span><span class="w"> </span><span class="n">nbio</span><span class="p">);</span>
<a href="#__codelineno-17-24" id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-17-25" id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">        </span><span class="n">biodone</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<a href="#__codelineno-17-26" id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-17-27" id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-17-28" id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="p">}</span>
</code></pre></div>
<h3 id="slice-checking-and-translation">Slice Checking and Translation<a class="headerlink" href="#slice-checking-and-translation" title="Permanent link">¶</a></h3>
<p><code>dscheck()</code> validates and translates I/O requests:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="cm">/* sys/kern/subr_diskslice.c:90-310 */</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="n">dscheck</span><span class="p">(</span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">*</span><span class="n">ssp</span><span class="p">)</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="p">{</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">buf</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_buf</span><span class="p">;</span>
<a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslice</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">;</span>
<a href="#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="n">u_int64_t</span><span class="w"> </span><span class="n">secno</span><span class="p">,</span><span class="w"> </span><span class="n">endsecno</span><span class="p">,</span><span class="w"> </span><span class="n">slicerel_secno</span><span class="p">;</span>
<a href="#__codelineno-18-8" id="__codelineno-18-8" name="__codelineno-18-8"></a>
<a href="#__codelineno-18-9" id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="n">slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dkslice</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<a href="#__codelineno-18-10" id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">    </span><span class="n">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dkpart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<a href="#__codelineno-18-11" id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">    </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_slices</span><span class="p">[</span><span class="n">slice</span><span class="p">];</span>
<a href="#__codelineno-18-12" id="__codelineno-18-12" name="__codelineno-18-12"></a>
<a href="#__codelineno-18-13" id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">    </span><span class="cm">/* Calculate sector number from byte offset */</span>
<a href="#__codelineno-18-14" id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_secshift</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-15" id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">        </span><span class="n">secno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">DEV_BSHIFT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_secshift</span><span class="p">);</span>
<a href="#__codelineno-18-16" id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">        </span><span class="n">nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bcount</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">DEV_BSHIFT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_secshift</span><span class="p">);</span>
<a href="#__codelineno-18-17" id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-18" id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">        </span><span class="n">secno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_secsize</span><span class="p">;</span>
<a href="#__codelineno-18-19" id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="w">        </span><span class="n">nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bcount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_secsize</span><span class="p">;</span>
<a href="#__codelineno-18-20" id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-18-21" id="__codelineno-18-21" name="__codelineno-18-21"></a>
<a href="#__codelineno-18-22" id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">    </span><span class="cm">/* Handle WHOLE_DISK_SLICE - no label interpretation */</span>
<a href="#__codelineno-18-23" id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slice</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WHOLE_DISK_SLICE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-24" id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">part</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">WHOLE_SLICE_PART</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-25" id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="w">            </span><span class="cm">/* Encode partition in high bits for raw pass-through */</span>
<a href="#__codelineno-18-26" id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="w">            </span><span class="n">nbio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">push_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<a href="#__codelineno-18-27" id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="w">            </span><span class="n">nbio</span><span class="o">-&gt;</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">u_int64_t</span><span class="p">)</span><span class="n">part</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">56</span><span class="p">;</span>
<a href="#__codelineno-18-28" id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">nbio</span><span class="p">;</span>
<a href="#__codelineno-18-29" id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-18-30" id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="w">        </span><span class="n">endsecno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_size</span><span class="p">;</span>
<a href="#__codelineno-18-31" id="__codelineno-18-31" name="__codelineno-18-31"></a><span class="w">        </span><span class="n">slicerel_secno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secno</span><span class="p">;</span>
<a href="#__codelineno-18-32" id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-18-33" id="__codelineno-18-33" name="__codelineno-18-33"></a><span class="w">    </span><span class="cm">/* Handle whole-slice partition */</span>
<a href="#__codelineno-18-34" id="__codelineno-18-34" name="__codelineno-18-34"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">part</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WHOLE_SLICE_PART</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-35" id="__codelineno-18-35" name="__codelineno-18-35"></a><span class="w">        </span><span class="n">endsecno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_size</span><span class="p">;</span>
<a href="#__codelineno-18-36" id="__codelineno-18-36" name="__codelineno-18-36"></a><span class="w">        </span><span class="n">slicerel_secno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secno</span><span class="p">;</span>
<a href="#__codelineno-18-37" id="__codelineno-18-37" name="__codelineno-18-37"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-18-38" id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="w">    </span><span class="cm">/* Handle labeled partition */</span>
<a href="#__codelineno-18-39" id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">lp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">).</span><span class="n">opaque</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-40" id="__codelineno-18-40" name="__codelineno-18-40"></a><span class="w">        </span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_ops</span><span class="p">;</span>
<a href="#__codelineno-18-41" id="__codelineno-18-41" name="__codelineno-18-41"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_getpartbounds</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">slicerel_secno</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">endsecno</span><span class="p">))</span>
<a href="#__codelineno-18-42" id="__codelineno-18-42" name="__codelineno-18-42"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad</span><span class="p">;</span>
<a href="#__codelineno-18-43" id="__codelineno-18-43" name="__codelineno-18-43"></a><span class="w">        </span><span class="n">slicerel_secno</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">secno</span><span class="p">;</span>
<a href="#__codelineno-18-44" id="__codelineno-18-44" name="__codelineno-18-44"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-18-45" id="__codelineno-18-45" name="__codelineno-18-45"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-46" id="__codelineno-18-46" name="__codelineno-18-46"></a><span class="w">        </span><span class="cm">/* No label - can't access partition */</span>
<a href="#__codelineno-18-47" id="__codelineno-18-47" name="__codelineno-18-47"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad</span><span class="p">;</span>
<a href="#__codelineno-18-48" id="__codelineno-18-48" name="__codelineno-18-48"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-18-49" id="__codelineno-18-49" name="__codelineno-18-49"></a>
<a href="#__codelineno-18-50" id="__codelineno-18-50" name="__codelineno-18-50"></a><span class="w">    </span><span class="cm">/* Check reserved area (label protection) */</span>
<a href="#__codelineno-18-51" id="__codelineno-18-51" name="__codelineno-18-51"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slicerel_secno</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_reserved</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nsec</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-18-52" id="__codelineno-18-52" name="__codelineno-18-52"></a><span class="w">        </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BUF_CMD_WRITE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-53" id="__codelineno-18-53" name="__codelineno-18-53"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_wlabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-54" id="__codelineno-18-54" name="__codelineno-18-54"></a><span class="w">            </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EROFS</span><span class="p">;</span>
<a href="#__codelineno-18-55" id="__codelineno-18-55" name="__codelineno-18-55"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-18-56" id="__codelineno-18-56" name="__codelineno-18-56"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-18-57" id="__codelineno-18-57" name="__codelineno-18-57"></a><span class="w">        </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">DSF_REPROBE</span><span class="p">;</span>
<a href="#__codelineno-18-58" id="__codelineno-18-58" name="__codelineno-18-58"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-18-59" id="__codelineno-18-59" name="__codelineno-18-59"></a>
<a href="#__codelineno-18-60" id="__codelineno-18-60" name="__codelineno-18-60"></a><span class="w">    </span><span class="cm">/* Handle EOF */</span>
<a href="#__codelineno-18-61" id="__codelineno-18-61" name="__codelineno-18-61"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secno</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nsec</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">endsecno</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-62" id="__codelineno-18-62" name="__codelineno-18-62"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secno</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">endsecno</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-63" id="__codelineno-18-63" name="__codelineno-18-63"></a><span class="w">            </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_resid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bcount</span><span class="p">;</span>
<a href="#__codelineno-18-64" id="__codelineno-18-64" name="__codelineno-18-64"></a><span class="w">            </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">B_INVAL</span><span class="p">;</span>
<a href="#__codelineno-18-65" id="__codelineno-18-65" name="__codelineno-18-65"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a href="#__codelineno-18-66" id="__codelineno-18-66" name="__codelineno-18-66"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-18-67" id="__codelineno-18-67" name="__codelineno-18-67"></a><span class="w">        </span><span class="cm">/* Truncate to fit */</span>
<a href="#__codelineno-18-68" id="__codelineno-18-68" name="__codelineno-18-68"></a><span class="w">        </span><span class="n">nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endsecno</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">secno</span><span class="p">;</span>
<a href="#__codelineno-18-69" id="__codelineno-18-69" name="__codelineno-18-69"></a><span class="w">        </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_bcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_secsize</span><span class="p">;</span>
<a href="#__codelineno-18-70" id="__codelineno-18-70" name="__codelineno-18-70"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-18-71" id="__codelineno-18-71" name="__codelineno-18-71"></a>
<a href="#__codelineno-18-72" id="__codelineno-18-72" name="__codelineno-18-72"></a><span class="w">    </span><span class="cm">/* Translate to absolute offset */</span>
<a href="#__codelineno-18-73" id="__codelineno-18-73" name="__codelineno-18-73"></a><span class="w">    </span><span class="n">nbio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">push_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<a href="#__codelineno-18-74" id="__codelineno-18-74" name="__codelineno-18-74"></a><span class="w">    </span><span class="n">nbio</span><span class="o">-&gt;</span><span class="n">bio_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">off_t</span><span class="p">)(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slicerel_secno</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-18-75" id="__codelineno-18-75" name="__codelineno-18-75"></a><span class="w">                       </span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">dss_secsize</span><span class="p">;</span>
<a href="#__codelineno-18-76" id="__codelineno-18-76" name="__codelineno-18-76"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nbio</span><span class="p">;</span>
<a href="#__codelineno-18-77" id="__codelineno-18-77" name="__codelineno-18-77"></a><span class="p">}</span>
</code></pre></div>
<hr/>
<h2 id="io-ordering">I/O Ordering<a class="headerlink" href="#io-ordering" title="Permanent link">¶</a></h2>
<h3 id="bio-queue-management">BIO Queue Management<a class="headerlink" href="#bio-queue-management" title="Permanent link">¶</a></h3>
<p>The disk layer provides I/O ordering for drive zone cache optimization:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="cm">/* sys/kern/subr_disk.c:1353-1409 */</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kt">void</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="nf">bioqdisksort</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_queue_head</span><span class="w"> </span><span class="o">*</span><span class="n">bioq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="p">{</span>
<a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bio_buf</span><span class="o">-&gt;</span><span class="n">b_cmd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">BUF_CMD_READ</span><span class="p">:</span>
<a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">transition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">            </span><span class="cm">/*</span>
<a href="#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="cm">             * Insert reads before the first write to prioritize reads.</span>
<a href="#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="cm">             * Periodically bleed writes through to prevent starvation.</span>
<a href="#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="cm">             */</span>
<a href="#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">            </span><span class="n">TAILQ_INSERT_BEFORE</span><span class="p">(</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">transition</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">bio_act</span><span class="p">);</span>
<a href="#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">            </span><span class="o">++</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">reorder</span><span class="p">;</span>
<a href="#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a>
<a href="#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">            </span><span class="cm">/* Minor interval: trickle small writes */</span>
<a href="#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">reorder</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bioq_reorder_minor_interval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">                </span><span class="n">bioqwritereorder</span><span class="p">(</span><span class="n">bioq</span><span class="p">);</span>
<a href="#__codelineno-19-18" id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">reorder</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">bioq_reorder_burst_interval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-19" id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">                    </span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">reorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-19-20" id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">                </span><span class="p">}</span>
<a href="#__codelineno-19-21" id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-19-22" id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-23" id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="w">            </span><span class="cm">/* No writes queued, append to tail */</span>
<a href="#__codelineno-19-24" id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="w">            </span><span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">bio_act</span><span class="p">);</span>
<a href="#__codelineno-19-25" id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-19-26" id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-19-27" id="__codelineno-19-27" name="__codelineno-19-27"></a>
<a href="#__codelineno-19-28" id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">BUF_CMD_WRITE</span><span class="p">:</span>
<a href="#__codelineno-19-29" id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="w">        </span><span class="cm">/* Writes always append; track transition point */</span>
<a href="#__codelineno-19-30" id="__codelineno-19-30" name="__codelineno-19-30"></a><span class="w">        </span><span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">bio_act</span><span class="p">);</span>
<a href="#__codelineno-19-31" id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">transition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a href="#__codelineno-19-32" id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="w">            </span><span class="n">bioq</span><span class="o">-&gt;</span><span class="n">transition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="p">;</span>
<a href="#__codelineno-19-33" id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-19-34" id="__codelineno-19-34" name="__codelineno-19-34"></a>
<a href="#__codelineno-19-35" id="__codelineno-19-35" name="__codelineno-19-35"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a href="#__codelineno-19-36" id="__codelineno-19-36" name="__codelineno-19-36"></a><span class="w">        </span><span class="cm">/* Other requests force ordering */</span>
<a href="#__codelineno-19-37" id="__codelineno-19-37" name="__codelineno-19-37"></a><span class="w">        </span><span class="n">bioq_insert_tail</span><span class="p">(</span><span class="n">bioq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>
<a href="#__codelineno-19-38" id="__codelineno-19-38" name="__codelineno-19-38"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-19-39" id="__codelineno-19-39" name="__codelineno-19-39"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-19-40" id="__codelineno-19-40" name="__codelineno-19-40"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Reorder tuning parameters:</strong></p>
<table>
<thead>
<tr>
<th>Sysctl</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kern.bioq_reorder_burst_interval</code></td>
<td>60</td>
<td>Burst interval (reads)</td>
</tr>
<tr>
<td><code>kern.bioq_reorder_minor_interval</code></td>
<td>5</td>
<td>Minor bleed interval</td>
</tr>
<tr>
<td><code>kern.bioq_reorder_burst_bytes</code></td>
<td>3000000</td>
<td>Bytes per burst</td>
</tr>
<tr>
<td><code>kern.bioq_reorder_minor_bytes</code></td>
<td>262144</td>
<td>Bytes per minor bleed</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="disk-enumeration">Disk Enumeration<a class="headerlink" href="#disk-enumeration" title="Permanent link">¶</a></h2>
<p>Enumerate all registered disks safely:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="cm">/* sys/kern/subr_disk.c:967-1008 */</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="n">disk_enumerate</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="p">{</span>
<a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">    </span><span class="n">lwkt_gettoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>
<a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">        </span><span class="o">--</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_refs</span><span class="p">;</span>
<a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">        </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LIST_NEXT</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="n">d_list</span><span class="p">);</span>
<a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">        </span><span class="n">LIST_REMOVE</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="n">d_list</span><span class="p">);</span>
<a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">        </span><span class="n">bzero</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">marker</span><span class="p">));</span>
<a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">        </span><span class="n">marker</span><span class="o">-&gt;</span><span class="n">d_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DISKFLAG_MARKER</span><span class="p">;</span>
<a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">        </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist</span><span class="p">);</span>
<a href="#__codelineno-20-15" id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-16" id="__codelineno-20-16" name="__codelineno-20-16"></a>
<a href="#__codelineno-20-17" id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">    </span><span class="cm">/* Skip markers */</span>
<a href="#__codelineno-20-18" id="__codelineno-20-18" name="__codelineno-20-18"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-19" id="__codelineno-20-19" name="__codelineno-20-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DISKFLAG_MARKER</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-20-20" id="__codelineno-20-20" name="__codelineno-20-20"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-20-21" id="__codelineno-20-21" name="__codelineno-20-21"></a><span class="w">        </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LIST_NEXT</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">d_list</span><span class="p">);</span>
<a href="#__codelineno-20-22" id="__codelineno-20-22" name="__codelineno-20-22"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-23" id="__codelineno-20-23" name="__codelineno-20-23"></a>
<a href="#__codelineno-20-24" id="__codelineno-20-24" name="__codelineno-20-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-25" id="__codelineno-20-25" name="__codelineno-20-25"></a><span class="w">        </span><span class="o">++</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_refs</span><span class="p">;</span>
<a href="#__codelineno-20-26" id="__codelineno-20-26" name="__codelineno-20-26"></a><span class="w">        </span><span class="n">LIST_INSERT_AFTER</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="n">d_list</span><span class="p">);</span>
<a href="#__codelineno-20-27" id="__codelineno-20-27" name="__codelineno-20-27"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-28" id="__codelineno-20-28" name="__codelineno-20-28"></a>
<a href="#__codelineno-20-29" id="__codelineno-20-29" name="__codelineno-20-29"></a><span class="w">    </span><span class="n">lwkt_reltoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-20-30" id="__codelineno-20-30" name="__codelineno-20-30"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dp</span><span class="p">;</span>
<a href="#__codelineno-20-31" id="__codelineno-20-31" name="__codelineno-20-31"></a><span class="p">}</span>
<a href="#__codelineno-20-32" id="__codelineno-20-32" name="__codelineno-20-32"></a>
<a href="#__codelineno-20-33" id="__codelineno-20-33" name="__codelineno-20-33"></a><span class="kt">void</span>
<a href="#__codelineno-20-34" id="__codelineno-20-34" name="__codelineno-20-34"></a><span class="n">disk_enumerate_stop</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<a href="#__codelineno-20-35" id="__codelineno-20-35" name="__codelineno-20-35"></a><span class="p">{</span>
<a href="#__codelineno-20-36" id="__codelineno-20-36" name="__codelineno-20-36"></a><span class="w">    </span><span class="n">lwkt_gettoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-20-37" id="__codelineno-20-37" name="__codelineno-20-37"></a><span class="w">    </span><span class="n">LIST_REMOVE</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="n">d_list</span><span class="p">);</span>
<a href="#__codelineno-20-38" id="__codelineno-20-38" name="__codelineno-20-38"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
<a href="#__codelineno-20-39" id="__codelineno-20-39" name="__codelineno-20-39"></a><span class="w">        </span><span class="o">--</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_refs</span><span class="p">;</span>
<a href="#__codelineno-20-40" id="__codelineno-20-40" name="__codelineno-20-40"></a><span class="w">    </span><span class="n">lwkt_reltoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-20-41" id="__codelineno-20-41" name="__codelineno-20-41"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Usage pattern:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="n">marker</span><span class="p">;</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a>
<a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disk_enumerate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="cm">/* Process disk */</span>
<a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">some_condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">        </span><span class="n">disk_enumerate_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">marker</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">);</span>
<a href="#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-21-9" id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-21-10" id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="p">}</span>
</code></pre></div></p>
<hr/>
<h2 id="ioctls">Ioctls<a class="headerlink" href="#ioctls" title="Permanent link">¶</a></h2>
<h3 id="diskslice-ioctls">Disk/Slice Ioctls<a class="headerlink" href="#diskslice-ioctls" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="cm">/* sys/kern/subr_diskslice.c:365-688 */</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="kt">int</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="nf">dsioctl</span><span class="p">(</span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u_long</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
<a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">diskslices</span><span class="w"> </span><span class="o">**</span><span class="n">sspp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span>
<a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="p">{</span>
<a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGDVIRGIN32</span><span class="p">:</span>
<a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGDVIRGIN64</span><span class="p">:</span>
<a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">        </span><span class="cm">/* Get virgin (default) disklabel */</span>
<a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">        </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_makevirginlabel</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a>
<a href="#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGDINFO32</span><span class="p">:</span>
<a href="#__codelineno-22-14" id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGDINFO64</span><span class="p">:</span>
<a href="#__codelineno-22-15" id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">        </span><span class="cm">/* Read disklabel from disk */</span>
<a href="#__codelineno-22-16" id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">.</span><span class="n">opaque</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a href="#__codelineno-22-17" id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsreadandsetlabel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_dsflags</span><span class="p">,</span><span class="w"> </span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-22-18" id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-22-19" id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">            </span><span class="n">bcopy</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">.</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">labelsize</span><span class="p">);</span>
<a href="#__codelineno-22-20" id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-22-21" id="__codelineno-22-21" name="__codelineno-22-21"></a>
<a href="#__codelineno-22-22" id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGMEDIASIZE</span><span class="p">:</span>
<a href="#__codelineno-22-23" id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="w">        </span><span class="cm">/* Get media size in bytes */</span>
<a href="#__codelineno-22-24" id="__codelineno-22-24" name="__codelineno-22-24"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="kt">off_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_int64_t</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-22-25" id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-22-26" id="__codelineno-22-26" name="__codelineno-22-26"></a>
<a href="#__codelineno-22-27" id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGSECTORSIZE</span><span class="p">:</span>
<a href="#__codelineno-22-28" id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="w">        </span><span class="cm">/* Get sector size */</span>
<a href="#__codelineno-22-29" id="__codelineno-22-29" name="__codelineno-22-29"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">u_int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-22-30" id="__codelineno-22-30" name="__codelineno-22-30"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-22-31" id="__codelineno-22-31" name="__codelineno-22-31"></a>
<a href="#__codelineno-22-32" id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGPART</span><span class="p">:</span>
<a href="#__codelineno-22-33" id="__codelineno-22-33" name="__codelineno-22-33"></a><span class="w">        </span><span class="cm">/* Get partition info */</span>
<a href="#__codelineno-22-34" id="__codelineno-22-34" name="__codelineno-22-34"></a><span class="w">        </span><span class="n">dpart</span><span class="o">-&gt;</span><span class="n">media_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_int64_t</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_offset</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-22-35" id="__codelineno-22-35" name="__codelineno-22-35"></a><span class="w">        </span><span class="n">dpart</span><span class="o">-&gt;</span><span class="n">media_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_int64_t</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-22-36" id="__codelineno-22-36" name="__codelineno-22-36"></a><span class="w">        </span><span class="n">dpart</span><span class="o">-&gt;</span><span class="n">media_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_size</span><span class="p">;</span>
<a href="#__codelineno-22-37" id="__codelineno-22-37" name="__codelineno-22-37"></a><span class="w">        </span><span class="n">dpart</span><span class="o">-&gt;</span><span class="n">media_blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">d_media_blksize</span><span class="p">;</span>
<a href="#__codelineno-22-38" id="__codelineno-22-38" name="__codelineno-22-38"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-22-39" id="__codelineno-22-39" name="__codelineno-22-39"></a>
<a href="#__codelineno-22-40" id="__codelineno-22-40" name="__codelineno-22-40"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCGSLICEINFO</span><span class="p">:</span>
<a href="#__codelineno-22-41" id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="w">        </span><span class="cm">/* Get all slice info */</span>
<a href="#__codelineno-22-42" id="__codelineno-22-42" name="__codelineno-22-42"></a><span class="w">        </span><span class="n">bcopy</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<a href="#__codelineno-22-43" id="__codelineno-22-43" name="__codelineno-22-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-22-44" id="__codelineno-22-44" name="__codelineno-22-44"></a>
<a href="#__codelineno-22-45" id="__codelineno-22-45" name="__codelineno-22-45"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCSDINFO32</span><span class="p">:</span>
<a href="#__codelineno-22-46" id="__codelineno-22-46" name="__codelineno-22-46"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCSDINFO64</span><span class="p">:</span>
<a href="#__codelineno-22-47" id="__codelineno-22-47" name="__codelineno-22-47"></a><span class="w">        </span><span class="cm">/* Set disklabel in memory */</span>
<a href="#__codelineno-22-48" id="__codelineno-22-48" name="__codelineno-22-48"></a><span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_setdisklabel</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">lptmp</span><span class="p">,</span><span class="w"> </span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">openmask</span><span class="p">);</span>
<a href="#__codelineno-22-49" id="__codelineno-22-49" name="__codelineno-22-49"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-22-50" id="__codelineno-22-50" name="__codelineno-22-50"></a>
<a href="#__codelineno-22-51" id="__codelineno-22-51" name="__codelineno-22-51"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCWDINFO32</span><span class="p">:</span>
<a href="#__codelineno-22-52" id="__codelineno-22-52" name="__codelineno-22-52"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCWDINFO64</span><span class="p">:</span>
<a href="#__codelineno-22-53" id="__codelineno-22-53" name="__codelineno-22-53"></a><span class="w">        </span><span class="cm">/* Write disklabel to disk */</span>
<a href="#__codelineno-22-54" id="__codelineno-22-54" name="__codelineno-22-54"></a><span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">op_writedisklabel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ds_label</span><span class="p">);</span>
<a href="#__codelineno-22-55" id="__codelineno-22-55" name="__codelineno-22-55"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-22-56" id="__codelineno-22-56" name="__codelineno-22-56"></a>
<a href="#__codelineno-22-57" id="__codelineno-22-57" name="__codelineno-22-57"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCSYNCSLICEINFO</span><span class="p">:</span>
<a href="#__codelineno-22-58" id="__codelineno-22-58" name="__codelineno-22-58"></a><span class="w">        </span><span class="cm">/* Reprobe entire disk */</span>
<a href="#__codelineno-22-59" id="__codelineno-22-59" name="__codelineno-22-59"></a><span class="w">        </span><span class="n">disk_msg_send_sync</span><span class="p">(</span><span class="n">DISK_DISK_REPROBE</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">si_disk</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a href="#__codelineno-22-60" id="__codelineno-22-60" name="__codelineno-22-60"></a><span class="w">        </span><span class="n">devfs_config</span><span class="p">();</span>
<a href="#__codelineno-22-61" id="__codelineno-22-61" name="__codelineno-22-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-22-62" id="__codelineno-22-62" name="__codelineno-22-62"></a>
<a href="#__codelineno-22-63" id="__codelineno-22-63" name="__codelineno-22-63"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIOCWLABEL</span><span class="p">:</span>
<a href="#__codelineno-22-64" id="__codelineno-22-64" name="__codelineno-22-64"></a><span class="w">        </span><span class="cm">/* Enable/disable label writes */</span>
<a href="#__codelineno-22-65" id="__codelineno-22-65" name="__codelineno-22-65"></a><span class="w">        </span><span class="n">set_ds_wlabel</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">slice</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-22-66" id="__codelineno-22-66" name="__codelineno-22-66"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-22-67" id="__codelineno-22-67" name="__codelineno-22-67"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-22-68" id="__codelineno-22-68" name="__codelineno-22-68"></a><span class="p">}</span>
</code></pre></div>
<hr/>
<h2 id="kernel-dumps">Kernel Dumps<a class="headerlink" href="#kernel-dumps" title="Permanent link">¶</a></h2>
<h3 id="dump-configuration">Dump Configuration<a class="headerlink" href="#dump-configuration" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="cm">/* sys/kern/subr_disk.c:915-940 */</span>
<a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="kt">int</span>
<a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="nf">disk_dumpconf</span><span class="p">(</span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u_int</span><span class="w"> </span><span class="n">onoff</span><span class="p">)</span>
<a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="p">{</span>
<a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dumperinfo</span><span class="w"> </span><span class="n">di</span><span class="p">;</span>
<a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">    </span><span class="n">u_int64_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">blkno</span><span class="p">;</span>
<a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="n">u_int32_t</span><span class="w"> </span><span class="n">secsize</span><span class="p">;</span>
<a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a>
<a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">onoff</span><span class="p">)</span>
<a href="#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">set_dumper</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a href="#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a>
<a href="#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disk_dumpcheck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blkno</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">secsize</span><span class="p">);</span>
<a href="#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a href="#__codelineno-23-14" id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ENXIO</span><span class="p">;</span>
<a href="#__codelineno-23-15" id="__codelineno-23-15" name="__codelineno-23-15"></a>
<a href="#__codelineno-23-16" id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">    </span><span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="p">));</span>
<a href="#__codelineno-23-17" id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="w">    </span><span class="n">di</span><span class="p">.</span><span class="n">dumper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diskdump</span><span class="p">;</span>
<a href="#__codelineno-23-18" id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="w">    </span><span class="n">di</span><span class="p">.</span><span class="n">priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span>
<a href="#__codelineno-23-19" id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="w">    </span><span class="n">di</span><span class="p">.</span><span class="n">blocksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secsize</span><span class="p">;</span>
<a href="#__codelineno-23-20" id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">    </span><span class="n">di</span><span class="p">.</span><span class="n">maxiosize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">si_iosize_max</span><span class="p">;</span>
<a href="#__codelineno-23-21" id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="w">    </span><span class="n">di</span><span class="p">.</span><span class="n">mediaoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blkno</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DEV_BSIZE</span><span class="p">;</span>
<a href="#__codelineno-23-22" id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">    </span><span class="n">di</span><span class="p">.</span><span class="n">mediasize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DEV_BSIZE</span><span class="p">;</span>
<a href="#__codelineno-23-23" id="__codelineno-23-23" name="__codelineno-23-23"></a>
<a href="#__codelineno-23-24" id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">set_dumper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="p">);</span>
<a href="#__codelineno-23-25" id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="p">}</span>
</code></pre></div>
<hr/>
<h2 id="device-aliases">Device Aliases<a class="headerlink" href="#device-aliases" title="Permanent link">¶</a></h2>
<p>The disk layer creates convenient device aliases:</p>
<table>
<thead>
<tr>
<th>Alias Pattern</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>serno/&lt;serial&gt;</code></td>
<td><code>serno/WD-12345</code></td>
<td>By serial number</td>
</tr>
<tr>
<td><code>serno/&lt;serial&gt;.sN</code></td>
<td><code>serno/WD-12345.s1</code></td>
<td>Slice by serial</td>
</tr>
<tr>
<td><code>serno/&lt;serial&gt;.sNX</code></td>
<td><code>serno/WD-12345.s1a</code></td>
<td>Partition by serial</td>
</tr>
<tr>
<td><code>slice-by-uuid/&lt;uuid&gt;</code></td>
<td><code>slice-by-uuid/abc...</code></td>
<td>GPT slice by UUID</td>
</tr>
<tr>
<td><code>part-by-uuid/&lt;uuid&gt;</code></td>
<td><code>part-by-uuid/def...</code></td>
<td>Partition by UUID</td>
</tr>
<tr>
<td><code>by-label/&lt;packname&gt;</code></td>
<td><code>by-label/root</code></td>
<td>By disklabel pack name</td>
</tr>
<tr>
<td><code>part-by-label/&lt;&gt;.X</code></td>
<td><code>part-by-label/root.a</code></td>
<td>Partition by label name</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="initialization">Initialization<a class="headerlink" href="#initialization" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="cm">/* sys/kern/subr_disk.c:1540-1564 */</span>
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="nf">disk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="p">{</span>
<a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread</span><span class="w"> </span><span class="o">*</span><span class="n">td_core</span><span class="p">;</span>
<a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a>
<a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">    </span><span class="cm">/* Create object cache for disk messages */</span>
<a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">    </span><span class="n">disk_msg_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_create</span><span class="p">(</span><span class="s">"disk-msg-cache"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">                                     </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">                                     </span><span class="n">objcache_malloc_alloc</span><span class="p">,</span>
<a href="#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">                                     </span><span class="n">objcache_malloc_free</span><span class="p">,</span>
<a href="#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">                                     </span><span class="o">&amp;</span><span class="n">disk_msg_malloc_args</span><span class="p">);</span>
<a href="#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a>
<a href="#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">    </span><span class="cm">/* Initialize tokens */</span>
<a href="#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">    </span><span class="n">lwkt_token_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">,</span><span class="w"> </span><span class="s">"disks"</span><span class="p">);</span>
<a href="#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="w">    </span><span class="n">lwkt_token_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds_token</span><span class="p">,</span><span class="w"> </span><span class="s">"ds"</span><span class="p">);</span>
<a href="#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a>
<a href="#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="w">    </span><span class="cm">/* Initialize message drain port */</span>
<a href="#__codelineno-24-19" id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="w">    </span><span class="n">lwkt_initport_replyonly</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_dispose_port</span><span class="p">,</span><span class="w"> </span><span class="n">disk_msg_autofree_reply</span><span class="p">);</span>
<a href="#__codelineno-24-20" id="__codelineno-24-20" name="__codelineno-24-20"></a>
<a href="#__codelineno-24-21" id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="w">    </span><span class="cm">/* Create disk message processing thread */</span>
<a href="#__codelineno-24-22" id="__codelineno-24-22" name="__codelineno-24-22"></a><span class="w">    </span><span class="n">lwkt_gettoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-24-23" id="__codelineno-24-23" name="__codelineno-24-23"></a><span class="w">    </span><span class="n">lwkt_create</span><span class="p">(</span><span class="n">disk_msg_core</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">td_core</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="s">"disk_msg_core"</span><span class="p">);</span>
<a href="#__codelineno-24-24" id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="w">    </span><span class="n">tsleep</span><span class="p">(</span><span class="n">td_core</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"diskcore"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-24-25" id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="w">    </span><span class="n">lwkt_reltoken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disklist_token</span><span class="p">);</span>
<a href="#__codelineno-24-26" id="__codelineno-24-26" name="__codelineno-24-26"></a><span class="p">}</span>
<a href="#__codelineno-24-27" id="__codelineno-24-27" name="__codelineno-24-27"></a>
<a href="#__codelineno-24-28" id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="n">SYSINIT</span><span class="p">(</span><span class="n">disk_register</span><span class="p">,</span><span class="w"> </span><span class="n">SI_SUB_PRE_DRIVERS</span><span class="p">,</span><span class="w"> </span><span class="n">SI_ORDER_FIRST</span><span class="p">,</span><span class="w"> </span><span class="n">disk_init</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</code></pre></div>
<hr/>
<h2 id="io-scheduling-dsched">I/O Scheduling (dsched)<a class="headerlink" href="#io-scheduling-dsched" title="Permanent link">¶</a></h2>
<p>The disk subsystem includes stub entry points for I/O scheduling (<code>dsched</code>):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="cm">/* sys/kern/kern_dsched.c - stubs only */</span>
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dsched_disk_create</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">head_name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dsched_disk_update</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dsched_disk_destroy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">disk</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>These functions are called from <code>disk_create()</code>, <code>disk_setdiskinfo()</code>, and
<code>disk_destroy()</code> but do nothing. The original dsched framework was removed
in November 2015 (commit <code>3573cf7bf6</code>) with this explanation:</p>
<blockquote>
<p>After consultation, remove dsched from the kernel. The original idea is
still valid but the current implementation has had lingering bugs for
several years now and we've determined that it's just got its fingers
into too many structures.</p>
<p>Also, the implementation was designed before SSDs, and doesn't play well
with SSDs.</p>
<p>Leave various empty entry points in so we can revisit at some future date.</p>
</blockquote>
<p>The removal deleted ~5,800 lines of code including three I/O schedulers:
- <strong>BFQ</strong> (Budget Fair Queueing) - ~2,100 lines
- <strong>FQ</strong> (Fair Queueing) - ~900 lines<br/>
- <strong>AS</strong> (Anticipatory Scheduler) - ~290 lines</p>
<p>The stub entry points remain to allow potential future reimplementation.</p>
<hr/>
<h2 id="sysctl-interface">Sysctl Interface<a class="headerlink" href="#sysctl-interface" title="Permanent link">¶</a></h2>
<table>
<thead>
<tr>
<th>Sysctl</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kern.disks</code></td>
<td>string</td>
<td>Space-separated list of disk names</td>
</tr>
<tr>
<td><code>kern.disk_debug</code></td>
<td>int</td>
<td>Enable disk subsystem debugging</td>
</tr>
<tr>
<td><code>debug.sizeof.disk</code></td>
<td>int</td>
<td>Size of struct disk</td>
</tr>
<tr>
<td><code>debug.sizeof.diskslices</code></td>
<td>int</td>
<td>Size of struct diskslices</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../devices/">Devices</a> - Device framework</li>
<li><a href="../vfs/buffer-cache.md">Buffer Cache</a> - Block I/O buffering</li>
<li><a href="../vfs/vfs-operations.md">VFS Operations</a> - Filesystem integration</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>