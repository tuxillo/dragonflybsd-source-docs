
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive documentation for the DragonFly BSD kernel source code">
      
      
        <meta name="author" content="DragonFly BSD Community">
      
      
      
        <link rel="prev" href="../time/">
      
      
        <link rel="next" href="../initialization/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Memory Management - DragonFly BSD Kernel Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#memory-allocation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Memory Management
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  Kernel Subsystems

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DragonFly BSD Kernel Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lwkt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../synchronization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../time/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Time & Timers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architectural-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architectural Layers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architectural Layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layer-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Layer Responsibilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-allocation-flags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Allocation Flags
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Allocation Flags">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#blocking-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Blocking Behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Properties
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kmallockfree-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        kmalloc/kfree API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="kmalloc/kfree API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basic Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malloc-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Malloc Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-size-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Size Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-sized-allocations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zero-Sized Allocations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#string-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        String Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reallocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reallocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-type-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Type Creation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-stable-object-allocator-kmalloc_obj" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type-Stable Object Allocator (kmalloc_obj)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Type-Stable Object Allocator (kmalloc_obj)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-object-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Defining Object Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Object Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-stable-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type-Stable Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-fast-path" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Fast Path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free-fast-path" class="md-nav__link">
    <span class="md-ellipsis">
      
        Free Fast Path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-stability-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type Stability Benefits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-slab-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Slab Cache
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slab-allocator-internals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slab Allocator Internals
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Slab Allocator Internals">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zone-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zone Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-zone-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Zone Management
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-size-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zone Size Calculation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Free Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-cpu-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross-CPU Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-recycling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zone Recycling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chunk-bitmap-invariants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chunk Bitmap (INVARIANTS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-pattern-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Pattern Debugging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#object-cache-objcache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Object Cache (objcache)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Object Cache (objcache)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Data Structures
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-an-object-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating an Object Cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-objects" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocating Objects
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-objects" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returning Objects
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#magazine-sizing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Magazine Sizing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-limit-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Limit Adjustment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#destroying-an-object-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Destroying an Object Cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend-allocators" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend Allocators
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#objcache-statistics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Objcache Statistics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#magazine-advantages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Magazine Advantages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-objcache" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use Objcache
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#malloc-pipes-mpipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Malloc Pipes (mpipe)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Malloc Pipes (mpipe)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      
        API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-malloc-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a Malloc Pipe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-from-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocating from Pipe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#freeing-to-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Freeing to Pipe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#destroying-a-malloc-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Destroying a Malloc Pipe
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callback Mechanism
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Internal Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-algorithm_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statistics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Statistics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-malloc-pipes" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use Malloc Pipes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advantages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advantages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Limitations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#helper-allocators" class="md-nav__link">
    <span class="md-ellipsis">
      
        Helper Allocators
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Helper Allocators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alist-power-of-2-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      
        alist: Power-of-2 Allocator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blist-bitmap-block-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      
        blist: Bitmap Block Allocator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sbuf-string-buffers" class="md-nav__link">
    <span class="md-ellipsis">
      
        sbuf: String Buffers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sglist-scatter-gather-lists" class="md-nav__link">
    <span class="md-ellipsis">
      
        sglist: Scatter-Gather Lists
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rbtree-red-black-tree-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        rbtree: Red-Black Tree Utilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-flow-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Flow Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Flow Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-simple-kmalloc-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 1: Simple kmalloc Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-cross-cpu-free-with-ipi" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 2: Cross-CPU Free with IPI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-type-stable-object-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 3: Type-Stable Object Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-4-objcache-magazine-exchange" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 4: Objcache Magazine Exchange
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-5-zone-recycling-and-hysteresis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 5: Zone Recycling and Hysteresis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices-and-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices and Guidelines
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices and Guidelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-the-right-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choosing the Right Allocator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-flags-m_waitok-vs-m_nowait" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Flags: M_WAITOK vs. M_NOWAIT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-leak-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Leak Prevention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Tips
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-techniques" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging Techniques
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Considerations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../initialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Initialization & Bootstrap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processes & Threads
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Resources & Credentials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../signals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2_11" >
        
          
          <label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/namecache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Name Lookup & Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/mounting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mounting & Unmounting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/buffer-cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Buffer Cache & I/O
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vfs/vfs-operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ipc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IPC & Sockets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Devices & Drivers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../syscalls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cpu/x86_64/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architectural-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architectural Layers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architectural Layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layer-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Layer Responsibilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-allocation-flags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Allocation Flags
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Allocation Flags">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#blocking-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Blocking Behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Properties
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kmallockfree-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        kmalloc/kfree API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="kmalloc/kfree API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basic Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malloc-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Malloc Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-size-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Size Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-sized-allocations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zero-Sized Allocations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#string-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        String Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reallocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reallocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-type-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Type Creation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-stable-object-allocator-kmalloc_obj" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type-Stable Object Allocator (kmalloc_obj)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Type-Stable Object Allocator (kmalloc_obj)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-object-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Defining Object Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Object Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-stable-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type-Stable Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-fast-path" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Fast Path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free-fast-path" class="md-nav__link">
    <span class="md-ellipsis">
      
        Free Fast Path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-stability-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type Stability Benefits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-slab-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Slab Cache
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slab-allocator-internals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slab Allocator Internals
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Slab Allocator Internals">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zone-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zone Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-zone-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-CPU Zone Management
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-size-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zone Size Calculation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Free Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-cpu-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross-CPU Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-recycling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zone Recycling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chunk-bitmap-invariants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chunk Bitmap (INVARIANTS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-pattern-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Pattern Debugging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#object-cache-objcache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Object Cache (objcache)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Object Cache (objcache)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Data Structures
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-an-object-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating an Object Cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-objects" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocating Objects
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-objects" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returning Objects
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#magazine-sizing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Magazine Sizing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-limit-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Limit Adjustment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#destroying-an-object-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Destroying an Object Cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend-allocators" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend Allocators
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#objcache-statistics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Objcache Statistics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#magazine-advantages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Magazine Advantages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-objcache" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use Objcache
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#malloc-pipes-mpipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Malloc Pipes (mpipe)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Malloc Pipes (mpipe)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      
        API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-malloc-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a Malloc Pipe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-from-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocating from Pipe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#freeing-to-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Freeing to Pipe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#destroying-a-malloc-pipe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Destroying a Malloc Pipe
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      
        Callback Mechanism
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Internal Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-algorithm_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statistics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Statistics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-malloc-pipes" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use Malloc Pipes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advantages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advantages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Limitations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#helper-allocators" class="md-nav__link">
    <span class="md-ellipsis">
      
        Helper Allocators
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Helper Allocators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alist-power-of-2-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      
        alist: Power-of-2 Allocator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blist-bitmap-block-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      
        blist: Bitmap Block Allocator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sbuf-string-buffers" class="md-nav__link">
    <span class="md-ellipsis">
      
        sbuf: String Buffers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sglist-scatter-gather-lists" class="md-nav__link">
    <span class="md-ellipsis">
      
        sglist: Scatter-Gather Lists
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rbtree-red-black-tree-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        rbtree: Red-Black Tree Utilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-flow-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Flow Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Flow Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-simple-kmalloc-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 1: Simple kmalloc Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-cross-cpu-free-with-ipi" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 2: Cross-CPU Free with IPI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-type-stable-object-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 3: Type-Stable Object Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-4-objcache-magazine-exchange" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 4: Objcache Magazine Exchange
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-5-zone-recycling-and-hysteresis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 5: Zone Recycling and Hysteresis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices-and-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices and Guidelines
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices and Guidelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-the-right-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choosing the Right Allocator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocation-flags-m_waitok-vs-m_nowait" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocation Flags: M_WAITOK vs. M_NOWAIT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-leak-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Leak Prevention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Tips
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-techniques" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging Techniques
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Considerations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="memory-allocation">Memory Allocation<a class="headerlink" href="#memory-allocation" title="Permanent link">&para;</a></h1>
<p>This document describes DragonFly BSD's kernel memory allocation subsystems, which provide efficient, scalable memory management for kernel code.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>DragonFly BSD implements a sophisticated multi-layered memory allocation system optimized for SMP scalability and low overhead. The system provides several allocators, each optimized for different use cases:</p>
<ol>
<li><strong>kmalloc/kfree</strong> - General-purpose allocation API (<code>sys/kern/kern_slaballoc.c</code>)</li>
<li><strong>kmalloc_obj</strong> - Type-stable object allocator (<code>sys/kern/kern_kmalloc.c</code>)</li>
<li><strong>objcache</strong> - Per-CPU object caches with magazine layer (<code>sys/kern/kern_objcache.c</code>)</li>
<li><strong>mpipe</strong> - Pre-allocated object pools (<code>sys/kern/kern_mpipe.c</code>)</li>
<li><strong>Helper allocators</strong> - Specialized data structure allocators (alist, blist, etc.)</li>
</ol>
<p>The system is designed around several key principles:</p>
<ul>
<li><strong>Per-CPU operation</strong>: Most allocations occur without locks, using per-CPU data structures</li>
<li><strong>Lock-free fast paths</strong>: Common allocations complete without synchronization</li>
<li><strong>Magazine/depot architecture</strong>: Multi-level caching reduces contention</li>
<li><strong>Type stability</strong>: Object allocators maintain type information for improved debuggability</li>
<li><strong>Lazy IPI</strong>: Cross-CPU operations use asynchronous IPI messages</li>
</ul>
<h2 id="architectural-layers">Architectural Layers<a class="headerlink" href="#architectural-layers" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  Kernel Code (drivers, filesystems, network stack, etc.)        
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                                                 
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>           
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>         kmalloc/kfree    kmalloc_obj       objcache   
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>          (slab API)      (type-stable)    (magazine)  
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>           
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                                                    
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>       
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                   Slab Allocator (kern_slaballoc.c)        
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>            Per-CPU zones, chunk management, IPI ops        
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>       
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                                
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                        
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>                          kmem_slab_   
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                          alloc/free   
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                        
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                                
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                        
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                           VM System   
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                         (vm_map, etc) 
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                        
</code></pre></div>
<h3 id="layer-responsibilities">Layer Responsibilities<a class="headerlink" href="#layer-responsibilities" title="Permanent link">&para;</a></h3>
<p><strong>API Layer</strong> (<code>kern_kmalloc.c</code>):
- Provides <code>kmalloc()</code> and <code>kfree()</code> API
- Implements kmalloc_obj for type-stable allocations
- Manages malloc types and statistics
- Routes large allocations directly to VM</p>
<p><strong>Slab Allocator</strong> (<code>kern_slaballoc.c</code>):
- Power-of-2 sized zones (8 bytes to 32KB)
- Per-CPU zone management
- Lock-free allocation and freeing
- Cross-CPU IPI-based operations
- Bitmap tracking for allocated chunks</p>
<p><strong>Object Cache</strong> (<code>kern_objcache.c</code>):
- Magazine-based per-CPU caching
- Depot layer for magazine exchange
- Constructor/destructor support
- Configurable limits and policies</p>
<p><strong>VM Interface</strong> (<code>kmem_slab_alloc/free</code>):
- Direct KVA and page allocation
- Wiring and mapping management
- Large allocation support</p>
<h2 id="memory-allocation-flags">Memory Allocation Flags<a class="headerlink" href="#memory-allocation-flags" title="Permanent link">&para;</a></h2>
<p>All allocation functions accept flags that control behavior:</p>
<h3 id="blocking-behavior">Blocking Behavior<a class="headerlink" href="#blocking-behavior" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
<th>Can Fail?</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>M_WAITOK</code></td>
<td>Block until memory available</td>
<td>No (panics on failure)</td>
</tr>
<tr>
<td><code>M_NOWAIT</code></td>
<td>Return NULL immediately if unavailable</td>
<td>Yes</td>
</tr>
<tr>
<td><code>M_NULLOK</code></td>
<td>Return NULL instead of panicking</td>
<td>Yes (with M_WAITOK)</td>
</tr>
<tr>
<td><code>M_INTWAIT</code></td>
<td>Like M_WAITOK for interrupt context</td>
<td>No</td>
</tr>
<tr>
<td><code>M_INTNOWAIT</code></td>
<td>Like M_NOWAIT for interrupt context</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<h3 id="memory-properties">Memory Properties<a class="headerlink" href="#memory-properties" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>M_ZERO</code></td>
<td>Zero allocated memory</td>
</tr>
<tr>
<td><code>M_USE_RESERVE</code></td>
<td>Can use emergency reserves</td>
</tr>
<tr>
<td><code>M_USE_INTERRUPT_RESERVE</code></td>
<td>Can exhaust free list (interrupt)</td>
</tr>
<tr>
<td><code>M_CACHEALIGN</code></td>
<td>Align to cache line boundary</td>
</tr>
<tr>
<td><code>M_POWEROF2</code></td>
<td>Round size to power of 2</td>
</tr>
</tbody>
</table>
<p><strong>Important</strong>: The default behavior without <code>M_ZERO</code> leaves memory uninitialized for performance. In <code>INVARIANTS</code> mode, memory may be filled with patterns to detect use-after-free.</p>
<h2 id="kmallockfree-api">kmalloc/kfree API<a class="headerlink" href="#kmallockfree-api" title="Permanent link">&para;</a></h2>
<p>The primary allocation interface for general-purpose kernel memory.</p>
<h3 id="basic-usage">Basic Usage<a class="headerlink" href="#basic-usage" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/malloc.h&gt;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="cm">/* Define a malloc type */</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">MALLOC_DEFINE</span><span class="p">(</span><span class="n">M_MYSUBSYS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mysubsys&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;My subsystem allocations&quot;</span><span class="p">);</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="cm">/* Allocate memory */</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_MYSUBSYS</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="cm">/* Allocate and zero */</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_MYSUBSYS</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">M_ZERO</span><span class="p">);</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="cm">/* Non-blocking allocation */</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_MYSUBSYS</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="cm">/* Handle allocation failure */</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="p">}</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="cm">/* Free memory */</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">M_MYSUBSYS</span><span class="p">);</span>
</code></pre></div>
<h3 id="malloc-types">Malloc Types<a class="headerlink" href="#malloc-types" title="Permanent link">&para;</a></h3>
<p>Every allocation must specify a <code>malloc_type</code> for tracking and statistics. Types are defined with:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">MALLOC_DEFINE</span><span class="p">(</span><span class="n">type_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;short-desc&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Long description&quot;</span><span class="p">);</span>
</code></pre></div>
<p><strong>Pre-defined types</strong> (in <code>sys/kern/kern_slaballoc.c</code>):
- <code>M_CACHE</code> - Various dynamically allocated caches
- <code>M_DEVBUF</code> - Device driver memory
- <code>M_TEMP</code> - Temporary buffers
- <code>M_DRM</code> - DRM subsystem allocations</p>
<h3 id="allocation-size-limits">Allocation Size Limits<a class="headerlink" href="#allocation-size-limits" title="Permanent link">&para;</a></h3>
<p>The slab allocator handles allocations based on size:</p>
<table>
<thead>
<tr>
<th>Size Range</th>
<th>Chunk Size</th>
<th>Zones</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>1-127 bytes</td>
<td>8 bytes</td>
<td>16</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>128-255</td>
<td>16 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>256-511</td>
<td>32 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>512-1023</td>
<td>64 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>1024-2047</td>
<td>128 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>2048-4095</td>
<td>256 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>4096-8191</td>
<td>512 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>8192-16383</td>
<td>1024 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td>16384-32767</td>
<td>2048 bytes</td>
<td>8</td>
<td>Slab allocation</td>
</tr>
<tr>
<td> ZoneLimit</td>
<td>Page-aligned</td>
<td>-</td>
<td>Direct VM allocation</td>
</tr>
</tbody>
</table>
<p><strong>Notes</strong>:
- Allocations are rounded up to chunk size
- Alignment equals chunk size for power-of-2 requests
- Large allocations ( ZoneLimit or &gt;2 pages) bypass slab allocator
- ZoneLimit is typically 32KB on systems with 1GB RAM</p>
<h3 id="zero-sized-allocations">Zero-Sized Allocations<a class="headerlink" href="#zero-sized-allocations" title="Permanent link">&para;</a></h3>
<p>DragonFly allows <code>kmalloc(0, ...)</code> for compatibility (some drivers depend on this):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="cm">/* Returns special ZERO_LENGTH_PTR (-8), not NULL */</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Safe to free */</span>
</code></pre></div>
<h3 id="string-allocation">String Allocation<a class="headerlink" href="#string-allocation" title="Permanent link">&para;</a></h3>
<p>Convenience functions for string duplication:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="cm">/* Duplicate a string */</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kstrdup</span><span class="p">(</span><span class="n">original</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">kfree</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="cm">/* Duplicate with length limit */</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kstrndup</span><span class="p">(</span><span class="n">original</span><span class="p">,</span><span class="w"> </span><span class="n">maxlen</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
</code></pre></div>
<h3 id="reallocation">Reallocation<a class="headerlink" href="#reallocation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="cm">/* Resize allocation - may move data */</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">new_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">krealloc</span><span class="p">(</span><span class="n">old_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="cm">/* If new size fits in same zone, returns same pointer */</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="cm">/* Otherwise allocates new memory and copies data */</span>
</code></pre></div>
<p><strong>Note</strong>: <code>krealloc()</code> does not support <code>M_ZERO</code> flag.</p>
<h3 id="memory-limits">Memory Limits<a class="headerlink" href="#memory-limits" title="Permanent link">&para;</a></h3>
<p>Each malloc type has an associated limit (typically 10% of kernel memory):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="cm">/* Check current limit */</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kt">long</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_limit</span><span class="p">(</span><span class="n">M_MYSUBSYS</span><span class="p">);</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="cm">/* Raise limit (never shrinks) */</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">kmalloc_raise_limit</span><span class="p">(</span><span class="n">M_MYSUBSYS</span><span class="p">,</span><span class="w"> </span><span class="n">new_limit_bytes</span><span class="p">);</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="cm">/* Set to unlimited */</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="n">kmalloc_set_unlimited</span><span class="p">(</span><span class="n">M_MYSUBSYS</span><span class="p">);</span>
</code></pre></div>
<p>When a limit is exceeded:
- <code>M_WAITOK</code> allocations <strong>panic</strong>
- <code>M_NULLOK</code> allocations return NULL
- Prevents runaway memory usage</p>
<h3 id="dynamic-type-creation">Dynamic Type Creation<a class="headerlink" href="#dynamic-type-creation" title="Permanent link">&para;</a></h3>
<p>For dynamically loaded modules or runtime-created subsystems:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_type</span><span class="w"> </span><span class="o">*</span><span class="n">my_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="cm">/* Create malloc type */</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">kmalloc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_type</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;runtime-type&quot;</span><span class="p">);</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="cm">/* Use it */</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">my_type</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">my_type</span><span class="p">);</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="cm">/* Destroy when done (must have no outstanding allocations) */</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="n">kmalloc_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_type</span><span class="p">);</span>
</code></pre></div>
<h2 id="type-stable-object-allocator-kmalloc_obj">Type-Stable Object Allocator (kmalloc_obj)<a class="headerlink" href="#type-stable-object-allocator-kmalloc_obj" title="Permanent link">&para;</a></h2>
<p>For fixed-size object allocations, DragonFly provides a type-stable allocator optimized for common-sized objects. This allocator provides:</p>
<ul>
<li><strong>Type stability</strong>: All objects of a type can be freed in bulk</li>
<li><strong>Per-CPU slabs</strong>: 128KB slabs with embedded object management</li>
<li><strong>Lock-free operations</strong>: Atomic operations for cross-CPU frees</li>
<li><strong>Efficient recycling</strong>: Two-tier slab management (per-CPU + global)</li>
</ul>
<h3 id="defining-object-types">Defining Object Types<a class="headerlink" href="#defining-object-types" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cm">/* Define a type-stable object type */</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_type</span><span class="w"> </span><span class="o">*</span><span class="n">my_obj_type</span><span class="p">;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">MALLOC_DEFINE_OBJ</span><span class="p">(</span><span class="n">my_obj_type</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="p">),</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">                  </span><span class="s">&quot;myobj&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;My object type&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Alternatively, create at runtime:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">_kmalloc_create_obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_obj_type</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my_runtime_obj&quot;</span><span class="p">,</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">                    </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="p">));</span>
</code></pre></div>
<h3 id="object-allocation">Object Allocation<a class="headerlink" href="#object-allocation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="cm">/* Allocate object */</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_obj</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="p">),</span><span class="w"> </span><span class="n">my_obj_type</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="cm">/* Use object */</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">obj</span><span class="o">-&gt;</span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="n">obj</span><span class="o">-&gt;</span><span class="n">field2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="cm">/* Free object */</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="n">kfree_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">my_obj_type</span><span class="p">);</span>
</code></pre></div>
<h3 id="type-stable-architecture">Type-Stable Architecture<a class="headerlink" href="#type-stable-architecture" title="Permanent link">&para;</a></h3>
<p><strong>Per-CPU Slab Management</strong>:</p>
<p>Each malloc type maintains per-CPU state in <code>struct kmalloc_use</code>:
- <code>active</code> - Current slab being allocated from
- <code>alternate</code> - Backup slab (hot spare)
- Per-CPU statistics (<code>memuse</code>, <code>inuse</code>, etc.)</p>
<p><strong>Slab Structure</strong> (128KB each):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a> kmalloc_slab (header)                                       
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a> fobjs[4096] - Circular buffer of free object pointers      
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>   - findex: next free index                                 
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>   - nindex: next allocation index                           
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>   - maxobjs: total capacity                                 
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a> Objects (allocated from end of slab)                        
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>                                                             
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>   [ obj 1 ][ obj 2 ][ obj 3 ] ... [ obj N ]                
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
</code></pre></div>
<p><strong>Slab States</strong>:</p>
<ol>
<li><strong>Active/Alternate</strong> (per-CPU): Fast allocation, no locks</li>
<li><strong>Partial</strong> (global): Has free objects, used to refill per-CPU</li>
<li><strong>Full</strong> (global): All allocated, kept for type-safety</li>
<li><strong>Empty</strong> (global): All freed, eligible for recycling</li>
</ol>
<h3 id="allocation-fast-path">Allocation Fast Path<a class="headerlink" href="#allocation-fast-path" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="cm">/* From kern_kmalloc.c:kmalloc_obj_alloc() */</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="mf">1.</span><span class="w"> </span><span class="n">Try</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="n">slab</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">fobjs</span><span class="p">[]</span><span class="w"> </span><span class="n">array</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="mf">2.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">empty</span><span class="p">,</span><span class="w"> </span><span class="n">swap</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="n">alternate</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="mf">3.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">both</span><span class="w"> </span><span class="n">empty</span><span class="p">,</span><span class="w"> </span><span class="n">rotate</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">partial</span><span class="err"></span><span class="n">active</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="mf">4.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">partial</span><span class="w"> </span><span class="n">slabs</span><span class="p">,</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="mi">128</span><span class="n">KB</span><span class="w"> </span><span class="n">slab</span>
</code></pre></div>
<p><strong>Key Insight</strong>: The fobjs[] circular buffer provides O(1) alloc/free with no linked-list manipulation.</p>
<h3 id="free-fast-path">Free Fast Path<a class="headerlink" href="#free-fast-path" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="cm">/* From kern_kmalloc.c:kmalloc_obj_free() */</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="mf">1.</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">slab</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">pointer</span><span class="o">:</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">128</span><span class="n">KB</span><span class="mi">-1</span><span class="p">)</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="mf">2.</span><span class="w"> </span><span class="n">Atomically</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">slab</span><span class="o">-&gt;</span><span class="n">fobjs</span><span class="p">[</span><span class="n">slab</span><span class="o">-&gt;</span><span class="n">findex</span><span class="o">++</span><span class="p">]</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="mf">3.</span><span class="w"> </span><span class="n">Update</span><span class="w"> </span><span class="n">per</span><span class="o">-</span><span class="n">CPU</span><span class="w"> </span><span class="n">statistics</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="mf">4.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">cross</span><span class="o">-</span><span class="n">CPU</span><span class="w"> </span><span class="n">free</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="n">only</span>
</code></pre></div>
<p><strong>Cross-CPU Free</strong>: When freeing to remote CPU's slab, atomic increments ensure thread-safety without explicit locks.</p>
<h3 id="type-stability-benefits">Type Stability Benefits<a class="headerlink" href="#type-stability-benefits" title="Permanent link">&para;</a></h3>
<p>When unmounting a filesystem (e.g., tmpfs), all memory from the filesystem's malloc type can be returned:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cm">/* During unmount */</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">malloc_uninit</span><span class="p">(</span><span class="n">tmpfs_mount_type</span><span class="p">);</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="cm">/* This returns ALL slabs for this type to the system */</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="cm">/* No fragmentation! All 128KB slabs are freed intact */</span>
</code></pre></div>
<p>Traditional allocators would have fragmentation preventing full memory reclamation.</p>
<h3 id="per-cpu-slab-cache">Per-CPU Slab Cache<a class="headerlink" href="#per-cpu-slab-cache" title="Permanent link">&para;</a></h3>
<p>To avoid expensive <code>kmem_slab_alloc()</code> calls, DragonFly maintains a per-globaldata slab cache:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="cm">/* In globaldata structure */</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">globaldata</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="n">kmalloc_slab_t</span><span class="w"> </span><span class="n">gd_kmslab</span><span class="p">[</span><span class="n">KMGD_MAXFREESLABS</span><span class="p">];</span><span class="w">  </span><span class="cm">/* 128 slabs */</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">            </span><span class="n">gd_kmslab_avail</span><span class="p">;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Benefits</strong>:
- Fast slab allocation from cache
- Amortizes VM allocation cost
- Reduces system map contention</p>
<h2 id="slab-allocator-internals">Slab Allocator Internals<a class="headerlink" href="#slab-allocator-internals" title="Permanent link">&para;</a></h2>
<p>The slab allocator (<code>kern_slaballoc.c</code>) provides the foundation for kmalloc operations.</p>
<h3 id="zone-structure">Zone Structure<a class="headerlink" href="#zone-structure" title="Permanent link">&para;</a></h3>
<p>A <strong>zone</strong> represents a region of memory divided into fixed-size chunks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">SLZone</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w">  </span><span class="n">z_Magic</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Magic number validation */</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_NFree</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Number of free chunks */</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_NMax</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Total chunks in zone */</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">SLZone</span><span class="w"> </span><span class="o">*</span><span class="n">z_Next</span><span class="p">;</span><span class="w">     </span><span class="cm">/* List linkage */</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_BaseIndex</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Optimization: start search here */</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_ChunkSize</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Size of each chunk */</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_ZoneIndex</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Which zone array (by size) */</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_Cpu</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Owning CPU */</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">globaldata</span><span class="w"> </span><span class="o">*</span><span class="n">z_CpuGd</span><span class="p">;</span><span class="cm">/* Owning CPU&#39;s globaldata */</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">    </span><span class="cm">/* Free chunk lists */</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">SLChunk</span><span class="w"> </span><span class="o">*</span><span class="n">z_LChunks</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Local free chunks (LIFO) */</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">SLChunk</span><span class="w"> </span><span class="o">**</span><span class="n">z_LChunksp</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Tail pointer */</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">SLChunk</span><span class="w"> </span><span class="o">*</span><span class="n">z_RChunks</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Remote free chunks (from other CPUs) */</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">    </span><span class="cm">/* Cross-CPU synchronization */</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_RSignal</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Signal for remote operations */</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">z_RCount</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Count of in-flight remote operations */</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">    </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">z_BasePtr</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Base of chunk array */</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="cp">#ifdef INVARIANTS</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">z_Bitmap</span><span class="p">[...];</span><span class="w">    </span><span class="cm">/* Allocation bitmap for debugging */</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="cp">#endif</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="p">};</span>
</code></pre></div>
<h3 id="per-cpu-zone-management">Per-CPU Zone Management<a class="headerlink" href="#per-cpu-zone-management" title="Permanent link">&para;</a></h3>
<p>Each CPU maintains separate zone lists in <code>struct SLGlobalData</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">SLGlobalData</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="n">SLZoneList</span><span class="w"> </span><span class="n">ZoneAry</span><span class="p">[</span><span class="n">NZONES</span><span class="p">];</span><span class="w">      </span><span class="cm">/* Zones by size */</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">SLZoneList</span><span class="w"> </span><span class="n">FreeZones</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Completely free zones */</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="n">SLZoneList</span><span class="w"> </span><span class="n">FreeOvZones</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Oversized free zones */</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">        </span><span class="n">NFreeZones</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Count of free zones */</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="kt">int</span><span class="w">        </span><span class="n">JunkIndex</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Randomization for new zones */</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="p">};</span>
</code></pre></div>
<p><strong>NZONES</strong> is typically 72 (16 for small + 56 for larger sizes).</p>
<h3 id="zone-size-calculation">Zone Size Calculation<a class="headerlink" href="#zone-size-calculation" title="Permanent link">&para;</a></h3>
<p>Zone size is determined at boot based on system memory:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="cm">/* From kmeminit() in kern_slaballoc.c */</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">ZoneSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZALLOC_MIN_ZONE_SIZE</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Start at 32KB */</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ZoneSize</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ZALLOC_MAX_ZONE_SIZE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ZoneSize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">usesize</span><span class="p">)</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="n">ZoneSize</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="cm">/* Typically:</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="cm"> * &lt; 128MB RAM: 32KB zones</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="cm"> * &gt;= 1GB RAM:  128KB zones (most systems)</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="cm"> */</span>
</code></pre></div>
<p>Larger zones reduce per-zone overhead but increase memory slack.</p>
<h3 id="allocation-algorithm">Allocation Algorithm<a class="headerlink" href="#allocation-algorithm" title="Permanent link">&para;</a></h3>
<p>The <code>_kmalloc()</code> function (kern_slaballoc.c:814) implements allocation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="mf">1.</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="n">cases</span><span class="o">:</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">malloc</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">limit</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="k">return</span><span class="w"> </span><span class="n">ZERO_LENGTH_PTR</span><span class="p">)</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="mf">2.</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">small</span><span class="w"> </span><span class="n">allocations</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="w"> </span><span class="n">ZoneLimit</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="n">zoneindex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">align</span><span class="p">)</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">   </span><span class="n">b</span><span class="p">.</span><span class="w"> </span><span class="n">Enter</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">section</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">   </span><span class="n">c</span><span class="p">.</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">chunks</span><span class="o">:</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">ZoneAry</span><span class="p">[</span><span class="n">zi</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">most</span><span class="w"> </span><span class="n">recently</span><span class="w"> </span><span class="n">used</span><span class="p">)</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">chunks</span><span class="p">,</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">z_RChunks</span><span class="w"> </span><span class="p">(</span><span class="n">remote</span><span class="w"> </span><span class="n">frees</span><span class="p">)</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">zone</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">   </span><span class="n">d</span><span class="p">.</span><span class="w"> </span><span class="n">Pop</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">z_UIndex</span><span class="w"> </span><span class="p">(</span><span class="n">never</span><span class="o">-</span><span class="n">allocated</span><span class="p">)</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">   </span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="n">Update</span><span class="w"> </span><span class="n">statistics</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">   </span><span class="n">f</span><span class="p">.</span><span class="w"> </span><span class="n">Exit</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">section</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">   </span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="n">Zero</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">M_ZERO</span><span class="w"> </span><span class="n">requested</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="mf">3.</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">large</span><span class="w"> </span><span class="n">allocations</span><span class="w"> </span><span class="p">(</span><span class="err"></span><span class="w"> </span><span class="n">ZoneLimit</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="w"> </span><span class="n">Round</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">boundary</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">   </span><span class="n">b</span><span class="p">.</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">kmem_slab_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">   </span><span class="n">c</span><span class="p">.</span><span class="w"> </span><span class="n">Mark</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="p">(</span><span class="n">btokup</span><span class="p">)</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">   </span><span class="n">d</span><span class="p">.</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="n">pointer</span>
</code></pre></div>
<p><strong>Critical section</strong>: Uses <code>crit_enter()/crit_exit()</code> not locks. This blocks preemption but allows interrupts.</p>
<h3 id="free-algorithm">Free Algorithm<a class="headerlink" href="#free-algorithm" title="Permanent link">&para;</a></h3>
<p>The <code>_kfree()</code> function (kern_slaballoc.c:1391) implements deallocation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="mf">1.</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="n">cases</span><span class="o">:</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="p">(</span><span class="n">panic</span><span class="p">)</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">ZERO_LENGTH_PTR</span><span class="w"> </span><span class="p">(</span><span class="k">return</span><span class="w"> </span><span class="n">immediately</span><span class="p">)</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">magic</span><span class="w"> </span><span class="n">number</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="mf">2.</span><span class="w"> </span><span class="n">Determine</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">oversized</span><span class="o">:</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">   </span><span class="n">kup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btokup</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Kernel page table lookup */</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">kup</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">       </span><span class="cm">/* Oversized allocation */</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">       </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">kup</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">;</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">       </span><span class="n">kmem_slab_free</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">       </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="mf">3.</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">allocations</span><span class="o">:</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">   </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SLZone</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">ptr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ZoneMask</span><span class="p">);</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_CpuGd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">mycpu</span><span class="o">:</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">      </span><span class="cm">/* Cross-CPU free */</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Atomic</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_RChunks</span><span class="w"> </span><span class="n">list</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">IPI</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">reactivation</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">   </span><span class="n">b</span><span class="p">.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">CPU</span><span class="o">:</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Enter</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">section</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_LChunks</span><span class="w"> </span><span class="p">(</span><span class="n">front</span><span class="p">,</span><span class="w"> </span><span class="n">LIFO</span><span class="p">)</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Update</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_NFree</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">becomes</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="n">free</span><span class="p">,</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">FreeZones</span><span class="w"> </span><span class="n">list</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Exit</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">section</span>
</code></pre></div>
<p><strong>LIFO ordering</strong>: Recently freed memory is hot in cache, so reallocate it first.</p>
<h3 id="cross-cpu-operations">Cross-CPU Operations<a class="headerlink" href="#cross-cpu-operations" title="Permanent link">&para;</a></h3>
<p>When CPU A frees memory owned by CPU B:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="cm">/* CPU A (freeing) */</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="mf">1.</span><span class="w"> </span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">c_Next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_RChunks</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Atomic */</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="mf">2.</span><span class="w"> </span><span class="n">atomic_cmpset_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_RChunks</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">);</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="mf">3.</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zone</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="n">allocated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">       </span><span class="n">lwkt_send_ipiq_passive</span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_CpuGd</span><span class="p">,</span><span class="w"> </span><span class="n">kfree_remote</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="cm">/* CPU B (IPI handler) */</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="n">kfree_remote</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SLZone</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">    </span><span class="cm">/* Move z-&gt;z_RChunks to z-&gt;z_LChunks */</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">    </span><span class="n">clean_zone_rchunks</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">    </span><span class="cm">/* Reactivate zone if it has free chunks */</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_NFree</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">        </span><span class="n">TAILQ_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slgd</span><span class="o">-&gt;</span><span class="n">ZoneAry</span><span class="p">[</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_ZoneIndex</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">z_Entry</span><span class="p">);</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Key optimizations</strong>:
- Passive IPI: Low priority, batched
- z_RSignal flag: Avoids IPI if zone already active
- z_RCount: Prevents premature zone destruction</p>
<h3 id="zone-recycling">Zone Recycling<a class="headerlink" href="#zone-recycling" title="Permanent link">&para;</a></h3>
<p>Completely free zones are kept in the <code>FreeZones</code> list up to a threshold (<code>ZoneRelsThresh</code>, default 32). Beyond that, zones are returned to the VM system:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="cm">/* In _kmalloc() hysteresis check */</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">slgd</span><span class="o">-&gt;</span><span class="n">NFreeZones</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ZoneRelsThresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAILQ_LAST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slgd</span><span class="o">-&gt;</span><span class="n">FreeZones</span><span class="p">,</span><span class="w"> </span><span class="n">SLZoneList</span><span class="p">);</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="n">TAILQ_REMOVE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slgd</span><span class="o">-&gt;</span><span class="n">FreeZones</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">z_Entry</span><span class="p">);</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">    </span><span class="o">--</span><span class="n">slgd</span><span class="o">-&gt;</span><span class="n">NFreeZones</span><span class="p">;</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="n">kmem_slab_free</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">ZoneSize</span><span class="p">);</span><span class="w">  </span><span class="cm">/* May block */</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Hysteresis</strong>: Prevents thrashing by keeping a buffer of free zones.</p>
<h3 id="chunk-bitmap-invariants">Chunk Bitmap (INVARIANTS)<a class="headerlink" href="#chunk-bitmap-invariants" title="Permanent link">&para;</a></h3>
<p>In debug builds, zones maintain a bitmap to detect double-free and use-after-free:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="cp">#ifdef INVARIANTS</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">chunk_mark_allocated</span><span class="p">(</span><span class="n">SLZone</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">chunk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bitdex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">chunk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_BasePtr</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_ChunkSize</span><span class="p">;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="n">KASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_Bitmap</span><span class="p">[</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">))),</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">            </span><span class="p">(</span><span class="s">&quot;double allocation&quot;</span><span class="p">));</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_Bitmap</span><span class="p">[</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">));</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="p">}</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">chunk_mark_free</span><span class="p">(</span><span class="n">SLZone</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">chunk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bitdex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">chunk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_BasePtr</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_ChunkSize</span><span class="p">;</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="n">KASSERT</span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_Bitmap</span><span class="p">[</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">)),</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">            </span><span class="p">(</span><span class="s">&quot;double free&quot;</span><span class="p">));</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">z_Bitmap</span><span class="p">[</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">bitdex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">));</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="p">}</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="cp">#endif</span>
</code></pre></div>
<h3 id="memory-pattern-debugging">Memory Pattern Debugging<a class="headerlink" href="#memory-pattern-debugging" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="cm">/* In INVARIANTS mode */</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">use_malloc_pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* sysctl debug.use_malloc_pattern */</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">use_weird_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">     </span><span class="cm">/* sysctl debug.use_weird_array */</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="cm">/* On allocation without M_ZERO */</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_malloc_pattern</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">chunk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 0xFFFFFFFF pattern */</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="p">}</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="cm">/* On free */</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_weird_array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">    </span><span class="n">bcopy</span><span class="p">(</span><span class="n">weirdary</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">weirdary</span><span class="p">)));</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">    </span><span class="cm">/* weirdary = { WEIRD_ADDR, ...} = { 0xdeadc0de, ... } */</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Usage</strong>: Enable via sysctl to detect:
- Use of uninitialized memory (all 0xFF bytes)
- Use after free (0xDEADC0DE pattern)</p>
<h2 id="object-cache-objcache">Object Cache (objcache)<a class="headerlink" href="#object-cache-objcache" title="Permanent link">&para;</a></h2>
<p>The object cache system (<code>kern_objcache.c</code>) provides a high-level caching layer for frequently allocated objects. It implements a <strong>magazine-based</strong> architecture similar to Solaris/Illumos slab allocator.</p>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>                Per-CPU Layer (lock-free)
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>  CPU 0                CPU 1                CPU N          
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>            
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>   loaded            loaded            loaded      
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>   magazine          magazine          magazine    
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>                  
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>   obj obj         obj obj         obj obj   
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>   obj obj         obj obj         obj obj   
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>                  
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>                                                   
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>   previous          previous          previous    
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>   magazine          magazine          magazine    
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>                  
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>   obj                             obj obj   
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>                                   obj       
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>                  
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>            
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>                            
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>                    Depot Layer (locked)
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>  Cluster 0 Depot (spinlock protected)                    
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>                 
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>  Full Magazines      Empty Magazines                
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>                     
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>  full mag          empty mag                    
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>  full mag          empty mag                    
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>  full mag          empty mag                    
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>                     
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>                 
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>                                                          
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>  unallocated_objects: 1024                              
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>  cluster_limit: 2048                                    
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>                           
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>                  Backend Allocator
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>  objcache_malloc_alloc() / objcache_malloc_free()        
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>  (or custom allocator)                                   
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>
</code></pre></div>
<h3 id="key-data-structures">Key Data Structures<a class="headerlink" href="#key-data-structures" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="cm">/* Magazine - array of object pointers */</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">magazine</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rounds</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Current number of objects */</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Maximum capacity */</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="n">SLIST_ENTRY</span><span class="p">(</span><span class="n">magazine</span><span class="p">)</span><span class="w"> </span><span class="n">nextmagazine</span><span class="p">;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">objects</span><span class="p">[];</span><span class="w">         </span><span class="cm">/* Flexible array of object pointers */</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="p">};</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="cm">/* Per-CPU cache state */</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="k">struct</span><span class="w"> </span><span class="nc">percpu_objcache</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazine</span><span class="w"> </span><span class="o">*</span><span class="n">loaded_magazine</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Active magazine */</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazine</span><span class="w"> </span><span class="o">*</span><span class="n">previous_magazine</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Backup magazine */</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">    </span><span class="cm">/* Statistics */</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">gets_cumulative</span><span class="p">;</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">gets_null</span><span class="p">;</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">allocs_cumulative</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Backend allocations */</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">puts_cumulative</span><span class="p">;</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">gets_exhausted</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Hit limit */</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="p">};</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="cm">/* Depot (shared between CPUs) */</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="k">struct</span><span class="w"> </span><span class="nc">magazinedepot</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazinelist</span><span class="w"> </span><span class="n">fullmagazines</span><span class="p">;</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazinelist</span><span class="w"> </span><span class="n">emptymagazines</span><span class="p">;</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">magcapacity</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Objects per magazine */</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="n">spin</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Protects depot */</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">unallocated_objects</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Remaining quota */</span>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cluster_limit</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Total object limit */</span>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">waiting</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Waiters for objects */</span>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="p">};</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="cm">/* Object cache */</span>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a><span class="k">struct</span><span class="w"> </span><span class="nc">objcache</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="w">    </span><span class="n">objcache_ctor_fn</span><span class="w">  </span><span class="o">*</span><span class="n">ctor</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Constructor */</span>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="w">    </span><span class="n">objcache_dtor_fn</span><span class="w">  </span><span class="o">*</span><span class="n">dtor</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Destructor */</span>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">    </span><span class="kt">void</span><span class="w">              </span><span class="o">*</span><span class="n">privdata</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Private data for ctor/dtor */</span>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">    </span><span class="n">objcache_alloc_fn</span><span class="w"> </span><span class="o">*</span><span class="n">alloc</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Backend allocator */</span>
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">    </span><span class="n">objcache_free_fn</span><span class="w">  </span><span class="o">*</span><span class="n">free</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Backend free */</span>
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="w">    </span><span class="kt">void</span><span class="w">              </span><span class="o">*</span><span class="n">allocator_args</span><span class="p">;</span>
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazinedepot</span><span class="w"> </span><span class="n">depot</span><span class="p">[</span><span class="n">MAXCLUSTERS</span><span class="p">];</span><span class="w">  </span><span class="cm">/* MAXCLUSTERS=1 currently */</span>
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">percpu_objcache</span><span class="w"> </span><span class="n">cache_percpu</span><span class="p">[];</span><span class="w">    </span><span class="cm">/* Per-CPU caches */</span>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="p">};</span>
</code></pre></div>
<h3 id="creating-an-object-cache">Creating an Object Cache<a class="headerlink" href="#creating-an-object-cache" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="cm">/* Simple cache backed by kmalloc */</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">objcache</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="p">;</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_create_simple</span><span class="p">(</span><span class="n">M_MYTYPE</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="p">));</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="cm">/* Cache with constructor/destructor */</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="k">static</span><span class="w"> </span><span class="n">boolean_t</span><span class="w"> </span><span class="nf">my_ctor</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">privdata</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ocflags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">    </span><span class="cm">/* Initialize object fields */</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="n">o</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="n">o</span><span class="o">-&gt;</span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Success */</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="p">}</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">my_dtor</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">privdata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="cm">/* Clean up before freeing */</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">    </span><span class="n">KKASSERT</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="p">}</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_create_mbacked</span><span class="p">(</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">    </span><span class="n">M_MYTYPE</span><span class="p">,</span><span class="w">                    </span><span class="cm">/* malloc type */</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">    </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="p">),</span><span class="w">    </span><span class="cm">/* object size */</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">    </span><span class="mi">1000</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* cluster_limit (total objects) */</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">    </span><span class="mi">200</span><span class="p">,</span><span class="w">                         </span><span class="cm">/* nom_cache (cached objects) */</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">    </span><span class="n">my_ctor</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* constructor */</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="w">    </span><span class="n">my_dtor</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* destructor */</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">    </span><span class="nb">NULL</span><span class="w">                         </span><span class="cm">/* privdata */</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="p">);</span>
</code></pre></div>
<p><strong>Key parameters</strong>:
- <code>cluster_limit</code>: Maximum total objects (0 = unlimited)
- <code>nom_cache</code>: Desired number of cached objects
- Magazine capacity is calculated: <code>nom_cache / (ncpus + 1) / 2</code></p>
<h3 id="allocating-objects">Allocating Objects<a class="headerlink" href="#allocating-objects" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="cm">/* Blocking allocation */</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_get</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="cm">/* Non-blocking allocation */</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_get</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">    </span><span class="cm">/* Handle failure */</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="p">}</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="cm">/* Use object */</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="n">obj</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="cm">/* Return to cache */</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="n">objcache_put</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span>
</code></pre></div>
<p><strong>Allocation Flow</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="cm">/* From objcache_get() - kern_objcache.c:427 */</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="mf">1.</span><span class="w"> </span><span class="n">crit_enter</span><span class="p">();</span><span class="w">  </span><span class="cm">/* Block preemption */</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="mf">2.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="n">magazine</span><span class="o">:</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">       </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">objects</span><span class="p">[</span><span class="o">--</span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="p">];</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">       </span><span class="n">crit_exit</span><span class="p">();</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span><span class="w">  </span><span class="cm">/* FAST PATH - no depot access */</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="mf">3.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">magazine</span><span class="o">:</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">       </span><span class="n">swap</span><span class="p">(</span><span class="n">loaded</span><span class="p">,</span><span class="w"> </span><span class="n">previous</span><span class="p">);</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">       </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">objects</span><span class="p">[</span><span class="o">--</span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="p">];</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">       </span><span class="n">crit_exit</span><span class="p">();</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Still fast, no depot */</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="mf">4.</span><span class="w"> </span><span class="n">Both</span><span class="w"> </span><span class="n">magazines</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">depot</span><span class="w"> </span><span class="n">exchange</span><span class="o">:</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="w">   </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SLIST_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">fullmagazines</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="w">       </span><span class="cm">/* Exchange empty for full */</span>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="w">       </span><span class="n">emptymag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">previous</span><span class="p">;</span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="w">       </span><span class="n">previous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loaded</span><span class="p">;</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="w">       </span><span class="n">loaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">fullmagazines</span><span class="p">);</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="w">       </span><span class="n">SLIST_REMOVE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">fullmagazines</span><span class="p">);</span>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="w">       </span><span class="n">SLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">emptymagazines</span><span class="p">,</span><span class="w"> </span><span class="n">emptymag</span><span class="p">);</span>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="w">       </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="w">       </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Now have full magazine */</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="mf">5.</span><span class="w"> </span><span class="n">Depot</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="n">allocation</span><span class="o">:</span>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">unallocated_objects</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a><span class="w">       </span><span class="o">--</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">unallocated_objects</span><span class="p">;</span>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a><span class="w">       </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a><span class="w">       </span><span class="n">crit_exit</span><span class="p">();</span>
<a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a>
<a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a><span class="w">       </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">allocator_args</span><span class="p">,</span><span class="w"> </span><span class="n">ocflags</span><span class="p">);</span>
<a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">ctor</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">privdata</span><span class="p">,</span><span class="w"> </span><span class="n">ocflags</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a><span class="w">           </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">allocator_args</span><span class="p">);</span>
<a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a><span class="w">           </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a><span class="w">       </span><span class="p">}</span>
<a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a>
<a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a><span class="mf">6.</span><span class="w"> </span><span class="n">Limit</span><span class="w"> </span><span class="n">exceeded</span><span class="o">:</span>
<a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ocflags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a><span class="w">       </span><span class="n">ssleep</span><span class="p">(</span><span class="n">depot</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;objcache_get&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a><span class="w">       </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</code></pre></div>
<h3 id="returning-objects">Returning Objects<a class="headerlink" href="#returning-objects" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="cm">/* From objcache_put() - kern_objcache.c:620 */</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="mf">1.</span><span class="w"> </span><span class="n">crit_enter</span><span class="p">();</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="mf">2.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="n">magazine</span><span class="o">:</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">       </span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">objects</span><span class="p">[</span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">       </span><span class="n">crit_exit</span><span class="p">();</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">       </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="cm">/* FAST PATH */</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="mf">3.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">magazine</span><span class="o">:</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">       </span><span class="n">swap</span><span class="p">(</span><span class="n">loaded</span><span class="p">,</span><span class="w"> </span><span class="n">previous</span><span class="p">);</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">       </span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">objects</span><span class="p">[</span><span class="n">loadedmag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">       </span><span class="n">crit_exit</span><span class="p">();</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">       </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="mf">4.</span><span class="w"> </span><span class="n">Both</span><span class="w"> </span><span class="n">magazines</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">depot</span><span class="w"> </span><span class="n">exchange</span><span class="o">:</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">   </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SLIST_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">emptymagazines</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">       </span><span class="cm">/* Exchange full for empty */</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">       </span><span class="n">loadedmag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">previous</span><span class="p">;</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">       </span><span class="n">previous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loaded</span><span class="p">;</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">       </span><span class="n">loaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">emptymagazines</span><span class="p">);</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">       </span><span class="n">SLIST_REMOVE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">emptymagazines</span><span class="p">);</span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MAGAZINE_EMPTY</span><span class="p">(</span><span class="n">loadedmag</span><span class="p">))</span>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="w">           </span><span class="n">SLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">emptymagazines</span><span class="p">,</span><span class="w"> </span><span class="n">loadedmag</span><span class="p">);</span>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="w">       </span><span class="k">else</span>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="w">           </span><span class="n">SLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">fullmagazines</span><span class="p">,</span><span class="w"> </span><span class="n">loadedmag</span><span class="p">);</span>
<a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>
<a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a><span class="w">       </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a><span class="w">       </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a><span class="w">   </span><span class="p">}</span>
<a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a>
<a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="mf">5.</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="n">magazines</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">backend</span><span class="o">:</span>
<a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="w">   </span><span class="o">++</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">unallocated_objects</span><span class="p">;</span>
<a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a><span class="w">   </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depot</span><span class="o">-&gt;</span><span class="n">spin</span><span class="p">);</span>
<a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a><span class="w">   </span><span class="n">crit_exit</span><span class="p">();</span>
<a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a>
<a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a><span class="w">   </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">dtor</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">privdata</span><span class="p">);</span>
<a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="w">   </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">allocator_args</span><span class="p">);</span>
</code></pre></div>
<h3 id="magazine-sizing">Magazine Sizing<a class="headerlink" href="#magazine-sizing" title="Permanent link">&para;</a></h3>
<p>Magazine capacity is cache-line aligned and bounded:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="cm">/* From objcache_create() */</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="cp">#define MAGAZINE_CAPACITY_MIN  4</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="cp">#define MAGAZINE_CAPACITY_MAX  4096</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">mag_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mag_capacity_align</span><span class="p">(</span><span class="n">nom_cache</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">ncpus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mag_capacity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAGAZINE_CAPACITY_MAX</span><span class="p">)</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="n">mag_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGAZINE_CAPACITY_MAX</span><span class="p">;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mag_capacity</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAGAZINE_CAPACITY_MIN</span><span class="p">)</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="n">mag_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGAZINE_CAPACITY_MIN</span><span class="p">;</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="cm">/* Align to cache line */</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="n">mag_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__VM_CACHELINE_ALIGN</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">magazine</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">mag_capacity</span><span class="p">]));</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="n">mag_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mag_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MAGAZINE_HDRSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
</code></pre></div>
<p><strong>Example</strong>: For 1000 object cache on 4-CPU system:
- <code>nom_cache / (4 + 1) / 2 = 1000 / 5 / 2 = 100</code> objects per magazine
- Aligns to cache line, typically 96 or 128 depending on alignment</p>
<h3 id="dynamic-limit-adjustment">Dynamic Limit Adjustment<a class="headerlink" href="#dynamic-limit-adjustment" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="cm">/* Adjust cluster limit at runtime */</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">objcache_set_cluster_limit</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">new_limit</span><span class="p">);</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="cm">/* Affects depot-&gt;unallocated_objects:</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="cm"> * delta = new_limit - old_cluster_limit;</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="cm"> * depot-&gt;unallocated_objects += delta;</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="cm"> */</span>
</code></pre></div>
<p><strong>Use case</strong>: Dynamically grow/shrink cache based on load.</p>
<h3 id="destroying-an-object-cache">Destroying an Object Cache<a class="headerlink" href="#destroying-an-object-cache" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="cm">/* All objects must be returned to cache first */</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="n">objcache_destroy</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="cm">/* Process:</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="cm"> * 1. Remove from global objcache list</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="cm"> * 2. Drain all depot magazines (call dtors)</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="cm"> * 3. Drain all per-CPU magazines</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="cm"> * 4. Free magazines and objcache structure</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="cm"> */</span>
</code></pre></div>
<h3 id="backend-allocators">Backend Allocators<a class="headerlink" href="#backend-allocators" title="Permanent link">&para;</a></h3>
<p><strong>Built-in allocators</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="cm">/* Standard kmalloc backend */</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">objcache_malloc_alloc</span><span class="p">();</span><span class="w">    </span><span class="cm">/* Allocates with kmalloc */</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="n">objcache_malloc_free</span><span class="p">();</span><span class="w">     </span><span class="cm">/* Frees with kfree */</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="cm">/* kmalloc with M_ZERO */</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="n">objcache_malloc_alloc_zero</span><span class="p">();</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="cm">/* No-op backend (pre-allocated objects only) */</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="n">objcache_nop_alloc</span><span class="p">();</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="n">objcache_nop_free</span><span class="p">();</span>
</code></pre></div>
<p><strong>Custom backend</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">my_alloc</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">allocator_args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ocflags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_alloc_args</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocator_args</span><span class="p">;</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="cm">/* Custom allocation logic */</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">custom_allocate</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">,</span><span class="w"> </span><span class="n">ocflags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">OC_MFLAGS</span><span class="p">);</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="p">}</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">my_free</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">allocator_args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="cm">/* Custom free logic */</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">    </span><span class="n">custom_free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="p">}</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_alloc_args</span><span class="w"> </span><span class="n">alloc_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_create</span><span class="p">(</span><span class="s">&quot;mycache&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">nom_cache</span><span class="p">,</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">                        </span><span class="n">ctor</span><span class="p">,</span><span class="w"> </span><span class="n">dtor</span><span class="p">,</span><span class="w"> </span><span class="n">privdata</span><span class="p">,</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">                        </span><span class="n">my_alloc</span><span class="p">,</span><span class="w"> </span><span class="n">my_free</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">alloc_args</span><span class="p">);</span>
</code></pre></div>
<h3 id="objcache-statistics">Objcache Statistics<a class="headerlink" href="#objcache-statistics" title="Permanent link">&para;</a></h3>
<p>Statistics are accessible via <code>sysctl kern.objcache.stats</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">objcache_stats</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">oc_name</span><span class="p">[</span><span class="n">OBJCACHE_NAMELEN</span><span class="p">];</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">oc_limit</span><span class="p">;</span><span class="w">       </span><span class="cm">/* cluster_limit */</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">oc_requested</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Total get requests */</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">oc_allocated</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Backend allocations */</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">oc_exhausted</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Times limit was hit */</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">oc_failed</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Failed allocations */</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">oc_used</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Currently allocated */</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="w">    </span><span class="n">u_long</span><span class="w"> </span><span class="n">oc_cached</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Cached in magazines */</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Example usage</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>$<span class="w"> </span>sysctl<span class="w"> </span>kern.objcache.stats
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="c1"># Shows statistics for all objcaches</span>
</code></pre></div></p>
<h3 id="magazine-advantages">Magazine Advantages<a class="headerlink" href="#magazine-advantages" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Batch operations</strong>: Amortize depot lock acquisition over magazine capacity</li>
<li><strong>CPU cache affinity</strong>: Recently freed objects are hot in cache</li>
<li><strong>Reduced contention</strong>: Most operations are per-CPU lock-free</li>
<li><strong>Simple</strong>: No complex data structures, just object pointer arrays</li>
</ol>
<h3 id="when-to-use-objcache">When to Use Objcache<a class="headerlink" href="#when-to-use-objcache" title="Permanent link">&para;</a></h3>
<p><strong>Use objcache when</strong>:
- Allocating many same-sized objects
- High allocation/free frequency
- Constructor/destructor needed
- Want detailed statistics
- Need fine-grained limit control</p>
<p><strong>Use kmalloc_obj when</strong>:
- Fixed-size objects, simple lifecycle
- Want type stability (bulk free)
- Less overhead than objcache
- No constructor/destructor needed</p>
<p><strong>Use plain kmalloc when</strong>:
- Variable sizes
- Infrequent allocations
- No special lifecycle requirements</p>
<hr />
<h2 id="malloc-pipes-mpipe">Malloc Pipes (mpipe)<a class="headerlink" href="#malloc-pipes-mpipe" title="Permanent link">&para;</a></h2>
<p><strong>Location</strong>: <code>sys/kern/kern_mpipe.c</code></p>
<p>Malloc pipes provide <strong>pre-allocated object pools</strong> with automatic growth and callback support. They are primarily used for critical allocations that cannot fail, such as network packet buffers (mbufs).</p>
<h3 id="architecture_1">Architecture<a class="headerlink" href="#architecture_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>         Malloc Pipe (mpipe)         
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>  Free list (LIFO, cache-hot)        
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>   obj1  obj2  obj3  ...        
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>                                      
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>  Allocation token (atomic)          
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>   Lock-free fast path             
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>                                      
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>  Callback mechanism                  
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>   MPF_CALLBACK flag                
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>   Support thread (mpipe_thread)   
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>   Pending request queue            
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>                                      
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>  Constructor/deconstructor           
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>   Called on alloc/free             
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>                                      
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>  Statistics                          
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>   total, free, array size          
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>
</code></pre></div>
<h3 id="key-features">Key Features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Pre-allocated pool</strong>: Objects allocated at initialization</li>
<li><strong>Lock-free allocation</strong>: Uses atomic token instead of spinlock</li>
<li><strong>Callback support</strong>: Can queue requests when pool exhausted</li>
<li><strong>LIFO caching</strong>: Recently freed objects are cache-hot</li>
<li><strong>Constructor/deconstructor</strong>: Called on alloc/free for initialization</li>
<li><strong>Statistics</strong>: Track usage via sysctl</li>
</ol>
<h3 id="api">API<a class="headerlink" href="#api" title="Permanent link">&para;</a></h3>
<h4 id="creating-a-malloc-pipe">Creating a Malloc Pipe<a class="headerlink" href="#creating-a-malloc-pipe" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">mpipe_init</span><span class="p">(</span><span class="n">malloc_pipe_t</span><span class="w"> </span><span class="n">mpipe</span><span class="p">,</span><span class="w"> </span><span class="n">malloc_type_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">                </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nnom</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nmax</span><span class="p">,</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">mpflags</span><span class="p">,</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">construct</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">deconstruct</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="cm">/* Parameters:</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="cm"> * mpipe:      Pointer to malloc_pipe structure</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="cm"> * type:       Malloc type for accounting</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="cm"> * bytes:      Size of each object</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="cm"> * nnom:       Nominal number of objects (initial allocation)</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="cm"> * nmax:       Maximum number of objects (0 = unlimited)</span>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="cm"> * mpflags:    MPF_CALLBACK (enable callback support) | MPF_NOZERO (don&#39;t zero)</span>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="cm"> * construct:  Constructor called on allocation</span>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="cm"> * deconstruct: Deconstructor called on free</span>
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="cm"> * priv:       Private data passed to construct/deconstruct</span>
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="cm"> */</span>
</code></pre></div>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mpipe.h&gt;</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_pipe</span><span class="w"> </span><span class="n">my_pipe</span><span class="p">;</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">my_construct</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span><span class="cm">/* Initialize object fields */</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="n">o</span><span class="o">-&gt;</span><span class="n">magic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MY_MAGIC</span><span class="p">;</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="n">o</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="p">}</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="kt">void</span><span class="w"> </span><span class="nf">my_deconstruct</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">    </span><span class="cm">/* Clean up object before returning to pool */</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="w">    </span><span class="n">KASSERT</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;mpipe: object still referenced&quot;</span><span class="p">));</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="w">    </span><span class="n">o</span><span class="o">-&gt;</span><span class="n">magic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="p">}</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">init_my_subsystem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="w">    </span><span class="n">mpipe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_pipe</span><span class="p">,</span><span class="w"> </span><span class="n">M_MYSUBSYS</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="p">),</span>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="w">               </span><span class="mi">64</span><span class="p">,</span><span class="w">      </span><span class="cm">/* Start with 64 objects */</span>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="w">               </span><span class="mi">1024</span><span class="p">,</span><span class="w">    </span><span class="cm">/* Max 1024 objects */</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="w">               </span><span class="n">MPF_CALLBACK</span><span class="p">,</span><span class="w">  </span><span class="cm">/* Enable callback support */</span>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a><span class="w">               </span><span class="n">my_construct</span><span class="p">,</span><span class="w"> </span><span class="n">my_deconstruct</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="allocating-from-pipe">Allocating from Pipe<a class="headerlink" href="#allocating-from-pipe" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">mpipe_alloc_waitok</span><span class="p">(</span><span class="n">malloc_pipe_t</span><span class="w"> </span><span class="n">mpipe</span><span class="p">);</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">mpipe_alloc_nowait</span><span class="p">(</span><span class="n">malloc_pipe_t</span><span class="w"> </span><span class="n">mpipe</span><span class="p">);</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="cm">/* mpipe_alloc_waitok():</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="cm"> *  - Always succeeds (blocks if necessary)</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="cm"> *  - If pool exhausted and nmax not reached, grows pool</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="cm"> *  - If nmax reached and MPF_CALLBACK set, queues request</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="cm"> *  - Constructor called before returning</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="cm"> *</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="cm"> * mpipe_alloc_nowait():</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="cm"> *  - Returns NULL if pool exhausted</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="cm"> *  - Never blocks</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="cm"> *  - Constructor still called on success</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="cm"> */</span>
</code></pre></div>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="cm">/* In process context (can sleep) */</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpipe_alloc_waitok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_pipe</span><span class="p">);</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="cm">/* obj is never NULL */</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="cm">/* In interrupt context (cannot sleep) */</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpipe_alloc_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_pipe</span><span class="p">);</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">    </span><span class="cm">/* Handle allocation failure */</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="p">}</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="cm">/* Use object... */</span>
</code></pre></div></p>
<h4 id="freeing-to-pipe">Freeing to Pipe<a class="headerlink" href="#freeing-to-pipe" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">mpipe_free</span><span class="p">(</span><span class="n">malloc_pipe_t</span><span class="w"> </span><span class="n">mpipe</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="cm">/* Process:</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="cm"> * 1. Call deconstructor on obj</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="cm"> * 2. Return obj to pipe&#39;s free list (LIFO)</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="cm"> * 3. If MPF_CALLBACK and pending requests, wake support thread</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="cm"> */</span>
</code></pre></div>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="cm">/* Return object to pool */</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">mpipe_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_pipe</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="cm">/* obj is back in pool, ready for reuse */</span>
</code></pre></div></p>
<h4 id="destroying-a-malloc-pipe">Destroying a Malloc Pipe<a class="headerlink" href="#destroying-a-malloc-pipe" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">mpipe_done</span><span class="p">(</span><span class="n">malloc_pipe_t</span><span class="w"> </span><span class="n">mpipe</span><span class="p">);</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="cm">/* Cleans up malloc pipe:</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="cm"> * - Frees all objects in pool</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="cm"> * - Deallocates array memory</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="cm"> * - Asserts that all objects were returned (ary_count == total_count)</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="cm"> */</span>
</code></pre></div>
<h3 id="callback-mechanism">Callback Mechanism<a class="headerlink" href="#callback-mechanism" title="Permanent link">&para;</a></h3>
<p>When <code>MPF_CALLBACK</code> is set, the malloc pipe can handle allocation requests when the pool is exhausted:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>Allocation when pool empty and nmax reached:
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>  1. mpipe_alloc_waitok() called     
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>                                      
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>  2. Pool empty, nmax reached         
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>                                      
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>  3. Add to pending list              
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>     (mpipe-&gt;pending_list)            
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>                                      
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>  4. tsleep() on mpipe                
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>                                      
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>  ... waiting ...                     
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>                                      
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>  5. Another thread calls mpipe_free()
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>                                      
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>  6. mpipe_thread woken               
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>                                      
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>  7. Process pending requests         
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a>                                      
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a>  8. Original thread woken            
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>                                      
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a>  9. Allocation completes             
<a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a>
</code></pre></div>
<p><strong>mpipe_thread</strong> (<code>kern_mpipe.c:277</code>):
- Support thread for callback mechanism
- Processes <code>mpipe_pending_list</code>
- Wakes blocked allocators when objects become available
- Only runs when MPF_CALLBACK pipes exist</p>
<h3 id="internal-structure">Internal Structure<a class="headerlink" href="#internal-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_pipe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">    </span><span class="kt">void</span><span class="w">    </span><span class="o">**</span><span class="n">array</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Array of object pointers */</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">total_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Total objects allocated */</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">free_count</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Objects in array */</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">ary_count</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Array size */</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">max_count</span><span class="p">;</span><span class="w">         </span><span class="cm">/* nmax (0 = unlimited) */</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">nominal_count</span><span class="p">;</span><span class="w">     </span><span class="cm">/* nnom */</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">mpflags</span><span class="p">;</span><span class="w">           </span><span class="cm">/* MPF_* flags */</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">    </span><span class="kt">size_t</span><span class="w">  </span><span class="n">bytes</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Object size */</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">    </span><span class="n">malloc_type_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">        </span><span class="cm">/* For accounting */</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">token</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Atomic allocation token */</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="w">    </span><span class="kt">void</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">construct</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w">    </span><span class="kt">void</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">deconstruct</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w">    </span><span class="kt">void</span><span class="w">    </span><span class="o">*</span><span class="n">priv</span><span class="p">;</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="p">};</span>
</code></pre></div>
<h3 id="allocation-algorithm_1">Allocation Algorithm<a class="headerlink" href="#allocation-algorithm_1" title="Permanent link">&para;</a></h3>
<p><strong>Fast path</strong> (lock-free):
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mpipe_alloc_callback</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* kern_mpipe.c:103 */</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">    </span><span class="cm">/* 1. Try to get token atomically */</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token_test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">        </span><span class="cm">/* Someone else has token, slow path */</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">slow_path</span><span class="p">;</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">    </span><span class="cm">/* 2. We have token, check free list */</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="w">        </span><span class="cm">/* 3. Pop object from array (LIFO) */</span>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="w">        </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">[</span><span class="o">--</span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="p">];</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="w">        </span><span class="n">token_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">);</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="w">        </span><span class="cm">/* 4. Call constructor */</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">construct</span><span class="p">)</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="w">            </span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">construct</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="w">    </span><span class="cm">/* Pool empty, release token and go to slow path */</span>
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a><span class="w">    </span><span class="n">token_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpipe</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">);</span>
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a><span class="nl">slow_path</span><span class="p">:</span>
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a><span class="w">    </span><span class="cm">/* Acquire lock, check if need to grow pool... */</span>
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Slow path</strong> (with lock):
- Grow pool if <code>total_count &lt; max_count</code> (or <code>max_count == 0</code>)
- If cannot grow and <code>MPF_CALLBACK</code> set, queue request
- Otherwise block or return NULL</p>
<h3 id="statistics">Statistics<a class="headerlink" href="#statistics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="cm">/* Per-pipe statistics via mpipe structure */</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_pipe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">total_count</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Total objects ever allocated */</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">free_count</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Objects currently in pool */</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ary_count</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Size of array */</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="p">};</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="cm">/* Can be exposed via sysctl for monitoring */</span>
</code></pre></div>
<h3 id="usage-patterns">Usage Patterns<a class="headerlink" href="#usage-patterns" title="Permanent link">&para;</a></h3>
<p><strong>Network packet buffers (mbufs)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_pipe</span><span class="w"> </span><span class="n">mbuf_pipe</span><span class="p">;</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">mbuf_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">    </span><span class="n">mpipe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbuf_pipe</span><span class="p">,</span><span class="w"> </span><span class="n">M_MBUF</span><span class="p">,</span><span class="w"> </span><span class="n">MSIZE</span><span class="p">,</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">               </span><span class="mi">256</span><span class="p">,</span><span class="w">     </span><span class="cm">/* Start with 256 mbufs */</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">               </span><span class="mi">0</span><span class="p">,</span><span class="w">       </span><span class="cm">/* Unlimited */</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">               </span><span class="n">MPF_CALLBACK</span><span class="p">,</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">               </span><span class="n">mbuf_construct</span><span class="p">,</span><span class="w"> </span><span class="n">mbuf_deconstruct</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="p">}</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="k">struct</span><span class="w"> </span><span class="nc">mbuf</span><span class="w"> </span><span class="o">*</span><span class="n">m_get</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">how</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">how</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">)</span>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mpipe_alloc_waitok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbuf_pipe</span><span class="p">);</span>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mpipe_alloc_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbuf_pipe</span><span class="p">);</span>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="p">}</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="kt">void</span><span class="w"> </span><span class="n">m_free</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mbuf</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">    </span><span class="n">mpipe_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbuf_pipe</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Temporary objects with initialization</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_pipe</span><span class="w"> </span><span class="n">temp_pipe</span><span class="p">;</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">temp_construct</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">temp_obj</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">    </span><span class="n">spin_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tempobj&quot;</span><span class="p">);</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="n">TAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="p">}</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">temp_deconstruct</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">temp_obj</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">    </span><span class="n">spin_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">    </span><span class="n">KASSERT</span><span class="p">(</span><span class="n">TAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;temp_obj: list not empty&quot;</span><span class="p">));</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="when-to-use-malloc-pipes">When to Use Malloc Pipes<a class="headerlink" href="#when-to-use-malloc-pipes" title="Permanent link">&para;</a></h3>
<p><strong>Use mpipe when</strong>:
- Need guaranteed allocations (cannot fail)
- High allocation/free frequency
- Constructor/deconstructor required
- Want to pre-allocate and limit resource usage
- Need LIFO cache-hot behavior</p>
<p><strong>Use objcache when</strong>:
- Need detailed statistics and tuning
- Want dynamic magazine sizing
- More complex caching strategies</p>
<p><strong>Use kmalloc when</strong>:
- Simple allocations without special lifecycle
- Variable sizes</p>
<h3 id="advantages">Advantages<a class="headerlink" href="#advantages" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Pre-allocation</strong>: Amortize allocation cost at initialization</li>
<li><strong>Lock-free fast path</strong>: Uses atomic token, no spinlock contention</li>
<li><strong>Cache-hot</strong>: LIFO means recently freed objects are hot in CPU cache</li>
<li><strong>Simple</strong>: Straightforward LIFO array, easy to understand</li>
<li><strong>Callback mechanism</strong>: Handles exhaustion gracefully</li>
</ol>
<h3 id="limitations">Limitations<a class="headerlink" href="#limitations" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Fixed size</strong>: All objects same size</li>
<li><strong>Memory overhead</strong>: Pre-allocated objects consume memory even if unused</li>
<li><strong>Constructor overhead</strong>: Called on every allocation</li>
<li><strong>No depot</strong>: Unlike objcache, no sophisticated caching layers</li>
</ol>
<hr />
<h2 id="helper-allocators">Helper Allocators<a class="headerlink" href="#helper-allocators" title="Permanent link">&para;</a></h2>
<h3 id="alist-power-of-2-allocator">alist: Power-of-2 Allocator<a class="headerlink" href="#alist-power-of-2-allocator" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/kern/subr_alist.c</code></p>
<p>The <strong>alist</strong> allocator manages free blocks using a <strong>radix tree</strong> and supports only <strong>power-of-2 sized allocations</strong>. It can handle unlimited address space sizes.</p>
<p><strong>Key characteristics</strong>:
- <strong>Power-of-2 only</strong>: Can only allocate sizes that are powers of 2
- <strong>Power-of-2 aligned</strong>: Allocations aligned to their size
- <strong>Radix tree</strong>: Efficient O(log n) operations with hinting
- <strong>Unlimited size</strong>: No fixed maximum range
- <strong>Bitmap-based</strong>: Uses bitmaps in tree nodes</p>
<p><strong>Data structure</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">almeta</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bm_bighint</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Biggest allocatable block in subtree */</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">    </span><span class="n">u_daddr_t</span><span class="w">   </span><span class="n">bm_bitmap</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Bitmap of free blocks (power-of-2) */</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="p">}</span><span class="w"> </span><span class="n">almeta_t</span><span class="p">;</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">alist</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bl_radix</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Coverage of one meta element */</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bl_radix_mask</span><span class="p">;</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bl_radix_ext</span><span class="p">;</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bl_skip</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Starting skip (address offset) */</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bl_free</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Number of free blocks */</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bl_blocks</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Total blocks managed */</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="w">    </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">bl_bighint</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Biggest hint */</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="w">    </span><span class="n">almeta_t</span><span class="w">    </span><span class="o">*</span><span class="n">bl_root</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Root of radix tree */</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">alist_t</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>API</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">alist_t</span><span class="w"> </span><span class="nf">alist_create</span><span class="p">(</span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_type</span><span class="w"> </span><span class="o">*</span><span class="n">mtype</span><span class="p">);</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">alist_destroy</span><span class="p">(</span><span class="n">alist_t</span><span class="w"> </span><span class="n">live</span><span class="p">);</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">alist_free</span><span class="p">(</span><span class="n">alist_t</span><span class="w"> </span><span class="n">live</span><span class="p">,</span><span class="w"> </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">blkno</span><span class="p">,</span><span class="w"> </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="n">alist_blk_t</span><span class="w"> </span><span class="nf">alist_alloc</span><span class="p">(</span><span class="n">alist_t</span><span class="w"> </span><span class="n">live</span><span class="p">,</span><span class="w"> </span><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="cm">/* Create alist for 1GB range (2^30 bytes, 4KB blocks = 2^18 blocks) */</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="n">alist_t</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alist_create</span><span class="p">(</span><span class="mi">262144</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span><span class="w">  </span><span class="cm">/* 2^18 blocks */</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="cm">/* Allocate 16 blocks (must be power-of-2) */</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="n">alist_blk_t</span><span class="w"> </span><span class="n">blk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alist_alloc</span><span class="p">(</span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="cm">/* Free the blocks */</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="n">alist_free</span><span class="p">(</span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">blk</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="cm">/* Destroy */</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="n">alist_destroy</span><span class="p">(</span><span class="n">al</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Use case</strong>: Managing memory ranges that require power-of-2 alignment (e.g., DMA buffers, hardware resource allocation).</p>
<p><strong>Algorithm</strong> (<code>subr_alist.c:185</code>):
- Radix tree with 64-way fanout (ALIST_BMAP_RADIX = 64)
- Each meta node has bitmap and bighint
- Hinting accelerates allocation (bm_bighint)
- Power-of-2 check: <code>count &amp; (count - 1) == 0</code></p>
<hr />
<h3 id="blist-bitmap-block-allocator">blist: Bitmap Block Allocator<a class="headerlink" href="#blist-bitmap-block-allocator" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/kern/subr_blist.c</code></p>
<p>The <strong>blist</strong> allocator is a general-purpose <strong>bitmap allocator</strong> using a <strong>radix tree</strong>, primarily used for <strong>swap space allocation</strong>. Unlike alist, it supports arbitrary sizes and ranges.</p>
<p><strong>Key characteristics</strong>:
- <strong>General sizes</strong>: Allocate any number of blocks
- <strong>Arbitrary ranges</strong>: No power-of-2 restrictions
- <strong>Fixed maximum</strong>: Cannot exceed initial size
- <strong>Radix tree</strong>: Efficient with hinting
- <strong>Swap allocator</strong>: Primary use case</p>
<p><strong>Data structure</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">blmeta</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="w">    </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">bm_bighint</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Biggest allocatable run in subtree */</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="w">    </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">bm_bitmap</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Bitmap of free blocks */</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="p">}</span><span class="w"> </span><span class="n">blmeta_t</span><span class="p">;</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">blist</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">    </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">bl_blocks</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Total blocks managed */</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">bl_radix</span><span class="p">;</span><span class="w">     </span><span class="cm">/* Coverage of one meta element */</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">    </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">bl_skip</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Starting skip */</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">    </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">bl_free</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Number of free blocks */</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">    </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">bl_rootblks</span><span class="p">;</span><span class="w">  </span><span class="cm">/* daddr_t blks allocated for root */</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">    </span><span class="n">blmeta_t</span><span class="w"> </span><span class="o">*</span><span class="n">bl_root</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Root of radix tree */</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">blist_t</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>API</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">blist_t</span><span class="w"> </span><span class="nf">blist_create</span><span class="p">(</span><span class="n">daddr_t</span><span class="w"> </span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">blist_destroy</span><span class="p">(</span><span class="n">blist_t</span><span class="w"> </span><span class="n">blist</span><span class="p">);</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">daddr_t</span><span class="w"> </span><span class="nf">blist_alloc</span><span class="p">(</span><span class="n">blist_t</span><span class="w"> </span><span class="n">blist</span><span class="p">,</span><span class="w"> </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">blist_free</span><span class="p">(</span><span class="n">blist_t</span><span class="w"> </span><span class="n">blist</span><span class="p">,</span><span class="w"> </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">blkno</span><span class="p">,</span><span class="w"> </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">blist_resize</span><span class="p">(</span><span class="n">blist_t</span><span class="w"> </span><span class="o">*</span><span class="n">pblist</span><span class="p">,</span><span class="w"> </span><span class="n">daddr_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">freenew</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="cm">/* Create blist for swap: 10000 blocks */</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">blist_t</span><span class="w"> </span><span class="n">bl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blist_create</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="cm">/* Allocate 100 blocks (any size) */</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">daddr_t</span><span class="w"> </span><span class="n">blk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blist_alloc</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SWAPBLK_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="w">    </span><span class="cm">/* Allocation failed */</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="p">}</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="cm">/* Free the blocks */</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="n">blist_free</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="n">blk</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="cm">/* Destroy */</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="n">blist_destroy</span><span class="p">(</span><span class="n">bl</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Use case</strong>: Swap space management (<code>vm/swap_pager.c</code>).</p>
<p><strong>Algorithm</strong> (<code>subr_blist.c:276</code>):
- Radix tree with BLIST_BMAP_RADIX fanout (currently 64)
- Each meta has bitmap and bighint
- Cursor-based allocation for sequential patterns
- Supports resizing (grow or shrink)</p>
<p><strong>Differences from alist</strong>:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>alist</th>
<th>blist</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alignment</td>
<td>Power-of-2 only</td>
<td>Any</td>
</tr>
<tr>
<td>Sizes</td>
<td>Power-of-2 only</td>
<td>Any</td>
</tr>
<tr>
<td>Max range</td>
<td>Unlimited (dynamic)</td>
<td>Fixed at creation</td>
</tr>
<tr>
<td>Primary use</td>
<td>General power-of-2 ranges</td>
<td>Swap allocation</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="sbuf-string-buffers">sbuf: String Buffers<a class="headerlink" href="#sbuf-string-buffers" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/kern/subr_sbuf.c</code></p>
<p>The <strong>sbuf</strong> API provides <strong>dynamic string buffers</strong> with automatic growth, similar to C++ <code>std::string</code> or Java <code>StringBuilder</code>.</p>
<p><strong>Key features</strong>:
- <strong>Dynamic growth</strong>: Automatically expands as needed
- <strong>Safe</strong>: Bounds-checked operations
- <strong>Printf-style</strong>: <code>sbuf_printf()</code> for formatted output
- <strong>Fixed or auto</strong>: Can use fixed buffer or auto-allocate
- <strong>Length tracking</strong>: Always know current length</p>
<p><strong>Data structure</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="w">    </span><span class="kt">char</span><span class="w">    </span><span class="o">*</span><span class="n">s_buf</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Buffer itself */</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">s_size</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Size of buffer */</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">s_len</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Current length */</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">s_flags</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Flags (SBUF_*) */</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="p">};</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="cm">/* Flags */</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="cp">#define SBUF_FIXEDLEN   0x00000001  </span><span class="cm">/* Fixed length buffer */</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="cp">#define SBUF_AUTOEXTEND 0x00000002  </span><span class="cm">/* Auto-extend buffer */</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="cp">#define SBUF_OVERFLOWED 0x00000010  </span><span class="cm">/* Buffer overflowed */</span>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="cp">#define SBUF_FINISHED   0x00000020  </span><span class="cm">/* Buffer finalized */</span>
</code></pre></div></p>
<p><strong>API</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="cm">/* Create/destroy */</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">sbuf_new</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sbuf_delete</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="cm">/* Append operations */</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_cat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_printf</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_putc</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_bcpy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Copy */</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_bcat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Append */</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="cm">/* Finalize and extract */</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_finish</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span><span class="w">  </span><span class="cm">/* NUL-terminate */</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">sbuf_data</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_len</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sbuf_overflowed</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="cm">/* Clear */</span>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sbuf_clear</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Example - Auto-extending buffer</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">;</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="cm">/* Create auto-extending buffer */</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="n">sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbuf_new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">SBUF_AUTOEXTEND</span><span class="p">);</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="cm">/* Build string */</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="n">sbuf_printf</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Process %d: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">p_pid</span><span class="p">);</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="n">sbuf_cat</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">p_comm</span><span class="p">);</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="n">sbuf_printf</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; (%d threads)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">p_nthreads</span><span class="p">);</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="cm">/* Finalize */</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="n">sbuf_finish</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="cm">/* Use the string */</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sbuf_data</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="cm">/* Clean up */</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="n">sbuf_delete</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Example - Fixed buffer</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sbuf</span><span class="w"> </span><span class="n">sb</span><span class="p">;</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="cm">/* Use fixed buffer (no allocation) */</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="n">sbuf_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span><span class="w"> </span><span class="n">SBUF_FIXEDLEN</span><span class="p">);</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="n">sbuf_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CPU %d: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cpuid</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="n">sbuf_finish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">);</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sbuf_overflowed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Buffer too small!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sbuf_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">));</span>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="p">}</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="n">sbuf_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Does not free buffer, just cleans up */</span>
</code></pre></div></p>
<p><strong>Use cases</strong>:
- Building complex strings for sysctl output
- Generating debug messages
- Creating formatted data for userspace
- Any string building where final size is unknown</p>
<p><strong>Performance note</strong>: Auto-extending sbufs reallocate using <code>kmalloc()</code>, which may be expensive for frequently reallocated buffers. Pre-allocate reasonable size if known.</p>
<hr />
<h3 id="sglist-scatter-gather-lists">sglist: Scatter-Gather Lists<a class="headerlink" href="#sglist-scatter-gather-lists" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/kern/subr_sglist.c</code></p>
<p>The <strong>sglist</strong> API manages <strong>scatter-gather lists</strong> for DMA operations. It describes physically discontiguous memory regions as an array of <code>(address, length)</code> pairs.</p>
<p><strong>Key features</strong>:
- <strong>Physical addressing</strong>: Describes physical memory ranges
- <strong>DMA-friendly</strong>: Standard format for DMA engines
- <strong>Bounds tracking</strong>: Knows remaining space
- <strong>Utilities</strong>: Build from uio, mbufs, physical buffers</p>
<p><strong>Data structure</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sglist_seg</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="w">    </span><span class="n">vm_paddr_t</span><span class="w"> </span><span class="n">ss_paddr</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Physical address */</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">    </span><span class="kt">size_t</span><span class="w">     </span><span class="n">ss_len</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Length in bytes */</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="p">};</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist_seg</span><span class="w"> </span><span class="o">*</span><span class="n">sg_segs</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Array of segments */</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">    </span><span class="kt">int</span><span class="w">               </span><span class="n">sg_nseg</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Number of segments */</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">    </span><span class="kt">int</span><span class="w">               </span><span class="n">sg_maxseg</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Maximum segments */</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">    </span><span class="kt">int</span><span class="w">               </span><span class="n">sg_refs</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Reference count */</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="p">};</span>
</code></pre></div></p>
<p><strong>API</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="cm">/* Create/destroy */</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sglist_alloc</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">nsegs</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mflags</span><span class="p">);</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sglist_build</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mflags</span><span class="p">);</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sglist_free</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">);</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sglist_hold</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">);</span><span class="w">   </span><span class="cm">/* Increment refcount */</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sglist_release</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Decrement refcount */</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="cm">/* Reset for reuse */</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sglist_reset</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">);</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="cm">/* Append segments */</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sglist_append</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">vm_paddr_t</span><span class="w"> </span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sglist_append_mbuf</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mbuf</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">);</span>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sglist_append_phys</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">vm_paddr_t</span><span class="w"> </span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sglist_append_uio</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">uio</span><span class="w"> </span><span class="o">*</span><span class="n">uio</span><span class="p">);</span>
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a><span class="cm">/* Query */</span>
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sglist_count</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a><span class="kt">size_t</span><span class="w"> </span><span class="nf">sglist_length</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">);</span>
<a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sglist_slice</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">original</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">**</span><span class="n">slice</span><span class="p">,</span>
<a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a><span class="w">                 </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mflags</span><span class="p">);</span>
<a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a>
<a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a><span class="cm">/* Join two sglists */</span>
<a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sglist_join</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">second</span><span class="p">,</span>
<a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a><span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Example - Build sglist from buffer</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">8192</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">;</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="cm">/* Build sglist describing physical pages of buf */</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sglist_build</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">8192</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="cm">/* Program DMA engine with sglist */</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">sg_nseg</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">    </span><span class="n">dma_program_segment</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ss_paddr</span><span class="p">,</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">                       </span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ss_len</span><span class="p">);</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="p">}</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="cm">/* Clean up */</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="n">sglist_free</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Example - Build from mbuf chain</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">mbuf</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* ... received packet ... */</span><span class="p">;</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sglist</span><span class="w"> </span><span class="o">*</span><span class="n">sg</span><span class="p">;</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="cm">/* Allocate sglist with enough segments for mbuf chain */</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="kt">int</span><span class="w"> </span><span class="n">nsegs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* estimate based on m_length(m) and page size */</span><span class="p">;</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="n">sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sglist_alloc</span><span class="p">(</span><span class="n">nsegs</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="cm">/* Append mbuf chain to sglist */</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sglist_append_mbuf</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="w">    </span><span class="cm">/* Not enough segments */</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="w">    </span><span class="n">sglist_free</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EFBIG</span><span class="p">;</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="p">}</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="cm">/* Use sglist for DMA... */</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="n">sglist_free</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>Use cases</strong>:
- Network DMA (NIC drivers)
- Storage device DMA
- Any hardware requiring scatter-gather I/O
- Zero-copy transfers</p>
<p><strong>Implementation note</strong> (<code>subr_sglist.c:94</code>):
- <code>sglist_build()</code> walks virtual address using <code>pmap_extract()</code> to find physical pages
- Consecutive physical pages are coalesced into single segment
- <code>sglist_append_mbuf()</code> walks mbuf chain, extracting physical addresses</p>
<hr />
<h3 id="rbtree-red-black-tree-utilities">rbtree: Red-Black Tree Utilities<a class="headerlink" href="#rbtree-red-black-tree-utilities" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>sys/kern/subr_rbtree.c</code></p>
<p>The <strong>rbtree</strong> module provides <strong>red-black tree helper functions</strong>, but DragonFly uses a <strong>custom implementation</strong> that is largely self-contained in header files (<code>sys/sys/tree.h</code>).</p>
<p><strong>Note</strong>: This is not a full-featured allocator, but rather utilities for <strong>tree-based data structures</strong>. Most code uses the <code>RB_*</code> macros from <code>&lt;sys/tree.h&gt;</code> directly.</p>
<p><strong>Red-black tree properties</strong>:
1. Every node is red or black
2. Root is black
3. Leaves (NIL) are black
4. Red nodes have black children
5. All paths from node to leaves have same black-height</p>
<p><strong>sys/tree.h macros</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="cm">/* Define tree structure */</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="n">RB_HEAD</span><span class="p">(</span><span class="n">my_tree</span><span class="p">,</span><span class="w"> </span><span class="n">my_node</span><span class="p">);</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="cm">/* Define node structure */</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_node</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w">    </span><span class="n">RB_ENTRY</span><span class="p">(</span><span class="n">my_node</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="w">    </span><span class="cm">/* ... data ... */</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="p">};</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="cm">/* Generate tree functions */</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="n">RB_GENERATE</span><span class="p">(</span><span class="n">my_tree</span><span class="p">,</span><span class="w"> </span><span class="n">my_node</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">my_compare</span><span class="p">);</span>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="cm">/* Use tree */</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_tree</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RB_INITIALIZER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="n">RB_INSERT</span><span class="p">(</span><span class="n">my_tree</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a><span class="k">struct</span><span class="w"> </span><span class="nc">my_node</span><span class="w"> </span><span class="o">*</span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RB_FIND</span><span class="p">(</span><span class="n">my_tree</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lookup</span><span class="p">);</span>
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="n">RB_REMOVE</span><span class="p">(</span><span class="n">my_tree</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a>
<a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a><span class="cm">/* Iteration */</span>
<a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a><span class="n">RB_FOREACH</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">my_tree</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Use cases</strong>:
- Ordered key-value data structures
- Interval trees
- Priority queues with O(log n) operations</p>
<p><strong>Alternative</strong>: DragonFly also provides <code>&lt;sys/queue.h&gt;</code> for simpler lists/queues (TAILQ, LIST, SLIST, STAILQ).</p>
<hr />
<h2 id="code-flow-examples">Code Flow Examples<a class="headerlink" href="#code-flow-examples" title="Permanent link">&para;</a></h2>
<h3 id="example-1-simple-kmalloc-allocation">Example 1: Simple kmalloc Allocation<a class="headerlink" href="#example-1-simple-kmalloc-allocation" title="Permanent link">&para;</a></h3>
<p><strong>Scenario</strong>: Allocate memory for a temporary buffer in process context.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="p">;</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">    </span><span class="cm">/* Step 1: Call kmalloc */</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">    </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">M_ZERO</span><span class="p">);</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="w">    </span><span class="cm">/* M_WAITOK: Can block (process context)</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="cm">     * M_ZERO: Zero-fill the buffer</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="cm">     */</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="w">    </span><span class="cm">/* Step 2: kmalloc()  kern_slaballoc.c:kmalloc() */</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="w">    </span><span class="cm">/* - Round size to power-of-2 zone: 4096  zone 4096 */</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="w">    </span><span class="cm">/* Step 3: Get CPU-local zone structure */</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="w">    </span><span class="cm">/* - cpuid = mycpuid (no lock needed) */</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a><span class="w">    </span><span class="cm">/* - zone = &amp;SLZone[cpuid][zid] */</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a><span class="w">    </span><span class="cm">/* Step 4: Try to allocate from CPU-local zone */</span>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="w">    </span><span class="cm">/* - Check zone-&gt;z_NFree &gt; 0 */</span>
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a><span class="w">    </span><span class="cm">/* - Pop chunk from zone-&gt;z_FreeChunk */</span>
<a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a><span class="w">    </span><span class="cm">/* - Decrement zone-&gt;z_NFree */</span>
<a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a><span class="w">    </span><span class="cm">/* - If M_ZERO, bzero() the buffer */</span>
<a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a>
<a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a><span class="w">    </span><span class="cm">/* Step 5: Return buffer to caller */</span>
<a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a>
<a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a><span class="w">    </span><span class="cm">/* Use buffer... */</span>
<a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a><span class="w">    </span><span class="n">bcopy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a>
<a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a><span class="w">    </span><span class="cm">/* Step 6: Free buffer */</span>
<a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a><span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a>
<a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a><span class="w">    </span><span class="cm">/* Step 7: kfree()  kern_slaballoc.c:kfree() */</span>
<a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a><span class="w">    </span><span class="cm">/* - Find zone based on pointer address */</span>
<a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a><span class="w">    </span><span class="cm">/* - Determine owning CPU from chunk metadata */</span>
<a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a><span class="w">    </span><span class="cm">/* - If local CPU: add to z_FreeChunk (fast) */</span>
<a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a><span class="w">    </span><span class="cm">/* - If remote CPU: add to z_ReleaseChunk and send IPI */</span>
<a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Flow diagram</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>kmalloc(4096, M_TEMP, M_WAITOK|M_ZERO)
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>  
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>Find zone: zid = 12 (4KB zone)
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>  
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>Get CPU-local zone: cpuid=2, zone=&amp;SLZone[2][12]
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>  
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>zone-&gt;z_NFree = 5 (chunks available)
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>  
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>Pop chunk from z_FreeChunk list
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>  
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>z_NFree = 4
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>  
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>bzero(chunk, 4096)   M_ZERO flag
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>  
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>Return chunk to caller
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>  
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>... use memory ...
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>  
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>kfree(chunk, M_TEMP)
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>  
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>Find owning CPU: cpuid=2 (local)
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>  
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>Add chunk to z_FreeChunk (LIFO)
<a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a>  
<a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a>z_NFree = 5
</code></pre></div></p>
<hr />
<h3 id="example-2-cross-cpu-free-with-ipi">Example 2: Cross-CPU Free with IPI<a class="headerlink" href="#example-2-cross-cpu-free-with-ipi" title="Permanent link">&para;</a></h3>
<p><strong>Scenario</strong>: Thread on CPU 0 frees memory allocated by thread on CPU 2.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="cm">/* Thread on CPU 2 allocates */</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="cm">/* Allocated from SLZone[2][zone_512] */</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="cm">/* Pass buf to thread on CPU 0 (via queue, etc.) */</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="cm">/* Thread on CPU 0 frees */</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="cm">/* Step 1: kfree() determines owning CPU from chunk */</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="cm">/* - Chunk metadata indicates CPU 2 */</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="cm">/* Step 2: Current CPU (0) != owning CPU (2) */</span>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="cm">/* - Cannot directly modify CPU 2&#39;s zone */</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="cm">/* Step 3: Add to remote CPU&#39;s release list */</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="cm">/* - zone-&gt;z_ReleaseChunk (uses lock) */</span>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="cm">/* - Add chunk to linked list */</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="cm">/* Step 4: Send IPI to CPU 2 */</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="cm">/* - lwkt_send_ipiq(2, ...) */</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="cm">/* Step 5: CPU 2 receives IPI */</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="cm">/* - Interrupt handler runs on CPU 2 */</span>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a>
<a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="cm">/* Step 6: Process release list */</span>
<a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a><span class="cm">/* - Move chunks from z_ReleaseChunk to z_FreeChunk */</span>
<a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a><span class="cm">/* - Update z_NFree */</span>
<a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a><span class="cm">/* - Chunks now available for allocation on CPU 2 */</span>
</code></pre></div>
<p><strong>Flow diagram</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>CPU 2: kmalloc(512)
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>  
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>Allocate from SLZone[2][zone_512]
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>  
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>Return chunk (metadata: owner=CPU2)
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>  
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>... pass to CPU 0 ...
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>  
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>CPU 0: kfree(chunk)
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>  
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>Check owner: CPU 2 (remote!)
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>  
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>Acquire zone-&gt;z_ReleaseChunk lock
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a>  
<a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>Add chunk to z_ReleaseChunk list
<a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a>  
<a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>Release lock
<a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a>  
<a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>Send IPI to CPU 2
<a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a>  
<a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a>
<a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a>CPU 2: IPI arrives
<a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a>  
<a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a>slgd_alloc() or periodic check
<a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a>  
<a id="__codelineno-70-26" name="__codelineno-70-26" href="#__codelineno-70-26"></a>Process z_ReleaseChunk list
<a id="__codelineno-70-27" name="__codelineno-70-27" href="#__codelineno-70-27"></a>  
<a id="__codelineno-70-28" name="__codelineno-70-28" href="#__codelineno-70-28"></a>Move chunks to z_FreeChunk
<a id="__codelineno-70-29" name="__codelineno-70-29" href="#__codelineno-70-29"></a>  
<a id="__codelineno-70-30" name="__codelineno-70-30" href="#__codelineno-70-30"></a>z_NFree += count
<a id="__codelineno-70-31" name="__codelineno-70-31" href="#__codelineno-70-31"></a>  
<a id="__codelineno-70-32" name="__codelineno-70-32" href="#__codelineno-70-32"></a>Chunks available for reuse on CPU 2
</code></pre></div></p>
<p><strong>Why IPIs?</strong>
- Maintain per-CPU zone invariants
- Avoid lock contention on allocation (fast path)
- Memory eventually returns to owning CPU's pool
- Trade-off: Occasional IPI cost vs. lock-free allocation</p>
<hr />
<h3 id="example-3-type-stable-object-allocation">Example 3: Type-Stable Object Allocation<a class="headerlink" href="#example-3-type-stable-object-allocation" title="Permanent link">&para;</a></h3>
<p><strong>Scenario</strong>: VFS allocating vnodes with type stability.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="cm">/* Initialize malloc type for vnodes */</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="n">MALLOC_DEFINE</span><span class="p">(</span><span class="n">M_VNODE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vnodes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vnodes&quot;</span><span class="p">);</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vnode_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">    </span><span class="cm">/* Create type for vnodes */</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">    </span><span class="n">kmalloc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">M_VNODE</span><span class="p">);</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="p">}</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vnode_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">;</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="w">    </span><span class="cm">/* Step 1: Allocate from type-stable allocator */</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="w">    </span><span class="n">vp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_obj</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="p">),</span><span class="w"> </span><span class="n">M_VNODE</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="o">|</span><span class="n">M_ZERO</span><span class="p">);</span>
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>
<a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="w">    </span><span class="cm">/* Step 2: kmalloc_obj() flow */</span>
<a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a><span class="w">    </span><span class="cm">/* - Get per-CPU active slab (objcache-&gt;slabdata[cpuid].active) */</span>
<a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a><span class="w">    </span><span class="cm">/* - Check active-&gt;findex &lt; KMALLOC_SLAB_FOBJS */</span>
<a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a><span class="w">    </span><span class="cm">/* - Pop object from fobjs[] circular buffer */</span>
<a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a><span class="w">    </span><span class="cm">/* - If active slab exhausted, get new slab from partial list */</span>
<a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>
<a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a><span class="w">    </span><span class="cm">/* Step 3: Initialize vnode */</span>
<a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a><span class="w">    </span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VNON</span><span class="p">;</span>
<a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a><span class="w">    </span><span class="n">lockinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_lock</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vnode&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">LK_CANRECURSE</span><span class="p">);</span>
<a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a><span class="w">    </span><span class="n">TAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_namecache</span><span class="p">);</span>
<a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a>
<a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vp</span><span class="p">;</span>
<a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a><span class="p">}</span>
<a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a>
<a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a><span class="kt">void</span><span class="w"> </span><span class="n">vnode_free</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="w">    </span><span class="cm">/* Clean up */</span>
<a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a><span class="w">    </span><span class="n">lockuninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">v_lock</span><span class="p">);</span>
<a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a>
<a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a><span class="w">    </span><span class="cm">/* Step 1: Free to type-stable allocator */</span>
<a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a><span class="w">    </span><span class="n">kfree_obj</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">M_VNODE</span><span class="p">);</span>
<a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a>
<a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a><span class="w">    </span><span class="cm">/* Step 2: kfree_obj() flow */</span>
<a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a><span class="w">    </span><span class="cm">/* - Find slab from object address */</span>
<a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a><span class="w">    </span><span class="cm">/* - Get per-CPU active slab */</span>
<a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a><span class="w">    </span><span class="cm">/* - Add object to fobjs[] circular buffer */</span>
<a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a><span class="w">    </span><span class="cm">/* - Update slab-&gt;findex atomically */</span>
<a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a><span class="w">    </span><span class="cm">/* - Object remains in slab, not returned to system */</span>
<a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a><span class="p">}</span>
<a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a>
<a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a><span class="kt">void</span><span class="w"> </span><span class="n">vnode_unmount_all</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a><span class="w">    </span><span class="cm">/* On unmount: bulk destroy all vnodes for this mount */</span>
<a id="__codelineno-71-46" name="__codelineno-71-46" href="#__codelineno-71-46"></a>
<a id="__codelineno-71-47" name="__codelineno-71-47" href="#__codelineno-71-47"></a><span class="w">    </span><span class="cm">/* Step 1: Walk vnode list, free each */</span>
<a id="__codelineno-71-48" name="__codelineno-71-48" href="#__codelineno-71-48"></a><span class="w">    </span><span class="n">TAILQ_FOREACH</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mnt_vnodelist</span><span class="p">,</span><span class="w"> </span><span class="n">v_mntvnodes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-49" name="__codelineno-71-49" href="#__codelineno-71-49"></a><span class="w">        </span><span class="n">kfree_obj</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">M_VNODE</span><span class="p">);</span>
<a id="__codelineno-71-50" name="__codelineno-71-50" href="#__codelineno-71-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-51" name="__codelineno-71-51" href="#__codelineno-71-51"></a>
<a id="__codelineno-71-52" name="__codelineno-71-52" href="#__codelineno-71-52"></a><span class="w">    </span><span class="cm">/* Step 2: Type-stable allocator can now bulk-free slabs */</span>
<a id="__codelineno-71-53" name="__codelineno-71-53" href="#__codelineno-71-53"></a><span class="w">    </span><span class="cm">/* - All vnodes for mount are freed */</span>
<a id="__codelineno-71-54" name="__codelineno-71-54" href="#__codelineno-71-54"></a><span class="w">    </span><span class="cm">/* - Entire slabs may be empty */</span>
<a id="__codelineno-71-55" name="__codelineno-71-55" href="#__codelineno-71-55"></a><span class="w">    </span><span class="cm">/* - kmalloc_obj can return slabs to system */</span>
<a id="__codelineno-71-56" name="__codelineno-71-56" href="#__codelineno-71-56"></a>
<a id="__codelineno-71-57" name="__codelineno-71-57" href="#__codelineno-71-57"></a><span class="w">    </span><span class="cm">/* Advantage: Type stability allows efficient bulk operations */</span>
<a id="__codelineno-71-58" name="__codelineno-71-58" href="#__codelineno-71-58"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Slab allocation flow</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>kmalloc_obj(sizeof(struct vnode), M_VNODE, ...)
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>  
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>Get per-CPU objcache: &amp;objcache[mycpuid]
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>  
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>Get active slab: objcache-&gt;slabdata[mycpuid].active
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>  
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>Active slab has free objects? (findex &lt; KMALLOC_SLAB_FOBJS)
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>   YES
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>Pop object: obj = active-&gt;fobjs[findex++]
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>  
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>Return object
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>  
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>... use vnode ...
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>  
<a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>kfree_obj(vnode, M_VNODE)
<a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a>  
<a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>Find slab from object address
<a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>  
<a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>Get per-CPU active slab
<a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>  
<a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a>Add to circular buffer: active-&gt;fobjs[findex++] = obj
<a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a>  
<a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a>Object back in pool (type-stable: not freed to system)
</code></pre></div></p>
<hr />
<h3 id="example-4-objcache-magazine-exchange">Example 4: Objcache Magazine Exchange<a class="headerlink" href="#example-4-objcache-magazine-exchange" title="Permanent link">&para;</a></h3>
<p><strong>Scenario</strong>: High-frequency allocation from objcache.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="cm">/* Create objcache for connection objects */</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">objcache</span><span class="w"> </span><span class="o">*</span><span class="n">conn_cache</span><span class="p">;</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">conn_construct</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">connection</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="w">    </span><span class="n">bzero</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">conn</span><span class="p">));</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="w">    </span><span class="n">TAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">);</span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="p">}</span>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">conn_destruct</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">connection</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a><span class="w">    </span><span class="n">KASSERT</span><span class="p">(</span><span class="n">TAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;conn: queue not empty&quot;</span><span class="p">));</span>
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="p">}</span>
<a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>
<a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a><span class="kt">void</span><span class="w"> </span><span class="nf">conn_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a><span class="w">    </span><span class="n">conn_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_create</span><span class="p">(</span><span class="s">&quot;connections&quot;</span><span class="p">,</span>
<a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a><span class="w">                                 </span><span class="mi">1000</span><span class="p">,</span><span class="w">  </span><span class="cm">/* cluster_limit */</span>
<a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a><span class="w">                                 </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="cm">/* nom_cache (auto) */</span>
<a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a><span class="w">                                 </span><span class="n">conn_construct</span><span class="p">,</span><span class="w"> </span><span class="n">conn_destruct</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a><span class="w">                                 </span><span class="n">objcache_malloc_alloc</span><span class="p">,</span>
<a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a><span class="w">                                 </span><span class="n">objcache_malloc_free</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a><span class="p">}</span>
<a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a>
<a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a><span class="k">struct</span><span class="w"> </span><span class="nc">connection</span><span class="w"> </span><span class="o">*</span><span class="n">conn_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a><span class="w">    </span><span class="cm">/* Step 1: Call objcache_get() */</span>
<a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">objcache_get</span><span class="p">(</span><span class="n">conn_cache</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a><span class="p">}</span>
<a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a>
<a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a><span class="cm">/* objcache_get() flow - Fast path */</span>
<a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">objcache_get_fast_path</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">objcache</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">objcache_cpu</span><span class="w"> </span><span class="o">*</span><span class="n">cpudata</span><span class="p">;</span>
<a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazine</span><span class="w"> </span><span class="o">*</span><span class="n">mag</span><span class="p">;</span>
<a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a>
<a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a><span class="w">    </span><span class="cm">/* Step 1: Get per-CPU data (lock-free) */</span>
<a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a><span class="w">    </span><span class="n">cpudata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">mycpuid</span><span class="p">];</span>
<a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a>
<a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a><span class="w">    </span><span class="cm">/* Step 2: Get loaded magazine */</span>
<a id="__codelineno-73-39" name="__codelineno-73-39" href="#__codelineno-73-39"></a><span class="w">    </span><span class="n">mag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">loaded_mag</span><span class="p">;</span>
<a id="__codelineno-73-40" name="__codelineno-73-40" href="#__codelineno-73-40"></a>
<a id="__codelineno-73-41" name="__codelineno-73-41" href="#__codelineno-73-41"></a><span class="w">    </span><span class="cm">/* Step 3: Check if magazine has objects */</span>
<a id="__codelineno-73-42" name="__codelineno-73-42" href="#__codelineno-73-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-43" name="__codelineno-73-43" href="#__codelineno-73-43"></a><span class="w">        </span><span class="cm">/* Step 4: Pop object from magazine (lock-free) */</span>
<a id="__codelineno-73-44" name="__codelineno-73-44" href="#__codelineno-73-44"></a><span class="w">        </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mag</span><span class="o">-&gt;</span><span class="n">objects</span><span class="p">[</span><span class="o">--</span><span class="n">mag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="p">];</span>
<a id="__codelineno-73-45" name="__codelineno-73-45" href="#__codelineno-73-45"></a>
<a id="__codelineno-73-46" name="__codelineno-73-46" href="#__codelineno-73-46"></a><span class="w">        </span><span class="cm">/* Step 5: Return object (constructor already called) */</span>
<a id="__codelineno-73-47" name="__codelineno-73-47" href="#__codelineno-73-47"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-73-48" name="__codelineno-73-48" href="#__codelineno-73-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-73-49" name="__codelineno-73-49" href="#__codelineno-73-49"></a>
<a id="__codelineno-73-50" name="__codelineno-73-50" href="#__codelineno-73-50"></a><span class="w">    </span><span class="cm">/* Magazine empty, go to slow path */</span>
<a id="__codelineno-73-51" name="__codelineno-73-51" href="#__codelineno-73-51"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">objcache_get_slow_path</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span>
<a id="__codelineno-73-52" name="__codelineno-73-52" href="#__codelineno-73-52"></a><span class="p">}</span>
<a id="__codelineno-73-53" name="__codelineno-73-53" href="#__codelineno-73-53"></a>
<a id="__codelineno-73-54" name="__codelineno-73-54" href="#__codelineno-73-54"></a><span class="cm">/* objcache_get() flow - Slow path (magazine empty) */</span>
<a id="__codelineno-73-55" name="__codelineno-73-55" href="#__codelineno-73-55"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">objcache_get_slow_path</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">objcache</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-56" name="__codelineno-73-56" href="#__codelineno-73-56"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">objcache_cpu</span><span class="w"> </span><span class="o">*</span><span class="n">cpudata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">mycpuid</span><span class="p">];</span>
<a id="__codelineno-73-57" name="__codelineno-73-57" href="#__codelineno-73-57"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazine</span><span class="w"> </span><span class="o">*</span><span class="n">empty_mag</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">full_mag</span><span class="p">;</span>
<a id="__codelineno-73-58" name="__codelineno-73-58" href="#__codelineno-73-58"></a>
<a id="__codelineno-73-59" name="__codelineno-73-59" href="#__codelineno-73-59"></a><span class="w">    </span><span class="cm">/* Step 1: Loaded magazine is empty */</span>
<a id="__codelineno-73-60" name="__codelineno-73-60" href="#__codelineno-73-60"></a><span class="w">    </span><span class="n">empty_mag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">loaded_mag</span><span class="p">;</span>
<a id="__codelineno-73-61" name="__codelineno-73-61" href="#__codelineno-73-61"></a>
<a id="__codelineno-73-62" name="__codelineno-73-62" href="#__codelineno-73-62"></a><span class="w">    </span><span class="cm">/* Step 2: Check previous magazine */</span>
<a id="__codelineno-73-63" name="__codelineno-73-63" href="#__codelineno-73-63"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">previous_mag</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">previous_mag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-64" name="__codelineno-73-64" href="#__codelineno-73-64"></a><span class="w">        </span><span class="cm">/* Step 3: Swap loaded &lt;-&gt; previous */</span>
<a id="__codelineno-73-65" name="__codelineno-73-65" href="#__codelineno-73-65"></a><span class="w">        </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">loaded_mag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">previous_mag</span><span class="p">;</span>
<a id="__codelineno-73-66" name="__codelineno-73-66" href="#__codelineno-73-66"></a><span class="w">        </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">previous_mag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">empty_mag</span><span class="p">;</span>
<a id="__codelineno-73-67" name="__codelineno-73-67" href="#__codelineno-73-67"></a>
<a id="__codelineno-73-68" name="__codelineno-73-68" href="#__codelineno-73-68"></a><span class="w">        </span><span class="cm">/* Step 4: Pop from newly loaded magazine */</span>
<a id="__codelineno-73-69" name="__codelineno-73-69" href="#__codelineno-73-69"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">magazine</span><span class="w"> </span><span class="o">*</span><span class="n">mag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">loaded_mag</span><span class="p">;</span>
<a id="__codelineno-73-70" name="__codelineno-73-70" href="#__codelineno-73-70"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mag</span><span class="o">-&gt;</span><span class="n">objects</span><span class="p">[</span><span class="o">--</span><span class="n">mag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="p">];</span>
<a id="__codelineno-73-71" name="__codelineno-73-71" href="#__codelineno-73-71"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-73-72" name="__codelineno-73-72" href="#__codelineno-73-72"></a>
<a id="__codelineno-73-73" name="__codelineno-73-73" href="#__codelineno-73-73"></a><span class="w">    </span><span class="cm">/* Step 5: Both magazines empty, need to get from depot */</span>
<a id="__codelineno-73-74" name="__codelineno-73-74" href="#__codelineno-73-74"></a><span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_lock</span><span class="p">);</span>
<a id="__codelineno-73-75" name="__codelineno-73-75" href="#__codelineno-73-75"></a>
<a id="__codelineno-73-76" name="__codelineno-73-76" href="#__codelineno-73-76"></a><span class="w">    </span><span class="cm">/* Step 6: Check depot for full magazine */</span>
<a id="__codelineno-73-77" name="__codelineno-73-77" href="#__codelineno-73-77"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SLIST_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_full</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-73-78" name="__codelineno-73-78" href="#__codelineno-73-78"></a><span class="w">        </span><span class="n">full_mag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_full</span><span class="p">);</span>
<a id="__codelineno-73-79" name="__codelineno-73-79" href="#__codelineno-73-79"></a><span class="w">        </span><span class="n">SLIST_REMOVE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_full</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">);</span>
<a id="__codelineno-73-80" name="__codelineno-73-80" href="#__codelineno-73-80"></a><span class="w">        </span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_full_count</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-73-81" name="__codelineno-73-81" href="#__codelineno-73-81"></a>
<a id="__codelineno-73-82" name="__codelineno-73-82" href="#__codelineno-73-82"></a><span class="w">        </span><span class="cm">/* Step 7: Return empty magazine to depot */</span>
<a id="__codelineno-73-83" name="__codelineno-73-83" href="#__codelineno-73-83"></a><span class="w">        </span><span class="n">SLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_empty</span><span class="p">,</span><span class="w"> </span><span class="n">empty_mag</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">);</span>
<a id="__codelineno-73-84" name="__codelineno-73-84" href="#__codelineno-73-84"></a><span class="w">        </span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_empty_count</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-73-85" name="__codelineno-73-85" href="#__codelineno-73-85"></a>
<a id="__codelineno-73-86" name="__codelineno-73-86" href="#__codelineno-73-86"></a><span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_lock</span><span class="p">);</span>
<a id="__codelineno-73-87" name="__codelineno-73-87" href="#__codelineno-73-87"></a>
<a id="__codelineno-73-88" name="__codelineno-73-88" href="#__codelineno-73-88"></a><span class="w">        </span><span class="cm">/* Step 8: Install full magazine as loaded */</span>
<a id="__codelineno-73-89" name="__codelineno-73-89" href="#__codelineno-73-89"></a><span class="w">        </span><span class="n">cpudata</span><span class="o">-&gt;</span><span class="n">loaded_mag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full_mag</span><span class="p">;</span>
<a id="__codelineno-73-90" name="__codelineno-73-90" href="#__codelineno-73-90"></a>
<a id="__codelineno-73-91" name="__codelineno-73-91" href="#__codelineno-73-91"></a><span class="w">        </span><span class="cm">/* Step 9: Pop object */</span>
<a id="__codelineno-73-92" name="__codelineno-73-92" href="#__codelineno-73-92"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">full_mag</span><span class="o">-&gt;</span><span class="n">objects</span><span class="p">[</span><span class="o">--</span><span class="n">full_mag</span><span class="o">-&gt;</span><span class="n">rounds</span><span class="p">];</span>
<a id="__codelineno-73-93" name="__codelineno-73-93" href="#__codelineno-73-93"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-73-94" name="__codelineno-73-94" href="#__codelineno-73-94"></a>
<a id="__codelineno-73-95" name="__codelineno-73-95" href="#__codelineno-73-95"></a><span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">depot_lock</span><span class="p">);</span>
<a id="__codelineno-73-96" name="__codelineno-73-96" href="#__codelineno-73-96"></a>
<a id="__codelineno-73-97" name="__codelineno-73-97" href="#__codelineno-73-97"></a><span class="w">    </span><span class="cm">/* Step 10: Depot empty, allocate from backend */</span>
<a id="__codelineno-73-98" name="__codelineno-73-98" href="#__codelineno-73-98"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">allocator_args</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-73-99" name="__codelineno-73-99" href="#__codelineno-73-99"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Magazine exchange diagram</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>objcache_get()
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>  
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>Check loaded magazine: rounds = 0 (empty)
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>  
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>Check previous magazine: rounds = 16 (full)
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>  
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>Swap loaded  previous (lock-free)
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>  
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>Pop from loaded: obj = loaded-&gt;objects[15]
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>  
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>loaded-&gt;rounds = 15
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>  
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>Return object
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a>  
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>... 15 more fast allocations from loaded ...
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a>  
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>Both magazines empty
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a>  
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a>Acquire depot_lock
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a>  
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>Check depot_full list: has magazines
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a>  
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a>Pop full magazine from depot
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a>  
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a>Push empty magazine to depot
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a>  
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a>Release depot_lock
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a>  
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a>Install full magazine as loaded
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a>  
<a id="__codelineno-74-31" name="__codelineno-74-31" href="#__codelineno-74-31"></a>Pop object from new loaded magazine
</code></pre></div></p>
<p><strong>Key insight</strong>: Most allocations are <strong>lock-free</strong> from per-CPU magazines. Only when magazines are exhausted do we acquire the depot lock.</p>
<hr />
<h3 id="example-5-zone-recycling-and-hysteresis">Example 5: Zone Recycling and Hysteresis<a class="headerlink" href="#example-5-zone-recycling-and-hysteresis" title="Permanent link">&para;</a></h3>
<p><strong>Scenario</strong>: System with low memory pressure triggers zone recycling.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="cm">/* Slab allocator monitors zone usage via:</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="cm"> * - ZGlobalZone[zid].ZoneRelsThresh (hysteresis threshold)</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="cm"> * - zone-&gt;z_NFree (free chunks in zone)</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="cm"> * - zone-&gt;z_NMax (maximum free chunks before recycling)</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="cm"> */</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="cm">/* Allocation increases zone pressure */</span>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">allocation_surge</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="w">        </span><span class="cm">/* ... use p ... */</span>
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="w">    </span><span class="cm">/* Many zones now have high z_NFree (lots of free chunks cached) */</span>
<a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a><span class="p">}</span>
<a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>
<a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a><span class="cm">/* Periodic zone cleanup (kern_slaballoc.c:slab_cleanup()) */</span>
<a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a><span class="kt">void</span><span class="w"> </span><span class="nf">slab_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a><span class="w">    </span><span class="cm">/* Called periodically (every few seconds) */</span>
<a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a>
<a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">zid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">zid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nzones</span><span class="p">;</span><span class="w"> </span><span class="n">zid</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a><span class="w">        </span><span class="n">SLGlobalZone</span><span class="w"> </span><span class="o">*</span><span class="n">zglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ZGlobalZone</span><span class="p">[</span><span class="n">zid</span><span class="p">];</span>
<a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a>
<a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a><span class="w">        </span><span class="cm">/* Step 1: Calculate zone release threshold */</span>
<a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a><span class="w">        </span><span class="cm">/* Based on:</span>
<a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a><span class="cm">         * - Total zone memory</span>
<a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a><span class="cm">         * - System memory pressure</span>
<a id="__codelineno-75-27" name="__codelineno-75-27" href="#__codelineno-75-27"></a><span class="cm">         * - Hysteresis to avoid thrashing</span>
<a id="__codelineno-75-28" name="__codelineno-75-28" href="#__codelineno-75-28"></a><span class="cm">         */</span>
<a id="__codelineno-75-29" name="__codelineno-75-29" href="#__codelineno-75-29"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">thresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zglobal</span><span class="o">-&gt;</span><span class="n">ZoneRelsThresh</span><span class="p">;</span>
<a id="__codelineno-75-30" name="__codelineno-75-30" href="#__codelineno-75-30"></a>
<a id="__codelineno-75-31" name="__codelineno-75-31" href="#__codelineno-75-31"></a><span class="w">        </span><span class="cm">/* Step 2: Check each CPU&#39;s zone */</span>
<a id="__codelineno-75-32" name="__codelineno-75-32" href="#__codelineno-75-32"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpuid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncpus</span><span class="p">;</span><span class="w"> </span><span class="n">cpuid</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-33" name="__codelineno-75-33" href="#__codelineno-75-33"></a><span class="w">            </span><span class="n">SLZone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SLZone</span><span class="p">[</span><span class="n">cpuid</span><span class="p">][</span><span class="n">zid</span><span class="p">];</span>
<a id="__codelineno-75-34" name="__codelineno-75-34" href="#__codelineno-75-34"></a>
<a id="__codelineno-75-35" name="__codelineno-75-35" href="#__codelineno-75-35"></a><span class="w">            </span><span class="cm">/* Step 3: Exceeds threshold? */</span>
<a id="__codelineno-75-36" name="__codelineno-75-36" href="#__codelineno-75-36"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">z_NFree</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">thresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-37" name="__codelineno-75-37" href="#__codelineno-75-37"></a><span class="w">                </span><span class="cm">/* Step 4: Recycle excess chunks */</span>
<a id="__codelineno-75-38" name="__codelineno-75-38" href="#__codelineno-75-38"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">excess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">z_NFree</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">thresh</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-75-39" name="__codelineno-75-39" href="#__codelineno-75-39"></a>
<a id="__codelineno-75-40" name="__codelineno-75-40" href="#__codelineno-75-40"></a><span class="w">                </span><span class="cm">/* Step 5: Free excess chunks back to system */</span>
<a id="__codelineno-75-41" name="__codelineno-75-41" href="#__codelineno-75-41"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">excess</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-75-42" name="__codelineno-75-42" href="#__codelineno-75-42"></a><span class="w">                    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">z_FreeChunk</span><span class="p">;</span>
<a id="__codelineno-75-43" name="__codelineno-75-43" href="#__codelineno-75-43"></a><span class="w">                    </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">z_FreeChunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">chunk</span><span class="p">;</span>
<a id="__codelineno-75-44" name="__codelineno-75-44" href="#__codelineno-75-44"></a><span class="w">                    </span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">z_NFree</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-75-45" name="__codelineno-75-45" href="#__codelineno-75-45"></a>
<a id="__codelineno-75-46" name="__codelineno-75-46" href="#__codelineno-75-46"></a><span class="w">                    </span><span class="cm">/* Step 6: Return page to VM system */</span>
<a id="__codelineno-75-47" name="__codelineno-75-47" href="#__codelineno-75-47"></a><span class="w">                    </span><span class="n">kfree_real</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span><span class="w">  </span><span class="cm">/*  vm_page_free() */</span>
<a id="__codelineno-75-48" name="__codelineno-75-48" href="#__codelineno-75-48"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-75-49" name="__codelineno-75-49" href="#__codelineno-75-49"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-75-50" name="__codelineno-75-50" href="#__codelineno-75-50"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-75-51" name="__codelineno-75-51" href="#__codelineno-75-51"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-75-52" name="__codelineno-75-52" href="#__codelineno-75-52"></a><span class="p">}</span>
<a id="__codelineno-75-53" name="__codelineno-75-53" href="#__codelineno-75-53"></a>
<a id="__codelineno-75-54" name="__codelineno-75-54" href="#__codelineno-75-54"></a><span class="cm">/* Result: Zone caches are trimmed, memory returned to VM */</span>
</code></pre></div>
<p><strong>Hysteresis prevents thrashing</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>Zone free chunks over time:
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>z_NFree
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>  ^
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>  |
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>200 |                        Threshold (ZoneRelsThresh)
<a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>  |          
<a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>  |           ___
<a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>100 |------------___________   Recycle to 100
<a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>  |                   
<a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>  |                    
<a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>  0 |___/___________________&gt; time
<a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>     Alloc    Recycle    Steady state
<a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>     surge    event
<a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>
<a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>Without hysteresis:
<a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>- Constant oscillation around threshold
<a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a>- Frequent expensive recycle operations
<a id="__codelineno-76-19" name="__codelineno-76-19" href="#__codelineno-76-19"></a>
<a id="__codelineno-76-20" name="__codelineno-76-20" href="#__codelineno-76-20"></a>With hysteresis:
<a id="__codelineno-76-21" name="__codelineno-76-21" href="#__codelineno-76-21"></a>- Recycle only when significantly above threshold
<a id="__codelineno-76-22" name="__codelineno-76-22" href="#__codelineno-76-22"></a>- Recycle to midpoint (thresh/2)
<a id="__codelineno-76-23" name="__codelineno-76-23" href="#__codelineno-76-23"></a>- Stable behavior under varying load
</code></pre></div></p>
<hr />
<h2 id="best-practices-and-guidelines">Best Practices and Guidelines<a class="headerlink" href="#best-practices-and-guidelines" title="Permanent link">&para;</a></h2>
<h3 id="choosing-the-right-allocator">Choosing the Right Allocator<a class="headerlink" href="#choosing-the-right-allocator" title="Permanent link">&para;</a></h3>
<p><strong>Decision tree</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a> What are you allocating?            
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>             
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>              Variable sizes, infrequent
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>                Use kmalloc/kfree
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>             
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>              Same-size, high frequency, no ctor/dtor
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>                Use kmalloc_obj/kfree_obj
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>             
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>              Same-size, high frequency, need ctor/dtor
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>                Use objcache
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>             
<a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>              Pre-allocated pool, guaranteed allocation
<a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a>                Use mpipe
<a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a>             
<a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a>              Power-of-2 ranges, alignment critical
<a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a>                Use alist
<a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a>             
<a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a>              General ranges (e.g., swap blocks)
<a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a>                Use blist
<a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a>             
<a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a>              Building strings dynamically
<a id="__codelineno-77-24" name="__codelineno-77-24" href="#__codelineno-77-24"></a>                Use sbuf
<a id="__codelineno-77-25" name="__codelineno-77-25" href="#__codelineno-77-25"></a>             
<a id="__codelineno-77-26" name="__codelineno-77-26" href="#__codelineno-77-26"></a>              DMA scatter-gather lists
<a id="__codelineno-77-27" name="__codelineno-77-27" href="#__codelineno-77-27"></a>                 Use sglist
</code></pre></div>
<p><strong>Detailed guidelines</strong>:</p>
<table>
<thead>
<tr>
<th>Allocator</th>
<th>Best For</th>
<th>Avoid When</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>kmalloc</strong></td>
<td>General allocations, variable sizes, infrequent</td>
<td>High-frequency same-size objects</td>
</tr>
<tr>
<td><strong>kmalloc_obj</strong></td>
<td>Fixed-size, high frequency, type stability</td>
<td>Need ctor/dtor, variable sizes</td>
</tr>
<tr>
<td><strong>objcache</strong></td>
<td>High frequency, ctor/dtor, statistics</td>
<td>Simple allocations, low frequency</td>
</tr>
<tr>
<td><strong>mpipe</strong></td>
<td>Pre-allocated pools, guaranteed success</td>
<td>Dynamic sizing, unpredictable counts</td>
</tr>
<tr>
<td><strong>alist</strong></td>
<td>Power-of-2 aligned ranges</td>
<td>Non-power-of-2 sizes</td>
</tr>
<tr>
<td><strong>blist</strong></td>
<td>General block ranges (swap)</td>
<td>Need unlimited growth</td>
</tr>
<tr>
<td><strong>sbuf</strong></td>
<td>Dynamic string building</td>
<td>Fixed-size strings</td>
</tr>
<tr>
<td><strong>sglist</strong></td>
<td>DMA scatter-gather</td>
<td>Non-DMA memory management</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="allocation-flags-m_waitok-vs-m_nowait">Allocation Flags: M_WAITOK vs. M_NOWAIT<a class="headerlink" href="#allocation-flags-m_waitok-vs-m_nowait" title="Permanent link">&para;</a></h3>
<p><strong>M_WAITOK</strong> (can sleep):
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="cm">/* Use in process context where blocking is acceptable */</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">process_context_function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="w">    </span><span class="cm">/* p is guaranteed to be non-NULL (or panic if truly OOM) */</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="w">    </span><span class="cm">/* Advantages:</span>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="cm">     * - Simple error handling (almost always succeeds)</span>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="cm">     * - Can trigger VM pageout to free memory</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="cm">     * - No need to check for NULL</span>
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="cm">     */</span>
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>M_NOWAIT</strong> (cannot sleep):
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="cm">/* Use in interrupt context or holding locks */</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">interrupt_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">        </span><span class="cm">/* Handle allocation failure */</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="w">    </span><span class="cm">/* Use p... */</span>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="p">}</span>
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="kt">void</span><span class="w"> </span><span class="nf">holding_spinlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a><span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>
<a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a><span class="w">    </span><span class="cm">/* Use p... */</span>
<a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a><span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Guidelines</strong>:</p>
<ol>
<li><strong>Default to M_WAITOK</strong> in process context</li>
<li>Simpler code (no NULL checks)</li>
<li>Better resource utilization</li>
<li>
<p>Kernel can free memory if needed</p>
</li>
<li>
<p><strong>Use M_NOWAIT when</strong>:</p>
</li>
<li>In interrupt context</li>
<li>Holding spinlocks</li>
<li>In callback functions (may be called from interrupt)</li>
<li>
<p>Performance-critical paths where blocking is unacceptable</p>
</li>
<li>
<p><strong>Always check M_NOWAIT return</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="cm">/* WRONG */</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="n">bcopy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w">  </span><span class="cm">/* May crash if p == NULL! */</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="cm">/* CORRECT */</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="n">bcopy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>M_INTWAIT</strong>: Special flag for slightly more aggressive M_NOWAIT</p>
</li>
<li>Will try harder than M_NOWAIT</li>
<li>Still won't block</li>
<li>Use in interrupt context when allocation is important</li>
</ol>
<hr />
<h3 id="memory-leak-prevention">Memory Leak Prevention<a class="headerlink" href="#memory-leak-prevention" title="Permanent link">&para;</a></h3>
<p><strong>Common patterns</strong>:</p>
<ol>
<li>
<p><strong>Match alloc/free</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="cm">/* WRONG: Leak on error path */</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="kt">int</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">some_error</span><span class="p">())</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Leak: forgot to free buf! */</span>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="w">    </span><span class="cm">/* ... use buf ... */</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a><span class="p">}</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a><span class="cm">/* CORRECT: Free on all paths */</span>
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a><span class="kt">int</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a>
<a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">some_error</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a><span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span>
<a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a>
<a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a><span class="w">    </span><span class="cm">/* ... use buf ... */</span>
<a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a>
<a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a><span class="nl">cleanup</span><span class="p">:</span>
<a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a><span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Use correct malloc type</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="cm">/* WRONG: Type mismatch */</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_VNODE</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="cm">/* ... */</span>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Statistics corrupted! */</span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="cm">/* CORRECT */</span>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_VNODE</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="cm">/* ... */</span>
<a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_VNODE</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Avoid double-free</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="cm">/* WRONG: Double free */</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="cm">/* ... */</span>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Corruption! */</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="cm">/* CORRECT: NULL after free */</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a><span class="cm">/* Later accidental free is safe */</span>
<a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Reference counting</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">refcounted_obj</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">refcount</span><span class="p">;</span>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="w">    </span><span class="cm">/* ... data ... */</span>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="p">};</span>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="kt">void</span><span class="w"> </span><span class="nf">obj_hold</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">refcounted_obj</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="w">    </span><span class="n">atomic_add_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="p">}</span>
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>
<a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">obj_drop</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">refcounted_obj</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_fetchadd_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a><span class="w">        </span><span class="cm">/* Last reference, free object */</span>
<a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a><span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">M_OBJ</span><span class="p">);</span>
<a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a><span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<hr />
<h3 id="performance-tips">Performance Tips<a class="headerlink" href="#performance-tips" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Batch allocations</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="cm">/* INEFFICIENT: Many small allocations */</span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">    </span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">item_t</span><span class="p">),</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="p">}</span>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="cm">/* EFFICIENT: One large allocation */</span>
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="n">item_t</span><span class="w"> </span><span class="o">*</span><span class="n">all_items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">item_t</span><span class="p">),</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="w">    </span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">all_items</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Use object caches for hot paths</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="cm">/* INEFFICIENT: kmalloc in packet processing loop */</span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">process_packet</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mbuf</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pkt_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="p">),</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="p">}</span>
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a>
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="cm">/* EFFICIENT: Use objcache */</span>
<a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">objcache</span><span class="w"> </span><span class="o">*</span><span class="n">pkt_ctx_cache</span><span class="p">;</span>
<a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a>
<a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a><span class="kt">void</span><span class="w"> </span><span class="nf">process_packet</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mbuf</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pkt_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_get</span><span class="p">(</span><span class="n">pkt_ctx_cache</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a><span class="w">    </span><span class="n">objcache_put</span><span class="p">(</span><span class="n">pkt_ctx_cache</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
<a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Avoid allocations in interrupt context</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="cm">/* POOR: Allocate in interrupt */</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">device_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">work</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Drop work! */</span>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="w">    </span><span class="n">queue_work</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="p">}</span>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="cm">/* BETTER: Pre-allocated pool (mpipe) */</span>
<a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_pipe</span><span class="w"> </span><span class="n">work_pipe</span><span class="p">;</span>
<a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>
<a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a><span class="kt">void</span><span class="w"> </span><span class="nf">device_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">work</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpipe_alloc_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work_pipe</span><span class="p">);</span>
<a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a><span class="w">    </span><span class="n">queue_work</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
<a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Cache-aware allocation</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="cm">/* Per-CPU data structure: use kmalloc_obj for cache affinity */</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">per_cpu_data</span><span class="w"> </span><span class="o">*</span><span class="n">pcd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_obj</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pcd</span><span class="p">),</span><span class="w"> </span><span class="n">M_PERCPU</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="cm">/* Likely to be allocated from local CPU zone, cache-hot */</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Reuse objects when possible</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="cm">/* INEFFICIENT: Constant alloc/free */</span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">process_loop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="w">        </span><span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="p">}</span>
<a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>
<a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="cm">/* EFFICIENT: Allocate once */</span>
<a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a><span class="kt">void</span><span class="w"> </span><span class="nf">process_loop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a><span class="w">        </span><span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a><span class="w">        </span><span class="cm">/* Reuse buf */</span>
<a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a><span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a><span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<hr />
<h3 id="debugging-techniques">Debugging Techniques<a class="headerlink" href="#debugging-techniques" title="Permanent link">&para;</a></h3>
<p><strong>Enable INVARIANTS</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="cm">/* In kernel config */</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="n">options</span><span class="w"> </span><span class="n">INVARIANTS</span>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="cm">/* Enables:</span>
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a><span class="cm"> * - Memory pattern checks (0xdeadc0de, 0x5a5a5a5a)</span>
<a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a><span class="cm"> * - Chunk bitmap verification</span>
<a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a><span class="cm"> * - Redzone protection</span>
<a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a><span class="cm"> * - Double-free detection</span>
<a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a><span class="cm"> */</span>
</code></pre></div></p>
<p><strong>Use vmstat -m for malloc statistics</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>$<span class="w"> </span>vmstat<span class="w"> </span>-m
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="w">         </span>Type<span class="w"> </span>InUse<span class="w"> </span>MemUse<span class="w"> </span>HighUse<span class="w"> </span>Requests<span class="w">  </span>Size<span class="o">(</span>s<span class="o">)</span>
<a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="w">       </span>vnode<span class="w">   </span><span class="m">1234</span><span class="w">   </span>123K<span class="w">    </span>234K<span class="w">     </span><span class="m">5678</span><span class="w">  </span><span class="m">128</span>,256
<a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a><span class="w">        </span>temp<span class="w">    </span><span class="m">567</span><span class="w">    </span>67K<span class="w">     </span>89K<span class="w">    </span><span class="m">12345</span><span class="w">  </span><span class="m">16</span>,32,64,128,256
<a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a><span class="w">       </span>mbuf<span class="w">    </span><span class="m">8901</span><span class="w">   </span>890K<span class="w">   </span>1234K<span class="w">   </span><span class="m">567890</span><span class="w">  </span><span class="m">256</span>
<a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="c1"># Shows:</span>
<a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a><span class="c1"># - InUse: Currently allocated objects</span>
<a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a><span class="c1"># - MemUse: Current memory usage</span>
<a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a><span class="c1"># - HighUse: Peak memory usage</span>
<a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a><span class="c1"># - Requests: Total allocation requests</span>
<a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a><span class="c1"># - Size(s): Zones used</span>
</code></pre></div></p>
<p><strong>Check objcache statistics</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>$<span class="w"> </span>sysctl<span class="w"> </span>kern.objcache.stats
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="c1"># Shows per-cache statistics:</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="c1"># - oc_limit: Cluster limit</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="c1"># - oc_requested: Total get requests</span>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="c1"># - oc_allocated: Backend allocations</span>
<a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="c1"># - oc_exhausted: Times limit was hit</span>
<a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="c1"># - oc_failed: Failed allocations</span>
<a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="c1"># - oc_used: Currently allocated</span>
<a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a><span class="c1"># - oc_cached: Cached in magazines</span>
</code></pre></div></p>
<p><strong>Memory leak detection</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="cm">/* Before suspected leak point */</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="n">vmstat</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">before</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="cm">/* Run code that might leak */</span>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="n">test_suspected_leak</span><span class="p">();</span>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a><span class="cm">/* After */</span>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a><span class="n">vmstat</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">after</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a>
<a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a><span class="cm">/* Compare */</span>
<a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a><span class="n">diff</span><span class="w"> </span><span class="n">before</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="n">after</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a><span class="cp"># Look for types with increased InUse counts</span>
</code></pre></div></p>
<p><strong>Kernel malloc tracing</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="cm">/* Enable malloc tracing (if compiled with MALLOC_PROFILE) */</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="n">sysctl</span><span class="w"> </span><span class="n">debug</span><span class="p">.</span><span class="n">malloc</span><span class="p">.</span><span class="n">trace</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="cm">/* Generate trace */</span>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="cm">/* ... run workload ... */</span>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="cm">/* Analyze trace output in kernel log */</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="n">dmesg</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">malloc</span>
</code></pre></div></p>
<p><strong>KTR (Kernel Trace) for detailed flow</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="cm">/* In kernel config */</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="n">options</span><span class="w"> </span><span class="n">KTR</span>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="n">options</span><span class="w"> </span><span class="n">KTR_MEMORY</span>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="cm">/* At runtime */</span>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="n">sysctl</span><span class="w"> </span><span class="n">debug</span><span class="p">.</span><span class="n">ktr</span><span class="p">.</span><span class="n">entries</span><span class="o">=</span><span class="mi">16384</span>
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a><span class="n">sysctl</span><span class="w"> </span><span class="n">debug</span><span class="p">.</span><span class="n">ktr</span><span class="p">.</span><span class="n">mask</span><span class="o">=</span><span class="mh">0x800</span><span class="w">  </span><span class="cm">/* KTR_MEMORY */</span>
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a>
<a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a><span class="cm">/* Generate trace */</span>
<a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a><span class="cm">/* ... run workload ... */</span>
<a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>
<a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a><span class="cm">/* Dump trace */</span>
<a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a><span class="n">sysctl</span><span class="w"> </span><span class="n">debug</span><span class="p">.</span><span class="n">ktr</span><span class="p">.</span><span class="n">dump</span>
</code></pre></div></p>
<p><strong>Common memory corruption patterns</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="cm">/* Use-after-free: INVARIANTS detects 0xdeadc0de pattern */</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="n">p</span><span class="o">-&gt;</span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">;</span><span class="w">  </span><span class="cm">/* INVARIANTS panic: 0xdeadc0de detected */</span>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a><span class="cm">/* Buffer overflow: Watch for panics about corrupted chunks */</span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a><span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;this_string_is_too_long&quot;</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Corruption! */</span>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a><span class="cm">/* Double free: INVARIANTS detects chunk already free */</span>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">);</span><span class="w">  </span><span class="cm">/* INVARIANTS panic: chunk already free */</span>
</code></pre></div></p>
<hr />
<h3 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Zero sensitive data</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="cm">/* Always use M_ZERO for sensitive data */</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">password</span><span class="w"> </span><span class="o">*</span><span class="n">pwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pwd</span><span class="p">),</span><span class="w"> </span><span class="n">M_SECURE</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="o">|</span><span class="n">M_ZERO</span><span class="p">);</span>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="cm">/* After use, explicit zero before free */</span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="n">bzero</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pwd</span><span class="p">));</span>
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="n">kfree</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span><span class="w"> </span><span class="n">M_SECURE</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Avoid uninitialized data leaks</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="cm">/* UNSAFE: May leak kernel data to userspace */</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">userdata</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ud</span><span class="p">),</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="n">ud</span><span class="o">-&gt;</span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value1</span><span class="p">;</span>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="cm">/* ud-&gt;field2 uninitialized! */</span>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="n">copyout</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="n">userptr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ud</span><span class="p">));</span><span class="w">  </span><span class="cm">/* Leak! */</span>
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a>
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="cm">/* SAFE: Zero or initialize all fields */</span>
<a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a><span class="k">struct</span><span class="w"> </span><span class="nc">userdata</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ud</span><span class="p">),</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="o">|</span><span class="n">M_ZERO</span><span class="p">);</span>
<a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a><span class="n">ud</span><span class="o">-&gt;</span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value1</span><span class="p">;</span>
<a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a><span class="n">ud</span><span class="o">-&gt;</span><span class="n">field2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value2</span><span class="p">;</span>
<a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a><span class="n">copyout</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="n">userptr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ud</span><span class="p">));</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Validate sizes from userspace</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="cm">/* UNSAFE: User can cause huge allocation */</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="n">copyin</span><span class="p">(</span><span class="n">userptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Danger! */</span>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a><span class="cm">/* SAFE: Validate and limit size */</span>
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a><span class="n">copyin</span><span class="p">(</span><span class="n">userptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
<a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_USER_ALLOC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a><span class="p">}</span>
<a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Use M_NULLOK when appropriate</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="cm">/* Allow NULL return instead of panic on exhaustion */</span>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">huge_size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="o">|</span><span class="n">M_NULLOK</span><span class="p">);</span>
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a><span class="w">    </span><span class="cm">/* Handle gracefully instead of panic */</span>
<a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a><span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<hr />
<h3 id="common-pitfalls">Common Pitfalls<a class="headerlink" href="#common-pitfalls" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Allocating with locks held</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="cm">/* WRONG: May deadlock */</span>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Can&#39;t sleep with spinlock! */</span>
<a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a>
<a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a><span class="cm">/* CORRECT: Allocate before lock or use M_NOWAIT */</span>
<a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a><span class="cm">/* ... use p ... */</span>
<a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Ignoring M_NOWAIT failures</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="cm">/* WRONG: No NULL check */</span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a><span class="n">bcopy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Crash if p == NULL! */</span>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a><span class="cm">/* CORRECT */</span>
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">M_NOWAIT</span><span class="p">);</span>
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a><span class="n">bcopy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Type-stable allocator misconceptions</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="cm">/* WRONG: Expecting memory to be returned to VM immediately */</span>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="n">kfree_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">M_TYPE</span><span class="p">);</span>
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a><span class="cm">/* Memory stays in type-stable slab, not freed to VM! */</span>
<a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>
<a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a><span class="cm">/* This is intentional: Type stability keeps memory allocated</span>
<a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a><span class="cm"> * for fast reuse. Use kmalloc if you need memory returned</span>
<a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a><span class="cm"> * to system immediately.</span>
<a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a><span class="cm"> */</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Objcache magazine sizing</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="cm">/* POOR: Cluster limit too small */</span>
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_create</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w">  </span><span class="cm">/* Only 10 objects max */</span>
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="cm">/* Under load, will hit limit and fall back to backend frequently */</span>
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="cm">/* BETTER: Size based on expected load */</span>
<a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objcache_create</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w">  </span><span class="cm">/* Allow 1000 cached */</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Mixing allocators</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="cm">/* WRONG: Allocate with one, free with another */</span>
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_obj</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TYPE</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Should use kfree_obj! */</span>
<a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>
<a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a><span class="cm">/* CORRECT */</span>
<a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_obj</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">M_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">M_WAITOK</span><span class="p">);</span>
<a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a><span class="n">kfree_obj</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">M_TYPE</span><span class="p">);</span>
</code></pre></div></p>
</li>
</ol>
<hr />
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>DragonFly's memory allocation system provides a sophisticated, multi-layered architecture optimized for different use cases:</p>
<ul>
<li><strong>kmalloc/kfree</strong>: General-purpose, power-of-2 zones, per-CPU optimization</li>
<li><strong>kmalloc_obj/kfree_obj</strong>: Type-stable, 128KB slabs, bulk operations</li>
<li><strong>objcache</strong>: Magazine/depot caching, constructor/destructor support</li>
<li><strong>mpipe</strong>: Pre-allocated pools, guaranteed allocation</li>
<li><strong>Helper allocators</strong>: alist, blist, sbuf, sglist for specialized needs</li>
</ul>
<p>Key design principles:
1. <strong>Lock-free fast paths</strong>: Per-CPU zones, atomic operations
2. <strong>Cache affinity</strong>: LIFO behavior, per-CPU allocation
3. <strong>Hysteresis</strong>: Prevent thrashing in zone recycling
4. <strong>Layered architecture</strong>: Choose the right tool for the job
5. <strong>Type stability</strong>: Enable efficient bulk operations</p>
<p>The system balances performance, memory efficiency, and simplicity, providing appropriate allocators for different allocation patterns from high-frequency small objects to dynamic string building and DMA scatter-gather lists.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>