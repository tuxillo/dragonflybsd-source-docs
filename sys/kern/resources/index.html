
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../processes/" rel="prev"/>
<link href="../signals/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.0" name="generator"/>
<title>Process Resources &amp; Credentials - DragonFly BSD Kernel Documentation</title>
<link href="../../../assets/stylesheets/main.618322db.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#process-resources-and-credentials">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Process Resources &amp; Credentials
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptors-kern_descripc">
<span class="md-ellipsis">
      
        File Descriptors (kern_descrip.c)
      
    </span>
</a>
<nav aria-label="File Descriptors (kern_descrip.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-filedesc">
<span class="md-ellipsis">
      
        struct filedesc
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thread-local-caching-td_fdcache">
<span class="md-ellipsis">
      
        Thread-local Caching (td_fdcache)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-allocation">
<span class="md-ellipsis">
      
        File Descriptor Allocation
      
    </span>
</a>
<nav aria-label="File Descriptor Allocation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#binary-tree-algorithm-fdalloc_locked">
<span class="md-ellipsis">
      
        Binary Tree Algorithm (fdalloc_locked)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#growing-the-descriptor-table">
<span class="md-ellipsis">
      
        Growing the Descriptor Table
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-operations">
<span class="md-ellipsis">
      
        File Descriptor Operations
      
    </span>
</a>
<nav aria-label="File Descriptor Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fgetreadfgetwritefget">
<span class="md-ellipsis">
      
        fgetread/fgetwrite/fget
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fdrop-release-file-reference">
<span class="md-ellipsis">
      
        fdrop — Release File Reference
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dupdup2fcntlf_dupfd">
<span class="md-ellipsis">
      
        dup/dup2/fcntl(F_DUPFD)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-limits">
<span class="md-ellipsis">
      
        File Descriptor Limits
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-revocation-fdrevoke">
<span class="md-ellipsis">
      
        File Descriptor Revocation (fdrevoke)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-limits-kern_plimitc">
<span class="md-ellipsis">
      
        Resource Limits (kern_plimit.c)
      
    </span>
</a>
<nav aria-label="Resource Limits (kern_plimit.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures_1">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-plimit">
<span class="md-ellipsis">
      
        struct plimit
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write-semantics">
<span class="md-ellipsis">
      
        Copy-on-Write Semantics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#limit-modification">
<span class="md-ellipsis">
      
        Limit Modification
      
    </span>
</a>
<nav aria-label="Limit Modification" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#plimit_modify">
<span class="md-ellipsis">
      
        plimit_modify
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dosetrlimit">
<span class="md-ellipsis">
      
        dosetrlimit
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fork-depth-adjustment-plimit_getadjvalue">
<span class="md-ellipsis">
      
        Fork Depth Adjustment (plimit_getadjvalue)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cpu-limit-enforcement">
<span class="md-ellipsis">
      
        CPU Limit Enforcement
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-accounting-kern_resourcec">
<span class="md-ellipsis">
      
        Resource Accounting (kern_resource.c)
      
    </span>
</a>
<nav aria-label="Resource Accounting (kern_resource.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#priority-management">
<span class="md-ellipsis">
      
        Priority Management
      
    </span>
</a>
<nav aria-label="Priority Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#three-priority-types">
<span class="md-ellipsis">
      
        Three Priority Types
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#getprioritysetpriority">
<span class="md-ellipsis">
      
        getpriority/setpriority
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ioprio_getioprio_set">
<span class="md-ellipsis">
      
        ioprio_get/ioprio_set
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rtpriolwp_rtprio">
<span class="md-ellipsis">
      
        rtprio/lwp_rtprio
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cpu-time-accounting">
<span class="md-ellipsis">
      
        CPU Time Accounting
      
    </span>
</a>
<nav aria-label="CPU Time Accounting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#calcru-calculate-resource-usage">
<span class="md-ellipsis">
      
        calcru — Calculate Resource Usage
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#calcru_proc-aggregate-process-usage">
<span class="md-ellipsis">
      
        calcru_proc — Aggregate Process Usage
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#getrusage-system-call">
<span class="md-ellipsis">
      
        getrusage System Call
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-user-resource-tracking-uidinfo">
<span class="md-ellipsis">
      
        Per-User Resource Tracking (uidinfo)
      
    </span>
</a>
<nav aria-label="Per-User Resource Tracking (uidinfo)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-uidinfo">
<span class="md-ellipsis">
      
        struct uidinfo
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chgproccntchgsbsize">
<span class="md-ellipsis">
      
        chgproccnt/chgsbsize
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credentials-kern_protc">
<span class="md-ellipsis">
      
        Credentials (kern_prot.c)
      
    </span>
</a>
<nav aria-label="Credentials (kern_prot.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures_2">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-ucred">
<span class="md-ellipsis">
      
        struct ucred
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#atomic-copy-on-write-cratom">
<span class="md-ellipsis">
      
        Atomic Copy-on-Write (cratom)
      
    </span>
</a>
<nav aria-label="Atomic Copy-on-Write (cratom)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cratom_proc">
<span class="md-ellipsis">
      
        cratom_proc
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uidgid-system-calls">
<span class="md-ellipsis">
      
        UID/GID System Calls
      
    </span>
</a>
<nav aria-label="UID/GID System Calls" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#getuidgeteuidgetgidgetegid">
<span class="md-ellipsis">
      
        getuid/geteuid/getgid/getegid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setuidseteuid">
<span class="md-ellipsis">
      
        setuid/seteuid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#change_euidchange_ruid">
<span class="md-ellipsis">
      
        change_euid/change_ruid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setreuidsetregid">
<span class="md-ellipsis">
      
        setreuid/setregid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setresuidsetresgid">
<span class="md-ellipsis">
      
        setresuid/setresgid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setgroupsgetgroups">
<span class="md-ellipsis">
      
        setgroups/getgroups
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#permission-checking">
<span class="md-ellipsis">
      
        Permission Checking
      
    </span>
</a>
<nav aria-label="Permission Checking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#p_trespass">
<span class="md-ellipsis">
      
        p_trespass
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processsessiongroup-ids">
<span class="md-ellipsis">
      
        Process/Session/Group IDs
      
    </span>
</a>
<nav aria-label="Process/Session/Group IDs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#getpidgetppid">
<span class="md-ellipsis">
      
        getpid/getppid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setsid-create-new-session">
<span class="md-ellipsis">
      
        setsid — Create New Session
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setpgid-set-process-group">
<span class="md-ellipsis">
      
        setpgid — Set Process Group
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credential-tainting-setsugid">
<span class="md-ellipsis">
      
        Credential Tainting (setsugid)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#interactions-between-subsystems">
<span class="md-ellipsis">
      
        Interactions Between Subsystems
      
    </span>
</a>
<nav aria-label="Interactions Between Subsystems" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptors-resource-limits">
<span class="md-ellipsis">
      
        File Descriptors → Resource Limits
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptors-credentials">
<span class="md-ellipsis">
      
        File Descriptors → Credentials
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-limits-fork">
<span class="md-ellipsis">
      
        Resource Limits → Fork
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credentials-uidinfo">
<span class="md-ellipsis">
      
        Credentials → uidinfo
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-design-principles">
<span class="md-ellipsis">
      
        Key Design Principles
      
    </span>
</a>
<nav aria-label="Key Design Principles" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-copy-on-write-for-sharing">
<span class="md-ellipsis">
      
        1. Copy-on-Write for Sharing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-thread-local-caching">
<span class="md-ellipsis">
      
        2. Thread-Local Caching
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-per-user-resource-tracking">
<span class="md-ellipsis">
      
        3. Per-User Resource Tracking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-binary-tree-allocation">
<span class="md-ellipsis">
      
        4. Binary Tree Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-limit-enforcement-points">
<span class="md-ellipsis">
      
        5. Limit Enforcement Points
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
<span class="md-ellipsis">
      
        Summary
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vm/vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptors-kern_descripc">
<span class="md-ellipsis">
      
        File Descriptors (kern_descrip.c)
      
    </span>
</a>
<nav aria-label="File Descriptors (kern_descrip.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-filedesc">
<span class="md-ellipsis">
      
        struct filedesc
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thread-local-caching-td_fdcache">
<span class="md-ellipsis">
      
        Thread-local Caching (td_fdcache)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-allocation">
<span class="md-ellipsis">
      
        File Descriptor Allocation
      
    </span>
</a>
<nav aria-label="File Descriptor Allocation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#binary-tree-algorithm-fdalloc_locked">
<span class="md-ellipsis">
      
        Binary Tree Algorithm (fdalloc_locked)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#growing-the-descriptor-table">
<span class="md-ellipsis">
      
        Growing the Descriptor Table
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-operations">
<span class="md-ellipsis">
      
        File Descriptor Operations
      
    </span>
</a>
<nav aria-label="File Descriptor Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fgetreadfgetwritefget">
<span class="md-ellipsis">
      
        fgetread/fgetwrite/fget
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fdrop-release-file-reference">
<span class="md-ellipsis">
      
        fdrop — Release File Reference
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dupdup2fcntlf_dupfd">
<span class="md-ellipsis">
      
        dup/dup2/fcntl(F_DUPFD)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-limits">
<span class="md-ellipsis">
      
        File Descriptor Limits
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptor-revocation-fdrevoke">
<span class="md-ellipsis">
      
        File Descriptor Revocation (fdrevoke)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-limits-kern_plimitc">
<span class="md-ellipsis">
      
        Resource Limits (kern_plimit.c)
      
    </span>
</a>
<nav aria-label="Resource Limits (kern_plimit.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures_1">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-plimit">
<span class="md-ellipsis">
      
        struct plimit
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write-semantics">
<span class="md-ellipsis">
      
        Copy-on-Write Semantics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#limit-modification">
<span class="md-ellipsis">
      
        Limit Modification
      
    </span>
</a>
<nav aria-label="Limit Modification" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#plimit_modify">
<span class="md-ellipsis">
      
        plimit_modify
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dosetrlimit">
<span class="md-ellipsis">
      
        dosetrlimit
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fork-depth-adjustment-plimit_getadjvalue">
<span class="md-ellipsis">
      
        Fork Depth Adjustment (plimit_getadjvalue)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cpu-limit-enforcement">
<span class="md-ellipsis">
      
        CPU Limit Enforcement
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-accounting-kern_resourcec">
<span class="md-ellipsis">
      
        Resource Accounting (kern_resource.c)
      
    </span>
</a>
<nav aria-label="Resource Accounting (kern_resource.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#priority-management">
<span class="md-ellipsis">
      
        Priority Management
      
    </span>
</a>
<nav aria-label="Priority Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#three-priority-types">
<span class="md-ellipsis">
      
        Three Priority Types
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#getprioritysetpriority">
<span class="md-ellipsis">
      
        getpriority/setpriority
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ioprio_getioprio_set">
<span class="md-ellipsis">
      
        ioprio_get/ioprio_set
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rtpriolwp_rtprio">
<span class="md-ellipsis">
      
        rtprio/lwp_rtprio
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cpu-time-accounting">
<span class="md-ellipsis">
      
        CPU Time Accounting
      
    </span>
</a>
<nav aria-label="CPU Time Accounting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#calcru-calculate-resource-usage">
<span class="md-ellipsis">
      
        calcru — Calculate Resource Usage
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#calcru_proc-aggregate-process-usage">
<span class="md-ellipsis">
      
        calcru_proc — Aggregate Process Usage
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#getrusage-system-call">
<span class="md-ellipsis">
      
        getrusage System Call
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-user-resource-tracking-uidinfo">
<span class="md-ellipsis">
      
        Per-User Resource Tracking (uidinfo)
      
    </span>
</a>
<nav aria-label="Per-User Resource Tracking (uidinfo)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-uidinfo">
<span class="md-ellipsis">
      
        struct uidinfo
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chgproccntchgsbsize">
<span class="md-ellipsis">
      
        chgproccnt/chgsbsize
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credentials-kern_protc">
<span class="md-ellipsis">
      
        Credentials (kern_prot.c)
      
    </span>
</a>
<nav aria-label="Credentials (kern_prot.c)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures_2">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-ucred">
<span class="md-ellipsis">
      
        struct ucred
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#atomic-copy-on-write-cratom">
<span class="md-ellipsis">
      
        Atomic Copy-on-Write (cratom)
      
    </span>
</a>
<nav aria-label="Atomic Copy-on-Write (cratom)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cratom_proc">
<span class="md-ellipsis">
      
        cratom_proc
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uidgid-system-calls">
<span class="md-ellipsis">
      
        UID/GID System Calls
      
    </span>
</a>
<nav aria-label="UID/GID System Calls" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#getuidgeteuidgetgidgetegid">
<span class="md-ellipsis">
      
        getuid/geteuid/getgid/getegid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setuidseteuid">
<span class="md-ellipsis">
      
        setuid/seteuid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#change_euidchange_ruid">
<span class="md-ellipsis">
      
        change_euid/change_ruid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setreuidsetregid">
<span class="md-ellipsis">
      
        setreuid/setregid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setresuidsetresgid">
<span class="md-ellipsis">
      
        setresuid/setresgid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setgroupsgetgroups">
<span class="md-ellipsis">
      
        setgroups/getgroups
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#permission-checking">
<span class="md-ellipsis">
      
        Permission Checking
      
    </span>
</a>
<nav aria-label="Permission Checking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#p_trespass">
<span class="md-ellipsis">
      
        p_trespass
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processsessiongroup-ids">
<span class="md-ellipsis">
      
        Process/Session/Group IDs
      
    </span>
</a>
<nav aria-label="Process/Session/Group IDs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#getpidgetppid">
<span class="md-ellipsis">
      
        getpid/getppid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setsid-create-new-session">
<span class="md-ellipsis">
      
        setsid — Create New Session
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setpgid-set-process-group">
<span class="md-ellipsis">
      
        setpgid — Set Process Group
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credential-tainting-setsugid">
<span class="md-ellipsis">
      
        Credential Tainting (setsugid)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#interactions-between-subsystems">
<span class="md-ellipsis">
      
        Interactions Between Subsystems
      
    </span>
</a>
<nav aria-label="Interactions Between Subsystems" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptors-resource-limits">
<span class="md-ellipsis">
      
        File Descriptors → Resource Limits
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-descriptors-credentials">
<span class="md-ellipsis">
      
        File Descriptors → Credentials
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-limits-fork">
<span class="md-ellipsis">
      
        Resource Limits → Fork
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credentials-uidinfo">
<span class="md-ellipsis">
      
        Credentials → uidinfo
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-design-principles">
<span class="md-ellipsis">
      
        Key Design Principles
      
    </span>
</a>
<nav aria-label="Key Design Principles" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-copy-on-write-for-sharing">
<span class="md-ellipsis">
      
        1. Copy-on-Write for Sharing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-thread-local-caching">
<span class="md-ellipsis">
      
        2. Thread-Local Caching
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-per-user-resource-tracking">
<span class="md-ellipsis">
      
        3. Per-User Resource Tracking
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-binary-tree-allocation">
<span class="md-ellipsis">
      
        4. Binary Tree Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-limit-enforcement-points">
<span class="md-ellipsis">
      
        5. Limit Enforcement Points
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
<span class="md-ellipsis">
      
        Summary
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="process-resources-and-credentials">Process Resources and Credentials<a class="headerlink" href="#process-resources-and-credentials" title="Permanent link">¶</a></h1>
<p><strong>Source files:</strong> <code>kern_descrip.c</code>, <code>kern_plimit.c</code>, <code>kern_resource.c</code>, <code>kern_prot.c</code></p>
<p>This document covers the management of process resources, limits, credentials, and file descriptors in DragonFly BSD. These subsystems provide resource accounting, access control, and per-process resource tracking.</p>
<hr/>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h2>
<p>Process resource management encompasses four major areas:</p>
<ol>
<li><strong>File descriptors</strong> (<code>kern_descrip.c</code>) — per-process file descriptor tables with thread-local caching</li>
<li><strong>Resource limits</strong> (<code>kern_plimit.c</code>) — copy-on-write limit structures (RLIMIT_* values)</li>
<li><strong>Resource accounting</strong> (<code>kern_resource.c</code>) — priority management, CPU usage tracking, per-user accounting</li>
<li><strong>Credentials</strong> (<code>kern_prot.c</code>) — UID/GID management with atomic copy-on-write semantics</li>
</ol>
<p>All four interact closely: file descriptors are subject to resource limits (RLIMIT_NOFILE), credentials control access to resources, and resource accounting tracks consumption per user and process.</p>
<hr/>
<h2 id="file-descriptors-kern_descripc">File Descriptors (<code>kern_descrip.c</code>)<a class="headerlink" href="#file-descriptors-kern_descripc" title="Permanent link">¶</a></h2>
<h3 id="data-structures">Data Structures<a class="headerlink" href="#data-structures" title="Permanent link">¶</a></h3>
<h4 id="struct-filedesc"><code>struct filedesc</code><a class="headerlink" href="#struct-filedesc" title="Permanent link">¶</a></h4>
<p>The per-process file descriptor table:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">filedesc</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">**</span><span class="n">fd_files</span><span class="p">;</span><span class="w">        </span><span class="cm">/* File pointer array */</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">fd_cmask</span><span class="p">;</span><span class="w">             </span><span class="cm">/* umask for open() */</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd_lastfile</span><span class="p">;</span><span class="w">               </span><span class="cm">/* High water mark */</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd_freefile</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Hint for next free fd */</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd_nfiles</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Total slots allocated */</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd_refcnt</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Reference count */</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uidinfo</span><span class="w"> </span><span class="o">*</span><span class="n">fd_uinfo</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Per-user accounting */</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="p">};</span>
</code></pre></div>
<p>Key points:
- <code>fd_files[]</code> is dynamically resized as file descriptors are allocated
- Binary tree structure tracks free slots for efficient allocation
- Each process owns one <code>filedesc</code>, inherited from parent on fork()</p>
<h4 id="thread-local-caching-td_fdcache">Thread-local Caching (<code>td_fdcache</code>)<a class="headerlink" href="#thread-local-caching-td_fdcache" title="Permanent link">¶</a></h4>
<p>Each thread maintains a small cache to avoid expensive reference counting:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">thread</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">td_fdcache</span><span class="p">[</span><span class="n">NFDCACHE</span><span class="p">];</span><span class="w">  </span><span class="cm">/* Cached file pointers */</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="c1">// NFDCACHE = 16</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Cache modes</strong> (stored in low bits of pointer):
- <strong>Mode 0:</strong> Available slot, no reference held
- <strong>Mode 1:</strong> Locked (transitional state during lookup)
- <strong>Mode 2:</strong> Borrowed reference (can reuse without atomic inc/dec)</p>
<p>The cache dramatically improves performance for frequently used file descriptors (e.g., stdin/stdout/stderr).</p>
<h3 id="file-descriptor-allocation">File Descriptor Allocation<a class="headerlink" href="#file-descriptor-allocation" title="Permanent link">¶</a></h3>
<h4 id="binary-tree-algorithm-fdalloc_locked">Binary Tree Algorithm (<code>fdalloc_locked</code>)<a class="headerlink" href="#binary-tree-algorithm-fdalloc_locked" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_descrip.c:839-1064</code></p>
<p>File descriptor slots are organized as a binary tree for O(log n) allocation:</p>
<pre class="mermaid"><code>flowchart TB
    HINT["fd_freefile (hint)"]
    LEFT["left subtree"]
    RIGHT["right subtree"]

    HINT --&gt; LEFT
    HINT --&gt; RIGHT
</code></pre>
<p><strong>Key functions:</strong>
- <code>right_subtree_size(fd, nfiles)</code> — size of right subtree at fd
- <code>right_ancestor(fd, nfiles)</code> — next right ancestor in tree
- <code>left_ancestor(fd, nfiles)</code> — next left ancestor in tree</p>
<p><strong>Allocation logic:</strong>
1. Start at <code>fd_freefile</code> (last known free)
2. If slot free, allocate immediately
3. Otherwise, traverse tree using right_ancestor/left_ancestor
4. On failure, grow <code>fd_files[]</code> array</p>
<h4 id="growing-the-descriptor-table">Growing the Descriptor Table<a class="headerlink" href="#growing-the-descriptor-table" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_descrip.c:1066-1227</code></p>
<p>When the table is full:
1. Calculate new size: <code>nfiles + max(nfiles/8, 15) + 3</code>
2. Allocate new array (M_FILEDESC)
3. Copy old entries
4. Free old array
5. Update <code>fd_nfiles</code></p>
<p>The growth strategy balances memory overhead with reallocation frequency.</p>
<h3 id="file-descriptor-operations">File Descriptor Operations<a class="headerlink" href="#file-descriptor-operations" title="Permanent link">¶</a></h3>
<h4 id="fgetreadfgetwritefget"><code>fgetread</code>/<code>fgetwrite</code>/<code>fget</code><a class="headerlink" href="#fgetreadfgetwritefget" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_descrip.c:1492-1650</code></p>
<p>Retrieve file pointer for descriptor <code>fd</code>:</p>
<ol>
<li><strong>Check cache:</strong> Look in <code>td_fdcache[]</code> first</li>
<li><strong>Fallback:</strong> If not cached, search <code>fd_files[]</code></li>
<li><strong>Validate:</strong> Check bounds, NULL, and file type (read/write)</li>
<li><strong>Reference:</strong> Increment <code>f_count</code> (borrowed ref avoids this)</li>
<li><strong>Cache:</strong> Store in <code>td_fdcache[]</code> as mode 2 (borrowed)</li>
</ol>
<p><strong>Borrowed references:</strong> Cache entries hold refs without atomic ops, dramatically improving hot-path performance.</p>
<h4 id="fdrop-release-file-reference"><code>fdrop</code> — Release File Reference<a class="headerlink" href="#fdrop-release-file-reference" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_descrip.c:2128-2217</code></p>
<p>Decrement <code>f_count</code>; if zero, close file:</p>
<ol>
<li>Atomic decrement of <code>f_count</code></li>
<li>If non-zero, return</li>
<li>If zero:</li>
<li>Call <code>fo_close()</code> (file operations close)</li>
<li>Call <code>fdrevoke()</code> to invalidate all cached refs</li>
<li>Free file structure</li>
</ol>
<p><strong>Locking:</strong> Uses per-file <code>f_spin</code> spinlock for atomicity.</p>
<h4 id="dupdup2fcntlf_dupfd"><code>dup</code>/<code>dup2</code>/<code>fcntl(F_DUPFD)</code><a class="headerlink" href="#dupdup2fcntlf_dupfd" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_descrip.c:299-447</code></p>
<p>Duplicate file descriptor:</p>
<ul>
<li><strong><code>dup(old)</code></strong> — allocate lowest free fd, copy file pointer</li>
<li><strong><code>dup2(old, new)</code></strong> — force specific fd, close <code>new</code> if open</li>
<li><strong><code>fcntl(F_DUPFD, minfd)</code></strong> — allocate fd &gt;= minfd</li>
</ul>
<p><strong>Flags:</strong>
- <code>DUP_FIXED</code> — dup2 behavior (specific fd)
- <code>DUP_VARIABLE</code> — dup behavior (any free fd)
- <code>DUP_CLOEXEC</code> — set close-on-exec flag</p>
<p><strong>Cache invalidation:</strong> <code>fclearcache()</code> clears all thread caches when closing or revoking.</p>
<h3 id="file-descriptor-limits">File Descriptor Limits<a class="headerlink" href="#file-descriptor-limits" title="Permanent link">¶</a></h3>
<p>Source: <code>kern_descrip.c:1229-1333</code></p>
<p>Two limits apply:</p>
<ol>
<li><strong>Per-process:</strong> <code>RLIMIT_NOFILE</code> (default 1024, hard max 1,048,576)</li>
<li><strong>Per-user:</strong> <code>maxfilesperuser</code> (default 80% of system max)</li>
</ol>
<p><strong>Enforcement:</strong>
- <code>fdalloc()</code> checks both limits before allocation
- <code>chgproccnt()</code> updates per-user <code>ui_proccnt</code> counter (via uidinfo)
- <code>chgopenfiles()</code> updates per-user <code>ui_openfiles</code> counter</p>
<p><strong>System-wide limit:</strong> <code>maxfiles</code> (global sysctl, default computed from RAM).</p>
<h3 id="file-descriptor-revocation-fdrevoke">File Descriptor Revocation (<code>fdrevoke</code>)<a class="headerlink" href="#file-descriptor-revocation-fdrevoke" title="Permanent link">¶</a></h3>
<p>Source: <code>kern_descrip.c:2219-2339</code></p>
<p>Invalidate all references to a file:</p>
<ol>
<li>Mark file with <code>FREVOKED</code> flag</li>
<li>Iterate all processes' file descriptor tables</li>
<li>For each match, set <code>FREVOKED</code> in <code>fd_files[]</code></li>
<li>Call <code>fclearcache()</code> to purge thread caches</li>
<li>Wake sleeping threads (select/poll)</li>
</ol>
<p><strong>Use case:</strong> Device revocation (e.g., USB device unplugged).</p>
<hr/>
<h2 id="resource-limits-kern_plimitc">Resource Limits (<code>kern_plimit.c</code>)<a class="headerlink" href="#resource-limits-kern_plimitc" title="Permanent link">¶</a></h2>
<h3 id="data-structures_1">Data Structures<a class="headerlink" href="#data-structures_1" title="Permanent link">¶</a></h3>
<h4 id="struct-plimit"><code>struct plimit</code><a class="headerlink" href="#struct-plimit" title="Permanent link">¶</a></h4>
<p>Process resource limits:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">plimit</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rlimit</span><span class="w"> </span><span class="n">pl_rlimit</span><span class="p">[</span><span class="n">RLIM_NLIMITS</span><span class="p">];</span><span class="w"> </span><span class="cm">/* Limit array */</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pl_refcnt</span><span class="p">;</span><span class="w">                          </span><span class="cm">/* Reference count */</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pl_flags</span><span class="p">;</span><span class="w">                      </span><span class="cm">/* Flags */</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="p">};</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="cp">#define PLIMITF_EXCLUSIVE  0x00000001  </span><span class="cm">/* Private copy (multi-threaded) */</span>
</code></pre></div>
<p><strong>Limit types</strong> (subset of <code>RLIM_NLIMITS</code>):
- <code>RLIMIT_CPU</code> — CPU seconds (enforced in <code>kern_clock.c</code>)
- <code>RLIMIT_DATA</code> — Data segment size
- <code>RLIMIT_STACK</code> — Stack size
- <code>RLIMIT_CORE</code> — Core dump size
- <code>RLIMIT_NOFILE</code> — Open files per process
- <code>RLIMIT_VMEM</code> — Virtual memory
- <code>RLIMIT_NPROC</code> — Processes per user
- <code>RLIMIT_SBSIZE</code> — Socket buffer space per user</p>
<p>Each limit has soft (<code>rlim_cur</code>) and hard (<code>rlim_max</code>) values.</p>
<h3 id="copy-on-write-semantics">Copy-on-Write Semantics<a class="headerlink" href="#copy-on-write-semantics" title="Permanent link">¶</a></h3>
<p>Source: <code>kern_plimit.c:105-212</code></p>
<p>Process limits are shared across fork() using reference counting:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>   parent fork → child
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>      ↓              ↓
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>   plimit ← pl_refcnt = 2
</code></pre></div>
<p><strong><code>plimit_fork(struct plimit *olimit)</code></strong></p>
<p>Called during fork():
1. If <code>PLIMITF_EXCLUSIVE</code> set → allocate private copy
2. Otherwise → increment <code>pl_refcnt</code>, share with child</p>
<p><strong><code>plimit_lwp_fork(struct plimit *olimit)</code></strong></p>
<p>Called when creating LWPs (multi-threaded process):
1. Always allocate private copy
2. Set <code>PLIMITF_EXCLUSIVE</code> flag
3. Return new exclusive limit structure</p>
<p><strong>Rationale:</strong> Multi-threaded processes need private limits to avoid races when multiple LWPs modify limits simultaneously.</p>
<h3 id="limit-modification">Limit Modification<a class="headerlink" href="#limit-modification" title="Permanent link">¶</a></h3>
<h4 id="plimit_modify"><code>plimit_modify</code><a class="headerlink" href="#plimit_modify" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_plimit.c:233-289</code></p>
<p>Atomically modify a limit:</p>
<ol>
<li>If <code>pl_refcnt &gt; 1</code> → allocate private copy (copy-on-write)</li>
<li>Set <code>PLIMITF_EXCLUSIVE</code> if process has LWPs</li>
<li>Update limit value</li>
<li>Release old limit structure</li>
</ol>
<p><strong>Locking:</strong> Uses process token (<code>&amp;p-&gt;p_token</code>) for atomicity.</p>
<h4 id="dosetrlimit"><code>dosetrlimit</code><a class="headerlink" href="#dosetrlimit" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_plimit.c:291-444</code></p>
<p>System call handler for <code>setrlimit()</code>:</p>
<ol>
<li>Validate new limits (soft ≤ hard)</li>
<li>Check permissions (non-root can only lower hard limit)</li>
<li>Call <code>plimit_modify()</code> to update</li>
<li>Special handling:</li>
<li><code>RLIMIT_NOFILE</code> — update <code>maxfilesperproc</code> cache</li>
<li><code>RLIMIT_STACK</code> — call <code>vm_map_growstack()</code> to adjust stack</li>
<li><code>RLIMIT_CPU</code> — update <code>p_cpulimit</code> (in microseconds)</li>
</ol>
<p><strong>Permission check:</strong> Raising hard limits requires superuser privilege.</p>
<h3 id="fork-depth-adjustment-plimit_getadjvalue">Fork Depth Adjustment (<code>plimit_getadjvalue</code>)<a class="headerlink" href="#fork-depth-adjustment-plimit_getadjvalue" title="Permanent link">¶</a></h3>
<p>Source: <code>kern_plimit.c:446-493</code></p>
<p>Adjust limits based on chroot depth:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">plimit_getadjvalue</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chroot_visible_vnodes</span><span class="p">.</span><span class="n">depth</span><span class="p">;</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 10% per chroot level */</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="c1">// Max 50% reduction</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Rationale:</strong> Nested chroot environments (e.g., jails within jails) get progressively reduced limits to prevent resource exhaustion.</p>
<h3 id="cpu-limit-enforcement">CPU Limit Enforcement<a class="headerlink" href="#cpu-limit-enforcement" title="Permanent link">¶</a></h3>
<p>The CPU limit is enforced in <code>kern_clock.c:statclock()</code>:</p>
<ol>
<li>Each clock tick, check <code>p-&gt;p_cpulimit</code></li>
<li>If exceeded, send <code>SIGXCPU</code> signal</li>
<li>If grace period exceeded, send <code>SIGKILL</code></li>
</ol>
<p>The limit is stored in <strong>microseconds</strong> (<code>p_cpulimit</code>) for efficient comparison.</p>
<hr/>
<h2 id="resource-accounting-kern_resourcec">Resource Accounting (<code>kern_resource.c</code>)<a class="headerlink" href="#resource-accounting-kern_resourcec" title="Permanent link">¶</a></h2>
<h3 id="priority-management">Priority Management<a class="headerlink" href="#priority-management" title="Permanent link">¶</a></h3>
<h4 id="three-priority-types">Three Priority Types<a class="headerlink" href="#three-priority-types" title="Permanent link">¶</a></h4>
<ol>
<li><strong>Nice priority</strong> (<code>p_nice</code>) — CPU scheduling priority (-20 to +20)</li>
<li><strong>I/O priority</strong> (<code>p_ionice</code>) — Disk I/O priority (0 to 20)</li>
<li><strong>Real-time priority</strong> (<code>lwp_rtprio</code>) — Real-time scheduling class</li>
</ol>
<p>Each type is independent and affects different schedulers.</p>
<h4 id="getprioritysetpriority"><code>getpriority</code>/<code>setpriority</code><a class="headerlink" href="#getprioritysetpriority" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:84-244</code></p>
<p>Adjust nice value:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">setpriority</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">which</span><span class="p">,</span><span class="w"> </span><span class="kt">id_t</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="c1">// which: PRIO_PROCESS, PRIO_PGRP, PRIO_USER</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="c1">// prio: PRIO_MIN (-20) to PRIO_MAX (+20)</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Effects:</strong>
1. Update <code>p-&gt;p_nice</code>
2. Call <code>p-&gt;p_usched-&gt;resetpriority(lp)</code> for each LWP
3. Reschedule threads with new priority</p>
<p><strong>Permission:</strong> Non-root can only increase nice (lower priority).</p>
<h4 id="ioprio_getioprio_set"><code>ioprio_get</code>/<code>ioprio_set</code><a class="headerlink" href="#ioprio_getioprio_set" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:246-386</code></p>
<p>Adjust I/O priority:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ioprio_set</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">which</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="c1">// prio: IOPRIO_MIN (0) to IOPRIO_MAX (20)</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Effects:</strong>
1. Update <code>p-&gt;p_ionice</code>
2. Affects disk scheduler (dsched) I/O ordering</p>
<p><strong>Use case:</strong> Deprioritize background tasks (e.g., backups).</p>
<h4 id="rtpriolwp_rtprio"><code>rtprio</code>/<code>lwp_rtprio</code><a class="headerlink" href="#rtpriolwp_rtprio" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:388-594</code></p>
<p>Real-time priority control:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">rtprio</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">   </span><span class="cm">/* RTP_PRIO_REALTIME, NORMAL, IDLE, FIFO */</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">prio</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 0-31 */</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Classes:</strong>
- <code>RTP_PRIO_REALTIME</code> — Hard real-time (requires <code>SYSCAP_NOSCHED</code>)
- <code>RTP_PRIO_FIFO</code> — FIFO scheduling
- <code>RTP_PRIO_NORMAL</code> — Time-sharing
- <code>RTP_PRIO_IDLE</code> — Run only when idle</p>
<p><strong>Permission:</strong> Real-time classes require <code>SYSCAP_NOSCHED</code> capability.</p>
<h3 id="cpu-time-accounting">CPU Time Accounting<a class="headerlink" href="#cpu-time-accounting" title="Permanent link">¶</a></h3>
<h4 id="calcru-calculate-resource-usage"><code>calcru</code> — Calculate Resource Usage<a class="headerlink" href="#calcru-calculate-resource-usage" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:655-743</code></p>
<p>Convert tick counters to timeval:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">calcru</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">lwp</span><span class="w"> </span><span class="o">*</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="o">*</span><span class="n">up</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="c1">// Convert td_uticks → up (user time)</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="c1">// Convert td_sticks → sp (system time)</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Tick sources:</strong>
- <code>td_uticks</code> — User-mode microseconds (updated in statclock)
- <code>td_sticks</code> — Kernel-mode microseconds (updated in statclock)
- <code>td_iticks</code> — Interrupt microseconds</p>
<p><strong>Algorithm:</strong>
1. Read tick counters atomically
2. Convert ticks to timeval using <code>sys_cputimer-&gt;freq</code>
3. Handle wraparound and monotonicity</p>
<h4 id="calcru_proc-aggregate-process-usage"><code>calcru_proc</code> — Aggregate Process Usage<a class="headerlink" href="#calcru_proc-aggregate-process-usage" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:745-819</code></p>
<p>Sum all LWP statistics into process rusage:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">calcru_proc</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">rusage</span><span class="w"> </span><span class="o">*</span><span class="n">ru</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="n">FOREACH_LWP_IN_PROC</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">        </span><span class="n">calcru</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">utv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stv</span><span class="p">);</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">        </span><span class="n">timeradd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_utime</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">utv</span><span class="p">);</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">        </span><span class="n">timeradd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_stime</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stv</span><span class="p">);</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Aggregated fields:</strong>
- <code>ru_utime</code> — Total user CPU time
- <code>ru_stime</code> — Total system CPU time
- <code>ru_minflt</code> — Minor page faults
- <code>ru_majflt</code> — Major page faults
- <code>ru_inblock</code> — Block input operations
- <code>ru_oublock</code> — Block output operations</p>
<h4 id="getrusage-system-call"><code>getrusage</code> System Call<a class="headerlink" href="#getrusage-system-call" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:821-922</code></p>
<p>Retrieve resource usage:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">getrusage</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">rusage</span><span class="w"> </span><span class="o">*</span><span class="n">rusage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="c1">// who: RUSAGE_SELF, RUSAGE_CHILDREN</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>RUSAGE_SELF:</strong> Returns current process usage (via <code>calcru_proc</code>).</p>
<p><strong>RUSAGE_CHILDREN:</strong> Returns accumulated child usage from <code>p-&gt;p_cru</code> (updated in <code>kern_exit.c:wait1()</code> when reaping children).</p>
<h3 id="per-user-resource-tracking-uidinfo">Per-User Resource Tracking (<code>uidinfo</code>)<a class="headerlink" href="#per-user-resource-tracking-uidinfo" title="Permanent link">¶</a></h3>
<h4 id="struct-uidinfo"><code>struct uidinfo</code><a class="headerlink" href="#struct-uidinfo" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:66-82</code></p>
<p>Per-user accounting structure:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">uidinfo</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">ui_uid</span><span class="p">;</span><span class="w">           </span><span class="cm">/* User ID */</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ui_ref</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Reference count */</span>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ui_proccnt</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Process count */</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ui_openfiles</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Open file count */</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ui_sbsize</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Socket buffer bytes */</span>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="c1">// Hashed in uidinfo_hash</span>
<a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Use cases:</strong>
- Enforce <code>RLIMIT_NPROC</code> (processes per user)
- Enforce <code>maxfilesperuser</code> (open files per user)
- Enforce <code>RLIMIT_SBSIZE</code> (socket buffer space per user)</p>
<h4 id="chgproccntchgsbsize"><code>chgproccnt</code>/<code>chgsbsize</code><a class="headerlink" href="#chgproccntchgsbsize" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_resource.c:1038-1103</code></p>
<p>Atomically adjust per-user counters:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">chgproccnt</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">uidinfo</span><span class="w"> </span><span class="o">*</span><span class="n">uip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="c1">// Returns 0 if within limit, 1 if exceeded</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="p">}</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">chgsbsize</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">uidinfo</span><span class="w"> </span><span class="o">*</span><span class="n">uip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">hiwat</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="c1">// Adjust socket buffer size tracking</span>
<a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Atomicity:</strong> Uses <code>atomic_fetchadd_int()</code> for lock-free updates.</p>
<p><strong>Callers:</strong>
- <code>fork()</code> → <code>chgproccnt(uip, 1, maxproc)</code>
- <code>exit()</code> → <code>chgproccnt(uip, -1, 0)</code>
- <code>socket()</code> → <code>chgsbsize()</code> for buffer allocation</p>
<hr/>
<h2 id="credentials-kern_protc">Credentials (<code>kern_prot.c</code>)<a class="headerlink" href="#credentials-kern_protc" title="Permanent link">¶</a></h2>
<h3 id="data-structures_2">Data Structures<a class="headerlink" href="#data-structures_2" title="Permanent link">¶</a></h3>
<h4 id="struct-ucred"><code>struct ucred</code><a class="headerlink" href="#struct-ucred" title="Permanent link">¶</a></h4>
<p>Process credentials:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cr_ref</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Reference count */</span>
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">cr_uid</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Effective user ID */</span>
<a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">cr_ruid</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Real user ID */</span>
<a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">cr_svuid</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Saved user ID */</span>
<a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">cr_gid</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Effective group ID */</span>
<a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">cr_rgid</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Real group ID */</span>
<a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">cr_svgid</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Saved group ID */</span>
<a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">cr_groups</span><span class="p">[</span><span class="n">NGROUPS</span><span class="p">];</span><span class="w">  </span><span class="cm">/* Supplementary groups */</span>
<a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cr_ngroups</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Group count */</span>
<a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">prison</span><span class="w"> </span><span class="o">*</span><span class="n">cr_prison</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Jail info */</span>
<a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">    </span><span class="c1">// ... capabilities, labels, etc.</span>
<a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="p">};</span>
</code></pre></div>
<p><strong>Special credentials:</strong>
- <code>NOCRED</code> — No credential (internal use)
- <code>FSCRED</code> — Filesystem credential (never freed)</p>
<h3 id="atomic-copy-on-write-cratom">Atomic Copy-on-Write (<code>cratom</code>)<a class="headerlink" href="#atomic-copy-on-write-cratom" title="Permanent link">¶</a></h3>
<p>Source: <code>kern_prot.c:113-177</code></p>
<p>Ensure exclusive credential before modification:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="o">*</span><span class="n">cratom</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="o">**</span><span class="n">cr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">cr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cr_ref</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">        </span><span class="c1">// Shared → allocate private copy</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="o">*</span><span class="n">ncr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crdup</span><span class="p">(</span><span class="o">*</span><span class="n">cr</span><span class="p">);</span>
<a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">        </span><span class="n">crfree</span><span class="p">(</span><span class="o">*</span><span class="n">cr</span><span class="p">);</span>
<a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">        </span><span class="o">*</span><span class="n">cr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncr</span><span class="p">;</span>
<a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="n">cr</span><span class="p">;</span>
<a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Why copy-on-write?</strong>
- Credentials are shared across fork() and threads
- Modification requires atomicity (no races)
- Copy-on-write avoids unnecessary duplication</p>
<h4 id="cratom_proc"><code>cratom_proc</code><a class="headerlink" href="#cratom_proc" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:179-209</code></p>
<p>Process-level atomization:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="o">*</span><span class="n">cratom_proc</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_ucred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cratom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_ucred</span><span class="p">);</span>
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_ucred</span><span class="p">;</span>
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Locking:</strong> Uses process token (<code>&amp;p-&gt;p_token</code>) for atomicity.</p>
<h3 id="uidgid-system-calls">UID/GID System Calls<a class="headerlink" href="#uidgid-system-calls" title="Permanent link">¶</a></h3>
<h4 id="getuidgeteuidgetgidgetegid"><code>getuid</code>/<code>geteuid</code>/<code>getgid</code>/<code>getegid</code><a class="headerlink" href="#getuidgeteuidgetgidgetegid" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:211-279</code></p>
<p>Retrieve credentials:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kt">uid_t</span><span class="w"> </span><span class="nf">getuid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">curthread</span><span class="o">-&gt;</span><span class="n">td_ucred</span><span class="o">-&gt;</span><span class="n">cr_ruid</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kt">uid_t</span><span class="w"> </span><span class="nf">geteuid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">curthread</span><span class="o">-&gt;</span><span class="n">td_ucred</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p><strong>Thread vs. process credentials:</strong>
- Threads cache <code>td_ucred</code> (pointer to <code>p-&gt;p_ucred</code>)
- Always consistent due to copy-on-write semantics</p>
<h4 id="setuidseteuid"><code>setuid</code>/<code>seteuid</code><a class="headerlink" href="#setuidseteuid" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:281-457</code></p>
<p>Change user ID:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">setuid</span><span class="p">(</span><span class="kt">uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">    </span><span class="c1">// POSIX_APPENDIX_B_4_2_2 semantics</span>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Semantics (POSIX_APPENDIX_B_4_2_2):</strong></p>
<p>For non-superuser:
- Can set euid to ruid or svuid only</p>
<p>For superuser:
- Sets all three: ruid, euid, svuid</p>
<p><strong>Implementation:</strong>
1. Call <code>cratom_proc()</code> to get exclusive credential
2. Update uid fields
3. Call <code>change_euid()</code> to transfer uidinfo
4. Mark process as <code>P_SUGID</code> (tainted)</p>
<h4 id="change_euidchange_ruid"><code>change_euid</code>/<code>change_ruid</code><a class="headerlink" href="#change_euidchange_ruid" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:459-550</code></p>
<p>Helper functions to change UID with uidinfo transfer:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">change_euid</span><span class="p">(</span><span class="kt">uid_t</span><span class="w"> </span><span class="n">euid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uidinfo</span><span class="w"> </span><span class="o">*</span><span class="n">new_uip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uifind</span><span class="p">(</span><span class="n">euid</span><span class="p">);</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="n">uireplace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_ucred</span><span class="o">-&gt;</span><span class="n">cr_uidinfo</span><span class="p">,</span><span class="w"> </span><span class="n">new_uip</span><span class="p">);</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="c1">// Transfer lock file ownership, etc.</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="p">}</span>
</code></pre></div>
<p><strong>uidinfo management:</strong>
- <code>uifind(uid)</code> — Lookup or create uidinfo (refcounted)
- <code>uireplace()</code> — Atomically swap uidinfo pointers
- <code>uihold()</code>/<code>uidrop()</code> — Reference counting</p>
<p><strong>Lock file adjustment:</strong> <code>lf_count_adjust()</code> transfers file lock ownership.</p>
<h4 id="setreuidsetregid"><code>setreuid</code>/<code>setregid</code><a class="headerlink" href="#setreuidsetregid" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:552-751</code></p>
<p>Set real and effective IDs simultaneously:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">setreuid</span><span class="p">(</span><span class="kt">uid_t</span><span class="w"> </span><span class="n">ruid</span><span class="p">,</span><span class="w"> </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">euid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="c1">// Allows swapping ruid ↔ euid (for setuid programs)</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Use case:</strong> Temporarily drop privileges (swap euid and ruid), perform operation, then restore.</p>
<h4 id="setresuidsetresgid"><code>setresuid</code>/<code>setresgid</code><a class="headerlink" href="#setresuidsetresgid" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:753-988</code></p>
<p>Set real, effective, and saved IDs:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">setresuid</span><span class="p">(</span><span class="kt">uid_t</span><span class="w"> </span><span class="n">ruid</span><span class="p">,</span><span class="w"> </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">euid</span><span class="p">,</span><span class="w"> </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">suid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">    </span><span class="c1">// Fine-grained control over all three IDs</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Advantage:</strong> Provides explicit control over saved UID (needed for some security models).</p>
<h4 id="setgroupsgetgroups"><code>setgroups</code>/<code>getgroups</code><a class="headerlink" href="#setgroupsgetgroups" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:990-1120</code></p>
<p>Manage supplementary groups:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">setgroups</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ngroups</span><span class="p">,</span><span class="w"> </span><span class="kt">gid_t</span><span class="w"> </span><span class="o">*</span><span class="n">groups</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">    </span><span class="c1">// Requires superuser privilege</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Limit:</strong> <code>NGROUPS</code> (typically 16-64 depending on configuration).</p>
<h3 id="permission-checking">Permission Checking<a class="headerlink" href="#permission-checking" title="Permanent link">¶</a></h3>
<h4 id="p_trespass"><code>p_trespass</code><a class="headerlink" href="#p_trespass" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:1256-1332</code></p>
<p>Check if process A can signal/ptrace process B:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">p_trespass</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="o">*</span><span class="n">cr1</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucred</span><span class="w"> </span><span class="o">*</span><span class="n">cr2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="c1">// Returns 0 if allowed, errno otherwise</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Rules:</strong>
1. Root can always signal others
2. Same uid → allowed
3. Same ruid and target not setuid → allowed
4. Otherwise → EPERM</p>
<p><strong>Security:</strong> Prevents unprivileged processes from interfering with setuid processes.</p>
<h3 id="processsessiongroup-ids">Process/Session/Group IDs<a class="headerlink" href="#processsessiongroup-ids" title="Permanent link">¶</a></h3>
<h4 id="getpidgetppid"><code>getpid</code>/<code>getppid</code><a class="headerlink" href="#getpidgetppid" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:1415-1478</code></p>
<p>Retrieve process/parent IDs:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kt">pid_t</span><span class="w"> </span><span class="nf">getpid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">curproc</span><span class="o">-&gt;</span><span class="n">p_pid</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="kt">pid_t</span><span class="w"> </span><span class="nf">getppid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">curproc</span><span class="o">-&gt;</span><span class="n">p_pptr</span><span class="o">-&gt;</span><span class="n">p_pid</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<h4 id="setsid-create-new-session"><code>setsid</code> — Create New Session<a class="headerlink" href="#setsid-create-new-session" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:1532-1597</code></p>
<p>Become session leader:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kt">pid_t</span><span class="w"> </span><span class="nf">setsid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">    </span><span class="c1">// Create new session and process group</span>
<a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Effects:</strong>
1. Allocate new session ID (equal to pid)
2. Allocate new process group ID (equal to pid)
3. Detach from controlling terminal
4. Become session leader</p>
<p><strong>Restrictions:</strong> Cannot be called by process group leader.</p>
<h4 id="setpgid-set-process-group"><code>setpgid</code> — Set Process Group<a class="headerlink" href="#setpgid-set-process-group" title="Permanent link">¶</a></h4>
<p>Source: <code>kern_prot.c:1599-1749</code></p>
<p>Change process group membership:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">setpgid</span><span class="p">(</span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pgid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">    </span><span class="c1">// Move process to different process group</span>
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Restrictions:</strong>
1. Can only set own pgid or child's pgid before exec
2. Target must be in same session
3. Cannot move across session boundaries</p>
<h3 id="credential-tainting-setsugid">Credential Tainting (<code>setsugid</code>)<a class="headerlink" href="#credential-tainting-setsugid" title="Permanent link">¶</a></h3>
<p>Source: <code>kern_prot.c:1751-1784</code></p>
<p>Mark process as tainted (changed credentials):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">setsugid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">P_SUGID</span><span class="p">;</span>
<a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Effects:</strong>
- Disables core dumps (security)
- Disables ptrace attachment
- Prevents privilege escalation exploits</p>
<p><strong>Callers:</strong>
- <code>setuid()</code>, <code>setgid()</code> — after changing credentials
- <code>execve()</code> — when executing setuid binary</p>
<hr/>
<h2 id="interactions-between-subsystems">Interactions Between Subsystems<a class="headerlink" href="#interactions-between-subsystems" title="Permanent link">¶</a></h2>
<h3 id="file-descriptors-resource-limits">File Descriptors → Resource Limits<a class="headerlink" href="#file-descriptors-resource-limits" title="Permanent link">¶</a></h3>
<p><code>fdalloc()</code> checks <code>RLIMIT_NOFILE</code> before allocating:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_rlimit</span><span class="p">[</span><span class="n">RLIMIT_NOFILE</span><span class="p">].</span><span class="n">rlim_cur</span><span class="p">)</span>
<a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EMFILE</span><span class="p">;</span>
</code></pre></div>
<h3 id="file-descriptors-credentials">File Descriptors → Credentials<a class="headerlink" href="#file-descriptors-credentials" title="Permanent link">¶</a></h3>
<p>File operations use <code>td_ucred</code> for permission checks:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VOP_READ</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">uio</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_ucred</span><span class="p">);</span>
</code></pre></div>
<h3 id="resource-limits-fork">Resource Limits → Fork<a class="headerlink" href="#resource-limits-fork" title="Permanent link">¶</a></h3>
<p><code>fork()</code> checks <code>RLIMIT_NPROC</code> before creating child:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chgproccnt</span><span class="p">(</span><span class="n">uip</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_rlimit</span><span class="p">[</span><span class="n">RLIMIT_NPROC</span><span class="p">].</span><span class="n">rlim_cur</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EAGAIN</span><span class="p">;</span>
</code></pre></div>
<h3 id="credentials-uidinfo">Credentials → uidinfo<a class="headerlink" href="#credentials-uidinfo" title="Permanent link">¶</a></h3>
<p>Changing UID transfers uidinfo:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="n">change_euid</span><span class="p">(</span><span class="n">new_uid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">    </span><span class="n">uireplace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">cr_uidinfo</span><span class="p">,</span><span class="w"> </span><span class="n">uifind</span><span class="p">(</span><span class="n">new_uid</span><span class="p">));</span>
<a href="#__codelineno-30-3" id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="p">}</span>
</code></pre></div>
<p>This updates per-user resource tracking atomically.</p>
<hr/>
<h2 id="key-design-principles">Key Design Principles<a class="headerlink" href="#key-design-principles" title="Permanent link">¶</a></h2>
<h3 id="1-copy-on-write-for-sharing">1. Copy-on-Write for Sharing<a class="headerlink" href="#1-copy-on-write-for-sharing" title="Permanent link">¶</a></h3>
<p>Both <code>plimit</code> and <code>ucred</code> use reference counting with copy-on-write:</p>
<ul>
<li>Cheap sharing across fork()</li>
<li>Atomic modification when needed</li>
<li>No races in multi-threaded processes</li>
</ul>
<h3 id="2-thread-local-caching">2. Thread-Local Caching<a class="headerlink" href="#2-thread-local-caching" title="Permanent link">¶</a></h3>
<p>File descriptor cache (<code>td_fdcache</code>) avoids expensive atomic operations:</p>
<ul>
<li>16-entry cache per thread</li>
<li>Borrowed references (mode 2) skip refcount ops</li>
<li>Cache coherency via <code>fclearcache()</code></li>
</ul>
<h3 id="3-per-user-resource-tracking">3. Per-User Resource Tracking<a class="headerlink" href="#3-per-user-resource-tracking" title="Permanent link">¶</a></h3>
<p><code>uidinfo</code> provides global accounting per user:</p>
<ul>
<li>Prevents single user from exhausting system resources</li>
<li>Enforced atomically with <code>chgproccnt</code>/<code>chgsbsize</code></li>
<li>Hashed for efficient lookup</li>
</ul>
<h3 id="4-binary-tree-allocation">4. Binary Tree Allocation<a class="headerlink" href="#4-binary-tree-allocation" title="Permanent link">¶</a></h3>
<p>File descriptor allocation uses binary tree traversal:</p>
<ul>
<li>O(log n) allocation even with sparse tables</li>
<li>Efficient reuse of low-numbered descriptors</li>
<li>Minimizes table growth</li>
</ul>
<h3 id="5-limit-enforcement-points">5. Limit Enforcement Points<a class="headerlink" href="#5-limit-enforcement-points" title="Permanent link">¶</a></h3>
<p>Resource limits are enforced at allocation points:</p>
<ul>
<li><code>RLIMIT_NOFILE</code> — in <code>fdalloc()</code></li>
<li><code>RLIMIT_NPROC</code> — in <code>fork()</code></li>
<li><code>RLIMIT_CPU</code> — in <code>statclock()</code> (kern_clock.c)</li>
<li><code>RLIMIT_STACK</code> — in <code>vm_map_growstack()</code> (sys/vm)</li>
</ul>
<hr/>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">¶</a></h2>
<p>Process resource management in DragonFly BSD provides:</p>
<ol>
<li><strong>Efficient file descriptor management</strong> with thread-local caching and binary tree allocation</li>
<li><strong>Copy-on-write resource limits</strong> shared across fork() with atomic modification</li>
<li><strong>Multi-level priority control</strong> (nice, ionice, rtprio) for CPU and I/O scheduling</li>
<li><strong>Atomic credential management</strong> with POSIX semantics and per-user accounting</li>
<li><strong>System-wide resource tracking</strong> preventing exhaustion attacks</li>
</ol>
<p>The design emphasizes:
- <strong>Atomicity</strong> through copy-on-write and tokens
- <strong>Performance</strong> through caching and lock-free algorithms
- <strong>Isolation</strong> through per-user limits and permission checks
- <strong>Scalability</strong> through efficient data structures (binary tree, hash tables)</p>
<p>These subsystems interact closely with process lifecycle (fork/exec/exit), virtual filesystem (file operations), and virtual memory (stack limits), forming the foundation of resource management in the kernel.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>