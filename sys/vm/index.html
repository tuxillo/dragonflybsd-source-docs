
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive documentation for the DragonFly BSD kernel source code">
      
      
        <meta name="author" content="DragonFly BSD Community">
      
      
      
        <link rel="prev" href="../kern/syscalls/">
      
      
        <link rel="next" href="../cpu/x86_64/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Overview - DragonFly BSD Kernel Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#virtual-memory-subsystem" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Overview
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Kernel Subsystems

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" aria-label="DragonFly BSD Kernel Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DragonFly BSD Kernel Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/lwkt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/synchronization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/time/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Time & Timers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/initialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Initialization & Bootstrap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/processes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processes & Threads
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Resources & Credentials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/signals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2_11" >
        
          
          <label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/namecache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Name Lookup & Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/mounting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mounting & Unmounting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/buffer-cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Buffer Cache & I/O
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/vfs-operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/journaling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/vfs-locking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vnode Locking & Lifecycle
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/vfs/vfs-extensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VFS Extensions & Helpers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2_12" >
        
          
          <label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    IPC & Sockets
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    IPC & Sockets
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/mbufs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/sockets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/unix-sockets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/protocol-dispatch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/pipes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/mqueue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/sysv-msg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/sysv-sem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/ipc/sysv-shm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Devices & Drivers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/newbus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/bus-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bus Resources & DMA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/disk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kern/syscalls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Data Structures
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Data Structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vm_page-vm_pageh181" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_page (vm_page.h:181)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_object-vm_objecth136" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_object (vm_object.h:136)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_map-vm_maph337" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_map (vm_map.h:337)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_map_entry-vm_maph224" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_map_entry (vm_map.h:224)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_map_backing-vm_maph170" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_map_backing (vm_map.h:170)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#page-queues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Queues
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page Queues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#page-coloring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Coloring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#page-fault-handling-vm_faultc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Fault Handling (vm_fault.c)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page Fault Handling (vm_fault.c)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fast-path-vm_fault_bypass" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fast Path (vm_fault_bypass)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-on-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        Copy-on-Write
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pager-interface-vm_pagerh" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pager Interface (vm_pager.h)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pager Interface (vm_pager.h)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pager-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pager Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pager-return-values" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pager Return Values
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pageout-daemon-vm_pageoutc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pageout Daemon (vm_pageout.c)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pageout Daemon (vm_pageout.c)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#page-activity-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Activity Tracking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-thresholds-vm_page2h" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Thresholds (vm_page2.h)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-memory-allocation-vm_kernc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kernel Memory Allocation (vm_kern.c)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmspace-vm_maph370" class="md-nav__link">
    <span class="md-ellipsis">
      
        vmspace (vm_map.h:370)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protection-and-inheritance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protection and Inheritance
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Protection and Inheritance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protection-flags-vmh" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protection Flags (vm.h)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inheritance-modes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inheritance Modes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#smp-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        SMP Considerations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#source-files" class="md-nav__link">
    <span class="md-ellipsis">
      
        Source Files
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Documentation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpu/x86_64/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Data Structures
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Data Structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vm_page-vm_pageh181" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_page (vm_page.h:181)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_object-vm_objecth136" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_object (vm_object.h:136)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_map-vm_maph337" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_map (vm_map.h:337)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_map_entry-vm_maph224" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_map_entry (vm_map.h:224)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vm_map_backing-vm_maph170" class="md-nav__link">
    <span class="md-ellipsis">
      
        vm_map_backing (vm_map.h:170)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#page-queues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Queues
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page Queues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#page-coloring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Coloring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#page-fault-handling-vm_faultc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Fault Handling (vm_fault.c)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page Fault Handling (vm_fault.c)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fast-path-vm_fault_bypass" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fast Path (vm_fault_bypass)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-on-write" class="md-nav__link">
    <span class="md-ellipsis">
      
        Copy-on-Write
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pager-interface-vm_pagerh" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pager Interface (vm_pager.h)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pager Interface (vm_pager.h)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pager-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pager Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pager-return-values" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pager Return Values
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pageout-daemon-vm_pageoutc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pageout Daemon (vm_pageout.c)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pageout Daemon (vm_pageout.c)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#page-activity-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Page Activity Tracking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-thresholds-vm_page2h" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Thresholds (vm_page2.h)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-memory-allocation-vm_kernc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kernel Memory Allocation (vm_kern.c)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmspace-vm_maph370" class="md-nav__link">
    <span class="md-ellipsis">
      
        vmspace (vm_map.h:370)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protection-and-inheritance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protection and Inheritance
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Protection and Inheritance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protection-flags-vmh" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protection Flags (vm.h)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inheritance-modes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inheritance Modes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#smp-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        SMP Considerations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#source-files" class="md-nav__link">
    <span class="md-ellipsis">
      
        Source Files
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Documentation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="virtual-memory-subsystem">Virtual Memory Subsystem<a class="headerlink" href="#virtual-memory-subsystem" title="Permanent link">&para;</a></h1>
<p>The DragonFly BSD virtual memory subsystem manages virtual address spaces,
physical memory allocation, paging, and swap.  It derives from the Mach VM
architecture as adopted by BSD but has been extensively modified by Matthew
Dillon for better SMP scalability and LWKT integration.</p>
<h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>                    +-------------------+
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>                    |     vm_map        |  Virtual address space
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                    |  (vm_map_entry)   |
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                    +--------+----------+
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                             |
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                    +--------v----------+
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                    |  vm_map_backing   |  Backing store chain
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                    +--------+----------+
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                             |
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                    +--------v----------+
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                    |    vm_object      |  Container for pages
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                    +--------+----------+
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                             |
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>              +--------------+--------------+
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>              |              |              |
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>       +------v------+ +-----v------+ +-----v------+
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>       |   vm_page   | |  vm_page   | |  vm_page   |
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>       | (resident)  | | (resident) | | (swapped)  |
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>       +-------------+ +------------+ +-----+------+
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                                            |
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                                     +------v------+
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                                     | swap_pager  |
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                                     +-------------+
</code></pre></div>
<h2 id="key-data-structures">Key Data Structures<a class="headerlink" href="#key-data-structures" title="Permanent link">&para;</a></h2>
<h3 id="vm_page-vm_pageh181">vm_page (vm_page.h:181)<a class="headerlink" href="#vm_page-vm_pageh181" title="Permanent link">&para;</a></h3>
<p>The <code>vm_page</code> structure represents a single physical page of memory.  Each
page is 128 bytes (consuming about 3.125% overhead for 4KB pages) and
contains:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pageq</code></td>
<td>Links page into one of the page queues</td>
</tr>
<tr>
<td><code>rb_entry</code></td>
<td>Red-black tree entry for object lookup</td>
</tr>
<tr>
<td><code>spin</code></td>
<td>Per-page spinlock for queue operations</td>
</tr>
<tr>
<td><code>wire_count</code></td>
<td>Number of wired references</td>
</tr>
<tr>
<td><code>busy_count</code></td>
<td>Soft-busy and hard-busy state</td>
</tr>
<tr>
<td><code>hold_count</code></td>
<td>Temporary hold preventing free</td>
</tr>
<tr>
<td><code>object</code></td>
<td>Owning vm_object</td>
</tr>
<tr>
<td><code>pindex</code></td>
<td>Page index within object</td>
</tr>
<tr>
<td><code>phys_addr</code></td>
<td>Physical address</td>
</tr>
<tr>
<td><code>queue</code></td>
<td>Current queue (PQ_FREE, PQ_ACTIVE, etc.)</td>
</tr>
<tr>
<td><code>valid</code></td>
<td>Bitmask of valid DEV_BSIZE chunks</td>
</tr>
<tr>
<td><code>dirty</code></td>
<td>Bitmask of dirty DEV_BSIZE chunks</td>
</tr>
<tr>
<td><code>flags</code></td>
<td>Page state flags (PG_MAPPED, PG_WRITEABLE, etc.)</td>
</tr>
</tbody>
</table>
<p><strong>Page Busy States</strong></p>
<p>Pages use a combined busy_count field with embedded flags:</p>
<ul>
<li><code>PBUSY_LOCKED</code> (0x80000000) - Hard-busied, exclusive access</li>
<li><code>PBUSY_WANTED</code> (0x40000000) - Someone waiting for the page</li>
<li><code>PBUSY_SWAPINPROG</code> (0x20000000) - Swap I/O in progress</li>
<li><code>PBUSY_MASK</code> (0x1FFFFFFF) - Soft-busy reference count</li>
</ul>
<p>A page must be hard-busied to change <code>object</code>, <code>pindex</code>, <code>valid</code>, or
to transition <code>wire_count</code> to/from zero.</p>
<h3 id="vm_object-vm_objecth136">vm_object (vm_object.h:136)<a class="headerlink" href="#vm_object-vm_objecth136" title="Permanent link">&para;</a></h3>
<p>A <code>vm_object</code> is a container that holds a set of pages indexed by
<code>pindex</code> (page index).  Objects can be backed by various pagers:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OBJT_DEFAULT</code></td>
<td>Anonymous memory (zero-fill on demand)</td>
</tr>
<tr>
<td><code>OBJT_SWAP</code></td>
<td>Swap-backed anonymous memory</td>
</tr>
<tr>
<td><code>OBJT_VNODE</code></td>
<td>File-backed pages</td>
</tr>
<tr>
<td><code>OBJT_DEVICE</code></td>
<td>Device memory mappings</td>
</tr>
<tr>
<td><code>OBJT_MGTDEVICE</code></td>
<td>Managed device pages</td>
</tr>
<tr>
<td><code>OBJT_PHYS</code></td>
<td>Direct physical memory</td>
</tr>
<tr>
<td><code>OBJT_DEAD</code></td>
<td>Destroyed object</td>
</tr>
</tbody>
</table>
<p>Key fields:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_object</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lwkt_token</span><span class="w"> </span><span class="n">token</span><span class="p">;</span><span class="w">        </span><span class="cm">/* soft-lock for object */</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock</span><span class="w"> </span><span class="n">backing_lk</span><span class="p">;</span><span class="w">         </span><span class="cm">/* lock for backing_list */</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_page_rb_tree</span><span class="w"> </span><span class="n">rb_memq</span><span class="p">;</span><span class="w"> </span><span class="cm">/* resident pages (red-black tree) */</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">               </span><span class="cm">/* object size in pages */</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ref_count</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* reference count */</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="n">objtype_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* pager type */</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="n">u_short</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* OBJ_* flags */</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">resident_page_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* pages in memory */</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">handle</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* vnode, device, etc. */</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">swblock_rb_tree</span><span class="w"> </span><span class="n">swblock_root</span><span class="p">;</span><span class="w"> </span><span class="cm">/* swap block tree */</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="p">};</span>
</code></pre></div>
<p>Objects are soft-locked via their <code>token</code> field using LWKT tokens,
allowing other threads to make progress during blocking operations.</p>
<p><strong>Object Flags</strong></p>
<ul>
<li><code>OBJ_ACTIVE</code> - Object is on the active list</li>
<li><code>OBJ_DEAD</code> - Object is being destroyed</li>
<li><code>OBJ_WRITEABLE</code> - Has been mapped writable</li>
<li><code>OBJ_MIGHTBEDIRTY</code> - May contain dirty pages</li>
<li><code>OBJ_ONEMAPPING</code> - At most one mapping per page index</li>
</ul>
<h3 id="vm_map-vm_maph337">vm_map (vm_map.h:337)<a class="headerlink" href="#vm_map-vm_maph337" title="Permanent link">&para;</a></h3>
<p>A <code>vm_map</code> represents a virtual address space.  The kernel has a single
<code>kernel_map</code>, while each process has its own map within a <code>vmspace</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w">               </span><span class="cm">/* map lock */</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_rb_tree</span><span class="w"> </span><span class="n">rb_root</span><span class="p">;</span><span class="w">  </span><span class="cm">/* map entries (red-black tree) */</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">min_addr</span><span class="p">;</span><span class="w">           </span><span class="cm">/* minimum valid address */</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">max_addr</span><span class="p">;</span><span class="w">           </span><span class="cm">/* maximum valid address */</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nentries</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* number of entries */</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span><span class="w">         </span><span class="cm">/* version for change detection */</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="n">vm_size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* virtual size */</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="n">u_char</span><span class="w"> </span><span class="n">system_map</span><span class="p">;</span><span class="w">              </span><span class="cm">/* kernel map flag */</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pmap</span><span class="w"> </span><span class="o">*</span><span class="n">pmap</span><span class="p">;</span><span class="w">              </span><span class="cm">/* hardware page tables */</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="p">};</span>
</code></pre></div>
<h3 id="vm_map_entry-vm_maph224">vm_map_entry (vm_map.h:224)<a class="headerlink" href="#vm_map_entry-vm_maph224" title="Permanent link">&para;</a></h3>
<p>Each region in a vm_map is described by a <code>vm_map_entry</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_entry</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="n">RB_ENTRY</span><span class="p">(</span><span class="n">vm_map_entry</span><span class="p">)</span><span class="w"> </span><span class="n">rb_entry</span><span class="p">;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="nc">vm_map_aux</span><span class="w"> </span><span class="n">aux</span><span class="p">;</span><span class="w">           </span><span class="cm">/* stack size, device, etc. */</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="n">ba</span><span class="p">;</span><span class="w">       </span><span class="cm">/* backing store chain */</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="n">vm_eflags_t</span><span class="w"> </span><span class="n">eflags</span><span class="p">;</span><span class="w">             </span><span class="cm">/* MAP_ENTRY_* flags */</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="n">vm_maptype_t</span><span class="w"> </span><span class="n">maptype</span><span class="p">;</span><span class="w">           </span><span class="cm">/* NORMAL, SUBMAP, UKSMAP */</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">protection</span><span class="p">;</span><span class="w">           </span><span class="cm">/* current protection */</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">max_protection</span><span class="p">;</span><span class="w">       </span><span class="cm">/* maximum allowed protection */</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="n">vm_inherit_t</span><span class="w"> </span><span class="n">inheritance</span><span class="p">;</span><span class="w">       </span><span class="cm">/* fork behavior */</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">wired_count</span><span class="p">;</span><span class="w">                </span><span class="cm">/* wire reference count */</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="p">};</span>
</code></pre></div>
<h3 id="vm_map_backing-vm_maph170">vm_map_backing (vm_map.h:170)<a class="headerlink" href="#vm_map_backing-vm_maph170" title="Permanent link">&para;</a></h3>
<p>The <code>vm_map_backing</code> structure chains backing stores for copy-on-write:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">              </span><span class="cm">/* start address in pmap */</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w">                </span><span class="cm">/* end address in pmap */</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pmap</span><span class="w"> </span><span class="o">*</span><span class="n">pmap</span><span class="p">;</span><span class="w">              </span><span class="cm">/* physical map */</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="o">*</span><span class="n">backing_ba</span><span class="p">;</span><span class="w"> </span><span class="cm">/* next in chain */</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_object</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="p">;</span><span class="w">   </span><span class="cm">/* normal backing */</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map</span><span class="w"> </span><span class="o">*</span><span class="n">sub_map</span><span class="p">;</span><span class="w">     </span><span class="cm">/* submap */</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">uksmap</span><span class="p">)(...);</span><span class="w">         </span><span class="cm">/* user-kernel shared map */</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="n">vm_ooffset_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w">            </span><span class="cm">/* offset into object */</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="p">};</span>
</code></pre></div>
<h2 id="page-queues">Page Queues<a class="headerlink" href="#page-queues" title="Permanent link">&para;</a></h2>
<p>Pages are organized into queues based on their state.  DragonFly uses
page coloring with 1024 sub-queues per major queue for cache optimization
and reduced lock contention:</p>
<table>
<thead>
<tr>
<th>Queue</th>
<th>Constant</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Free</td>
<td><code>PQ_FREE</code></td>
<td>Available for immediate allocation</td>
</tr>
<tr>
<td>Inactive</td>
<td><code>PQ_INACTIVE</code></td>
<td>Candidates for reclamation (LRU)</td>
</tr>
<tr>
<td>Active</td>
<td><code>PQ_ACTIVE</code></td>
<td>Recently referenced pages</td>
</tr>
<tr>
<td>Cache</td>
<td><code>PQ_CACHE</code></td>
<td>Clean pages, quickly reclaimable</td>
</tr>
<tr>
<td>Hold</td>
<td><code>PQ_HOLD</code></td>
<td>Temporarily held pages</td>
</tr>
</tbody>
</table>
<p>Queue operations require both the page's spinlock (<code>m-&gt;spin</code>) and the
queue's spinlock.  The pageout daemon has special permission to reorder
pages within a queue holding only the queue lock.</p>
<h3 id="page-coloring">Page Coloring<a class="headerlink" href="#page-coloring" title="Permanent link">&para;</a></h3>
<p>Page coloring spreads allocations across CPU cache sets:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="cp">#define PQ_L2_SIZE 1024     </span><span class="cm">/* sub-queues per major queue */</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="cp">#define PQ_L2_MASK (PQ_L2_SIZE - 1)</span>
</code></pre></div>
<p>This allows 4-way set associativity with up to 256 CPUs while reducing
lock contention on SMP systems.</p>
<h2 id="page-fault-handling-vm_faultc">Page Fault Handling (vm_fault.c)<a class="headerlink" href="#page-fault-handling-vm_faultc" title="Permanent link">&para;</a></h2>
<p>The <code>vm_fault()</code> function handles page faults:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>vm_fault(map, vaddr, fault_type, fault_flags)
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    |
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    +-- vm_map_lookup() - Find map entry and backing object
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    |
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    +-- vm_fault_bypass() - Try lockless fast path
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    |       |
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    |       +-- vm_page_hash_get() - Get page if already active
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    |
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    +-- vm_fault_object() - Full fault processing
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>            |
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>            +-- Allocate page if needed
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>            +-- Call pager if page not resident
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>            +-- Handle copy-on-write
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>            +-- pmap_enter() - Install mapping
</code></pre></div>
<h3 id="fast-path-vm_fault_bypass">Fast Path (vm_fault_bypass)<a class="headerlink" href="#fast-path-vm_fault_bypass" title="Permanent link">&para;</a></h3>
<p>For common cases where the page is already resident and active,
<code>vm_fault_bypass()</code> can resolve the fault without acquiring any
object locks:</p>
<ol>
<li>Look up page via hash table with only soft-busy</li>
<li>Verify page is valid, active, and not swapped</li>
<li>For writes, verify object is already writable and page dirty</li>
<li>Install pmap mapping and return</li>
</ol>
<p>This significantly improves performance for shared mappings like
libraries.</p>
<h3 id="copy-on-write">Copy-on-Write<a class="headerlink" href="#copy-on-write" title="Permanent link">&para;</a></h3>
<p>When a writable mapping needs COW:</p>
<ol>
<li>Allocate new page in the first (shadow) object</li>
<li>Copy contents from backing object's page</li>
<li>Mark new page dirty</li>
<li>Update pmap to point to new page</li>
</ol>
<p>The <code>vm_map_backing</code> chain handles the object hierarchy.</p>
<h2 id="pager-interface-vm_pagerh">Pager Interface (vm_pager.h)<a class="headerlink" href="#pager-interface-vm_pagerh" title="Permanent link">&para;</a></h2>
<p>Pagers provide backing store for vm_objects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">pagerops</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="n">pgo_dealloc_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgo_dealloc</span><span class="p">;</span><span class="w">     </span><span class="cm">/* destroy pager */</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="n">pgo_getpage_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgo_getpage</span><span class="p">;</span><span class="w">     </span><span class="cm">/* read page from backing store */</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="n">pgo_putpages_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgo_putpages</span><span class="p">;</span><span class="w">   </span><span class="cm">/* write pages to backing store */</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="n">pgo_haspage_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgo_haspage</span><span class="p">;</span><span class="w">     </span><span class="cm">/* check if page exists */</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">};</span>
</code></pre></div>
<h3 id="pager-types">Pager Types<a class="headerlink" href="#pager-types" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Pager</th>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td><code>default_pager.c</code></td>
<td>Zero-fill pages (OBJT_DEFAULT)</td>
</tr>
<tr>
<td>swap</td>
<td><code>swap_pager.c</code></td>
<td>Swap device I/O</td>
</tr>
<tr>
<td>vnode</td>
<td><code>vnode_pager.c</code></td>
<td>File-backed I/O</td>
</tr>
<tr>
<td>device</td>
<td><code>device_pager.c</code></td>
<td>Device memory mapping</td>
</tr>
<tr>
<td>phys</td>
<td><code>phys_pager.c</code></td>
<td>Direct physical pages</td>
</tr>
</tbody>
</table>
<h3 id="pager-return-values">Pager Return Values<a class="headerlink" href="#pager-return-values" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>VM_PAGER_OK</code></td>
<td>Operation successful</td>
</tr>
<tr>
<td><code>VM_PAGER_BAD</code></td>
<td>Invalid request</td>
</tr>
<tr>
<td><code>VM_PAGER_FAIL</code></td>
<td>Data doesn't exist</td>
</tr>
<tr>
<td><code>VM_PAGER_PEND</code></td>
<td>I/O initiated, not complete</td>
</tr>
<tr>
<td><code>VM_PAGER_ERROR</code></td>
<td>I/O error</td>
</tr>
<tr>
<td><code>VM_PAGER_AGAIN</code></td>
<td>Temporary resource shortage</td>
</tr>
</tbody>
</table>
<h2 id="pageout-daemon-vm_pageoutc">Pageout Daemon (vm_pageout.c)<a class="headerlink" href="#pageout-daemon-vm_pageoutc" title="Permanent link">&para;</a></h2>
<p>The pageout daemon (<code>vm_pageout</code>) reclaims memory when free pages
fall below thresholds.  DragonFly uses a tiered threshold system:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>reserved &lt; severe &lt; minimum &lt; wait &lt; start &lt; target1 &lt; target2
</code></pre></div>
<table>
<thead>
<tr>
<th>Threshold</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>v_free_reserved</code></td>
<td>Only interrupt allocations allowed</td>
</tr>
<tr>
<td><code>v_free_severe</code></td>
<td>User processes stall</td>
</tr>
<tr>
<td><code>v_free_min</code></td>
<td>Normal faults block, pageout active</td>
</tr>
<tr>
<td><code>v_paging_wait</code></td>
<td>Nice-based throttling</td>
</tr>
<tr>
<td><code>v_paging_start</code></td>
<td>Pageout daemon starts</td>
</tr>
<tr>
<td><code>v_paging_target1</code></td>
<td>Pageout works hard</td>
</tr>
<tr>
<td><code>v_paging_target2</code></td>
<td>Pageout takes it easy</td>
</tr>
</tbody>
</table>
<p>The daemon:</p>
<ol>
<li>Scans inactive queue for clean pages to free</li>
<li>Writes dirty pages to backing store</li>
<li>Moves pages from active to inactive based on <code>act_count</code></li>
<li>Uses per-CPU statistics to avoid cache-line bouncing</li>
</ol>
<h3 id="page-activity-tracking">Page Activity Tracking<a class="headerlink" href="#page-activity-tracking" title="Permanent link">&para;</a></h3>
<p>Each page has an <code>act_count</code> (0-64) tracking recent usage:</p>
<ul>
<li><code>ACT_INIT</code> (5) - Initial value for new pages</li>
<li><code>ACT_ADVANCE</code> (3) - Added on reference</li>
<li><code>ACT_DECLINE</code> (1) - Subtracted during scans</li>
</ul>
<p>Pages move active -&gt; inactive when <code>act_count</code> drops sufficiently.</p>
<h2 id="memory-thresholds-vm_page2h">Memory Thresholds (vm_page2.h)<a class="headerlink" href="#memory-thresholds-vm_page2h" title="Permanent link">&para;</a></h2>
<p>Inline functions check memory pressure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">vm_paging_severe</span><span class="p">()</span><span class="w">  </span><span class="cm">/* User processes should stall */</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">vm_paging_min</span><span class="p">()</span><span class="w">     </span><span class="cm">/* Normal faults should block */</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">vm_paging_wait</span><span class="p">()</span><span class="w">    </span><span class="cm">/* Allocations should slow down */</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">vm_paging_start</span><span class="p">()</span><span class="w">   </span><span class="cm">/* Pageout daemon should run */</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">vm_paging_target1</span><span class="p">()</span><span class="w"> </span><span class="cm">/* Below initial target */</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="n">vm_paging_target2</span><span class="p">()</span><span class="w"> </span><span class="cm">/* Below final target */</span>
</code></pre></div>
<p>These use per-CPU cached statistics (<code>gd-&gt;gd_vmstats</code>) to avoid
global cache-line bouncing on the hot path.</p>
<h2 id="kernel-memory-allocation-vm_kernc">Kernel Memory Allocation (vm_kern.c)<a class="headerlink" href="#kernel-memory-allocation-vm_kernc" title="Permanent link">&para;</a></h2>
<p>Kernel memory allocation functions:</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kmem_alloc()</code></td>
<td>Allocate wired kernel memory</td>
</tr>
<tr>
<td><code>kmem_alloc3()</code></td>
<td>With flags (KM_STACK, etc.)</td>
</tr>
<tr>
<td><code>kmem_alloc_wait()</code></td>
<td>Block until memory available</td>
</tr>
<tr>
<td><code>kmem_alloc_attr()</code></td>
<td>With physical address constraints</td>
</tr>
<tr>
<td><code>kmem_free()</code></td>
<td>Free kernel memory</td>
</tr>
<tr>
<td><code>kmem_suballoc()</code></td>
<td>Create sub-map from parent</td>
</tr>
</tbody>
</table>
<h2 id="vmspace-vm_maph370">vmspace (vm_map.h:370)<a class="headerlink" href="#vmspace-vm_maph370" title="Permanent link">&para;</a></h2>
<p>Process address spaces are managed via <code>vmspace</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vmspace</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map</span><span class="w"> </span><span class="n">vm_map</span><span class="p">;</span><span class="w">       </span><span class="cm">/* the address map */</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pmap</span><span class="w"> </span><span class="n">vm_pmap</span><span class="p">;</span><span class="w">        </span><span class="cm">/* private physical map */</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">vm_shm</span><span class="p">;</span><span class="w">             </span><span class="cm">/* SysV shared memory */</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">segsz_t</span><span class="w"> </span><span class="n">vm_tsize</span><span class="p">;</span><span class="w">           </span><span class="cm">/* text size (bytes) */</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="n">segsz_t</span><span class="w"> </span><span class="n">vm_dsize</span><span class="p">;</span><span class="w">           </span><span class="cm">/* data size (bytes) */</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="n">segsz_t</span><span class="w"> </span><span class="n">vm_ssize</span><span class="p">;</span><span class="w">           </span><span class="cm">/* stack size (bytes) */</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">vm_taddr</span><span class="p">;</span><span class="w">           </span><span class="cm">/* text address */</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">vm_daddr</span><span class="p">;</span><span class="w">           </span><span class="cm">/* data address */</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">vm_maxsaddr</span><span class="p">;</span><span class="w">        </span><span class="cm">/* max stack address */</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="p">};</span>
</code></pre></div>
<p>Key operations:</p>
<ul>
<li><code>vmspace_alloc()</code> - Create new address space</li>
<li><code>vmspace_fork()</code> - Fork address space (COW)</li>
<li><code>vmspace_exec()</code> - Replace address space on exec</li>
<li><code>vmspace_free()</code> - Destroy address space</li>
</ul>
<h2 id="protection-and-inheritance">Protection and Inheritance<a class="headerlink" href="#protection-and-inheritance" title="Permanent link">&para;</a></h2>
<h3 id="protection-flags-vmh">Protection Flags (vm.h)<a class="headerlink" href="#protection-flags-vmh" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="cp">#define VM_PROT_NONE     0x00</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="cp">#define VM_PROT_READ     0x01</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="cp">#define VM_PROT_WRITE    0x02</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="cp">#define VM_PROT_EXECUTE  0x04</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="cp">#define VM_PROT_OVERRIDE_WRITE  0x08  </span><span class="cm">/* Force COW */</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="cp">#define VM_PROT_NOSYNC   0x10         </span><span class="cm">/* Don&#39;t sync dirty bit */</span>
</code></pre></div>
<h3 id="inheritance-modes">Inheritance Modes<a class="headerlink" href="#inheritance-modes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="cp">#define VM_INHERIT_SHARE    0  </span><span class="cm">/* Share mapping with child */</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="cp">#define VM_INHERIT_COPY     1  </span><span class="cm">/* Copy-on-write (default) */</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="cp">#define VM_INHERIT_NONE     2  </span><span class="cm">/* Don&#39;t inherit */</span>
</code></pre></div>
<h2 id="smp-considerations">SMP Considerations<a class="headerlink" href="#smp-considerations" title="Permanent link">&para;</a></h2>
<p>The VM subsystem uses several locking strategies for SMP scalability:</p>
<ol>
<li><strong>LWKT Tokens</strong> - Soft locks on vm_objects allowing blocking</li>
<li><strong>Spinlocks</strong> - Per-page and per-queue spinlocks</li>
<li><strong>Per-CPU Statistics</strong> - Cached vmstats avoid global contention</li>
<li><strong>Page Coloring</strong> - Reduces queue lock contention</li>
<li><strong>Shared Faults</strong> - <code>vm_shared_fault</code> enables shared object locks</li>
</ol>
<p>The <code>vm_fault_bypass()</code> fast path can resolve faults with no locks at
all for pages already in the active queue.</p>
<h2 id="source-files">Source Files<a class="headerlink" href="#source-files" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Lines</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vm_fault.c</code></td>
<td>~2,600</td>
<td>Page fault handling</td>
</tr>
<tr>
<td><code>vm_map.c</code></td>
<td>~3,800</td>
<td>Address space management</td>
</tr>
<tr>
<td><code>vm_object.c</code></td>
<td>~1,400</td>
<td>VM object management</td>
</tr>
<tr>
<td><code>vm_page.c</code></td>
<td>~3,300</td>
<td>Physical page management</td>
</tr>
<tr>
<td><code>vm_pageout.c</code></td>
<td>~2,400</td>
<td>Page daemon and reclamation</td>
</tr>
<tr>
<td><code>swap_pager.c</code></td>
<td>~2,000</td>
<td>Swap I/O</td>
</tr>
<tr>
<td><code>vnode_pager.c</code></td>
<td>~700</td>
<td>File-backed I/O</td>
</tr>
<tr>
<td><code>vm_kern.c</code></td>
<td>~500</td>
<td>Kernel memory allocation</td>
</tr>
<tr>
<td><code>vm_mmap.c</code></td>
<td>~1,100</td>
<td>mmap() implementation</td>
</tr>
<tr>
<td><code>vm_zone.c</code></td>
<td>~700</td>
<td>Zone allocator</td>
</tr>
</tbody>
</table>
<h2 id="related-documentation">Related Documentation<a class="headerlink" href="#related-documentation" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../kern/memory/">Memory Allocation</a> - kmalloc/objcache</li>
<li><a href="../kern/vfs/buffer-cache/">Buffer Cache</a> - Filesystem buffers</li>
<li><a href="../kern/processes/">Processes</a> - Process and vmspace lifecycle</li>
</ul>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><code>sys/vm/vm.h</code> - Core VM types and constants</li>
<li><code>sys/vm/vm_page.h</code> - Page structure and queues</li>
<li><code>sys/vm/vm_object.h</code> - Object structure</li>
<li><code>sys/vm/vm_map.h</code> - Map and entry structures</li>
<li><code>sys/vm/vm_pager.h</code> - Pager interface</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>