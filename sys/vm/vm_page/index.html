
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../concepts/" rel="prev"/>
<link href="../vm_object/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Physical Pages - DragonFly BSD Kernel Documentation</title>
<link href="../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#physical-page-management">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Physical Pages
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#why-physical-page-management-matters">
<span class="md-ellipsis">
      
        Why Physical Page Management Matters
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-life-of-a-page">
<span class="md-ellipsis">
      
        The Life of a Page
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-you-need-this">
<span class="md-ellipsis">
      
        When You Need This
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
<nav aria-label="Overview" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#key-design-principles">
<span class="md-ellipsis">
      
        Key Design Principles
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#why-five-queues">
<span class="md-ellipsis">
      
        Why Five Queues?
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-specific-design-choices">
<span class="md-ellipsis">
      
        DragonFly-Specific Design Choices
      
    </span>
</a>
<nav aria-label="DragonFly-Specific Design Choices" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1024-color-page-queues">
<span class="md-ellipsis">
      
        1024-Color Page Queues
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#atomic-busy-counts-vs-locks">
<span class="md-ellipsis">
      
        Atomic Busy Counts vs. Locks
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-cpu-statistics">
<span class="md-ellipsis">
      
        Per-CPU Statistics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#numa-aware-coloring">
<span class="md-ellipsis">
      
        NUMA-Aware Coloring
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nice-aware-paging-thresholds">
<span class="md-ellipsis">
      
        Nice-Aware Paging Thresholds
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#page-array">
<span class="md-ellipsis">
      
        Page Array
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-queues">
<span class="md-ellipsis">
      
        Page Queues
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-hash-table">
<span class="md-ellipsis">
      
        Page Hash Table
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#boot-time-initialization">
<span class="md-ellipsis">
      
        Boot-Time Initialization
      
    </span>
</a>
<nav aria-label="Boot-Time Initialization" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_startup">
<span class="md-ellipsis">
      
        vm_page_startup()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-color-calculation">
<span class="md-ellipsis">
      
        Page Color Calculation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#numa-organization">
<span class="md-ellipsis">
      
        NUMA Organization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dma-reserve">
<span class="md-ellipsis">
      
        DMA Reserve
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-allocation">
<span class="md-ellipsis">
      
        Page Allocation
      
    </span>
</a>
<nav aria-label="Page Allocation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_alloc">
<span class="md-ellipsis">
      
        vm_page_alloc()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cpu-localized-color-selection">
<span class="md-ellipsis">
      
        CPU-Localized Color Selection
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#queue-search-algorithm">
<span class="md-ellipsis">
      
        Queue Search Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#contiguous-allocation">
<span class="md-ellipsis">
      
        Contiguous Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#other-allocation-functions">
<span class="md-ellipsis">
      
        Other Allocation Functions
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-freeing">
<span class="md-ellipsis">
      
        Page Freeing
      
    </span>
</a>
<nav aria-label="Page Freeing" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_free_toq">
<span class="md-ellipsis">
      
        vm_page_free_toq()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#free-wakeup-logic">
<span class="md-ellipsis">
      
        Free Wakeup Logic
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-state-transitions">
<span class="md-ellipsis">
      
        Page State Transitions
      
    </span>
</a>
<nav aria-label="Page State Transitions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#activation">
<span class="md-ellipsis">
      
        Activation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deactivation">
<span class="md-ellipsis">
      
        Deactivation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#caching">
<span class="md-ellipsis">
      
        Caching
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#busy-state-management">
<span class="md-ellipsis">
      
        Busy State Management
      
    </span>
</a>
<nav aria-label="Busy State Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hard-busy-pbusy_locked">
<span class="md-ellipsis">
      
        Hard Busy (PBUSY_LOCKED)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#soft-busy-pbusy_mask">
<span class="md-ellipsis">
      
        Soft Busy (PBUSY_MASK)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#waiting">
<span class="md-ellipsis">
      
        Waiting
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wireunwire">
<span class="md-ellipsis">
      
        Wire/Unwire
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#holdunhold">
<span class="md-ellipsis">
      
        Hold/Unhold
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-lookup">
<span class="md-ellipsis">
      
        Page Lookup
      
    </span>
</a>
<nav aria-label="Page Lookup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#standard-lookup">
<span class="md-ellipsis">
      
        Standard Lookup
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup-busy">
<span class="md-ellipsis">
      
        Lookup + Busy
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fast-heuristic-lookup">
<span class="md-ellipsis">
      
        Fast Heuristic Lookup
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#validdirty-bit-management">
<span class="md-ellipsis">
      
        Valid/Dirty Bit Management
      
    </span>
</a>
<nav aria-label="Valid/Dirty Bit Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#functions">
<span class="md-ellipsis">
      
        Functions
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#memory-pressure-handling">
<span class="md-ellipsis">
      
        Memory Pressure Handling
      
    </span>
</a>
<nav aria-label="Memory Pressure Handling" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#waiting-functions">
<span class="md-ellipsis">
      
        Waiting Functions
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nice-aware-paging">
<span class="md-ellipsis">
      
        Nice-Aware Paging
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#low-memory-kill">
<span class="md-ellipsis">
      
        Low Memory Kill
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#madvise-support">
<span class="md-ellipsis">
      
        madvise Support
      
    </span>
</a>
<nav aria-label="madvise Support" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_dontneed">
<span class="md-ellipsis">
      
        vm_page_dontneed()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#special-page-types">
<span class="md-ellipsis">
      
        Special Page Types
      
    </span>
</a>
<nav aria-label="Special Page Types" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fictitious-pages">
<span class="md-ellipsis">
      
        Fictitious Pages
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pages-requiring-commit">
<span class="md-ellipsis">
      
        Pages Requiring Commit
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#locking-rules">
<span class="md-ellipsis">
      
        Locking Rules
      
    </span>
</a>
<nav aria-label="Locking Rules" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#queue-operations">
<span class="md-ellipsis">
      
        Queue Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-cpu-statistics_1">
<span class="md-ellipsis">
      
        Per-CPU Statistics
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-usage-patterns">
<span class="md-ellipsis">
      
        Common Usage Patterns
      
    </span>
</a>
<nav aria-label="Common Usage Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-1-page-fault-allocation">
<span class="md-ellipsis">
      
        Pattern 1: Page Fault Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-2-pageout-daemon-scanning">
<span class="md-ellipsis">
      
        Pattern 2: Pageout Daemon Scanning
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-3-driver-dma-buffer">
<span class="md-ellipsis">
      
        Pattern 3: Driver DMA Buffer
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-4-wiring-pages-for-io">
<span class="md-ellipsis">
      
        Pattern 4: Wiring Pages for I/O
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debugging">
<span class="md-ellipsis">
      
        Debugging
      
    </span>
</a>
<nav aria-label="Debugging" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ddb-commands">
<span class="md-ellipsis">
      
        DDB Commands
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctls">
<span class="md-ellipsis">
      
        Sysctls
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#further-reading">
<span class="md-ellipsis">
      
        Further Reading
      
    </span>
</a>
<nav aria-label="Further Reading" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-resources">
<span class="md-ellipsis">
      
        DragonFly Resources
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#external-resources">
<span class="md-ellipsis">
      
        External Resources
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#source-files">
<span class="md-ellipsis">
      
        Source Files
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer2/">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#why-physical-page-management-matters">
<span class="md-ellipsis">
      
        Why Physical Page Management Matters
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-life-of-a-page">
<span class="md-ellipsis">
      
        The Life of a Page
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-you-need-this">
<span class="md-ellipsis">
      
        When You Need This
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
<nav aria-label="Overview" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#key-design-principles">
<span class="md-ellipsis">
      
        Key Design Principles
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#why-five-queues">
<span class="md-ellipsis">
      
        Why Five Queues?
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-specific-design-choices">
<span class="md-ellipsis">
      
        DragonFly-Specific Design Choices
      
    </span>
</a>
<nav aria-label="DragonFly-Specific Design Choices" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1024-color-page-queues">
<span class="md-ellipsis">
      
        1024-Color Page Queues
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#atomic-busy-counts-vs-locks">
<span class="md-ellipsis">
      
        Atomic Busy Counts vs. Locks
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-cpu-statistics">
<span class="md-ellipsis">
      
        Per-CPU Statistics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#numa-aware-coloring">
<span class="md-ellipsis">
      
        NUMA-Aware Coloring
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nice-aware-paging-thresholds">
<span class="md-ellipsis">
      
        Nice-Aware Paging Thresholds
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#page-array">
<span class="md-ellipsis">
      
        Page Array
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-queues">
<span class="md-ellipsis">
      
        Page Queues
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-hash-table">
<span class="md-ellipsis">
      
        Page Hash Table
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#boot-time-initialization">
<span class="md-ellipsis">
      
        Boot-Time Initialization
      
    </span>
</a>
<nav aria-label="Boot-Time Initialization" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_startup">
<span class="md-ellipsis">
      
        vm_page_startup()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-color-calculation">
<span class="md-ellipsis">
      
        Page Color Calculation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#numa-organization">
<span class="md-ellipsis">
      
        NUMA Organization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dma-reserve">
<span class="md-ellipsis">
      
        DMA Reserve
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-allocation">
<span class="md-ellipsis">
      
        Page Allocation
      
    </span>
</a>
<nav aria-label="Page Allocation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_alloc">
<span class="md-ellipsis">
      
        vm_page_alloc()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cpu-localized-color-selection">
<span class="md-ellipsis">
      
        CPU-Localized Color Selection
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#queue-search-algorithm">
<span class="md-ellipsis">
      
        Queue Search Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#contiguous-allocation">
<span class="md-ellipsis">
      
        Contiguous Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#other-allocation-functions">
<span class="md-ellipsis">
      
        Other Allocation Functions
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-freeing">
<span class="md-ellipsis">
      
        Page Freeing
      
    </span>
</a>
<nav aria-label="Page Freeing" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_free_toq">
<span class="md-ellipsis">
      
        vm_page_free_toq()
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#free-wakeup-logic">
<span class="md-ellipsis">
      
        Free Wakeup Logic
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-state-transitions">
<span class="md-ellipsis">
      
        Page State Transitions
      
    </span>
</a>
<nav aria-label="Page State Transitions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#activation">
<span class="md-ellipsis">
      
        Activation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deactivation">
<span class="md-ellipsis">
      
        Deactivation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#caching">
<span class="md-ellipsis">
      
        Caching
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#busy-state-management">
<span class="md-ellipsis">
      
        Busy State Management
      
    </span>
</a>
<nav aria-label="Busy State Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#hard-busy-pbusy_locked">
<span class="md-ellipsis">
      
        Hard Busy (PBUSY_LOCKED)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#soft-busy-pbusy_mask">
<span class="md-ellipsis">
      
        Soft Busy (PBUSY_MASK)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#waiting">
<span class="md-ellipsis">
      
        Waiting
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wireunwire">
<span class="md-ellipsis">
      
        Wire/Unwire
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#holdunhold">
<span class="md-ellipsis">
      
        Hold/Unhold
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#page-lookup">
<span class="md-ellipsis">
      
        Page Lookup
      
    </span>
</a>
<nav aria-label="Page Lookup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#standard-lookup">
<span class="md-ellipsis">
      
        Standard Lookup
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lookup-busy">
<span class="md-ellipsis">
      
        Lookup + Busy
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fast-heuristic-lookup">
<span class="md-ellipsis">
      
        Fast Heuristic Lookup
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#validdirty-bit-management">
<span class="md-ellipsis">
      
        Valid/Dirty Bit Management
      
    </span>
</a>
<nav aria-label="Valid/Dirty Bit Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#functions">
<span class="md-ellipsis">
      
        Functions
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#memory-pressure-handling">
<span class="md-ellipsis">
      
        Memory Pressure Handling
      
    </span>
</a>
<nav aria-label="Memory Pressure Handling" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#waiting-functions">
<span class="md-ellipsis">
      
        Waiting Functions
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nice-aware-paging">
<span class="md-ellipsis">
      
        Nice-Aware Paging
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#low-memory-kill">
<span class="md-ellipsis">
      
        Low Memory Kill
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#madvise-support">
<span class="md-ellipsis">
      
        madvise Support
      
    </span>
</a>
<nav aria-label="madvise Support" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_page_dontneed">
<span class="md-ellipsis">
      
        vm_page_dontneed()
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#special-page-types">
<span class="md-ellipsis">
      
        Special Page Types
      
    </span>
</a>
<nav aria-label="Special Page Types" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fictitious-pages">
<span class="md-ellipsis">
      
        Fictitious Pages
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pages-requiring-commit">
<span class="md-ellipsis">
      
        Pages Requiring Commit
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#locking-rules">
<span class="md-ellipsis">
      
        Locking Rules
      
    </span>
</a>
<nav aria-label="Locking Rules" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#queue-operations">
<span class="md-ellipsis">
      
        Queue Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-cpu-statistics_1">
<span class="md-ellipsis">
      
        Per-CPU Statistics
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-usage-patterns">
<span class="md-ellipsis">
      
        Common Usage Patterns
      
    </span>
</a>
<nav aria-label="Common Usage Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-1-page-fault-allocation">
<span class="md-ellipsis">
      
        Pattern 1: Page Fault Allocation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-2-pageout-daemon-scanning">
<span class="md-ellipsis">
      
        Pattern 2: Pageout Daemon Scanning
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-3-driver-dma-buffer">
<span class="md-ellipsis">
      
        Pattern 3: Driver DMA Buffer
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-4-wiring-pages-for-io">
<span class="md-ellipsis">
      
        Pattern 4: Wiring Pages for I/O
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debugging">
<span class="md-ellipsis">
      
        Debugging
      
    </span>
</a>
<nav aria-label="Debugging" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ddb-commands">
<span class="md-ellipsis">
      
        DDB Commands
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctls">
<span class="md-ellipsis">
      
        Sysctls
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#further-reading">
<span class="md-ellipsis">
      
        Further Reading
      
    </span>
</a>
<nav aria-label="Further Reading" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-resources">
<span class="md-ellipsis">
      
        DragonFly Resources
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#external-resources">
<span class="md-ellipsis">
      
        External Resources
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#source-files">
<span class="md-ellipsis">
      
        Source Files
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="physical-page-management">Physical Page Management<a class="headerlink" href="#physical-page-management" title="Permanent link"></a></h1>
<p>This document describes DragonFly BSD's physical page management subsystem, implemented in <code>sys/vm/vm_page.c</code>. The subsystem manages all physical memory pages in the system, including allocation, freeing, queue management, and state transitions.</p>
<p><strong>Source file:</strong> <code>sys/vm/vm_page.c</code> (~4,200 lines)</p>
<hr/>
<h2 id="why-physical-page-management-matters">Why Physical Page Management Matters<a class="headerlink" href="#why-physical-page-management-matters" title="Permanent link"></a></h2>
<p>Physical memory is a finite resource that every process, the kernel, and the filesystem cache compete for. The page management subsystem is the arbiter of this competitionit decides which processes get memory, which pages stay resident, and which get evicted to disk.</p>
<p>Without sophisticated page management:</p>
<ul>
<li><strong>Lock contention</strong> would serialize all memory operations on multi-core systems</li>
<li><strong>Memory fragmentation</strong> would prevent allocation of contiguous regions for DMA</li>
<li><strong>Unfair allocation</strong> would let memory-hungry processes starve others</li>
<li><strong>Poor locality</strong> would cause cache misses as CPUs access remote NUMA memory</li>
</ul>
<p>DragonFly's page management addresses these with 1024-way queue coloring (reducing lock contention), NUMA-aware allocation (improving locality), and nice-aware paging thresholds (ensuring fairness).</p>
<hr/>
<h2 id="the-life-of-a-page">The Life of a Page<a class="headerlink" href="#the-life-of-a-page" title="Permanent link"></a></h2>
<p>Before diving into data structures, it helps to understand the typical journey of a physical page:</p>
<pre class="mermaid"><code>flowchart TB
    subgraph BIRTH["Birth"]
        BOOT["System boot"]
        FREE1["Page added to PQ_FREE queue"]
    end

    subgraph LIFE["Active Life"]
        ALLOC["vm_page_alloc() - Page assigned to object"]
        ACTIVE["PQ_ACTIVE - Recently used"]
        INACTIVE["PQ_INACTIVE - Aging, candidate for reclaim"]
    end

    subgraph DEATH["Reclamation"]
        CACHE["PQ_CACHE - Clean, unmapped, quickly reusable"]
        FREE2["PQ_FREE - Available again"]
    end

    BOOT --&gt; FREE1
    FREE1 --&gt;|"fault or explicit alloc"| ALLOC
    ALLOC --&gt; ACTIVE
    ACTIVE --&gt;|"not referenced recently"| INACTIVE
    INACTIVE --&gt;|"cleaned by pageout"| CACHE
    INACTIVE --&gt;|"referenced again"| ACTIVE
    CACHE --&gt;|"stolen for new alloc"| FREE2
    FREE2 --&gt;|"new fault"| ALLOC
</code></pre>
<p><strong>1. Birth (Boot):</strong> During system startup, <code>vm_page_startup()</code> creates a <code>struct vm_page</code> for every physical page and places them on <code>PQ_FREE</code> queues.</p>
<p><strong>2. Allocation:</strong> When a page fault occurs or the kernel needs memory, <code>vm_page_alloc()</code> pulls a page from <code>PQ_FREE</code>, associates it with a <code>vm_object</code>, and marks it busy while I/O loads its contents.</p>
<p><strong>3. Active Use:</strong> The page lives on <code>PQ_ACTIVE</code> while processes access it. Each access refreshes its "activity count," keeping it resident.</p>
<p><strong>4. Aging:</strong> If a page isn't accessed for a while, the pageout daemon moves it to <code>PQ_INACTIVE</code>. This is a "second chance"if accessed again, it returns to <code>PQ_ACTIVE</code>.</p>
<p><strong>5. Cleaning:</strong> If the page remains inactive and is dirty, the pageout daemon writes it to its backing store (swap or file). Now clean, it moves to <code>PQ_CACHE</code>.</p>
<p><strong>6. Reclamation:</strong> <code>PQ_CACHE</code> pages are still valid but unmapped. If memory pressure rises, they're the first victimsinstantly reusable without I/O. Otherwise, they may be reactivated if faulted again.</p>
<p><strong>7. Rebirth:</strong> Eventually the page returns to <code>PQ_FREE</code>, ready for a new allocation.</p>
<hr/>
<h2 id="when-you-need-this">When You Need This<a class="headerlink" href="#when-you-need-this" title="Permanent link"></a></h2>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Key Functions</th>
<th>Section</th>
</tr>
</thead>
<tbody>
<tr>
<td>Allocating a page during fault handling</td>
<td><code>vm_page_alloc()</code>, <code>vm_page_grab()</code></td>
<td><a href="#page-allocation">Page Allocation</a></td>
</tr>
<tr>
<td>Understanding why a page can't be freed</td>
<td>Wire count, hold count, busy state</td>
<td><a href="#wireunwire">Wire/Unwire</a>, <a href="#holdunhold">Hold</a>, <a href="#busy-state-management">Busy State</a></td>
</tr>
<tr>
<td>Implementing a new pager</td>
<td><code>vm_page_set_valid()</code>, <code>vm_page_dirty()</code></td>
<td><a href="#validdirty-bit-management">Valid/Dirty Bits</a></td>
</tr>
<tr>
<td>Debugging memory pressure issues</td>
<td>Page queues, vmstats</td>
<td><a href="#page-queues">Page Queues</a>, <a href="#memory-pressure-handling">Memory Pressure</a></td>
</tr>
<tr>
<td>Writing DMA-capable driver code</td>
<td><code>vm_page_alloc_contig()</code></td>
<td><a href="#contiguous-allocation">Contiguous Allocation</a></td>
</tr>
<tr>
<td>Understanding pageout victim selection</td>
<td>Queue transitions</td>
<td><a href="#page-state-transitions">Page State Transitions</a></td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link"></a></h2>
<p>Every physical page in the system is represented by a <code>struct vm_page</code> (128 bytes). These structures are stored in a global array (<code>vm_page_array</code>) and indexed by physical page number. The VM system organizes pages into multiple queues based on their state and uses sophisticated coloring and NUMA-aware algorithms to optimize memory locality.</p>
<h3 id="key-design-principles">Key Design Principles<a class="headerlink" href="#key-design-principles" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Principle</th>
<th>Problem Solved</th>
<th>DragonFly's Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Page coloring</strong></td>
<td>Lock contention on page queues</td>
<td>1024 sub-queues per queue type; each CPU typically hits different queues</td>
</tr>
<tr>
<td><strong>NUMA awareness</strong></td>
<td>Cross-socket memory latency</td>
<td>Color calculation incorporates socket/core topology</td>
</tr>
<tr>
<td><strong>Atomic busy state</strong></td>
<td>Lock overhead for page access</td>
<td>Busy counts instead of locks; soft-busy for shared access</td>
</tr>
<tr>
<td><strong>Per-CPU statistics</strong></td>
<td>Cache-line bouncing on global counters</td>
<td>Each CPU caches vmstats locally; periodic rollup to global</td>
</tr>
</tbody>
</table>
<h3 id="why-five-queues">Why Five Queues?<a class="headerlink" href="#why-five-queues" title="Permanent link"></a></h3>
<p>The five page queues implement a <strong>multi-stage replacement policy</strong> that balances responsiveness with efficiency:</p>
<table>
<thead>
<tr>
<th>Queue</th>
<th>Purpose</th>
<th>Why It Exists</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PQ_FREE</code></td>
<td>Immediately allocatable</td>
<td>Fast allocation without any cleanup needed</td>
</tr>
<tr>
<td><code>PQ_ACTIVE</code></td>
<td>Recently used pages</td>
<td>Protects working set from premature eviction</td>
</tr>
<tr>
<td><code>PQ_INACTIVE</code></td>
<td>Second-chance candidates</td>
<td>Gives pages time to be re-referenced before eviction</td>
</tr>
<tr>
<td><code>PQ_CACHE</code></td>
<td>Clean, valid, unmapped</td>
<td>Zero-cost reuse if same data needed; instant free otherwise</td>
</tr>
<tr>
<td><code>PQ_HOLD</code></td>
<td>Temporarily pinned</td>
<td>Prevents race conditions during sensitive operations</td>
</tr>
</tbody>
</table>
<p>This design avoids the pathological behavior of simpler schemes:
- Pure LRU would evict pages that happen to be accessed in large sequential scans
- Pure FIFO would evict frequently-used pages just because they're old
- The active/inactive split approximates LRU while the cache queue enables instant reclamation of clean pages</p>
<h2 id="dragonfly-specific-design-choices">DragonFly-Specific Design Choices<a class="headerlink" href="#dragonfly-specific-design-choices" title="Permanent link"></a></h2>
<p>This section explains <em>why</em> DragonFly's page management differs from traditional BSD.</p>
<h3 id="1024-color-page-queues">1024-Color Page Queues<a class="headerlink" href="#1024-color-page-queues" title="Permanent link"></a></h3>
<p>Traditional BSD systems use a single lock per queue type. On a 64-core system, this becomes a severe bottleneckevery page allocation/free contends on the same lock.</p>
<p>DragonFly divides each queue type into 1024 sub-queues ("colors"). The page color is derived from its physical address and CPU topology, so:</p>
<ul>
<li>CPUs on different sockets naturally hit different queue subsets</li>
<li>Even CPUs on the same socket distribute across colors</li>
<li>Lock contention drops by ~1000x compared to single-queue designs</li>
</ul>
<p>The 1024 value balances granularity (more = less contention) against memory overhead (each queue has its own spinlock and list head).</p>
<h3 id="atomic-busy-counts-vs-locks">Atomic Busy Counts vs. Locks<a class="headerlink" href="#atomic-busy-counts-vs-locks" title="Permanent link"></a></h3>
<p>Traditional BSD uses <code>lockmgr</code> locks on pages. DragonFly replaces this with atomic busy counts:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>busy_count field:
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>  [31]    PBUSY_LOCKED   - Hard busy (exclusive)
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>  [30]    PBUSY_WANTED   - Someone waiting
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>  [29]    PBUSY_SWAPINPROG - Swap I/O active
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>  [28:0]  Soft-busy count (shared)
</code></pre></div>
<p>Benefits:
- <strong>No lock structure overhead</strong> per page
- <strong>Soft-busy allows concurrency</strong>: Multiple readers can soft-busy a page simultaneously
- <strong>Atomic operations</strong> are faster than lock acquire/release cycles
- <strong>Integrates with LWKT</strong>: Waiters use <code>tsleep()</code>/<code>wakeup()</code> patterns</p>
<h3 id="per-cpu-statistics">Per-CPU Statistics<a class="headerlink" href="#per-cpu-statistics" title="Permanent link"></a></h3>
<p>Global <code>vmstats</code> would cause cache-line bouncing on every alloc/free. DragonFly caches adjustments per-CPU:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">mycpu</span><span class="o">-&gt;</span><span class="n">gd_vmstats_adj</span><span class="p">.</span><span class="n">v_free_count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span><span class="w">  </span><span class="c1">// Fast, local</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1">// Periodically or when threshold exceeded:</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="n">atomic_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmstats</span><span class="p">.</span><span class="n">v_free_count</span><span class="p">,</span><span class="w"> </span><span class="n">accumulated_delta</span><span class="p">);</span><span class="w">  </span><span class="c1">// Slow, global</span>
</code></pre></div>
<p>This reduces cross-CPU cache invalidations from O(allocations) to O(sync_intervals).</p>
<h3 id="numa-aware-coloring">NUMA-Aware Coloring<a class="headerlink" href="#numa-aware-coloring" title="Permanent link"></a></h3>
<p>On NUMA systems, accessing memory on a remote socket incurs 2-3x latency. DragonFly's <code>vm_get_pg_color()</code> encodes CPU topology into the color:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>Color bits: [socket_id][core_id][ht_id][set_associativity]
</code></pre></div>
<p>Result: A CPU naturally allocates pages from queues that contain pages physically close to it.</p>
<h3 id="nice-aware-paging-thresholds">Nice-Aware Paging Thresholds<a class="headerlink" href="#nice-aware-paging-thresholds" title="Permanent link"></a></h3>
<p>When memory is low, all processes compete to allocate. Traditional systems give equal priority to all. DragonFly adjusts paging thresholds based on process nice value:</p>
<ul>
<li>Nice 0 process: blocks at <code>v_free_min</code></li>
<li>Nice +10 process: blocks earlier (at higher free count)</li>
<li>Nice -10 process: blocks later (can dig deeper into reserves)</li>
</ul>
<p>This prevents a <code>nice +19</code> background job from consuming memory needed by interactive processes.</p>
<hr/>
<h2 id="data-structures">Data Structures<a class="headerlink" href="#data-structures" title="Permanent link"></a></h2>
<h3 id="page-array">Page Array<a class="headerlink" href="#page-array" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="n">vm_page_array</span><span class="p">;</span><span class="w">           </span><span class="c1">// Global array of all vm_page structures</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">vm_page_array_size</span><span class="p">;</span><span class="w">    </span><span class="c1">// Number of entries</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">first_page</span><span class="p">;</span><span class="w">            </span><span class="c1">// First physical page index</span>
</code></pre></div>
<p>The macro <code>PHYS_TO_VM_PAGE(pa)</code> converts a physical address to its corresponding <code>vm_page</code> pointer.</p>
<h3 id="page-queues">Page Queues<a class="headerlink" href="#page-queues" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vpgqueues</span><span class="w"> </span><span class="n">vm_page_queues</span><span class="p">[</span><span class="n">PQ_COUNT</span><span class="p">];</span>
</code></pre></div>
<p>Five queue types, each with 1024 color variants (<code>PQ_L2_SIZE</code>):</p>
<table>
<thead>
<tr>
<th>Queue Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PQ_FREE</code></td>
<td>Available for allocation</td>
</tr>
<tr>
<td><code>PQ_CACHE</code></td>
<td>Clean pages, immediately reusable</td>
</tr>
<tr>
<td><code>PQ_INACTIVE</code></td>
<td>Low activity, candidates for reclamation</td>
</tr>
<tr>
<td><code>PQ_ACTIVE</code></td>
<td>Recently referenced pages</td>
</tr>
<tr>
<td><code>PQ_HOLD</code></td>
<td>Temporarily held (prevents freeing)</td>
</tr>
</tbody>
</table>
<p>Each <code>struct vpgqueues</code> contains:
- <code>spin</code> - Per-queue spinlock
- <code>pl</code> - Page list (TAILQ)
- <code>lcnt</code> - Local count
- <code>lastq</code> - Heuristic for skipping empty queues</p>
<h3 id="page-hash-table">Page Hash Table<a class="headerlink" href="#page-hash-table" title="Permanent link"></a></h3>
<p>A lockless heuristic cache for fast page lookups:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_page_hash_elm</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="n">vm_page_t</span><span class="w">   </span><span class="n">m</span><span class="p">;</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">;</span><span class="w">   </span><span class="c1">// Cached for fast comparison</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pindex</span><span class="p">;</span><span class="w">   </span><span class="c1">// Cached for fast comparison</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">ticks</span><span class="p">;</span><span class="w">    </span><span class="c1">// LRU timestamp</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="p">};</span>
</code></pre></div>
<ul>
<li>4-way set associative (<code>VM_PAGE_HASH_SET</code>)</li>
<li>Maximum 8 million entries</li>
<li>Only caches pages with <code>PG_MAPPEDMULTI</code> flag</li>
</ul>
<hr/>
<h2 id="boot-time-initialization">Boot-Time Initialization<a class="headerlink" href="#boot-time-initialization" title="Permanent link"></a></h2>
<h3 id="vm_page_startup"><code>vm_page_startup()</code><a class="headerlink" href="#vm_page_startup" title="Permanent link"></a></h3>
<p>Called early in boot to initialize the page management subsystem:</p>
<ol>
<li><strong>Aligns physical memory ranges</strong> - Rounds <code>phys_avail[]</code> to page boundaries</li>
<li><strong>Initializes page queues</strong> - Creates 5120 queue structures (5 types  1024 colors)</li>
<li><strong>Allocates minidump bitmap</strong> - For crash dump support</li>
<li><strong>Allocates vm_page_array</strong> - One <code>struct vm_page</code> per physical page</li>
<li><strong>Initializes page structures</strong> - Sets up spinlocks and physical addresses</li>
<li><strong>Populates free queues</strong> - Adds pages in ascending physical order</li>
</ol>
<h3 id="page-color-calculation">Page Color Calculation<a class="headerlink" href="#page-color-calculation" title="Permanent link"></a></h3>
<p>During boot, page colors are calculated with CPU locality twisting:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">m</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pa</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">);</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">m</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">((</span><span class="n">pa</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PQ_L2_SIZE</span><span class="p">);</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="n">m</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">((</span><span class="n">pa</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">PQ_L2_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PQ_L2_SIZE</span><span class="p">));</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="n">m</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="n">PQ_L2_MASK</span><span class="p">;</span>
</code></pre></div>
<p>This distributes pages across queues while maintaining locality.</p>
<h3 id="numa-organization">NUMA Organization<a class="headerlink" href="#numa-organization" title="Permanent link"></a></h3>
<p><code>vm_numa_organize()</code> reorganizes page colors based on physical socket ID:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">socket_mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PQ_L2_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cpu_topology_phys_ids</span><span class="p">;</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="n">socket_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">physid</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">cpu_topology_phys_ids</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">socket_mod</span><span class="p">;</span>
</code></pre></div>
<p><code>vm_numa_organize_finalize()</code> then balances queues to prevent empty queues that would force cross-socket borrowing.</p>
<h3 id="dma-reserve">DMA Reserve<a class="headerlink" href="#dma-reserve" title="Permanent link"></a></h3>
<p>Low physical memory is reserved for DMA operations:</p>
<ul>
<li><strong><code>vm_low_phys_reserved</code></strong>: Threshold for DMA reserve (default 65536 pages)</li>
<li><strong><code>vm_dma_reserved</code></strong>: Tunable amount to keep reserved (default 128MB on 2G+ systems)</li>
<li>Pages in this range are marked <code>PG_FICTITIOUS | PG_UNQUEUED</code> and managed by <code>vm_contig_alist</code></li>
</ul>
<hr/>
<h2 id="page-allocation">Page Allocation<a class="headerlink" href="#page-allocation" title="Permanent link"></a></h2>
<h3 id="vm_page_alloc"><code>vm_page_alloc()</code><a class="headerlink" href="#vm_page_alloc" title="Permanent link"></a></h3>
<p>The primary page allocation function.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_page_alloc</span><span class="p">(</span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">page_req</span><span class="p">);</span>
</code></pre></div>
<p><strong>Allocation flags:</strong></p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>VM_ALLOC_NORMAL</code></td>
<td>Can use cache pages</td>
</tr>
<tr>
<td><code>VM_ALLOC_QUICK</code></td>
<td>Free queue only, skip cache</td>
</tr>
<tr>
<td><code>VM_ALLOC_SYSTEM</code></td>
<td>Can exhaust most of free list</td>
</tr>
<tr>
<td><code>VM_ALLOC_INTERRUPT</code></td>
<td>Can exhaust entire free list</td>
</tr>
<tr>
<td><code>VM_ALLOC_CPU(n)</code></td>
<td>CPU localization hint</td>
</tr>
<tr>
<td><code>VM_ALLOC_ZERO</code></td>
<td>Zero page if allocated</td>
</tr>
<tr>
<td><code>VM_ALLOC_NULL_OK</code></td>
<td>Return NULL on collision</td>
</tr>
</tbody>
</table>
<p><strong>Algorithm:</strong></p>
<ol>
<li>Calculate page color via <code>vm_get_pg_color(cpuid, object, pindex)</code></li>
<li>Check free count against thresholds</li>
<li>Search free queue (and optionally cache queue)</li>
<li>If using cache page, free it first then retry</li>
<li>Insert into object if provided</li>
<li>Return BUSY page</li>
</ol>
<h3 id="cpu-localized-color-selection">CPU-Localized Color Selection<a class="headerlink" href="#cpu-localized-color-selection" title="Permanent link"></a></h3>
<p><code>vm_get_pg_color()</code> calculates colors considering CPU topology:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">// General format: [phys_id][core_id][cpuid][set-associativity]</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="n">physcale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PQ_L2_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cpu_topology_phys_ids</span><span class="p">;</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="n">grpscale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">physcale</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cpu_topology_core_ids</span><span class="p">;</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="n">cpuscale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grpscale</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cpu_topology_ht_ids</span><span class="p">;</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="n">pg_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phys_id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">physcale</span><span class="p">;</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="n">pg_color</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">core_id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">grpscale</span><span class="p">;</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="n">pg_color</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ht_id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cpuscale</span><span class="p">;</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="n">pg_color</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">pindex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">object_pg_color</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">cpuscale</span><span class="p">;</span>
</code></pre></div>
<h3 id="queue-search-algorithm">Queue Search Algorithm<a class="headerlink" href="#queue-search-algorithm" title="Permanent link"></a></h3>
<p><code>_vm_page_list_find()</code> searches for pages with widening locality:</p>
<ol>
<li>Try exact color queue first</li>
<li>Widen search: 16  32  64  128  ...  1024 queues</li>
<li>Track <code>lastq</code> to skip known-empty queues</li>
<li>Return spinlocked page removed from queue</li>
</ol>
<h3 id="contiguous-allocation">Contiguous Allocation<a class="headerlink" href="#contiguous-allocation" title="Permanent link"></a></h3>
<p>For DMA and device drivers requiring physically contiguous memory:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_page_alloc_contig</span><span class="p">(</span><span class="n">vm_paddr_t</span><span class="w"> </span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">vm_paddr_t</span><span class="w"> </span><span class="n">high</span><span class="p">,</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">                               </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">alignment</span><span class="p">,</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">                               </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">boundary</span><span class="p">,</span>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">                               </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">                               </span><span class="n">vm_memattr_t</span><span class="w"> </span><span class="n">memattr</span><span class="p">);</span>
</code></pre></div>
<p>Uses the <code>vm_contig_alist</code> allocator for low-memory DMA pages.</p>
<h3 id="other-allocation-functions">Other Allocation Functions<a class="headerlink" href="#other-allocation-functions" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vm_page_alloczwq()</code></td>
<td>Allocate without object, returns wired page</td>
</tr>
<tr>
<td><code>vm_page_grab()</code></td>
<td>Lookup-or-allocate with object</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="page-freeing">Page Freeing<a class="headerlink" href="#page-freeing" title="Permanent link"></a></h2>
<h3 id="vm_page_free_toq"><code>vm_page_free_toq()</code><a class="headerlink" href="#vm_page_free_toq" title="Permanent link"></a></h3>
<p>The main page freeing function:</p>
<ol>
<li>Assert page not mapped (calls <code>pmap_mapped_sync()</code> if needed)</li>
<li>Remove from object via <code>vm_page_remove()</code></li>
<li>For fictitious pages: just wakeup and return</li>
<li>Remove from current queue</li>
<li>Clear valid/dirty bits</li>
<li>Place on appropriate queue:</li>
<li><code>PQ_HOLD</code> if <code>hold_count != 0</code></li>
<li><code>PQ_FREE</code> otherwise (at head for cache-hot)</li>
<li>Wake up page waiters</li>
<li>Wake memory-waiting threads via <code>vm_page_free_wakeup()</code></li>
</ol>
<h3 id="free-wakeup-logic">Free Wakeup Logic<a class="headerlink" href="#free-wakeup-logic" title="Permanent link"></a></h3>
<p><code>vm_page_free_wakeup()</code> signals:
- <strong>Pageout daemon</strong>: If it needs pages and threshold met
- <strong>Memory-waiting processes</strong>: If above hysteresis threshold</p>
<hr/>
<h2 id="page-state-transitions">Page State Transitions<a class="headerlink" href="#page-state-transitions" title="Permanent link"></a></h2>
<pre class="mermaid"><code>flowchart TB
    PQ_FREE["PQ_FREE"]
    PQ_ACTIVE["PQ_ACTIVE"]
    PQ_INACTIVE["PQ_INACTIVE"]
    PQ_CACHE["PQ_CACHE<br/><i>clean, not mapped</i>"]
    PQ_FREE_OR_HOLD["PQ_FREE or PQ_HOLD"]

    PQ_FREE --&gt;|alloc| PQ_ACTIVE
    PQ_ACTIVE --&gt;|deactivate| PQ_INACTIVE
    PQ_INACTIVE --&gt;|clean| PQ_CACHE
    PQ_CACHE --&gt;|free| PQ_FREE_OR_HOLD
</code></pre>
<h3 id="activation">Activation<a class="headerlink" href="#activation" title="Permanent link"></a></h3>
<p><code>vm_page_activate()</code> moves a page to <code>PQ_ACTIVE</code>:
- Sets <code>act_count</code> to at least <code>ACT_INIT</code>
- Wakes pagedaemon if page was on cache/free queue</p>
<h3 id="deactivation">Deactivation<a class="headerlink" href="#deactivation" title="Permanent link"></a></h3>
<p><code>vm_page_deactivate()</code> moves a page to <code>PQ_INACTIVE</code>:
- Clears <code>PG_WINATCFLS</code> flag
- Optional <code>athead</code> for pseudo-cache behavior (MADV_DONTNEED)</p>
<h3 id="caching">Caching<a class="headerlink" href="#caching" title="Permanent link"></a></h3>
<p><code>vm_page_cache()</code> moves a clean page to <code>PQ_CACHE</code>:
- Removes all pmap mappings first
- Dirty pages are deactivated instead</p>
<hr/>
<h2 id="busy-state-management">Busy State Management<a class="headerlink" href="#busy-state-management" title="Permanent link"></a></h2>
<p>DragonFly uses atomic busy counts instead of traditional locks.</p>
<h3 id="hard-busy-pbusy_locked">Hard Busy (<code>PBUSY_LOCKED</code>)<a class="headerlink" href="#hard-busy-pbusy_locked" title="Permanent link"></a></h3>
<p>Exclusive access to the page.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_busy_wait</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">also_m_busy</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kt">int</span><span class="w">  </span><span class="nf">vm_page_busy_try</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">also_m_busy</span><span class="p">);</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_wakeup</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
</code></pre></div>
<ul>
<li><code>vm_page_busy_wait()</code>: Blocks until page not busy</li>
<li><code>vm_page_busy_try()</code>: Non-blocking attempt, returns TRUE on failure</li>
<li><code>vm_page_wakeup()</code>: Clears busy and wakes waiters</li>
</ul>
<h3 id="soft-busy-pbusy_mask">Soft Busy (<code>PBUSY_MASK</code>)<a class="headerlink" href="#soft-busy-pbusy_mask" title="Permanent link"></a></h3>
<p>Shared access for compatible operations (e.g., read-only mapping during write).</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_io_start</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w">   </span><span class="c1">// Increment soft-busy (requires hard-busy)</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_io_finish</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w">  </span><span class="c1">// Decrement soft-busy</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kt">int</span><span class="w">  </span><span class="nf">vm_page_sbusy_try</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w">  </span><span class="c1">// Non-blocking soft-busy acquire</span>
</code></pre></div>
<h3 id="waiting">Waiting<a class="headerlink" href="#waiting" title="Permanent link"></a></h3>
<p><code>vm_page_sleep_busy()</code> sleeps until page not busy without acquiring it.</p>
<hr/>
<h2 id="wireunwire">Wire/Unwire<a class="headerlink" href="#wireunwire" title="Permanent link"></a></h2>
<p>Wiring prevents a page from being paged out.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_wire</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_unwire</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">activate</span><span class="p">);</span>
</code></pre></div>
<ul>
<li><code>vm_page_wire()</code>: Increments <code>wire_count</code>, adjusts vmstats on 01</li>
<li><code>vm_page_unwire()</code>: Decrements <code>wire_count</code>, activates or deactivates on 10</li>
<li>Fictitious pages ignore wire operations</li>
</ul>
<hr/>
<h2 id="holdunhold">Hold/Unhold<a class="headerlink" href="#holdunhold" title="Permanent link"></a></h2>
<p>Holding prevents page reuse but not disassociation from object.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_hold</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_page_unhold</span><span class="p">(</span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
</code></pre></div>
<p>On last unhold, if page is on <code>PQ_HOLD</code>, it moves to <code>PQ_FREE</code>.</p>
<hr/>
<h2 id="page-lookup">Page Lookup<a class="headerlink" href="#page-lookup" title="Permanent link"></a></h2>
<h3 id="standard-lookup">Standard Lookup<a class="headerlink" href="#standard-lookup" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_page_lookup</span><span class="p">(</span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pindex</span><span class="p">);</span>
</code></pre></div>
<p>Requires object token held. Does RB-tree lookup and populates hash cache.</p>
<h3 id="lookup-busy">Lookup + Busy<a class="headerlink" href="#lookup-busy" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1">// Blocking</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_page_lookup_busy_wait</span><span class="p">(</span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">                                   </span><span class="kt">int</span><span class="w"> </span><span class="n">also_m_busy</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a>
<a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="c1">// Non-blocking</span>
<a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_page_lookup_busy_try</span><span class="p">(</span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span>
<a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">also_m_busy</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">);</span>
</code></pre></div>
<h3 id="fast-heuristic-lookup">Fast Heuristic Lookup<a class="headerlink" href="#fast-heuristic-lookup" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_page_hash_get</span><span class="p">(</span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pindex</span><span class="p">);</span>
</code></pre></div>
<p>Lockless lookup returning soft-busied page on hit.</p>
<hr/>
<h2 id="validdirty-bit-management">Valid/Dirty Bit Management<a class="headerlink" href="#validdirty-bit-management" title="Permanent link"></a></h2>
<p>Each page has 8 valid and 8 dirty bits (one per DEV_BSIZE chunk, typically 512 bytes).</p>
<h3 id="functions">Functions<a class="headerlink" href="#functions" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vm_page_bits(base, size)</code></td>
<td>Convert range to bit mask</td>
</tr>
<tr>
<td><code>vm_page_set_valid()</code></td>
<td>Set valid bits, zero invalid portions</td>
</tr>
<tr>
<td><code>vm_page_set_validclean()</code></td>
<td>Set valid, clear dirty</td>
</tr>
<tr>
<td><code>vm_page_set_validdirty()</code></td>
<td>Set both valid and dirty</td>
</tr>
<tr>
<td><code>vm_page_clear_dirty()</code></td>
<td>Clear dirty bits</td>
</tr>
<tr>
<td><code>vm_page_dirty()</code></td>
<td>Set all dirty bits</td>
</tr>
<tr>
<td><code>vm_page_test_dirty()</code></td>
<td>Sync dirty from pmap</td>
</tr>
<tr>
<td><code>vm_page_zero_invalid()</code></td>
<td>Zero invalid portions before mapping</td>
</tr>
<tr>
<td><code>vm_page_is_valid()</code></td>
<td>Check if range is valid</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="memory-pressure-handling">Memory Pressure Handling<a class="headerlink" href="#memory-pressure-handling" title="Permanent link"></a></h2>
<h3 id="waiting-functions">Waiting Functions<a class="headerlink" href="#waiting-functions" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vm_wait()</code></td>
<td>Block until memory available (I/O path)</td>
</tr>
<tr>
<td><code>vm_wait_pfault()</code></td>
<td>Block in page fault path (nice-aware)</td>
</tr>
<tr>
<td><code>vm_wait_nominal()</code></td>
<td>Block for kernel heavy operations</td>
</tr>
<tr>
<td><code>vm_test_nominal()</code></td>
<td>Test if vm_wait_nominal would block</td>
</tr>
</tbody>
</table>
<h3 id="nice-aware-paging">Nice-Aware Paging<a class="headerlink" href="#nice-aware-paging" title="Permanent link"></a></h3>
<p>Process nice value affects paging thresholds:
- Higher nice = earlier blocking
- Prevents nice'd memory hogs from impacting normal processes</p>
<h3 id="low-memory-kill">Low Memory Kill<a class="headerlink" href="#low-memory-kill" title="Permanent link"></a></h3>
<p>Processes with <code>P_LOWMEMKILL</code> flag can break out of wait loops.</p>
<hr/>
<h2 id="madvise-support">madvise Support<a class="headerlink" href="#madvise-support" title="Permanent link"></a></h2>
<h3 id="vm_page_dontneed"><code>vm_page_dontneed()</code><a class="headerlink" href="#vm_page_dontneed" title="Permanent link"></a></h3>
<p>Implements <code>MADV_DONTNEED</code>:
- 3/32 chance: deactivate page
- 28/32 chance: deactivate at head (pseudo-cache)
- Clears <code>PG_REFERENCED</code></p>
<hr/>
<h2 id="special-page-types">Special Page Types<a class="headerlink" href="#special-page-types" title="Permanent link"></a></h2>
<h3 id="fictitious-pages">Fictitious Pages<a class="headerlink" href="#fictitious-pages" title="Permanent link"></a></h3>
<p>Pages with <code>PG_FICTITIOUS</code> flag:
- Not in normal page array
- Created via <code>vm_page_initfake()</code>
- Wire/unwire operations ignored
- Used for device mappings (GPU, etc.)</p>
<h3 id="pages-requiring-commit">Pages Requiring Commit<a class="headerlink" href="#pages-requiring-commit" title="Permanent link"></a></h3>
<p>Pages with <code>PG_NEED_COMMIT</code> flag:
- Cannot be reclaimed even if clean
- Used by tmpfs, NFS
- Set via <code>vm_page_need_commit()</code></p>
<hr/>
<h2 id="locking-rules">Locking Rules<a class="headerlink" href="#locking-rules" title="Permanent link"></a></h2>
<h3 id="queue-operations">Queue Operations<a class="headerlink" href="#queue-operations" title="Permanent link"></a></h3>
<p>Locking order: <strong>Page spinlock first, then queue spinlock</strong></p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">vm_page_spin_lock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w">           </span><span class="c1">// Lock page</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="n">_vm_page_queue_spin_lock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w">    </span><span class="c1">// Then lock its queue</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="c1">// ... manipulate queue ...</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="n">_vm_page_queue_spin_unlock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w">  </span><span class="c1">// Unlock queue first</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="n">vm_page_spin_unlock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w">         </span><span class="c1">// Then unlock page</span>
</code></pre></div>
<h3 id="per-cpu-statistics_1">Per-CPU Statistics<a class="headerlink" href="#per-cpu-statistics_1" title="Permanent link"></a></h3>
<p>Queue adjustments update per-CPU vmstats:
- <code>mycpu-&gt;gd_vmstats_adj</code> - Accumulated adjustments
- <code>mycpu-&gt;gd_vmstats</code> - Current view
- Synchronized to global <code>vmstats</code> periodically or when threshold exceeded</p>
<hr/>
<h2 id="common-usage-patterns">Common Usage Patterns<a class="headerlink" href="#common-usage-patterns" title="Permanent link"></a></h2>
<p>This section shows how page management functions work together in typical scenarios.</p>
<h3 id="pattern-1-page-fault-allocation">Pattern 1: Page Fault Allocation<a class="headerlink" href="#pattern-1-page-fault-allocation" title="Permanent link"></a></h3>
<p>From <code>sys/vm/vm_fault.c</code> - when a process accesses unmapped memory:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="cm">/* Try to find existing page (non-blocking busy try) */</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_page_lookup_busy_try</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">                                      </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">    </span><span class="cm">/* Page exists but is busy - sleep and retry */</span>
<a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="n">vm_page_sleep_busy</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="s">"vmpfw"</span><span class="p">);</span>
<a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">KERN_TRY_AGAIN</span><span class="p">);</span>
<a href="#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="p">}</span>
<a href="#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a>
<a href="#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">    </span><span class="cm">/* Page doesn't exist - allocate new one (returns BUSY) */</span>
<a href="#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">    </span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_page_alloc</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span>
<a href="#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">                                </span><span class="n">VM_ALLOC_NULL_OK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_ALLOC_NORMAL</span><span class="p">);</span>
<a href="#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">        </span><span class="n">vm_wait_pfault</span><span class="p">();</span><span class="w">  </span><span class="cm">/* Block if low memory */</span>
<a href="#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">KERN_TRY_AGAIN</span><span class="p">);</span>
<a href="#__codelineno-19-18" id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-19-19" id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">    </span><span class="cm">/* Page is busy, safe to do I/O to populate it */</span>
<a href="#__codelineno-19-20" id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="p">}</span>
<a href="#__codelineno-19-21" id="__codelineno-19-21" name="__codelineno-19-21"></a>
<a href="#__codelineno-19-22" id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="cm">/* ... fault handling continues ... */</span>
<a href="#__codelineno-19-23" id="__codelineno-19-23" name="__codelineno-19-23"></a>
<a href="#__codelineno-19-24" id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="cm">/* When done, release busy state */</span>
<a href="#__codelineno-19-25" id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="n">vm_page_wakeup</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</code></pre></div>
<h3 id="pattern-2-pageout-daemon-scanning">Pattern 2: Pageout Daemon Scanning<a class="headerlink" href="#pattern-2-pageout-daemon-scanning" title="Permanent link"></a></h3>
<p>From <code>sys/vm/vm_pageout.c</code> - reclaiming inactive pages:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="cm">/* Simplified from vm_pageout_scan_inactive() */</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="n">TAILQ_FOREACH</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vm_page_queues</span><span class="p">[</span><span class="n">PQ_INACTIVE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">].</span><span class="n">pl</span><span class="p">,</span><span class="w"> </span><span class="n">pageq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="cm">/* Non-blocking busy attempt - skip if can't acquire */</span>
<a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_page_busy_try</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">))</span>
<a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>
<a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">    </span><span class="cm">/*</span>
<a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="cm">     * Page is now busy - we own it.</span>
<a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="cm">     * Remaining operations run with page busy.</span>
<a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="cm">     */</span>
<a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">        </span><span class="cm">/* Must clean before freeing */</span>
<a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_pageout_clean_helper</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">vmflush_flags</span><span class="p">);</span>
<a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-15" id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">        </span><span class="cm">/* Clean page - move to cache for instant reuse */</span>
<a href="#__codelineno-20-16" id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="w">        </span><span class="n">vm_page_cache</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a href="#__codelineno-20-17" id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-20-18" id="__codelineno-20-18" name="__codelineno-20-18"></a>
<a href="#__codelineno-20-19" id="__codelineno-20-19" name="__codelineno-20-19"></a><span class="w">    </span><span class="n">vm_page_wakeup</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a href="#__codelineno-20-20" id="__codelineno-20-20" name="__codelineno-20-20"></a><span class="p">}</span>
</code></pre></div>
<h3 id="pattern-3-driver-dma-buffer">Pattern 3: Driver DMA Buffer<a class="headerlink" href="#pattern-3-driver-dma-buffer" title="Permanent link"></a></h3>
<p>Device drivers needing physically contiguous memory:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="cm">/* Allocate 64KB contiguous, 16-byte aligned, below 4GB */</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_page_alloc_contig</span><span class="p">(</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                      </span><span class="cm">/* low address */</span>
<a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="mh">0xFFFFFFFFULL</span><span class="p">,</span><span class="w">          </span><span class="cm">/* high address (4GB) */</span>
<a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="mi">16</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* alignment */</span>
<a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                      </span><span class="cm">/* boundary (0 = none) */</span>
<a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">    </span><span class="mi">64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w">              </span><span class="cm">/* size */</span>
<a href="#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="w">    </span><span class="n">VM_MEMATTR_UNCACHEABLE</span><span class="w">  </span><span class="cm">/* memory attribute */</span>
<a href="#__codelineno-21-9" id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="p">);</span>
<a href="#__codelineno-21-10" id="__codelineno-21-10" name="__codelineno-21-10"></a>
<a href="#__codelineno-21-11" id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-21-12" id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="w">    </span><span class="n">phys_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_PAGE_TO_PHYS</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a href="#__codelineno-21-13" id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="w">    </span><span class="cm">/* Program DMA controller with phys_addr */</span>
<a href="#__codelineno-21-14" id="__codelineno-21-14" name="__codelineno-21-14"></a>
<a href="#__codelineno-21-15" id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="w">    </span><span class="cm">/* Later, when done: */</span>
<a href="#__codelineno-21-16" id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="w">    </span><span class="n">vm_page_free_contig</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a href="#__codelineno-21-17" id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="p">}</span>
</code></pre></div>
<h3 id="pattern-4-wiring-pages-for-io">Pattern 4: Wiring Pages for I/O<a class="headerlink" href="#pattern-4-wiring-pages-for-io" title="Permanent link"></a></h3>
<p>Ensuring pages stay resident during I/O operations:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="cm">/* Wire range to prevent pageout during I/O */</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">each</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">range</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">    </span><span class="n">vm_page_wire</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="p">}</span>
<a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a>
<a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="cm">/* Pages now guaranteed resident */</span>
<a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="n">start_io</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="n">wait_for_io_completion</span><span class="p">();</span>
<a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a>
<a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="cm">/* Unwire when done */</span>
<a href="#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">each</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">range</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">    </span><span class="n">vm_page_unwire</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="cm">/* 0 = deactivate, 1 = keep active */</span>
<a href="#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="p">}</span>
</code></pre></div>
<hr/>
<h2 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link"></a></h2>
<h3 id="ddb-commands">DDB Commands<a class="headerlink" href="#ddb-commands" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>show page</code></td>
<td>Display vmstats counters</td>
</tr>
<tr>
<td><code>show pageq</code></td>
<td>Display queue lengths per color</td>
</tr>
</tbody>
</table>
<h3 id="sysctls">Sysctls<a class="headerlink" href="#sysctls" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Sysctl</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vm.dma_reserved</code></td>
<td>Memory reserved for DMA</td>
</tr>
<tr>
<td><code>vm.dma_free_pages</code></td>
<td>Available DMA pages</td>
</tr>
<tr>
<td><code>vm.page_hash_vnode_only</code></td>
<td>Only hash vnode pages</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="further-reading">Further Reading<a class="headerlink" href="#further-reading" title="Permanent link"></a></h2>
<h3 id="dragonfly-resources">DragonFly Resources<a class="headerlink" href="#dragonfly-resources" title="Permanent link"></a></h3>
<ul>
<li><a href="../concepts/">VM Concepts</a>  Foundational VM theory and Mach heritage</li>
<li><a href="../vm_object/">VM Objects</a>  How pages are grouped into objects</li>
<li><a href="../vm_fault/">Page Faults</a>  How faults trigger page allocation</li>
<li><a href="../vm_pageout/">Pageout Daemon</a>  Memory reclamation in detail</li>
</ul>
<h3 id="external-resources">External Resources<a class="headerlink" href="#external-resources" title="Permanent link"></a></h3>
<ul>
<li><strong><a href="https://www.informit.com/store/design-and-implementation-of-the-freebsd-operating-9780321968975">The Design and Implementation of the FreeBSD Operating System</a></strong> (McKusick et al.)  Chapter 5 covers BSD VM; DragonFly inherits this design</li>
<li><strong><a href="https://pages.cs.wisc.edu/~remzi/OSTEP/">Operating Systems: Three Easy Pieces</a></strong>  Free online textbook; Chapters 18-22 cover paging and replacement</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Page_replacement_algorithm">Wikipedia: Page replacement algorithm</a></strong>  Overview of LRU, Clock, and related algorithms</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Non-uniform_memory_access">Wikipedia: NUMA</a></strong>  Background on NUMA architecture and why locality matters</li>
<li><strong><a href="https://lwn.net/Kernel/Index/#Memory_management">LWN: Memory management</a></strong>  Linux perspective, but concepts transfer</li>
</ul>
<h3 id="source-files">Source Files<a class="headerlink" href="#source-files" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sys/vm/vm_page.c</code></td>
<td>Implementation (~4,200 lines)</td>
</tr>
<tr>
<td><code>sys/vm/vm_page.h</code></td>
<td><code>struct vm_page</code> definition, flags</td>
</tr>
<tr>
<td><code>sys/vm/vm_page2.h</code></td>
<td>Inline functions, paging thresholds</td>
</tr>
<tr>
<td><code>sys/vm/vm_pageout.c</code></td>
<td>Pageout daemon (consumer of this API)</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link"></a></h2>
<ul>
<li><a href="../">VM Architecture Overview</a></li>
<li><a href="../../kern/memory/">Memory Allocation</a>  Kernel memory (kmalloc, objcache)</li>
<li><a href="../../kern/vfs/buffer-cache/">Buffer Cache</a>  Filesystem buffer management</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>