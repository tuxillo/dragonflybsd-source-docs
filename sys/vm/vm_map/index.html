
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../vm_object/" rel="prev"/>
<link href="../vm_fault/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Address Space - DragonFly BSD Kernel Documentation</title>
<link href="../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#address-space-management">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Address Space
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#why-address-space-management-matters">
<span class="md-ellipsis">
      
        Why Address Space Management Matters
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-life-of-a-mapping">
<span class="md-ellipsis">
      
        The Life of a Mapping
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-design-principles">
<span class="md-ellipsis">
      
        Key Design Principles
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-operations">
<span class="md-ellipsis">
      
        Common Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vmspace">
<span class="md-ellipsis">
      
        struct vmspace
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vm_map">
<span class="md-ellipsis">
      
        struct vm_map
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vm_map_entry">
<span class="md-ellipsis">
      
        struct vm_map_entry
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vm_map_backing">
<span class="md-ellipsis">
      
        struct vm_map_backing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-flags-vm_eflags_t">
<span class="md-ellipsis">
      
        Entry Flags (vm_eflags_t)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map-types-vm_maptype_t">
<span class="md-ellipsis">
      
        Map Types (vm_maptype_t)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vmspace-lifecycle">
<span class="md-ellipsis">
      
        vmspace Lifecycle
      
    </span>
</a>
<nav aria-label="vmspace Lifecycle" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#two-stage-termination">
<span class="md-ellipsis">
      
        Two-Stage Termination
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#allocation-and-initialization">
<span class="md-ellipsis">
      
        Allocation and Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reference-counting">
<span class="md-ellipsis">
      
        Reference Counting
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map-operations">
<span class="md-ellipsis">
      
        Map Operations
      
    </span>
</a>
<nav aria-label="Map Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-lookup">
<span class="md-ellipsis">
      
        Entry Lookup
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#finding-free-space">
<span class="md-ellipsis">
      
        Finding Free Space
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inserting-mappings">
<span class="md-ellipsis">
      
        Inserting Mappings
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-find-and-insert">
<span class="md-ellipsis">
      
        High-Level Find and Insert
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-clipping">
<span class="md-ellipsis">
      
        Entry Clipping
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#range-operations">
<span class="md-ellipsis">
      
        Range Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#removing-mappings">
<span class="md-ellipsis">
      
        Removing Mappings
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#protection-changes">
<span class="md-ellipsis">
      
        Protection Changes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wiring">
<span class="md-ellipsis">
      
        Wiring
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#msync-implementation">
<span class="md-ellipsis">
      
        msync Implementation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write">
<span class="md-ellipsis">
      
        Copy-On-Write
      
    </span>
</a>
<nav aria-label="Copy-On-Write" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shadow-object-creation">
<span class="md-ellipsis">
      
        Shadow Object Creation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shadow-chain-depth-limiting">
<span class="md-ellipsis">
      
        Shadow Chain Depth Limiting
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#process-fork">
<span class="md-ellipsis">
      
        Process Fork
      
    </span>
</a>
<nav aria-label="Process Fork" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#uksmap-fork-handling">
<span class="md-ellipsis">
      
        UKSMAP Fork Handling
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stack-management">
<span class="md-ellipsis">
      
        Stack Management
      
    </span>
</a>
<nav aria-label="Stack Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#stack-creation">
<span class="md-ellipsis">
      
        Stack Creation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stack-growth">
<span class="md-ellipsis">
      
        Stack Growth
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fault-path-lookup">
<span class="md-ellipsis">
      
        Fault Path Lookup
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#range-interlocks">
<span class="md-ellipsis">
      
        Range Interlocks
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-cpu-entry-cache">
<span class="md-ellipsis">
      
        Per-CPU Entry Cache
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-specific-features">
<span class="md-ellipsis">
      
        DragonFly-Specific Features
      
    </span>
</a>
<nav aria-label="DragonFly-Specific Features" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_map_backing-chains">
<span class="md-ellipsis">
      
        vm_map_backing Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#two-stage-vmspace-termination">
<span class="md-ellipsis">
      
        Two-Stage vmspace Termination
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#freehint-cache">
<span class="md-ellipsis">
      
        Freehint Cache
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-partitioning">
<span class="md-ellipsis">
      
        Entry Partitioning
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uksmap">
<span class="md-ellipsis">
      
        UKSMAP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#coalescing-on-insert">
<span class="md-ellipsis">
      
        Coalescing on Insert
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctls">
<span class="md-ellipsis">
      
        Sysctls
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debugging">
<span class="md-ellipsis">
      
        Debugging
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-usage-patterns">
<span class="md-ellipsis">
      
        Common Usage Patterns
      
    </span>
</a>
<nav aria-label="Common Usage Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-1-creating-a-mapping-in-kernel-code">
<span class="md-ellipsis">
      
        Pattern 1: Creating a Mapping in Kernel Code
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-2-looking-up-an-entry-for-ptrace">
<span class="md-ellipsis">
      
        Pattern 2: Looking Up an Entry for ptrace
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-3-temporarily-changing-protection-for-ptrace-write">
<span class="md-ellipsis">
      
        Pattern 3: Temporarily Changing Protection for ptrace Write
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-4-wiring-pages-for-mlock">
<span class="md-ellipsis">
      
        Pattern 4: Wiring Pages for mlock
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-5-removing-a-mapping">
<span class="md-ellipsis">
      
        Pattern 5: Removing a Mapping
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#further-reading">
<span class="md-ellipsis">
      
        Further Reading
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_fault/">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer2/">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#why-address-space-management-matters">
<span class="md-ellipsis">
      
        Why Address Space Management Matters
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-life-of-a-mapping">
<span class="md-ellipsis">
      
        The Life of a Mapping
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-design-principles">
<span class="md-ellipsis">
      
        Key Design Principles
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-operations">
<span class="md-ellipsis">
      
        Common Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vmspace">
<span class="md-ellipsis">
      
        struct vmspace
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vm_map">
<span class="md-ellipsis">
      
        struct vm_map
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vm_map_entry">
<span class="md-ellipsis">
      
        struct vm_map_entry
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-vm_map_backing">
<span class="md-ellipsis">
      
        struct vm_map_backing
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-flags-vm_eflags_t">
<span class="md-ellipsis">
      
        Entry Flags (vm_eflags_t)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map-types-vm_maptype_t">
<span class="md-ellipsis">
      
        Map Types (vm_maptype_t)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vmspace-lifecycle">
<span class="md-ellipsis">
      
        vmspace Lifecycle
      
    </span>
</a>
<nav aria-label="vmspace Lifecycle" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#two-stage-termination">
<span class="md-ellipsis">
      
        Two-Stage Termination
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#allocation-and-initialization">
<span class="md-ellipsis">
      
        Allocation and Initialization
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reference-counting">
<span class="md-ellipsis">
      
        Reference Counting
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map-operations">
<span class="md-ellipsis">
      
        Map Operations
      
    </span>
</a>
<nav aria-label="Map Operations" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-lookup">
<span class="md-ellipsis">
      
        Entry Lookup
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#finding-free-space">
<span class="md-ellipsis">
      
        Finding Free Space
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inserting-mappings">
<span class="md-ellipsis">
      
        Inserting Mappings
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-find-and-insert">
<span class="md-ellipsis">
      
        High-Level Find and Insert
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-clipping">
<span class="md-ellipsis">
      
        Entry Clipping
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#range-operations">
<span class="md-ellipsis">
      
        Range Operations
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#removing-mappings">
<span class="md-ellipsis">
      
        Removing Mappings
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#protection-changes">
<span class="md-ellipsis">
      
        Protection Changes
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wiring">
<span class="md-ellipsis">
      
        Wiring
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#msync-implementation">
<span class="md-ellipsis">
      
        msync Implementation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write">
<span class="md-ellipsis">
      
        Copy-On-Write
      
    </span>
</a>
<nav aria-label="Copy-On-Write" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shadow-object-creation">
<span class="md-ellipsis">
      
        Shadow Object Creation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shadow-chain-depth-limiting">
<span class="md-ellipsis">
      
        Shadow Chain Depth Limiting
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#process-fork">
<span class="md-ellipsis">
      
        Process Fork
      
    </span>
</a>
<nav aria-label="Process Fork" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#uksmap-fork-handling">
<span class="md-ellipsis">
      
        UKSMAP Fork Handling
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stack-management">
<span class="md-ellipsis">
      
        Stack Management
      
    </span>
</a>
<nav aria-label="Stack Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#stack-creation">
<span class="md-ellipsis">
      
        Stack Creation
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stack-growth">
<span class="md-ellipsis">
      
        Stack Growth
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fault-path-lookup">
<span class="md-ellipsis">
      
        Fault Path Lookup
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#range-interlocks">
<span class="md-ellipsis">
      
        Range Interlocks
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#per-cpu-entry-cache">
<span class="md-ellipsis">
      
        Per-CPU Entry Cache
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-specific-features">
<span class="md-ellipsis">
      
        DragonFly-Specific Features
      
    </span>
</a>
<nav aria-label="DragonFly-Specific Features" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_map_backing-chains">
<span class="md-ellipsis">
      
        vm_map_backing Chains
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#two-stage-vmspace-termination">
<span class="md-ellipsis">
      
        Two-Stage vmspace Termination
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#freehint-cache">
<span class="md-ellipsis">
      
        Freehint Cache
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#entry-partitioning">
<span class="md-ellipsis">
      
        Entry Partitioning
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uksmap">
<span class="md-ellipsis">
      
        UKSMAP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#coalescing-on-insert">
<span class="md-ellipsis">
      
        Coalescing on Insert
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctls">
<span class="md-ellipsis">
      
        Sysctls
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debugging">
<span class="md-ellipsis">
      
        Debugging
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#common-usage-patterns">
<span class="md-ellipsis">
      
        Common Usage Patterns
      
    </span>
</a>
<nav aria-label="Common Usage Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-1-creating-a-mapping-in-kernel-code">
<span class="md-ellipsis">
      
        Pattern 1: Creating a Mapping in Kernel Code
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-2-looking-up-an-entry-for-ptrace">
<span class="md-ellipsis">
      
        Pattern 2: Looking Up an Entry for ptrace
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-3-temporarily-changing-protection-for-ptrace-write">
<span class="md-ellipsis">
      
        Pattern 3: Temporarily Changing Protection for ptrace Write
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-4-wiring-pages-for-mlock">
<span class="md-ellipsis">
      
        Pattern 4: Wiring Pages for mlock
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-5-removing-a-mapping">
<span class="md-ellipsis">
      
        Pattern 5: Removing a Mapping
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#further-reading">
<span class="md-ellipsis">
      
        Further Reading
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="address-space-management">Address Space Management<a class="headerlink" href="#address-space-management" title="Permanent link"></a></h1>
<p>The VM map subsystem manages virtual address spaces in DragonFly BSD. It handles address range mappings, copy-on-write (COW), process forking, stack management, and the relationship between virtual addresses and backing objects.</p>
<p><strong>Source file:</strong> <code>sys/vm/vm_map.c</code> (~4,781 lines)</p>
<hr/>
<h2 id="why-address-space-management-matters">Why Address Space Management Matters<a class="headerlink" href="#why-address-space-management-matters" title="Permanent link"></a></h2>
<p>Every process sees its own private, contiguous address spacefrom address 0 to the maximum virtual address. But this is an illusion. Physical memory is fragmented, shared between processes, and far smaller than the virtual range. The VM map subsystem creates and maintains this illusion.</p>
<p><strong>How does the kernel know what's at a virtual address?</strong></p>
<p>When a process accesses address <code>0x7fff12340000</code>, the hardware triggers a page fault. The kernel must answer: Is this address valid? What protection does it have? Where does its data come from? The <code>vm_map</code> answers all these questions. It's a sorted tree of <code>vm_map_entry</code> structures, each describing a contiguous range with uniform properties.</p>
<p><strong>How does <code>fork()</code> create a child without copying gigabytes of memory?</strong></p>
<p>Copy-on-write (COW) is the answer, but implementing it efficiently is complex. The parent and child must share physical pages until one writes. DragonFly's <code>vm_map_backing</code> chains track these sharing relationships without modifying the underlying <code>vm_object</code>a key architectural difference from traditional BSD.</p>
<p><strong>How do you efficiently find free space in a sparse address space?</strong></p>
<p>With thousands of mappings and huge address ranges, finding a suitable hole for <code>mmap()</code> could be expensive. DragonFly uses a freehint cache that provides O(1) lookup for common allocation patterns, falling back to RB tree traversal only when necessary.</p>
<p><strong>Why can multiple threads fault on different parts of the same mapping concurrently?</strong></p>
<p>Large anonymous mappings (like a process's heap) could serialize all faults through a single lock. DragonFly's 32MB entry partitioning allows different threads to fault on different partitions simultaneously, dramatically improving multi-threaded scalability.</p>
<hr/>
<h2 id="the-life-of-a-mapping">The Life of a Mapping<a class="headerlink" href="#the-life-of-a-mapping" title="Permanent link"></a></h2>
<p>A mapping's journey from creation through active use to destruction:</p>
<pre class="mermaid"><code>flowchart TB
    MMAP["mmap() syscall"]
    FINDSPACE["vm_map_findspace()<br/>Find suitable hole"]
    INSERT["vm_map_insert()<br/>Create vm_map_entry"]
    ACTIVE["Active Mapping<br/>Entry in RB tree"]
    FAULT["Page fault on access"]
    LOOKUP["vm_map_lookup()<br/>Find entry, check protection"]
    COW{"Write to<br/>COW page?"}
    SHADOW["vm_map_entry_shadow()<br/>Create shadow chain"]
    VMFAULT["vm_fault()<br/>Populate page"]
    PROTECT["mprotect() / mlock()"]
    MODIFY["vm_map_protect()<br/>vm_map_user_wiring()"]
    FORK["fork()"]
    COPY["vm_map_copy_entry()<br/>Set up COW sharing"]
    MUNMAP["munmap() syscall"]
    DELETE["vm_map_delete()<br/>Remove entry, clean up"]

    MMAP --&gt; FINDSPACE
    FINDSPACE --&gt; INSERT
    INSERT --&gt; ACTIVE
    ACTIVE --&gt; FAULT
    FAULT --&gt; LOOKUP
    LOOKUP --&gt; COW
    COW --&gt;|yes| SHADOW
    SHADOW --&gt; VMFAULT
    COW --&gt;|no| VMFAULT
    VMFAULT --&gt; ACTIVE
    ACTIVE --&gt; PROTECT
    PROTECT --&gt; MODIFY
    MODIFY --&gt; ACTIVE
    ACTIVE --&gt; FORK
    FORK --&gt; COPY
    COPY --&gt; ACTIVE
    ACTIVE --&gt; MUNMAP
    MUNMAP --&gt; DELETE
</code></pre>
<p><strong>Key transitions:</strong></p>
<ol>
<li>
<p><strong>Creation</strong>: <code>mmap()</code>  <code>vm_map_findspace()</code> finds a hole  <code>vm_map_insert()</code> creates the entry. The mapping exists but has no pages yet.</p>
</li>
<li>
<p><strong>First Access</strong>: A page fault triggers <code>vm_map_lookup()</code> which finds the entry and checks permissions. Then <code>vm_fault()</code> populates the page from the backing object or zero-fills it.</p>
</li>
<li>
<p><strong>COW Fault</strong>: If a process writes to a shared page (after <code>fork()</code>), <code>vm_map_entry_shadow()</code> creates a shadow chain, and the write goes to a private copy.</p>
</li>
<li>
<p><strong>Destruction</strong>: <code>munmap()</code>  <code>vm_map_delete()</code> removes pmap mappings, releases object references, and frees the entry.</p>
</li>
</ol>
<hr/>
<h2 id="key-design-principles">Key Design Principles<a class="headerlink" href="#key-design-principles" title="Permanent link"></a></h2>
<table>
<thead>
<tr>
<th>Problem</th>
<th>Traditional Approach</th>
<th>DragonFly's Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>COW tracking</strong></td>
<td>Modify vm_object shadow chains</td>
<td><code>vm_map_backing</code> chainsobjects unchanged when shadowed</td>
</tr>
<tr>
<td><strong>Finding free space</strong></td>
<td>O(n) scan or complex data structures</td>
<td>Freehint cache for O(1) common case, RB tree fallback</td>
</tr>
<tr>
<td><strong>Large mapping contention</strong></td>
<td>Single entry = single lock</td>
<td>32MB partitioning for concurrent faults</td>
</tr>
<tr>
<td><strong>Process exit cleanup</strong></td>
<td>Synchronous, heavyweight</td>
<td>Two-stage termination (stage-1 while runnable)</td>
</tr>
<tr>
<td><strong>Entry allocation in fault path</strong></td>
<td>Zone allocator (may block)</td>
<td>Per-CPU entry cache, pre-reserved entries</td>
</tr>
<tr>
<td><strong>Shadow chain explosion</strong></td>
<td>Unbounded depth from repeated forks</td>
<td><code>vm_map_backing_limit</code> (default 5) with auto-collapse</td>
</tr>
<tr>
<td><strong>Submap overhead</strong></td>
<td>Separate map structure</td>
<td>Embedded in entry via <code>VM_MAPTYPE_SUBMAP</code></td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="common-operations">Common Operations<a class="headerlink" href="#common-operations" title="Permanent link"></a></h2>
<p>Understanding when this code runs helps navigate the 4,781 lines. Here's what happens for common scenarios:</p>
<table>
<thead>
<tr>
<th>User Action</th>
<th>Syscall</th>
<th>Key Functions</th>
<th>What Happens</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mmap()</code></td>
<td><code>sys_mmap</code></td>
<td><code>vm_map_find()</code>  <code>vm_map_insert()</code></td>
<td>Creates vm_map_entry, may coalesce with previous</td>
</tr>
<tr>
<td><code>munmap()</code></td>
<td><code>sys_munmap</code></td>
<td><code>vm_map_remove()</code>  <code>vm_map_delete()</code></td>
<td>Clips entries, removes pmap mappings, frees objects</td>
</tr>
<tr>
<td><code>mprotect()</code></td>
<td><code>sys_mprotect</code></td>
<td><code>vm_map_protect()</code></td>
<td>Two-pass: validate then apply to entries and pmap</td>
</tr>
<tr>
<td><code>mlock()</code></td>
<td><code>sys_mlock</code></td>
<td><code>vm_map_user_wiring()</code></td>
<td>Faults in pages, sets USER_WIRED flag</td>
</tr>
<tr>
<td><code>fork()</code></td>
<td><code>sys_fork</code></td>
<td><code>vmspace_fork()</code>  <code>vm_map_copy_entry()</code></td>
<td>Clones entries, sets up COW sharing</td>
</tr>
<tr>
<td>Stack growth</td>
<td>(fault)</td>
<td><code>vm_map_growstack()</code></td>
<td>Expands stack entry into reserved space</td>
</tr>
<tr>
<td>Page fault</td>
<td>(trap)</td>
<td><code>vm_map_lookup()</code></td>
<td>Finds entry, handles COW, returns backing info</td>
</tr>
</tbody>
</table>
<pre class="mermaid"><code>flowchart TB
    subgraph User["USER"]
        mmap["mmap(NULL, 4096, ...)"]
        access["*ptr = 42"]
        fork["fork()"]
        munmap["munmap(ptr, 4096)"]
    end

    subgraph vmmap["vm_map.c"]
        findspace["vm_map_findspace()"]
        insert["vm_map_insert()"]
        lookup["vm_map_lookup()"]
        fault["(vm_fault handles rest)"]
        vmfork["vmspace_fork()"]
        copyentry["vm_map_copy_entry()"]
        delete["vm_map_delete()"]
        pmapremove["pmap_remove()"]
    end

    subgraph Result["RESULT"]
        addr["0x7f0000000000"]
        newentry["new vm_map_entry"]
        entryinfo["entry + backing info"]
        childvm["child vmspace"]
        cowentries["COW entries"]
        removed["entry removed"]
        cleared["PTEs cleared"]
    end

    mmap --&gt; findspace --&gt; addr
    mmap --&gt; insert --&gt; newentry
    access --&gt; lookup --&gt; entryinfo
    access --&gt; fault
    fork --&gt; vmfork --&gt; childvm
    fork --&gt; copyentry --&gt; cowentries
    munmap --&gt; delete --&gt; removed
    munmap --&gt; pmapremove --&gt; cleared
</code></pre>
<hr/>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link"></a></h2>
<p>A virtual address space is represented by two key structures:</p>
<ul>
<li><strong>vmspace</strong> - Per-process address space containing both <code>vm_map</code> and <code>pmap</code></li>
<li><strong>vm_map</strong> - Collection of address range mappings organized in a red-black tree</li>
</ul>
<p>Each mapping (<code>vm_map_entry</code>) describes a contiguous virtual address range with its protection, inheritance, and backing store. DragonFly uses <code>vm_map_backing</code> chains to link entries to objects, enabling efficient shadow object handling without modifying the objects themselves.</p>
<h2 id="data-structures">Data Structures<a class="headerlink" href="#data-structures" title="Permanent link"></a></h2>
<h3 id="struct-vmspace">struct vmspace<a class="headerlink" href="#struct-vmspace" title="Permanent link"></a></h3>
<p>Per-process address space descriptor:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vmspace</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map</span><span class="w"> </span><span class="n">vm_map</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Embedded address map */</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pmap</span><span class="w"> </span><span class="n">vm_pmap</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Embedded page table */</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="cm">/* Copied on fork (vm_startcopy to vm_endcopy) */</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">segsz_t</span><span class="w"> </span><span class="n">vm_swrss</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Swap reserved for process */</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">segsz_t</span><span class="w"> </span><span class="n">vm_tsize</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Text size (pages) */</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">segsz_t</span><span class="w"> </span><span class="n">vm_dsize</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Data size (pages) */</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="n">segsz_t</span><span class="w"> </span><span class="n">vm_ssize</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Stack size (pages) */</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">vm_taddr</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Text address */</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">vm_daddr</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Data address */</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="n">caddr_t</span><span class="w"> </span><span class="n">vm_maxsaddr</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Max stack address */</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span><span class="w">              </span><span class="cm">/* VMSPACE_EXIT1/EXIT2 */</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vm_exitingcnt</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Threads currently exiting */</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vm_refcnt</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Reference count */</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vm_holdcnt</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Hold count (prevents stage-2 exit) */</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="p">};</span>
</code></pre></div>
<h3 id="struct-vm_map">struct vm_map<a class="headerlink" href="#struct-vm_map" title="Permanent link"></a></h3>
<p>Virtual address space:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_rb_tree</span><span class="w"> </span><span class="n">rb_root</span><span class="p">;</span><span class="w">  </span><span class="cm">/* RB tree of entries */</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pmap</span><span class="w"> </span><span class="o">*</span><span class="n">pmap</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Physical address map */</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">min_addr</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Lowest valid address */</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">max_addr</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Highest valid address */</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">vm_size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Total mapped size */</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nentries</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Number of entries */</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Modification counter */</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Hard lock (100ms timeout) */</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lwkt_token</span><span class="w"> </span><span class="n">token</span><span class="p">;</span><span class="w">        </span><span class="cm">/* Soft serializer */</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="n">vm_flags_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">               </span><span class="cm">/* MAP_WIREFUTURE, etc. */</span>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_freehint</span><span class="w"> </span><span class="n">freehint</span><span class="p">[</span><span class="n">VM_MAP_FFCOUNT</span><span class="p">];</span><span class="w">  </span><span class="cm">/* Findspace hints */</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="n">ilock_spin</span><span class="p">;</span><span class="w">     </span><span class="cm">/* For range interlocks */</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="p">};</span>
</code></pre></div>
<h3 id="struct-vm_map_entry">struct vm_map_entry<a class="headerlink" href="#struct-vm_map_entry" title="Permanent link"></a></h3>
<p>Single address range mapping:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_entry</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="cm">/* RB tree linkage */</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="n">RB_ENTRY</span><span class="p">(</span><span class="n">vm_map_entry</span><span class="p">)</span><span class="w"> </span><span class="n">rb_entry</span><span class="p">;</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="cm">/* Embedded backing store */</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="n">ba</span><span class="p">;</span><span class="w">       </span><span class="cm">/* pmap, start, end, offset, object */</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="cm">/* Properties */</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">protection</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Current protection */</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">max_protection</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Maximum allowed */</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="n">vm_inherit_t</span><span class="w"> </span><span class="n">inheritance</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Fork behavior */</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="n">u_int</span><span class="w"> </span><span class="n">wired_count</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Wiring reference count */</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="n">vm_eflags_t</span><span class="w"> </span><span class="n">eflags</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Entry flags */</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="n">vm_maptype_t</span><span class="w"> </span><span class="n">maptype</span><span class="p">;</span><span class="w">           </span><span class="cm">/* NORMAL, SUBMAP, UKSMAP */</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="n">vm_subsys_t</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Subsystem identifier */</span>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">avail_ssize</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Stack: available growth */</span>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">dev_prot</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Device protection */</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">aux</span><span class="p">;</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">};</span>
</code></pre></div>
<h3 id="struct-vm_map_backing">struct vm_map_backing<a class="headerlink" href="#struct-vm_map_backing" title="Permanent link"></a></h3>
<p>Backing store chain element (DragonFly-specific):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="cm">/* Chain linkage */</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="o">*</span><span class="n">backing_ba</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Next in shadow chain */</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">backing_count</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Depth counter */</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="cm">/* Address range (mirrored from entry but can differ in chain) */</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="n">vm_ooffset_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="cm">/* Backing store */</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pmap</span><span class="w"> </span><span class="o">*</span><span class="n">pmap</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Page table reference */</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_object</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="p">;</span><span class="w">        </span><span class="cm">/* NORMAL: backing object */</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map</span><span class="w"> </span><span class="o">*</span><span class="n">sub_map</span><span class="p">;</span><span class="w">          </span><span class="cm">/* SUBMAP: nested map */</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">uksmap</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="o">*</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">,</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">                      </span><span class="n">cdev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">page</span><span class="p">);</span><span class="w">  </span><span class="cm">/* UKSMAP: callback */</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">aux_info</span><span class="p">;</span><span class="w">                      </span><span class="cm">/* UKSMAP auxiliary */</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="cm">/* Object linkage */</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="n">TAILQ_ENTRY</span><span class="p">(</span><span class="n">vm_map_backing</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w">   </span><span class="cm">/* On object's backing_list */</span>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="p">};</span>
</code></pre></div>
<h3 id="entry-flags-vm_eflags_t">Entry Flags (vm_eflags_t)<a class="headerlink" href="#entry-flags-vm_eflags_t" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MAP_ENTRY_COW</code></td>
<td>Copy-on-write enabled</td>
</tr>
<tr>
<td><code>MAP_ENTRY_NEEDS_COPY</code></td>
<td>COW not yet performed</td>
</tr>
<tr>
<td><code>MAP_ENTRY_NOFAULT</code></td>
<td>No faults allowed</td>
</tr>
<tr>
<td><code>MAP_ENTRY_USER_WIRED</code></td>
<td>User-level wiring (mlock)</td>
</tr>
<tr>
<td><code>MAP_ENTRY_IN_TRANSITION</code></td>
<td>Entry being modified</td>
</tr>
<tr>
<td><code>MAP_ENTRY_NEEDS_WAKEUP</code></td>
<td>Wake waiters when done</td>
</tr>
<tr>
<td><code>MAP_ENTRY_NOSYNC</code></td>
<td>Don't sync to filesystem</td>
</tr>
<tr>
<td><code>MAP_ENTRY_NOCOREDUMP</code></td>
<td>Exclude from core dumps</td>
</tr>
<tr>
<td><code>MAP_ENTRY_STACK</code></td>
<td>User stack mapping</td>
</tr>
<tr>
<td><code>MAP_ENTRY_KSTACK</code></td>
<td>Kernel stack mapping</td>
</tr>
</tbody>
</table>
<h3 id="map-types-vm_maptype_t">Map Types (vm_maptype_t)<a class="headerlink" href="#map-types-vm_maptype_t" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>VM_MAPTYPE_NORMAL</code></td>
<td>Standard mapping with backing object</td>
</tr>
<tr>
<td><code>VM_MAPTYPE_SUBMAP</code></td>
<td>Nested map (kernel use)</td>
</tr>
<tr>
<td><code>VM_MAPTYPE_UKSMAP</code></td>
<td>User-kernel shared memory with device callback</td>
</tr>
</tbody>
</table>
<h2 id="vmspace-lifecycle">vmspace Lifecycle<a class="headerlink" href="#vmspace-lifecycle" title="Permanent link"></a></h2>
<h3 id="two-stage-termination">Two-Stage Termination<a class="headerlink" href="#two-stage-termination" title="Permanent link"></a></h3>
<p>DragonFly uses a two-stage termination for vmspace cleanup:</p>
<p><strong>Stage 1</strong> (ref_count reaches 0):
- Triggered by <code>vmspace_rel()</code> or <code>vmspace_relexit()</code>
- Sets <code>VMSPACE_EXIT1</code> flag
- Detaches SysV shared memory
- Removes pmap mappings and frees most VM resources
- Process can still run (using cached TLB entries)</p>
<p><strong>Stage 2</strong> (hold_count reaches 0):
- Triggered by <code>vmspace_drop()</code> or <code>vmspace_exitfree()</code>
- Sets <code>VMSPACE_EXIT2</code> flag<br/>
- Final cleanup via <code>vm_map_delete()</code>
- Releases pmap resources
- Returns vmspace to objcache</p>
<p>This separation allows efficient process exit - the heavyweight cleanup happens while threads are still runnable.</p>
<h3 id="allocation-and-initialization">Allocation and Initialization<a class="headerlink" href="#allocation-and-initialization" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="cm">/* Allocate new vmspace */</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vmspace</span><span class="w"> </span><span class="o">*</span><span class="n">vmspace_alloc</span><span class="p">(</span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">max</span><span class="p">);</span>
</code></pre></div>
<p>Initialization sequence:
1. Get vmspace from objcache
2. Zero the copyable region (<code>vm_startcopy</code> to <code>vm_endcopy</code>)
3. Initialize embedded <code>vm_map</code> with RB tree, locks, freehints
4. Set refs=1, holds=1
5. Initialize pmap via <code>pmap_pinit()</code>
6. Architecture-specific setup via <code>cpu_vmspace_alloc()</code></p>
<h3 id="reference-counting">Reference Counting<a class="headerlink" href="#reference-counting" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vmspace_ref(vm)</code></td>
<td>Add reference (increments both ref and hold)</td>
</tr>
<tr>
<td><code>vmspace_rel(vm)</code></td>
<td>Release reference (triggers stage-1 on 10)</td>
</tr>
<tr>
<td><code>vmspace_hold(vm)</code></td>
<td>Add hold only (acquires map token)</td>
</tr>
<tr>
<td><code>vmspace_drop(vm)</code></td>
<td>Release hold (triggers stage-2 on 10)</td>
</tr>
<tr>
<td><code>vmspace_relexit(p)</code></td>
<td>Exit path: add hold, release ref</td>
</tr>
<tr>
<td><code>vmspace_exitfree(p)</code></td>
<td>Reap path: clear p_vmspace, drop hold</td>
</tr>
</tbody>
</table>
<h2 id="map-operations">Map Operations<a class="headerlink" href="#map-operations" title="Permanent link"></a></h2>
<h3 id="entry-lookup">Entry Lookup<a class="headerlink" href="#entry-lookup" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">boolean_t</span><span class="w"> </span><span class="nf">vm_map_lookup_entry</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">                               </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">);</span>
</code></pre></div>
<p>Performs RB tree lookup:
- Returns TRUE if address is within an entry
- Sets <code>*entry</code> to containing entry or closest predecessor
- <code>*entry = NULL</code> if address is before all entries</p>
<h3 id="finding-free-space">Finding Free Space<a class="headerlink" href="#finding-free-space" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_findspace</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">                     </span><span class="n">vm_size_t</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">);</span>
</code></pre></div>
<p>Finds a hole of <code>length</code> bytes starting at or after <code>start</code>:
- Respects alignment requirements
- <code>MAP_32BIT</code> flag restricts to low 4GB
- Uses freehint cache for O(1) common case
- Handles stack entry reserved space (<code>avail_ssize</code>)
- For kernel_map: calls <code>pmap_growkernel()</code> if needed</p>
<p><strong>Freehint Optimization:</strong></p>
<p>The map maintains <code>VM_MAP_FFCOUNT</code> hints for recently successful allocations:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_freehint</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">align</span><span class="p">;</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="p">};</span>
</code></pre></div>
<p>When findspace succeeds, it updates the hint cache. Subsequent requests with matching (length, align) get O(1) lookup.</p>
<h3 id="inserting-mappings">Inserting Mappings<a class="headerlink" href="#inserting-mappings" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_insert</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">countp</span><span class="p">,</span><span class="w"> </span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">                  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">aux</span><span class="p">,</span><span class="w"> </span><span class="n">vm_ooffset_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">                  </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">                  </span><span class="n">vm_maptype_t</span><span class="w"> </span><span class="n">maptype</span><span class="p">,</span><span class="w"> </span><span class="n">vm_subsys_t</span><span class="w"> </span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">                  </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cow</span><span class="p">);</span>
</code></pre></div>
<p><strong>COWF_* flags:</strong></p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>COWF_COPY_ON_WRITE</code></td>
<td>Enable COW (sets COW + NEEDS_COPY)</td>
</tr>
<tr>
<td><code>COWF_NOFAULT</code></td>
<td>No faults allowed (object must be NULL)</td>
</tr>
<tr>
<td><code>COWF_PREFAULT</code></td>
<td>Prepopulate page tables</td>
</tr>
<tr>
<td><code>COWF_32BIT</code></td>
<td>Restrict to 32-bit addresses</td>
</tr>
<tr>
<td><code>COWF_DISABLE_SYNCER</code></td>
<td>Set NOSYNC flag</td>
</tr>
<tr>
<td><code>COWF_DISABLE_COREDUMP</code></td>
<td>Set NOCOREDUMP flag</td>
</tr>
<tr>
<td><code>COWF_IS_STACK</code></td>
<td>Mark as stack</td>
</tr>
</tbody>
</table>
<p><strong>Coalescing Optimization:</strong></p>
<p>When no object is specified and the previous entry is compatible (same flags, id, maptype, no backing chain), insert attempts to extend the previous entry's object via <code>vm_object_coalesce()</code> instead of creating a new entry.</p>
<h3 id="high-level-find-and-insert">High-Level Find and Insert<a class="headerlink" href="#high-level-find-and-insert" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_find</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">aux</span><span class="p">,</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">                </span><span class="n">vm_ooffset_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">                </span><span class="n">vm_size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">vm_size_t</span><span class="w"> </span><span class="n">align</span><span class="p">,</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">                </span><span class="n">boolean_t</span><span class="w"> </span><span class="n">fitit</span><span class="p">,</span><span class="w"> </span><span class="n">vm_maptype_t</span><span class="w"> </span><span class="n">maptype</span><span class="p">,</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">                </span><span class="n">vm_subsys_t</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cow</span><span class="p">);</span>
</code></pre></div>
<p>Combines findspace + insert:
- If <code>fitit</code> is TRUE: finds space starting at <code>*addr</code>
- If <code>fitit</code> is FALSE: uses exact address <code>*addr</code>
- Handles UKSMAP aux_info setup for upmap/kpmap/lpmap</p>
<h3 id="entry-clipping">Entry Clipping<a class="headerlink" href="#entry-clipping" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_map_clip_start</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">                       </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">startaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">countp</span><span class="p">);</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_map_clip_end</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">                     </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">endaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">countp</span><span class="p">);</span>
</code></pre></div>
<p>Clips split an entry at a given address:
- <code>clip_start</code>: Creates new entry for front portion
- <code>clip_end</code>: Creates new entry for tail portion
- Both replicate the backing chain via <code>vm_map_backing_replicated()</code></p>
<p><strong>Partition Optimization:</strong></p>
<p>For large anonymous mappings, clip may allocate an object to enable 32MB partitioning for concurrent faults:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="cp">#define MAP_ENTRY_PARTITION_SIZE  (32 * 1024 * 1024)</span>
</code></pre></div>
<h3 id="range-operations">Range Operations<a class="headerlink" href="#range-operations" title="Permanent link"></a></h3>
<p>Many operations work on address ranges using clip_range/unclip_range:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="nf">vm_map_clip_range</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">                                  </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">countp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_map_unclip_range</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">                         </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">                         </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">countp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</code></pre></div>
<p><code>clip_range</code>:
1. Clips entries to exact range boundaries
2. Sets <code>IN_TRANSITION</code> on all covered entries
3. Returns first entry (or NULL)
4. <code>MAP_CLIP_NO_HOLES</code> fails if gaps exist</p>
<p><code>unclip_range</code>:
1. Clears <code>IN_TRANSITION</code> flags
2. Wakes any waiters (<code>NEEDS_WAKEUP</code>)
3. Simplifies entries (merges compatible neighbors)</p>
<h3 id="removing-mappings">Removing Mappings<a class="headerlink" href="#removing-mappings" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_remove</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
</code></pre></div>
<p>Internal workhorse <code>vm_map_delete()</code>:
1. Clips entries to range
2. For each entry:
   - Unwires if wired
   - Removes pmap mappings
   - For anonymous with ONEMAPPING: removes pages + swap
   - Deletes entry
3. Updates freehint with new hole</p>
<h3 id="protection-changes">Protection Changes<a class="headerlink" href="#protection-changes" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_protect</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">                   </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">new_prot</span><span class="p">,</span><span class="w"> </span><span class="n">boolean_t</span><span class="w"> </span><span class="n">set_max</span><span class="p">);</span>
</code></pre></div>
<p>Two-pass algorithm:
1. <strong>Validation</strong>: Check submaps, verify new protection fits max
2. <strong>Apply</strong>: Clip entries, update protection, call <code>pmap_protect()</code></p>
<p>For COW entries, write protection is masked from pmap even if logically allowed.</p>
<h3 id="wiring">Wiring<a class="headerlink" href="#wiring" title="Permanent link"></a></h3>
<p><strong>User wiring (mlock/munlock):</strong></p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_user_wiring</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">                       </span><span class="n">boolean_t</span><span class="w"> </span><span class="n">new_pageable</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>Sets <code>USER_WIRED</code> flag</li>
<li>Increments <code>wired_count</code></li>
<li>Calls <code>vm_fault_wire()</code> to fault in pages</li>
<li>On failure: backs out changes</li>
</ul>
<p><strong>Kernel wiring:</strong></p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_kernel_wiring</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">                         </span><span class="kt">int</span><span class="w"> </span><span class="n">kmflags</span><span class="p">);</span>
</code></pre></div>
<ul>
<li><code>KM_KRESERVE</code> avoids zone allocation recursion</li>
<li>Two-pass: prepare entries, then wire</li>
</ul>
<h3 id="msync-implementation">msync Implementation<a class="headerlink" href="#msync-implementation" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_clean</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">end</span><span class="p">,</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">                 </span><span class="n">boolean_t</span><span class="w"> </span><span class="n">syncio</span><span class="p">,</span><span class="w"> </span><span class="n">boolean_t</span><span class="w"> </span><span class="n">invalidate</span><span class="p">);</span>
</code></pre></div>
<p>For each entry:
- SUBMAP: recurse
- NORMAL: follow backing chain to vnode object, call <code>vm_object_page_clean()</code>
- If invalidate: remove pmap mappings</p>
<h2 id="copy-on-write">Copy-On-Write<a class="headerlink" href="#copy-on-write" title="Permanent link"></a></h2>
<h3 id="shadow-object-creation">Shadow Object Creation<a class="headerlink" href="#shadow-object-creation" title="Permanent link"></a></h3>
<p>When a COW fault occurs on a <code>NEEDS_COPY</code> entry:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_map_entry_shadow</span><span class="p">(</span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
</code></pre></div>
<p><strong>Optimization case</strong> - If source object is:
- ref_count == 1
- No vnode
- OBJT_DEFAULT or OBJT_SWAP
- No handle</p>
<p>Then: Just clear NEEDS_COPY, no shadow needed.</p>
<p><strong>General case:</strong>
1. Allocate new result object (OBJT_DEFAULT)
2. Create new <code>vm_map_backing</code> for old object
3. Chain: <code>entry-&gt;ba.object = new</code>, <code>entry-&gt;ba.backing_ba-&gt;object = old</code>
4. Increment <code>backing_count</code>
5. Clear <code>OBJ_ONEMAPPING</code> on source</p>
<h3 id="shadow-chain-depth-limiting">Shadow Chain Depth Limiting<a class="headerlink" href="#shadow-chain-depth-limiting" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">sysctl</span><span class="w"> </span><span class="n">vm</span><span class="p">.</span><span class="n">map_backing_limit</span><span class="o">=</span><span class="mi">5</span><span class="w">  </span><span class="cm">/* Default max depth */</span>
</code></pre></div>
<p>During fork, if <code>backing_count &gt;= limit</code>:
- Collapse via <code>vm_fault_collapse()</code> to reduce depth
- Prevents unbounded chain growth</p>
<h2 id="process-fork">Process Fork<a class="headerlink" href="#process-fork" title="Permanent link"></a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vmspace</span><span class="w"> </span><span class="o">*</span><span class="n">vmspace_fork</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vmspace</span><span class="w"> </span><span class="o">*</span><span class="n">vm1</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p2</span><span class="p">,</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">                             </span><span class="k">struct</span><span class="w"> </span><span class="nc">lwp</span><span class="w"> </span><span class="o">*</span><span class="n">lp2</span><span class="p">);</span>
</code></pre></div>
<p>Creates child address space:</p>
<ol>
<li>Allocate new vmspace</li>
<li>Copy size/address fields (<code>vm_startcopy</code> to <code>vm_endcopy</code>)</li>
<li>For each parent entry, based on inheritance:</li>
</ol>
<table>
<thead>
<tr>
<th>Inheritance</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>VM_INHERIT_NONE</code></td>
<td>Skip entry</td>
</tr>
<tr>
<td><code>VM_INHERIT_SHARE</code></td>
<td>Clone entry, share backing (allocate object if needed, shadow if NEEDS_COPY)</td>
</tr>
<tr>
<td><code>VM_INHERIT_COPY</code></td>
<td>Clone entry, set up COW via <code>vm_map_copy_entry()</code></td>
</tr>
</tbody>
</table>
<p><strong><code>vm_map_copy_entry()</code></strong> for COW:
- If wired: physically copy pages via <code>vm_fault_copy_entry()</code>
- If not wired:
  - Write-protect parent PTEs
  - Set COW + NEEDS_COPY on both
  - Copy PTEs via <code>pmap_copy()</code></p>
<h3 id="uksmap-fork-handling">UKSMAP Fork Handling<a class="headerlink" href="#uksmap-fork-handling" title="Permanent link"></a></h3>
<p>For user-kernel shared mappings:
- upmap/kpmap: Fork normally with updated aux_info
- lpmap: Only fork if thread ID matches new LWP</p>
<h2 id="stack-management">Stack Management<a class="headerlink" href="#stack-management" title="Permanent link"></a></h2>
<h3 id="stack-creation">Stack Creation<a class="headerlink" href="#stack-creation" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_stack</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">addrbos</span><span class="p">,</span><span class="w"> </span><span class="n">vm_size_t</span><span class="w"> </span><span class="n">max_ssize</span><span class="p">,</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">                 </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cow</span><span class="p">);</span>
</code></pre></div>
<p>Creates auto-grow stack:
1. Initial size = min(max_ssize, sgrowsiz)
2. Find space for full <code>max_ssize</code>
3. Insert mapping at top (grows down)
4. Set <code>entry-&gt;aux.avail_ssize = max_ssize - init_ssize</code></p>
<h3 id="stack-growth">Stack Growth<a class="headerlink" href="#stack-growth" title="Permanent link"></a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_growstack</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</code></pre></div>
<p>Called on stack fault:
1. Verify faulting address is in reserved stack space
2. Calculate growth amount (page-aligned)
3. Check against:
   - Available space (<code>avail_ssize</code>)
   - Previous entry gap
   - <code>RLIMIT_STACK</code>
   - <code>RLIMIT_VMEM</code>
4. Insert new mapping below stack entry
5. Update <code>avail_ssize</code> and <code>vm_ssize</code>
6. If <code>MAP_WIREFUTURE</code>: wire new region</p>
<h2 id="fault-path-lookup">Fault Path Lookup<a class="headerlink" href="#fault-path-lookup" title="Permanent link"></a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_map_lookup</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="o">*</span><span class="n">var_map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">fault_type</span><span class="p">,</span>
<a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">                  </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_entry</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_backing</span><span class="w"> </span><span class="o">**</span><span class="n">bap</span><span class="p">,</span>
<a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">                  </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="o">*</span><span class="n">pindex</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="o">*</span><span class="n">pcount</span><span class="p">,</span>
<a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">                  </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_prot</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">wflags</span><span class="p">);</span>
</code></pre></div>
<p>Core function called from page fault handler:</p>
<ol>
<li>Reserve entries (with recursion protection)</li>
<li>Lock map (read or write)</li>
<li>Lookup entry for address</li>
<li>Handle submaps: switch to submap, retry</li>
<li>Check protection:</li>
<li><code>OVERRIDE_WRITE</code> uses max_protection</li>
<li>Normal uses current protection</li>
<li>Handle <code>NEEDS_COPY</code>:</li>
<li>Write fault: upgrade lock, shadow entry, set <code>FW_DIDCOW</code></li>
<li>Read fault: mask out write permission</li>
<li>Partition large entries for concurrent faults</li>
<li>Allocate object if needed</li>
<li>Return backing, page index, protection, flags</li>
</ol>
<p><strong>Entry Partitioning:</strong></p>
<p>For entries larger than 32MB, <code>vm_map_entry_partition()</code> clips to the 32MB partition containing the fault address. This allows concurrent faults on different partitions.</p>
<h2 id="range-interlocks">Range Interlocks<a class="headerlink" href="#range-interlocks" title="Permanent link"></a></h2>
<p>For <code>MADV_INVAL</code> coordination with faults:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_map_interlock</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_ilock</span><span class="w"> </span><span class="o">*</span><span class="n">ilock</span><span class="p">,</span>
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">                      </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">ran_beg</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">ran_end</span><span class="p">);</span>
<a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_map_deinterlock</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_map_ilock</span><span class="w"> </span><span class="o">*</span><span class="n">ilock</span><span class="p">);</span>
</code></pre></div>
<p>Interlocks wait for overlapping operations to complete, preventing races between pmap manipulation and fault handling.</p>
<h2 id="per-cpu-entry-cache">Per-CPU Entry Cache<a class="headerlink" href="#per-cpu-entry-cache" title="Permanent link"></a></h2>
<p>To avoid zone allocation in hot paths:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="cm">/* Per-CPU freelist */</span>
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_vme_base</span><span class="w">  </span><span class="cm">/* Entry freelist head */</span>
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="n">gd</span><span class="o">-&gt;</span><span class="n">gd_vme_avail</span><span class="w"> </span><span class="cm">/* Available count */</span>
</code></pre></div>
<p><strong>Boot initialization:</strong>
- BSP gets <code>MAPENTRYBSP_CACHE</code> (MAXCPU+1) entries
- Each AP gets <code>MAPENTRYAP_CACHE</code> (8) entries</p>
<p><strong>Reserve/release:</strong>
- <code>vm_map_entry_reserve(count)</code>: Ensure count available
- <code>vm_map_entry_release(count)</code>: Return entries, trim if excessive
- <code>kreserve/krelease</code>: Special versions for kernel_map (zalloc recursion avoidance)</p>
<h2 id="dragonfly-specific-features">DragonFly-Specific Features<a class="headerlink" href="#dragonfly-specific-features" title="Permanent link"></a></h2>
<h3 id="vm_map_backing-chains">vm_map_backing Chains<a class="headerlink" href="#vm_map_backing-chains" title="Permanent link"></a></h3>
<p>Unlike traditional BSD where entries point directly to objects, DragonFly interposes <code>vm_map_backing</code>:</p>
<ul>
<li>Shadow chains via <code>backing_ba</code> linkage</li>
<li>Objects unchanged when shadowed</li>
<li>Per-entry backing not shared across pmaps</li>
<li>Efficient fork without object manipulation</li>
</ul>
<h3 id="two-stage-vmspace-termination">Two-Stage vmspace Termination<a class="headerlink" href="#two-stage-vmspace-termination" title="Permanent link"></a></h3>
<p>Separates heavyweight cleanup (stage-1) from final release (stage-2):
- Stage-1 on ref0: bulk pmap/object cleanup
- Stage-2 on hold0: final map delete, return to cache</p>
<h3 id="freehint-cache">Freehint Cache<a class="headerlink" href="#freehint-cache" title="Permanent link"></a></h3>
<p>O(1) findspace for repeated similar allocations (common in mmap patterns).</p>
<h3 id="entry-partitioning">Entry Partitioning<a class="headerlink" href="#entry-partitioning" title="Permanent link"></a></h3>
<p>32MB partitions enable concurrent faults on large anonymous mappings without serializing on the entire entry.</p>
<h3 id="uksmap">UKSMAP<a class="headerlink" href="#uksmap" title="Permanent link"></a></h3>
<p>User-kernel shared memory with device callbacks:
- <code>/dev/upmap</code> (minor 5): Per-process shared page
- <code>/dev/kpmap</code> (minor 6): Kernel-wide shared page<br/>
- <code>/dev/lpmap</code> (minor 7): Per-LWP shared page</p>
<p>Device provides callback for mapping operations.</p>
<h3 id="coalescing-on-insert">Coalescing on Insert<a class="headerlink" href="#coalescing-on-insert" title="Permanent link"></a></h3>
<p>Automatically extends previous entry's object when possible, reducing entry count.</p>
<h2 id="sysctls">Sysctls<a class="headerlink" href="#sysctls" title="Permanent link"></a></h2>
<table>
<thead>
<tr>
<th>Sysctl</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vm.randomize_mmap</code></td>
<td>0</td>
<td>Enable mmap ASLR</td>
</tr>
<tr>
<td><code>vm.map_relock_enable</code></td>
<td>1</td>
<td>Relock optimization for prefault</td>
</tr>
<tr>
<td><code>vm.map_partition_enable</code></td>
<td>1</td>
<td>Enable 32MB entry partitioning</td>
</tr>
<tr>
<td><code>vm.map_backing_limit</code></td>
<td>5</td>
<td>Max shadow chain depth</td>
</tr>
<tr>
<td><code>vm.map_backing_shadow_test</code></td>
<td>1</td>
<td>Test backing object shadows</td>
</tr>
</tbody>
</table>
<h2 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link"></a></h2>
<p>DDB commands:</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>show map &lt;addr&gt;</code></td>
<td>Print map entries with protection and backing</td>
</tr>
<tr>
<td><code>show procvm</code></td>
<td>Print current process vmspace</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="common-usage-patterns">Common Usage Patterns<a class="headerlink" href="#common-usage-patterns" title="Permanent link"></a></h2>
<h3 id="pattern-1-creating-a-mapping-in-kernel-code">Pattern 1: Creating a Mapping in Kernel Code<a class="headerlink" href="#pattern-1-creating-a-mapping-in-kernel-code" title="Permanent link"></a></h3>
<p>From <code>sys/kern/init_main.c</code> - allocating the initial stack for init:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>
<a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="cm">/* Allocate one page at a specific address (fitit=FALSE) */</span>
<a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trunc_page</span><span class="p">(</span><span class="n">USRSTACK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<a href="#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_map_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_vmspace</span><span class="o">-&gt;</span><span class="n">vm_map</span><span class="p">,</span>
<a href="#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">                    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w">         </span><span class="cm">/* object, aux_info (anonymous) */</span>
<a href="#__codelineno-26-8" id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">                    </span><span class="mi">0</span><span class="p">,</span><span class="w">                  </span><span class="cm">/* offset */</span>
<a href="#__codelineno-26-9" id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">                    </span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span><span class="w">              </span><span class="cm">/* address (in/out) */</span>
<a href="#__codelineno-26-10" id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">                    </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w">          </span><span class="cm">/* length */</span>
<a href="#__codelineno-26-11" id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">                    </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w">          </span><span class="cm">/* alignment */</span>
<a href="#__codelineno-26-12" id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">                    </span><span class="n">FALSE</span><span class="p">,</span><span class="w">              </span><span class="cm">/* fitit=FALSE: use exact address */</span>
<a href="#__codelineno-26-13" id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">                    </span><span class="n">VM_MAPTYPE_NORMAL</span><span class="p">,</span>
<a href="#__codelineno-26-14" id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="w">                    </span><span class="n">VM_SUBSYS_INIT</span><span class="p">,</span>
<a href="#__codelineno-26-15" id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">                    </span><span class="n">VM_PROT_ALL</span><span class="p">,</span>
<a href="#__codelineno-26-16" id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">                    </span><span class="n">VM_PROT_ALL</span><span class="p">,</span>
<a href="#__codelineno-26-17" id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">                    </span><span class="mi">0</span><span class="p">);</span><span class="w">                 </span><span class="cm">/* cow flags */</span>
</code></pre></div>
<h3 id="pattern-2-looking-up-an-entry-for-ptrace">Pattern 2: Looking Up an Entry for ptrace<a class="headerlink" href="#pattern-2-looking-up-an-entry-for-ptrace" title="Permanent link"></a></h3>
<p>From <code>sys/kern/sys_process.c</code> - reading process memory:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="n">vm_map_t</span><span class="w"> </span><span class="n">tmap</span><span class="p">;</span>
<a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">out_entry</span><span class="p">;</span>
<a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="n">vm_map_backing_t</span><span class="w"> </span><span class="n">ba</span><span class="p">;</span>
<a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">;</span>
<a href="#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span><span class="w"> </span><span class="n">pcount</span><span class="p">;</span>
<a href="#__codelineno-27-6" id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">out_prot</span><span class="p">;</span>
<a href="#__codelineno-27-7" id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="kt">int</span><span class="w"> </span><span class="n">wflags</span><span class="p">;</span>
<a href="#__codelineno-27-8" id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="kt">int</span><span class="w"> </span><span class="n">rv</span><span class="p">;</span>
<a href="#__codelineno-27-9" id="__codelineno-27-9" name="__codelineno-27-9"></a>
<a href="#__codelineno-27-10" id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="n">tmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">;</span><span class="w">  </span><span class="cm">/* vm_map_lookup may change the map pointer */</span>
<a href="#__codelineno-27-11" id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_map_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmap</span><span class="p">,</span><span class="w"> </span><span class="n">pageno</span><span class="p">,</span><span class="w"> </span><span class="n">VM_PROT_READ</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_entry</span><span class="p">,</span>
<a href="#__codelineno-27-12" id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">                   </span><span class="o">&amp;</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pindex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pcount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_prot</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wflags</span><span class="p">);</span>
<a href="#__codelineno-27-13" id="__codelineno-27-13" name="__codelineno-27-13"></a>
<a href="#__codelineno-27-14" id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ba</span><span class="p">)</span>
<a href="#__codelineno-27-15" id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">    </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>
<a href="#__codelineno-27-16" id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="k">else</span>
<a href="#__codelineno-27-17" id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">    </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a href="#__codelineno-27-18" id="__codelineno-27-18" name="__codelineno-27-18"></a>
<a href="#__codelineno-27-19" id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">KERN_SUCCESS</span><span class="p">)</span>
<a href="#__codelineno-27-20" id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<a href="#__codelineno-27-21" id="__codelineno-27-21" name="__codelineno-27-21"></a>
<a href="#__codelineno-27-22" id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="n">vm_map_lookup_done</span><span class="p">(</span><span class="n">tmap</span><span class="p">,</span><span class="w"> </span><span class="n">out_entry</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>
<h3 id="pattern-3-temporarily-changing-protection-for-ptrace-write">Pattern 3: Temporarily Changing Protection for ptrace Write<a class="headerlink" href="#pattern-3-temporarily-changing-protection-for-ptrace-write" title="Permanent link"></a></h3>
<p>From <code>sys/kern/sys_process.c</code> - writing to read-only memory:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">procp</span><span class="o">-&gt;</span><span class="n">p_vmspace</span><span class="o">-&gt;</span><span class="n">vm_map</span><span class="p">;</span>
<a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="n">boolean_t</span><span class="w"> </span><span class="n">fix_prot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a>
<a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="cm">/* Check if page is writable */</span>
<a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_map_check_protection</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">pageno</span><span class="p">,</span><span class="w"> </span><span class="n">pageno</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span>
<a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">                            </span><span class="n">VM_PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="n">fix_prot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a href="#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="cm">/* Temporarily make it writable */</span>
<a href="#__codelineno-28-9" id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">    </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_map_protect</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">pageno</span><span class="p">,</span><span class="w"> </span><span class="n">pageno</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span>
<a href="#__codelineno-28-10" id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="w">                        </span><span class="n">VM_PROT_ALL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-28-11" id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">KERN_SUCCESS</span><span class="p">)</span>
<a href="#__codelineno-28-12" id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EFAULT</span><span class="p">;</span>
<a href="#__codelineno-28-13" id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="p">}</span>
<a href="#__codelineno-28-14" id="__codelineno-28-14" name="__codelineno-28-14"></a>
<a href="#__codelineno-28-15" id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="cm">/* ... do the write ... */</span>
<a href="#__codelineno-28-16" id="__codelineno-28-16" name="__codelineno-28-16"></a>
<a href="#__codelineno-28-17" id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="cm">/* Restore original protection */</span>
<a href="#__codelineno-28-18" id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fix_prot</span><span class="p">)</span>
<a href="#__codelineno-28-19" id="__codelineno-28-19" name="__codelineno-28-19"></a><span class="w">    </span><span class="n">vm_map_protect</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">pageno</span><span class="p">,</span><span class="w"> </span><span class="n">pageno</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span>
<a href="#__codelineno-28-20" id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="w">                   </span><span class="n">VM_PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_PROT_EXECUTE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>
<h3 id="pattern-4-wiring-pages-for-mlock">Pattern 4: Wiring Pages for mlock<a class="headerlink" href="#pattern-4-wiring-pages-for-mlock" title="Permanent link"></a></h3>
<p>From <code>sys/vm/vm_mmap.c</code> - implementing mlock/munlock:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="cm">/* mlock: wire the pages (new_pageable=FALSE) */</span>
<a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_map_user_wiring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_vmspace</span><span class="o">-&gt;</span><span class="n">vm_map</span><span class="p">,</span>
<a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">                           </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">);</span>
<a href="#__codelineno-29-4" id="__codelineno-29-4" name="__codelineno-29-4"></a>
<a href="#__codelineno-29-5" id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="cm">/* munlock: unwire the pages (new_pageable=TRUE) */</span>
<a href="#__codelineno-29-6" id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_map_user_wiring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_vmspace</span><span class="o">-&gt;</span><span class="n">vm_map</span><span class="p">,</span>
<a href="#__codelineno-29-7" id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">                           </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span>
</code></pre></div>
<h3 id="pattern-5-removing-a-mapping">Pattern 5: Removing a Mapping<a class="headerlink" href="#pattern-5-removing-a-mapping" title="Permanent link"></a></h3>
<p>From <code>sys/kern/kern_exec.c</code> - clearing address space before exec:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="cm">/* Remove all user mappings */</span>
<a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="n">vm_map_remove</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">VM_MAX_USER_ADDRESS</span><span class="p">);</span>
</code></pre></div>
<p>From <code>sys/kern/sys_process.c</code> - cleaning up temporary kernel mapping:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="cm">/* Remove temporary kernel mapping after use */</span>
<a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="n">vm_map_remove</span><span class="p">(</span><span class="n">kernel_map</span><span class="p">,</span><span class="w"> </span><span class="n">kva</span><span class="p">,</span><span class="w"> </span><span class="n">kva</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
</code></pre></div>
<hr/>
<h2 id="further-reading">Further Reading<a class="headerlink" href="#further-reading" title="Permanent link"></a></h2>
<ul>
<li><strong>"The Design and Implementation of the 4.4BSD Operating System"</strong> (McKusick et al.) - Chapter 5 covers VM system design including maps and entries</li>
<li><strong>"Design elements of the FreeBSD VM system"</strong> - <a href="https://docs.freebsd.org/en/books/arch-handbook/vm/">FreeBSD Architecture Handbook</a> - DragonFly's heritage, though backing chains differ significantly</li>
<li><strong>DragonFly commit history</strong> - Search for "vm_map_backing" to see the evolution from shadow objects to backing chains</li>
<li><a href="../vm_fault/">vm_fault.md</a> - How faults use <code>vm_map_lookup()</code> results</li>
<li><a href="../vm_object/">vm_object.md</a> - Objects that back map entries</li>
</ul>
<hr/>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link"></a></h2>
<ul>
<li><a href="../">VM Subsystem Overview</a> - Architecture overview</li>
<li><a href="../vm_page/">Physical Pages</a> - Page allocation and queues</li>
<li><a href="../vm_object/">VM Objects</a> - Object lifecycle and management</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>