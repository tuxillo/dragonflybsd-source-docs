
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Comprehensive documentation for the DragonFly BSD kernel source code" name="description"/>
<meta content="DragonFly BSD Community" name="author"/>
<link href="../vm_map/" rel="prev"/>
<link href="../vm_pageout/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Page Faults - DragonFly BSD Kernel Documentation</title>
<link href="../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#page-fault-handling">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DragonFly BSD Kernel Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Page Faults
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../getting-started/">
        
  
  
    
  
  Getting Started

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
  Kernel Subsystems

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DragonFly BSD Kernel Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DragonFly BSD Kernel Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    DragonFly BSD Kernel Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tuxillo/dragonflybsd-source-docs" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tuxillo/dragonflybsd-source-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Kernel Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Kernel Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    
  
    kern/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    kern/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/lwkt/">
<span class="md-ellipsis">
    
  
    LWKT Threading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/synchronization/">
<span class="md-ellipsis">
    
  
    Synchronization
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/time/">
<span class="md-ellipsis">
    
  
    Time &amp; Timers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/memory/">
<span class="md-ellipsis">
    
  
    Memory Management
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/initialization/">
<span class="md-ellipsis">
    
  
    Initialization &amp; Bootstrap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/processes/">
<span class="md-ellipsis">
    
  
    Processes &amp; Threads
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/resources/">
<span class="md-ellipsis">
    
  
    Process Resources &amp; Credentials
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/scheduling/">
<span class="md-ellipsis">
    
  
    Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_11" id="__nav_3_2_11_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Virtual Filesystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_11_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_11">
<span class="md-nav__icon md-icon"></span>
            
  
    Virtual Filesystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/namecache/">
<span class="md-ellipsis">
    
  
    Name Lookup &amp; Caching
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/mounting/">
<span class="md-ellipsis">
    
  
    Mounting &amp; Unmounting
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/buffer-cache/">
<span class="md-ellipsis">
    
  
    Buffer Cache &amp; I/O
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-operations/">
<span class="md-ellipsis">
    
  
    VFS Operations Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/journaling/">
<span class="md-ellipsis">
    
  
    Journaling System
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-locking/">
<span class="md-ellipsis">
    
  
    Vnode Locking &amp; Lifecycle
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/vfs/vfs-extensions/">
<span class="md-ellipsis">
    
  
    VFS Extensions &amp; Helpers
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_12" id="__nav_3_2_12_label" tabindex="0">
<span class="md-ellipsis">
    
  
    IPC &amp; Sockets
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_12_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_12">
<span class="md-nav__icon md-icon"></span>
            
  
    IPC &amp; Sockets
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/mbufs/">
<span class="md-ellipsis">
    
  
    Mbufs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sockets/">
<span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/unix-sockets/">
<span class="md-ellipsis">
    
  
    Unix Domain Sockets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/protocol-dispatch/">
<span class="md-ellipsis">
    
  
    Protocol Dispatch
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/pipes/">
<span class="md-ellipsis">
    
  
    Pipes
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/mqueue/">
<span class="md-ellipsis">
    
  
    POSIX Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-msg/">
<span class="md-ellipsis">
    
  
    System V Message Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-sem/">
<span class="md-ellipsis">
    
  
    System V Semaphores
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/ipc/sysv-shm/">
<span class="md-ellipsis">
    
  
    System V Shared Memory
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/devices/">
<span class="md-ellipsis">
    
  
    Devices &amp; Drivers
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/newbus/">
<span class="md-ellipsis">
    
  
    NewBus Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/bus-resources/">
<span class="md-ellipsis">
    
  
    Bus Resources &amp; DMA
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/disk/">
<span class="md-ellipsis">
    
  
    Disk Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/firmware/">
<span class="md-ellipsis">
    
  
    Firmware Loading
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/syscalls/">
<span class="md-ellipsis">
    
  
    System Calls
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/kld/">
<span class="md-ellipsis">
    
  
    Kernel Linker (KLD)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tracing/">
<span class="md-ellipsis">
    
  
    Tracing &amp; Debugging
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/sysctl/">
<span class="md-ellipsis">
    
  
    Sysctl Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/accounting/">
<span class="md-ellipsis">
    
  
    Accounting &amp; Sensors
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/security/">
<span class="md-ellipsis">
    
  
    Security
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tty/">
<span class="md-ellipsis">
    
  
    TTY Subsystem
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/tty-pty/">
<span class="md-ellipsis">
    
  
    Pseudo-Terminals (PTY)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/kevent/">
<span class="md-ellipsis">
    
  
    Event Notification (kevent)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/taskqueue/">
<span class="md-ellipsis">
    
  
    Task Queues
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/random/">
<span class="md-ellipsis">
    
  
    Random Number Generation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/checkpoint/">
<span class="md-ellipsis">
    
  
    Process Checkpoint/Restart
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/dmsg/">
<span class="md-ellipsis">
    
  
    Distributed Messaging (dmsg)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/shutdown/">
<span class="md-ellipsis">
    
  
    Shutdown &amp; Panic
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kern/utilities/">
<span class="md-ellipsis">
    
  
    Kernel Utilities
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    vm/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    vm/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_page/">
<span class="md-ellipsis">
    
  
    Physical Pages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_object/">
<span class="md-ellipsis">
    
  
    VM Objects
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_map/">
<span class="md-ellipsis">
    
  
    Address Space
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Page Faults
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#when-this-code-runs">
<span class="md-ellipsis">
      
        When This Code Runs
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-flow">
<span class="md-ellipsis">
      
        High-Level Flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-faultstate">
<span class="md-ellipsis">
      
        struct faultstate
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fault-flags">
<span class="md-ellipsis">
      
        Fault Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wiring-flags-wflags">
<span class="md-ellipsis">
      
        Wiring Flags (wflags)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#main-entry-point">
<span class="md-ellipsis">
      
        Main Entry Point
      
    </span>
</a>
<nav aria-label="Main Entry Point" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lockless-fast-path">
<span class="md-ellipsis">
      
        Lockless Fast Path
      
    </span>
</a>
<nav aria-label="Lockless Fast Path" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#requirements">
<span class="md-ellipsis">
      
        Requirements
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_1">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#benefits">
<span class="md-ellipsis">
      
        Benefits
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-fault-logic">
<span class="md-ellipsis">
      
        Core Fault Logic
      
    </span>
</a>
<nav aria-label="Core Fault Logic" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#protection-upgrade">
<span class="md-ellipsis">
      
        Protection Upgrade
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#main-loop-backing-chain-walk">
<span class="md-ellipsis">
      
        Main Loop (Backing Chain Walk)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write">
<span class="md-ellipsis">
      
        Copy-On-Write
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#finalization">
<span class="md-ellipsis">
      
        Finalization
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wiring-support">
<span class="md-ellipsis">
      
        Wiring Support
      
    </span>
</a>
<nav aria-label="Wiring Support" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_wire">
<span class="md-ellipsis">
      
        vm_fault_wire
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_unwire">
<span class="md-ellipsis">
      
        vm_fault_unwire
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shadow-collapse">
<span class="md-ellipsis">
      
        Shadow Collapse
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#physical-page-copy">
<span class="md-ellipsis">
      
        Physical Page Copy
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#prefaulting">
<span class="md-ellipsis">
      
        Prefaulting
      
    </span>
</a>
<nav aria-label="Prefaulting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#full-prefault">
<span class="md-ellipsis">
      
        Full Prefault
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quick-prefault">
<span class="md-ellipsis">
      
        Quick Prefault
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selection">
<span class="md-ellipsis">
      
        Selection
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alternative-entry-points">
<span class="md-ellipsis">
      
        Alternative Entry Points
      
    </span>
</a>
<nav aria-label="Alternative Entry Points" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_page">
<span class="md-ellipsis">
      
        vm_fault_page
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_page_quick">
<span class="md-ellipsis">
      
        vm_fault_page_quick
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_object_page">
<span class="md-ellipsis">
      
        vm_fault_object_page
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctls">
<span class="md-ellipsis">
      
        Sysctls
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-specific-features">
<span class="md-ellipsis">
      
        DragonFly-Specific Features
      
    </span>
</a>
<nav aria-label="DragonFly-Specific Features" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#lockless-bypass">
<span class="md-ellipsis">
      
        Lockless Bypass
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shared-object-tokens">
<span class="md-ellipsis">
      
        Shared Object Tokens
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exclusive-lock-heuristics">
<span class="md-ellipsis">
      
        Exclusive Lock Heuristics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#burst-faulting">
<span class="md-ellipsis">
      
        Burst Faulting
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rss-enforcement">
<span class="md-ellipsis">
      
        RSS Enforcement
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mgtdevice-support">
<span class="md-ellipsis">
      
        MGTDEVICE Support
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_pageout/">
<span class="md-ellipsis">
    
  
    Pageout &amp; Swap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vm_mmap/">
<span class="md-ellipsis">
    
  
    Memory Mapping
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    vfs/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    vfs/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer2/">
<span class="md-ellipsis">
    
  
    HAMMER2
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hammer/">
<span class="md-ellipsis">
    
  
    HAMMER
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/devfs/">
<span class="md-ellipsis">
    
  
    devfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/procfs/">
<span class="md-ellipsis">
    
  
    procfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/tmpfs/">
<span class="md-ellipsis">
    
  
    tmpfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nullfs/">
<span class="md-ellipsis">
    
  
    nullfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fifofs/">
<span class="md-ellipsis">
    
  
    fifofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/deadfs/">
<span class="md-ellipsis">
    
  
    deadfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/mfs/">
<span class="md-ellipsis">
    
  
    mfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ufs/">
<span class="md-ellipsis">
    
  
    UFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/nfs/">
<span class="md-ellipsis">
    
  
    NFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ext2fs/">
<span class="md-ellipsis">
    
  
    ext2fs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/msdosfs/">
<span class="md-ellipsis">
    
  
    msdosfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/ntfs/">
<span class="md-ellipsis">
    
  
    NTFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/isofs/">
<span class="md-ellipsis">
    
  
    ISO9660
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/udf/">
<span class="md-ellipsis">
    
  
    UDF
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/hpfs/">
<span class="md-ellipsis">
    
  
    HPFS
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/smbfs/">
<span class="md-ellipsis">
    
  
    smbfs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/fuse/">
<span class="md-ellipsis">
    
  
    FUSE
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/autofs/">
<span class="md-ellipsis">
    
  
    autofs
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vfs/dirfs/">
<span class="md-ellipsis">
    
  
    dirfs
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    cpu/x86_64/
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    cpu/x86_64/
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cpu/x86_64/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#when-this-code-runs">
<span class="md-ellipsis">
      
        When This Code Runs
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-flow">
<span class="md-ellipsis">
      
        High-Level Flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-structures">
<span class="md-ellipsis">
      
        Data Structures
      
    </span>
</a>
<nav aria-label="Data Structures" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#struct-faultstate">
<span class="md-ellipsis">
      
        struct faultstate
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fault-flags">
<span class="md-ellipsis">
      
        Fault Flags
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wiring-flags-wflags">
<span class="md-ellipsis">
      
        Wiring Flags (wflags)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#main-entry-point">
<span class="md-ellipsis">
      
        Main Entry Point
      
    </span>
</a>
<nav aria-label="Main Entry Point" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lockless-fast-path">
<span class="md-ellipsis">
      
        Lockless Fast Path
      
    </span>
</a>
<nav aria-label="Lockless Fast Path" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#requirements">
<span class="md-ellipsis">
      
        Requirements
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#algorithm_1">
<span class="md-ellipsis">
      
        Algorithm
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#benefits">
<span class="md-ellipsis">
      
        Benefits
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-fault-logic">
<span class="md-ellipsis">
      
        Core Fault Logic
      
    </span>
</a>
<nav aria-label="Core Fault Logic" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#protection-upgrade">
<span class="md-ellipsis">
      
        Protection Upgrade
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#main-loop-backing-chain-walk">
<span class="md-ellipsis">
      
        Main Loop (Backing Chain Walk)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#copy-on-write">
<span class="md-ellipsis">
      
        Copy-On-Write
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#finalization">
<span class="md-ellipsis">
      
        Finalization
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#wiring-support">
<span class="md-ellipsis">
      
        Wiring Support
      
    </span>
</a>
<nav aria-label="Wiring Support" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_wire">
<span class="md-ellipsis">
      
        vm_fault_wire
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_unwire">
<span class="md-ellipsis">
      
        vm_fault_unwire
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shadow-collapse">
<span class="md-ellipsis">
      
        Shadow Collapse
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#physical-page-copy">
<span class="md-ellipsis">
      
        Physical Page Copy
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#prefaulting">
<span class="md-ellipsis">
      
        Prefaulting
      
    </span>
</a>
<nav aria-label="Prefaulting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#full-prefault">
<span class="md-ellipsis">
      
        Full Prefault
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quick-prefault">
<span class="md-ellipsis">
      
        Quick Prefault
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selection">
<span class="md-ellipsis">
      
        Selection
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alternative-entry-points">
<span class="md-ellipsis">
      
        Alternative Entry Points
      
    </span>
</a>
<nav aria-label="Alternative Entry Points" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_page">
<span class="md-ellipsis">
      
        vm_fault_page
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_page_quick">
<span class="md-ellipsis">
      
        vm_fault_page_quick
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vm_fault_object_page">
<span class="md-ellipsis">
      
        vm_fault_object_page
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sysctls">
<span class="md-ellipsis">
      
        Sysctls
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dragonfly-specific-features">
<span class="md-ellipsis">
      
        DragonFly-Specific Features
      
    </span>
</a>
<nav aria-label="DragonFly-Specific Features" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#lockless-bypass">
<span class="md-ellipsis">
      
        Lockless Bypass
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shared-object-tokens">
<span class="md-ellipsis">
      
        Shared Object Tokens
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exclusive-lock-heuristics">
<span class="md-ellipsis">
      
        Exclusive Lock Heuristics
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#burst-faulting">
<span class="md-ellipsis">
      
        Burst Faulting
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rss-enforcement">
<span class="md-ellipsis">
      
        RSS Enforcement
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mgtdevice-support">
<span class="md-ellipsis">
      
        MGTDEVICE Support
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#see-also">
<span class="md-ellipsis">
      
        See Also
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="page-fault-handling">Page Fault Handling<a class="headerlink" href="#page-fault-handling" title="Permanent link">¶</a></h1>
<p>The page fault handler resolves virtual memory faults by locating or creating physical pages and establishing pmap mappings. DragonFly BSD's implementation emphasizes SMP scalability through shared locking, lockless fast paths, and burst faulting.</p>
<p><strong>Source file:</strong> <code>sys/vm/vm_fault.c</code> (~3,243 lines)</p>
<h2 id="when-this-code-runs">When This Code Runs<a class="headerlink" href="#when-this-code-runs" title="Permanent link">¶</a></h2>
<p>Page faults are <strong>triggered by hardware</strong> when a process accesses memory that:</p>
<table>
<thead>
<tr>
<th>Trigger</th>
<th>Cause</th>
<th>Typical Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>First access after mmap()</td>
<td>No PTE exists</td>
<td>Allocate page, zero-fill or load from file</td>
</tr>
<tr>
<td>Exec touches new code page</td>
<td>Demand paging</td>
<td>Load from executable via vnode_pager</td>
</tr>
<tr>
<td>Write to COW page after fork()</td>
<td>PTE is read-only</td>
<td>Copy page, update PTE to writable</td>
</tr>
<tr>
<td>Stack growth</td>
<td>Access below current stack</td>
<td>Expand stack via <code>vm_map_growstack()</code></td>
</tr>
<tr>
<td>Swapped-out page access</td>
<td>Page not resident</td>
<td>Load from swap via swap_pager</td>
</tr>
<tr>
<td>MADV_DONTNEED region access</td>
<td>Page was freed</td>
<td>Zero-fill new page</td>
</tr>
</tbody>
</table>
<h2 id="high-level-flow">High-Level Flow<a class="headerlink" href="#high-level-flow" title="Permanent link">¶</a></h2>
<pre class="mermaid"><code>flowchart TB
    trap["HARDWARE TRAP"]
    vm_fault["trap() → vm_fault(map, vaddr, fault_type, fault_flags)"]

    subgraph lookup["1. vm_map_lookup()"]
        find["Find vm_map_entry for faulting address"]
        cow_setup["Handle COW setup (shadow object creation)"]
        ret_backing["Return backing chain and protection"]
    end

    subgraph fast["2a. vm_fault_bypass()<br/>FAST PATH"]
        hash["Page in hash cache"]
        valid["Already valid/dirty"]
        nolock["No locks needed"]
        sbusy["Soft-busy only"]
    end

    subgraph slow["2b. vm_fault_object()<br/>SLOW PATH"]
        walk["Walk backing chain"]
        pager["Call pager if needed"]
        cow_copy["Handle COW copy"]
        zero["Zero-fill if new"]
    end

    pmap["3. pmap_enter()<br/>Install PTE for virtual→physical mapping"]

    trap --&gt; vm_fault
    vm_fault --&gt; lookup
    lookup --&gt; fast
    lookup --&gt; slow
    fast --&gt; pmap
    slow --&gt; pmap
</code></pre>
<hr/>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h2>
<p>When a process accesses unmapped or protected memory, the hardware generates a page fault. The fault handler must:</p>
<ol>
<li>Find the vm_map_entry for the faulting address</li>
<li>Walk the vm_map_backing chain to locate the page</li>
<li>Handle copy-on-write if needed</li>
<li>Page in from backing store (file/swap) if needed</li>
<li>Enter the page into the pmap</li>
</ol>
<p>DragonFly optimizes this path with:
- <strong>Lockless bypass</strong> for frequently accessed pages
- <strong>Shared object tokens</strong> for concurrent read faults
- <strong>Burst faulting</strong> to map multiple pages at once
- <strong>Two-level prefaulting</strong> based on lock mode</p>
<h2 id="data-structures">Data Structures<a class="headerlink" href="#data-structures" title="Permanent link">¶</a></h2>
<h3 id="struct-faultstate">struct faultstate<a class="headerlink" href="#struct-faultstate" title="Permanent link">¶</a></h3>
<p>Internal state maintained during fault processing:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">faultstate</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">mary</span><span class="p">[</span><span class="n">VM_FAULT_MAX_QUICK</span><span class="p">];</span><span class="w">  </span><span class="cm">/* Burst pages (max 16) */</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="n">vm_map_backing_t</span><span class="w"> </span><span class="n">ba</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Current backing during iteration */</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Final protection for pmap */</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">vm_page_t</span><span class="w"> </span><span class="n">first_m</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Allocated page for COW target */</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">vm_map_backing_t</span><span class="w"> </span><span class="n">first_ba</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Top-level backing */</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">first_prot</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Protection from map lookup */</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Map being faulted */</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Entry being faulted */</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lookup_still_valid</span><span class="p">;</span><span class="w">         </span><span class="cm">/* Map lock state */</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">hardfault</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* I/O was required */</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">;</span><span class="w">                </span><span class="cm">/* VM_FAULT_* flags */</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">shared</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* Using shared object lock */</span>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">msoftonly</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* Pages are soft-busied only */</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">first_shared</span><span class="p">;</span><span class="w">               </span><span class="cm">/* First object has shared lock */</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">wflags</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* FW_* flags from lookup */</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">first_ba_held</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Object lock state */</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vnode</span><span class="w"> </span><span class="o">*</span><span class="n">vp</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Locked vnode (if any) */</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">};</span>
</code></pre></div>
<h3 id="fault-flags">Fault Flags<a class="headerlink" href="#fault-flags" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>VM_FAULT_NORMAL</code></td>
<td>Standard fault</td>
</tr>
<tr>
<td><code>VM_FAULT_WIRE_MASK</code></td>
<td>Wiring operation</td>
</tr>
<tr>
<td><code>VM_FAULT_USER_WIRE</code></td>
<td>User wiring (mlock)</td>
</tr>
<tr>
<td><code>VM_FAULT_CHANGE_WIRING</code></td>
<td>Kernel wiring</td>
</tr>
<tr>
<td><code>VM_FAULT_BURST</code></td>
<td>Enable prefaulting</td>
</tr>
<tr>
<td><code>VM_FAULT_DIRTY</code></td>
<td>Mark page dirty</td>
</tr>
<tr>
<td><code>VM_FAULT_UNSWAP</code></td>
<td>Remove swap backing</td>
</tr>
<tr>
<td><code>VM_FAULT_USERMODE</code></td>
<td>User-mode fault</td>
</tr>
</tbody>
</table>
<h3 id="wiring-flags-wflags">Wiring Flags (wflags)<a class="headerlink" href="#wiring-flags-wflags" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FW_WIRED</code></td>
<td>Entry is wired</td>
</tr>
<tr>
<td><code>FW_DIDCOW</code></td>
<td>COW was performed</td>
</tr>
</tbody>
</table>
<h2 id="main-entry-point">Main Entry Point<a class="headerlink" href="#main-entry-point" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_fault</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">             </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">fault_type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">);</span>
</code></pre></div>
<p>Called from the trap handler when a page fault occurs.</p>
<h3 id="algorithm">Algorithm<a class="headerlink" href="#algorithm" title="Permanent link">¶</a></h3>
<p><strong>1. Initialization:</strong>
- Set <code>LWP_PAGING</code> flag on current LWP
- Initialize faultstate with shared lock preference</p>
<p><strong>2. Map Lookup (RetryFault):</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_map_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="p">.</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">fault_type</span><span class="p">,</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">                       </span><span class="o">&amp;</span><span class="n">fs</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fs</span><span class="p">.</span><span class="n">first_ba</span><span class="p">,</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">                       </span><span class="o">&amp;</span><span class="n">first_pindex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">first_count</span><span class="p">,</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">                       </span><span class="o">&amp;</span><span class="n">fs</span><span class="p">.</span><span class="n">first_prot</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fs</span><span class="p">.</span><span class="n">wflags</span><span class="p">);</span>
</code></pre></div></p>
<p>The lookup may:
- Create a shadow object for COW
- Partition large entries for concurrency
- Return protection and wiring state</p>
<p><strong>3. Handle Lookup Failures:</strong>
- <code>KERN_INVALID_ADDRESS</code>: Try <code>vm_map_growstack()</code> for stack faults
- <code>KERN_PROTECTION_FAILURE</code> with USER_WIRE: Retry with <code>VM_PROT_OVERRIDE_WRITE</code></p>
<p><strong>4. Special Entry Types:</strong>
- <code>MAP_ENTRY_NOFAULT</code>: Panic (should never fault)
- <code>MAP_ENTRY_KSTACK</code> guard page: Panic
- <code>VM_MAPTYPE_UKSMAP</code>: Call device callback, map directly</p>
<p><strong>5. Fast Path (vm_fault_bypass):</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_fault_bypass_count</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="n">vm_fault_bypass</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">first_pindex</span><span class="p">,</span><span class="w"> </span><span class="n">first_count</span><span class="p">,</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">                   </span><span class="o">&amp;</span><span class="n">mextcount</span><span class="p">,</span><span class="w"> </span><span class="n">fault_type</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">KERN_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">success</span><span class="p">;</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>6. Slow Path:</strong>
- Acquire object lock (shared or exclusive)
- Lock vnode if needed
- Call <code>vm_fault_object()</code> to resolve page</p>
<p><strong>7. Success:</strong>
- Set <code>PG_REFERENCED</code> on page
- Enter page(s) into pmap
- Handle wiring or activate page
- Prefault nearby pages if <code>VM_FAULT_BURST</code></p>
<p><strong>8. Statistics:</strong>
- Increment <code>v_vm_faults</code>
- Update <code>ru_majflt</code> (hard) or <code>ru_minflt</code> (soft)
- Check RSS limits, deactivate pages if exceeded</p>
<h2 id="lockless-fast-path">Lockless Fast Path<a class="headerlink" href="#lockless-fast-path" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">vm_fault_bypass</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">faultstate</span><span class="w"> </span><span class="o">*</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">first_pindex</span><span class="p">,</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">                           </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">first_count</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">mextcountp</span><span class="p">,</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">                           </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">fault_type</span><span class="p">);</span>
</code></pre></div>
<p>Attempts to resolve the fault without acquiring object locks:</p>
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">¶</a></h3>
<ul>
<li>No wiring operation in progress</li>
<li>Page exists in object's page hash</li>
<li>Object is not dead</li>
<li>Page is fully valid, on <code>PQ_ACTIVE</code>, not <code>PG_SWAPPED</code></li>
<li>For writes: object and page already marked writable/dirty</li>
</ul>
<h3 id="algorithm_1">Algorithm<a class="headerlink" href="#algorithm_1" title="Permanent link">¶</a></h3>
<ol>
<li>Look up page via <code>vm_page_hash_get()</code> (acquires soft-busy)</li>
<li>Validate page state</li>
<li>For writes: verify <code>OBJ_WRITEABLE | OBJ_MIGHTBEDIRTY</code> and <code>dirty == VM_PAGE_BITS_ALL</code></li>
<li>Call <code>vm_page_soft_activate()</code> (passive queue manipulation)</li>
<li>Optionally burst: get additional consecutive pages</li>
<li>Return with soft-busied pages in <code>fs-&gt;mary[]</code></li>
</ol>
<h3 id="benefits">Benefits<a class="headerlink" href="#benefits" title="Permanent link">¶</a></h3>
<ul>
<li>No object token acquisition</li>
<li>No hard page busy</li>
<li>Excellent for shared executables and libraries</li>
<li>Multiple pages can be mapped in single operation</li>
</ul>
<h2 id="core-fault-logic">Core Fault Logic<a class="headerlink" href="#core-fault-logic" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">vm_fault_object</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">faultstate</span><span class="w"> </span><span class="o">*</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">vm_pindex_t</span><span class="w"> </span><span class="n">first_pindex</span><span class="p">,</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">                           </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">fault_type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">allow_nofault</span><span class="p">);</span>
</code></pre></div>
<p>Walks the backing chain to find or create the target page.</p>
<h3 id="protection-upgrade">Protection Upgrade<a class="headerlink" href="#protection-upgrade" title="Permanent link">¶</a></h3>
<p>For read faults, the code attempts to also enable write access if:
- The mapping allows writes
- The page is not COW
- The pmap doesn't require A/M bit emulation (vkernel)</p>
<h3 id="main-loop-backing-chain-walk">Main Loop (Backing Chain Walk)<a class="headerlink" href="#main-loop-backing-chain-walk" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>for (;;) {
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>    1. Check if object is dead
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>    2. Look up page in current object
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>    3. If found and valid → break to PAGE FOUND
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>    4. If not found → try pager or allocate
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>    5. Move to next backing object
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>}
</code></pre></div>
<p><strong>Page Lookup:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_page_lookup_busy_try</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</code></pre></div></p>
<p>If the page is busy, sleep and return <code>KERN_TRY_AGAIN</code>.</p>
<p><strong>Page Not Resident:</strong></p>
<p>For <code>OBJT_SWAP</code> objects, check <code>swap_pager_haspage_locked()</code> before allocating.</p>
<p>If the page might be in the pager (<code>TRYPAGER</code>) or this is the first object:
1. Require exclusive lock for allocation
2. Check <code>pindex &lt; object-&gt;size</code>
3. Allocate via <code>vm_page_alloc()</code></p>
<p><strong>Pager I/O:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_pager_get_page</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">pindex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">seqaccess</span><span class="p">);</span>
</code></pre></div></p>
<table>
<thead>
<tr>
<th>Result</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>VM_PAGER_OK</code></td>
<td>Increment hardfault, re-lookup page</td>
</tr>
<tr>
<td><code>VM_PAGER_FAIL</code></td>
<td>Continue to next backing object</td>
</tr>
<tr>
<td><code>VM_PAGER_ERROR</code></td>
<td>Return <code>KERN_FAILURE</code></td>
</tr>
<tr>
<td><code>VM_PAGER_BAD</code></td>
<td>Return <code>KERN_PROTECTION_FAILURE</code></td>
</tr>
</tbody>
</table>
<p><strong>Continue to Next Object:</strong>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">next_ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">backing_ba</span><span class="p">;</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next_ba</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="cm">/* Zero-fill the page */</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="n">vm_page_zero_fill</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="p">}</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="cm">/* Adjust pindex through offset chain */</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="n">pindex</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">OFF_TO_IDX</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="n">pindex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">OFF_TO_IDX</span><span class="p">(</span><span class="n">next_ba</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_ba</span><span class="p">;</span>
</code></pre></div></p>
<h3 id="copy-on-write">Copy-On-Write<a class="headerlink" href="#copy-on-write" title="Permanent link">¶</a></h3>
<p>When the page is found in a backing object (<code>ba != first_ba</code>) and this is a write fault:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="cm">/* Copy from backing page to first_m */</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="n">vm_page_copy</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">first_m</span><span class="p">);</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="cm">/* Release backing page and object */</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="n">release_page</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="n">vm_object_pip_wakeup</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span>
<a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="n">vm_object_drop</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span>
<a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>
<a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="cm">/* Switch to the copy */</span>
<a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">first_ba</span><span class="p">;</span>
<a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">first_m</span><span class="p">;</span>
</code></pre></div>
<p>For read faults on backing pages, write permission is masked:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">fs</span><span class="o">-&gt;</span><span class="n">prot</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">VM_PROT_WRITE</span><span class="p">;</span>
</code></pre></div></p>
<h3 id="finalization">Finalization<a class="headerlink" href="#finalization" title="Permanent link">¶</a></h3>
<ol>
<li>Activate the page</li>
<li>For writes:</li>
<li><code>vm_object_set_writeable_dirty()</code></li>
<li>Handle <code>PG_SWAPPED</code> (requires exclusive lock for <code>swap_pager_unswapped()</code>)</li>
<li>Return <code>KERN_SUCCESS</code> with busied page</li>
</ol>
<h2 id="wiring-support">Wiring Support<a class="headerlink" href="#wiring-support" title="Permanent link">¶</a></h2>
<h3 id="vm_fault_wire">vm_fault_wire<a class="headerlink" href="#vm_fault_wire" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_fault_wire</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">                  </span><span class="n">boolean_t</span><span class="w"> </span><span class="n">user_wire</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kmflags</span><span class="p">);</span>
</code></pre></div>
<p>Wires a range by simulating faults:</p>
<ol>
<li>Entry must be marked <code>IN_TRANSITION</code></li>
<li>Unlock map during faults</li>
<li>For each page: call <code>vm_fault()</code> with wire flags</li>
<li>On failure: unwire already-wired pages</li>
</ol>
<h3 id="vm_fault_unwire">vm_fault_unwire<a class="headerlink" href="#vm_fault_unwire" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_fault_unwire</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
</code></pre></div>
<p>Unwires a range:
- Calls <code>pmap_unwire()</code> to get page
- Calls <code>vm_page_unwire()</code> to decrement wire count
- Skips guard page for <code>MAP_ENTRY_KSTACK</code></p>
<h2 id="shadow-collapse">Shadow Collapse<a class="headerlink" href="#shadow-collapse" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">vm_fault_collapse</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
</code></pre></div>
<p>Used during fork when the backing chain exceeds <code>vm.map_backing_limit</code>:</p>
<ol>
<li>For each pindex in entry range:</li>
<li>Skip if page already in head object</li>
<li>Call <code>vm_fault_object()</code> with write permission</li>
<li>Activates and wakes page</li>
<li>If any pages copied: <code>pmap_remove()</code> entire range</li>
</ol>
<p>This brings all pages into the head object, allowing the backing chain to be freed.</p>
<h2 id="physical-page-copy">Physical Page Copy<a class="headerlink" href="#physical-page-copy" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vm_fault_copy_entry</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">dst_map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">src_map</span><span class="p">,</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">                         </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">dst_entry</span><span class="p">,</span><span class="w"> </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">src_entry</span><span class="p">);</span>
</code></pre></div>
<p>Physically copies pages between entries when COW is not possible (wired pages):</p>
<ol>
<li>Allocate destination object</li>
<li>For each page:</li>
<li>Allocate page in destination</li>
<li>Look up page in source (must exist)</li>
<li><code>vm_page_copy()</code> contents</li>
<li><code>pmap_enter()</code> into destination pmap</li>
</ol>
<h2 id="prefaulting">Prefaulting<a class="headerlink" href="#prefaulting" title="Permanent link">¶</a></h2>
<p>Prefaulting maps nearby pages after a fault to reduce future faults.</p>
<h3 id="full-prefault">Full Prefault<a class="headerlink" href="#full-prefault" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">vm_prefault</span><span class="p">(</span><span class="n">pmap_t</span><span class="w"> </span><span class="n">pmap</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">addra</span><span class="p">,</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">                        </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">);</span>
</code></pre></div>
<p>Used when holding exclusive object lock:</p>
<ol>
<li>Scan ±<code>vm_prefault_pages</code> (default 8) around fault address</li>
<li>Skip already-mapped pages (<code>pmap_prefault_ok()</code>)</li>
<li>Walk backing chain for each address</li>
<li>If not found and <code>vm_fast_fault</code>: allocate zero-fill page</li>
<li>Enter page into pmap</li>
</ol>
<h3 id="quick-prefault">Quick Prefault<a class="headerlink" href="#quick-prefault" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">vm_prefault_quick</span><span class="p">(</span><span class="n">pmap_t</span><span class="w"> </span><span class="n">pmap</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">addra</span><span class="p">,</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">                              </span><span class="n">vm_map_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">);</span>
</code></pre></div>
<p>Used when holding shared object lock:</p>
<ul>
<li>Only works on terminal objects (no backing chain)</li>
<li>Uses <code>vm_page_lookup_sbusy_try()</code> for soft-busy</li>
<li>Only maps existing valid pages, no allocation</li>
<li>Much lower overhead than full prefault</li>
</ul>
<h3 id="selection">Selection<a class="headerlink" href="#selection" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">first_shared</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">shared</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="n">vm_prefault</span><span class="p">(</span><span class="n">pmap</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">);</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="n">vm_prefault_quick</span><span class="p">(</span><span class="n">pmap</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">);</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="p">}</span>
</code></pre></div>
<h2 id="alternative-entry-points">Alternative Entry Points<a class="headerlink" href="#alternative-entry-points" title="Permanent link">¶</a></h2>
<h3 id="vm_fault_page">vm_fault_page<a class="headerlink" href="#vm_fault_page" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_fault_page</span><span class="p">(</span><span class="n">vm_map_t</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">fault_type</span><span class="p">,</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">busyp</span><span class="p">);</span>
</code></pre></div>
<p>Returns a held (and optionally busied) page without pmap update:</p>
<ol>
<li>First tries <code>pmap_fault_page_quick()</code> for fast lookup</li>
<li>Falls back to full <code>vm_fault_object()</code> path</li>
<li>Returns held page, optionally busied for writes</li>
<li>Used by vkernel, ptrace, and similar</li>
</ol>
<h3 id="vm_fault_page_quick">vm_fault_page_quick<a class="headerlink" href="#vm_fault_page_quick" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_fault_page_quick</span><span class="p">(</span><span class="n">vm_offset_t</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">fault_type</span><span class="p">,</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">                              </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">busyp</span><span class="p">);</span>
</code></pre></div>
<p>Convenience wrapper using current process vmspace.</p>
<h3 id="vm_fault_object_page">vm_fault_object_page<a class="headerlink" href="#vm_fault_object_page" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="n">vm_page_t</span><span class="w"> </span><span class="nf">vm_fault_object_page</span><span class="p">(</span><span class="n">vm_object_t</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">vm_ooffset_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">                               </span><span class="n">vm_prot_t</span><span class="w"> </span><span class="n">fault_type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fault_flags</span><span class="p">,</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sharedp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">errorp</span><span class="p">);</span>
</code></pre></div>
<p>Faults a page directly from an object (no map involvement):
- Creates fake <code>vm_map_entry</code>
- Used internally for direct object access</p>
<h2 id="sysctls">Sysctls<a class="headerlink" href="#sysctls" title="Permanent link">¶</a></h2>
<table>
<thead>
<tr>
<th>Sysctl</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vm.shared_fault</code></td>
<td>1</td>
<td>Allow shared object token for faults</td>
</tr>
<tr>
<td><code>vm.fault_bypass</code></td>
<td>1</td>
<td>Enable lockless fast path</td>
</tr>
<tr>
<td><code>vm.prefault_pages</code></td>
<td>8</td>
<td>Pages to prefault each direction</td>
</tr>
<tr>
<td><code>vm.fast_fault</code></td>
<td>1</td>
<td>Allow zero-fill allocation during prefault</td>
</tr>
<tr>
<td><code>vm.debug_fault</code></td>
<td>0</td>
<td>Debug output for faults</td>
</tr>
<tr>
<td><code>vm.debug_cluster</code></td>
<td>0</td>
<td>Debug output for I/O clustering</td>
</tr>
</tbody>
</table>
<h2 id="dragonfly-specific-features">DragonFly-Specific Features<a class="headerlink" href="#dragonfly-specific-features" title="Permanent link">¶</a></h2>
<h3 id="lockless-bypass">Lockless Bypass<a class="headerlink" href="#lockless-bypass" title="Permanent link">¶</a></h3>
<p><code>vm_fault_bypass()</code> uses the page hash table to find pages without acquiring object locks. Pages are soft-busied only, allowing concurrent access. This dramatically improves performance for shared libraries and executables.</p>
<h3 id="shared-object-tokens">Shared Object Tokens<a class="headerlink" href="#shared-object-tokens" title="Permanent link">¶</a></h3>
<p>The <code>vm_shared_fault</code> sysctl (default on) allows read faults to use shared object tokens. This enables concurrent faults on the same object from different processes, important for fork-heavy workloads.</p>
<h3 id="exclusive-lock-heuristics">Exclusive Lock Heuristics<a class="headerlink" href="#exclusive-lock-heuristics" title="Permanent link">¶</a></h3>
<p><code>VM_MAP_BACK_EXCL_HEUR</code> tracks when exclusive locks were needed, avoiding unnecessary shared→exclusive upgrades on subsequent faults.</p>
<h3 id="burst-faulting">Burst Faulting<a class="headerlink" href="#burst-faulting" title="Permanent link">¶</a></h3>
<p>The <code>mary[]</code> array (max 16 pages) allows multiple pages to be faulted in a single operation. Combined with prefaulting, this reduces per-page overhead.</p>
<h3 id="rss-enforcement">RSS Enforcement<a class="headerlink" href="#rss-enforcement" title="Permanent link">¶</a></h3>
<p>After user faults, the code checks process RSS against <code>RLIMIT_RSS</code>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="n">vm_pageout_map_deactivate_pages</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="mgtdevice-support">MGTDEVICE Support<a class="headerlink" href="#mgtdevice-support" title="Permanent link">¶</a></h3>
<p>For managed device objects (GPU/DRM), pages are not indexed in the VM object. The pager returns pages directly for pmap entry without object insertion.</p>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../">VM Subsystem Overview</a> - Architecture overview</li>
<li><a href="../vm_page/">Physical Pages</a> - Page allocation and states</li>
<li><a href="../vm_object/">VM Objects</a> - Object lifecycle</li>
<li><a href="../vm_map/">Address Space</a> - Map lookup and entry management</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>